<div id="MDP_Aux">
<div class="head">
<h1>Theory MDP_Aux</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> MDP_Aux
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Markov_Models/Markov_Decision_Process.html">Markov_Models.Markov_Decision_Process</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="MDP_Aux-sets_stream_space_cylinder"><span class="command">lemma</span></span> sets_stream_space_cylinder<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sets <span class="main">(</span>stream_space <span class="free">M</span><span class="main">)</span> <span class="main">=</span> sigma_sets <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span> <span class="main">⊆</span> Pow <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> scylinder_streams<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"space <span class="free">M</span>"</span></span> <span class="main">_</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">→</span> space <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snth_in<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> sigma_algebra <span class="quoted"><span class="quoted">"streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sigma_sets <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sigma_algebra_sigma_sets<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">A</span> <span class="main">∩</span> streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">=</span> scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">(</span>replicate <span class="skolem">i</span> <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">A</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ω <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> streams_Stream Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> streams_stl<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>stream_space <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> sets <span class="main">(</span>sigma <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sets_stream_space_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_Sup_in_sets<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sets_vimage_algebra2 PiE_UNIV_domain space_PiM * <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sigma_sets.Basic imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sigma_sets <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets_measure_of<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>stream_space <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> sigma_sets <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sigma_sets <span class="main">(</span>streams <span class="main">(</span>space <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>scylinder <span class="main">(</span>space <span class="free">M</span><span class="main">)</span> <span class="main">`</span> lists <span class="main">(</span>sets <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> sets <span class="main">(</span>stream_space <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> space_stream_space<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sets.sigma_sets_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sets_scylinder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Finiteness">
<div class="head">
<h1>Theory Finiteness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Finiteness
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach_Tools.html">HOL-Eisbach.Eisbach_Tools</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Two Eisbach proof methods for finiteness of sets›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The first method is intended to act more conservatively (think <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span>), leaving subgoals
  for the user where it couldn't proceed any further.
  The second method is more powerful, acting more in a succeed-or-die manner,
  similarly to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>force›</span></span></span></span> and friends.
  The examples in the second section should give a good impression of where these methods
  can help.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This slot is intended to provide more <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>intro›</span></span></span></span> theorems for finite sets.›</span></span>
<span class="keyword1"><span class="command">named_theorems</span></span> finite

<span class="comment1">(* Trick from Dan Matichuk on isabelle-users *)</span>
<span class="keyword1"><span class="command">method</span></span> add_finite_Collect_simproc <span class="keyword2"><span class="keyword">methods</span></span> m <span class="main">=</span>
  <span class="operator">match</span> termI <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> H<span class="main"><span class="main">[</span></span><span class="operator">simproc</span> <span class="quasi_keyword"><span class="quasi_keyword">add</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> finite_Collect<span class="main"><span class="main">]</span></span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="main">_</span></span> <span class="main"><span class="main">⇒</span></span> <span class="operator">m</span>

<span class="comment1">(* Trick from Dan Matichuk on isabelle-users.
   Turns a structured method into a simple one.
*)</span>
<span class="keyword1"><span class="command">method_setup</span></span> simple_method <span class="main">=</span>
 <span class="quoted">‹<span class="entity">Method.text_closure</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">m</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
   <span class="keyword2"><span class="keyword">let</span></span>
     <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">facts</span> <span class="main">=</span> <span class="entity">Method.get_facts</span> <span class="entity">ctxt</span>
     <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insert'</span> <span class="main">=</span> <span class="entity">Method.Basic</span> <span class="main">(</span>K <span class="main">(</span><span class="entity">Method.insert</span> <span class="entity">facts</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">m'</span> <span class="main">=</span> <span class="entity">Method.Combinator</span> <span class="main">(</span><span class="entity">Method.no_combinator_info</span><span class="main">,</span> <span class="entity">Method.Then</span><span class="main">,</span> <span class="main">[</span><span class="entity">insert'</span><span class="main">,</span> <span class="entity">m</span><span class="main">]</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Method.evaluate</span> <span class="entity">m'</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">method</span></span> finite_tup <span class="main">=</span>
  <span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">conclusion</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">rule</span> finite_cartesian_product<span class="keyword3">;</span> <span class="operator">finite_tup</span>›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">S</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">*</span> <span class="main">_</span><span class="main">)</span> set"</span></span> <span class="main"><span class="main">⇒</span></span>
      <span class="quoted">‹<span class="operator">print_term</span> <span class="quoted"><span class="free">S</span></span><span class="keyword3">,</span> (<span class="operator">rule</span> finite_subset<span class="main">[</span><span class="operator">where</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted">"fst <span class="main">`</span> <span class="free">S</span> <span class="main">×</span> snd <span class="main">`</span> <span class="free">S</span>"</span><span class="main">]</span><span class="keyword3">;</span> <span class="operator">finite_tup</span><span class="keyword3">?</span>
        <span class="keyword3">|</span> (<span class="operator">rule</span> finite_subset<span class="keyword3">;</span> <span class="operator">assumption</span><span class="keyword3">?</span><span class="keyword3">;</span> <span class="operator">fastforce</span>))›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="main"><span class="main">⇒</span></span>
      <span class="quoted">‹<span class="operator">print_term</span> <span class="quoted"><span class="free">X</span></span><span class="keyword3">,</span> (<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> image_def<span class="keyword3">,</span> <span class="operator">finite_tup</span><span class="keyword3">?</span>)<span class="keyword3">?</span><span class="keyword3">,</span>
                (<span class="operator">solves</span> ‹(<span class="operator">rule</span> finite_subset<span class="keyword3">;</span> <span class="operator">assumption</span><span class="keyword3">?</span><span class="keyword3">;</span> <span class="operator">fastforce</span>)›)<span class="keyword3">?</span>›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="main">_</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> image_def›</span>

<span class="keyword1"><span class="command">method</span></span> finite_search <span class="main">=</span>
  <span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">conclusion</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">rule</span> finite_cartesian_product<span class="keyword3">;</span> <span class="operator">finite_search</span>›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">_</span> <span class="main">`</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">simp</span><span class="keyword3">;</span> <span class="operator">finite_search</span> <span class="keyword3">|</span> <span class="operator">rule</span> finite_imageI<span class="keyword3">;</span> <span class="operator">finite_search</span>›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">S</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">*</span> <span class="main">_</span><span class="main">)</span> set"</span></span> <span class="main"><span class="main">⇒</span></span>
      <span class="quoted">‹<span class="operator">print_term</span> <span class="quoted"><span class="free">S</span></span><span class="keyword3">,</span> (<span class="operator">solves</span> ‹<span class="operator">rule</span> finite_subset<span class="keyword3">;</span> <span class="operator">auto</span>›
        <span class="keyword3">|</span> <span class="operator">rule</span> finite_subset<span class="main">[</span><span class="operator">where</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted">"fst <span class="main">`</span> <span class="free">S</span> <span class="main">×</span> snd <span class="main">`</span> <span class="free">S</span>"</span><span class="main">]</span><span class="keyword3">;</span> <span class="operator">finite_tup</span><span class="keyword3">?</span>)›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Collect <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">f</span> <span class="main"><span class="main">⇒</span></span>
      <span class="quoted">‹<span class="operator">print_term</span> <span class="quoted"><span class="free">f</span></span><span class="keyword3">,</span> (<span class="operator">add_finite_Collect_simproc</span> <span class="operator">simp</span>)<span class="keyword3">?</span><span class="keyword3">;</span>
        (<span class="operator">solves</span> ‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">finite</span></span>›
       <span class="keyword3">|</span> <span class="operator">print_term</span> <span class="quoted"><span class="free">v</span></span><span class="keyword3">,</span> <span class="operator">simp</span><span class="keyword3">?</span><span class="keyword3">,</span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">finite</span></span><span class="keyword3">;</span> (<span class="operator">assumption</span> <span class="keyword3">|</span> <span class="operator">finite_search</span>)
       <span class="keyword3">|</span> <span class="operator">rule</span> finite_imageI<span class="keyword3">;</span> <span class="operator">finite_search</span>
       <span class="keyword3">|</span> <span class="operator">rule</span> finite_vimageI<span class="keyword3">;</span> <span class="operator">finite_search</span>
       <span class="keyword3">|</span> <span class="operator">print_term</span> <span class="quoted"><span class="free">x</span></span><span class="keyword3">,</span> <span class="operator">rule</span> finite_subset<span class="keyword3">;</span> <span class="operator">assumption</span><span class="keyword3">?</span><span class="keyword3">;</span> <span class="operator">fastforce</span>)›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="main"><span class="main">⇒</span></span>
      <span class="quoted">‹<span class="operator">print_term</span> <span class="quoted"><span class="free">X</span></span><span class="keyword3">,</span>
        (<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">finite</span></span><span class="keyword3">;</span> (<span class="operator">assumption</span> <span class="keyword3">|</span> <span class="operator">finite_search</span>) 
       <span class="keyword3">|</span>(<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> image_def<span class="keyword3">,</span> <span class="operator">finite_search</span><span class="keyword3">?</span>)<span class="keyword3">?</span><span class="keyword3">,</span>
          (<span class="operator">solves</span> ‹(<span class="operator">rule</span> finite_subset<span class="keyword3">;</span> <span class="operator">assumption</span><span class="keyword3">?</span><span class="keyword3">;</span> <span class="operator">fastforce</span>)›)<span class="keyword3">?</span>)›</span> <span class="main"><span class="main">¦</span></span>
    <span class="quoted"><span class="main">_</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> image_def›</span>

<span class="keyword1"><span class="command">method</span></span> finite <span class="main">=</span> <span class="operator">simple_method</span> <span class="operator">finite_search</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tests›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Counterexamples›</span></span>

<span class="keyword1" id="Finiteness-inj_finite_single"><span class="command">lemma</span></span> inj_finite_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Collect_mem_eq Collect_mono_iff infinite_iff_countable_subset inj_eq not_finite_existsD
      rangeI
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> inj_finite_single<span class="main">[</span><span class="operator">finite</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It's hard to guess the right set›</span></span>
<span class="keyword1" id="Finiteness-inj_finite_single'"><span class="command">lemma</span></span> inj_finite_single'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">z</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite</span>

<span class="comment1">(* Due to Lars Hupel *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span> <span class="main">|</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">z</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Finiteness-select_finite"><span class="command">lemma</span></span> select_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>select <span class="free">f</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">lemmas</span></span> inj_finite_single'<span class="main">[</span><span class="operator">finite</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Working Examples›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite_search</span>

<span class="keyword1" id="Finiteness-collect_pair_finite"><span class="command">lemma</span></span> collect_pair_finite<span class="main">[</span><span class="operator">finite</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-collect_pair_finite'"><span class="command">lemma</span></span> collect_pair_finite'<span class="main">[</span><span class="operator">finite</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is what we actually need in this theory›</span></span>
<span class="keyword1" id="Finiteness-collect_pair_finite''"><span class="command">lemma</span></span> collect_pair_finite''<span class="main">[</span><span class="operator">finite</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-finite_imageI'"><span class="command">lemma</span></span> finite_imageI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-finite_imageI''"><span class="command">lemma</span></span> finite_imageI''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finite_Collect›</span></span></span></span> can also rewrite to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vimage›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Another counter-example›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">TT</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">TT</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Easier proof. The problem for our method is that the simproc fails to turn ?S into the form used
  in the proof above.
  Note that the declaration of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finite›</span></span></span></span> attribute below is the only one that is <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹necessary›</span></span> in
  this theory.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> finite_imageI''<span class="main">[</span><span class="operator">finite</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">TT</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">S</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-R"><span class="command">lemma</span></span> R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-pairwise_finiteI"><span class="command">lemma</span></span> pairwise_finiteI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-pairwise_finiteI3"><span class="command">lemma</span></span> pairwise_finiteI3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-pairwise_finiteI4"><span class="command">lemma</span></span> pairwise_finiteI4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">d</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-finite_ex_and1"><span class="command">lemma</span></span> finite_ex_and1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1" id="Finiteness-finite_ex_and2"><span class="command">lemma</span></span> finite_ex_and2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">finite</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the only lemma where our methods cannot help us so far due to the fairly
  complex argument that is used in the interactive proof.
›</span></span>
<span class="keyword1" id="Finiteness-finite_set_of_finite_funs2"><span class="command">lemma</span></span> finite_set_of_finite_funs2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">d</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∉</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">d</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">d</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite_set_of_finite_funs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite_set_of_finite_funs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="free">d</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xa</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Basic">
<div class="head">
<h1>Theory Basic</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Julian Brunner *)</span>
<span class="comment1">(* This is originally a part of the CAVA model checker *)</span>
<span class="keyword1"><span class="command">theory</span></span> Basic
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1" id="Basic-infinite_subset"><span class="command">lemma</span></span> infinite_subset<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> infinite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Basic-finite_subset"><span class="command">lemma</span></span> finite_subset<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> finite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword1"><span class="command">declare</span></span> infinite_coinduct<span class="main">[</span><span class="operator">case_names</span> infinite<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> infinite<span class="main">]</span>
  <span class="keyword1" id="Basic-infinite_psubset_coinduct"><span class="command">lemma</span></span> infinite_psubset_coinduct<span class="main">[</span><span class="operator">case_names</span> infinite<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">B</span></span> <span class="main">⊂</span> <span class="bound">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Basic-GreatestI"><span class="command">lemma</span></span> GreatestI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> GreatestI_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Basic-Greatest_le"><span class="command">lemma</span></span> Greatest_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_le_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Basic-Greatest_not_less"><span class="command">lemma</span></span> Greatest_not_less<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le 1 assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Basic-finite_set_of_finite_maps'"><span class="command">lemma</span></span> finite_set_of_finite_maps'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">𝒜</span> <span class="main">∈</span> Pow <span class="free">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">=</span> <span class="bound">𝒜</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_set_of_finite_maps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">alternate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">0</span> <span class="main">=</span> id"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">alternate</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

  <span class="keyword1" id="Basic-alternate_Suc"><span class="command">lemma</span></span> alternate_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="keyword1">else</span> <span class="free">g</span><span class="main">)</span> <span class="main">∘</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternate <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> alternate <span class="skolem">g</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">k</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="keyword1">else</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>alternate <span class="skolem">g</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="keyword1">else</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∘</span> alternate <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">declare</span></span> alternate.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1" id="Basic-alternate_antimono"><span class="command">lemma</span></span> alternate_antimono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>alternate <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_Suc_ex 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_funI<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">l</span> <span class="main">≤</span> alternate <span class="free">f</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sequence">
<div class="head">
<h1>Theory Sequence</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Julian Brunner *)</span>
<span class="comment1">(* This is originally a part of the CAVA model checker *)</span>
<span class="keyword1"><span class="command">theory</span></span> Sequence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Basic.html">Basic</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(* list basics *)</span>

  <span class="keyword1"><span class="command">declare</span></span> upt_Suc<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> last.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> butlast.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> Cons_nth_drop_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Sequence-list_pred_cases"><span class="command">lemma</span></span> list_pred_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>nil<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>cons<span class="main">)</span> <span class="free">y</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-fold_const"><span class="command">lemma</span></span> fold_const<span class="main">:</span> <span class="quoted"><span class="quoted">"fold const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> last <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-take_Suc"><span class="command">lemma</span></span> take_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> hd <span class="free">xs</span> <span class="main">#</span> take <span class="free">n</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc<span class="main">)</span>

  <span class="comment1">(* stream basics *)</span>

  <span class="keyword1"><span class="command">declare</span></span> stream.map_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.set_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.set_sel<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.pred_map<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.rel_map<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> shift_simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stake_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stake_siterate<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> sdrop_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Sequence-stream_pred_cases"><span class="command">lemma</span></span> stream_pred_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>scons<span class="main">)</span> <span class="free">y</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-stream_rel_coinduct"><span class="command">lemma</span></span> stream_rel_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_rel<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> stream_all2<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="main">##</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.collapse<span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_rel_coinduct_shift"><span class="command">lemma</span></span> stream_rel_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_rel<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟹</span>
      <span class="main">∃</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list.rel_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-stream_pred_coinduct"><span class="command">lemma</span></span> stream_pred_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> pred_stream<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_rel eq_onp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_pred_coinduct_shift"><span class="command">lemma</span></span> stream_pred_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_pred_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-stream_pred_flat_coinduct"><span class="command">lemma</span></span> stream_pred_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">ws</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span> <span class="bound">ws</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">w</span> <span class="main">##</span> <span class="bound">ws</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">ws</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span>flat <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream_pred_coinduct_shift<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.exhaust flat_Stream<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_eq_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_eq<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> HOL.eq<span class="main">]</span> <span class="main">=</span>
    stream_rel_coinduct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted">HOL.eq</span><span class="main">,</span> <span class="operator">unfolded</span> stream.rel_eq<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> stream_eq_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_eq<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span> <span class="main">=</span>
    stream_rel_coinduct_shift<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted">HOL.eq</span><span class="main">,</span> <span class="operator">unfolded</span> stream.rel_eq list.rel_eq<span class="main">]</span>

  <span class="keyword1" id="Sequence-sset_subset_stream_pred"><span class="command">lemma</span></span> sset_subset_stream_pred<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="free">w</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟷</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-stream_pred_snth"><span class="command">lemma</span></span> stream_pred_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set sset_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence-stream_pred_shift"><span class="command">lemma</span></span> stream_pred_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">P</span> <span class="free">u</span> <span class="main">∧</span> pred_stream <span class="free">P</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_rel_shift"><span class="command">lemma</span></span> stream_rel_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> list_all2 <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-eq_scons"><span class="command">lemma</span></span> eq_scons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> shd <span class="free">w</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> stl <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-scons_eq"><span class="command">lemma</span></span> scons_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> shd <span class="free">w</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> stl <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-eq_shift"><span class="command">lemma</span></span> eq_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> sdrop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence-shift_eq"><span class="command">lemma</span></span> shift_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> sdrop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scons_eq_shift"><span class="command">lemma</span></span> scons_eq_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">[]</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">a</span> <span class="main">#</span> <span class="bound">u'</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u'</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-shift_eq_scons"><span class="command">lemma</span></span> shift_eq_scons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-stream_all2_sset1"><span class="command">lemma</span></span> stream_all2_sset1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> sset <span class="free">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">ys</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-stream_all2_sset2"><span class="command">lemma</span></span> stream_all2_sset2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> sset <span class="free">ys</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">xs</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-smap_eq_scons"><span class="command">lemma</span></span> smap_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> smap <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smap_ctr <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_smap"><span class="command">lemma</span></span> scons_eq_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="free">f</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smap_ctr <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-smap_eq_shift"><span class="command">lemma</span></span> smap_eq_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> smap <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sdrop_smap eq_shift stake_sdrop stake_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-shift_eq_smap"><span class="command">lemma</span></span> shift_eq_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> smap <span class="free">f</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> map <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> smap <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sdrop_smap eq_shift stake_sdrop stake_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-siterate_eq_scons"><span class="command">lemma</span></span> siterate_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"siterate <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> siterate <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> siterate.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_siterate"><span class="command">lemma</span></span> scons_eq_siterate<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> siterate <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> siterate <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> siterate.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-eqI_snth"><span class="command">lemma</span></span> eqI_snth<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">u</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.sel snth.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-set_sset_stake"><span class="command">lemma</span></span> set_sset_stake<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>stake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sset_shift stake_sdrop sup_ge1<span class="main">)</span>
  <span class="keyword1" id="Sequence-sset_sdrop"><span class="command">lemma</span></span> sset_sdrop<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sset_shift stake_sdrop sup_ge2<span class="main">)</span>

  <span class="keyword1" id="Sequence-set_stake_snth"><span class="command">lemma</span></span> set_stake_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>stake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence-split_stream_first"><span class="command">lemma</span></span> split_stream_first<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ys</span> <span class="free">zs</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="var">?n</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sset_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> not_less_Least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> stake <span class="var">?n</span> <span class="free">xs</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> sdrop <span class="main">(</span>Suc <span class="var">?n</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_stake_snth_sdrop<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_stake_snth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* scans *)</span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">scan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-scan_append"><span class="command">lemma</span></span> scan_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">@</span> scan <span class="free">f</span> <span class="free">ys</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_eq_nil"><span class="command">lemma</span></span> scan_eq_nil<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_eq_cons"><span class="command">lemma</span></span> scan_eq_cons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">#</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">y</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">ys</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_eq_append"><span class="command">lemma</span></span> scan_eq_append<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">ys</span> <span class="free">a</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">zs</span> <span class="main">(</span>fold <span class="free">f</span> <span class="bound">ys</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Cons fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_length"><span class="command">lemma</span></span> scan_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_last"><span class="command">lemma</span></span> scan_last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="free">a</span> <span class="main">#</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_const"><span class="command">lemma</span></span> scan_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_nth"><span class="command">lemma</span></span> scan_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_map"><span class="command">lemma</span></span> scan_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_take"><span class="command">lemma</span></span> scan_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_drop"><span class="command">lemma</span></span> scan_drop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">k</span> <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fold <span class="free">f</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">sscan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free">sscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sscan_scons"><span class="command">lemma</span></span> sscan_scons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.expand<span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_shift"><span class="command">lemma</span></span> sscan_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">@-</span> sscan <span class="free">f</span> <span class="free">ys</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sscan_eq_scons"><span class="command">lemma</span></span> sscan_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> sscan <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sscan.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_sscan"><span class="command">lemma</span></span> scons_eq_sscan<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sscan.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-sscan_const"><span class="command">lemma</span></span> sscan_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_snth"><span class="command">lemma</span></span> sscan_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>stake <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_scons_snth"><span class="command">lemma</span></span> sscan_scons_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>stake <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_smap"><span class="command">lemma</span></span> sscan_smap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span>smap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sscan <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_stake"><span class="command">lemma</span></span> sscan_stake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="free">k</span> <span class="main">(</span>sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>stake <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_sdrop"><span class="command">lemma</span></span> sscan_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="free">k</span> <span class="main">(</span>sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fold <span class="free">f</span> <span class="main">(</span>stake <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="comment1">(* sdistinct *)</span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">sdistinct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    scons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> sset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">sdistinct</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">sdistinct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sdistinct_scons_elim"><span class="command">lemma</span></span> sdistinct_scons_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> sset <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdistinct.cases<span class="main">)</span>

  <span class="keyword1" id="Sequence-sdistinct_coinduct"><span class="command">lemma</span></span> sdistinct_coinduct<span class="main">[</span><span class="operator">case_names</span> sdistinct<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> sdistinct<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">##</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> sset <span class="bound">xs</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stream.collapse sdistinct.coinduct assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-sdistinct_shift"><span class="command">lemma</span></span> sdistinct_shift<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> sset <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sdistinct_shift_elim"><span class="command">lemma</span></span> sdistinct_shift_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> sset <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sdistinct_infinite_sset"><span class="command">lemma</span></span> sdistinct_infinite_sset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdistinct.cases<span class="main">)</span>

  <span class="keyword1" id="Sequence-not_sdistinct_decomp"><span class="command">lemma</span></span> not_sdistinct_decomp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sdistinct <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="free">a</span> <span class="free">w'</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">w'</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">w'</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">a</span> <span class="bound">w'</span><span class="main">.</span> <span class="free">w</span> <span class="main">≠</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">a</span> <span class="main">##</span> <span class="bound">v</span> <span class="main">@-</span> <span class="bound">a</span> <span class="main">##</span> <span class="bound">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> id_stake_snth_sdrop imageE shift.simps sset_range<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* sorted streams *)</span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> <span class="entity">sascending</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">sascending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sascending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> <span class="entity">sdescending</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">sdescending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sdescending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sdescending_coinduct"><span class="command">lemma</span></span> sdescending_coinduct<span class="main">[</span><span class="operator">case_names</span> sdescending<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> sdescending<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">b</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≥</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">b</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stream.collapse sdescending.coinduct assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sdescending_sdrop"><span class="command">lemma</span></span> sdescending_sdrop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> sdescending.cases sdrop_stl stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sdescending_snth_antimono"><span class="command">lemma</span></span> sdescending_snth_antimono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>snth <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> antimono_iff_le_Suc
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_sdrop assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">k</span> <span class="free">w</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">b</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="free">w</span> <span class="main">!!</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps stream.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-sdescending_stuck"><span class="command">lemma</span></span> sdescending_stuck<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder stream"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sdrop <span class="free">k</span> <span class="free">w</span> <span class="main">=</span> sconst <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="main">0</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sconst <span class="main">(</span><span class="skolem">w</span> <span class="main">!!</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff eqI_snth insert_iff snth_sset sset_sconst<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>snth <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_snth_antimono less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antimonoD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">k</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_sdrop less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">l</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> sconst <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 4 _ 5<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sequence_LTL">
<div class="head">
<h1>Theory Sequence_LTL</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Julian Brunner *)</span>
<span class="comment1">(* This is originally a part of the CAVA model checker *)</span>
<span class="keyword1"><span class="command">theory</span></span> Sequence_LTL
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Sequence.html">Sequence</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(* basics *)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> ev_sconst alw_sconst ev_smap alw_smap hld_smap'

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> alw_ev_stl
  <span class="keyword1" id="Sequence_LTL-alw_ev_sdrop"><span class="command">lemma</span></span> alw_ev_sdrop<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alw_ev_sdrop alw_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Sequence_LTL-alw_ev_scons"><span class="command">lemma</span></span> alw_ev_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_ev_stl stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-alw_ev_shift"><span class="command">lemma</span></span> alw_ev_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> ev_alw_stl
  <span class="keyword1" id="Sequence_LTL-ev_alw_sdrop"><span class="command">lemma</span></span> ev_alw_sdrop<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alwD alw_alw alw_sdrop ev_alw_imp_alw_ev not_ev_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_LTL-ev_alw_scons"><span class="command">lemma</span></span> ev_alw_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev_alw_stl stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-ev_alw_shift"><span class="command">lemma</span></span> ev_alw_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-HLD_sconst"><span class="command">lemma</span></span> HLD_sconst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HLD <span class="free">A</span> <span class="main">(</span>sconst <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HLD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence_LTL-ev_stl"><span class="command">lemma</span></span> ev_stl<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="main">(</span>stl <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">φ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev.base ev_shift list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rotate1.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rotate1_is_Nil_conv
        sdrop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sdrop_wait shift_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_Suc stake_sdrop
      <span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-ev_HLD_sset"><span class="command">lemma</span></span> ev_HLD_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>HLD <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> sset <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HLD_def ev_holds_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_LTL-alw_ev_coinduct"><span class="command">lemma</span></span> alw_ev_coinduct<span class="main">[</span><span class="operator">case_names</span> alw_ev<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> ev <span class="free">φ</span> <span class="bound">w</span> <span class="main">∧</span> ev <span class="free">R</span> <span class="main">(</span>stl <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">R</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> alw_sdrop not_ev_iff sdrop_stl sdrop_wait<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* acceptance conditions *)</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">infs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> alw <span class="main">(</span>ev <span class="main">(</span>HLD <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1" id="Sequence_LTL-infs_suffix"><span class="command">lemma</span></span> infs_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">⟶</span> sset <span class="bound">v</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alwD alw_iff_sdrop alw_shift ev_HLD_sset stake_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_LTL-infs_snth"><span class="command">lemma</span></span> infs_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="bound">n</span><span class="main">.</span> <span class="free">w</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop ev_iff_sdrop HLD_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_add1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_infm"><span class="command">lemma</span></span> infs_infm<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infs_snth INFM_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword1" id="Sequence_LTL-infs_coinduct"><span class="command">lemma</span></span> infs_coinduct<span class="main">[</span><span class="operator">case_names</span> infs<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> infs<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> set <span class="bound">u</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw_ev_coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev_HLD_sset ev_stl<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_flat_coinduct"><span class="command">lemma</span></span> infs_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> infs_flat<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">xss</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">##</span> <span class="bound">xss</span><span class="main">)</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="main">(</span>flat <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> empty_set inf_bot_left flat_Stream stream.exhaust<span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-infs_supset"><span class="command">lemma</span></span> infs_supset<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> sset <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> infs <span class="free">B</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="Sequence_LTL-infsI_sset"><span class="command">lemma</span></span> infsI_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="free">w</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> infs <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Sequence_LTL-infsD_sset"><span class="command">lemma</span></span> infsD_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="free">w</span> <span class="main">⟹</span> sset <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_HLD_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_LTL-infs_sset"><span class="command">lemma</span></span> infs_sset<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> infsI_sset<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_UNIV"><span class="command">lemma</span></span> infs_UNIV<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs UNIV <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> infsI_sset<span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-infs_union"><span class="command">lemma</span></span> infs_union<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> infs <span class="free">A</span> <span class="free">w</span> <span class="main">∨</span> infs <span class="free">B</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> le_trans nat_le_linear<span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-infs_cycle"><span class="command">lemma</span></span> infs_cycle<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> set <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">A</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> set <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev_HLD_sset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> infs <span class="free">A</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cycle_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Instantiate_Existentials">
<div class="head">
<h1>Theory Instantiate_Existentials</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Manuel Eberl *)</span>
<span class="keyword1"><span class="command">theory</span></span> Instantiate_Existentials
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inst_existentials_tac</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> TRY o REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">inst_existentials_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">t</span> :: <span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>TRY o REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
      THEN_ALL_NEW <span class="main">(</span>TRY o <span class="main">(</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>NONE<span class="main">,</span> SOME <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">)</span><span class="main">]</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="entity">inst</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> exI bexI<span class="antiquote">}</span></span></span>
        <span class="keyword2"><span class="keyword">in</span></span>
          resolve_tac <span class="entity">ctxt</span> <span class="entity">thms</span> THEN' <span class="entity">inst_existentials_tac</span> <span class="entity">ctxt</span> <span class="entity">ts</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> inst_existentials <span class="main">=</span>
  <span class="quoted">‹
  Scan.lift <span class="main">(</span>Scan.repeat Parse.term<span class="main">)</span> &gt;&gt;
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">inst_existentials_tac</span> <span class="entity">ctxt</span>
         <span class="main">(</span>map <span class="main">(</span>Syntax.read_term <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  ›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Test›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> UNIV<span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span> <span class="main">∈</span> UNIV<span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">1</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> nat"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> nat"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral"><span class="numeral">3</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> nat"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="More_List">
<div class="head">
<h1>Theory More_List</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Simon Wimmer *)</span>
<span class="keyword1"><span class="command">theory</span></span> More_List
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../HOL/HOL/Main.html">Main</a>
    <a href="Instantiate_Existentials.html">Instantiate_Existentials</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First and Last Elements of Lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> hd_butlast_last_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">#</span> tl <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">xs</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_all</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> list_all_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">as'</span><span class="main">.</span> map <span class="free">f</span> <span class="bound">as'</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> as' a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">as'</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">list_all2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="More_List-list_all2_op_map_iff"><span class="command">lemma</span></span> list_all2_op_map_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-list_all2_last"><span class="command">lemma</span></span> list_all2_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>last <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-list_all2_set1"><span class="command">lemma</span></span> list_all2_set1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">xa</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-list_all2_swap"><span class="command">lemma</span></span> list_all2_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="More_List-list_all2_set2"><span class="command">lemma</span></span> list_all2_set2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xa</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> list_all2_set1<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list_all2_swap<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Distinct lists›</span></span>

<span class="comment1">(* XXX Duplication with Floyd_Warshall.thy *)</span>
<span class="keyword1" id="More_List-distinct_length_le"><span class="command">lemma</span></span> distinct_length_le<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≤</span> card <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">filter</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="More_List-filter_eq_appendD"><span class="command">lemma</span></span> filter_eq_appendD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs'</span> <span class="bound">ys'</span><span class="main">.</span> filter <span class="free">P</span> <span class="bound">xs'</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">as</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> list"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">as</span></span></span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> filter_eq_ConsD<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>set <span class="skolem">us</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">us</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs'</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys</span></span></span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-list_all2_elem_filter"><span class="command">lemma</span></span> list_all2_elem_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons1<span class="main">)</span>

<span class="keyword1" id="More_List-list_all2_replicate_elem_filter"><span class="command">lemma</span></span> list_all2_replicate_elem_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">(</span>concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_elem_filter <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_append1<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sublists›</span></span>

<span class="keyword1" id="More_List-nths_split"><span class="command">lemma</span></span> nths_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> nths <span class="free">xs</span> <span class="free">A</span> <span class="main">@</span> nths <span class="free">xs</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="var">?B</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∨</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">B</span><span class="main">}</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nths_Cons
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> Cons.prems Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-nths_nth"><span class="command">lemma</span></span> nths_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-nths_shift"><span class="command">lemma</span></span> nths_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nths <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> nths <span class="free">ys</span> <span class="main">{</span><span class="bound">x</span> <span class="main">-</span> length <span class="free">xs</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">-</span> length <span class="skolem">xs</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> Suc <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x x'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Cons.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-nths_eq_ConsD"><span class="command">lemma</span></span> nths_eq_ConsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">I</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span>
      <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> length <span class="bound">ys</span><span class="main">)</span>
      <span class="main">∧</span> nths <span class="bound">zs</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span> <span class="main">-</span> length <span class="bound">ys</span> <span class="main">-</span> <span class="main">1</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> length <span class="bound">ys</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nths_Cons
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> list"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">nths</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Cons.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys zs
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ys</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs</span></span></span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">nths</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ i
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-nths_out_of_bounds"><span class="command">lemma</span></span> nths_out_of_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">I</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="comment1">(* Found by sledgehammer *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">N</span> <span class="bound">as</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∧</span> <span class="main">¬</span> length <span class="main">(</span><span class="bound">as</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">asa</span><span class="main">.</span> nths <span class="main">(</span><span class="bound">as</span> <span class="main">@</span> <span class="bound">asa</span><span class="main">)</span> <span class="bound">N</span> <span class="main">=</span> nths <span class="bound">asa</span> <span class="main">{</span><span class="bound">n</span> <span class="main">-</span> length <span class="bound">as</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nths_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">N</span> <span class="bound">as</span><span class="main">.</span>
      <span class="skolem">nn</span> <span class="bound">N</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∧</span> <span class="main">¬</span> length <span class="bound">as</span> <span class="main">≤</span> <span class="skolem">nn</span> <span class="bound">N</span> <span class="bound">as</span>
    <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">asa</span><span class="main">.</span> nths <span class="main">(</span><span class="bound">as</span> <span class="main">@</span> <span class="bound">asa</span><span class="main">)</span> <span class="bound">N</span> <span class="main">=</span> nths <span class="bound">asa</span> <span class="main">{</span><span class="bound">n</span> <span class="main">-</span> length <span class="bound">as</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> nths <span class="bound">as</span> <span class="main">{</span><span class="bound">n</span> <span class="main">-</span> length <span class="free">xs</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span> <span class="main">=</span> nths <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="bound">as</span><span class="main">)</span> <span class="free">I</span>
      <span class="main">∨</span> nths <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> nths_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-nths_eq_appendD"><span class="command">lemma</span></span> nths_eq_appendD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">I</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span>
        <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> nths <span class="bound">ys</span> <span class="free">I</span> <span class="main">=</span> <span class="free">as</span>
        <span class="main">∧</span> nths <span class="bound">zs</span> <span class="main">{</span><span class="bound">i</span> <span class="main">-</span> length <span class="bound">ys</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≥</span> length <span class="bound">ys</span><span class="main">}</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> list"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"nths <span class="free"><span class="free"><span class="free">bs</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ys</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nths_eq_ConsD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@</span> <span class="free">bs</span>"</span></span><span class="main">]</span> Cons.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">zs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys'</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> length <span class="skolem">ys'</span>"</span></span>
    <span class="quoted"><span class="quoted">"nths <span class="skolem">zs'</span> <span class="main">{</span><span class="bound">i</span> <span class="main">-</span> length <span class="skolem">ys'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> length <span class="skolem">ys'</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹nths <span class="skolem">zs'</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ys'' zs'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">ys'</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ys''</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs''</span></span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_out_of_bounds nths_append nths_Cons<span class="main">)</span>
        <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys''</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys''</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">nths</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs''</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs''</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">nths</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span> <span class="comment1">(* Slow *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_List-filter_nths_length"><span class="command">lemma</span></span> filter_nths_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="free">xs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="comment1">(* Found by sledgehammer *)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xsa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="skolem">xsa</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span> <span class="bound">bs</span> <span class="bound">N</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="bound">N</span> <span class="keyword1">then</span> nths <span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">N</span> <span class="main">=</span>
        <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">@</span> nths <span class="bound">bs</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">}</span> <span class="keyword1">else</span> nths <span class="main">(</span><span class="bound">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">N</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> nths <span class="bound">bs</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="bound">N</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span>
      <span class="quoted"><span class="quoted">"nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span>
        <span class="main">⟶</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span>
      <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> filter <span class="free">P</span> <span class="main">(</span>nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span> <span class="main">≠</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span>
            <span class="quoted"><span class="quoted">"nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> nths <span class="skolem">xsa</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Ia</span><span class="main">}</span>
            <span class="main">∧</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xsa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_Nil filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impossible_Cons<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f3 f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans le_cases<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f6 f5 f4 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_mono append_Cons append_Nil filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>nths <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span> <span class="skolem">Ia</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span>
</pre>
</div><div id="Stream_More">
<div class="head">
<h1>Theory Stream_More</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Stream_More
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Sequence_LTL.html">Sequence_LTL</a>
  <a href="Instantiate_Existentials.html">Instantiate_Existentials</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*

(* TODO: can be replaced by stream.rel_cases *)
lemma stream_all2_Cons1:
  "stream_all2 P (y ## ys) xs ⟷ (∃ x xs'. xs = x ## xs' ∧ P y x ∧ stream_all2 P ys xs')"
  by (cases xs) auto
lemma stream_all2_Cons2:
  "stream_all2 P xs (y ## ys) ⟷ (∃ x xs'. xs = x ## xs' ∧ P x y ∧ stream_all2 P xs' ys)"
  by (cases xs) auto

(* TODO: inline? *)
lemma filter_list_all_iff: "filter P xs = [] ⟷ list_all (Not ∘ P) xs"
  unfolding filter_empty_conv list.pred_set by simp

(* TODO: inline? *)
lemma append_single_shift: "(xs @ [x]) @- ys = xs @- x ## ys" by simp

(* TODO: inline? *)
lemma sset_finite_decomp:
  assumes "finite (sset w)"
  obtains u v a w'
  where "w = u @- a ## v @- a ## w'"
  using sdistinct_infinite_sset not_sdistinct_decomp assms by metis

*)</span>

<span class="keyword1" id="Stream_More-list_all_stake_least"><span class="command">lemma</span></span> list_all_stake_least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="var">?n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_stake_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-alw_stream_all2_mono"><span class="command">lemma</span></span> alw_stream_all2_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">Q</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> stream_all2 <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">R</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms stream.rel_sel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Stream_More-alw_ev_HLD_cycle"><span class="command">lemma</span></span> alw_ev_HLD_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(∈)</span> <span class="free">xs</span> <span class="main">(</span>cycle <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">a</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">coinduct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infs <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(∈)</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>stake <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="main">(</span>cycle <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(∈)</span> <span class="main">(</span>sdrop <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="main">(</span>cycle <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infs stream_rel_shift stake_sdrop length_stake <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="main">(</span>cycle <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="main">(</span>cycle <span class="free">as</span><span class="main">)</span> <span class="main">=</span> cycle <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdrop_cycle_eq 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>stake <span class="main">(</span>length <span class="free">as</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> list.in_rel 3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> IntI empty_iff mem_Collect_eq set_zip_leftD split_conv subsetCE zip_map_fst_snd<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-alw_ev_mono"><span class="command">lemma</span></span> alw_ev_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">φ</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">ψ</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alw_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ev_mono assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop<span class="main">)</span>

<span class="keyword1" id="Stream_More-alw_ev_lockstep"><span class="command">lemma</span></span> alw_ev_lockstep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">Q</span> <span class="free">xs</span> <span class="free">as</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw.cases assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ev_holds_sset stream_all2_sset1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw.cases stream.rel_sel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹sfilter, wait, nxt›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful?›</span></span>
<span class="keyword1" id="Stream_More-nxt_holds_iff_snth"><span class="command">lemma</span></span> nxt_holds_iff_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nxt <span class="main">^^</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful?›</span></span>
<span class="keyword1" id="Stream_More-wait_LEAST"><span class="command">lemma</span></span> wait_LEAST<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wait <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wait_def nxt_holds_iff_snth <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Stream_More-sfilter_SCons_decomp"><span class="command">lemma</span></span> sfilter_SCons_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys'</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys'</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="bound">zs'</span> <span class="main">∧</span> list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="bound">ys'</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span> <span class="main">∧</span> sfilter <span class="free">P</span> <span class="bound">zs'</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ev_imp_shift<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@-</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"holds <span class="free">P</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>shd <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sdrop_wait <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> sdrop_while_sdrop_LEAST<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sdrop_while <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> sdrop <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sdrop_while <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> shd <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">=</span> sfilter <span class="free">P</span> <span class="main">(</span>stl <span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sfilter.ctr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> stake <span class="var">?n</span> <span class="free">xs</span> <span class="main">@-</span> sdrop <span class="var">?n</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sfilter_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all_stake_least<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">zs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stake <span class="var"><span class="var"><span class="var">?n</span></span></span> <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="var"><span class="var"><span class="var">?xs</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-sfilter_SCons_decomp'"><span class="command">lemma</span></span> sfilter_SCons_decomp'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="main">(</span>wait <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G1</span>"</span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> stake <span class="main">(</span>wait <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="bound">zs'</span> <span class="main">∧</span> sfilter <span class="free">P</span> <span class="bound">zs'</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ev_imp_shift<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@-</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"holds <span class="free">P</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>shd <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sdrop_wait <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">thm</span></span> sdrop_wait
  <span class="keyword1"><span class="command">from</span></span> sdrop_while_sdrop_LEAST<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sdrop_while <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> sdrop <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sdrop_while <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wait <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> shd <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">=</span> sfilter <span class="free">P</span> <span class="main">(</span>stl <span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sfilter.ctr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> stake <span class="var">?n</span> <span class="free">xs</span> <span class="main">@-</span> sdrop <span class="var">?n</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sfilter_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all_stake_least <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wait_LEAST<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?G2</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">zs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="var"><span class="var"><span class="var">?xs</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wait_LEAST<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-sfilter_shift_decomp"><span class="command">lemma</span></span> sfilter_shift_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@-</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys'</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys'</span> <span class="main">@-</span> <span class="bound">zs'</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> sfilter <span class="free">P</span> <span class="bound">zs'</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">::</span></span></span> <span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> list"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> alw_ev_imp_ev_alw<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>ev <span class="main">_</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ev_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> sfilter_SCons_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@-</span> <span class="free">zs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ys' zs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">note</span></span> guessed <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@-</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>ev <span class="main">_</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">zs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ev_shift not_alw_iff stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹sfilter <span class="free">P</span> <span class="skolem">zs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> zs1 zs2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">with</span></span> guessed <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ys'</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">zs1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs2</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-finite_sset_sfilter_decomp"><span class="command">lemma</span></span> finite_sset_sfilter_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">ws</span> <span class="free">ys</span> <span class="free">zs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="free">ys</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sdistinct <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdistinct_infinite_sset assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> not_sdistinct_decomp<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ws ys x zs <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> guessed1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> sfilter_shift_decomp<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ys' zs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">note</span></span> guessed2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">zs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alw_shift assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_SCons_decomp<span class="main">[</span><span class="operator">OF</span> guessed2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> zs1 zs2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">note</span></span> guessed3 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">zs2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_ev_stl alw_shift assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> guessed2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> guessed3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_shift_decomp<span class="main">[</span><span class="operator">OF</span> guessed3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> zs3 zs4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">note</span></span> guessed4 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">zs4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">zs2</span>›</span></span> alw_shift guessed4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_SCons_decomp<span class="main">[</span><span class="operator">OF</span> guessed4<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> zs5 zs6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">with</span></span> guessed1 guessed2 guessed3 guessed4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span> <span class="bound">x</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@-</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">ys</span> <span class="main">@-</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ys'</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">zs1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">zs3</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">zs5</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs6</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful?›</span></span>
<span class="keyword1" id="Stream_More-sfilter_shd_LEAST"><span class="command">lemma</span></span> sfilter_shd_LEAST<span class="main">:</span>
  <span class="quoted"><span class="quoted">"shd <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sdrop_wait<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ev <span class="main">_</span> <span class="free">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sdrop_while_sdrop_LEAST<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-alw_nxt_holds_cong"><span class="command">lemma</span></span> alw_nxt_holds_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nxt <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>nxt <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> nxt_holds_iff_snth alw_iff_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Stream_More-alw_wait_holds_cong"><span class="command">lemma</span></span> alw_wait_holds_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wait <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> wait <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wait_def alw_nxt_holds_cong<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Stream_More-alw_sfilter"><span class="command">lemma</span></span> alw_sfilter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sfilter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> sfilter <span class="free">Q</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> stream_eq
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ev_one<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ev_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"holds <span class="free"><span class="free"><span class="free">Q</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">assumption</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> shd <span class="main">(</span>sfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> shd <span class="main">(</span>sfilter <span class="free">Q</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev_one <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sfilter_shd_LEAST<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> alw_wait_holds_cong<span class="main">[</span><span class="operator">unfolded</span> wait_LEAST<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_SCons_decomp'<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> <span class="operator">OF</span> ev_one<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> u2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">note</span></span> guessed_a <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_SCons_decomp'<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> v2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">with</span></span> guessed_a <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_wait_holds_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> shift_left_inj stream.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw.cases alw_shift prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-alw_ev_holds_mp"><span class="command">lemma</span></span> alw_ev_holds_mp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟹</span> ev <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟹</span> ev <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ev_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Stream_More-alw_ev_conjI"><span class="command">lemma</span></span> alw_ev_conjI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> alw_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_ev_holds_mp<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Useful?›</span></span>

<span class="keyword1" id="Stream_More-alw_holds_pred_stream_iff"><span class="command">lemma</span></span> alw_holds_pred_stream_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span> pred_stream <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop stream_pred_snth<span class="main">)</span>

<span class="keyword1" id="Stream_More-alw_holds_sset"><span class="command">lemma</span></span> alw_holds_sset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_holds_pred_stream_iff stream.pred_set<span class="main">)</span>

<span class="keyword1" id="Stream_More-pred_stream_sfilter"><span class="command">lemma</span></span> pred_stream_sfilter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> alw_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_ev
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stream_pred <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> shd <span class="main">(</span>sfilter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">##</span> stl <span class="main">(</span>sfilter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sfilter <span class="free">P</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sfilter_SCons_decomp<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ys' zs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs'</span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> sfilter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream_pred<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> scons_eq sfilter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream_pred<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> alw_ev_stl alw_shift stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream_pred<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-alw_ev_sfilter_mono"><span class="command">lemma</span></span> alw_ev_sfilter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> alw_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">Q</span> <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> stream.pred_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">]</span> assms pred_stream_sfilter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Stream_More-sset_sfilter"><span class="command">lemma</span></span> sset_sfilter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sset <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>ev <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span> alw_sfilter<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>ev <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> alw_ev_sfilter_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_ev_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="main">(</span>sfilter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream_More-stream_all2_weaken"><span class="command">lemma</span></span> stream_all2_weaken<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">Q</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Stream_More-stream_all2_SCons1"><span class="command">lemma</span></span> stream_all2_SCons1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">##</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">z</span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream.collapse<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Stream_More-stream_all2_SCons2"><span class="command">lemma</span></span> stream_all2_SCons2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">##</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">z</span> <span class="free">y</span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="bound">zs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream.collapse<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Stream_More-stream_all2_combine"><span class="command">lemma</span></span> stream_all2_combine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">Q</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_all2_SCons1 stream_all2_SCons2<span class="main">)</span>

<span class="keyword1" id="Stream_More-stream_all2_shift1"><span class="command">lemma</span></span> stream_all2_shift1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="main">(</span><span class="free">xs1</span> <span class="main">@-</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">ys1</span> <span class="bound">ys2</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">ys1</span> <span class="main">@-</span> <span class="bound">ys2</span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="free">xs1</span> <span class="bound">ys1</span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="free">xs2</span> <span class="bound">ys2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_all2_SCons1 list_all2_Cons1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a xs1 ys z zs ys1 ys2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">z</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys2</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a xs1 ys ys1 ys2 z zs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">zs</span></span></span> <span class="main"><span class="main"><span class="main">@-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys2</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ys2</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Stream_More-stream_all2_shift2"><span class="command">lemma</span></span> stream_all2_shift2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">ys</span> <span class="main">(</span><span class="free">xs1</span> <span class="main">@-</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">ys1</span> <span class="bound">ys2</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">ys1</span> <span class="main">@-</span> <span class="bound">ys2</span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="bound">ys1</span> <span class="free">xs1</span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="bound">ys2</span> <span class="free">xs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list.rel_flip stream.rel_flip stream_all2_shift1<span class="main">)</span>

<span class="keyword1" id="Stream_More-stream_all2_bisim"><span class="command">lemma</span></span> stream_all2_bisim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(∈)</span> <span class="free">xs</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(∈)</span> <span class="free">ys</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">as</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a u b v as xs ys
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"shd <span class="skolem"><span class="skolem">as</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_all2_SCons1<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem">as</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_all2_SCons1<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Graphs">
<div class="head">
<h1>Theory Graphs</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Simon Wimmer *)</span>
<span class="keyword1"><span class="command">theory</span></span> Graphs
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="More_List.html">More_List</a> <a href="Stream_More.html">Stream_More</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
    <a href="Instantiate_Existentials.html">Instantiate_Existentials</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Graphs›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions and Theorems›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">steps</span> <span class="keyword2"><span class="keyword">where</span></span>
  Single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> steps.intros

<span class="keyword1" id="Graphs-steps_append"><span class="command">lemma</span></span> steps_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> tl <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> hd <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_append'"><span class="command">lemma</span></span> steps_append'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">as</span> <span class="main">=</span> hd <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">@</span> tl <span class="free">bs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_append that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">run</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> run.intros

<span class="keyword1" id="Graphs-steps_appendD1"><span class="command">lemma</span></span> steps_appendD1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_appendD2"><span class="command">lemma</span></span> steps_appendD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_appendD3"><span class="command">lemma</span></span> steps_appendD3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="free">E</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_ConsD"><span class="command">lemma</span></span> steps_ConsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> stepsD <span class="main">=</span> steps_ConsD steps_appendD1 steps_appendD2

<span class="keyword1" id="Graphs-steps_alt_induct"><span class="command">lemma</span></span> steps_alt_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Single Snoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"steps <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">E</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> steps <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> steps_appendD3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_appendI"><span class="command">lemma</span></span> steps_appendI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_append_single"><span class="command">lemma</span></span> steps_append_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-extend_run"><span class="command">lemma</span></span> extend_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-run_cycle"><span class="command">lemma</span></span> run_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>cycle <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> run
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‹cycle <span class="skolem"><span class="skolem">xs</span></span>›</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">‹stl <span class="main"><span class="main">(</span></span>cycle <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span>›</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> steps.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> cycle_Cons<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y xs'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">y</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> steps_append_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cycle_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="comment1">(* XXX Automate forward reasoning *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cycle_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-run_stl"><span class="command">lemma</span></span> run_stl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-run_sdrop"><span class="command">lemma</span></span> run_sdrop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_stl<span class="main">)</span>

<span class="keyword1" id="Graphs-run_reachable'"><span class="command">lemma</span></span> run_reachable'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-run_reachable"><span class="command">lemma</span></span> run_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> run_reachable'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Graphs-run_decomp"><span class="command">lemma</span></span> run_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span> <span class="main">∧</span> run <span class="free">ys</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>shd <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_decomp"><span class="command">lemma</span></span> steps_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span> <span class="main">∧</span> steps <span class="free">ys</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>hd <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_rotate"><span class="command">lemma</span></span> steps_rotate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> steps_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>last <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append_single<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> steps_append<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹steps <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-run_shift_coinduct"><span class="command">lemma</span></span> run_shift_coinduct<span class="main">[</span><span class="operator">case_names</span> run_shift<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">y</span> <span class="main">##</span> <span class="bound">v</span> <span class="main">∧</span> steps <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="free">E</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">(</span><span class="bound">y</span> <span class="main">##</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">##</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z zs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u' v' x' y'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">u'</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a as
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u' v' x' y'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">u'</span></span>"</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> steps_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> steps_appendI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">as</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-run_flat_coinduct"><span class="command">lemma</span></span> run_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> run_shift<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">xss</span><span class="main">.</span>
    <span class="free">R</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">##</span> <span class="bound">ys</span> <span class="main">##</span> <span class="bound">xss</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> steps <span class="bound">xs</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">(</span>last <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">##</span> <span class="bound">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>flat <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">xss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xss</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">##</span> <span class="skolem">ys</span> <span class="main">##</span> <span class="skolem">xss'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">xss'</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run_shift_coinduct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run_shift <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">xss'</span> <span class="skolem">xss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run_shift <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xss'</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"butlast <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"tl <span class="skolem"><span class="skolem">ys</span></span> <span class="main"><span class="main">@-</span></span> flat <span class="skolem"><span class="skolem">xss'</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"last <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"hd <span class="skolem"><span class="skolem">ys</span></span>"</span></span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> x1 x2 z zs
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> butlast <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">xs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">xs</span> <span class="main">@-</span> last <span class="skolem">xs</span> <span class="main">##</span> <span class="skolem">tail</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@-</span> <span class="skolem">tail</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tail</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> shift_append<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ws wss
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">wss</span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_non_empty"><span class="command">lemma</span></span> steps_non_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> steps <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_non_empty'"><span class="command">lemma</span></span> steps_non_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* XXX Generalize *)</span>
<span class="keyword1" id="Graphs-steps_replicate"><span class="command">lemma</span></span> steps_replicate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span>hd <span class="free">xs</span> <span class="main">#</span> concat <span class="main">(</span>replicate <span class="free">n</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">with</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">#</span> tl <span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> tl <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> prems Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="free">E</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reaches</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→*</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reaches</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reaches1</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇧</span><sup>+</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reaches1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Graphs-steps_reaches"><span class="command">lemma</span></span> steps_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">→*</span> last <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-steps_reaches'"><span class="command">lemma</span></span> steps_reaches'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→*</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that steps_reaches <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-reaches_steps"><span class="command">lemma</span></span> reaches_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> hd <span class="bound">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> last <span class="bound">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> steps <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→*</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z xs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">z</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graphs-reaches_steps_iff"><span class="command">lemma</span></span> reaches_steps_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→*</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> hd <span class="bound">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> last <span class="bound">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> steps <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_reaches reaches_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Graphs-steps_reaches1"><span class="command">lemma</span></span> steps_reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> rtranclp_into_tranclp2 snoc_eq_iff_butlast steps.cases steps_reaches that<span class="main">)</span>

<span class="keyword1" id="Graphs-stepsI"><span class="command">lemma</span></span> stepsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">→</span></span> hd <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-reaches1_steps"><span class="command">lemma</span></span> reaches1_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">→</span></span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">→*</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tranclpD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> reaches_steps<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">xs</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> append_butlast_last_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main"><span class="free">→</span></span> <span class="skolem">z</span>›</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stepsI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reaches1_steps_iff"><span class="command">lemma</span></span> reaches1_steps_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_reaches1 reaches1_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Graphs-reaches1_reaches_iff1"><span class="command">lemma</span></span> reaches1_reaches_iff1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main"><span class="free">→</span></span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">→*</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclpD<span class="main">)</span>

<span class="keyword1" id="Graphs-reaches1_reaches_iff2"><span class="command">lemma</span></span> reaches1_reaches_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">→*</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main"><span class="free">→</span></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Nitpick.rtranclp_unfold tranclp.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→*</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">→*</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-steps_append2"><span class="command">lemma</span></span> steps_append2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> steps_append<span class="main">)</span>

<span class="keyword1" id="Graphs-reaches1_steps_append"><span class="command">lemma</span></span> reaches1_steps_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reaches1_steps<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_last_step"><span class="command">lemma</span></span> steps_last_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">→</span></span> last <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> graphI <span class="main">=</span>
  steps.intros
  steps_append_single
  steps_reaches'
  stepsI

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Defs *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graphs with a Start Node›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Start_Defs <span class="main">=</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="main">=</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>

<span class="keyword1" id="Graphs-start_reachable"><span class="command">lemma</span></span> start_reachable<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-reachable_step"><span class="command">lemma</span></span> reachable_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-reachable_reaches"><span class="command">lemma</span></span> reachable_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">→*</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable_step<span class="main">)</span>

<span class="keyword1" id="Graphs-reachable_steps_append"><span class="command">lemma</span></span> reachable_steps_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graphI reachable_reaches<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> steps_reachable <span class="main">=</span> reachable_steps_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Graphs-reachable_steps_elem"><span class="command">lemma</span></span> reachable_steps_elem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_decomp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="comment1">(* XXX *)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹steps <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stepsD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">as</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable_reaches graphI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reachable_steps"><span class="command">lemma</span></span> reachable_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> steps <span class="bound">xs</span> <span class="main">∧</span> hd <span class="bound">xs</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> last <span class="bound">xs</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> reachable_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step.IH <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">with</span></span> step.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">xs</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">z</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graphI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reachable_cycle_iff"><span class="command">lemma</span></span> reachable_cycle_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ws</span> <span class="bound">xs</span><span class="main">.</span> steps <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="bound">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ws</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_reachable stepsD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ws</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stepsD steps_reaches1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 1
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reaches1_steps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reachable_induct"><span class="command">lemma</span></span> reachable_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> start step<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> reachable<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> reachable <span class="bound">a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">→</span></span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> reachable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> reachable_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> graphI_aggressive <span class="main">=</span>
  tranclp_into_rtranclp
  rtranclp.rtrancl_into_rtrancl
  tranclp.trancl_into_trancl
  rtranclp_into_tranclp2

<span class="keyword1"><span class="command">lemmas</span></span> graphI_aggressive1 <span class="main">=</span>
  graphI_aggressive
  steps_append'

<span class="keyword1"><span class="command">lemmas</span></span> graphI_aggressive2 <span class="main">=</span>
  graphI_aggressive
  stepsD
  steps_reaches1
  steps_reachable

<span class="keyword1"><span class="command">lemmas</span></span> graphD <span class="main">=</span>
  reaches1_steps

<span class="keyword1"><span class="command">lemmas</span></span> graphD_aggressive <span class="main">=</span>
  tranclpD

<span class="keyword1"><span class="command">lemmas</span></span> graph_startI <span class="main">=</span>
  reachable_reaches
  start_reachable

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Start Defs *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subgraphs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Edge-induced Subgraphs›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Subgraph_Defs <span class="main">=</span> G<span class="main">:</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> G'<span class="main">:</span> Graph_Defs <span class="quoted"><span class="free">E'</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph Defs *)</span>

<span class="keyword1"><span class="command">locale</span></span> Subgraph_Start_Defs <span class="main">=</span> G<span class="main">:</span> Graph_Start_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> G'<span class="main">:</span> Graph_Start_Defs <span class="quoted"><span class="free">E'</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph Start Defs *)</span>

<span class="keyword1"><span class="command">locale</span></span> Subgraph <span class="main">=</span> Subgraph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subgraph<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">E</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-non_subgraph_cycle_decomp"><span class="command">lemma</span></span> non_subgraph_cycle_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> G.reaches <span class="free">a</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">E</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">E'</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">∧</span> G.reaches <span class="bound">d</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"G.reaches1 <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> G'.reaches1 <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> G'.reaches1 <span class="free">a</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tranclp.trancl_into_trancl<span class="main">)</span> <span class="comment1">(* XXX *)</span>
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"G.reaches <span class="free">a</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">E'</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"G.reaches <span class="skolem">d</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">E'</span> <span class="skolem">y</span> <span class="skolem">z</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span> <span class="comment1">(* XXX *)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reaches"><span class="command">lemma</span></span> reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"G.reaches <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.reaches <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Graphs-reaches1"><span class="command">lemma</span></span> reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"G.reaches1 <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.reaches1 <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph *)</span>

<span class="keyword1"><span class="command">locale</span></span> Subgraph_Start <span class="main">=</span> Subgraph_Start_Defs <span class="main">+</span> Subgraph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-reachable_subgraph"><span class="command">lemma</span></span> reachable_subgraph<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G.reachable <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹G.reachable <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹G'.reaches <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> G.graph_startI mono_rtranclp<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">E'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Graphs-reachable"><span class="command">lemma</span></span> reachable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"G.reachable <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.reachable <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G.reachable_def G'.reachable_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph Start *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Node-induced Subgraphs›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Subgraph_Node_Defs <span class="main">=</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">E'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">V</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">V</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Subgraph <span class="quoted"><span class="free">E</span></span> <span class="quoted">E'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-subgraph'"><span class="command">lemma</span></span> subgraph'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"E' <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> E'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-E'_V1"><span class="command">lemma</span></span> E'_V1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"E' <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> E'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-E'_V2"><span class="command">lemma</span></span> E'_V2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"E' <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> E'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-G'_reaches_V"><span class="command">lemma</span></span> G'_reaches_V<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.reaches <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> E'_V2<span class="main">)</span>

<span class="keyword1" id="Graphs-G'_steps_V_all"><span class="command">lemma</span></span> G'_steps_V_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">V</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> E'_V2<span class="main">)</span>

<span class="keyword1" id="Graphs-G'_steps_V_last"><span class="command">lemma</span></span> G'_steps_V_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"G'.steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> E'_V2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> subgraphI <span class="main">=</span> E'_V1 E'_V2 G'_reaches_V

<span class="keyword1"><span class="command">lemmas</span></span> subgraphD <span class="main">=</span> E'_V1 E'_V2 G'_reaches_V

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph Node *)</span>


<span class="keyword1"><span class="command">locale</span></span> Subgraph_Node_Defs_Notation <span class="main">=</span> Subgraph_Node_Defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="free">E</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> E' <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> reaches <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→*</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> G'.reaches <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→*</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> reaches1 <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇧</span><sup>+</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> G'.reaches1 <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇧</span><sup>+</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 40<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Subgraph_Node_Defs_Notation *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Reachable Subgraph›</span></span>

<span class="keyword1"><span class="command">context</span></span> Graph_Start_Defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Subgraph_Node_Defs_Notation <span class="quoted"><span class="free">E</span></span> <span class="quoted">reachable</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> reachable_subgraph<span class="main">:</span> Subgraph_Node_Defs <span class="quoted"><span class="free">E</span></span> <span class="quoted">reachable</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Graphs-reachable_supgraph"><span class="command">lemma</span></span> reachable_supgraph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> E'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graph_startI<span class="main">)</span>

<span class="keyword1" id="Graphs-reachable_reaches_equiv"><span class="command">lemma</span></span> reachable_reaches_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"reaches <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">→*</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reachable_supgraph <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graph_startI graphI_aggressive<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subgraph<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graphs-reachable_reaches1_equiv"><span class="command">lemma</span></span> reachable_reaches1_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"reaches1 <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reachable_supgraph <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graph_startI graphI_aggressive<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subgraph<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graphs-reachable_steps_equiv"><span class="command">lemma</span></span> reachable_steps_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> G'.steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="quoted"><span class="quoted">‹reachable <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reachable_supgraph <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> graph_startI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Start Defs *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bundles›</span></span>

<span class="keyword1"><span class="command">bundle</span></span> graph_automation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> Graph_Defs.graphI Graph_Start_Defs.graph_startI
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>  <span class="main">=</span> Graph_Start_Defs.graphD

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bundle *)</span>

<span class="keyword1"><span class="command">bundle</span></span> reaches_steps_iff <span class="main">=</span>
  Graph_Defs.reaches1_steps_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  Graph_Defs.reaches_steps_iff  <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

<span class="keyword1"><span class="command">bundle</span></span> graph_automation_aggressive
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> graph_automation

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> Graph_Start_Defs.graphI_aggressive
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>  <span class="main">=</span> Graph_Start_Defs.graphD_aggressive

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bundle *)</span>

<span class="keyword1"><span class="command">bundle</span></span> subgraph_automation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> graph_automation

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> Subgraph_Node_Defs.subgraphI
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>  <span class="main">=</span> Subgraph_Node_Defs.subgraphD

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bundle *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simulations and Bisimulations›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Invariant <span class="main">=</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main"><span class="free">→</span></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-invariant_steps"><span class="command">lemma</span></span> invariant_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_reaches"><span class="command">lemma</span></span> invariant_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">→*</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_run"><span class="command">lemma</span></span> invariant_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> invariant run.cases<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Invariant *)</span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Invariants <span class="main">=</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main"><span class="free">→</span></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Pre<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant Q_P<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Post<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant Q_P<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_steps"><span class="command">lemma</span></span> invariant_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">Q</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant Q_P<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_run"><span class="command">lemma</span></span> invariant_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">Q</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> invariant run.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Q_P<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_reaches1"><span class="command">lemma</span></span> invariant_reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant Q_P<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Invariants *)</span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Invariant_Start <span class="main">=</span> Graph_Start_Defs <span class="main">+</span> Graph_Invariant <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_s<span class="hidden">⇩</span><sub>0</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-invariant_steps"><span class="command">lemma</span></span> invariant_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that P_s<span class="hidden">⇩</span><sub>0</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> invariant_steps<span class="main">)</span>

<span class="keyword1" id="Graphs-invariant_reaches"><span class="command">lemma</span></span> invariant_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">→*</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invariant_reaches<span class="main">[</span><span class="operator">OF</span> that P_s<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> invariant_run <span class="main">=</span> invariant_run<span class="main">[</span><span class="operator">OF</span> _ P_s<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Invariant Start *)</span>

<span class="keyword1"><span class="command">locale</span></span> Graph_Invariant_Strong <span class="main">=</span> Graph_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">→</span></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inv<span class="main">:</span> Graph_Invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> invariant<span class="main">)</span>

<span class="keyword1" id="Graphs-P_invariant_steps"><span class="command">lemma</span></span> P_invariant_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_last_invariant"><span class="command">lemma</span></span> steps_last_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_last_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> invariant_reaches <span class="main">=</span> inv.invariant_reaches

<span class="keyword1" id="Graphs-invariant_reaches1"><span class="command">lemma</span></span> invariant_reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">→<span class="hidden">⇧</span><sup>+</sup></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> invariant<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Graph Invariant *)</span>

<span class="keyword1"><span class="command">locale</span></span> Simulation_Defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∼</span></span></span></span></span></span></span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> A<span class="main">:</span> Graph_Defs <span class="quoted"><span class="free">A</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> B<span class="main">:</span> Graph_Defs <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Simulation Defs *)</span>

<span class="keyword1"><span class="command">locale</span></span> Simulation <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-simulation_reaches"><span class="command">lemma</span></span> simulation_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>

<span class="keyword1" id="Graphs-simulation_reaches1"><span class="command">lemma</span></span> simulation_reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tranclp_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>

<span class="keyword1" id="Graphs-simulation_steps"><span class="command">lemma</span></span> simulation_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">bs</span><span class="main">.</span> B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span><span class="main">)</span> <span class="free">as</span> <span class="bound">bs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> A_B_step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Graphs-simulation_run"><span class="command">lemma</span></span> simulation_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> B.run <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∧</span> stream_all2 <span class="main"><span class="free">(∼)</span></span> <span class="free">xs</span> <span class="bound">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.run <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">∼</span></span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sscan <span class="main">(</span><span class="main">λ</span> <span class="bound">a'</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">a'</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span> <span class="free">xs</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"B.run <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI_ex A_B_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A.run.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main"><span class="free">(∼)</span></span> <span class="free">xs</span> <span class="var">?ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI_ex A_B_step <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A.run.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Simulation *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Subgraph<span class="main">)</span> Subgraph_Simulation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Simulation <span class="free">E'</span> <span class="free">E</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> Simulation_Invariant <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">PB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">equiv'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">PB</span> <span class="bound">b</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Simulation <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted">equiv'</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv'_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> PA_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1" id="Graphs-simulation_reaches"><span class="command">lemma</span></span> simulation_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">PA</span> <span class="free">a'</span> <span class="main">∧</span> <span class="free">PB</span> <span class="bound">b'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simulation_reaches<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">unfolding</span></span> equiv'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graphs-simulation_steps"><span class="command">lemma</span></span> simulation_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">bs</span><span class="main">.</span> B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">PB</span> <span class="bound">b</span><span class="main">)</span> <span class="free">as</span> <span class="bound">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simulation_steps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">unfolding</span></span> equiv'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Graphs-simulation_steps'"><span class="command">lemma</span></span> simulation_steps'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">bs</span><span class="main">.</span> B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span><span class="main">)</span> <span class="free">as</span> <span class="bound">bs</span> <span class="main">∧</span> list_all <span class="free">PA</span> <span class="free">as</span> <span class="main">∧</span> list_all <span class="free">PB</span> <span class="bound">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simulation_steps<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list_all2_conv_all_nth list_all_length<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-simulation_steps'_map"><span class="command">lemma</span></span> simulation_steps'_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">bs</span><span class="main">.</span>
    B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">bs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">as</span>
    <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span><span class="main">)</span> <span class="free">as</span> <span class="bound">bs</span>
    <span class="main">∧</span> list_all <span class="free">PA</span> <span class="free">as</span> <span class="main">∧</span> list_all <span class="free">PB</span> <span class="bound">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> simulation_steps'<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">note</span></span> guessed <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> guessed <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Context for Equality Relation *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Simulation Invariant *)</span>

<span class="keyword1"><span class="command">locale</span></span> Simulation_Invariants <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PA</span> <span class="free">QA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">PB</span> <span class="free">QB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QA</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PA_QA<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PB_QB<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Pre<span class="main">:</span> Simulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Post<span class="main">:</span> Simulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">QB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> A_invs<span class="main">:</span> Graph_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> B_invs<span class="main">:</span> Graph_Invariants <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-simulation_reaches1"><span class="command">lemma</span></span> simulation_reaches1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b2</span><span class="main">.</span> B.reaches1 <span class="free">b1</span> <span class="bound">b2</span> <span class="main">∧</span> <span class="free">a2</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b2</span> <span class="main">∧</span> <span class="free">QB</span> <span class="bound">b2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A.reaches1 <span class="free">a1</span> <span class="free">a2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main"><span class="free">∼</span></span> <span class="free">b1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> Pre.simulation_reaches1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> B_invs.invariant_reaches1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pre.equiv'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-reaches1_unique"><span class="command">lemma</span></span> reaches1_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b2</span><span class="main">.</span> <span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b2</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">b2</span> <span class="main">⟹</span> <span class="bound">b2</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reaches1 <span class="free">a</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"B.reaches1 <span class="free">b</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique simulation_reaches1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Simualation Invariants *)</span>

<span class="keyword1"><span class="command">locale</span></span> Bisimulation <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_A_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> A_B<span class="main">:</span> Simulation <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> A_B_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> B_A<span class="main">:</span> Simulation <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main"><span class="free">∼</span></span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> B_A_step<span class="main">)</span>

<span class="keyword1" id="Graphs-A_B_reaches"><span class="command">lemma</span></span> A_B_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A_B.simulation_reaches<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Graphs-B_A_reaches"><span class="command">lemma</span></span> B_A_reaches<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">b</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b'</span> <span class="main"><span class="free">∼</span></span> <span class="free">a'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main"><span class="free">∼</span></span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> B_A.simulation_reaches<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bisim *)</span>

<span class="keyword1"><span class="command">locale</span></span> Bisimulation_Invariant <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">PB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_A_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> PA_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> PB_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> B_steps_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> PB_invariant.invariant_reaches

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">equiv'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">PB</span> <span class="bound">b</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bisim<span class="main">:</span> Bisimulation <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted">equiv'</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> A_B_step B_A_step<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> A_B<span class="main">:</span> Simulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> B_A<span class="main">:</span> Simulation_Invariant <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main"><span class="free">∼</span></span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">PA</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">PA</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Graphs-list_all2_inj_map_eq"><span class="command">lemma</span></span> list_all2_inj_map_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">PB</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">PA</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that inj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_map_equiv"><span class="command">lemma</span></span> steps_map_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟷</span> B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A_B.simulation_steps'_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> B_A.simulation_steps'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> that eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_inj_map_eq<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_map"><span class="command">lemma</span></span> steps_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">as</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> map <span class="free">f</span> <span class="bound">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"B.steps <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> B_A.simulation_steps'<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">PB</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PA</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> as <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">as</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-reaches_equiv"><span class="command">lemma</span></span> reaches_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"A.reaches <span class="free">a</span> <span class="free">a'</span> <span class="main">⟷</span> B.reaches <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> A_B.simulation_reaches<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="free"><span class="free">a</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> B_A.simulation_reaches<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq <span class="main"><span class="keyword3">|</span></span> <span class="operator">metis</span> inj<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Context for Equality Relation *)</span>

<span class="keyword1" id="Graphs-equiv'_D"><span class="command">lemma</span></span> equiv'_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A_B.equiv' <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> A_B.equiv'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Graphs-equiv'_rotate_1"><span class="command">lemma</span></span> equiv'_rotate_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"B_A.equiv' <span class="free">b</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"A_B.equiv' <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_A.equiv'_def A_B.equiv'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-equiv'_rotate_2"><span class="command">lemma</span></span> equiv'_rotate_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"A_B.equiv' <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"B_A.equiv' <span class="free">b</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_A.equiv'_def A_B.equiv'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-stream_all2_equiv'_D"><span class="command">lemma</span></span> stream_all2_equiv'_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="main"><span class="free">(∼)</span></span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"stream_all2 A_B.equiv' <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> stream_all2_weaken<span class="main">[</span><span class="operator">OF</span> that equiv'_D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Graphs-stream_all2_equiv'_D2"><span class="command">lemma</span></span> stream_all2_equiv'_D2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 B_A.equiv' <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> stream_all2 <span class="main"><span class="free">(∼)</span></span><span class="main">¯¯</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_A.equiv'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-stream_all2_rotate_1"><span class="command">lemma</span></span> stream_all2_rotate_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 B_A.equiv' <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> stream_all2 A_B.equiv' <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_A.equiv'_def A_B.equiv'_def<span class="main">)</span>

<span class="keyword1" id="Graphs-stream_all2_rotate_2"><span class="command">lemma</span></span> stream_all2_rotate_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 A_B.equiv' <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> stream_all2 B_A.equiv' <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_A.equiv'_def A_B.equiv'_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bisim Invariant *)</span>

<span class="keyword1"><span class="command">locale</span></span> Bisimulation_Invariants <span class="main">=</span> Simulation_Defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PA</span> <span class="free">QA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">PB</span> <span class="free">QB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_B_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_A_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a'</span> <span class="bound">b'</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free">∼</span></span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main"><span class="free">∼</span></span> <span class="bound">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QA</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B_invariant<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PA_QA<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PB_QB<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> PA_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> PB_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> QA_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> QB_invariant<span class="main">:</span> Graph_Invariant <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">QB</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> Pre_Bisim<span class="main">:</span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Post_Bisim<span class="main">:</span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">QB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> A_B<span class="main">:</span> Simulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(∼)</span></span>"</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> B_A<span class="main">:</span> Simulation_Invariants <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main"><span class="free">∼</span></span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> B_A_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">QB</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">QA</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> list_all2_inj_map_eq <span class="main">=</span> Post_Bisim.list_all2_inj_map_eq<span class="main">[</span><span class="operator">OF</span> eq inj<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> steps_map_equiv' <span class="main">=</span> Post_Bisim.steps_map_equiv<span class="main">[</span><span class="operator">OF</span> eq inj<span class="main">]</span>

<span class="keyword1" id="Graphs-list_all2_inj_map_eq'"><span class="command">lemma</span></span> list_all2_inj_map_eq'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">QB</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">QA</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_inj_map_eq<span class="main">)</span>

<span class="keyword1" id="Graphs-steps_map_equiv"><span class="command">lemma</span></span> steps_map_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟷</span> B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> Single
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a'</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> A_B_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="free">a</span> <span class="skolem">a'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PA</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PB</span> <span class="free">b</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="free">b</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> steps_map_equiv'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> prems that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"B.steps <span class="main">(</span><span class="free">b</span> <span class="main">#</span> map <span class="free">f</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"A.steps <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> Single
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">b'</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> B_A_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="free">b</span> <span class="skolem">b'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main"><span class="free">∼</span></span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PA</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PB</span> <span class="free">b</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">a</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> that prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QA</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">QB</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="free">a</span> <span class="skolem">a'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>›</span></span> steps_map_equiv'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="free">as</span>"</span></span><span class="main">]</span> prems that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z zs
        <span class="keyword1"><span class="command">using</span></span> inj<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-steps_map"><span class="command">lemma</span></span> steps_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">as</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> map <span class="free">f</span> <span class="bound">as</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"B.steps <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> Single
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">b'</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B_A_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">_</span> <span class="skolem">b'</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="free">PA</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">a</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QA</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">QB</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Post_Bisim.steps_map<span class="main">[</span><span class="operator">OF</span> eq inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> prems <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">bs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">a'</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ys</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Post_Bisim.reaches_equiv<span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot be lifted directly:
  injectivity cannot be applied for the reflexive case.
›</span></span>
<span class="keyword1" id="Graphs-reaches1_equiv"><span class="command">lemma</span></span> reaches1_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"A.reaches1 <span class="free">a</span> <span class="free">a'</span> <span class="main">⟷</span> B.reaches1 <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">PA</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"A.reaches1 <span class="free">a</span> <span class="free">a'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a''</span></span> <span class="keyword2"><span class="keyword">where</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">a</span> <span class="skolem">a''</span>"</span></span> <span class="quoted"><span class="quoted">"A.reaches <span class="skolem">a''</span> <span class="free">a'</span>"</span></span>
    <span class="keyword1"><span class="command">including</span></span> graph_automation_aggressive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> A_B_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="free">a</span> <span class="main">_</span>›</span></span> _ that<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a''</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QA</span> <span class="skolem">a''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">QB</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Post_Bisim.reaches_equiv<span class="main">[</span><span class="operator">OF</span> eq inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a''</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">]</span> prems <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a''</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B.reaches1 <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"B.reaches1 <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"B.reaches <span class="skolem">b</span> <span class="main">(</span><span class="free">f</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">including</span></span> graph_automation_aggressive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> B_A_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">_</span> <span class="skolem">b</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="free">PA</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">PB</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">a</span> <span class="skolem">a''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a''</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QA</span> <span class="skolem">a''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">QB</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Post_Bisim.reaches_equiv<span class="main">[</span><span class="operator">OF</span> eq inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a''</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">]</span> prems <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="free">a</span> <span class="skolem">a''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a''</span> <span class="main"><span class="free">∼</span></span> <span class="skolem">b</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"A.reaches1 <span class="free">a</span> <span class="free">a'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Context for Equality Relation *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bisim Invariant *)</span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_composition"><span class="command">lemma</span></span> Bisimulation_Invariant_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim1</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">B</span> <span class="free">C</span> <span class="free">sim2</span> <span class="free">PB</span> <span class="free">PC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">C</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim1</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim2</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">PA</span> <span class="free">PC</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> Bisimulation_Invariant <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">PC</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.A_B_step B.A_B_step <span class="main"><span class="keyword3">|</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.B_A_step B.B_A_step<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_filter"><span class="command">lemma</span></span> Bisimulation_Invariant_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">sim</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">FA</span> <span class="bound">a</span> <span class="main">⟷</span> <span class="free">FB</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FA</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">A'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FB</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">B'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A'</span> <span class="free">B'</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FA</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FB</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> unfold
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> B_A_step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariants_filter"><span class="command">lemma</span></span> Bisimulation_Invariants_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">QA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">FA</span> <span class="bound">a</span> <span class="main">⟷</span> <span class="free">FB</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FA</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">A'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FB</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">B'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A'</span> <span class="free">B'</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FA</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">FB</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> unfold
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> B_A_step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariants_composition"><span class="command">lemma</span></span> Bisimulation_Invariants_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim1</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">B</span> <span class="free">C</span> <span class="free">sim2</span> <span class="free">PB</span> <span class="free">QB</span> <span class="free">PC</span> <span class="free">QC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A</span> <span class="free">C</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim1</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim2</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PC</span> <span class="free">QC</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> Bisimulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> Bisimulation_Invariants <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span> <span class="quoted"><span class="free">PC</span></span> <span class="quoted"><span class="free">QC</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.A_B_step B.A_B_step <span class="main"><span class="keyword3">|</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.B_A_step B.B_A_step<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_Invariants_composition"><span class="command">lemma</span></span> Bisimulation_Invariant_Invariants_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim1</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">B</span> <span class="free">C</span> <span class="free">sim2</span> <span class="free">PB</span> <span class="free">QB</span> <span class="free">PC</span> <span class="free">QC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A</span> <span class="free">C</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim1</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">sim2</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="free">PA</span> <span class="free">PA</span> <span class="free">PC</span> <span class="free">QC</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> Bisimulation_Invariants <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span> <span class="quoted"><span class="free">PC</span></span> <span class="quoted"><span class="free">QC</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> Bisimulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.A_B_step B.A_B_step <span class="main"><span class="keyword3">|</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A.B_A_step B.B_A_step<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_Bisimulation_Invariants"><span class="command">lemma</span></span> Bisimulation_Invariant_Bisimulation_Invariants<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PA</span> <span class="free">PB</span> <span class="free">PB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_strengthen_post"><span class="command">lemma</span></span> Bisimulation_Invariant_strengthen_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">PA'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA'</span> <span class="free">PB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_strengthen_post'"><span class="command">lemma</span></span> Bisimulation_Invariant_strengthen_post'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PB'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">PB'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step B_A_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Simulation_Invariant_strengthen_post"><span class="command">lemma</span></span> Simulation_Invariant_strengthen_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Simulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PA'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">PA'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PA</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Simulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA'</span> <span class="free">PB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Simulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Simulation_Invariant_strengthen_post'"><span class="command">lemma</span></span> Simulation_Invariant_strengthen_post'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Simulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">PB'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">PB'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Simulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Simulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Simulation_Invariants_strengthen_post"><span class="command">lemma</span></span> Simulation_Invariants_strengthen_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Simulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">QA</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QA'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QA'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">QA</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Simulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA'</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Simulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Simulation_Invariants_strengthen_post'"><span class="command">lemma</span></span> Simulation_Invariants_strengthen_post'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"Simulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PB</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">QB'</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="free">QB'</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">QB</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Simulation_Invariants <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">QA</span> <span class="free">PB</span> <span class="free">QB'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Simulation_Invariants <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">QA</span></span> <span class="quoted"><span class="free">PB</span></span> <span class="quoted"><span class="free">QB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A_B_step assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Graphs-Bisimulation_Invariant_sim_replace"><span class="command">lemma</span></span> Bisimulation_Invariant_sim_replace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PA</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">PB</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">sim</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟷</span> <span class="free">sim'</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Bisimulation_Invariant <span class="free">A</span> <span class="free">B</span> <span class="free">sim'</span> <span class="free">PA</span> <span class="free">PB</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Bisimulation_Invariant <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">PA</span></span> <span class="quoted"><span class="free">PB</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A_B_step<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> B_A_step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span>
</pre>
</div><div id="Lib">
<div class="head">
<h1>Theory Lib</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Lib
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Timed_Automata/Timed_Automata.html">Timed_Automata.Timed_Automata</a>"</span>
          <span class="quoted">"<a href="../Timed_Automata/Approx_Beta.html">Timed_Automata.Approx_Beta</a>"</span>
          <span class="quoted">"<a href="MDP_Aux.html">MDP_Aux</a>"</span>
          <span class="quoted">"<a href="Finiteness.html">Finiteness</a>"</span>
          <span class="quoted">"<a href="Sequence_LTL.html">Sequence_LTL</a>"</span>
          <span class="quoted">"<a href="Instantiate_Existentials.html">Instantiate_Existentials</a>"</span>
          <span class="quoted">"<a href="Graphs.html">Graphs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Misc›</span></span>

<span class="keyword1" id="Lib-measurable_pred_stream"><span class="command">lemma</span></span> measurable_pred_stream<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set sset_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-pmf_map_pmf_cong"><span class="command">lemma</span></span> pmf_map_pmf_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">μ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">μ</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y1</span> <span class="main">⟷</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span> <span class="free">y1</span> <span class="main">=</span> pmf <span class="main">(</span>map_pmf <span class="free">g</span> <span class="free">μ</span><span class="main">)</span> <span class="free">y2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pmf_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_pmf.finite_measure_eq_AE<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff assms <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator
     <span class="main">)</span>

<span class="keyword1" id="Lib-collect_pair_finite"><span class="command">lemma</span></span> collect_pair_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> finite_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-collect_pair_finite'"><span class="command">lemma</span></span> collect_pair_finite'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> finite_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is what we actually need in this theory›</span></span>
<span class="keyword1" id="Lib-collect_pair_finite''"><span class="command">lemma</span></span> collect_pair_finite''<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> finite_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-finite_imageI'"><span class="command">lemma</span></span> finite_imageI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-finite_imageI''"><span class="command">lemma</span></span> finite_imageI''<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move/should be somewhere already *)</span>
<span class="keyword1" id="Lib-pred_stream_stl"><span class="command">lemma</span></span> pred_stream_stl<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">φ</span> <span class="free">xs</span> <span class="main">⟶</span> pred_stream <span class="free">φ</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Should be somewhere already *)</span>
<span class="keyword1" id="Lib-stream_all_pred_stream"><span class="command">lemma</span></span> stream_all_pred_stream<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all <span class="main">=</span> pred_stream"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>

<span class="keyword1" id="Lib-pred_stream_iff"><span class="command">lemma</span></span> pred_stream_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">s</span> <span class="main">⟷</span> Ball <span class="main">(</span>sset <span class="free">s</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> stream_all_iff<span class="main">[</span><span class="operator">unfolded</span> stream_all_pred_stream<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-measure_pmf_eq_1_iff"><span class="command">lemma</span></span> measure_pmf_eq_1_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="free">μ</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> measure_pmf.prob_eq_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">μ</span></span><span class="main">]</span> set_pmf_subset_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">μ</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_eq_measure AE_measure_pmf_iff<span class="main">)</span>

<span class="keyword1" id="Lib-HLD_mono"><span class="command">lemma</span></span> HLD_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HLD <span class="free">S</span> <span class="free">ω</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"HLD <span class="free">R</span> <span class="free">ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> HLD_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lib-alw_HLD_smap"><span class="command">lemma</span></span> alw_HLD_smap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">ω</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">S</span><span class="main">)</span> <span class="free">ω</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HLD_mono alw_mono<span class="main">)</span>

<span class="keyword1" id="Lib-alw_disjoint_ccontr"><span class="command">lemma</span></span> alw_disjoint_ccontr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">S</span><span class="main">)</span> <span class="free">ω</span>"</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="main">(</span>HLD <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">S</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">R</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_sdrop sdrop_wait<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-stream_all2_refl"><span class="command">lemma</span></span> stream_all2_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.pred_rel eq_onp_def<span class="main">)</span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Lib-AE_all_imp_countable"><span class="command">lemma</span></span> AE_all_imp_countable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> AE_ball_countable<span class="main">)</span>

<span class="keyword1" id="Lib-AE_conj"><span class="command">lemma</span></span> AE_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"almost_everywhere <span class="free">M</span> <span class="free">P</span> <span class="main">=</span> almost_everywhere <span class="free">M</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="free">M</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1" id="Lib-list_hd_lastD"><span class="command">lemma</span></span> list_hd_lastD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> rev_exhaust<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-SUP_eq_and_INF_eq"><span class="command">lemma</span></span> SUP_eq_and_INF_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">g</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">::</span> complete_lattice<span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">⨅</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_eq SUP_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-measurable_alw_stream"><span class="command">lemma</span></span> measurable_alw_stream<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> alw_iff_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-ev_neq_start_implies_ev_neq"><span class="command">lemma</span></span> ev_neq_start_implies_ev_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>Not <span class="keyword1">o</span> HLD <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">≠</span> shd <span class="main">(</span>stl <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ev.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ev.step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> stream.collapse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-ev_sdropD"><span class="command">lemma</span></span> ev_sdropD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ev.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span> <span class="main"><span class="main">::</span></span> nat"</span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-pred_stream_sconst"><span class="command">lemma</span></span> pred_stream_sconst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">(=)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sconst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-alw_Stream"><span class="command">lemma</span></span> alw_Stream<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> alw <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> alw.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-alw_True"><span class="command">lemma</span></span> alw_True<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="free">ω</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> all_imp_alw<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-alw_conjI"><span class="command">lemma</span></span> alw_conjI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="free">P</span> <span class="keyword1">aand</span> <span class="free">Q</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">Q</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_aand<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-alw_ev_cong"><span class="command">lemma</span></span> alw_ev_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">S</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> alw <span class="main">(</span>ev <span class="free">R</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">S</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">R</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alw_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff that <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ev_cong<span class="main">)</span>

<span class="keyword1" id="Lib-alw_ev_HLD_cong"><span class="command">lemma</span></span> alw_ev_HLD_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>HLD <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> alw <span class="main">(</span>ev <span class="main">(</span>HLD <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">P</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alw_ev_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> that<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff that<span class="main">)</span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-measurable_eq_stream_space"><span class="command">lemma</span></span> measurable_eq_stream_space<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">c</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eqI_snth <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: rename, and change to LTL constants i.e. HLD, aand, nxt etc. *)</span>
<span class="keyword1" id="Lib-prop_nth_sdrop"><span class="command">lemma</span></span> prop_nth_sdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span><span class="main">≥</span><span class="free">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>sdrop <span class="free">j</span> <span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Lib-prop_nth_sdrop_pair"><span class="command">lemma</span></span> prop_nth_sdrop_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ω'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>sdrop <span class="free">j</span> <span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">j</span> <span class="free">ω'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span> <span class="quoted"><span class="free">ω'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Lib-prop_nth_stl"><span class="command">lemma</span></span> prop_nth_stl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>stl <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> Graph_Defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lib-steps_SCons_iff"><span class="command">lemma</span></span> steps_SCons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">E</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> steps <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> steps.cases<span class="main">)</span>

<span class="keyword1" id="Lib-steps_Single_True"><span class="command">lemma</span></span> steps_Single_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"steps <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lib-add_step_iff"><span class="command">lemma</span></span> add_step_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">y</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">z</span> <span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> steps <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs y
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Lib-compower_stepsD"><span class="command">lemma</span></span> compower_stepsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> steps_append_single <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc.IH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-compower_stepsD'"><span class="command">lemma</span></span> compower_stepsD'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">s'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compower_stepsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_hd_lastD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> MC_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> AE_T_iff_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> stream <span class="main">⇒</span> bool"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> Graph_Defs.steps <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">K</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="free">n</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> T <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@-</span> <span class="bound">y</span> <span class="main">##</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n x P
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_T_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Graph_Defs.steps_SCons_iff Graph_Defs.steps_Single_True<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> n'
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">##</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
      <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> prems<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_T_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> Graph_Defs.steps_SCons_iff Graph_Defs.add_step_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Lib-AE_alw_accD"><span class="command">lemma</span></span> AE_alw_accD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">s</span><span class="main">)</span> <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> acc"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">K</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> T <span class="skolem">z</span><span class="main">.</span> alw <span class="free">P</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">##</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AE_T_iff<span class="main">[</span><span class="operator">OF</span> measurable_alw_stream<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Lib-acc_relfunD"><span class="command">lemma</span></span> acc_relfunD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> acc"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">K</span> <span class="bound">a</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_imp_relpow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: If we can show measurable_alw_stream, then this subsumed by the lemma above *)</span>
<span class="keyword1" id="Lib-AE_all_accD"><span class="command">lemma</span></span> AE_all_accD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">s</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> acc"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> acc_relfunD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> acc›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">K</span> <span class="bound">a</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> * assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"Graph_Defs.steps <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="free">K</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">s'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Graph_Defs.compower_stepsD'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> AE_T_iff_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_pred_stream <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-AE_T_ev_HLD_infinite_strong'"><span class="command">lemma</span></span> AE_T_ev_HLD_infinite_strong'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">⟹</span> measure_pmf.prob <span class="main">(</span><span class="free">K</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Y</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> T <span class="free">x</span><span class="main">.</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> T <span class="free">x</span><span class="main">.</span> ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">run</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run</span> <span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span>HLD <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">suntil</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">⋅</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">F</span>

  <span class="keyword1"><span class="command">have</span></span> le_gfp<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="keyword1">aand</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="main">≤</span> gfp <span class="skolem">run</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gfp_upperbound<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ω</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">∧</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ω</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ev_induct_strong<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">ω</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> suntil.base <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_Stream run_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">ω</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> run_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> HLD <span class="free">X</span> <span class="skolem">ω</span>›</span></span> <span class="quoted"><span class="quoted">‹alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> run_def<span class="main">]</span> step<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> suntil.step<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> cont_run<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_continuous <span class="skolem">run</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf_continuous_def fun_eq_iff run_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> that <span class="keyword2"><span class="keyword">for</span></span> M x f
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suntil_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> alw_True<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> that <span class="keyword2"><span class="keyword">for</span></span> M x
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> that<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> suntil_induct_strong<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">ω</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suntil_Stream<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">ω</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suntil_Stream<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>gfp <span class="skolem">run</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_gfp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_run<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">≤</span>
    emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">aand</span> <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> HLD <span class="free">Y</span> <span class="bound">ω</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_mono_AE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ae <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> gfp <span class="skolem">run</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> le_gfp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T.emeasure_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> emeasure <span class="main">(</span>T <span class="bound">t'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space S<span class="main">.</span> <span class="bound">t</span><span class="main">∈</span><span class="free">X</span> <span class="main">∧</span> <span class="bound">t</span><span class="main">∈</span><span class="free">Y</span> <span class="main">∧</span> <span class="bound">t'</span><span class="main">∈</span><span class="free">Y</span> <span class="main">∧</span> gfp <span class="skolem">run</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∂</span><span class="free">K</span> <span class="bound">t</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span>
        <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> indicator <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> indicator <span class="free">Y</span> <span class="bound">t'</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∂</span><span class="free">K</span> <span class="bound">t</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> indicator <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="bound">t</span> <span class="main">*</span> <span class="free">r</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono mult_right_mono r ennreal_leI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator
                 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nn_integral_multc mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> measure_pmf.emeasure_eq_measure<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">*</span> <span class="free">r</span><span class="main">^</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_mult <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">r</span>›</span></span> nn_integral_multc ennreal_indicator mult.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> emeasure <span class="main">(</span>T <span class="bound">t'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space S<span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> gfp <span class="skolem">run</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∂</span><span class="free">K</span> <span class="bound">t</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span>
        emeasure <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">*</span> <span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> emeasure <span class="main">(</span>T <span class="bound">t'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> gfp <span class="skolem">run</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∂</span><span class="free">K</span> <span class="bound">t</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span>
           ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span>
        emeasure <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono_left *<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono measure_pmf.emeasure_le_1<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> emeasure <span class="main">(</span>T <span class="bound">t'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space MC_syntax.S<span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> gfp <span class="skolem">run</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∂</span><span class="free">K</span> <span class="bound">t</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span>
           ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">r</span><span class="main">^</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inf_continuous_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_run<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> run_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_suntil_disj<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_I2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Collect_T<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Collect_T<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_cmult<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">≤</span> <span class="free">r</span><span class="main">^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">≤</span> ennreal <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LIMSEQ_le_const<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_ennrealI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LIMSEQ_power_zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>T <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space <span class="main">(</span>T <span class="free">x</span><span class="main">)</span><span class="main">.</span> alw <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_ev_iff not_HLD<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Markov_Decision_Process
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lib-cfg_on_inv"><span class="command">lemma</span></span> cfg_on_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg</span><span class="main">.</span> <span class="bound">cfg</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="free">ω</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"MC.enabled <span class="free">cfg</span> <span class="free">ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> stream_pred
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">ω</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set_pmf <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"MC.enabled <span class="skolem">a</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MC.enabled_Stream<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> cont <span class="skolem">cfg</span> <span class="main">`</span> set_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-MC_T_not_sconst_strong"><span class="command">lemma</span></span> MC_T_not_sconst_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> HLD <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span> <span class="main">≠</span> sconst <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span> <span class="var">?S</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> <span class="var">?T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cfg</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span> <span class="var">?S</span> <span class="main">≤</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="var">?U</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cfg_onD_state <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emeasure_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> <span class="var">?T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MC.AE_T_ev_HLD_infinite_strong'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"enn2real <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?X</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">Y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ennreal_enn2real_if ennreal_less_one_iff zero_less_one<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> *<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> Sigma_Algebra.measure_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> enn2real_mono ennreal_one_less_top less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> AE_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MC.AE_T_enabled<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ω</span> <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">∈</span> space <span class="main">(</span>MC.T <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="quoted"><span class="quoted">"MC.enabled <span class="free">cfg</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> state<span class="main">)</span> <span class="skolem">ω</span> <span class="main">=</span> sconst <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cfg_onD_state <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfg_on_inv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">cfg</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> sset <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cfg</span>
        <span class="keyword1"><span class="command">using</span></span> stream.set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> state"</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">]</span> that <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream.pred_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="var">?S</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_holds_pred_stream_iff HLD_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_ev_not<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> not_HLD <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-MC_T_not_sconst"><span class="command">lemma</span></span> MC_T_not_sconst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span> <span class="main">≠</span> sconst <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span> <span class="var">?S</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cfg</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span> <span class="var">?S</span> <span class="main">≤</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="var">?U</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cfg_onD_state <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emeasure_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MC.AE_T_ev_HLD_infinite<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"enn2real <span class="free">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ennreal_enn2real_if ennreal_less_one_iff zero_less_one<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sigma_Algebra.measure_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> enn2real_mono ennreal_one_less_top less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MC.AE_T_enabled<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AE_I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ω</span> <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">∈</span> space <span class="main">(</span>MC.T <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="quoted"><span class="quoted">"MC.enabled <span class="free">cfg</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> state<span class="main">)</span> <span class="skolem">ω</span> <span class="main">=</span> sconst <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cfg_onD_state <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cfg_on_inv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">cfg</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> sset <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cfg</span>
        <span class="keyword1"><span class="command">using</span></span> stream.set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> state"</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">]</span> that <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream.pred_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>HLD <span class="var">?S</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_holds_pred_stream_iff HLD_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ev <span class="main">(</span>HLD <span class="main">(</span><span class="main">-</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_ev_not<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> not_HLD <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-MC_T_not_sconst'"><span class="command">lemma</span></span> MC_T_not_sconst'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> smap state <span class="bound">ω</span> <span class="main">≠</span> sconst <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MC_T_not_sconst<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Lib-K_cfg_cfg_onI"><span class="command">lemma</span></span> K_cfg_cfg_onI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>

<span class="keyword1" id="Lib-MC_acc_cfg_onI"><span class="command">lemma</span></span> MC_acc_cfg_onI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cfg</span><span class="main">,</span> <span class="free">cfg'</span><span class="main">)</span> <span class="main">∈</span> MC.acc"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> K_cfg <span class="bound">a</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cfg</span> <span class="free">cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> MC.acc_relfunD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K_cfg_cfg_onI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-non_loop_tail_strong"><span class="command">lemma</span></span> non_loop_tail_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">ω</span><span class="main">.</span> HLD <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span> <span class="main">⟶</span> ev <span class="main">(</span>HLD <span class="free">Y</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">ω</span> <span class="main">⟷</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">xs</span> <span class="main">≠</span> sconst <span class="free">u</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ω</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_ev_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">alw</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
      <span class="keyword1"><span class="command">using</span></span> MC.alw_HLD_iff_sconst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">xs</span> <span class="main">≠</span> sconst <span class="free">u</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MC.AE_T_alw<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pred_intros_logic measurable_eq_stream_space<span class="main">)</span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> MC_T_not_sconst_strong<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MC.AE_all_accD MC.AE_alw_accD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MC_acc_cfg_onI
        <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-non_loop_tail"><span class="command">lemma</span></span> non_loop_tail<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> cfg_on <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">ω</span> <span class="main">⟷</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">xs</span> <span class="main">≠</span> sconst <span class="free">u</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ω</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_ev_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">alw</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
      <span class="keyword1"><span class="command">using</span></span> MC.alw_HLD_iff_sconst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">xs</span> <span class="main">≠</span> sconst <span class="free">u</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MC.AE_T_alw<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pred_intros_logic measurable_eq_stream_space<span class="main">)</span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> MC_T_not_sconst<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MC.AE_all_accD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MC_acc_cfg_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-non_loop_tail'"><span class="command">lemma</span></span> non_loop_tail'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">cfg</span> <span class="main">∈</span> cfg_on <span class="free">x</span> <span class="main">∩</span> <span class="free">X</span><span class="main">.</span> measure_pmf <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MC.T <span class="free">cfg</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">erule</span> non_loop_tail<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Regions<span class="main">)</span> intv_const_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c1</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isGreater <span class="main">(</span><span class="free">I</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intv_const <span class="main">(</span><span class="free">I</span> <span class="free">c1</span><span class="main">)</span> <span class="main">≤</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">c1</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">c1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">c2</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">c2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="free">c1</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">c2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c2</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lib-sset_sdrop"><span class="command">lemma</span></span> sset_sdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> sset <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> sset <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sset_range<span class="main">)</span>

<span class="keyword1" id="Lib-holds_untilD"><span class="command">lemma</span></span> holds_untilD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">P</span> <span class="keyword1">until</span> holds <span class="free">Q</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> <span class="free">j</span><span class="main">.</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc.IH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1" id="Lib-frac_le_self"><span class="command">lemma</span></span> frac_le_self<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms less_trans <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less frac_eq not_less frac_lt_1<span class="main">)</span>

<span class="keyword1" id="Lib-frac_le_1I"><span class="command">lemma</span></span> frac_le_1I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms dual_order.trans frac_le_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lib-frac_le_1I'"><span class="command">lemma</span></span> frac_le_1I'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">≤</span> frac <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> frac_le_1I<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> order.strict_implies_order<span class="main">[</span><span class="operator">OF</span> frac_lt_1<span class="main">]</span>

<span class="keyword1" id="Lib-nat_eventually_critical"><span class="command">lemma</span></span> nat_eventually_critical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dec_induct less_le<span class="main">)</span>

<span class="keyword1" id="Lib-nat_eventually_critical_path"><span class="command">lemma</span></span> nat_eventually_critical_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Min_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">_</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="var">?k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹MDP Invariant›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Markov_Decision_Process_Invariant <span class="main">=</span>
  Markov_Decision_Process <span class="quoted"><span class="free">K</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf set"</span></span><span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">D</span> <span class="main">∈</span> <span class="free">K</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span> <span class="main">∈</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lib-E_invariant"><span class="command">lemma</span></span> E_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> E<span class="main">}</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> invariant <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> cfg_on <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Lib-valid_cfgI"><span class="command">lemma</span></span> valid_cfgI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">s</span> <span class="main">⟹</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_cfg_def<span class="main">)</span>

<span class="keyword1" id="Lib-valid_cfgD"><span class="command">lemma</span></span> valid_cfgD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> <span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_cfg_def<span class="main">)</span>

<span class="keyword1" id="Lib-action_closed"><span class="command">lemma</span></span> action_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">cfg</span> <span class="main">∈</span> cfg_on <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> action <span class="free">cfg</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cfg_onD_action<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> valid_cfg_state_in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> state <span class="free">cfg</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> valid_cfg_action<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> action <span class="free">cfg</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> valid_cfg_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> action <span class="free">cfg</span> <span class="main">⟹</span> cont <span class="free">cfg</span> <span class="free">s</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_cfg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> action_closed<span class="main">)</span>

<span class="keyword1" id="Lib-valid_K_cfg"><span class="command">lemma</span></span> valid_K_cfg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> <span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span> <span class="main">⟹</span> <span class="free">cfg'</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_cfg_def valid_cfg_cont<span class="main">)</span>

<span class="keyword1" id="Lib-pred_stream_valid_cfg"><span class="command">lemma</span></span> pred_stream_valid_cfg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> enabled<span class="main">:</span> <span class="quoted"><span class="quoted">"MC.enabled <span class="free">cfg</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg</span><span class="main">.</span> <span class="bound">cfg</span> <span class="main">∈</span> valid_cfg<span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> MC.enabled_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Lib-pred_stream_cfg_on"><span class="command">lemma</span></span> pred_stream_cfg_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> enabled<span class="main">:</span> <span class="quoted"><span class="quoted">"MC.enabled <span class="free">cfg</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg</span><span class="main">.</span> state <span class="bound">cfg</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="bound">cfg</span> <span class="main">∈</span> cfg_on <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid pred_stream_valid_cfg<span class="main">[</span><span class="operator">OF</span> _ enabled<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_cfgI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_cfgD valid_cfg_state_in_S<span class="main">)</span>

<span class="keyword1" id="Lib-alw_S"><span class="command">lemma</span></span> alw_S<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>T <span class="free">cfg</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> T_def <span class="keyword1"><span class="command">using</span></span> pred_stream_cfg_on <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_distr_iff<span class="main">)</span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MC.AE_T_enabled<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Finite_Markov_Decision_Process
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Invariant<span class="main">:</span> Markov_Decision_Process_Invariant
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"Invariant.valid_cfg <span class="main">=</span> valid_cfg"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Markov_Decision_Process_Invariant <span class="free">K</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_pmf_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Markov_Decision_Process_Invariant.valid_cfg <span class="free">K</span> <span class="free">S</span> <span class="main">=</span> valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Markov_Decision_Process_Invariant.valid_cfg_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_cfg_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pred_stream_cfg_on <span class="main">=</span> Invariant.pred_stream_cfg_on
   <span class="keyword2"><span class="keyword">and</span></span> pred_stream_valid_cfg <span class="main">=</span> Invariant.pred_stream_valid_cfg
   <span class="keyword2"><span class="keyword">and</span></span> alw_S <span class="main">=</span> Invariant.alw_S
   <span class="keyword2"><span class="keyword">and</span></span> valid_cfg_state_in_S <span class="main">=</span> Invariant.valid_cfg_state_in_S

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PTA">
<div class="head">
<h1>Theory PTA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PTA
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Lib.html">library/Lib</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation on a Relation›</span></span> <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thm:bisim}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_set_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_set_strong</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA-T_eq_rel_half"><span class="command">lemma</span></span> T_eq_rel_half<span class="main">[</span><span class="operator">consumes</span> 4<span class="main">,</span> <span class="operator">case_names</span> prob sets cont<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">R</span> <span class="bound">s</span> <span class="bound">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set_strong <span class="main">(</span>stream_all2 <span class="free">R</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> KL<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="free">R</span> <span class="main">(</span>rel_pmf <span class="free">R</span><span class="main">)</span> <span class="free">K</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MC_syntax.T <span class="free">K</span> <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> MC_syntax.T <span class="free">L</span> <span class="free">y</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> K<span class="main">:</span> MC_syntax <span class="quoted"><span class="free">K</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">interpret</span></span> L<span class="main">:</span> MC_syntax <span class="quoted"><span class="free">L</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="free">x</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">s</span><span class="main">.</span> <span class="free">R</span> <span class="bound">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">have</span></span> measurable_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> count_space UNIV <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> K_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">K</span> <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> KL<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> rel_pmf_imp_rel_set<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def R_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> K.T <span class="free">x</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">∈</span> streams <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K.AE_T_enabled
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">ω</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x ω <span class="keyword1"><span class="command">using</span></span> K_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> K.enabled_Stream<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> L_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">y</span> <span class="main">=</span> map_pmf <span class="free">f</span> <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>map_pmf <span class="free">f</span> <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> KL<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> xy<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf.rel_mono_strong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def pmf.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pmf.rel_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> distr <span class="main">(</span>K.T <span class="bound">x</span><span class="main">)</span> K.S <span class="main">(</span>smap <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> prob_space_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>prob_algebra K.S<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_prob_algebra K.T.prob_space_distr<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> D_eq_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?D</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x'</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stream_space_eq_sstart<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> K.acc <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> x_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ω</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"countable <span class="var">?Ω</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> countable_image K.countable_acc<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="main">(</span><span class="var">?D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="main">(</span><span class="var">?D</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> K.T.prob_space_distr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="var">?D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> sets L.S"</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="var">?D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> sets L.S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> AE_streams<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?D</span> <span class="skolem">x''</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> streams <span class="var">?Ω</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x''</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x''</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_stream_space streams_sets AE_distr_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> K.AE_T_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x''</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> alw_HLD_iff_streams
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> streams <span class="main">(</span>K.acc <span class="main">``</span> <span class="main">{</span><span class="skolem">x''</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K.acc <span class="main">``</span> <span class="main">{</span><span class="skolem">x''</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x''</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def Image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="skolem">s</span> <span class="main">∈</span> streams <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smap_streams<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> x_A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?D</span> <span class="skolem">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> streams <span class="var">?Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="var">?D</span> <span class="skolem">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> streams <span class="var">?Ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">(</span>sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?D</span> <span class="skolem">x'</span> <span class="main">(</span>sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">(</span>streams <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> AE_streams<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space.emeasure_eq_1_AE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> K.T.prob_space_distr<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> streams_sets<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_pmf <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R</span><span class="main">¯¯</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> KL<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> KL<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> pmf.rel_compp pmf.rel_flip <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R</span><span class="main">¯¯</span><span class="main">)</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map_pmf fst <span class="skolem">p</span> <span class="main">=</span> <span class="free">K</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"map_pmf snd <span class="skolem">p</span> <span class="main">=</span> <span class="free">K</span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf.in_rel<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(##)</span> <span class="skolem">y</span> <span class="main">-`</span> smap <span class="free">f</span> <span class="main">-`</span> sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span> <span class="keyword1">then</span> smap <span class="free">f</span> <span class="main">-`</span> sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">zs</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">(</span>sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y'</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="bound">y'</span> <span class="main">=</span> <span class="skolem">z</span> <span class="keyword1">then</span> <span class="var">?D</span> <span class="bound">y'</span> <span class="main">(</span>sstart <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∂</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K.T_eq_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?S</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_distr2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?S</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong_AE AE_pmfI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * space_stream_space<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> fst_A<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ab</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ab</span> <span class="main">∈</span> <span class="free">K</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">p</span>›</span></span> set_map_pmf <span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl.rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> snd_A<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ab</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ab</span> <span class="main">∈</span> <span class="free">K</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">p</span>›</span></span> set_map_pmf <span class="main">[</span><span class="operator">of</span> <span class="quoted">snd</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ab</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl.rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ** eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> nn_integral_map_pmf
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong_AE AE_pmfI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ab <span class="keyword1"><span class="command">using</span></span> p<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ab</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_A snd_A<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> L_eq_D<span class="main">:</span> <span class="quoted"><span class="quoted">"L.T <span class="free">y</span> <span class="main">=</span> <span class="var">?D</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="free">x</span> <span class="free">y</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> L.T_coinduct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cont <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Kx_Ly<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_pmf <span class="free">R</span> <span class="main">(</span><span class="free">K</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> KL<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> <span class="free">L</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span><span class="free">K</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x'</span> <span class="skolem">y'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y'</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_imp_rel_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> <span class="free">L</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">y'</span><span class="main">)</span> <span class="skolem">y'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y'</span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> D_SCons_eq_D_D<span class="main">:</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>K.T <span class="skolem">i</span><span class="main">)</span> K.S <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">##</span> smap <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?D</span> <span class="skolem">i</span><span class="main">)</span> K.S <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D_eq_D_gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?D</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">K</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">L</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Kx_Ly i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_imp_rel_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def R_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> D_eq_D<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">i</span> <span class="skolem">j</span>›</span></span><span class="main"><span class="main">]</span></span> g<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="skolem">x</span> <span class="main">=</span> measure_pmf <span class="main">(</span><span class="free">L</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> distr <span class="main">(</span><span class="var">?D</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> K.S <span class="main">(</span><span class="main">(##)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K.T_eq_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_bind<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">K.S</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_distr2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span>  <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"K.S"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distr_distr comp_def L_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont<span class="main"><span class="main">]</span></span> map_pmf_rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_distr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">K.S</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_distr2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span>  <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"K.S"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_measure_pmf_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"K.S"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_subprob_algebra space_stream_space <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> K.T.subprob_space_distr<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> D_SCons_eq_D_D D_eq_D_gi <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> distr <span class="main">(</span>K.T <span class="main">(</span><span class="skolem">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stream_space <span class="main">(</span>count_space UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="free">f</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K.T.prob_space_distr *** <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> **<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K.T.prob_space_distr<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∈</span> streams <span class="free">S</span> <span class="main">∧</span> smap <span class="free">f</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">t</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="main">∈</span> streams <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">⟹</span> smap <span class="free">f</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream.rel_refl_strong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.rel_map R_def streams_iff_sset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">∈</span> streams <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">ω</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> smap <span class="free">f</span> <span class="skolem">ω</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ω</span>
    <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_strong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K.T <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> K.T <span class="free">x</span> <span class="main">(</span>smap <span class="free">f</span> <span class="main">-`</span> <span class="free">B</span> <span class="main">∩</span> space <span class="main">(</span>K.T <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emeasure_eq_AE streams_sets<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>distr <span class="main">(</span>K.T <span class="free">x</span><span class="main">)</span> K.S <span class="main">(</span>smap <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_distr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>L.T <span class="free">y</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> L_eq_D <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> ccval <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span> <span class="main">[</span>100<span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> succ


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional Facts on Regions›</span></span>

<span class="comment1">(* XXX Move this to a theory on Timed Automata *)</span>
<span class="keyword1"><span class="command">declare</span></span> reset_set11<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> reset_set1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Defining the closest successor of a region. Only exists if at least one interval is upper-bounded.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_upper_right</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_upper_right</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* XXX Remove old successor definition *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> is_upper_right <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">R'</span><span class="main">.</span> <span class="bound">R'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> Succ <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA-region_continuous"><span class="command">lemma</span></span> region_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> between<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t2</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> R
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R cval_add_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> elem that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> between <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> intv_elem <span class="bound">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">=</span> Intv <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> elem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟷</span> frac <span class="main">(</span><span class="free">u</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="free">u</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span> <span class="main">=</span> Intv <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">y</span> <span class="main">=</span> Intv <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> A elem between <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def R<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> elem between <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def R<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">+</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">+</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nat_intv_frac_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> **<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> nat_intv_frac_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span> frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟷</span> frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-upper_right_eq"><span class="command">lemma</span></span> upper_right_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> isGreater <span class="main">(</span><span class="free">I</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> is_upper_right <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
  <span class="comment1">(* XXX Does this lemma actually need the finiteness assumption? *)</span>
  <span class="keyword1"><span class="command">from</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="skolem">u</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-bounded_region"><span class="command">lemma</span></span> bounded_region<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_upper_right <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="main">1</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> upper_right_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isGreater <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x<span class="main">(</span>1<span class="main">)</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Remove Caml case *)</span>
<span class="keyword1"><span class="command">context</span></span> AlphaClosure
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* XXX Clean *)</span>
<span class="keyword1"><span class="command">no_notation</span></span> Regions_Beta.part <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">]⇩</span>_"</span> <span class="main">[</span>61<span class="main">,</span>61<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1" id="PTA-succ_ex"><span class="command">lemma</span></span> succ_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G1</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">∈</span> Succ <span class="free">ℛ</span> <span class="free">R</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G2</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> region <span class="free">X</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span> R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">=</span> Const <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?succ</span></span></span> <span class="main">=</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">R'</span><span class="main">.</span> <span class="bound">R'</span> <span class="main">≠</span> <span class="free">R</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> Succ <span class="free">ℛ</span> <span class="free">R</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">R'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>upper_right<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> isGreater <span class="main">(</span><span class="skolem">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="main">(</span>intv<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">=</span> Intv <span class="bound">d</span> <span class="main">∧</span> <span class="var">?Z</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>const<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> isGreater <span class="main">(</span><span class="skolem">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G1</span> <span class="main">∧</span> <span class="var">?G2</span> <span class="main">∧</span> <span class="var">?G3</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> const
    <span class="keyword1"><span class="command">with</span></span> upper_right_eq<span class="main">[</span><span class="operator">OF</span> finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_upper_right <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> closest_prestable_1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> const finite R<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> closest_valid_1<span class="main">[</span><span class="operator">OF</span> const finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> R<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R'</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> R'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">≠</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span><span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> R'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> Succ <span class="free">ℛ</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SuccI3<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?succ</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> succ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> is_upper_right <span class="free">R</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> the_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">R''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R''<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">≠</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'</span><span class="main">]⇩</span><span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R''2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">=</span> region <span class="free">X</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> R'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> neq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R'<span class="main">(</span>2<span class="main">)</span> assms region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> t'' prems <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'''<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'''</span> <span class="main">≤</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'''</span> <span class="main">∈</span> <span class="skolem">R''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'''</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> region_continuous<span class="main">[</span><span class="operator">OF</span> R''2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ t'''<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> R''2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">-</span> <span class="skolem">t'''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">t'''</span>"</span></span><span class="main">]</span>
           t'' R'' regions_closed'_spec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> R''<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∈</span> <span class="skolem">R''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R''2 cval_add_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t''<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> R''<span class="main">(</span>1<span class="main">)</span> R'<span class="main">(</span>2<span class="main">)</span> region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> R' * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> intv
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">¬</span> Regions.isConst <span class="main">(</span><span class="skolem">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> isIntv <span class="main">(</span><span class="skolem">I</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> intv <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isGreater <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span> <span class="main">=</span> Intv <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">=</span> Intv <span class="bound">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> R<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"total_on <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> total_finite_trans_max<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> _ this<span class="main">]</span> finite
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">x'</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> x'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> upper_right_eq<span class="main">[</span><span class="operator">OF</span> finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_upper_right <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> closest_prestable_2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> * finite R<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> **<span class="main">]</span> closest_valid_2<span class="main">[</span><span class="operator">OF</span> * finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> **<span class="main">]</span> R<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> R'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">≠</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bounded_region<span class="main">[</span><span class="operator">OF</span> finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> R<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> is_upper_right <span class="free">R</span>›</span></span> u<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> t<span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">::</span> t<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> R'<span class="main">(</span>1<span class="main">)</span> u <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> t<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> Succ <span class="free">ℛ</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SuccI3<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> R'<span class="main">(</span>1<span class="main">)</span> neq <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?succ</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> succ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> is_upper_right <span class="free">R</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> the_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">R''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R''<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">≠</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'</span><span class="main">]⇩</span><span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R''2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R''</span> <span class="main">=</span> region <span class="free">X</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> R'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> neq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∉</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R'<span class="main">(</span>2<span class="main">)</span> assms region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> t'' prems <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'''<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'''</span> <span class="main">≤</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t'''</span> <span class="main">∈</span> <span class="skolem">R''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'''</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> region_continuous<span class="main">[</span><span class="operator">OF</span> R''2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ t'''<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> R''2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">-</span> <span class="skolem">t'''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">t'''</span>"</span></span><span class="main">]</span>
           t'' R'' regions_closed'_spec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> R''<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t''</span> <span class="main">∈</span> <span class="skolem">R''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def R''2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t''<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> R''<span class="main">(</span>1<span class="main">)</span> R'<span class="main">(</span>2<span class="main">)</span> region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> R' * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> upper_right
    <span class="keyword1"><span class="command">with</span></span> upper_right_eq<span class="main">[</span><span class="operator">OF</span> finite R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">ℛ</span> <span class="free">R</span> <span class="main">=</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SuccI3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?G1</span></span></span> <span class="var"><span class="quoted"><span class="var">?G2</span></span></span> <span class="var"><span class="quoted"><span class="var">?G3</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1" id="PTA-region_set'_closed"><span class="command">lemma</span></span> region_set'_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">r</span><span class="main">.</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"region_set' <span class="free">R</span> <span class="free">r</span> <span class="free">d</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> region_set'_id<span class="main">[</span><span class="operator">OF</span> _ _  finite<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">]</span> assms this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-clock_set_cong"><span class="command">lemma</span></span> clock_set_cong<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">r</span><span class="main">.</span> <span class="free">u</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">u</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-region_reset_not_Succ"><span class="command">lemma</span></span> region_reset_not_Succ<span class="main">:</span>
  <span class="comment1">(* XXX Declare globally? *)</span>
  <span class="keyword2"><span class="keyword">notes</span></span> regions_closed'_spec<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"region_set' <span class="free">R</span> <span class="free">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∨</span> region_set' <span class="free">R</span> <span class="free">r</span> <span class="main">0</span> <span class="main">∉</span> Succ <span class="free">ℛ</span> <span class="free">R</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms finite <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Succ.cases succ_ex<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span><span class="free">ℛ</span> <span class="main">=</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> region_unique_spec <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> region_V<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> region_set'_id<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ℛ_def<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> finite<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">]⇩</span><span class="free">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">r</span><span class="main">.</span> <span class="skolem">u</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∈</span> Succ <span class="free">ℛ</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span><span class="free">ℛ</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∈</span> <span class="free">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Succ.cases set_of_regions_spec<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> region_set'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="free">V</span>›</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def V_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="main">∈</span> <span class="free">ℛ</span>›</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> region_set'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Alpha Closure global *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Justifying Timed Until vs <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹suntil›</span></span>›</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-guard_continuous"><span class="command">lemma</span></span> guard_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊢</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span> <span class="main">⊢</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t'</span><span class="main">::</span><span class="tfree">'t</span><span class="main">::</span>time<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t'</span> <span class="main">⊢</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span><span class="main"><span class="keyword3">;</span></span>
      <span class="operator">auto</span> 4 3
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def order_le_less_subst2 order_subst2 add_increasing2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_le_trans
     <span class="main">)</span>

<span class="comment1">(* XXX Move *)</span>
<span class="comment1">(*
lemma guard_continuous:
  assumes "u ⊢ g" "u ⊕ t ⊢ g" "0 ≤ t'" "t' ≤ t"
  shows "u ⊕ t' ⊢ g"
  using assms by (auto 4 4 intro: atomic_guard_continuous simp: list_all_iff)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition and Semantics›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We do not include:
  <span class="antiquoted"><span class="antiquoted">▪</span></span> a labelling function, as we will assume that atomic propositions are simply sets of states
  <span class="antiquoted"><span class="antiquoted">▪</span></span> a fixed set of locations or clocks, as we will implicitly derive it from the set of transitions
  <span class="antiquoted"><span class="antiquoted">▪</span></span> start or end locations, as we will primarily study reachability
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> transition <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> cconstraint <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span> set <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> pmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> transition set <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> invassn"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> cconstraint <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span> set <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> pmf <span class="main">*</span> <span class="tfree">'c</span> set <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">edges</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Edges</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">{</span>edges <span class="bound">t</span> <span class="main">|</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">trans_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans_of</span> <span class="main">≡</span> fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_of</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'time</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'time</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> invassn"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_of</span> <span class="main">≡</span> snd"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> transition <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⟶⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖</span> _"</span> <span class="main">[</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">transition</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'time</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'time</span><span class="main">)</span> cconstraint <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> set <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> pmf <span class="main">⇒</span> <span class="tfree">'c</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⟶⇗</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">⇖</span> _"</span> <span class="main">[</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">,</span>61<span class="main">]</span> 61<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> ⟶<span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span></sup><span class="hidden">⇖</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">∈</span> Edges <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">locations</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locations</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="main">`</span> Edges <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> Edges <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Collecting Information About Clocks›</span></span>

<span class="comment1">(* XXX Remove sort constraints *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">collect_clkt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>time<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> transition set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">*</span><span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_clkt</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>collect_clock_pairs <span class="main">(</span>fst <span class="main">(</span>snd <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">collect_clki</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> time<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> invassn <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">*</span><span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_clki</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>collect_clock_pairs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">clkp_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> time<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">*</span> <span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clkp_set</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> collect_clki <span class="main">(</span>inv_of <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∪</span> collect_clkt <span class="main">(</span>trans_of <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">collect_clkvt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> time<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta <span class="main">⇒</span> <span class="tfree">'c</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_clkvt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> Edges <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">clocks</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">clocks</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> fst <span class="main">`</span> clkp_set <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> collect_clkvt <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_abstraction</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_abstraction</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> clkp_set <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span><span class="main">)</span> <span class="main">∧</span> collect_clkvt <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="PTA-valid_abstractionD"><span class="command">lemma</span></span> valid_abstractionD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_abstraction <span class="free">A</span> <span class="free">X</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> clkp_set <span class="free">A</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"collect_clkvt <span class="free">A</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> valid_abstraction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-valid_abstractionI"><span class="command">lemma</span></span> valid_abstractionI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> clkp_set <span class="free">A</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"collect_clkvt <span class="free">A</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_abstraction <span class="free">A</span> <span class="free">X</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> valid_abstraction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operational Semantics as an MDP›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">clock_set_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set <span class="main">⇒</span> <span class="tfree">'t</span><span class="main">::</span>time <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'t</span><span class="main">)</span> cval <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'t</span><span class="main">)</span> cval"</span></span>
<span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">:=</span>_<span class="keyword1">]</span>_"</span> <span class="main">[</span>65<span class="main">,</span>65<span class="main">,</span>65<span class="main">]</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free">:=</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> clock_set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">region_set'</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">region_set_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set <span class="main">⇒</span> <span class="tfree">'t</span><span class="main">::</span>time <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'t</span><span class="main">)</span> zone <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'t</span><span class="main">)</span> zone"</span></span>
<span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">::=</span>_<span class="keyword1">]</span>_"</span> <span class="main">[</span>65<span class="main">,</span>65<span class="main">,</span>65<span class="main">]</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free">::=</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> region_set' <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> zone_set <span class="main">(</span><span class="quoted">"_<span class="keyword1">⇘</span>_ <span class="keyword1">→</span> <span class="keyword1">0⇙</span>"</span> <span class="main">[</span>71<span class="main">]</span> 71<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zone_set_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>time<span class="main">)</span> zone <span class="main">⇒</span> <span class="tfree">'c</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> zone"</span></span>
<span class="main">(</span><span class="quoted">"_<span class="keyword1">⇘</span>_ <span class="keyword1">→</span> <span class="keyword1">0⇙</span>"</span> <span class="main">[</span>71<span class="main">]</span> 71<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main"><span class="free">→</span></span> 0</sub><span class="hidden">⇙</span> <span class="main">≡</span> zone_set <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ccval</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span> <span class="main">[</span>100<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ccval</span> <span class="free"><span class="bound"><span class="entity">cc</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">cc</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Probabilistic_Timed_Automaton <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> time<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> admissible_targets<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">g</span><span class="main">⦄</span><span class="hidden">⇘</span><sub><span class="free">X</span> <span class="main">→</span> 0</sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free">l'</span><span class="main">⦄</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> clocks <span class="free">A</span>"</span></span>
  <span class="comment1">― ‹Not necessarily what we want to have›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Definition›</span></span> <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹ \label{sem:mdp} ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> locations <span class="free">A</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒳</span> <span class="main">=</span> clocks <span class="free">A</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> L <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="bound">u</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="bound">l</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> cval<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> cval<span class="main">)</span> pmf set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> cval<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Passage of time›</span> delay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span> return_pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">K</span> <span class="free">st</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Discrete transitions›</span> action<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
  <span class="main">⟹</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="bound">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> <span class="free">K</span> <span class="free">st</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Self loops -- Note that this does not assume <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>st ∈ S›</span></span>›</span> loop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"return_pmf <span class="free">st</span> <span class="main">∈</span> <span class="free">K</span> <span class="free">st</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> K.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">sublocale</span></span> MDP<span class="main">:</span> Markov_Decision_Process <span class="quoted">K</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Probabilistic Timed Automaton *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Constructing the Corresponding Finite MDP on Regions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Probabilistic_Timed_Automaton_Regions <span class="main">=</span>
  Probabilistic_Timed_Automaton <span class="quoted"><span class="free">A</span></span> <span class="main">+</span> Regions <span class="quoted">𝒳</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta"</span></span> <span class="main">+</span>
  <span class="comment1">― ‹The following are necessary to obtain a <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>finite›</span></span> MDP›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite 𝒳"</span></span> <span class="quoted"><span class="quoted">"finite L"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>trans_of <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_trivial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span> <span class="main">∈</span> L<span class="main">.</span> <span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">.</span> <span class="bound">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="bound">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_abstraction <span class="free">A</span> 𝒳 <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> finite_ℛ <span class="main">=</span> finite_ℛ<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Definition›</span></span> <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹ \label{sem:mdprg} ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒮</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span> <span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> L <span class="main">∧</span> <span class="bound">R</span> <span class="main">∈</span> ℛ <span class="main">∧</span> <span class="bound">R</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="bound">l</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="comment1">(* XXX Move definition of V somewhere else *)</span>
<span class="keyword1" id="PTA-S_alt_def"><span class="command">lemma</span></span> S_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> L <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> V <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="bound">l</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note how we relax the definition to allow more transitions in the first case.
  To obtain a more compact MDP the commented out version can be used an proved equivalent.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
 <span class="entity">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> pmf set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(* 
  -- "Passage of time" delay:
  "st ∈ 𝒮 ⟹ st = (l,R) ⟹ succ ℛ R ⊆ ⦃inv_of A l⦄ ⟹ return_pmf (l, succ ℛ R) ∈ 𝒦 st" |
  *)</span>
   <span class="comment1">― ‹Passage of time›</span> delay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">∈</span> Succ ℛ <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦄</span> <span class="main">⟹</span> return_pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">𝒦</span> <span class="free">st</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Discrete transitions›</span> action<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⊆</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⦄</span>
  <span class="main">⟹</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> region_set' <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="bound">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">∈</span> <span class="free">𝒦</span> <span class="free">st</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Self loops -- Note that this does not assume <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>st ∈ 𝒮›</span></span>›</span> loop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"return_pmf <span class="free">st</span> <span class="main">∈</span> <span class="free">𝒦</span> <span class="free">st</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> 𝒦.intros


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Many Closure Properties›</span></span>

<span class="keyword1" id="PTA-transition_def"><span class="command">lemma</span></span> transition_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Edges_def edges_def trans_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-transitionI"><span class="command">lemma</span></span> transitionI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> transition_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="PTA-transitionD"><span class="command">lemma</span></span> transitionD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> transition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-bex_Edges"><span class="command">lemma</span></span> bex_Edges<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> Edges <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l</span> <span class="bound">g</span> <span class="bound">μ</span> <span class="bound">X</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">A</span> <span class="main">⊢</span> <span class="bound">l</span> ⟶<span class="hidden">⇗</span><sup><span class="bound">g</span><span class="main">,</span><span class="bound">μ</span><span class="main">,</span><span class="bound">X</span></sup><span class="hidden">⇖</span> <span class="bound">l'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">,</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-L_trans"><span class="command">lemma</span></span> L_trans<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> L"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> L"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L_def locations_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff bex_Edges transition_def<span class="main">)</span>

<span class="keyword1" id="PTA-transition_𝒳"><span class="command">lemma</span></span> transition_𝒳<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> 𝒳_def collect_clkvt_def clkp_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-admissible_targets_alt"><span class="command">lemma</span></span> admissible_targets_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">g</span><span class="main">⦄</span><span class="hidden">⇘</span><sub><span class="free">X</span> <span class="main">→</span> 0</sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free">l'</span><span class="main">⦄</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> clocks <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> admissible_targets<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PTA-V_reset_closed"><span class="command">lemma</span></span> V_reset_closed<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">(</span><span class="free">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">]</span><span class="free">u</span> <span class="main">∈</span> V"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> V_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> V_reset_closed'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> V_reset_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="PTA-regions_part_ex"><span class="command">lemma</span></span> regions_part_ex<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms regions_partition<span class="main">[</span><span class="operator">OF</span> meta_eq_to_obj_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ℛ_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> ℛ <span class="main">∧</span> <span class="free">u</span> <span class="main">∈</span> <span class="bound">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_interp.region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-rep_ℛ_ex"><span class="command">lemma</span></span> rep_ℛ_ex<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-V_nn_closed"><span class="command">lemma</span></span> V_nn_closed<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V <span class="main">⟹</span> <span class="free">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span> <span class="main">∈</span> V"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> V_def cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-K_S_closed"><span class="command">lemma</span></span> K_S_closed<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> K.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_alt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> admissible_targets<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> zone_set_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="PTA-S_V"><span class="command">lemma</span></span> S_V<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> V"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> S_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-L_V"><span class="command">lemma</span></span> L_V<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> L"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-𝒮_V"><span class="command">lemma</span></span> 𝒮_V<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> <span class="free">R</span> <span class="main">∈</span> ℛ"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-admissible_targets'"><span class="command">lemma</span></span> admissible_targets'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="main">⦃</span><span class="free">g</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">0</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free">l'</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> admissible_targets<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> region_set'_def zone_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Region Graph is a Finite MDP›</span></span>

<span class="keyword1" id="PTA-𝒮_finite"><span class="command">lemma</span></span> 𝒮_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite 𝒮"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite finite_ℛ <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-𝒦_finite"><span class="command">lemma</span></span> 𝒦_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>𝒦 <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">R'</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">∧</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> Succ ℛ <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="bound">l</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">R'</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="var">?B1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">R'</span> <span class="bound">l</span> <span class="bound">R</span><span class="main">.</span> <span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">∧</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> Succ ℛ <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="bound">l</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> region_set' <span class="bound">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="bound">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">μ</span>
             <span class="main">|</span> <span class="bound">R</span> <span class="bound">μ</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">∧</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span> <span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">∧</span> <span class="bound">R</span> <span class="main">⊆</span> <span class="main">⦃</span><span class="bound">g</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B1</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">R'</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="bound">R'</span> <span class="main">∈</span> ℛ <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮 <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 𝒮_finite finite_ℛ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">R'</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="var">?B1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?S1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">μ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> PTA.trans_of <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">`</span> PTA.trans_of <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> finite<span class="main">(</span>3<span class="main">)</span> finite_ℛ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> ℛ <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">∧</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span> <span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">∧</span> <span class="bound">R</span> <span class="main">⊆</span> <span class="main">⦃</span><span class="bound">g</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">…</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="free">st</span> <span class="main">∈</span> 𝒮 <span class="main">∧</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span> <span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span> <span class="main">∧</span> <span class="bound">R</span> <span class="main">⊆</span> <span class="main">⦃</span><span class="bound">g</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒦 <span class="free">st</span> <span class="main">=</span> <span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span> <span class="main">∪</span> <span class="main">{</span>return_pmf <span class="free">st</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒦.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Obsolete in here, move to Regions *)</span>
<span class="keyword1" id="PTA-ℛ_not_empty"><span class="command">lemma</span></span> ℛ_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℛ <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> Const <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"region 𝒳 <span class="var">?I</span> <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="var">?I</span> <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> Const <span class="main">0</span> <span class="main">=</span> Intv <span class="bound">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="main">{}</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total_on <span class="main">{}</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> Regions.valid_intv <span class="main">(</span><span class="free">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Const <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ℛ <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-𝒮_not_empty"><span class="command">lemma</span></span> 𝒮_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒮 <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> not_trivial <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> L"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℛ_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">∈</span>collect_clock_pairs <span class="main">(</span>inv_of <span class="free">A</span> <span class="skolem">l</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clkp_set_def collect_clki_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ccompatible<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">]</span> R st<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="skolem">l</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ccompatible_def ccval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> st<span class="main">(</span>1<span class="main">)</span> R<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-𝒦_𝒮_closed"><span class="command">lemma</span></span> 𝒦_𝒮_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">D</span><span class="main">∈</span>𝒦 <span class="free">s</span><span class="main">.</span> set_pmf <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> 𝒮"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒦.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alpha_interp.succ_ex<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> 𝒮›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">l'</span> <span class="skolem">R'</span> <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">R</span> <span class="skolem">g</span> <span class="skolem">μ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="skolem">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">μ</span><span class="main">,</span> <span class="skolem">X</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> edges <span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">μ</span><span class="main">,</span> <span class="skolem">X</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> Edges <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Edges_def trans_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> L"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> L_def locations_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="skolem">l'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">using</span></span> admissible_targets'<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> *<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    
    <span class="keyword1"><span class="command">from</span></span> admissible_targets<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒳_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> alpha_interp.region_set'_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span><span class="main">]</span> prems<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> *<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def 𝒳_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> R_G<span class="main">:</span> Finite_Markov_Decision_Process <span class="quoted">𝒦</span> <span class="quoted">𝒮</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒮_finite 𝒮_not_empty 𝒦_finite 𝒦_𝒮_closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> 𝒦_𝒮_closed'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> R_G.set_pmf_closed


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relating the MDPs›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translating From K to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒦›</span></span></span></span>›</span></span>

<span class="comment1">(* XXX Clean this for regular automata too *)</span>
<span class="comment1">(* Assumption of valid too strong? i.e. do not need l ∈ L here *)</span>
<span class="keyword1" id="PTA-ccompatible_inv"><span class="command">lemma</span></span> ccompatible_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccompatible ℛ <span class="main">(</span>inv_of <span class="free">A</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">∈</span>collect_clock_pairs <span class="main">(</span>inv_of <span class="free">A</span> <span class="free">l</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_abstraction_def clkp_set_def collect_clki_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ccompatible<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted">𝒳</span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-ccompatible_guard"><span class="command">lemma</span></span> ccompatible_guard<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccompatible ℛ <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms valid <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">∈</span>collect_clock_pairs <span class="free">g</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">ℕ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_abstraction_def clkp_set_def collect_clkt_def trans_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms ccompatible<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted">𝒳</span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ccompatible_def <span class="main">=</span> ccompatible_def<span class="main">[</span><span class="operator">unfolded</span> ccval_def<span class="main">]</span>

<span class="keyword1" id="PTA-region_set'_eq"><span class="command">lemma</span></span> region_set'_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="free">l</span> ⟶<span class="hidden">⇗</span><sup><span class="free">g</span><span class="main">,</span><span class="free">μ</span><span class="main">,</span><span class="free">X</span></sup><span class="hidden">⇖</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> admissible_targets_alt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> 𝒳_def finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?r</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> someI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> valid assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?r</span> <span class="main">⊆</span> 𝒳"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transition_𝒳<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> region_set'_id<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">𝒳</span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-regions_part_ex_reset"><span class="command">lemma</span></span> regions_part_ex_reset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">(</span><span class="free">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">]</span><span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-reset_sets_all_equiv"><span class="command">lemma</span></span> reset_sets_all_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">(</span><span class="free">d</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">x</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">ρ</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> u<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="free">d</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="free">x</span> <span class="main">=</span> Const <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> I assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">x</span> <span class="free">u'</span> <span class="main">(</span><span class="skolem">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">x</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-reset_eq"><span class="command">lemma</span></span> reset_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">r'</span> <span class="main">⊆</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span> <span class="main">=</span> <span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u'</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">using</span></span> reset_sets_all_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="skolem">u'</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u'</span> <span class="skolem">x</span> 
  <span class="keyword1"><span class="command">using</span></span> reset_sets_all_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="skolem">u'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> regions_part_ex_reset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * ** True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">r'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒳"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">=</span> Regions.region 𝒳 <span class="skolem">I</span> <span class="skolem">ρ</span>"</span></span> <span class="quoted"><span class="quoted">"Regions.valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">ρ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ** <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span>
          <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> reset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span> <span class="main">=</span> Const <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ***<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> reset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">r'</span> <span class="main">→</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> id <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-admissible_targets_clocks"><span class="command">lemma</span></span> admissible_targets_clocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">g</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> admissible_targets<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> finite <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> 𝒳"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒳_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">⊆</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> someI_ex<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"rel_pmf <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">)</span> <span class="free">μ</span> <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> rel_pmf_reflI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PTA-K_pmf_rel"><span class="command">lemma</span></span> K_pmf_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">st</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">=</span> <span class="bound">st</span><span class="main">)</span> <span class="free">μ</span> <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> rel_pmf_reflI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PTA-𝒦_pmf_rel"><span class="command">lemma</span></span> 𝒦_pmf_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">st</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="bound">st</span><span class="main">)</span> <span class="free">μ</span> <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> rel_pmf_reflI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PTA-K_elem_abs_inj"><span class="command">lemma</span></span> K_elem_abs_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u1</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u2</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">u1</span> <span class="skolem">u2</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> A
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 _ _ <span class="skolem">τ</span> <span class="skolem">μ'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> elem <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X1</span><span class="main">)</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X2</span><span class="main">)</span><span class="main">→</span><span class="main">0</span><span class="main">]</span><span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> trans_of <span class="main">_</span>›</span></span> admissible_targets_clocks <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X1</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X2</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> id <span class="quoted"><span class="quoted">‹<span class="skolem">u1</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u2</span> <span class="main">=</span> <span class="main">_</span>›</span></span> reset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> S›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def V_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">-</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> elem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_elem_repr_inj"><span class="command">lemma</span></span> K_elem_repr_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> alpha_interp.valid_regions_distinct_spec<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="comment1">(* XXX Declare somewhere else *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">R1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">R1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">R2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">R1</span> <span class="skolem">R2</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r2</span> <span class="main">=</span> <span class="var">?r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">μ'</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">μ'</span><span class="main">)</span> <span class="main">∈</span> PTA.trans_of <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊢</span> <span class="skolem">g</span><span class="main">}</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="bound">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">μ'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> elem <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R1</span> <span class="main">=</span> region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X1</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R2</span> <span class="main">=</span> region_set' <span class="free">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X2</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> trans_of <span class="main">_</span>›</span></span> admissible_targets_clocks <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X1</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X2</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> alpha_interp.region_set'_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">R1</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R2</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> 𝒮›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R1</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R2</span> <span class="main">∈</span> ℛ"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">R1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∈</span> <span class="skolem">R1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∈</span> <span class="skolem">R2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R1</span> <span class="main">∈</span> ℛ›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R2</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R1</span> <span class="main">=</span> <span class="skolem">R2</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> A elem this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_elem_pmf_map_abs"><span class="command">lemma</span></span> K_elem_pmf_map_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf <span class="free">μ</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf_map_inj K_elem_abs_inj<span class="main">)</span>

<span class="keyword1" id="PTA-K_elem_pmf_map_repr"><span class="command">lemma</span></span> K_elem_pmf_map_repr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf <span class="free">f</span> <span class="free">μ</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf <span class="free">μ</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf_map_inj K_elem_repr_inj<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translating Configurations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹States›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">abss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abss</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">u</span> <span class="main">∈</span> V <span class="keyword1">then</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">-</span>V<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">reps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reps</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">R</span> <span class="main">∈</span> ℛ <span class="keyword1">then</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA-𝒮_reps_S"><span class="command">lemma</span></span> 𝒮_reps_S<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reps <span class="free">s</span> <span class="main">∈</span> S"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ℛ_V <span class="keyword1"><span class="command">unfolding</span></span> S_def 𝒮_def reps_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="PTA-S_abss_𝒮"><span class="command">lemma</span></span> S_abss_𝒮<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ccompatible_inv <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def S_alt_def abss_def ccompatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="PTA-𝒮_abss_reps"><span class="command">lemma</span></span> 𝒮_abss_reps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> abss <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ℛ_V alpha_interp.region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def 𝒮_def reps_def abss_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="PTA-map_pmf_abs_reps"><span class="command">lemma</span></span> map_pmf_abs_reps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_pmf abss <span class="main">(</span>map_pmf reps <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf abss <span class="main">(</span>map_pmf reps <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span>abss <span class="keyword1">o</span> reps<span class="main">)</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">μ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> map_pmf_idI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">l'</span> <span class="skolem">R'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-abss_reps_id"><span class="command">lemma</span></span> abss_reps_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-abss_S"><span class="command">lemma</span></span> abss_S<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> abss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-reps_𝒮"><span class="command">lemma</span></span> reps_𝒮<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> reps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-fst_abss"><span class="command">lemma</span></span> fst_abss<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">st</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">st</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abss_def<span class="main">)</span>

<span class="keyword1" id="PTA-K_elem_abss_inj"><span class="command">lemma</span></span> K_elem_abss_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on abss <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inj_on_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> K_elem_abs_inj<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-𝒦_elem_reps_inj"><span class="command">lemma</span></span> 𝒦_elem_reps_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on reps <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reps <span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inj_on_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> K_elem_repr_inj<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-P_elem_pmf_map_abss"><span class="command">lemma</span></span> P_elem_pmf_map_abss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf abss <span class="free">μ</span><span class="main">)</span> <span class="main">(</span>abss <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> pmf <span class="free">μ</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf_map_inj K_elem_abss_inj<span class="main">)</span>

<span class="keyword1" id="PTA-𝒦_elem_pmf_map_reps"><span class="command">lemma</span></span> 𝒦_elem_pmf_map_reps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf reps <span class="free">μ</span><span class="main">)</span> <span class="main">(</span>reps <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pmf <span class="free">μ</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf_map_inj 𝒦_elem_reps_inj<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒳›</span></span></span></span> is non-trivial here›</span></span>
<span class="keyword1" id="PTA-not_𝒮_reps"><span class="command">lemma</span></span> not_𝒮_reps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∉</span> 𝒮 <span class="main">⟹</span> reps <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∉</span> S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∉</span> 𝒮"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> L"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(* XXX Refactor -- doing that kind of proof at other places too *)</span>
    <span class="keyword1"><span class="command">from</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∉</span> 𝒮›</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">R</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free">l</span><span class="main">⦄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒮_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ccompatible_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ccompatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> non_empty <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∉</span> 𝒮›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def S_def reps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move up *)</span>
<span class="keyword1" id="PTA-neq_V_not_region"><span class="command">lemma</span></span> neq_V_not_region<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span>V <span class="main">∉</span> ℛ"</span></span>
<span class="keyword1"><span class="command">using</span></span> ℛ_V rep_ℛ_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-𝒮_abss_S"><span class="command">lemma</span></span> 𝒮_abss_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abss_def 𝒮_def S_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ u
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ u
    <span class="keyword1"><span class="command">using</span></span> neq_V_not_region <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l' y l u
    <span class="keyword1"><span class="command">using</span></span> neq_V_not_region <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> regions_part_ex<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA-S_pred_stream_abss_𝒮"><span class="command">lemma</span></span> S_pred_stream_abss_𝒮<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮<span class="main">)</span> <span class="main">(</span>smap abss <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> S_abss_𝒮 𝒮_abss_S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>


<span class="keyword1"><span class="command">sublocale</span></span> MDP<span class="main">:</span> Markov_Decision_Process_Invariant <span class="quoted">K</span> <span class="quoted">S</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">valid_cfg</span> <span class="main">≡</span> MDP.valid_cfg"</span></span>

<span class="keyword1" id="PTA-K_closed"><span class="command">lemma</span></span> K_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">D</span><span class="main">∈</span>K <span class="free">s</span><span class="main">.</span> set_pmf <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> S"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intermezzo›</span></span>

<span class="comment1">(* XXX Correct binding strength *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">timed_bisim</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">~</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">~</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> abss <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> abss <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1" id="PTA-bisim_loc_id"><span class="command">lemma</span></span> bisim_loc_id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> abss_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> V"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="PTA-bisim_val_id"><span class="command">lemma</span></span> bisim_val_id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="main">[</span><span class="free">u'</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="main">-</span> V<span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> V"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abss_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-bisim_symmetric"><span class="command">lemma</span></span> bisim_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_commute<span class="main">)</span>

<span class="keyword1" id="PTA-bisim_val_id2"><span class="command">lemma</span></span> bisim_val_id2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> V <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="main">[</span><span class="free">u'</span><span class="main">]⇩</span>ℛ"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bisim_val_id<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-K_bisim_unique"><span class="command">lemma</span></span> K_bisim_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">~</span> <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">,</span>3-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> K.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>action <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">τ</span> <span class="skolem">μ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="skolem">μ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X2</span><span class="main">,</span> <span class="skolem">l2</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="skolem">μ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X1</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X2</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">~</span> <span class="free">x'</span>›</span></span> A <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="skolem">X1</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="main">[</span><span class="main">[</span><span class="skolem">X2</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bisim_val_id<span class="main">[</span><span class="operator">OF</span> S_V<span class="main">]</span> K_S_closed assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bisim_val_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S_V<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">X1</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">X2</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A admissible_targets_clocks<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> reset_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">~</span> <span class="free">x'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> delay
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> loop
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Predicates›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">absp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">absp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">o</span> reps"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">repp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">o</span> absp"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Distributions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">abst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> pmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> pmf"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abst</span> <span class="main">=</span> map_pmf abss"</span></span>

<span class="keyword1" id="PTA-abss_𝒮D"><span class="command">lemma</span></span> abss_𝒮D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 𝒮_abss_S<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-abss_𝒮D'"><span class="command">lemma</span></span> abss_𝒮D'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> abss_𝒮D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abss_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
definition
  rept :: "'s * ('c, t) cval ⇒ ('s * ('c, t) cval set) pmf ⇒ ('s * ('c, t) cval) pmf"
where
  "rept s μ_abs ≡ let (l, u) = s in
    if μ_abs = return_pmf (abss s)
    then if (∃ c ∈ 𝒳. ∃ d. u c = real d)
         then return_pmf s
         else return_pmf (l, u ⊕ 0.5)
    else SOME μ. μ ∈ K s ∧ abst μ = μ_abs"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">infR</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> of_int <span class="main">⌊</span><span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="bound">c</span><span class="main">⌋</span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">in</span> <span class="free">b</span>"</span></span>

<span class="comment1">(* definition "shiftedR R ≡ let u = (SOME u. u ∈ R) in (u ⊕ max 0 (0.1 - Max {frac (u c) | c. c ∈ 𝒳}))" *)</span>
<span class="comment1">(*
definition "delayedR R u ≡
  u ⊕ (
    let (I, r) = (SOME x. ∃ I r. x = (I, r) ∧ valid_region 𝒳 k I r ∧ R = region 𝒳 I r);
        m = Min {of_nat (intv_const (I c)) + 1 - u c | c. c ∈ 𝒳 ∧ isConst (I c)}
    in if m ≥ 1 then SOME t. u ⊕ t ∈ R else m / 2
  )"
*)</span>

<span class="comment1">(*
definition "delayedR R u ≡
  u ⊕ (
    let (I, r) = (SOME x. ∃ I r. x = (I, r) ∧ valid_region 𝒳 k I r ∧ R = region 𝒳 I r);
        m = 1 - Max ({frac (u c) | c. c ∈ 𝒳 ∧ isIntv (I c) ∧ intv_const (I c) = 0} ∪ {0})
    in if m ≥ 1 then SOME t. u ⊕ t ∈ R else m / 2
  )"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delayedR</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">I</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> valid_region 𝒳 <span class="free">k</span> <span class="bound">I</span> <span class="bound">r</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> region 𝒳 <span class="bound">I</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> Max <span class="main">(</span><span class="main">{</span>frac <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> isIntv <span class="main">(</span><span class="bound">I</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≥</span> <span class="bound">m</span> <span class="main">/</span> <span class="numeral">2</span>
  <span class="main">)</span>"</span></span>


<span class="comment1">(* XXX Move, generated by sledgehammer *)</span>
<span class="keyword1" id="PTA-delayedR_correct_aux_aux"><span class="command">lemma</span></span> delayedR_correct_aux_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> Suc <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> Suc <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> frac <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span>
<span class="comment1">(* Working alternative:
by (smt One_nat_def add.right_neutral add_Suc_right assms nat_intv_frac_decomp)
*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="bound">r</span> <span class="main">+</span> <span class="bound">ra</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ra</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">+</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ra</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">r</span> <span class="main">+</span> <span class="main">-</span> frac <span class="bound">r</span> <span class="main">=</span> real <span class="bound">n</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">r</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> real <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_intv_frac_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">a</span> <span class="main">+</span> real <span class="free">c</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f4 f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def add.right_neutral add_Suc_right assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f5 f1 assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-delayedR_correct_aux"><span class="command">lemma</span></span> delayedR_correct_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="free">r</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> region 𝒳 <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">¬</span> isConst <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> isIntv <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="bound">c</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Const
    <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Intv <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Greater <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>𝒳<span class="main">.</span> intv_elem <span class="bound">x</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">=</span> Intv <span class="bound">d</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> delayedR_correct_aux_aux<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> frac <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-delayedR_correct_aux'"><span class="command">lemma</span></span> delayedR_correct_aux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="free">r</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> region 𝒳 <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">¬</span> isConst <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> isIntv <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t2</span><span class="main">)</span> <span class="bound">c</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t2</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="free">t1</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">t2</span> <span class="main">-</span> <span class="free">t1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> delayedR_correct_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t2</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* XXX Move to valid_regions_distinct *)</span>
<span class="keyword1" id="PTA-valid_regions_intv_distinct"><span class="command">lemma</span></span> valid_regions_intv_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span> <span class="main">⟹</span> valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I'</span> <span class="free">r'</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I'</span> <span class="free">r'</span>
  <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">x</span> <span class="main">=</span> <span class="free">I'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> 1
  <span class="keyword1"><span class="command">note</span></span> x <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">I'</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>3<span class="main">)</span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">x</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>4<span class="main">)</span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">x</span> <span class="free">u</span> <span class="main">(</span><span class="free">I'</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">x</span> <span class="main">=</span> <span class="free">I'</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_intv_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-delayedR_correct"><span class="command">lemma</span></span> delayedR_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="free">r</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≡</span> region 𝒳 <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">¬</span> isConst <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">∈</span> Succ ℛ <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"delayedR <span class="free">R'</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">.</span> delayedR <span class="free">R'</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⊕</span> <span class="bound">t</span>
            <span class="main">∧</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> Max <span class="main">(</span><span class="main">{</span>frac <span class="main">(</span><span class="free">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> isIntv <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> valid_region 𝒳 <span class="free">k</span> <span class="bound">I</span> <span class="bound">r</span> <span class="main">∧</span> <span class="free">R'</span> <span class="main">=</span> region 𝒳 <span class="bound">I</span> <span class="bound">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>frac <span class="main">(</span><span class="free">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> isIntv <span class="main">(</span><span class="free">I</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> <span class="free">u</span> <span class="main">⊕</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> frac_lt_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span> 6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alpha_interp.regions_closed'_spec alpha_interp.set_of_regions_spec<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="skolem">I'</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">I</span> <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> region 𝒳 <span class="skolem">I'</span> <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">I'</span> <span class="skolem">r'</span>
  <span class="keyword1"><span class="command">using</span></span> valid_regions_intv_distinct assms<span class="main">(</span>4<span class="main">)</span> t<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> R'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> I_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">I</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> valid_region 𝒳 <span class="free">k</span> <span class="var">?I</span> <span class="bound">r</span> <span class="main">∧</span> <span class="free">R'</span> <span class="main">=</span> region 𝒳 <span class="var">?I</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> valid_region 𝒳 <span class="free">k</span> <span class="bound">I</span> <span class="bound">r</span> <span class="main">∧</span> <span class="free">R'</span> <span class="main">=</span> region 𝒳 <span class="bound">I</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> I_cong that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">{</span>frac <span class="main">(</span><span class="free">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> isIntv <span class="main">(</span><span class="var">?I</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"isIntv <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">c</span> <span class="main">&gt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> t that assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">c</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> True <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">c</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="free">u</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">-</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * nat_intv_frac_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">⊕</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">c</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> frac <span class="main">(</span><span class="free">u</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nat_intv_frac_decomp of_nat_1 of_nat_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">c</span> <span class="main">≤</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="var">?m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?m</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">c</span> <span class="main">+</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> intv_const <span class="main">(</span><span class="free">I</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">⊕</span> <span class="var">?t</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∧</span> <span class="var">?t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span> t <span class="quoted"><span class="quoted">‹Max <span class="main">(</span><span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="var">?t</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∧</span> <span class="var">?t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?m</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R'_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> delayedR_correct_aux'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> t<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> R'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> upper_bound False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?m</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"delayedR <span class="free">R'</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> delayedR <span class="free">R'</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⊕</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≥</span> <span class="var">?m</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> delayedR_def <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> pmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> pmf"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">μ_abs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">R'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">μ_abs</span></span></span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="bound">R'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">R'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">μ_abs</span></span></span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> Succ ℛ <span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ <span class="main">≠</span> <span class="bound">R'</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">R'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">∄</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span>  <span class="bound">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> delayedR <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">R'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">μ_abs</span></span></span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">SOME</span> <span class="bound">μ</span><span class="main">.</span> <span class="bound">μ</span> <span class="main">∈</span> K <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> abst <span class="bound">μ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">μ_abs</span></span></span>"</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-𝒮_L"><span class="command">lemma</span></span> 𝒮_L<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> L"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-𝒮_inv"><span class="command">lemma</span></span> 𝒮_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> <span class="free">R</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="free">l</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-upper_right_closed"><span class="command">lemma</span></span> upper_right_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="bound">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="skolem">I</span> <span class="bound">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="improper">c</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> R <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> V›</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊕</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-S_I"><span class="command">lemma</span></span> S_I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> L"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def V_def<span class="main">)</span>

<span class="keyword1" id="PTA-rept_ex"><span class="command">lemma</span></span> rept_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="main">(</span>rept <span class="free">s</span> <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>delay <span class="skolem">l</span> <span class="skolem">R</span> <span class="skolem">R'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> abss_𝒮D<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]⇩</span>ℛ"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abss_S<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 𝒮_abss_S<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>4<span class="main">)</span> alpha_interp.set_of_regions_spec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">∈</span> ℛ›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> L"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ›</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abst <span class="var">?μ</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ** abst_def prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> default <span class="main">=</span> calculation
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">∈</span> ℛ›</span></span> alpha_interp.region_unique_spec<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">using</span></span> * prems ℛ_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> elapsed<span class="main">:</span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> ℛ›</span></span> ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> ℛ›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alpha_interp.region_unique_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> V›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> L›</span></span> prems<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="var">?u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abss_S<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abst <span class="var">?μ'</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> prems <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?μ'</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abst <span class="var">?μ'</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?μ'</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> T<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="skolem">u'</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> T * R prems<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?μ</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> upper_right_closed<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> * <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> ℛ›</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">⊕</span> <span class="numeral">0.5</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> elapsed <span class="quoted"><span class="quoted">‹rept <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> T * R prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> default <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> F<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">R'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">∄</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> F * R prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> default <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True F * R prems<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> delayedR <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">R'</span><span class="main">.</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> delayedR <span class="var">?R</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delayedR <span class="var">?R</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="var">?R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R' True <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">¬</span> Regions.isConst <span class="main">(</span><span class="skolem">I</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> delayedR_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">R</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span><span class="main">]</span> * <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">∈</span> ℛ›</span></span> R' True <span class="quoted"><span class="quoted">‹<span class="skolem">R'</span> <span class="main">∈</span> Succ ℛ <span class="skolem">R</span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"delayedR <span class="skolem">R'</span> <span class="skolem">u'</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"delayedR <span class="skolem">R'</span> <span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">⊕</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="main">=</span><span class="main">_</span> ›</span></span><span class="quoted"><span class="quoted">‹rept <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> delayedR <span class="skolem">R'</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> elapsed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>action <span class="skolem">l</span> <span class="skolem">R</span> <span class="skolem">τ</span> <span class="skolem">μ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> abss_𝒮D'<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> 𝒮›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">[</span><span class="bound">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="skolem">μ'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> u prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abst <span class="var">?μ</span> <span class="main">=</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prems<span class="main">(</span>1<span class="main">)</span> abst_def
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> map_pmf_comp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pmf.map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">X</span> <span class="skolem">l'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">using</span></span> ℛ_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1<span class="main">)</span> A
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> A prems R_G.K_closed <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> L"</span></span> <span class="quoted"><span class="quoted">"region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span> <span class="main">⊆</span> <span class="main">⦃</span>inv_of <span class="free">A</span> <span class="skolem">l'</span><span class="main">⦄</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> 𝒮_L 𝒮_inv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> region_set'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> L›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span> <span class="main">∈</span> V›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> region_set'_eq<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> transition_def<span class="main">]</span> prems A u <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> default<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">R</span><span class="main">.</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">R</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> default <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> R' prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="bound">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_pmf_eq_return_pmf_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">μ'</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"region_set' <span class="skolem">R</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_pmf_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_targets_clocks<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> finite_list finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> alpha_interp.region_reset_not_Succ False <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">R'</span>›</span></span> u<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∉</span> Succ ℛ <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> R' u<span class="main">(</span>4<span class="main">)</span> False <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> default <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> T<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">u</span> <span class="bound">c</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> T <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> R' u<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> default <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> T <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> R' u<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S›</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> upper_right_closed<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> T u ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="skolem">R'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> T alpha_interp.region_unique_spec u<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> <span class="quoted"><span class="quoted">‹rept <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> R' <span class="quoted"><span class="quoted">‹abss <span class="free">s</span> <span class="main">∈</span> 𝒮›</span></span> <span class="quoted"><span class="quoted">‹abss <span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> prems<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>rept <span class="free">s</span> <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> abss_S<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝒮_L S_def V_def T <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> 𝒮_inv<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> <span class="skolem">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> K.delay<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> 𝒮_inv<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> loop
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> T<span class="main">:</span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> L"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> S_abss_𝒮 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 𝒮_inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">⊆</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">⊢</span> inv_of <span class="free">A</span> <span class="skolem">l</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">u</span> <span class="bound">c</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> S›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> upper_right_closed<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> * ℛ_V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> calculation * alpha_interp.region_unique_spec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="quoted"><span class="quoted">‹rept <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> T <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> 𝒮›</span></span> 𝒮_inv
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rept_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> abst_def abss_S<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"return_pmf <span class="free">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="free">μ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">μ'</span><span class="main">.</span> <span class="bound">μ'</span> <span class="main">∈</span> K <span class="free">s</span> <span class="main">∧</span> abst <span class="bound">μ'</span> <span class="main">=</span> <span class="free">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">μ</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"return_pmf <span class="free">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rept_K<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>       <span class="main">=</span> rept_ex<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> abst_rept_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>  <span class="main">=</span> rept_ex<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>

<span class="keyword1" id="PTA-abst_rept2"><span class="command">lemma</span></span> abst_rept2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>rept <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span> <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="free">μ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-rept_K2"><span class="command">lemma</span></span> rept_K2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> 𝒦 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span> <span class="free">μ</span> <span class="main">∈</span> K <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* XXX Move this. Does this exist anywhere? More elegant pattern? *)</span>
<span class="keyword1" id="PTA-theI'"><span class="command">lemma</span></span> theI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> theI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="PTA-cont_cfg_defined"><span class="command">lemma</span></span> cont_cfg_defined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cfg</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> abst <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> abss <span class="bound">x</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abss <span class="free">x</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> action <span class="free">cfg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> abss <span class="bound">y</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> action <span class="free">cfg</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> abss <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> theI'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> K_bisim_unique MDP.valid_cfg_state_in_S <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">absc'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> cfg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> cfg"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">absc'</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> cfg_corec
    <span class="main">(</span>abss <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>abst <span class="keyword1">o</span> action<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg</span> <span class="bound">s</span><span class="main">.</span> cont <span class="bound">cfg</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> abss <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> action <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Configuration›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">absc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> cfg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> cfg"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">absc</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> cfg_corec
    <span class="main">(</span>abss <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>abst <span class="keyword1">o</span> action<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg</span> <span class="bound">s</span><span class="main">.</span> cont <span class="bound">cfg</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> abss <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> action <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">repcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval set<span class="main">)</span> cfg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> cfg"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repcs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> cfg_corec
    <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">.</span> rept <span class="bound">s</span> <span class="main">(</span>action <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> cont <span class="bound">cfg</span> <span class="main">(</span>abss <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repc</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> repcs <span class="main">(</span>reps <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span>"</span></span>

<span class="keyword1" id="PTA-𝒮_state_absc_repc"><span class="command">lemma</span></span> 𝒮_state_absc_repc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">∈</span> 𝒮 <span class="main">⟹</span> state <span class="main">(</span>absc <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absc_def repc_def repcs_def<span class="main">)</span>

<span class="keyword1" id="PTA-action_repc"><span class="command">lemma</span></span> action_repc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"action <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> rept <span class="main">(</span>reps <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> repc_def repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* XXX Declare simp? *)</span>
<span class="keyword1" id="PTA-action_absc"><span class="command">lemma</span></span> action_absc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"action <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> abst <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> absc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PTA-action_absc'"><span class="command">lemma</span></span> action_absc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"action <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> map_pmf abss <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> absc_def <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="free">s'</span> <span class="main">=</span> repcs <span class="free">s'</span> <span class="main">(</span>cont <span class="free">cfg</span> <span class="main">(</span>abss <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repc_def repcs_def abss_reps_id<span class="main">)</span>

<span class="keyword1" id="PTA-cont_repcs1"><span class="command">lemma</span></span> cont_repcs1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span> <span class="free">s'</span> <span class="main">=</span> repcs <span class="free">s'</span> <span class="main">(</span>cont <span class="free">cfg</span> <span class="main">(</span>abss <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repc_def repcs_def abss_reps_id<span class="main">)</span>

<span class="keyword1" id="PTA-cont_absc_1"><span class="command">lemma</span></span> cont_absc_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> MDP.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">(</span>abss <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> absc <span class="main">(</span>cont <span class="free">cfg</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">~</span> <span class="free">s'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>abst <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">~</span> <span class="free">s'</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">~</span> <span class="free">s'</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> absc_def abst_def repc_def x_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-state_repc"><span class="command">lemma</span></span> state_repc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> reps <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> repc_def repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PTA-abss_reps_id'"><span class="command">lemma</span></span> abss_reps_id'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>reps <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abss_reps_id R_G.valid_cfg_state_in_S R_G.valid_cfgD<span class="main">)</span>

<span class="comment1">(* XXX Move to different locale *)</span>
<span class="keyword1" id="PTA-valid_cfg_coinduct"><span class="command">lemma</span></span> valid_cfg_coinduct<span class="main">[</span><span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> valid_cfg<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> state <span class="bound">cfg</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> action <span class="bound">cfg</span> <span class="main">∈</span> K <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> action <span class="bound">cfg</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>cont <span class="bound">cfg</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MDP.valid_cfgI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-state_repcD"><span class="command">lemma</span></span> state_repcD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> reps <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> repc_def repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-ccompatible_subs"><span class="command">lemma</span></span> ccompatible_subs<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ccompatible ℛ <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⊢</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="free">g</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ccompatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-action_abscD"><span class="command">lemma</span></span> action_abscD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">s</span> <span class="main">⟹</span> action <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> absc_def abst_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> cfg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_pmf abss <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>delay <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> prems ccompatible_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊢</span> PTA.inv_of <span class="free">A</span> <span class="skolem">l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ccompatible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abss_S<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>action <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">g</span> <span class="skolem">μ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> prems ccompatible_guard <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">⊆</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="skolem">g</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ccompatible_subs<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"map_pmf abss <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>
      <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> region_set' <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="bound">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">μ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> region_set' <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">μ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="skolem">l'</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">l</span> ⟶<span class="hidden">⇗</span><sup><span class="skolem">g</span><span class="main">,</span><span class="skolem">μ</span><span class="main">,</span><span class="skolem">X</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> that prems MDP.action_closed<span class="main">[</span><span class="operator">OF</span> _ cfg<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="skolem">X</span><span class="main">:=</span><span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> region_set' <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> region_set'_eq<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊢</span> <span class="skolem">l</span> ⟶<span class="hidden">⇗</span><sup><span class="skolem">g</span><span class="main">,</span><span class="skolem">μ</span><span class="main">,</span><span class="skolem">X</span></sup><span class="hidden">⇖</span> <span class="skolem">l'</span>›</span></span><span class="main">]</span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> prems<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmf.map_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_pmf_comp<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> loop
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-repcs_valid"><span class="command">lemma</span></span> repcs_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">s</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repcs_def 𝒮_abss_S <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cfg'</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> rept_K<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">s'</span> <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">cfg</span> <span class="main">(</span>abss <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">s'</span> <span class="main">∈</span> abst <span class="main">(</span>rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> repcs_def abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"abss <span class="skolem">s'</span> <span class="main">∈</span> action <span class="skolem">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abst_rept_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?cfg</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cont_repcs1<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD R_G.valid_cfg_cont<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-repc_valid"><span class="command">lemma</span></span> repc_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"repc <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> repc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>

<span class="keyword1" id="PTA-action_abst_repcs"><span class="command">lemma</span></span> action_abst_repcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>action <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> repc_def repcs_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> abst_rept_id<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.cfg_onD_action R_G.valid_cfgD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-action_abst_repc"><span class="command">lemma</span></span> action_abst_repc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>action <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>reps <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> action_abst_repcs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> repc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-state_absc"><span class="command">lemma</span></span> state_absc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> abss <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> absc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-state_repcs"><span class="command">lemma</span></span> state_repcs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA-repcs_bisim"><span class="command">lemma</span></span> repcs_bisim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">~</span> <span class="free">x'</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">x</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="main">(</span>repcs <span class="free">x</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="free">x'</span> <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">x'</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">x'</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> state
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_absc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> action
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> absc_def repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>cont <span class="skolem">s</span> <span class="skolem">cfg</span> <span class="skolem">x</span> <span class="skolem">x'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">=</span> cont <span class="skolem">cfg</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span>    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> abss <span class="bound">y</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> action <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span>   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≡</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> abss <span class="bound">y</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> action <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="skolem">x</span> <span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> repcs_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> abst <span class="main">(</span>action <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> action_absc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> action <span class="skolem">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_action<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">OF</span> valid *<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span>
      <span class="quoted"><span class="quoted">"abss <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> action <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>abss <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> absc <span class="main">(</span>cont <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_absc_1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="skolem">t</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prems t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cont_repcs1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cont_x<span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="skolem">t</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="skolem">x'</span> <span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> action <span class="skolem">cfg</span>›</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> abst <span class="main">(</span>action <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">OF</span> valid this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"abss <span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> action <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>abss <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> absc <span class="main">(</span>cont <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t' valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_absc_1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="skolem">t'</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prems t' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cont_repcs1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="main">(</span>repcs <span class="skolem">x'</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="skolem">t'</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> cont_x <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> action <span class="skolem">cfg</span>›</span></span> prems<span class="main">(</span>1<span class="main">)</span> t t' <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> 𝒮›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"cont <span class="skolem"><span class="skolem"><span class="skolem">cfg</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span></span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S R_G.valid_cfg_action R_G.valid_cfg_cont<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> R_G_I

<span class="keyword1"><span class="command">lemmas</span></span> R_G.valid_cfg_state_in_S<span class="main">[</span><span class="operator">R_G_I</span><span class="main">]</span> R_G.valid_cfgD<span class="main">[</span><span class="operator">R_G_I</span><span class="main">]</span> R_G.valid_cfg_action

<span class="comment1">(* XXX Simplifier looping problems on cfg_on
   If R_G.cfg_onD_state is not removed from simpset, the simplifier rewrites state cfg = state cfg.
*)</span>
<span class="keyword1" id="PTA-absc_repcs_id"><span class="command">lemma</span></span> absc_repcs_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> <span class="free">cfg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> state
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absc_def repc_def repcs_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> action_abst_repcs action_absc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>cont <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">≡</span> repcs <span class="skolem">s</span> <span class="skolem">cfg</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span>    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span>    <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> abss <span class="bound">x</span> <span class="main">=</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="skolem">cfg'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="skolem">cfg</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="main">(</span>reps <span class="main">(</span>state <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>reps <span class="main">(</span>state <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_action<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> repcs_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> abst <span class="main">(</span>action <span class="skolem">cfg'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> action_abst_repcs<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">OF</span> valid this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span>
    <span class="quoted"><span class="quoted">"abss <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> action <span class="skolem">cfg'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> t_def cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">~</span> reps <span class="main">(</span>abss <span class="skolem">t</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 𝒮_abss_reps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_action<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="skolem">cfg'</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">=</span> cont <span class="main">(</span>absc <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">(</span>abss <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span>absc <span class="skolem">cfg'</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">=</span> absc <span class="main">(</span>cont <span class="skolem">cfg'</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_absc_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> absc <span class="main">(</span>repcs <span class="skolem">t</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems t * <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">~</span> <span class="main">_</span>›</span></span> valid
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> repcs_bisim <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cont_repcs1 cfg'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"cont <span class="skolem">cfg</span> <span class="skolem">s'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">using</span></span> prems t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_cont<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Simplifier looping problems on cfg_on
   If R_G.cfg_onD_state is not removed from simpset, the simplifier rewrites state cfg = state cfg.
*)</span>
<span class="keyword1" id="PTA-absc_repc_id"><span class="command">lemma</span></span> absc_repc_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> R_G.cfg_onD_state<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> <span class="free">cfg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> repc_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> absc_repcs_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>

<span class="keyword1" id="PTA-K_cfg_map_absc"><span class="command">lemma</span></span> K_cfg_map_absc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg <span class="main">⟹</span> K_cfg <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> map_pmf absc <span class="main">(</span>K_cfg <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> K_cfg_def map_pmf_comp action_absc abst_def cont_absc_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_pmf_cong<span class="main">)</span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-smap_comp"><span class="command">lemma</span></span> smap_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>smap <span class="free">f</span> <span class="keyword1">o</span> smap <span class="free">g</span><span class="main">)</span> <span class="main">=</span> smap <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp<span class="main">)</span>

<span class="keyword1" id="PTA-state_abscD"><span class="command">lemma</span></span> state_abscD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> abss <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> absc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* XXX Move to different locale *)</span>
<span class="keyword1" id="PTA-R_G_valid_cfg_coinduct"><span class="command">lemma</span></span> R_G_valid_cfg_coinduct<span class="main">[</span><span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> valid_cfg<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> state <span class="bound">cfg</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> action <span class="bound">cfg</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cfg</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> action <span class="bound">cfg</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>cont <span class="bound">cfg</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R_G.valid_cfgI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-absc_valid"><span class="command">lemma</span></span> absc_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> absc_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfg_state_in_S<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cfg'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> state_abscD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgD action_abscD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">s'</span> <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> abss <span class="bound">x</span> <span class="main">=</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">cfg</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> abss <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> action <span class="skolem">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> action_absc'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"abss <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> abss <span class="bound">y</span> <span class="main">=</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> t_def abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?cfg</span></span></span></span></span></span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfg_cont <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abst_def action_absc absc_def t_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_cfg_set_absc"><span class="command">lemma</span></span> K_cfg_set_absc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> K_cfg_map_absc<span class="main">)</span>

<span class="keyword1" id="PTA-abst_action_repcs"><span class="command">lemma</span></span> abst_action_repcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>action <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> repc_def repcs_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> abst_rept_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>

<span class="keyword1" id="PTA-abst_action_repc"><span class="command">lemma</span></span> abst_action_repc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abst <span class="main">(</span>action <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> repc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abst_action_repcs <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>

<span class="keyword1" id="PTA-K_elem_abss_inj'"><span class="command">lemma</span></span> K_elem_abss_inj'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on abss <span class="main">(</span>set_pmf <span class="free">μ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms K_elem_abss_inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_bisim_unique inj_onI<span class="main">)</span>

<span class="keyword1" id="PTA-K_cfg_rept_aux"><span class="command">lemma</span></span> K_cfg_rept_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">cfg'</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">~</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">cfg'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> K <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span> 𝒮_abss_S<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> K_bisim_unique<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_cfg_rept_action"><span class="command">lemma</span></span> K_cfg_rept_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>K_cfg <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="free">cfg'</span><span class="main">)</span> <span class="main">=</span> state <span class="free">cfg'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> abst_rept_id assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">=</span> abst <span class="var">?μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> abst <span class="var">?μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="var">?μ</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">s'</span> <span class="main">=</span> state <span class="free">cfg'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abst_def pmf.set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> K_cfg_rept_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_cfg_map_repcs"><span class="command">lemma</span></span> K_cfg_map_repcs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">repc'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">cfg'</span><span class="main">.</span> repcs <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="bound">cfg'</span><span class="main">)</span> <span class="bound">cfg'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"K_cfg <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="free">repc'</span> <span class="main">(</span>K_cfg <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rept <span class="free">s</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">cfg'</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="var">?μ</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="bound">cfg'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span>cont <span class="free">cfg</span> <span class="main">(</span>abss <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="var">?μ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">using</span></span> K_cfg_rept_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> that<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> K_cfg_def <span class="keyword1"><span class="command">using</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abst_action_repcs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> repc_def repcs_def t_def map_pmf_comp abst_def assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_pmf_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_cfg_map_repc"><span class="command">lemma</span></span> K_cfg_map_repc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">repc'</span> <span class="free">cfg'</span> <span class="main">≡</span> repcs <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> rept <span class="main">(</span>reps <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="free">cfg'</span><span class="main">)</span> <span class="free">cfg'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"K_cfg <span class="main">(</span>repc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="free">repc'</span> <span class="main">(</span>K_cfg <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> repc'_def repc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span> K_cfg_map_repcs<span class="main">)</span>

<span class="keyword1" id="PTA-R_G_K_cfg_valid_cfgD"><span class="command">lemma</span></span> R_G_K_cfg_valid_cfgD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S R_G.valid_cfgD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-K_cfg_valid_cfgD"><span class="command">lemma</span></span> K_cfg_valid_cfgD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-absc_bisim_abss"><span class="command">lemma</span></span> absc_bisim_abss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">x</span> <span class="main">=</span> absc <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="free">x</span> <span class="main">~</span> state <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span>absc <span class="free">x</span><span class="main">)</span> <span class="main">=</span> state <span class="main">(</span>absc <span class="free">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_absc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-K_cfg_bisim_unique"><span class="command">lemma</span></span> K_cfg_bisim_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"state <span class="free">x</span> <span class="main">~</span> state <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">~</span> state <span class="free">x</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> K_cfg_valid_cfgD assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span>  <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">x</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"state <span class="free">x</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">x'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">x'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>state <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="main">(</span>abst <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cont_cfg_defined<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>state <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">~</span> state <span class="free">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set_pmf <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="free">x'</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">x</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-absc_distr_self"><span class="command">lemma</span></span> absc_distr_self<span class="main">:</span>
  <span class="quoted"><span class="quoted">"MDP.MC.T <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> distr <span class="main">(</span>MDP.MC.T <span class="free">cfg</span><span class="main">)</span> MDP.MC.S <span class="main">(</span>smap absc<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> MDP.MC.T_coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prob
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MDP.MC.T.prob_space_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> sets
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>cont <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span>  <span class="main">≡</span> <span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> absc <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> K_cfg <span class="skolem">cfg</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">cfg</span><span class="main">.</span> distr <span class="main">(</span>MDP.MC.T <span class="main">(</span><span class="skolem">t</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> MDP.MC.S <span class="main">(</span>smap absc<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">M'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> A prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> absc <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> K_cfg <span class="skolem">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> K_cfg_map_absc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> K_cfg_bisim_unique<span class="main">[</span><span class="operator">OF</span> prems _ _ absc_bisim_abss<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> absc <span class="main">(</span><span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> theI2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 5
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> MDP.MC.T_eq_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_bind<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K_cfg_map_absc<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_pmf_rep_eq<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_distr<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_measure_pmf_cong<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> A <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span>absc <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> K_cfg_bisim_unique<span class="main">[</span><span class="operator">OF</span> prems _ A absc_bisim_abss<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span>
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  space_subprob_algebra MC_syntax.in_S
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_measure_pmf_cong MDP.MC.T.subprob_space_distr MDP.MC.T.prob_space_distr
          <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.MC.T.prob_space_distr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-R_G_trace_space_distr_eq"><span class="command">lemma</span></span> R_G_trace_space_distr_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MDP.MC.T <span class="free">cfg</span> <span class="main">=</span> distr <span class="main">(</span>MDP.MC.T <span class="main">(</span>repcs <span class="free">s</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> MDP.MC.S <span class="main">(</span>smap absc<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> MDP.MC.T_coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prob
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MDP.MC.T.prob_space_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> sets
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>cont <span class="skolem">cfg</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">repc'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">repc'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">cfg'</span><span class="main">.</span> repcs <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="var">?μ</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="bound">cfg'</span><span class="main">)</span> <span class="bound">cfg'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">cfg</span><span class="main">.</span> distr <span class="main">(</span>MDP.MC.T <span class="main">(</span><span class="skolem">repc'</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> MDP.MC.S <span class="main">(</span>smap absc<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">M'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">cfg'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> K_cfg_rept_action<span class="main">[</span><span class="operator">OF</span> prems<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="var">?μ</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">=</span> state <span class="skolem">cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M'_def repc'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MDP.MC.T.prob_space_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 5
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"smap absc <span class="main">∘</span> <span class="main">(##)</span> <span class="main">(</span><span class="skolem">repc'</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(##)</span> <span class="skolem">cfg'</span> <span class="main">∘</span> smap absc"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>K_cfg <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cfg'</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> K_cfg_rept_action<span class="main">[</span><span class="operator">OF</span> prems that<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="var">?μ</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">=</span> state <span class="skolem">cfg'</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> prems that <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">"absc <span class="main">(</span><span class="skolem">repc'</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">cfg'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> repc'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> absc_repcs_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap absc <span class="main">∘</span> <span class="main">(##)</span> <span class="main">(</span><span class="skolem">repc'</span> <span class="skolem">cfg'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(##)</span> <span class="skolem">cfg'</span> <span class="main">∘</span> smap absc<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> MDP.MC.T_eq_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_bind<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MDP.MC.distr_Stream_subprob<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K_cfg_map_repcs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_pmf_rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_distr<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> repc'_def<span class="main"><span class="main">]</span></span> repc'_def space_subprob_algebra MC_syntax.in_S
                  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_measure_pmf_cong MDP.MC.T.subprob_space_distr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-repc_inj_on_K_cfg"><span class="command">lemma</span></span> repc_inj_on_K_cfg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on repc <span class="main">(</span>set_pmf <span class="main">(</span>K_cfg <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_on_inverseI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">absc</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> absc_repc_id<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD R_G.valid_cfgI R_G.valid_cfg_state_in_S<span class="main">)</span>

<span class="keyword1" id="PTA-smap_absc_iff"><span class="command">lemma</span></span> smap_absc_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> smap abss <span class="bound">x</span> <span class="main">=</span> smap abss <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap state <span class="free">xs</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> abss <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">∈</span> smap abss <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"smap state <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">xs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> abss <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> smap abss <span class="main">(</span>smap state <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def stream.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap abss <span class="main">(</span>smap state <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> smap abss <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-valid_abss_reps"><span class="command">lemma</span></span> valid_abss_reps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span>reps <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> 𝒮_abss_reps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>

<span class="keyword1" id="PTA-in_space_UNIV"><span class="command">lemma</span></span> in_space_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="PTA-S_reps_𝒮_aux"><span class="command">lemma</span></span> S_reps_𝒮_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reps <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ccompatible_inv <span class="keyword1"><span class="command">unfolding</span></span> reps_def ccompatible_def 𝒮_def S_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> non_empty<span class="main">)</span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA-S_reps_𝒮"><span class="command">lemma</span></span> S_reps_𝒮<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reps <span class="free">s</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_reps_𝒮_aux <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>

<span class="keyword1" id="PTA-absc_valid_cfg_eq"><span class="command">lemma</span></span> absc_valid_cfg_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"absc <span class="main">`</span> valid_cfg <span class="main">=</span> R_G.valid_cfg"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cfg
    <span class="keyword1"><span class="command">using</span></span> absc_repcs_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span>state <span class="skolem">cfg</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">frule</span> repcs_valid<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span>state <span class="skolem">cfg</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA-action_repcs"><span class="command">lemma</span></span> action_repcs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"action <span class="main">(</span>repcs <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> rept <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equalities Between Measures of Trace Spaces›</span></span>

<span class="comment1">(* TODO: Clean *)</span>
<span class="keyword1" id="PTA-path_measure_eq_absc1_new"><span class="command">lemma</span></span> path_measure_eq_absc1_new<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cfg</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">≡</span> absc <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> R_G.St"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> MDP.St"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">(</span>R_G.T <span class="free">cfg'</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">(</span>MDP.T <span class="free">cfg</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred R_G.St <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Q'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred MDP.St <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X_Y_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> smap abss <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_X_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟹</span> smap abss <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="free">cfg'</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="free">cfg</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(=)</span> <span class="main">(</span>absc <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> stream_all2 <span class="main">(=)</span> <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> stream_all2 <span class="main">(=)</span> <span class="skolem">y</span> <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> stream.rel_conversep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="free">cfg'</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> emeasure <span class="main">(</span>R_G.T <span class="free">cfg'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emeasure_eq_AE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>MDP.T <span class="free">cfg</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="free">cfg</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emeasure_eq_AE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_G.T_def MDP.T_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_eq_rel_half<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">absc</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">valid_cfg</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_stream_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_set_strong_def stream.rel_eq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> stream.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ra <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
      <span class="keyword1"><span class="command">using</span></span> Y_X_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smap state <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"smap state <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> X_Y_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smap state <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"smap state <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * stream.rel_eq stream.map_comp state_absc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K_cfg_map_absc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_pmf_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Clean duplication *)</span>
<span class="keyword1" id="PTA-path_measure_eq_repcs1_new"><span class="command">lemma</span></span> path_measure_eq_repcs1_new<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cfg</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">≡</span> repcs <span class="free">s</span> <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> R_G.St"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Y<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> MDP.St"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">(</span>R_G.T <span class="free">cfg</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">(</span>MDP.T <span class="free">cfg'</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred R_G.St <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Q'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred MDP.St <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X_Y_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> smap abss <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_X_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟹</span> smap abss <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="free">cfg</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="free">cfg'</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> stream_all2 <span class="main">(=)</span> <span class="skolem">y</span> <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> stream.rel_conversep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P X <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="free">cfg</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> emeasure <span class="main">(</span>R_G.T <span class="free">cfg</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emeasure_eq_AE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Q Y <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>MDP.T <span class="free">cfg'</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="free">cfg'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emeasure_eq_AE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_G.T_def MDP.T_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_eq_rel_half<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">absc</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">valid_cfg</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_stream_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_set_strong_def stream.rel_eq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> stream.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ra <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
        <span class="keyword1"><span class="command">using</span></span> Y_X_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smap state <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"smap state <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> X_Y_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smap state <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"smap state <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * stream.rel_eq stream.map_comp state_absc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> K_cfg_map_absc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_pmf_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s absc_repcs_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-region_compatible_suntil1"><span class="command">lemma</span></span> region_compatible_suntil1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">suntil</span> holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap abss <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"smap abss <span class="free">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> suntil.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> suntil.base <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> step
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> step.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"stl <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> step.prems step.hyps<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> suntil.step <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-region_compatible_suntil2"><span class="command">lemma</span></span> region_compatible_suntil2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">suntil</span> holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap abss <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> suntil.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> suntil.base <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> suntil.step <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-region_compatible_suntil"><span class="command">lemma</span></span> region_compatible_suntil<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">suntil</span> holds <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap abss <span class="free">x</span><span class="main">)</span>
     <span class="main">⟷</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">using</span></span> assms region_compatible_suntil1 region_compatible_suntil2 <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="PTA-reps_abss_S"><span class="command">lemma</span></span> reps_abss_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span>abss <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_reps_𝒮 𝒮_abss_S assms<span class="main">)</span>

<span class="keyword1" id="PTA-measurable_sset"><span class="command">lemma</span></span> measurable_sset<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> stream_space <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>sset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>sset <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sset_range<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA-path_measure_eq_repcs''_new"><span class="command">lemma</span></span> path_measure_eq_repcs''_new<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> in_space_UNIV<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cfg</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">≡</span> repcs <span class="free">s</span> <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ'</span> <span class="main">≡</span> absp <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ'</span> <span class="main">≡</span> absp <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"abss <span class="free">s</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equiv_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="bound">x</span>
                    <span class="main">⟹</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>state <span class="free">cfg'</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> equiv_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="bound">x</span>
                    <span class="main">⟹</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>state <span class="free">cfg'</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="free">cfg</span><span class="main">)</span>  <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space R_G.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ'</span> <span class="keyword1">suntil</span> holds <span class="free">ψ'</span><span class="main">)</span> <span class="main">(</span>state <span class="free">cfg</span>  <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
     emeasure <span class="main">(</span>MDP.T <span class="free">cfg'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space MDP.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span>  <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>  <span class="main">(</span>state <span class="free">cfg'</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cfg'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path_measure_eq_repcs1_new<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_G.T_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> AE_distr_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MDP.MC.AE_T_enabled AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> R_G.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MDP.T_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> AE_distr_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MDP.MC.AE_T_enabled AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> MDP.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> valid'<span class="main">,</span> <span class="operator">unfolded</span> cfg'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> ys xs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ'_def ψ'_def absp_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> region_compatible_suntil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮_abss_S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> equiv_φ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮_abss_S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> equiv_ψ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid prems
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s comp_def φ'_def ψ'_def absp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> ys xs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set 𝒮_abss_S<span class="main"><span class="keyword3">;</span></span> <span class="operator">measurable</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> φ'_def ψ'_def absp_def comp_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_comp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> region_compatible_suntil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮_abss_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> equiv_φ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg'_def repc_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮_abss_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> equiv_ψ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s S_abss_𝒮 stream.pred_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Probabilistic Timed Automaton Regions *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span>
</pre>
</div><div id="PTA_Reachability">
<div class="head">
<h1>Theory PTA_Reachability</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PTA_Reachability
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="PTA.html">PTA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Classifying Regions for Divergence›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pairwise›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">pairwise</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">pairwise</span> <span class="free">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">pairwise</span> <span class="free">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Reachability-pairwise_Suc"><span class="command">lemma</span></span> pairwise_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pairwise.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PTA_Reachability-Suc_pairwise"><span class="command">lemma</span></span> Suc_pairwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> pairwise <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="main"><span class="main">_</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> HOL.refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-pairwise_iff"><span class="command">lemma</span></span> pairwise_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pairwise_Suc Suc_pairwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="PTA_Reachability-pairwise_stlD"><span class="command">lemma</span></span> pairwise_stlD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> pairwise <span class="free">P</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pairwise.cases<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-pairwise_pairD"><span class="command">lemma</span></span> pairwise_pairD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pairwise.cases<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-pairwise_mp"><span class="command">lemma</span></span> pairwise_mp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> sset <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">Q</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="main"><span class="main">_</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HOL.refl<span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stl_sset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pairwise_pairD pairwise_stlD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA_Reachability-pairwise_sdropD"><span class="command">lemma</span></span> pairwise_sdropD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pairwise <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"shd <span class="main"><span class="main">(</span></span>sdrop <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"shd <span class="main"><span class="main">(</span></span>stl <span class="main"><span class="main">(</span></span>sdrop <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="main"><span class="main">(</span></span>stl <span class="main"><span class="main">(</span></span>sdrop <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pairwise_Suc<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sdrop_stl stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pairwise_Suc pairwise_stlD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regions›</span></span>

<span class="comment1">(* XXX Move. Rename? *)</span>
<span class="keyword1" id="PTA_Reachability-gt_GreaterD"><span class="command">lemma</span></span> gt_GreaterD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">c</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-const_ConstD"><span class="command">lemma</span></span> const_ConstD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Const <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">c</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-not_Greater_bounded"><span class="command">lemma</span></span> not_Greater_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">x</span> <span class="main">≠</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">k</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">x</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">k</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-Greater_closed"><span class="command">lemma</span></span> Greater_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">(</span><span class="free">c</span> <span class="main">:=</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> region.intros<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">c</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> intv_elem.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-Greater_unbounded_aux"><span class="command">lemma</span></span> Greater_unbounded_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">.</span> <span class="bound">u</span> <span class="free">c</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Greater_closed<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2-4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">k</span> <span class="free">c</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> region_not_empty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Greater_closed<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2-4<span class="main"><span class="main">)</span></span> t<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">(</span><span class="free">c</span><span class="main">:=</span><span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">u</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">c</span></span></span><span class="main"><span class="main"><span class="main">:=</span></span></span><span class="var"><span class="var"><span class="var">?t</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unbounded and Zero Regions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unbounded</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">t</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">zero</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="PTA_Reachability-Greater_unbounded"><span class="command">lemma</span></span> Greater_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="free">c</span> <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Greater_unbounded_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> unbounded_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="PTA_Reachability-unbounded_Greater"><span class="command">lemma</span></span> unbounded_Greater<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="free">c</span> <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> unbounded_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_GreaterD<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-Const_zero"><span class="command">lemma</span></span> Const_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Const <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">c</span> <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="PTA_Reachability-zero_Const"><span class="command">lemma</span></span> zero_Const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">c</span> <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Const <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> region_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> const_ConstD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-zero_all"><span class="command">lemma</span></span> zero_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region <span class="free">X</span> <span class="free">k</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">c</span> <span class="main">(</span>region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="free">c</span> <span class="free">u</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">c</span> <span class="main">=</span> Const <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> region <span class="free">X</span> <span class="free">I</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u'</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Reachability›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Probabilistic_Timed_Automaton_Regions_Reachability <span class="main">=</span>
  Probabilistic_Timed_Automaton_Regions <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">not_in_X</span></span> <span class="quoted"><span class="free">A</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">v</span> <span class="free">n</span> <span class="free">not_in_X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> pta"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="bound">x</span> <span class="main">~</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="bound">x</span> <span class="main">~</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">ψ</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> S"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ'</span> <span class="main">≡</span> absp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ'</span> <span class="main">≡</span> absp <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">≡</span> abss <span class="free">s</span>"</span></span>

<span class="keyword1" id="PTA_Reachability-s_s'_cfg_on"><span class="command">lemma</span></span> s_s'_cfg_on<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on s'"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MDP.valid_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_absc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-s'_𝒮"><span class="command">lemma</span></span> s'_𝒮<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"s' <span class="main">∈</span> 𝒮"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-s'_s_cfg_on"><span class="command">lemma</span></span> s'_s_cfg_on<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on s'"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">s</span> <span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_G.valid_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">s</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Probabilistic_Timed_Automaton_Regions<span class="main">)</span> compatible_stream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="bound">x</span> <span class="main">~</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> S"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> sset <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reps <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">~</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> φ <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-φ_stream'"><span class="command">lemma</span></span> φ_stream'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compatible_stream<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">,</span> <span class="operator">OF</span> φ that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="PTA_Reachability-ψ_stream'"><span class="command">lemma</span></span> ψ_stream'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compatible_stream<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">,</span> <span class="operator">OF</span> ψ that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> φ_stream <span class="main">=</span> compatible_stream<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">,</span> <span class="operator">OF</span> φ<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> ψ_stream <span class="main">=</span> compatible_stream<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">,</span> <span class="operator">OF</span> ψ<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Easier Result on All Configurations›</span></span>

<span class="comment1">(* TODO: Rename *)</span>
<span class="keyword1" id="PTA_Reachability-suntil_reps"><span class="command">lemma</span></span> suntil_reps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>sset <span class="main">(</span>smap abss <span class="free">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> smap abss <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> region_compatible_suntil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> φ_stream ψ_stream<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ'_def ψ'_def absp_def stream.pred_set 𝒮_abss_S s'_def comp_def<span class="main">)</span>

<span class="comment1">(* TODO: Rename *)</span>
<span class="keyword1" id="PTA_Reachability-suntil_abss"><span class="command">lemma</span></span> suntil_abss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>sset <span class="free">y</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> smap abss <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> region_compatible_suntil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> φ_stream ψ_stream<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ'_def ψ'_def absp_def stream.pred_set s'_def comp_def<span class="main">)</span>

<span class="comment1">(* TODO: Generalize to CTL formulae *)</span>
<span class="keyword1"><span class="command">theorem</span></span> P_sup_sunitl_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> in_space_UNIV <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> pred_stream_iff
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>MDP.P_sup <span class="free">s</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>   <span class="main">(</span><span class="free">s</span>  <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span>R_G.P_sup s' <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MDP.P_sup_def R_G.P_sup_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"absc <span class="skolem">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cfg'</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="keyword1"><span class="command">have</span></span> alw_S<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>MDP.T <span class="skolem">cfg</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MDP.alw_S<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?cfg'</span><span class="main">∈</span> R_G.valid_cfg›</span></span> <span class="keyword1"><span class="command">have</span></span> alw_𝒮<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>R_G.T <span class="var">?cfg'</span><span class="main">)</span> <span class="main">(</span>pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_G.alw_S<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>MDP.T <span class="skolem">cfg</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space MDP.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>
       <span class="main">=</span> emeasure <span class="main">(</span>R_G.T <span class="var">?cfg'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space R_G.St<span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path_measure_eq_absc1_new<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮<span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems alw_S alw_𝒮 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span><span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_abss_𝒮 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> suntil_abss suntil_reps<span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span></span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">cfg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"repcs <span class="free">s</span> <span class="skolem">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> state <span class="var">?cfg'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s' <span class="main">=</span> state <span class="skolem">cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>state <span class="main">(</span>repcs <span class="free">s</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> prems that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> φ_stream<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>reps <span class="main">(</span>abss <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>state <span class="main">(</span>repcs <span class="free">s</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> prems that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ψ_stream<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="skolem">cfg</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space R_G.St<span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>
    <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="main">(</span>repcs <span class="free">s</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space MDP.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">##</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>›</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹s' <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ'_def ψ'_def s'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path_measure_eq_repcs''_new<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI MDP.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span></span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* PTA Reachability Problem *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Divergent Adversaries›</span></span>

<span class="keyword1"><span class="command">context</span></span> Probabilistic_Timed_Automaton
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">elapsed</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">≡</span> Max <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="bound">c</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_elapsed</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">≡</span> elapsed <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="bound">c</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">c</span> <span class="main">=</span> elapsed <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">dur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval stream <span class="main">⇒</span> nat <span class="main">⇒</span> t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">dur</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">dur</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> elapsed <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free">dur</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">divergent</span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">t</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> dur <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="bound">t</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">div_cfg</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> <span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">.</span> divergent <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℛ_div</span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_G_div_cfg</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> <span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">.</span> ℛ_div <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Probabilistic_Timed_Automaton_Regions
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg_on_div</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> MDP.cfg_on <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> div_cfg <span class="bound">cfg</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_G_cfg_on_div</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> R_G.cfg_on <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> R_G_div_cfg <span class="bound">cfg</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="PTA_Reachability-measurable_ℛ_div"><span class="command">lemma</span></span> measurable_ℛ_div<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred MDP.MC.S ℛ_div"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ℛ_div_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span>
        pred_intros_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> beta_interp.finite<span class="main"><span class="main">]</span></span>
        pred_intros_logic pred_intros_countable
        measurable_count_space_const measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_snth<span class="main"><span class="main">]</span></span>
     <span class="main">)</span> <span class="operator">measurable</span>

<span class="keyword1" id="PTA_Reachability-elapsed_ge0"><span class="command">lemma</span></span> elapsed_ge0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"elapsed <span class="free">x</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> elapsed_def <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-dur_pos"><span class="command">lemma</span></span> dur_pos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i xs
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA_Reachability-dur_mono"><span class="command">lemma</span></span> dur_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">≤</span> dur <span class="free">xs</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dur_pos<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span> <span class="main">##</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stream.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="skolem">xs</span> <span class="skolem">j</span> <span class="main">=</span> elapsed <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">+</span> dur <span class="main">(</span><span class="skolem">y</span> <span class="main">##</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc j' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> elapsed <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">+</span> dur <span class="main">(</span><span class="skolem">y</span> <span class="main">##</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">+</span> dur <span class="main">(</span><span class="skolem">y</span> <span class="main">##</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> dur <span class="skolem">xs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-dur_monoD"><span class="command">lemma</span></span> dur_monoD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">i</span> <span class="main">&lt;</span> dur <span class="free">xs</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> leI dur_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-elapsed_0D"><span class="command">lemma</span></span> elapsed_0D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span> <span class="main">∈</span> <span class="main">{</span><span class="free">u'</span> <span class="bound">c</span> <span class="main">-</span> <span class="free">u</span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">{</span><span class="free">u'</span> <span class="bound">c</span> <span class="main">-</span> <span class="free">u</span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> elapsed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-elapsed_ge"><span class="command">lemma</span></span> elapsed_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">≥</span> <span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_elapsed_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> elapsed_ge0 order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> elapsed_0D<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-elapsed_eq"><span class="command">lemma</span></span> elapsed_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">=</span> <span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elapsed_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_elapsed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-dur_shift"><span class="command">lemma</span></span> dur_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dur <span class="free">ω</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> dur <span class="free">ω</span> <span class="free">i</span> <span class="main">+</span> dur <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">ω</span><span class="main">)</span> <span class="free">j</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i ω
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem">ω</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"dur <span class="skolem"><span class="skolem">ω</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"dur <span class="main"><span class="main">(</span></span><span class="main"><span class="main">_</span></span> <span class="main"><span class="main">##</span></span> <span class="main"><span class="main">⌑</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA_Reachability-dur_zero"><span class="command">lemma</span></span> dur_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> zero <span class="free">x</span> <span class="main">(</span><span class="free">ω</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">ω</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!!</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stl <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="var">?x</span> <span class="main">##</span> <span class="var">?y</span> <span class="main">##</span> <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="var">?y</span> <span class="main">##</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> stl <span class="skolem">ω</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="skolem">i</span><span class="main">.</span> zero <span class="free">x</span> <span class="main">(</span>stl <span class="skolem">ω</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span>stl <span class="skolem">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dur <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="free">x</span> <span class="main">-</span> <span class="var">?x</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="skolem">xs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> elapsed <span class="var">?x</span> <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> xs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> elapsed_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> One_nat_def <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-dur_zero_tail"><span class="command">lemma</span></span> dur_zero_tail<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">ω</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> zero <span class="free">x</span> <span class="main">(</span><span class="free">ω</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">j</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> dur_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">j</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">+</span> dur <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"dur <span class="main"><span class="main"><span class="main">(</span></span></span>sdrop <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> dur_zero<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ω <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"sdrop <span class="free">i</span> <span class="free">ω</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prop_nth_sdrop_pair<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">eq_elapsed</span><span class="main"><span class="main">]</span></span> prop_nth_sdrop prop_nth_sdrop_pair<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(∈)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-elapsed_ge_pos"><span class="command">lemma</span></span> elapsed_ge_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">≤</span> <span class="free">u'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> V›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳 ›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> False assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">=</span> <span class="free">u'</span> <span class="free">c</span> <span class="main">-</span> <span class="free">u</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_elapsed_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">u'</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-dur_Suc"><span class="command">lemma</span></span> dur_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="main"><span class="main">_</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i xs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="main"><span class="main">_</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"dur <span class="skolem"><span class="skolem">xs</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">##</span></span> stl <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dur.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trans</span> <span class="keyword2"><span class="keyword">where</span></span>
  succ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span> <span class="main">|</span>
  reset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⊆</span> 𝒳 <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> clock_set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span> <span class="main">|</span>
  id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span> <span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">stream_trans</span> <span class="main">≡</span> pairwise trans"</span></span>

<span class="keyword1" id="PTA_Reachability-K_cfg_trans"><span class="command">lemma</span></span> K_cfg_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">R</span> <span class="free">R'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> MDP.cfg_onD_action<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> K.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans.intros<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> admissible_targets_clocks<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-enabled_stream_trans"><span class="command">lemma</span></span> enabled_stream_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="quoted"><span class="quoted">"MDP.MC.enabled <span class="free">cfg</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>pairwise <span class="skolem">cfg</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stl <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> MDP.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> prems<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">cfg</span><span class="main">.</span> state <span class="bound">cfg</span> <span class="main">∈</span> S <span class="main">∧</span> <span class="bound">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"state <span class="var">?x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="var">?y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span>state <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> K_cfg <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MDP.MC.enabled.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="skolem">R</span> <span class="skolem">R'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> K_cfg_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cfg <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> cfg' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> l <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> l' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">∈</span> valid_cfg›</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">R</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">R'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"smap <span class="main"><span class="main">(</span></span>snd <span class="keyword1"><span class="keyword1">o</span></span> state<span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?xs</span></span>"</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?x</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MDP.MC.enabled.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-stream_trans_trans"><span class="command">lemma</span></span> stream_trans_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pairwise_Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-trans_eq_elapsed"><span class="command">lemma</span></span> trans_eq_elapsed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="free">u</span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>succ <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def elapsed_def max_def eq_elapsed_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>reset <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="skolem">c</span> <span class="main">-</span> <span class="free">u</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> V›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="free">u</span> <span class="free">u'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> elapsed_def <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Max_insert2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_elapsed_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> id
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_gr_iff elapsed_def eq_elapsed_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-pairwise_trans_eq_elapsed"><span class="command">lemma</span></span> pairwise_trans_eq_elapsed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> trans_eq_elapsed assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pairwise_mp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-not_reset_dur"><span class="command">lemma</span></span> not_reset_dur<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">¬</span> zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> stream_trans_trans<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> regions<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> succ
    <span class="keyword1"><span class="command">with</span></span> regions <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>reset <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span> <span class="main">∈</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zero_all<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main">]</span> regions<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> id <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳›</span></span> elapsed_eq <span class="keyword1"><span class="command">have</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dur_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span>  <span class="main">+</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * False Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-not_reset_dur'"><span class="command">lemma</span></span> not_reset_dur'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms not_reset_dur <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-not_reset_unbounded"><span class="command">lemma</span></span> not_reset_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span> <span class="main">∈</span> V"</span></span>
          <span class="quoted"><span class="quoted">"unbounded <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">]⇩</span>ℛ"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">,</span>7<span class="main">)</span> unbounded_Greater <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="main">∈</span> <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="free">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> not_reset_dur'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span><span class="main">]</span> dur_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="free">c</span> <span class="main">≥</span> <span class="var">?u</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="free">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">]⇩</span>ℛ"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">∈</span> <span class="var">?R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R'</span> <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R'</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u'</span> <span class="free">c</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> gt_GreaterD <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="free">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Greater_unbounded<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-gt_unboundedD"><span class="command">lemma</span></span> gt_unboundedD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">k</span> <span class="free">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="free">c</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Greater_unbounded<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒳</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> gt_GreaterD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted">𝒳</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> assms finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans'</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> delayedR <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA_Reachability-zeroI"><span class="command">lemma</span></span> zeroI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">c</span> <span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> zero_all<span class="main">[</span><span class="operator">OF</span> finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move, rename *)</span>
<span class="keyword1" id="PTA_Reachability-zeroD"><span class="command">lemma</span></span> zeroD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> regions_part_ex<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zero_def<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-not_zeroD"><span class="command">lemma</span></span> not_zeroD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> zeroI assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA_Reachability-not_const_intv"><span class="command">lemma</span></span> not_const_intv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="skolem">c</span> <span class="main">=</span> real <span class="bound">d</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">u'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="skolem">c</span> <span class="main">=</span> real <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> I that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">c</span> <span class="skolem">u'</span> <span class="main">(</span><span class="skolem">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_intv <span class="main">(</span><span class="free">k</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> A I <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u</span><span class="main">]⇩</span>ℛ›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-K_cfg_trans'"><span class="command">lemma</span></span> K_cfg_trans'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="main">(</span>repcs <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">cfg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trans' <span class="free">u</span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> MDP.cfg_onD_action<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> K.cases<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"absc <span class="main">(</span>repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> repcs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹abss <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> abst_rept_id<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">=</span> abst <span class="main">(</span>return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="skolem">u</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> upper_right_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> True<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ <span class="main">=</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alpha_interp.region_unique_spec<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="numeral">0.5</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="free">u'</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> F<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="skolem">u</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">u'</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">u'</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">∈</span> <span class="main">[</span><span class="free">u'</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> Succ ℛ <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> zeroI prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">c</span> <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="skolem">c</span> <span class="main">(</span><span class="main">[</span><span class="free">u'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ <span class="main">≠</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True not_const_intv prems <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ<span class="main">.</span> <span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S <span class="main">∧</span>
                     action <span class="free">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="bound">R'</span> <span class="main">∈</span> Succ ℛ <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ <span class="main">≠</span> <span class="bound">R'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="bound">R'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> <span class="main">∄</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="bound">c</span> <span class="main">∧</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">=</span> real <span class="bound">d</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command">using</span></span> prems ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>
       <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> delayedR <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">R'</span><span class="main">.</span> action <span class="free">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">R'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * ** prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">=</span> delayedR <span class="main">(</span><span class="main">[</span><span class="skolem">u</span> <span class="main">⊕</span> <span class="skolem">t</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> F True prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> F <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>2 _ _ <span class="skolem">τ</span> <span class="skolem">μ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> set_pmf <span class="skolem">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> S›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> set <span class="bound">r</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> non_empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">using</span></span> admissible_targets_clocks<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> X<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> 𝒳›</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_list finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?r</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> X r <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> V›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">u</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">u</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="main">_</span> <span class="main">≤</span> <span class="main">_</span>›</span></span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">with</span></span> non_empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">enabled_repcs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enabled_repcs</span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟹</span> shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> repcs <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">∈</span> rept <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>action <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> abss <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> state <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">∈</span> R_G.valid_cfg
  <span class="main">⟹</span> <span class="free">enabled_repcs</span> <span class="main">(</span>repcs <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="comment1">(* XXX Move *)</span>
<span class="keyword1" id="PTA_Reachability-K_cfg_rept_in"><span class="command">lemma</span></span> K_cfg_rept_in<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">st</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">∈</span> K_cfg <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rept <span class="free">st</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="free">cfg'</span><span class="main">)</span>
         <span class="main">∈</span> set_pmf <span class="main">(</span>rept <span class="free">st</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="free">cfg</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">R_G_I</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg'</span> <span class="main">=</span> cont <span class="free">cfg</span> <span class="main">(</span>state <span class="free">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> action <span class="free">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_K_cfg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> abst_rept_id<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹action <span class="main">_</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span> pmf.set_map <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"state <span class="free">cfg'</span> <span class="main">∈</span> abss <span class="main">`</span> set_pmf <span class="main">(</span>rept <span class="free">st</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abst_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">∈</span> rept <span class="free">st</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">st'</span> <span class="main">=</span> state <span class="free">cfg'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> K_cfg_rept_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-enabled_repcsI"><span class="command">lemma</span></span> enabled_repcsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">st</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"MDP.MC.enabled <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enabled_repcs <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>enabled_repcs <span class="skolem">cfg</span> <span class="skolem">xs</span> <span class="skolem">st</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?st</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>rept <span class="skolem">st</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="main">(</span>absc <span class="var">?x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> K_cfg <span class="main">(</span>repcs <span class="skolem">st</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">with</span></span> K_cfg_map_repcs<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cfg'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> K_cfg <span class="skolem">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> repcs <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> rept <span class="skolem">st</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="skolem">cfg'</span><span class="main">)</span> <span class="skolem">cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?st</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">THE</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> rept <span class="skolem">st</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∧</span> abss <span class="bound">s'</span> <span class="main">=</span> state <span class="skolem">cfg'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> K_cfg_rept_action<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="var">?st</span> <span class="main">=</span> state <span class="skolem">cfg'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> K_cfg_rept_in<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?st</span> <span class="main">∈</span> rept <span class="skolem">st</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg'</span> <span class="main">∈</span> K_cfg <span class="skolem">cfg</span>›</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> absc_repcs_id<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹abss <span class="var">?st</span> <span class="main">=</span> state <span class="skolem">cfg'</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"absc <span class="var">?x</span> <span class="main">=</span> <span class="skolem">cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MDP.MC.enabled <span class="main">(</span>shd <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?st</span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"absc <span class="var"><span class="var"><span class="var">?x</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">st</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cfg</span></span></span></span></span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-repcs_eq_rept"><span class="command">lemma</span></span> repcs_eq_rept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rept <span class="free">st</span> <span class="main">(</span>action <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> rept <span class="free">st''</span> <span class="main">(</span>action <span class="free">cfg''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">=</span> repcs <span class="free">st''</span> <span class="free">cfg''</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> action_cfg_corec old.prod.case repcs_def that<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-enabled_stream_trans'"><span class="command">lemma</span></span> enabled_stream_trans'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"abss <span class="free">st</span> <span class="main">=</span> state <span class="free">cfg</span>"</span></span> <span class="quoted"><span class="quoted">"MDP.MC.enabled <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise trans' <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cfg</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>pairwise <span class="skolem">cfg</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stl <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled_repcs <span class="main">(</span>repcs <span class="skolem">st</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enabled_repcsI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">cfg'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"enabled_repcs <span class="main">(</span>shd <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span> <span class="main">=</span> repcs <span class="skolem">st'</span> <span class="skolem">cfg'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">∈</span> rept <span class="skolem">st</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"abss <span class="skolem">st'</span> <span class="main">=</span> state <span class="skolem">cfg'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg'</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> enabled_repcs.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> st' cfg' st'' cfg''
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">st'</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cfg'</span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> repcs_eq_rept<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st''</span></span> <span class="skolem"><span class="skolem">cfg''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"enabled_repcs <span class="main">(</span>shd <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span>stl <span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"shd <span class="var">?xs</span> <span class="main">=</span> repcs <span class="skolem">st''</span> <span class="skolem">cfg''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st''</span> <span class="main">∈</span> rept <span class="skolem">st'</span> <span class="main">(</span>action <span class="skolem">cfg'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">st''</span> <span class="main">=</span> state <span class="skolem">cfg''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span>enabled_repcs.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> repcs_eq_rept<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"repcs <span class="skolem">st</span> <span class="skolem">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> MDP.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?cfg</span> <span class="main">∈</span> valid_cfg›</span></span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">cfg</span><span class="main">.</span> state <span class="bound">cfg</span> <span class="main">∈</span> S <span class="main">∧</span> <span class="bound">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st''</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span>state <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> K_cfg <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MDP.MC.enabled.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans' <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg'</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹abss <span class="skolem">st'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> K_cfg_trans'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfg_state_in_S<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg'</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹abss <span class="main">_</span> <span class="main">=</span> state <span class="skolem">cfg'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u'</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"smap <span class="main"><span class="main">(</span></span>snd <span class="keyword1"><span class="keyword1">o</span></span> state<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>stl <span class="var"><span class="var">?xs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?y</span> <span class="main">=</span> <span class="main">_</span>›</span></span> eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MDP.MC.enabled.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-divergent_ℛ_divergent"><span class="command">lemma</span></span> divergent_ℛ_divergent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span>  div<span class="main">:</span>  <span class="quoted"><span class="quoted">"divergent <span class="free">xs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ℛ_div <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ℛ_div <span class="var">?ω</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> ℛ_div_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> xs_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?ω</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trans in_S <span class="keyword1"><span class="command">have</span></span> elapsed<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pairwise_trans_eq_elapsed pairwise_Suc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">eq_elapsed</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">k</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> div <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">&gt;</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">k</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> divergent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="skolem">x</span> <span class="main">&lt;</span> dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> not_reset_dur'<span class="main">[</span><span class="operator">OF</span> A less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dur_monoD<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> assms elapsed <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gt_unboundedD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dur_monoD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> j A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elapsed assms x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_reset_unbounded <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bounded <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> div <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">&gt;</span> dur <span class="free">xs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> divergent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dur_monoD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="var">?ω</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dur_zero_tail<span class="main">[</span><span class="operator">OF</span> xs_ω _ x <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> elapsed<span class="main">]</span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="comment1">(* TODO: Reduce this proof to a more general theorem *)</span>
<span class="keyword1" id="PTA_Reachability-dur_ev_exceedsI"><span class="command">lemma</span></span> dur_ev_exceedsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="main">0</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> dur_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">d</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> base2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≤</span> <span class="free">d</span>›</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> base <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="free">d</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> dur_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="free">t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="var">?m</span> <span class="main">*</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> base<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="free">d</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">/</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="comment1">(* Generated by sledgehammer *)</span>
        <span class="comment1">(* Alternative: by (smt assms(2) diff_divide_distrib divide_self_if) *)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_divide_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="var">?t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span><span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌈</span><span class="var">?t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="free">d</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="var">?t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">*</span> <span class="free">d</span> <span class="main">&lt;</span> dur <span class="free">xs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="var">?t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="free">d</span> <span class="main">&lt;</span> dur <span class="free">xs</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">&gt;</span> nat <span class="main">⌈</span><span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">*</span> <span class="free">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌈</span><span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span>›</span></span> add.commute distrib_left mult.commute 
                  mult.right_neutral of_nat_Suc<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="skolem">t</span> <span class="main">/</span> <span class="free">d</span><span class="main">⌉</span> <span class="main">*</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span> Suc_leI add.right_neutral le_antisym mult.commute
                  mult.right_neutral of_nat_0 of_nat_Suc order_refl zero_less_Suc<span class="main">)</span> 
        <span class="keyword1"><span class="command">with</span></span> base2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="var">?m</span> <span class="main">*</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">*</span> <span class="free">d</span> <span class="main">≥</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos_divide_le_eq real_nat_ceiling_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-not_reset_mono"><span class="command">lemma</span></span> not_reset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"shd <span class="free">xs</span> <span class="free">c1</span> <span class="main">≥</span> shd <span class="free">xs</span> <span class="free">c2</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="free">c1</span> <span class="main">≥</span> <span class="bound">u</span> <span class="free">c2</span><span class="main">)</span> <span class="keyword1">until</span> holds <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="free">c1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>UNTIL <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stl <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="var">?xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="free">c1</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="free">c1</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?x</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pairwise_pairD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">trans</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="free">c1</span> <span class="main">≥</span> <span class="var">?y</span> <span class="free">c2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> <span class="main">(</span>reset <span class="skolem">t</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> A False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="free">c2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="free">c2</span> <span class="main">≤</span> <span class="var">?x</span> <span class="free">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> A False <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="free">c1</span> <span class="main">≥</span> <span class="var">?x</span> <span class="free">c2</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> prems <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> cval_add_def›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="var">?xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pairwise_stlD stl_sset<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> prems <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> UNTIL.base›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-ℛ_divergent_divergent_aux"><span class="command">lemma</span></span> ℛ_divergent_divergent_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> t<span class="main">)</span> cval stream"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≥</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">c1</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">c1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≥</span> shd <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> not_reset_mono<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="free">c2</span> <span class="main">≤</span> <span class="bound">u</span> <span class="free">c1</span><span class="main">)</span> <span class="keyword1">until</span> holds <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="free">c1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sset_sdrop pairwise_sdropD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> k<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">)</span> <span class="free">c1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> holds_untilD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">_</span> <span class="keyword1">until</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">c2</span> <span class="main">≤</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">c1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c2</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-unbounded_all"><span class="command">lemma</span></span> unbounded_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="free">x</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> unbounded_Greater <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> 𝒳›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="free">x</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> R <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-trans_not_delay_mono"><span class="command">lemma</span></span> trans_not_delay_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹trans <span class="free">u</span> <span class="free">u'</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reset <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> cval_add_def V_def add_nonneg_eq_0_iff›</span><span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-dur_reset"><span class="command">lemma</span></span> dur_reset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> in_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span> <span class="main">∈</span> V"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snth_sset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> elapsed_ge_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> in_V assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeroD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> elapsed_ge0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dur_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-resets_mono_0'"><span class="command">lemma</span></span> resets_mono_0'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">0</span><span class="main">)</span> <span class="free">c</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>        
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zeroD snth_sset<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zeroD snth_sset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>succ <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>reset <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> id
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-resets_mono'"><span class="command">lemma</span></span> resets_mono'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sset_sdrop <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pairwise_sdropD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_trans <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pairwise_sdropD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">.</span> zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span>sdrop <span class="free">i</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_conv2 assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> resets_mono_0'<span class="main">[</span><span class="operator">OF</span> 2 1 3 4 assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-resets_mono"><span class="command">lemma</span></span> resets_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> zero <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> resets_mono'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>

<span class="keyword1" id="PTA_Reachability-ℛ_divergent_divergent_aux2"><span class="command">lemma</span></span> ℛ_divergent_divergent_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span><span class="main">∃</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">P</span> <span class="bound">m</span><span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">m</span> <span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&gt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j1</span> <span class="main">≥</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j1</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="var">?j1</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&gt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j1</span> <span class="main">≥</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="skolem">j1</span> <span class="main">≥</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Q</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="skolem">k</span> <span class="bound">Q</span> <span class="main">|</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="bound">P</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="bound">Q</span> <span class="main">|</span> <span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">M</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">P</span> <span class="main">=</span> <span class="var">?k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≥</span> <span class="skolem">k</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Q</span> <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="var">?P</span> <span class="main">=</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> j1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="skolem">j1</span> <span class="main">≥</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">&gt;</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">k</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Q</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> Suc <span class="skolem">j1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="skolem">j1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">&gt;</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">k</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j1</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">j1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="var">?P</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="var">?k</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="var">?k</span><span class="main">.</span> <span class="var">?j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Q</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> k<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">&gt;</span> <span class="skolem">j1</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">k</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">≤</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="skolem">Q</span> <span class="main">&gt;</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span><span class="main">∃</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">P</span> <span class="bound">m</span><span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">&lt;</span> <span class="var">?k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="var">?k</span>›</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?j</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?k</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-ℛ_divergent_divergent"><span class="command">lemma</span></span> ℛ_divergent_divergent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> div<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ_div <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_trans <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise trans' <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> unbounded_not_const<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"divergent <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divergent_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">from</span></span> pairwise_trans_eq_elapsed<span class="main">[</span><span class="operator">OF</span> trans in_S<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> eq_elapsed<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise eq_elapsed <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite<span class="main">(</span>1<span class="main">)</span> non_empty <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_in<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">⊆</span> 𝒳"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> finite<span class="main">(</span>1<span class="main">)</span> non_empty <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">≥</span> <span class="var">?k</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_ge<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">k</span><span class="main">.</span> unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="var">?k</span><span class="main">.</span> unbounded <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="var">?i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?i</span> <span class="main">≥</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">&lt;</span> dur <span class="free">xs</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> 𝒳"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> <span class="numeral">0.5</span> <span class="main">≤</span> dur <span class="free">xs</span> <span class="bound">k</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> max <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">∈</span> <span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> unbounded <span class="quoted"><span class="quoted">‹<span class="skolem">X1</span> <span class="main">=</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="var">?u</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unbounded_all<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> unbounded_not_const <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ev <span class="main">(</span>alw <span class="main">(</span>HLD <span class="main">{</span><span class="var">?u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> HLD_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!!</span> Suc <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_ev_iff not_alw_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_sdrop<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">i</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alwD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stream.collapse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ev_neq_start_implies_ev_neq<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> comp_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> stream.collapse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ev_sdropD<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">using</span></span> snth_sset <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> in_S <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span> <span class="main">∈</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">]⇩</span>ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≥</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> unbounded <span class="quoted"><span class="quoted">‹<span class="skolem">X1</span> <span class="main">=</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snth.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unbounded_all<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trans' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans' <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pairwise_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⊕</span> <span class="numeral">0.5</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> eq_elapsed<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="var">?k</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">0.5</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> non_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def dur_Suc elapsed_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> dur_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="var">?k</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">0.5</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> dur_ev_exceedsI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="numeral">0.5</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> 𝒳 <span class="main">-</span> <span class="skolem">X1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X1_def X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> inf_resets<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that div <span class="keyword1"><span class="command">unfolding</span></span> X1_def X2_def ℛ_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">∧</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="main">¬</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="bound">j</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> unbounded <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">i'</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">i'</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> ℛ_divergent_divergent_aux2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">}</span>"</span></span><span class="main">]</span>
        inf_resets
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i'</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="bound">j</span><span class="main">.</span> <span class="main">∃</span><span class="bound">P</span><span class="main">∈</span><span class="main">{</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">}</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">k</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">P</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">∈</span><span class="main">{</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span><span class="main">∈</span><span class="main">{</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="bound">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X2</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="skolem">k</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">0.5</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span>  x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> not_reset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">∧</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j'</span></span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> inf_resets<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≥</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> inf_resets<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≥</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> nat_eventually_critical_path<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">j'</span> <span class="main">⟶</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> not_reset not_reset_dur <span class="quoted"><span class="quoted">‹stream_trans <span class="main">_</span>›</span></span> in_S pairwise_Suc<span class="main">[</span><span class="operator">OF</span> eq_elapsed<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d1</span> <span class="main">=</span> <span class="var">?d2</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">]⇩</span>ℛ<span class="main">)</span>›</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zeroD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d1</span> <span class="main">=</span> <span class="var">?d2</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?d1</span> <span class="main">≥</span> <span class="numeral">0.5</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="comment1">(* XXX Fix SMT *)</span>
        <span class="keyword1"><span class="command">with</span></span> dur_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="main">/</span> <span class="numeral">10</span> <span class="main">≤</span> dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> j_c_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="var">?d2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">from</span></span> X2 <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>›</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeroD stream.pred_set<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_eq Suc_pred linorder_neqE_nat not_less not_less_zero<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> not_reset in_S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeroI stream.pred_set<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="var">?d2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans in_S <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ℛ_divergent_divergent_aux that <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span>
            trans_not_delay_mono<span class="main">[</span><span class="operator">OF</span> pairwise_Suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> in_S x<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeroD stream.pred_set<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="quoted"><span class="quoted">‹<span class="var">?d1</span> <span class="main">=</span> <span class="var">?d2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d2</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> frac_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?d2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
          <span class="keyword1"><span class="command">using</span></span> that frac_le_1I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2_def<span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> region<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region 𝒳 <span class="skolem">I</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>frac <span class="main">(</span><span class="var">?u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> isIntv <span class="main">(</span><span class="skolem">I</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 𝒳_X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"isIntv <span class="main">(</span><span class="skolem">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> X1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X1</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> unbounded_Greater<span class="main">[</span><span class="operator">OF</span> region<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main">]</span> region<span class="main">(</span>1<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> <span class="skolem">X1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> frac_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?d2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"isIntv <span class="main">(</span><span class="skolem">I</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
          <span class="keyword1"><span class="command">using</span></span> frac_bound<span class="main">[</span><span class="operator">OF</span> 𝒳_X2<span class="main">]</span> that <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> in_S eq_elapsed
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dur_zero_tail<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ω <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="main">[</span><span class="bound">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pairwise_Suc <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dur_reset<span class="main">[</span><span class="operator">OF</span> eq_elapsed in_S<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> x<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> trans'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"trans' <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> j' <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zeroD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_zeroD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> delayedR_aux <span class="main">=</span> calculation
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊕</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> region'<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ <span class="main">=</span> region 𝒳 <span class="skolem">I'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"valid_region 𝒳 <span class="free">k</span> <span class="skolem">I'</span> <span class="skolem">r'</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> ℛ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>            
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>frac <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳 <span class="main">∧</span> Regions.isIntv <span class="main">(</span><span class="skolem">I'</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

            <span class="keyword1"><span class="command">from</span></span> finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d2</span> <span class="main">≥</span> Max <span class="main">(</span><span class="var">?S'</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Max.boundedI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> _ c d
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">from</span></span> j' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="var">?u</span> <span class="skolem">c</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> resets_mono'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_elapsed in_S trans _ <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> A<span class="main">:</span> 1
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X1</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> True
                    <span class="keyword1"><span class="command">with</span></span> X1 <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="skolem">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> region' <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="skolem">c</span> <span class="main">=</span> Greater <span class="main">(</span><span class="free">k</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unbounded_Greater<span class="main">)</span>
                    <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> False
                    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> j_c_bound <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                    <span class="keyword1"><span class="command">from</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> V_def stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
                      <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> frac_le_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> A mono <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 2
                    <span class="comment1">(* XXX *)</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> V_def stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">using</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def stream.pred_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> Max <span class="main">(</span><span class="var">?S'</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?u'</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">∈</span> V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> ℛ"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> trans<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Succ<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ <span class="main">∈</span> Succ ℛ <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">t</span></span><span class="main">≥</span> <span class="main">0</span><span class="main">.</span> <span class="var">?u</span> <span class="main">=</span> <span class="var">?u'</span> <span class="main">⊕</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
              <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>succ <span class="skolem">t</span><span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">∈</span> <span class="main">[</span><span class="var">?u'</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> prems * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reset <span class="skolem">l</span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u'</span> <span class="main">∈</span> V›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?u'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> j' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="var">?u'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u'</span> <span class="main">∈</span> V›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> id
              <span class="keyword1"><span class="command">with</span></span> * Succ_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted">ℛ</span> <span class="quoted">𝒳</span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">folded</span> ℛ_def<span class="main">,</span> <span class="operator">OF</span> _ finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊕</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">note</span></span> Succ <span class="main">=</span> Succ<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span>

            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> <span class="skolem">X2</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">d</span> <span class="main">::</span> nat<span class="main">.</span> <span class="var">?u</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">d</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X2_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
              <span class="keyword1"><span class="command">from</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> eq_elapsed<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?u</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span>
                elapsed_eq<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq_elapsed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> region' in_S <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">c</span> <span class="var">?u</span> <span class="main">(</span><span class="skolem">I'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?u</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="numeral">0.5</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
                  <span class="comment1">(* XXX This proof is duplicated at least once above *)</span>
                  <span class="keyword1"><span class="command">using</span></span> j'<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> resets_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_elapsed in_S trans _ <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?d2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_c_bound<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?d1</span> <span class="main">=</span> <span class="var">?d2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">10</span> <span class="main">≤</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">0.5</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def stream.pred_set<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> F<span class="main">:</span> False
              <span class="keyword1"><span class="command">have</span></span> not_const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isConst <span class="main">(</span><span class="skolem">I'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"isConst <span class="main">(</span><span class="skolem">I'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X1</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> True
                  <span class="keyword1"><span class="command">with</span></span> X1 <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="skolem">c</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">with</span></span> unbounded_Greater <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> region' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isGreater <span class="main">(</span><span class="skolem">I'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> False
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> region' in_S <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"intv_elem <span class="skolem">c</span> <span class="var">?u</span> <span class="main">(</span><span class="skolem">I'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>›</span></span> A False F <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">k</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> real <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> 𝒳"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> real <span class="skolem">d</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> F <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> <span class="skolem">X2</span>"</span></span> 
                <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">X1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> X1 <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unbounded <span class="skolem">c</span> <span class="main">(</span><span class="main">[</span><span class="var">?u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> unbounded_all<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> 𝒳›</span></span> in_S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="skolem">c</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="skolem">c</span> <span class="main">=</span> real <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≤</span> <span class="free">k</span> <span class="skolem">c</span>"</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">with</span></span> delayedR_aux <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> delayedR <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> not_const region'<span class="main">(</span>1<span class="main">)</span>  in_S Succ<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> delayedR <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊕</span> <span class="bound">t</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="main">1</span> <span class="main">-</span> Max <span class="main">(</span><span class="var">?S'</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> delayedR_correct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ region'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> le <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> delayedR <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> pairwise_Suc<span class="main">[</span><span class="operator">OF</span> eq_elapsed<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"eq_elapsed <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?d2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> dur_Suc<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> 𝒳›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cval_add_def elapsed_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dur_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≤</span> dur <span class="free">xs</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dur <span class="free">xs</span> <span class="skolem">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">0.5</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?d1</span> <span class="main">=</span> <span class="var">?d2</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">j'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> dur <span class="free">xs</span> <span class="bound">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">0.5</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> calculation<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&gt;</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="skolem">X2</span>"</span></span> <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="main">¬</span> zero <span class="skolem">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X2</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> zero <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X1</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> unbounded <span class="bound">x</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">m</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> calculation<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4-8<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≥</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="main">/</span> <span class="numeral">10</span> <span class="main">≤</span> dur <span class="free">xs</span> <span class="skolem">j'</span> <span class="main">-</span> dur <span class="free">xs</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> dur_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> dur_ev_exceedsI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="numeral">0.5</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-cfg_on_div_absc"><span class="command">lemma</span></span> cfg_on_div_absc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> in_space_UNIV<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on_div <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"absc <span class="free">cfg</span> <span class="main">∈</span> R_G_cfg_on_div <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">=</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"div_cfg <span class="free">cfg</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cfg_on_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>MDP.MC.T <span class="free">cfg</span><span class="main">)</span> <span class="main">(</span>MDP.MC.enabled <span class="free">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MDP.MC.AE_T_enabled<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> MDP.MC.T <span class="free">cfg</span><span class="main">.</span> divergent <span class="main">(</span>smap <span class="main">(</span>snd <span class="main">∘</span> state<span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_cfg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> MDP.MC.T <span class="free">cfg</span><span class="main">.</span> ℛ_div <span class="main">(</span>smap <span class="main">(</span>snd <span class="main">∘</span> state<span class="main">)</span> <span class="main">(</span>smap absc <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">ω</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> MDP.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹MDP.MC.enabled <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> S<span class="main">)</span> <span class="main">(</span>smap state <span class="skolem">ω</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">]⇩</span>ℛ <span class="main">=</span> snd <span class="main">(</span>abss <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sset <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> * that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="skolem">x</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>abss <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abss_S snd_conv surj_pair<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">[</span>snd <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> snd <span class="main">(</span>abss <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="var">?xs</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_def stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> S_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="var">?xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enabled_stream_trans <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹MDP.MC.enabled <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹divergent <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> divergent_ℛ_divergent<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_comp state_absc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R_G_div_cfg <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_G_div_cfg_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> absc_distr_self<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_distr_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> R_G.valid_cfgD <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alternating</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">.</span>
      alw <span class="main">(</span>ev <span class="main">(</span>HLD <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">∀</span><span class="bound">cfg'</span> <span class="main">∈</span> K_cfg <span class="bound">cfg</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Reachability-K_cfg_same_loc_iff"><span class="command">lemma</span></span> K_cfg_same_loc_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">cfg'</span><span class="main">∈</span> K_cfg <span class="free">cfg</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cfg'</span><span class="main">∈</span> K_cfg <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>state <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_absc fst_abss K_cfg_map_absc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> stream_all2_flip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">R</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> stream_all2 <span class="free">R</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>

<span class="comment1">(* TODO: Lots of duplication here, e.g. with path_measure_eq_repcs1_new *)</span>
<span class="keyword1" id="PTA_Reachability-AE_alw_ev_same_loc_iff"><span class="command">lemma</span></span> AE_alw_ev_same_loc_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alternating <span class="free">cfg</span> <span class="main">⟷</span> alternating <span class="main">(</span>absc <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> alternating_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MDP.MC.T.AE_iff_emeasure_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?y</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> stream_all2 <span class="main">(=)</span> <span class="skolem">y</span> <span class="main">(</span>smap absc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> stream_all2_flip<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_eq_rel_half<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">absc</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">valid_cfg</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> HOL.refl<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_stream_space rel_set_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> stream.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ra <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> absc <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * stream.rel_eq stream_all2_refl alw_holds_pred_stream_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
              K_cfg_same_loc_iff HLD_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_ev_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_reflI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf.rel_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> K_cfg_map_absc<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PTA_Reachability-AE_alw_ev_same_loc_iff'"><span class="command">lemma</span></span> AE_alw_ev_same_loc_iff'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alternating <span class="free">cfg</span> <span class="main">⟷</span> alternating <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_alw_ev_same_loc_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> absc_repcs_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> cval_add_non_id<span class="main">:</span>
  <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊕</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">⊕</span> <span class="free">d</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">b</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">unfolding</span></span> cval_add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-repcs_unbounded_AE_non_loop_end_strong"><span class="command">lemma</span></span> repcs_unbounded_AE_non_loop_end_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"alternating <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">&gt;</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> R_G.valid_cfgD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> L<span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">μ</span></span> <span class="main">∈</span> K <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="bound">μ</span> <span class="main">≠</span> return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">μ</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> Sup <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?U</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> lt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">≠</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_pmf <span class="skolem">μ</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">μ</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> measure_pmf.emeasure_ge_1_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Int_set_pmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emeasure_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_ge_1_iff measure_pmf_eq_1_iff that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span>map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="bound">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">|</span> <span class="bound">μ</span> <span class="bound">l</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?U</span> <span class="skolem">u</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> K.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="bound">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">`</span> trans_of <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> finite<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?U</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * finite_imp_Sup_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cfg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span> set<span class="main">)</span> cfg"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="skolem">u</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> 𝒮"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> same_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">cfg'</span> <span class="main">∈</span> K_cfg <span class="skolem">cfg</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cfg_on<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="skolem">cfg</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_G.cfg_onD_action<span class="main">)</span>
        <span class="comment1">(* TODO: Pull out? *)</span>
    <span class="keyword1"><span class="command">have</span></span> K_cfg_rept<span class="main">:</span> <span class="quoted"><span class="quoted">"state <span class="main">`</span> K_cfg <span class="main">(</span>repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">=</span> rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> K_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> action_repcs<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> L"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MDP.valid_cfg_state_in_S <span class="quoted"><span class="quoted">‹repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">∈</span> MDP.valid_cfg›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">≠</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="skolem">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span>abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> abst_rept_id<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹action <span class="skolem">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> S"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> 𝒮›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abss_S calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> unbounded <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cval_add_non_id<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> K <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="main">(</span>repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> K <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cfg_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_pmf <span class="main">(</span>rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> same_loc K_cfg_same_loc_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span>"</span></span><span class="main">]</span>
        <span class="quoted"><span class="quoted">‹repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">_</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absc_repcs_id fst_abss K_cfg_rept<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?U</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span> <span class="main">≤</span> <span class="var">?r</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">=</span> action <span class="main">(</span>repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>action <span class="main">(</span>repcs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">}</span> <span class="main">≤</span> <span class="var">?r</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">cfg'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">cfg'</span> <span class="main">∈</span> R_G.valid_cfg <span class="main">∧</span> <span class="bound">cfg</span> <span class="main">=</span> repcs <span class="bound">s</span> <span class="bound">cfg'</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="bound">cfg'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">cfg</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="free"><span class="free"><span class="free">st</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free"><span class="free">st</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> K_cfg <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cfg' l u
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"absc <span class="skolem"><span class="skolem">y</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"state <span class="skolem"><span class="skolem">y</span></span>"</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>
            K_cfg_valid_cfgD R_G.valid_cfgD R_G.valid_cfg_state_in_S absc_repcs_id cont_absc_1
            cont_repcs1 repcs_valid
            <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_absc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> MDP.MC.acc"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> MDP.MC.acc_relfunD<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> K_cfg <span class="bound">a</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="comment1">(* XXX Extract induction rule *)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> start <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> relcomppE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> step<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Suc.IH<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>MDP.MC.T <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span>HLD <span class="var">?S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MDP.MC.AE_T_reachable<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ** <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹alternating <span class="free">cfg</span>›</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternating <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_alw_ev_same_loc_iff'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">st</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> alw_ev_same2<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>MDP.MC.T <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> HLD <span class="main">(</span>state <span class="main">-`</span> snd <span class="main">-`</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">)</span> <span class="bound">ω</span> <span class="main">⟶</span>
      ev <span class="main">(</span>HLD <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">∀</span><span class="bound">cfg'</span><span class="main">∈</span>set_pmf <span class="main">(</span>K_cfg <span class="bound">cfg</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="keyword1"><span class="command">unfolding</span></span> alternating_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">cfg</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> cfg<span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> snd <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cfg'</span> <span class="main">∈</span> K_cfg <span class="bound">cfg</span><span class="main">.</span> fst <span class="main">(</span>state <span class="bound">cfg'</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>state <span class="bound">cfg</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> snd <span class="main">`</span> state <span class="main">`</span> <span class="main">(</span>MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">with</span></span> MDP.MC.AE_T_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ω</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">intro</span> alw_HLD_smap alw_disjoint_ccontr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
              S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="main">`</span> MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span>"</span></span>
              <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ω <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">ω</span>"</span></span>
              <span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> snd <span class="main">`</span> state <span class="main">`</span> <span class="main">(</span>MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MDP.MC.countable_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> AE_all_imp_countable<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> countable_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> state <span class="main">`</span> MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> calculation
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l u x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
          MDP.non_loop_tail_strong<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">snd</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> cfg l1 u1 _ cfg' l2 u2
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">u1</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MDP.cfg_onD_state Pair_inject prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> state_repcs<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MDP.cfg_onD_state prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> snd_conv state_repcs<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> state <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">u1</span>›</span></span> snd_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">-`</span> <span class="main">{</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> snd <span class="bound">y</span> <span class="main">=</span> snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> *<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">)</span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prems<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">)</span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prems<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> K_cfg_same_loc_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cfg'</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absc_repcs_id<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fst_abss fst_conv repcs_valid<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lt_1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MDP.valid_cfgD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> *** <span class="keyword1"><span class="command">unfolding</span></span> alw_holds_pred_stream_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> HLD_def <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alw_ev_same2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-cfg_on_div_repcs_strong"><span class="command">lemma</span></span> cfg_on_div_repcs_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> in_space_UNIV<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G_cfg_on_div <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"alternating <span class="free">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> cfg_on_div <span class="free">st</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?st</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"abss <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="var">?st</span>"</span></span> <span class="quoted"><span class="quoted">"state <span class="free">cfg</span> <span class="main">=</span> <span class="var">?st</span>"</span></span> <span class="quoted"><span class="quoted">"R_G_div_cfg <span class="free">cfg</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">st</span> <span class="main">∈</span> S›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="var">?st</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">st</span> <span class="main">∈</span> S›</span></span> <span class="quoted"><span class="quoted">‹alternating <span class="free">cfg</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="var">?cfg</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span>
                          <span class="main">¬</span> ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span>snd <span class="main">∘</span> state<span class="main">)</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> repcs_unbounded_AE_non_loop_end_strong<span class="main">)</span>
  <span class="comment1">― ‹Move to lower level›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="var">?cfg</span><span class="main">.</span> ℛ_div <span class="main">(</span>smap <span class="main">(</span>snd <span class="main">∘</span> state<span class="main">)</span> <span class="main">(</span>smap absc <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_G_div_cfg_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> R_G_trace_space_distr_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_distr_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"div_cfg <span class="var">?cfg</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_cfg_def <span class="keyword1"><span class="command">using</span></span> MDP.MC.AE_T_enabled<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>elim <span class="skolem">ω</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span>snd <span class="keyword1">o</span> state<span class="main">)</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> MDP.pred_stream_cfg_on<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹MDP.MC.enabled <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> S<span class="main">)</span> <span class="main">(</span>smap state <span class="skolem">ω</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">]⇩</span>ℛ <span class="main">=</span> snd <span class="main">(</span>abss <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sset <span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> * that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="skolem">x</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.pred_set<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>abss <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>snd <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span><span class="main">]⇩</span>ℛ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abss_S snd_conv surj_pair<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">[</span>snd <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">]⇩</span>ℛ<span class="main">)</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> snd <span class="main">(</span>abss <span class="main">(</span>state <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">)</span> <span class="var">?xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_def stream.pred_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> surjective_pairing<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_trans <span class="var">?xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enabled_stream_trans <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹MDP.MC.enabled <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise trans' <span class="var">?xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> <span class="quoted"><span class="quoted">‹state <span class="free">cfg</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹MDP.MC.enabled <span class="main">_</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enabled_stream_trans'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>𝒳<span class="main">.</span> real <span class="main">(</span><span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> snd <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap state <span class="skolem">ω</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ℛ_div <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_comp state_absc <span class="quoted"><span class="quoted">‹smap <span class="main">_</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="main">_</span>›</span></span> ℛ_divergent_divergent<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> MDP.valid_cfgD <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cfg_on_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Reachability-repcs_unbounded_AE_non_loop_end"><span class="command">lemma</span></span> repcs_unbounded_AE_non_loop_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="free">st</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> MDP.MC.T <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> snd <span class="bound">s</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> R_G.valid_cfgD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>state <span class="free">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">μ</span></span> <span class="main">∈</span> K <span class="bound">x</span><span class="main">.</span> <span class="bound">μ</span> <span class="main">≠</span> return_pmf <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Sup <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?K</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> lt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">∈</span> <span class="var">?K</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">μ</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="main">≠</span> return_pmf <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">μ</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="skolem">μ</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> measure_pmf.emeasure_ge_1_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf_eq_1_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span>map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="bound">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">|</span> <span class="bound">μ</span> <span class="bound">l</span> <span class="bound">u</span> <span class="bound">g</span><span class="main">.</span>
          <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> trans_of <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?K</span> <span class="skolem">x</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> K.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">g</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="bound">X</span> <span class="main">:=</span> <span class="main">0</span><span class="main">]</span><span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">`</span> trans_of <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> finite<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">μ</span><span class="main">.</span> measure_pmf <span class="bound">μ</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?K</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * finite_imp_Sup_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cfg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span> set<span class="main">)</span> cfg"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> snd <span class="skolem">s</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on <span class="main">(</span>abss <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">s</span> <span class="main">∈</span> 𝒮"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"repcs <span class="skolem">s</span> <span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G.valid_cfgI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cfg_on<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="skolem">s</span> <span class="skolem">cfg</span> <span class="main">∈</span> MDP.cfg_on <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MDP.valid_cfgD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="skolem">cfg</span> <span class="main">∈</span> 𝒦 <span class="main">(</span>abss <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_G.cfg_onD_action<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">≠</span> return_pmf <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">=</span> return_pmf <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="skolem">cfg</span> <span class="main">=</span> return_pmf <span class="main">(</span>abss <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> abst_rept_id<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹action <span class="skolem">cfg</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abst_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">s</span><span class="main">,</span> snd <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> S"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">∈</span> 𝒮›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abss <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">s</span><span class="main">,</span> <span class="main">[</span>snd <span class="skolem">s</span><span class="main">]⇩</span>ℛ<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abss_S calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rept <span class="skolem">s</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> unbounded <span class="keyword1"><span class="command">unfolding</span></span> rept_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cval_add_non_id<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> K <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"action <span class="main">(</span>repcs <span class="skolem">s</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> K <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cfg_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?K</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">≤</span> <span class="var">?r</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">=</span> action <span class="main">(</span>repcs <span class="skolem">s</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> repcs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>action <span class="main">(</span>repcs <span class="skolem">s</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">≤</span> <span class="var">?r</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> this <span class="quoted"><span class="quoted">‹rept <span class="skolem">s</span> <span class="main">(</span>action <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?K</span> <span class="skolem">s</span>›</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">cfg'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">cfg'</span> <span class="main">∈</span> R_G.valid_cfg <span class="main">∧</span> <span class="bound">cfg</span> <span class="main">=</span> repcs <span class="bound">s</span> <span class="bound">cfg'</span> <span class="main">∧</span> abss <span class="bound">s</span> <span class="main">=</span> state <span class="bound">cfg'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">cfg</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="free"><span class="free"><span class="free">st</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free"><span class="free">st</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> K_cfg <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cfg' l u
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">inst_existentials</span> <span class="quoted"><span class="quoted"><span class="quoted">"absc <span class="skolem"><span class="skolem">y</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"state <span class="skolem"><span class="skolem">y</span></span>"</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>
            K_cfg_valid_cfgD R_G.valid_cfgD R_G.valid_cfg_state_in_S absc_repcs_id cont_absc_1
            cont_repcs1 repcs_valid
            <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_absc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> MDP.MC.acc"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> MDP.MC.acc_relfunD<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> K_cfg <span class="bound">a</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="comment1">(* XXX Extract induction rule *)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> start <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> relcomppE step Suc.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_everywhere <span class="main">(</span>MDP.MC.T <span class="main">(</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span>HLD <span class="var">?S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MDP.MC.AE_T_reachable<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ** <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HLD_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ω</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> snd <span class="bound">s</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> state <span class="main">`</span> <span class="main">(</span>MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">with</span></span> MDP.MC.AE_T_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ω</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> alw_HLD_smap alw_disjoint_ccontr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
              S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"state <span class="main">`</span> MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ω <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"smap state <span class="skolem">ω</span>"</span></span>
              <span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HLD_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> 𝒳<span class="main">.</span> snd <span class="bound">s</span> <span class="bound">c</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> state <span class="main">`</span> <span class="main">(</span>MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">ω</span> <span class="keyword1">in</span> <span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span>alw <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> shd <span class="bound">xs</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap state <span class="bound">ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MDP.MC.countable_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"repcs <span class="free">st</span> <span class="free">cfg</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> AE_all_imp_countable<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> countable_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"state <span class="main">`</span> MDP.MC.acc <span class="main">``</span> <span class="main">{</span>repcs <span class="free">st</span> <span class="free">cfg</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> calculation
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l u x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MDP.non_loop_tail'<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"state <span class="skolem">x</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>state <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> cfg cfg' l' u'
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MDP.cfg_onD_state state_repcs<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> state <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹state <span class="skolem">x</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>1<span class="main">,</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> **<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lt_1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R_G.valid_cfg_state_in_S R_G.valid_cfgD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> MDP.valid_cfgD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹repcs <span class="free">st</span> <span class="free">cfg</span> <span class="main">∈</span> valid_cfg›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> *** <span class="keyword1"><span class="command">unfolding</span></span> alw_holds_pred_stream_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> HLD_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* PTA Regions *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Result›</span></span> <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹ \label{thm:minmax} ›</span></span>

<span class="keyword1"><span class="command">context</span></span> Probabilistic_Timed_Automaton_Regions_Reachability
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="PTA_Reachability-R_G_cfg_on_valid"><span class="command">lemma</span></span> R_G_cfg_on_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> R_G_cfg_on_div s'"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def R_G.valid_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PTA_Reachability-cfg_on_valid"><span class="command">lemma</span></span> cfg_on_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> valid_cfg"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg</span> <span class="main">∈</span> cfg_on_div <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> cfg_on_div_def MDP.valid_cfg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">path_measure</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> emeasure <span class="main">(</span>MDP.T <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space MDP.St<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_G_path_measure</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> emeasure <span class="main">(</span>R_G.T <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space R_G.St<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">progressive</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> cfg_on_div <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> alternating <span class="bound">cfg</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_G_progressive</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> R_G_cfg_on_div <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">cfg</span><span class="main">.</span> alternating <span class="bound">cfg</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Summary of our results on divergent configurations:›</span></span>
<span class="keyword1" id="PTA_Reachability-absc_valid_cfg_eq"><span class="command">lemma</span></span> absc_valid_cfg_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"absc <span class="main">`</span> progressive <span class="free">s</span> <span class="main">=</span> R_G_progressive s'"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cfg_on_div_absc<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_alw_ev_same_loc_iff cfg_on_valid<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cfg
    <span class="keyword1"><span class="command">unfolding</span></span> s'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> cfg_on_div_repcs_strong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> 4 4
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def R_G_cfg_on_div_def AE_alw_ev_same_loc_iff'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R_G_cfg_on_valid absc_repcs_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
       <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main theorem:›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> Min_Max_reachability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> in_space_UNIV<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> pred_stream_iff
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="bound">cfg</span><span class="main">∈</span> progressive <span class="free">s</span><span class="main">.</span>      path_measure     <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span>  <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>  <span class="main">(</span><span class="free">s</span>  <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">cfg</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">cfg</span><span class="main">∈</span> R_G_progressive s'<span class="main">.</span> R_G_path_measure <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">cfg</span><span class="main">)</span>
 <span class="main">∧</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">cfg</span><span class="main">∈</span> progressive <span class="free">s</span><span class="main">.</span>      path_measure     <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span>  <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>  <span class="main">(</span><span class="free">s</span>  <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">cfg</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">cfg</span><span class="main">∈</span> R_G_progressive s'<span class="main">.</span> R_G_path_measure <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">cfg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SUP_eq_and_INF_eq<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> IntE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cfg</span> <span class="keyword3"><span class="command">assume</span></span> cfg_div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G_cfg_on_div s'"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> Collect alternating"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternating <span class="skolem">cfg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"repcs <span class="free">s</span> <span class="skolem">cfg</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹alternating <span class="skolem">cfg</span>›</span></span> cfg_div <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alternating <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_G_cfg_on_div_def s'_def AE_alw_ev_same_loc_iff'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cfg_div <span class="quoted"><span class="quoted">‹alternating <span class="skolem">cfg</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cfg'</span> <span class="main">∈</span> cfg_on_div <span class="free">s</span> <span class="main">∩</span> Collect alternating"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cfg_on_div_repcs_strong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>R_G.T <span class="skolem">cfg</span><span class="main">)</span>   <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space R_G.St<span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>
      <span class="main">=</span> emeasure <span class="main">(</span>MDP.T <span class="var">?cfg'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space MDP.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>   <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> cfg_div <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R_G_cfg_on_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cfg_div <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> R_G.cfg_on s'"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R_G_cfg_on_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="skolem">cfg</span> <span class="main">=</span> s'"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>
          path_measure_eq_repcs''_new<span class="main"><span class="main">[</span></span>
            <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">cfg</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> φ'_def ψ'_def<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> s'›</span></span> state_repcs
            <span class="main"><span class="main">]</span></span>
          <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?cfg'</span> <span class="main">∈</span> cfg_on_div <span class="free">s</span> <span class="main">∩</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cfg_on_valid<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> xs
        <span class="keyword1"><span class="command">using</span></span> prems s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> φ_stream<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
        <span class="keyword1"><span class="command">using</span></span> prems s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ψ_stream<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cfg</span> <span class="keyword3"><span class="command">assume</span></span> cfg_div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> cfg_on_div <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> Collect alternating"</span></span>
  <span class="keyword1"><span class="command">with</span></span> absc_valid_cfg_eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"absc <span class="skolem">cfg</span> <span class="main">∈</span> R_G_cfg_on_div s' <span class="main">∩</span> Collect alternating"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>MDP.T <span class="skolem">cfg</span><span class="main">)</span>        <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space MDP.St<span class="main">.</span> <span class="main">(</span>holds <span class="free">φ</span> <span class="keyword1">suntil</span> holds <span class="free">ψ</span><span class="main">)</span>   <span class="main">(</span><span class="free">s</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>
      <span class="main">=</span> emeasure <span class="main">(</span>R_G.T <span class="main">(</span>absc <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space R_G.St<span class="main">.</span> <span class="main">(</span>holds φ' <span class="keyword1">suntil</span> holds ψ'<span class="main">)</span> <span class="main">(</span>s' <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"absc <span class="skolem">cfg</span> <span class="main">∈</span> R_G.valid_cfg"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R_G_cfg_on_valid <span class="quoted"><span class="quoted">‹absc <span class="skolem">cfg</span> <span class="main">∈</span> R_G_cfg_on_div s' <span class="main">∩</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> cfg_div <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg</span> <span class="main">∈</span> valid_cfg"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg_on_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹absc <span class="skolem">cfg</span> <span class="main">∈</span> R_G.valid_cfg›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> <span class="var">?a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MDP.alw_S R_G.alw_S path_measure_eq_absc1_new
            <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> 𝒮<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> S<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
         <span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_abss_𝒮 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒮_abss_S <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> suntil_abss suntil_reps<span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* PTA Reachability Problem *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span>
</pre>
</div>