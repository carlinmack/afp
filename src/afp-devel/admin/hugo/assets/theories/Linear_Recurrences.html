<div id="RatFPS">
<div class="head">
<h1>Theory RatFPS</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    RatFPS.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rational formal power series›</span></span>
<span class="keyword1"><span class="command">theory</span></span> RatFPS
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial_Factorial.html">HOL-Computational_Algebra.Polynomial_Factorial</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some auxiliary›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">constant_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>zero"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">constant_term</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="RatFPS-coeff_0_mult"><span class="command">lemma</span></span> coeff_0_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="main">0</span> <span class="main">*</span> coeff <span class="free">q</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_mult<span class="main">)</span>

<span class="keyword1" id="RatFPS-coeff_0_div"><span class="command">lemma</span></span> coeff_0_div<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field poly<span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="free">q</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="main">0</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="free">q</span> <span class="main">*</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">…</span> <span class="main">0</span> <span class="main">=</span> coeff <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="free">q</span><span class="main">)</span> <span class="main">0</span> <span class="main">*</span> coeff <span class="free">q</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_0_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="RatFPS-coeff_0_add_fract_nonzero"><span class="command">lemma</span></span> coeff_0_add_fract_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>quot_of_fract <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>quot_of_fract <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>quot_of_fract <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">num</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">num</span> <span class="main">=</span> fst <span class="main">(</span>quot_of_fract <span class="free">x</span><span class="main">)</span> <span class="main">*</span> snd <span class="main">(</span>quot_of_fract <span class="free">y</span><span class="main">)</span> <span class="main">+</span> 
    snd <span class="main">(</span>quot_of_fract <span class="free">x</span><span class="main">)</span> <span class="main">*</span> fst <span class="main">(</span>quot_of_fract <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">denom</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">denom</span> <span class="main">=</span> snd <span class="main">(</span>quot_of_fract <span class="free">x</span><span class="main">)</span> <span class="main">*</span> snd <span class="main">(</span>quot_of_fract <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">num</span><span class="main">,</span> <span class="skolem">denom</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> denom_def z_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> normalize_quotE'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> d <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z_def denom_def coeff_0_mult<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>quot_of_fract <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> coeff <span class="main">(</span>snd <span class="main">(</span>normalize_quot <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_add Let_def case_prod_unfold z_def num_def denom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d coeff_0_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-coeff_0_normalize_quot_nonzero"><span class="command">lemma</span></span> coeff_0_normalize_quot_nonzero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> normalize_quotE'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> d <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_0_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">numerator</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fract <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ring_gcd<span class="main">,</span>idom_divide<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">numerator</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>quot_of_fract <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">denominator</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fract <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ring_gcd<span class="main">,</span>idom_divide<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">denominator</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>quot_of_fract <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> unit_factor_snd_quot_of_fract <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  normalize_snd_quot_of_fract <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="RatFPS-constant_term_denominator_nonzero_imp_constant_term_denominator_div_gcd_nonzero"><span class="command">lemma</span></span> constant_term_denominator_nonzero_imp_constant_term_denominator_div_gcd_nonzero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"constant_term <span class="main">(</span>denominator <span class="free">x</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="main">(</span>denominator <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"constant_term <span class="main">(</span>denominator <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that coeff_0_normalize_quot_nonzero <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> denominator <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
  normalize_quot_proj<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"denominator <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The type of rational formal power series›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="quoted">field_gcd</span> ratfps <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> poly fract<span class="main">.</span> constant_term <span class="main">(</span>denominator <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_ratfps

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted">field_gcd</span><span class="main">)</span> <span class="quoted">idom</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uminus"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_uminus case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coeff_0_add_fract_nonzero<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> diff_conv_add_uminus<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> coeff_0_add_fract_nonzero<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_uminus Let_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_mult Let_def case_prod_unfold coeff_0_mult
    constant_term_denominator_nonzero_imp_constant_term_denominator_div_gcd_nonzero<span class="main">)</span>
 
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ratfps_nth_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> poly <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ratfps_nth_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span> <span class="main">=</span> inverse <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ratfps_nth_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> 
     <span class="main">-</span> inverse <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span> <span class="main">*</span> <span class="free">ratfps_nth_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="RatFPS-ratfps_nth_aux_correct"><span class="command">lemma</span></span> ratfps_nth_aux_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"ratfps_nth_aux <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> natfun_inverse <span class="main">(</span>fps_of_poly <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ratfps_nth_aux.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ratfps_nth <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_fract <span class="bound">x</span>
         <span class="keyword1">in</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> coeff <span class="bound">a</span> <span class="bound">i</span> <span class="main">*</span> ratfps_nth_aux <span class="bound">b</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ratfps_subdegree <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> poly_subdegree <span class="main">(</span>fst <span class="main">(</span>quot_of_fract <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="RatFPS-RatFPS_parametric"><span class="command">lemma</span></span> RatFPS_parametric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> coeff <span class="bound">q</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> quot_to_fract <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> coeff <span class="bound">q</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> quot_to_fract <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
  
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="RatFPS-normalize_quot_quot_of_fract"><span class="command">lemma</span></span> normalize_quot_quot_of_fract <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"normalize_quot <span class="main">(</span>quot_of_fract <span class="free">x</span><span class="main">)</span> <span class="main">=</span> quot_of_fract <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalize_quot_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> quot_of_fract_in_normalized_fracts<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field_gcd<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> quot_of_ratfps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"quot_of_fract <span class="main">::</span> <span class="tfree">'a</span> poly fract <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> quot_to_ratfps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">y'</span><span class="main">)</span> <span class="main">=</span> normalize_quot <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> 
           <span class="keyword1">in</span>  <span class="keyword1">if</span> coeff <span class="bound">y'</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> quot_to_fract <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def quot_of_fract_quot_to_fract<span class="main">)</span>

<span class="keyword1" id="RatFPS-quot_to_ratfps_quot_of_ratfps"><span class="command">lemma</span></span> quot_to_ratfps_quot_of_ratfps <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_to_ratfps <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-coeff_0_snd_quot_of_ratfps_nonzero"><span class="command">lemma</span></span> coeff_0_snd_quot_of_ratfps_nonzero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-quot_of_ratfps_quot_to_ratfps"><span class="command">lemma</span></span> quot_of_ratfps_quot_to_ratfps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> normalized_fracts <span class="main">⟹</span> quot_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_unfold coeff_0_normalize_quot_nonzero 
                 quot_of_fract_quot_to_fract normalize_quot_id<span class="main">)</span>

<span class="keyword1" id="RatFPS-quot_of_ratfps_0"><span class="command">lemma</span></span> quot_of_ratfps_0 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp_all</span>

<span class="keyword1" id="RatFPS-quot_of_ratfps_1"><span class="command">lemma</span></span> quot_of_ratfps_1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ratfps_of_poly <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"to_fract <span class="main">::</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-ratfps_of_poly_code"><span class="command">lemma</span></span> ratfps_of_poly_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span>ratfps_of_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> zero_ratfps_code <span class="main">=</span> quot_of_ratfps_0

<span class="keyword1"><span class="command">lemmas</span></span> one_ratfps_code <span class="main">=</span> quot_of_ratfps_1
  
<span class="keyword1" id="RatFPS-uminus_ratfps_code"><span class="command">lemma</span></span> uminus_ratfps_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">-</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> quot_of_fract_uminus<span class="main">)</span>

<span class="keyword1" id="RatFPS-plus_ratfps_code"><span class="command">lemma</span></span> plus_ratfps_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span><span class="main">;</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">y</span>
      <span class="keyword1">in</span>  normalize_quot <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">d</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> quot_of_fract_add<span class="main">)</span>

<span class="keyword1" id="RatFPS-minus_ratfps_code"><span class="command">lemma</span></span> minus_ratfps_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span><span class="main">;</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">y</span>
      <span class="keyword1">in</span>  normalize_quot <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">d</span> <span class="main">-</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> quot_of_fract_diff<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ratfps_cutoff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ratfps_cutoff</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> poly_of_list <span class="main">(</span>map <span class="main">(</span>ratfps_nth <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ratfps_shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ratfps_shift</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> ratfps_of_poly <span class="main">(</span>ratfps_cutoff <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">in</span>  quot_to_ratfps <span class="main">(</span>poly_shift <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
 
<span class="keyword1" id="RatFPS-times_ratfps_code"><span class="command">lemma</span></span> times_ratfps_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span><span class="main">;</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">y</span><span class="main">;</span>
          <span class="main">(</span><span class="bound">e</span><span class="main">,</span><span class="bound">f</span><span class="main">)</span> <span class="main">=</span> normalize_quot <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span> <span class="main">=</span> normalize_quot <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span>
      <span class="keyword1">in</span>  <span class="main">(</span><span class="bound">e</span><span class="main">*</span><span class="bound">g</span><span class="main">,</span> <span class="bound">f</span><span class="main">*</span><span class="bound">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> quot_of_fract_mult<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_nth_code"><span class="command">lemma</span></span> ratfps_nth_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ratfps_nth <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span>
     <span class="keyword1">in</span>  <span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> coeff <span class="bound">a</span> <span class="bound">i</span> <span class="main">*</span> ratfps_nth_aux <span class="bound">b</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-ratfps_subdegree_code"><span class="command">lemma</span></span> ratfps_subdegree_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="free">x</span> <span class="main">=</span> poly_subdegree <span class="main">(</span>fst <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">inverse</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">inverse_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_fract <span class="bound">x</span>
       <span class="keyword1">in</span>  <span class="keyword1">if</span> coeff <span class="bound">a</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> inverse <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def quot_of_fract_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">divide_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> 
           <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> ratfps_subdegree <span class="bound">g</span><span class="main">;</span> <span class="bound">h</span> <span class="main">=</span> ratfps_shift <span class="bound">n</span> <span class="bound">g</span>
           <span class="keyword1">in</span>  ratfps_shift <span class="bound">n</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> inverse <span class="bound">h</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="RatFPS-ratfps_inverse_code"><span class="command">lemma</span></span> ratfps_inverse_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span>inverse <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="free">x</span>
      <span class="keyword1">in</span>  <span class="keyword1">if</span> coeff <span class="bound">a</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> unit_factor <span class="bound">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">div</span> <span class="bound">u</span><span class="main">,</span> <span class="bound">a</span> <span class="keyword1">div</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_unfold quot_of_fract_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted">equal</span><span class="main">)</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">equal_ratfps</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">equal_ratfps</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="RatFPS-quot_of_fract_eq_iff"><span class="command">lemma</span></span> quot_of_fract_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quot_of_fract <span class="free">x</span> <span class="main">=</span> quot_of_fract <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_quot_eq_iff<span class="main">)</span>

<span class="keyword1" id="RatFPS-equal_ratfps_code"><span class="command">lemma</span></span> equal_ratfps_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.equal <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> quot_of_ratfps <span class="free">x</span> <span class="main">=</span> quot_of_ratfps <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equal_ratfps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_of_poly_quot_normalize_quot"><span class="command">lemma</span></span> fps_of_poly_quot_normalize_quot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fst <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     fps_of_poly <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd poly<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalize_quotE'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_poly_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-fps_of_poly_quot_normalize_quot'"><span class="command">lemma</span></span> fps_of_poly_quot_normalize_quot' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fst <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="main">(</span>normalize_quot <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     fps_of_poly <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fps_of_poly_quot_normalize_quot<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> fps_of_ratfps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps <span class="main">⇒</span> <span class="tfree">'a</span> fps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fps_of_poly <span class="main">(</span>numerator <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>denominator <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_altdef"><span class="command">lemma</span></span> fps_of_ratfps_altdef<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> quot_of_ratfps <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> fps_of_poly <span class="bound">a</span> <span class="main">/</span> fps_of_poly <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_ratfps_of_poly"><span class="command">lemma</span></span> fps_of_ratfps_ratfps_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>ratfps_of_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_0"><span class="command">lemma</span></span> fps_of_ratfps_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  
<span class="keyword1" id="RatFPS-fps_of_ratfps_1"><span class="command">lemma</span></span> fps_of_ratfps_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_uminus"><span class="command">lemma</span></span> fps_of_ratfps_uminus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> fps_of_ratfps <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_uminus case_prod_unfold Let_def fps_of_poly_simps dvd_neg_div<span class="main">)</span>
  
<span class="keyword1" id="RatFPS-fps_of_ratfps_add"><span class="command">lemma</span></span> fps_of_ratfps_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="free">x</span> <span class="main">+</span> fps_of_ratfps <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_add Let_def case_prod_unfold fps_of_poly_simps<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_diff"><span class="command">lemma</span></span> fps_of_ratfps_diff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="free">x</span> <span class="main">-</span> fps_of_ratfps <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quot_of_fract_diff Let_def case_prod_unfold fps_of_poly_simps<span class="main">)</span>

<span class="keyword1" id="RatFPS-is_unit_div_div_commute"><span class="command">lemma</span></span> is_unit_div_div_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="free">b</span> <span class="main">⟹</span> is_unit <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_unit_div_mult2_eq mult.commute<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_mult"><span class="command">lemma</span></span> fps_of_ratfps_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="free">x</span> <span class="main">*</span> fps_of_ratfps <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> quot_of_fract <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> quot_of_fract <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">x'</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">y'</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> normalize_quot <span class="main">(</span>fst <span class="skolem">x'</span><span class="main">,</span> snd <span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> normalize_quot <span class="main">(</span>fst <span class="skolem">y'</span><span class="main">,</span> snd <span class="skolem">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">x'</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">y'</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">w</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_0_normalize_quot_nonzero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fst <span class="skolem">w</span> <span class="main">*</span> fst <span class="skolem">z</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">w</span> <span class="main">*</span> snd <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">w</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
          <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">z</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">*</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_div_mult2_eq fps_of_poly_mult unit_div_mult_swap unit_div_commute unit<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">x'</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> 
                    <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">y'</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">y'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unit 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w_def z_def unit_div_commute unit_div_mult_swap is_unit_div_div_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w_def z_def x'_def y'_def Let_def case_prod_unfold quot_of_fract_mult mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-div_const_unit_poly"><span class="command">lemma</span></span> div_const_unit_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="free">c</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="main">[:</span><span class="free">c</span><span class="main">:]</span> <span class="main">=</span> smult <span class="main">(</span><span class="main">1</span> <span class="keyword1">div</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_const_poly_iff unit_eq_div1<span class="main">)</span>

<span class="keyword1" id="RatFPS-normalize_field"><span class="command">lemma</span></span> normalize_field<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>normalization_semidom<span class="main">,</span>field<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_1_iff dvd_field_iff<span class="main">)</span>

<span class="keyword1" id="RatFPS-unit_factor_field"><span class="command">lemma</span></span> unit_factor_field <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>normalization_semidom<span class="main">,</span>field<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unit_factor_mult_normalize<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> normalize_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_poly_normalize_field"><span class="command">lemma</span></span> fps_of_poly_normalize_field<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>normalize <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span> normalization_semidom<span class="main">}</span> poly<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     fps_of_poly <span class="free">p</span> <span class="main">*</span> fps_const <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_poly_def div_const_unit_poly <span class="dynamic"><span class="dynamic">divide_simps</span></span> dvd_field_iff<span class="main">)</span>

<span class="keyword1" id="RatFPS-unit_factor_poly_altdef"><span class="command">lemma</span></span> unit_factor_poly_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"unit_factor <span class="free">p</span> <span class="main">=</span> monom <span class="main">(</span>unit_factor <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_factor_poly_def monom_altdef<span class="main">)</span>

<span class="keyword1" id="RatFPS-div_const_poly"><span class="command">lemma</span></span> div_const_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">div</span> <span class="main">[:</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">:]</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_eq_div1 is_unit_triv<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_inverse"><span class="command">lemma</span></span> fps_of_ratfps_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>inverse <span class="free">x</span><span class="main">)</span> <span class="main">=</span> inverse <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>lead_coeff <span class="main">(</span>fst <span class="main">(</span>quot_of_fract <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>quot_of_fract <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span>
           unit_factor <span class="main">(</span>fst <span class="main">(</span>quot_of_fract <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>quot_of_fract <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>quot_of_fract <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_factor_poly_altdef monom_0 div_const_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def case_prod_unfold fps_divide_unit fps_inverse_mult
          quot_of_fract_inverse mult_ac
          fps_of_poly_simps fps_const_inverse
          fps_of_poly_normalize_field div_smult_left <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fps_notation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="RatFPS-ratfps_nth_altdef"><span class="command">lemma</span></span> ratfps_nth_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"ratfps_nth <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> fps_of_ratfps <span class="free">x</span> <span class="main">$</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold fps_divide_unit fps_times_def fps_inverse_def 
        ratfps_nth_aux_correct Let_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_is_unit"><span class="command">lemma</span></span> fps_of_ratfps_is_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">a</span> <span class="main">$</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> ratfps_nth <span class="free">a</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_nth_0"><span class="command">lemma</span></span> ratfps_nth_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ratfps_nth <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_cases"><span class="command">lemma</span></span> fps_of_ratfps_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="main"><span class="main"><span class="main">(</span></span></span>quot_of_ratfps <span class="free"><span class="free"><span class="free">f</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">(</span></span></span>quot_of_ratfps <span class="free"><span class="free"><span class="free">f</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_altdef case_prod_unfold<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_cutoff"><span class="command">lemma</span></span> fps_of_ratfps_cutoff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>ratfps_cutoff <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_cutoff <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff ratfps_cutoff_def nth_default_def ratfps_nth_altdef<span class="main">)</span>

<span class="keyword1" id="RatFPS-subdegree_fps_of_ratfps"><span class="command">lemma</span></span> subdegree_fps_of_ratfps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subdegree <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> ratfps_subdegree <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold subdegree_div_unit poly_subdegree_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_subdegree_altdef"><span class="command">lemma</span></span> ratfps_subdegree_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="free">x</span> <span class="main">=</span> subdegree <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subdegree_fps_of_ratfps <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">fps_of_ratfps</span>
  
<span class="keyword1" id="RatFPS-fps_zero_code"><span class="command">lemma</span></span> fps_zero_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> fps_of_ratfps <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1" id="RatFPS-fps_one_code"><span class="command">lemma</span></span> fps_one_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> fps_of_ratfps <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_const_code"><span class="command">lemma</span></span> fps_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_const <span class="free">c</span> <span class="main">=</span> fps_of_poly <span class="main">[:</span><span class="free">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_of_poly_code"><span class="command">lemma</span></span> fps_of_poly_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span>ratfps_of_poly <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1" id="RatFPS-fps_X_code"><span class="command">lemma</span></span> fps_X_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_X <span class="main">=</span> fps_of_ratfps <span class="main">(</span>ratfps_of_poly <span class="main">[:</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_nth_code"><span class="command">lemma</span></span> fps_nth_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> ratfps_nth <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>
     
<span class="keyword1" id="RatFPS-fps_uminus_code"><span class="command">lemma</span></span> fps_uminus_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> fps_of_ratfps <span class="free">x</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1" id="RatFPS-fps_add_code"><span class="command">lemma</span></span> fps_add_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="main">+</span> fps_of_ratfps <span class="free">y</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_diff_code"><span class="command">lemma</span></span> fps_diff_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="main">-</span> fps_of_ratfps <span class="free">y</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_mult_code"><span class="command">lemma</span></span> fps_mult_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="main">*</span> fps_of_ratfps <span class="free">y</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_inverse_code"><span class="command">lemma</span></span> fps_inverse_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span>inverse <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_cutoff_code"><span class="command">lemma</span></span> fps_cutoff_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_cutoff <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>ratfps_cutoff <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> subdegree_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> subdegree_fps_of_ratfps

 
<span class="keyword1" id="RatFPS-fractrel_normalize_quot"><span class="command">lemma</span></span> fractrel_normalize_quot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fractrel <span class="free">p</span> <span class="free">p</span> <span class="main">⟹</span> fractrel <span class="free">q</span> <span class="free">q</span> <span class="main">⟹</span> 
     fractrel <span class="main">(</span>normalize_quot <span class="free">p</span><span class="main">)</span> <span class="main">(</span>normalize_quot <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> fractrel <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fractrel_normalize_quot_left fractrel_normalize_quot_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  
<span class="keyword1" id="RatFPS-fps_of_ratfps_eq_iff"><span class="command">lemma</span></span> fps_of_ratfps_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">p</span> <span class="main">=</span> fps_of_ratfps <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly fract"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fractrel <span class="main">(</span>quot_of_fract <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>quot_of_fract <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fractrel_normalize_quot<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>        
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold unit_eq_div1 unit_eq_div2 unit_div_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="RatFPS-fps_of_ratfps_eq_zero_iff"><span class="command">lemma</span></span> fps_of_ratfps_eq_zero_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_0 <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_0 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="RatFPS-unit_factor_snd_quot_of_ratfps"><span class="command">lemma</span></span> unit_factor_snd_quot_of_ratfps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span>snd <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  
<span class="keyword1" id="RatFPS-poly_shift_times_monom_le"><span class="command">lemma</span></span> poly_shift_times_monom_le<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> poly_shift <span class="free">n</span> <span class="main">(</span>monom <span class="free">c</span> <span class="free">m</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> monom <span class="free">c</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_monom_mult coeff_poly_shift<span class="main">)</span>

<span class="keyword1" id="RatFPS-poly_shift_times_monom_ge"><span class="command">lemma</span></span> poly_shift_times_monom_ge<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> poly_shift <span class="free">n</span> <span class="main">(</span>monom <span class="free">c</span> <span class="free">m</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>poly_shift <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_monom_mult coeff_poly_shift<span class="main">)</span>
  
<span class="keyword1" id="RatFPS-poly_shift_times_monom"><span class="command">lemma</span></span> poly_shift_times_monom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"poly_shift <span class="free">n</span> <span class="main">(</span>monom <span class="free">c</span> <span class="free">n</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> smult <span class="free">c</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_monom_mult coeff_poly_shift<span class="main">)</span>

<span class="keyword1" id="RatFPS-monom_times_poly_shift"><span class="command">lemma</span></span> monom_times_poly_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"poly_subdegree <span class="free">p</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"monom <span class="free">c</span> <span class="free">n</span> <span class="main">*</span> poly_shift <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="var">?lhs</span> <span class="skolem">k</span> <span class="main">=</span> coeff <span class="var">?rhs</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> poly_subdegree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_less_poly_subdegree<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_monom_mult coeff_poly_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_monom_mult coeff_poly_shift<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-monom_times_poly_shift'"><span class="command">lemma</span></span> monom_times_poly_shift'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"poly_subdegree <span class="free">p</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"monom <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1<span class="main">)</span> <span class="free">n</span> <span class="main">*</span> poly_shift <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_times_poly_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="RatFPS-subdegree_minus_cutoff_ge"><span class="command">lemma</span></span> subdegree_minus_cutoff_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-</span> fps_cutoff <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ab_group_add fps<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subdegree <span class="main">(</span><span class="free">f</span> <span class="main">-</span> fps_cutoff <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subdegree_geI<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="RatFPS-fps_shift_times_X_power''"><span class="command">lemma</span></span> fps_shift_times_X_power''<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_shift <span class="free">n</span> <span class="main">(</span>fps_X <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 fps<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fps_shift_times_fps_X_power'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  
<span class="keyword1" id="RatFPS-ratfps_shift_code"><span class="command">lemma</span></span> 
  ratfps_shift_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
       <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> quot_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> ratfps_of_poly <span class="main">(</span>ratfps_cutoff <span class="free">n</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">in</span>  <span class="main">(</span>poly_shift <span class="free">n</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs1</span> <span class="main">=</span> <span class="var">?rhs1</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  fps_of_ratfps_shift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_shift <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>   
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">include</span></span> fps_notation
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> ratfps_of_poly <span class="main">(</span>ratfps_cutoff <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> quot_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> coprime_quot_of_fract<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> fst_y<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">=</span> monom <span class="main">1</span> <span class="free">n</span> <span class="main">*</span> poly_shift <span class="free">n</span> <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_subdegree <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> subdegree <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_subdegree_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subdegree <span class="main">(</span>fps_of_poly <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subdegree_div_unit<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subdegree <span class="main">…</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subdegree_geI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monom_times_poly_shift' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>poly_shift <span class="free">n</span> <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
          quot_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span>poly_shift <span class="free">n</span> <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_shift_def Let_def case_prod_unfold x'_def y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> coprime <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>poly_shift <span class="free">n</span> <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">,</span> snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> quot_of_ratfps_quot_to_ratfps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def normalized_fracts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def y_def x'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs1</span> <span class="main">=</span> <span class="var">?rhs1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_shift <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_shift <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_altdef y_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_shift <span class="free">n</span> <span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fst_y<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> fps_of_poly_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> unit_div_mult_swap <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def fps_of_poly_monom fps_shift_times_X_power'' eq 
          fps_of_ratfps_altdef case_prod_unfold Let_def x'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_shift <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-fps_shift_code"><span class="command">lemma</span></span> fps_shift_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_shift <span class="free">n</span> <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span>ratfps_shift <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">equal</span><span class="main">)</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">equal_fps</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fps <span class="main">⇒</span> <span class="tfree">'a</span> fps <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">equal_fps</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="RatFPS-equal_fps_code"><span class="command">lemma</span></span> equal_fps_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.equal <span class="main">(</span>fps_of_ratfps <span class="free">f</span><span class="main">)</span> <span class="main">(</span>fps_of_ratfps <span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_divide"><span class="command">lemma</span></span> fps_of_ratfps_divide <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">f</span> <span class="keyword1">div</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="free">f</span> <span class="keyword1">div</span> fps_of_ratfps <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fps_divide_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def ratfps_subdegree_altdef<span class="main">)</span>
           
<span class="keyword1" id="RatFPS-ratfps_eqI"><span class="command">lemma</span></span> ratfps_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="main">=</span> fps_of_ratfps <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">algebraic_semidom</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ratfps_eqI<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_dvd"><span class="command">lemma</span></span> fps_of_ratfps_dvd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="keyword1">dvd</span> fps_of_ratfps <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="keyword1">dvd</span> fps_of_ratfps <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">y</span> <span class="main">=</span> fps_of_ratfps <span class="free">y</span> <span class="keyword1">div</span> fps_of_ratfps <span class="free">x</span> <span class="main">*</span> fps_of_ratfps <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">y</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fps_of_ratfps_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvdI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">y</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="free"><span class="free"><span class="free">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">y</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> fps_of_ratfps <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span> <span class="keyword1">dvd</span> fps_of_ratfps <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_divide<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-is_unit_ratfps_iff"><span class="command">lemma</span></span> is_unit_ratfps_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_unit <span class="free">x</span> <span class="main">⟷</span> ratfps_nth <span class="free">x</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="free">x</span> <span class="main">*</span> fps_of_ratfps <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvdI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fps_of_ratfps <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ratfps_nth <span class="free">x</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ratfps_nth <span class="free">x</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">x</span> <span class="main">*</span> inverse <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef inverse_mult_eq_1'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> inverse <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fps_of_ratfps_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvdI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"inverse <span class="free"><span class="free"><span class="free">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">normalization_semidom</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unit_factor_ratfps</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"unit_factor <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ratfps_shift <span class="main">(</span>ratfps_subdegree <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">normalize_ratfps</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"normalize <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>ratfps_subdegree <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_unit_factor"><span class="command">lemma</span></span> fps_of_ratfps_unit_factor <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>unit_factor <span class="free">x</span><span class="main">)</span> <span class="main">=</span> unit_factor <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_factor_ratfps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_normalize"><span class="command">lemma</span></span> fps_of_ratfps_normalize <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>normalize <span class="free">x</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_ratfps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_poly_monom ratfps_subdegree_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unit_factor <span class="skolem">x</span> <span class="main">*</span> normalize <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> ratfps<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
       <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> ratfps<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_code 
          <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_eq_iff fps_unit_factor_def fps_normalize_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>unit_factor <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">a</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> unit_factor <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ratfps_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> fps_of_ratfps_unit_factor fps_of_ratfps_mult<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> unit_factor_mult_unit_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_nth_altdef<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unit_factor <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_is_unit<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">normalization_semidom_multiplicative</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> unit_factor <span class="skolem">a</span> <span class="main">*</span> unit_factor <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> unit_factor_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fps_of_ratfps <span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fps_of_ratfps <span class="skolem"><span class="skolem"><span class="skolem">b</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">semidom_modulo</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">modulo_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="keyword1">else</span> 
           <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> ratfps_subdegree <span class="bound">g</span><span class="main">;</span> <span class="bound">h</span> <span class="main">=</span> ratfps_shift <span class="bound">n</span> <span class="bound">g</span>
           <span class="keyword1">in</span>  ratfps_of_poly <span class="main">(</span>ratfps_cutoff <span class="bound">n</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> inverse <span class="bound">h</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">h</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_mod"><span class="command">lemma</span></span> fps_of_ratfps_mod <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span><span class="free">f</span> <span class="keyword1">mod</span> <span class="free">g</span> <span class="main">::</span> <span class="tfree">'a</span> ratfps<span class="main">)</span> <span class="main">=</span> fps_of_ratfps <span class="free">f</span> <span class="keyword1">mod</span> fps_of_ratfps <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fps_mod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def ratfps_subdegree_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ratfps_eqI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">euclidean_ring</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">euclidean_size_ratfps</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">euclidean_size_ratfps</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="numeral">2</span> <span class="main">^</span> ratfps_subdegree <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="RatFPS-fps_of_ratfps_euclidean_size"><span class="command">lemma</span></span> fps_of_ratfps_euclidean_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"euclidean_size <span class="free">x</span> <span class="main">=</span> euclidean_size <span class="main">(</span>fps_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euclidean_size_ratfps_def fps_euclidean_size_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"euclidean_size <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> ratfps<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"euclidean_size <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">&lt;</span> euclidean_size <span class="skolem">b</span>"</span></span>
       <span class="quoted"><span class="quoted">"euclidean_size <span class="skolem">a</span> <span class="main">≤</span> euclidean_size <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ratfps"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_size_less size_mult_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">euclidean_ring_cancel</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ratfps_eqI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="RatFPS-quot_of_ratfps_eq_iff"><span class="command">lemma</span></span> quot_of_ratfps_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="free">x</span> <span class="main">=</span> quot_of_ratfps <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-ratfps_eq_0_code"><span class="command">lemma</span></span> ratfps_eq_0_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> fst <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>fst <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_quot_of_fract<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>snd <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>quot_of_ratfps <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_unit_factor <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> div_unit_factor<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"quot_of_ratfps <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eq_iff normalize_idem_imp_is_unit_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> quot_of_ratfps <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> quot_of_ratfps_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="RatFPS-fps_dvd_code"><span class="command">lemma</span></span> fps_dvd_code <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>field_gcd fps<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> subdegree <span class="free">x</span> <span class="main">≤</span> subdegree <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fps_dvd_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="RatFPS-ratfps_dvd_code"><span class="command">lemma</span></span> ratfps_dvd_code <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> ratfps_subdegree <span class="free">x</span> <span class="main">≤</span> ratfps_subdegree <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fps_dvd_code <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="free">y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">normalization_euclidean_semiring</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"field_gcd"</span></span><span class="main">)</span> <span class="quoted">euclidean_ring_gcd</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">gcd_ratfps</span></span> <span class="main">=</span> <span class="main">(</span>Euclidean_Algorithm.gcd <span class="main">::</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">lcm_ratfps</span></span> <span class="main">=</span> <span class="main">(</span>Euclidean_Algorithm.lcm <span class="main">::</span> <span class="tfree">'a</span> ratfps <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">Gcd_ratfps</span></span> <span class="main">=</span> <span class="main">(</span>Euclidean_Algorithm.Gcd <span class="main">::</span> <span class="tfree">'a</span> ratfps set <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">Lcm_ratfps</span></span> <span class="main">=</span> <span class="main">(</span>Euclidean_Algorithm.Lcm<span class="main">::</span> <span class="tfree">'a</span> ratfps set <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_ratfps_def lcm_ratfps_def Gcd_ratfps_def Lcm_ratfps_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="RatFPS-ratfps_eq_0_iff"><span class="command">lemma</span></span> ratfps_eq_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> fps_of_ratfps <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fps_of_ratfps_eq_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fps_of_ratfps_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RatFPS-ratfps_of_poly_eq_0_iff"><span class="command">lemma</span></span> ratfps_of_poly_eq_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"ratfps_of_poly <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_eq_0_iff<span class="main">)</span>



<span class="keyword1" id="RatFPS-ratfps_gcd"><span class="command">lemma</span></span> ratfps_gcd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>min <span class="main">(</span>ratfps_subdegree <span class="free">f</span><span class="main">)</span> <span class="main">(</span>ratfps_subdegree <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcdI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef ratfps_dvd_code subdegree_fps_of_poly
         ratfps_of_poly_eq_0_iff normalize_ratfps_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_gcd_altdef"><span class="command">lemma</span></span> ratfps_gcd_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps<span class="main">)</span> <span class="free">g</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>ratfps_subdegree <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>ratfps_subdegree <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
     ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>min <span class="main">(</span>ratfps_subdegree <span class="free">f</span><span class="main">)</span> <span class="main">(</span>ratfps_subdegree <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_gcd normalize_ratfps_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_lcm"><span class="command">lemma</span></span> ratfps_lcm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lcm <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>max <span class="main">(</span>ratfps_subdegree <span class="free">f</span><span class="main">)</span> <span class="main">(</span>ratfps_subdegree <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lcmI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef ratfps_dvd_code subdegree_fps_of_poly
         ratfps_of_poly_eq_0_iff normalize_ratfps_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_lcm_altdef"><span class="command">lemma</span></span> ratfps_lcm_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"lcm <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps<span class="main">)</span> <span class="free">g</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> 
     ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>max <span class="main">(</span>ratfps_subdegree <span class="free">f</span><span class="main">)</span> <span class="main">(</span>ratfps_subdegree <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_lcm<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_Gcd"><span class="command">lemma</span></span> ratfps_Gcd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Gcd <span class="free">A</span> <span class="main">=</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> GcdI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code ratfps_of_poly_eq_0_iff ratfps_subdegree_altdef
                          subdegree_fps_of_poly <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cINF_lower<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> d assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="skolem">d</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cINF_greatest<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> d assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code ratfps_subdegree_altdef subdegree_fps_of_poly<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef subdegree_fps_of_poly normalize_ratfps_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_Gcd_altdef"><span class="command">lemma</span></span> ratfps_Gcd_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"Gcd <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps set<span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ratfps_Gcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="RatFPS-ratfps_Lcm"><span class="command">lemma</span></span> ratfps_Lcm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>ratfps_subdegree<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Lcm <span class="free">A</span> <span class="main">=</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> LcmI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>ratfps_subdegree <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">dvd</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code ratfps_of_poly_eq_0_iff subdegree_fps_of_poly 
                          ratfps_subdegree_altdef <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cSUP_upper<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="skolem">d</span> <span class="main">≥</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cSUP_least<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code ratfps_of_poly_eq_0_iff 
          ratfps_subdegree_altdef subdegree_fps_of_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_subdegree_altdef subdegree_fps_of_poly normalize_ratfps_def<span class="main">)</span>

<span class="keyword1" id="RatFPS-ratfps_Lcm_altdef"><span class="command">lemma</span></span> ratfps_Lcm_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Lcm <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd ratfps set<span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∨</span> <span class="main">¬</span>bdd_above <span class="main">(</span>ratfps_subdegree<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span>
      <span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> ratfps_of_poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> ratfps_subdegree <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>ratfps_subdegree<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bdd_above <span class="main">(</span>ratfps_subdegree<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Lcm <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Lcm <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> unbounded <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="main">(</span>Lcm <span class="free">A</span><span class="main">)</span> <span class="main">&lt;</span> ratfps_subdegree <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bdd_above_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Lcm <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ratfps_subdegree <span class="skolem">f</span> <span class="main">≤</span> ratfps_subdegree <span class="main">(</span>Lcm <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dvd_Lcm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_dvd_code<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> unbounded <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ratfps_Lcm Lcm_eq_0_I<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_quot_to_ratfps"><span class="command">lemma</span></span> fps_of_ratfps_quot_to_ratfps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="free">y</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> fps_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="free">x</span> <span class="main">/</span> fps_of_poly <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> fst <span class="main">(</span>normalize_quot <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> snd <span class="main">(</span>normalize_quot <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"normalize_quot <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x'_def y'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> normalize_quotE<span class="main">[</span><span class="operator">OF</span> nz<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> d <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> this <span class="main">[</span><span class="operator">folded</span> x'_def y'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> quot_of_fract <span class="main">(</span><span class="keyword1">if</span> coeff <span class="skolem">y'</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> quot_to_fract <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> fps_of_poly <span class="bound">a</span> <span class="main">/</span> fps_of_poly <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="skolem">x</span> <span class="main">/</span> fps_of_poly <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d eq 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold fps_of_poly_simps quot_of_fract_quot_to_fract 
                                Let_def coeff_0_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_unfold x'_def y'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_quot_to_ratfps_code_post1"><span class="command">lemma</span></span> fps_of_ratfps_quot_to_ratfps_code_post1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span><span class="free">x</span><span class="main">,</span>pCons <span class="main">1</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="free">x</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>pCons <span class="main">1</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span><span class="free">x</span><span class="main">,</span>pCons <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="free">x</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>pCons <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_quot_to_ratfps<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_of_ratfps_quot_to_ratfps_code_post2"><span class="command">lemma</span></span> fps_of_ratfps_quot_to_ratfps_code_post2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span><span class="free">x'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span> poly<span class="main">,</span>pCons <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     fps_of_poly <span class="free">x'</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>pCons <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>quot_to_ratfps <span class="main">(</span><span class="free">x'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span> poly<span class="main">,</span>pCons <span class="main">(</span><span class="main">-</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     fps_of_poly <span class="free">x'</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>pCons <span class="main">(</span><span class="main">-</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_ratfps_quot_to_ratfps<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fps_of_ratfps_quot_to_ratfps_code_post <span class="main">[</span><span class="operator">code_post</span><span class="main">]</span> <span class="main">=</span>
  fps_of_ratfps_quot_to_ratfps_code_post1
  fps_of_ratfps_quot_to_ratfps_code_post2

<span class="keyword1" id="RatFPS-fps_dehorner"><span class="command">lemma</span></span> fps_dehorner<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 fps"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="free">e</span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">::</span> ring_1 fps"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> fps_X <span class="main">=</span> <span class="free">b</span> <span class="main">*</span> fps_X <span class="main">+</span> <span class="free">c</span> <span class="main">*</span> fps_X"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">*</span> fps_X <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> fps_X <span class="main">^</span> <span class="numeral">2</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> fps_X <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> fps_X <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> fps_X <span class="main">^</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> fps_X <span class="main">*</span> fps_X <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> fps_X <span class="main">^</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> fps_X<span class="main">^</span><span class="free">m</span> <span class="main">*</span> fps_X<span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> fps_X<span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">+</span> <span class="main">-</span> <span class="free">e</span> <span class="main">=</span> <span class="free">d</span> <span class="main">-</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">+</span> <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span> <span class="main">+</span> <span class="free">e</span> <span class="main">-</span> <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="free">e</span><span class="main">)</span> <span class="main">*</span> fps_X <span class="main">=</span> <span class="free">d</span> <span class="main">*</span> fps_X <span class="main">-</span> <span class="free">e</span> <span class="main">*</span> fps_X"</span></span> <span class="quoted"><span class="quoted">"fps_X <span class="main">*</span> fps_X <span class="main">=</span> fps_X<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"fps_X <span class="main">*</span> fps_X<span class="main">^</span><span class="free">m</span> <span class="main">=</span> fps_X<span class="main">^</span><span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fps_X<span class="main">^</span><span class="free">m</span> <span class="main">*</span> fps_X <span class="main">=</span> fps_X<span class="main">^</span>Suc <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"fps_X<span class="main">^</span><span class="free">m</span> <span class="main">*</span> fps_X<span class="main">^</span><span class="free">n</span> <span class="main">=</span> fps_X<span class="main">^</span><span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square power_add power_commutes<span class="main">)</span>

<span class="keyword1" id="RatFPS-fps_divide_1"><span class="command">lemma</span></span> fps_divide_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field fps<span class="main">)</span> <span class="main">/</span> <span class="main">1</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> fps_of_poly_code_post <span class="main">[</span><span class="operator">code_post</span><span class="main">]</span> <span class="main">=</span> 
  fps_of_poly_simps fps_const_0_eq_0 fps_const_1_eq_1 numeral_fps_const <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  fps_const_neg <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fps_const_divide <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  fps_dehorner Suc_numeral arith_simps fps_divide_1

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> term_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">valterm_ratfps</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span><span class="main">{</span>field_gcd<span class="main">,</span> typerep<span class="main">}</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> Code_Evaluation.term<span class="main">)</span> <span class="main">⇒</span> 
     <span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> Code_Evaluation.term<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> ratfps <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> Code_Evaluation.term<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valterm_ratfps</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> 
    Code_Evaluation.valtermify <span class="main">(/)</span> <span class="main">{⋅}</span> 
      <span class="main">(</span>Code_Evaluation.valtermify ratfps_of_poly <span class="main">{⋅}</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">{⋅}</span> 
      <span class="main">(</span>Code_Evaluation.valtermify ratfps_of_poly <span class="main">{⋅}</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>field_gcd<span class="main">,</span>random<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">random</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> state_combinator_syntax term_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"Quickcheck_Random.random <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> 
     Quickcheck_Random.random <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∘→</span> <span class="main">(</span><span class="main">λ</span><span class="bound">num</span><span class="main">::</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> term<span class="main">)</span><span class="main">.</span> 
       Quickcheck_Random.random <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∘→</span> <span class="main">(</span><span class="main">λ</span><span class="bound">denom</span><span class="main">::</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> term<span class="main">)</span><span class="main">.</span> 
         Pair <span class="main">(</span><span class="keyword1">let</span> <span class="bound">denom</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">denom</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Code_Evaluation.valtermify <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">denom</span><span class="main">)</span>
               <span class="keyword1">in</span>  valterm_ratfps <span class="bound">num</span> <span class="bound">denom</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>field<span class="main">,</span>factorial_ring_gcd<span class="main">,</span>exhaustive<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">exhaustive</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">exhaustive_ratfps</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> 
     Quickcheck_Exhaustive.exhaustive <span class="main">(</span><span class="main">λ</span><span class="bound">num</span><span class="main">.</span> 
       Quickcheck_Exhaustive.exhaustive <span class="main">(</span><span class="main">λ</span><span class="bound">denom</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
         <span class="keyword1">let</span> <span class="bound">denom</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">denom</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">denom</span>
         <span class="keyword1">in</span>  ratfps_of_poly <span class="bound">num</span> <span class="main">/</span> ratfps_of_poly <span class="bound">denom</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ratfps <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>field_gcd<span class="main">,</span>full_exhaustive<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">full_exhaustive</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">full_exhaustive_ratfps</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> 
     Quickcheck_Exhaustive.full_exhaustive <span class="main">(</span><span class="main">λ</span><span class="bound">num</span><span class="main">::</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> term<span class="main">)</span><span class="main">.</span>
       Quickcheck_Exhaustive.full_exhaustive <span class="main">(</span><span class="main">λ</span><span class="bound">denom</span><span class="main">::</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span>unit <span class="main">⇒</span> term<span class="main">)</span><span class="main">.</span>
         <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">denom</span> <span class="main">=</span> <span class="keyword1">if</span> fst <span class="bound">denom</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Code_Evaluation.valtermify <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">denom</span>
            <span class="keyword1">in</span>  valterm_ratfps <span class="bound">num</span> <span class="bound">denom</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">quickcheck_generator</span></span> fps constructors<span class="main">:</span> <span class="quoted">fps_of_ratfps</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pochhammer_Polynomials">
<div class="head">
<h1>Theory Pochhammer_Polynomials</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Pochhammer_Polynomials.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Falling factorial as a polynomial›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pochhammer_Polynomials
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Stirling.html">HOL-Combinatorics.Stirling</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial.html">HOL-Computational_Algebra.Polynomial</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pochhammer_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">}</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pochhammer_poly</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Poly <span class="main">[</span>of_nat <span class="main">(</span>stirling <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Pochhammer_Polynomials-pochhammer_poly_code"><span class="command">lemma</span></span> pochhammer_poly_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>pochhammer_poly <span class="free">n</span><span class="main">)</span> <span class="main">=</span> map of_nat <span class="main">(</span>stirling_row <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_def stirling_row_def Let_def<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-coeff_pochhammer_poly"><span class="command">lemma</span></span> coeff_pochhammer_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pochhammer_poly <span class="free">n</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-degree_pochhammer_poly"><span class="command">lemma</span></span> degree_pochhammer_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>pochhammer_poly <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_eq_length_coeffs pochhammer_poly_def<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-pochhammer_poly_0"><span class="command">lemma</span></span> pochhammer_poly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pochhammer_poly <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_def<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-pochhammer_poly_Suc"><span class="command">lemma</span></span> pochhammer_poly_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"pochhammer_poly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">[:</span>of_nat <span class="free">n</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">*</span> pochhammer_poly <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_pochhammer_poly coeff_pCons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-pochhammer_poly_altdef"><span class="command">lemma</span></span> pochhammer_poly_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"pochhammer_poly <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">[:</span>of_nat <span class="bound">i</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_Suc<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-eval_pochhammer_poly"><span class="command">lemma</span></span> eval_pochhammer_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pochhammer_poly <span class="free">n</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> pochhammer <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_altdef poly_prod add_ac lessThan_Suc_atMost 
                               pochhammer_Suc_prod atLeast0AtMost<span class="main">)</span>

<span class="keyword1" id="Pochhammer_Polynomials-pochhammer_poly_Suc'"><span class="command">lemma</span></span> pochhammer_poly_Suc'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pochhammer_poly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> pCons <span class="main">0</span> <span class="main">(</span>pcompose <span class="main">(</span>pochhammer_poly <span class="free">n</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_poly_altdef prod.lessThan_Suc_shift pcompose_prod pcompose_pCons add_ac <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> prod.lessThan_Suc<span class="main">)</span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Linear_Recurrences_Misc">
<div class="head">
<h1>Theory Linear_Recurrences_Misc</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Linear_Recurrences_Misc.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous material required for linear recurrences›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Linear_Recurrences_Misc
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial_Factorial.html">HOL-Computational_Algebra.Polynomial_Factorial</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zip_with</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zip_with</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">zip_with</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_with</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Linear_Recurrences_Misc-length_zip_with"><span class="command">lemma</span></span> length_zip_with <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_altdef"><span class="command">lemma</span></span> zip_with_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>
  
<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_nth"><span class="command">lemma</span></span> zip_with_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟹</span> zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_with_altdef<span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Misc-take_zip_with"><span class="command">lemma</span></span> take_zip_with<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span>zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip_with <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-drop_zip_with"><span class="command">lemma</span></span> drop_zip_with<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="main">(</span>zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip_with <span class="free">f</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-map_zip_with"><span class="command">lemma</span></span> map_zip_with<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>zip_with <span class="free">g</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_map"><span class="command">lemma</span></span> zip_with_map<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_map_left"><span class="command">lemma</span></span> zip_with_map_left<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zip_with_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_map_right"><span class="command">lemma</span></span> zip_with_map_right<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with <span class="free">f</span> <span class="free">xs</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zip_with_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_swap"><span class="command">lemma</span></span> zip_with_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> zip_with <span class="free">f</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-set_zip_with"><span class="command">lemma</span></span> set_zip_with<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_Pair"><span class="command">lemma</span></span> zip_with_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"zip_with Pair <span class="main">(</span><span class="free">xs</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"Pair <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_with_altdef'"><span class="command">lemma</span></span> zip_with_altdef'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"zip_with <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> i <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_with.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_upt_Suc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Misc-zip_altdef"><span class="command">lemma</span></span> zip_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"zip <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">,</span> <span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> i <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_with_Pair <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zip_with_altdef'<span class="main">)</span>



<span class="keyword1" id="Linear_Recurrences_Misc-card_poly_roots_bound"><span class="command">lemma</span></span> card_poly_roots_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_ring_1<span class="main">,</span>ring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> Suc <span class="main">(</span>degree <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> q<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> degree_mult_eq<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> poly_roots_finite <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_le_m1<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> deg <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">…</span> <span class="main">=</span> degree <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deg<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Recurrences_Misc-poly_eqI_degree"><span class="command">lemma</span></span> poly_eqI_degree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">,</span> ring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> poly <span class="free">q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">&gt;</span> degree <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">&gt;</span> degree <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_diff_le_max<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono poly_roots_finite<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="main">≥</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_poly_roots_bound<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Linear_Recurrences_Misc-poly_root_order_induct"><span class="command">lemma</span></span> poly_root_order_induct <span class="main">[</span><span class="operator">case_names</span> 0 no_roots root<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="skolem">x</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> order_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_root<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">=</span> order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">+</span> order <span class="skolem">x</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> q<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> order_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_power_n_n<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">+</span> degree <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> q<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> degree_mult_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_power_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> order_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> order_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_root<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Recurrences_Misc-complex_poly_decompose"><span class="command">lemma</span></span> complex_poly_decompose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"smult <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">z</span></span><span class="main">|</span>poly <span class="free">p</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">z</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">z</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> poly_root_order_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>no_roots <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>constant <span class="main">(</span>poly <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> constant_degree<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fundamental_theorem_of_algebra <span class="keyword2"><span class="keyword">and</span></span> no_roots <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degree_eq_zeroE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>root <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> root <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>lead_coeff <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">z</span></span><span class="main">|</span>poly <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">z</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">z</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="skolem">x</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> 
          smult <span class="main">(</span>lead_coeff <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="bound">z</span><span class="main">∈</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">z</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">z</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> prod.insert<span class="main">)</span> 
       <span class="main">(</span><span class="operator">insert</span> root<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> poly_roots_finite <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac lead_coeff_mult lead_coeff_power<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_power_n_n order_0I<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">z</span><span class="main">∈</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">z</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">z</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∏</span><span class="bound">z</span><span class="main">∈</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">z</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">z</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> root <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">y</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_0I<span class="main">)</span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> root <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> root.IH
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="Linear_Recurrences_Misc-normalize_field"><span class="command">lemma</span></span> normalize_field<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>normalization_semidom<span class="main">,</span>field<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_1_iff dvd_field_iff<span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Misc-unit_factor_field"><span class="command">lemma</span></span> unit_factor_field <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unit_factor <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>normalization_semidom<span class="main">,</span>field<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unit_factor_mult_normalize<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> normalize_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Misc-coprime_linear_poly"><span class="command">lemma</span></span> coprime_linear_poly<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coprime <span class="main">[:</span><span class="free">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">[:</span><span class="free">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">=</span> gcd <span class="main">(</span><span class="main">[:</span><span class="free">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">-</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcd_diff1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="free">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">-</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">=</span> <span class="main">[:</span><span class="free">c</span><span class="main">-</span><span class="free">c'</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">…</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">=</span> normalize <span class="main">[:</span><span class="free">c</span><span class="main">-</span><span class="free">c'</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gcd_proj1_if_dvd<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_poly_dvd_iff dvd_field_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_poly_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">[:</span><span class="free">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">[:</span><span class="free">c'</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_eq_1_imp_coprime<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Recurrences_Misc-coprime_linear_poly'"><span class="command">lemma</span></span> coprime_linear_poly'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="free">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coprime <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c</span><span class="main">:]</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c</span><span class="main">:]</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span> <span class="main">=</span> gcd <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c</span><span class="main">:]</span> <span class="keyword1">mod</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eucl_rel_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="free">c</span><span class="main">:]</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="free">c'</span><span class="main">:]</span> <span class="main">(</span><span class="main">[:</span><span class="free">c</span><span class="main">/</span><span class="free">c'</span><span class="main">:]</span><span class="main">,</span> <span class="main">[:</span><span class="main">1</span><span class="main">-</span><span class="free">c</span><span class="main">/</span><span class="free">c'</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eucl_rel_poly_iff one_pCons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c</span><span class="main">:]</span> <span class="keyword1">mod</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span> <span class="main">=</span> <span class="main">[:</span><span class="main">1</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="free">c'</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mod_poly_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">…</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="free">c'</span><span class="main">:]</span> <span class="main">=</span> normalize <span class="main">(</span><span class="main">[:</span><span class="main">1</span> <span class="main">-</span> <span class="free">c</span> <span class="main">/</span> <span class="free">c'</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gcd_proj1_if_dvd<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_poly_dvd_iff dvd_field_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_poly_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcd_eq_1_imp_coprime<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Partial_Fraction_Decomposition">
<div class="head">
<h1>Theory Partial_Fraction_Decomposition</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Partial_Fraction_Decomposition.thy
  Author:   Manuel Eberl &lt;eberlm@in.tum.de&gt;
  
  Partial fraction decomposition on Euclidean rings, i.e. decomposing a quotient into a 
  sum of quotients where each denominator is a power of an irreducible element. (and possibly 
  one summand that is an entire element)
  The most interesting setting is when the Euclidean ring is a polynomial ring.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partial Fraction Decomposition›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Partial_Fraction_Decomposition
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial_Factorial.html">HOL-Computational_Algebra.Polynomial_Factorial</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
  <a href="#Linear_Recurrences_Misc">Linear_Recurrences_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Decomposition on general Euclidean rings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consider elements $x, y_1, \ldots, y_n$ of a ring $R$, where the $y_i$ are pairwise coprime.
  A \emph{Partial Fraction Decomposition} of these elements (or rather the formal quotient 
  $x / (y_1 \ldots y_n)$ that they represent) is a finite sum of summands of the form 
  $a / y_i ^ k$. Obviously, the sum can be arranged such that there is at most one summand 
  with denominator $y_i ^ n$ for any combination of $i$ and $n$; in particular, there is at 
  most one summand with denominator 1.
  
  We can decompose the summands further by performing division with remainder until in all 
  quotients, the numerator's Euclidean size is less than that of the denominator.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function performs the first step of the above process: it takes the values 
  $x$ and $y_1,\ldots, y_n$ and returns the numerators of the summands in the decomposition. 
  (the denominators are simply the $y_i$ from the input)
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">decompose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> euclidean_ring_gcd<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">case</span> bezout_coefficients <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">b</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">decompose</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-decompose_rec"><span class="command">lemma</span></span> decompose_rec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> decompose <span class="free">x</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">case</span> bezout_coefficients <span class="free">y</span> <span class="main">(</span>prod_list <span class="free">ys</span><span class="main">)</span> <span class="keyword1">of</span> 
        <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">b</span><span class="main">*</span><span class="free">x</span><span class="main">)</span> <span class="main">#</span> decompose <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="free">x</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-length_decompose"><span class="command">lemma</span></span> length_decompose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decompose.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> bezout_coefficients <span class="skolem">y</span> <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bezout_coefficients <span class="skolem">y</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">*</span> prod_list <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">[</span><span class="operator">OF</span> ab<span class="main">]</span> ab<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">decompose'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> euclidean_ring_gcd<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">case</span> bezout_coefficients <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">b</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">decompose'</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decompose_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ab_semigroup_mult<span class="main">,</span>monoid_mult<span class="main">}</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose_aux</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decompose_aux</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">#</span> <span class="free">decompose_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-decompose_code"><span class="command">lemma</span></span> decompose_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"decompose <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> decompose' <span class="free">x</span> <span class="free">ys</span> <span class="main">(</span>tl <span class="main">(</span>rev <span class="main">(</span>decompose_aux <span class="main">1</span> <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decompose.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"decompose_aux <span class="skolem">acc</span> <span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> prod_list <span class="bound">x</span> <span class="main">*</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">(</span>prefixes <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">acc</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">acc</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>bezout_coefficients <span class="skolem">y1</span> <span class="main">(</span><span class="skolem">y2</span> <span class="main">*</span> prod_list <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="quoted"><span class="quoted">"snd <span class="main">(</span>bezout_coefficients <span class="skolem">y1</span> <span class="main">(</span><span class="skolem">y2</span> <span class="main">*</span> prod_list <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold rev_map prefixes_conv_suffixes o_def mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next function performs the second step: Given a quotient of the form $x / y^n$, it 
  returns a list of $x_0, \ldots, x_n$ such that $x / y^n = x_0 / y^n + \ldots + x_{n-1} / y + x_n$
  and all $x_i$ have a Euclidean size less than that of $y$.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">normalise_decomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> semiring_modulo<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normalise_decomp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">normalise_decomp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">case</span> <span class="free">normalise_decomp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
       <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-length_normalise_decomp"><span class="command">lemma</span></span> length_normalise_decomp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>normalise_decomp <span class="free">x</span> <span class="free">y</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> normalise_decomp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

       

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following constant implements the full process of partial fraction decomposition: 
  The input is a quotient $x / (y_1 ^ {k_1} \ldots y_n ^ {k_n})$ and the output is a sum of 
  an entire element and terms of the form $a / y_i ^ k$ where $a$ has a Euclidean size less 
  than $y_i$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partial_fraction_decomposition</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> euclidean_ring_gcd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partial_fraction_decomposition</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">!</span> <span class="bound">i</span>
                <span class="keyword1">in</span>  normalise_decomp <span class="main">(</span>decompose <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">.</span> 
                  i <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">]</span><span class="main">]</span>
      <span class="keyword1">in</span>  <span class="main">(</span>sum_list <span class="main">(</span>map fst <span class="bound">zs</span><span class="main">)</span><span class="main">,</span> map snd <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      
<span class="keyword1" id="Partial_Fraction_Decomposition-length_pfd1"><span class="command">lemma</span></span> length_pfd1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-length_pfd2"><span class="command">lemma</span></span> length_pfd2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟹</span> length <span class="main">(</span>snd <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-size_normalise_decomp"><span class="command">lemma</span></span> size_normalise_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>normalise_decomp <span class="free">x</span> <span class="free">y</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> euclidean_size <span class="free">a</span> <span class="main">&lt;</span> euclidean_size <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> normalise_decomp.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def mod_size_less<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-size_partial_fraction_decomposition"><span class="command">lemma</span></span> size_partial_fraction_decomposition<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>partial_fraction_decomposition <span class="free">y</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
    <span class="main">⟹</span> euclidean_size <span class="free">x</span> <span class="main">&lt;</span> euclidean_size <span class="main">(</span>fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def Let_def case_prod_unfold
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalise_decomp.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> size_normalise_decomp<span class="main">)</span>  


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A homomorphism $\varphi$ from a Euclidean ring $R$ into another ring $S$ with a notion of 
  division. We will show that for any $x,y\in R$ such that $\phi(y)$ is a unit, we can perform 
  partial fraction decomposition on the quotient $\varphi(x) / \varphi(y)$.
  
  The obvious choice for $S$ is the fraction field of $R$, but other choices may also make sense: 
  If, for example, $R$ is a ring of polynomials $K[X]$, then one could let $S = K$ and $\varphi$ 
  the evaluation homomorphism. Or one could let $S = K[[X]]$ (the ring of formal power series) and 
  $\varphi$ the canonical homomorphism from polynomials to formal power series.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pfd_homomorphism <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> euclidean_ring_gcd<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> euclidean_semiring_cancel<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> lift_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">lift</span> <span class="free">a</span> <span class="main">+</span> <span class="free">lift</span> <span class="free">b</span>"</span></span>                   
<span class="keyword2"><span class="keyword">assumes</span></span> lift_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">lift</span> <span class="free">a</span> <span class="main">*</span> <span class="free">lift</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> lift_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> lift_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-lift_power"><span class="command">lemma</span></span> lift_power<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">lift</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_mult<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">from_decomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_decomp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-decompose"><span class="command">lemma</span></span> decompose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"pairwise coprime <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> is_unit <span class="main">(</span><span class="free">lift</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">ys</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             <span class="free">lift</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pairwise_insert <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_list_coprime_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cons.prems <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span><span class="free">lift</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">ys</span><span class="main">.</span> is_unit <span class="main">(</span><span class="free">lift</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> unit'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span><span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="skolem">y</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"bezout_coefficients <span class="skolem">y</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bezout_coefficients <span class="skolem">y</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹pairwise coprime <span class="main">(</span>set <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span>  coprime<span class="main">:</span><span class="quoted"><span class="quoted">"pairwise coprime <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pairwise_subset<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span>decompose <span class="skolem">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="free">lift</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">lift</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons.hyps cons.prems coprime <span class="keyword1"><span class="command">unfolding</span></span> length_Cons atLeast0LessThan <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atLeast_Suc_lessThan<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.shift_bounds_Suc_ivl<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan decompose_rec st cons.IH lift_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lift</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">lift</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                <span class="free">lift</span> <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             <span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lift</span> <span class="skolem">y</span> <span class="main">*</span> <span class="main">(</span><span class="free">lift</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
             <span class="free">lift</span> <span class="skolem">y</span> <span class="main">*</span> <span class="main">(</span><span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lift</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_mult <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="skolem">ys</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms unit 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_mult lift_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span>decompose <span class="skolem">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="free">lift</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">*</span> prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unit_eq_div2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_mult lift_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">*</span> prod_list <span class="skolem">ys</span> <span class="main">=</span> gcd <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bezout_coefficients_fst_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> st gcd.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-normalise_decomp"><span class="command">lemma</span></span> normalise_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span><span class="free">lift</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≡</span> snd <span class="main">(</span>normalise_decomp <span class="free">x</span> <span class="free">y</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>fst <span class="main">(</span>normalise_decomp <span class="free">x</span> <span class="free">y</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> from_decomp <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="free">y</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">lift</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="free">y</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> xs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> normalise_decomp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span><span class="free">lift</span> <span class="skolem">y</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_power_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"normalise_decomp <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"normalise_decomp <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>fst <span class="main">(</span>normalise_decomp <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> from_decomp <span class="main">(</span>snd <span class="main">(</span>normalise_decomp <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="free">lift</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> from_decomp <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> from_decomp <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atLeast0LessThan<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.atLeast_Suc_lessThan<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.shift_bounds_Suc_ivl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab atLeast0LessThan <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> from_decomp <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="free">lift</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> unit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">+</span> from_decomp <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">lift</span> <span class="skolem">y</span> <span class="main">=</span> 
      <span class="main">(</span><span class="free">lift</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">*</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?B</span> <span class="keyword1">div</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> lift_add lift_mult
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> div_add<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> from_decomp_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dvd_div_mult2_eq 
        unit_div_mult_swap dvd_div_mult2_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> unit_imp_dvd<span class="main"><span class="main">]</span></span> is_unit_mult_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">…</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> dvd_div_eq_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> unit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?B</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">lift</span> <span class="skolem">y</span> <span class="main">^</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_unit_div_mult2_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> div_mult_mod_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
     
<span class="keyword1" id="Partial_Fraction_Decomposition-lift_prod_list"><span class="command">lemma</span></span> lift_prod_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="free">lift</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_mult<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-lift_sum"><span class="command">lemma</span></span> lift_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>sum <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_add<span class="main">)</span>
  
<span class="keyword1" id="Partial_Fraction_Decomposition-partial_fraction_decomposition"><span class="command">lemma</span></span> partial_fraction_decomposition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="free">ys</span> <span class="main">::</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">ys</span> <span class="main">⟹</span> is_unit <span class="main">(</span><span class="free">lift</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise coprime <span class="main">(</span>set <span class="free">ys'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partial_fraction_decomposition <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">ys</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> 
                       from_decomp <span class="main">(</span><span class="free">zs</span><span class="main">!</span><span class="bound">i</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             <span class="free">lift</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="free">ys'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span>prod_list <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lift</span> <span class="main">(</span><span class="free">ys'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> decompose <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_prod_list prod_list_zero_iff lift_power lift_mult o_def n_def 
        is_unit_mult_iff is_unit_power_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">lift</span> <span class="main">(</span>fst <span class="main">(</span>normalise_decomp <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> from_decomp <span class="main">(</span><span class="free">zs</span><span class="main">!</span><span class="bound">i</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">+</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum.distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span><span class="free">ys'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">lift</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys'_def n_def lift_power lift_mult <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">…</span> <span class="main">=</span> 
      <span class="free">lift</span> <span class="main">(</span>fst <span class="main">(</span>normalise_decomp <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> from_decomp <span class="main">(</span>snd <span class="main">(</span>normalise_decomp <span class="main">(</span>decompose <span class="free">x</span> <span class="free">ys'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>
             <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> normalise_decomp <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def unit<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">.</span> from_decomp <span class="main">(</span><span class="free">zs</span><span class="main">!</span><span class="skolem">i</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def case_prod_unfold Let_def o_def n_def
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> normalise_decomp.simps<span class="main">)</span>
     <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="free">lift</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def o_def sum_list_sum_nth atLeast0LessThan
                   case_prod_unfold Let_def lift_sum n_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_fraction_decomposition_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specific results for polynomials›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divmod_field_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divmod_field_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Partial_Fraction_Decomposition-divmod_field_poly_code"><span class="command">lemma</span></span> divmod_field_poly_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"divmod_field_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">cg</span> <span class="main">=</span> coeffs <span class="free">q</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">cg</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">cf</span> <span class="main">=</span> coeffs <span class="free">p</span><span class="main">;</span> <span class="bound">ilc</span> <span class="main">=</span> inverse <span class="main">(</span>last <span class="bound">cg</span><span class="main">)</span><span class="main">;</span>
                <span class="bound">ch</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(*)</span> <span class="bound">ilc</span><span class="main">)</span> <span class="bound">cg</span><span class="main">;</span>
                <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span>
                  divmod_poly_one_main_list <span class="main">[]</span> <span class="main">(</span>rev <span class="bound">cf</span><span class="main">)</span> <span class="main">(</span>rev <span class="bound">ch</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">1</span> <span class="main">+</span> length <span class="bound">cf</span> <span class="main">-</span> length <span class="bound">cg</span><span class="main">)</span>
            <span class="keyword1">in</span> <span class="main">(</span>poly_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">(*)</span> <span class="bound">ilc</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">,</span> poly_of_list <span class="main">(</span>rev <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divmod_field_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_via_divmod_list<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalise_decomp_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field_gcd poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">normalise_decomp_poly</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">::</span> <span class="main">_</span> poly<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> normalise_decomp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-normalise_decomp_poly_code"><span class="command">lemma</span></span> normalise_decomp_poly_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalise_decomp_poly <span class="free">x</span> <span class="free">y</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"normalise_decomp_poly <span class="free">x</span> <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> divmod_field_poly <span class="free">x</span> <span class="free">y</span><span class="main">;</span>
         <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">rs</span><span class="main">)</span> <span class="main">=</span> normalise_decomp_poly <span class="bound">x'</span> <span class="free">y</span> <span class="free">n</span>
     <span class="keyword1">in</span>  <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">r</span> <span class="main">#</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divmod_field_poly_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_pfd_simple</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">poly_pfd_simple</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">i</span>
                <span class="keyword1">in</span>  normalise_decomp_poly <span class="main">(</span>decompose <span class="free"><span class="bound"><span class="entity">x</span></span></span> 
                      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> 
                i <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">]</span><span class="main">]</span>
      <span class="keyword1">in</span>  <span class="main">(</span>sum_list <span class="main">(</span>map fst <span class="bound">zs</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      
<span class="keyword1" id="Partial_Fraction_Decomposition-poly_pfd_simple_code"><span class="command">lemma</span></span> poly_pfd_simple_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"poly_pfd_simple <span class="free">x</span> <span class="free">cs</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span>
       <span class="keyword1">let</span> <span class="bound">zs</span> <span class="main">=</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">decomp</span><span class="main">.</span> normalise_decomp_poly <span class="bound">decomp</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>
                  <span class="free">cs</span> <span class="main">(</span>decompose <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">in</span>  <span class="main">(</span>sum_list <span class="main">(</span>map fst <span class="bound">zs</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> poly_pfd_simple_def zip_with_altdef'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_unfold<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-fst_poly_pfd_simple"><span class="command">lemma</span></span> fst_poly_pfd_simple<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>poly_pfd_simple <span class="free">x</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> 
      fst <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def partial_fraction_decomposition_def o_def
             case_prod_unfold Let_def sum_list_sum_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

<span class="keyword1" id="Partial_Fraction_Decomposition-const_polyI"><span class="command">lemma</span></span> const_polyI<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">[:</span>coeff <span class="free">p</span> <span class="main">0</span><span class="main">:]</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> degree_eq_zeroE<span class="main">)</span> <span class="operator">simp_all</span>
  
<span class="keyword1" id="Partial_Fraction_Decomposition-snd_poly_pfd_simple"><span class="command">lemma</span></span> snd_poly_pfd_simple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">[:</span><span class="bound">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd<span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="free">x</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>snd <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>poly_pfd_simple <span class="free">x</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>snd <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map <span class="var">?f</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def partial_fraction_decomposition_def o_def
               case_prod_unfold Let_def sum_list_sum_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">[:</span><span class="bound">c</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?f</span> <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong refl const_polyI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> snd <span class="main">(</span>partial_fraction_decomposition <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euclidean_size <span class="skolem">y</span> <span class="main">&lt;</span> euclidean_size <span class="main">(</span>fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> size_partial_fraction_decomposition<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euclidean_size <span class="skolem">y</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def euclidean_size_poly_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pCons_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> euclidean_size_poly_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Partial_Fraction_Decomposition-poly_pfd_simple"><span class="command">lemma</span></span> poly_pfd_simple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partial_fraction_decomposition <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span>fst <span class="main">(</span>poly_pfd_simple <span class="free">x</span> <span class="free">cs</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">[:</span><span class="bound">c</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="free">x</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_poly_pfd_simple snd_poly_pfd_simple<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Factorizations">
<div class="head">
<h1>Theory Factorizations</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Factorizations.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Factorizations of polynomials›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Factorizations
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="#Linear_Recurrences_Misc">Linear_Recurrences_Misc</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial_Factorial.html">HOL-Computational_Algebra.Polynomial_Factorial</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We view a factorisation of a polynomial as a pair consisting of the leading coefficient
  and a list of roots with multiplicities. This gives us a factorization into factors of
  the form $(X - c) ^ {n+1}$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_factorization</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_factorization</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">cs</span><span class="main">)</span><span class="main">.</span> Polynomial.smult <span class="bound">a</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="bound">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An alternative way to factorise is as a pair of the leading coefficient and
  factors of the form $(1 - cX) ^ {n+1}$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_alt_factorization</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_alt_factorization</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">cs</span><span class="main">)</span><span class="main">.</span> Polynomial.smult <span class="bound">a</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="bound">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_factorization_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_factorization_of</span> <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     <span class="main">(</span>interp_factorization <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_alt_factorization_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_alt_factorization_of</span> <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     <span class="main">(</span>interp_alt_factorization <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     distinct <span class="main">(</span>map fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">fctrs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Regular and alternative factorisations are related by reflecting the polynomial.
›</span></span>
<span class="keyword1" id="Factorizations-interp_factorization_reflect"><span class="command">lemma</span></span> interp_factorization_reflect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom<span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>interp_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span> interp_alt_factorization <span class="free">fctrs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>interp_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span>
          Polynomial.smult <span class="main">(</span>fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">←</span>snd <span class="free">fctrs</span><span class="main">.</span> reflect_poly <span class="main">[:</span><span class="main">-</span> fst <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def interp_alt_factorization_def case_prod_unfold
             reflect_poly_smult reflect_poly_prod_list reflect_poly_power o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> reflect_poly <span class="main">[:</span><span class="main">-</span> fst <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span>
               map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> fst <span class="bound">x</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> list.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> reflect_poly_pCons<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Polynomial.smult <span class="main">(</span>fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="main">…</span><span class="main">)</span> <span class="main">=</span> interp_alt_factorization <span class="free">fctrs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_alt_factorization_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorizations-interp_alt_factorization_reflect"><span class="command">lemma</span></span> interp_alt_factorization_reflect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom<span class="main">)</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>interp_alt_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span> interp_factorization <span class="free">fctrs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>interp_alt_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span>
          Polynomial.smult <span class="main">(</span>fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">←</span>snd <span class="free">fctrs</span><span class="main">.</span> reflect_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> fst <span class="bound">x</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def interp_alt_factorization_def case_prod_unfold
             reflect_poly_smult reflect_poly_prod_list reflect_poly_power o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> reflect_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> fst <span class="bound">x</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span>
               map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> fst <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> list.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="skolem">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">c</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflect_poly_pCons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Polynomial.smult <span class="main">(</span>fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="main">…</span><span class="main">)</span> <span class="main">=</span> interp_factorization <span class="free">fctrs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Factorizations-coeff_0_interp_factorization"><span class="command">lemma</span></span> coeff_0_interp_factorization<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>interp_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom<span class="main">)</span> <span class="main">⟷</span>
     fst <span class="free">fctrs</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_factorization_def case_prod_unfold coeff_0_prod_list o_def
                  coeff_0_power prod_list_zero_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>

<span class="keyword1" id="Factorizations-reflect_factorization"><span class="command">lemma</span></span> reflect_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="free">fctrs</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="free">fctrs</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_factorization_reflect is_factorization_of_def
                    is_alt_factorization_of_def coeff_0_interp_factorization<span class="main">)</span>

<span class="keyword1" id="Factorizations-reflect_factorization'"><span class="command">lemma</span></span> reflect_factorization'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="free">fctrs</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_factorization_of <span class="free">fctrs</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_alt_factorization_reflect is_factorization_of_def
                    is_alt_factorization_of_def coeff_0_interp_factorization<span class="main">)</span>

<span class="keyword1" id="Factorizations-zero_in_factorization_iff"><span class="command">lemma</span></span> zero_in_factorization_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="free">fctrs</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom<span class="main">)</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">fctrs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_factorization_of_def interp_factorization_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> interp_factorization <span class="free">fctrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">…</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>snd <span class="free">fctrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def case_prod_unfold coeff_0_prod_list
                        prod_list_zero_iff o_def coeff_0_power<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_factorization <span class="free">fctrs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_factorization <span class="free">fctrs</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span>
                 fst <span class="free">fctrs</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span>snd <span class="free">fctrs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span>snd <span class="free">fctrs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">c</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_list_zero_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorizations-poly_prod_list"><span class="command">lemma</span></span> poly_prod_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="free">ps</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Factorizations-is_factorization_of_roots"><span class="command">lemma</span></span> is_factorization_of_roots<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">fctrs</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_factorization_of_def interp_factorization_def o_def
        case_prod_unfold prod_list_zero_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid_mult<span class="main">)</span> prod_list_prod_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod.lessThan_Suc_shift <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> prod.lessThan_Suc<span class="main">)</span>

<span class="keyword1" id="Factorizations-order_prod"><span class="command">lemma</span></span> order_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> coprime <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> order <span class="free">c</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>prod <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> order <span class="free">c</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">*</span> prod <span class="free">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> order <span class="free">c</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> order <span class="free">c</span> <span class="main">(</span>prod <span class="free">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert.prems <span class="keyword2"><span class="keyword">and</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>prod <span class="free">f</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> order <span class="free">c</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert.prems <span class="keyword2"><span class="keyword">and</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> insert.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorizations-is_factorization_of_order"><span class="command">lemma</span></span> is_factorization_of_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">fctrs</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fctrs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="free">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_factorization_of_def interp_factorization_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> interp_factorization <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">fctrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_factorization_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">…</span> <span class="main">=</span> order <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="free">fctrs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">c</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> interp_factorization_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="free">fctrs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">c</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="free">fctrs</span><span class="main">}</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span>fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_list_prod_nth case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">…</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">&lt;</span>length <span class="free">fctrs</span><span class="main">.</span> order <span class="free">c</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span> fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order_prod<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">fctrs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span> fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power_eq_0_iff<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">fctrs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">fctrs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq <span class="main">[</span><span class="operator">OF</span> distinct<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="main">[:</span><span class="main">-</span> fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">[:</span><span class="main">-</span> fst <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="main">(</span><span class="free">fctrs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> coprime_power_left_iff coprime_power_right_iff<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_linear_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">←</span><span class="free">fctrs</span><span class="main">.</span> order <span class="free">c</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="bound">c'</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_sum_nth case_prod_unfold atLeast0LessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">←</span><span class="free">fctrs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="keyword1">then</span> Suc <span class="bound">n'</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_power_n_n order_0I <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">fctrs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">fctrs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_list_distinct_conv_sum_set<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For complex polynomials, a factorisation in the above sense always exists.
›</span></span>
<span class="keyword1" id="Factorizations-complex_factorization_exists"><span class="command">lemma</span></span> complex_factorization_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">fctrs</span><span class="main">.</span> is_factorization_of <span class="bound">fctrs</span> <span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">[]</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_factorization_of_def interp_factorization_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_distinct_list poly_roots_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interp_factorization <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> order <span class="bound">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
          smult <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>order <span class="bound">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interp_factorization_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>order <span class="bound">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">x</span></span><span class="main">|</span>poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>order <span class="bound">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">x</span></span><span class="main">|</span>poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="bound">x</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> order_root<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>order <span class="skolem">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> order <span class="skolem">x</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> complex_poly_decompose<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="main">(</span>lead_coeff <span class="free">p</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> order <span class="bound">x</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_factorization_of_def o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By reflecting the polynomial, this means that for complex polynomials with non-zero
  constant coefficient, the alternative factorisation also exists.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> complex_alt_factorization_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">fctrs</span><span class="main">.</span> is_alt_factorization_of <span class="bound">fctrs</span> <span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> complex_factorization_exists <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reflect_poly <span class="free">p</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fctrs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="skolem">fctrs</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="skolem">fctrs</span> <span class="main">(</span>reflect_poly <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reflect_factorization<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rational_FPS_Solver">
<div class="head">
<h1>Theory Rational_FPS_Solver</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Rational_FPS_Solver.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Solver for rational formal power series›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rational_FPS_Solver
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="#Pochhammer_Polynomials">Pochhammer_Polynomials</a>
  <a href="#Partial_Fraction_Decomposition">Partial_Fraction_Decomposition</a>
  <a href="#Factorizations">Factorizations</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Field_as_Ring.html">HOL-Computational_Algebra.Field_as_Ring</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can determine the $k$-th coefficient of an FPS of the form $d/(1-cX)^n$, which is
  an important step in solving linear recurrences. The $k$-th coefficient of such an FPS is always
  of the form $p(k) c^k$ where $p$ is the following polynomial:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inverse_irred_power_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_char_0 <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inverse_irred_power_poly</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
       Poly <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Rational_FPS_Solver-one_minus_const_fps_X_neg_power''"><span class="command">lemma</span></span> one_minus_const_fps_X_neg_power''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_char_0"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fps_const <span class="free">d</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_char_0<span class="main">)</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
           Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> poly <span class="main">(</span>inverse_irred_power_poly <span class="free">d</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">include</span></span> fps_notation
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pcompose <span class="main">(</span>pochhammer_poly <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> fps_const <span class="free">d</span> <span class="main">*</span> inverse <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_divide_unit<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
                 Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> one_minus_const_fps_X_neg_power' n<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_const <span class="free">d</span> <span class="main">*</span> <span class="main">…</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span>  <span class="main">=</span> <span class="free">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span><span class="main">^</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> binomial_symmetric<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>pochhammer <span class="main">(</span>of_nat <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_gbinomial gbinomial_pochhammer' of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> poly <span class="var">?p</span> <span class="main">(</span>of_nat <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_inverse eval_pochhammer_poly poly_pcompose add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pCons <span class="main">0</span> <span class="main">(</span>pcompose <span class="main">(</span>pochhammer_poly <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">:]</span><span class="main">)</span> <span class="main">=</span> pochhammer_poly <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pochhammer_poly_Suc' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pCons <span class="main">0</span> <span class="main">(</span>Poly <span class="main">[</span>of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">n</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pochhammer_poly_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff nth_default_def coeff_pCons
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pcompose <span class="main">(</span>pochhammer_poly <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">:]</span> <span class="main">=</span>
                      Poly <span class="main">[</span>of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">n</span><span class="main">]</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="free">d</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Poly <span class="main">[</span>of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">n</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
               inverse_irred_power_poly <span class="free">d</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_eq_iff inverse_irred_power_poly_def nth_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">…</span> <span class="main">(</span>of_nat <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Solver-inverse_irred_power_poly_code"><span class="command">lemma</span></span> inverse_irred_power_poly_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>inverse_irred_power_poly <span class="free">d</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">d</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">in</span>  <span class="main">[</span><span class="bound">e</span> <span class="main">*</span> of_nat <span class="bound">x</span><span class="main">.</span> x <span class="main">←</span> tl <span class="main">(</span>stirling_row <span class="free">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">d</span> <span class="main">/</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>inverse_irred_power_poly <span class="free">d</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
                     <span class="main">[</span><span class="skolem">e</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inverse_irred_power_poly_def Let_def divide_inverse mult_ac last_map
                   stirling_row_def map_tl <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tl_upt e_def no_trailing_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">e</span> <span class="main">*</span> of_nat <span class="bound">x</span><span class="main">.</span> x <span class="main">←</span> tl <span class="main">(</span>stirling_row <span class="free">n</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stirling_row_def map_tl <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> o_def tl_upt
                  map_Suc_upt <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def e_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inverse_irred_power_poly_def<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Solver-solve_rat_fps_aux"><span class="command">lemma</span></span> solve_rat_fps_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span> poly"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> azs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> poly_pfd_simple <span class="free">p</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="free">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
           Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> coeff <span class="free">a</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> poly <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span>
                   <span class="main">(</span>inverse_irred_power_poly <span class="main">(</span><span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pfd_homomorphism <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">::</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> fps"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fps_of_poly_add fps_of_poly_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> distinct <span class="keyword1"><span class="command">have</span></span> distinct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="skolem">b1</span> <span class="main">=</span> <span class="skolem">b2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b1</span> <span class="skolem">b2</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Some_eq_map_of_iff image_set in_set_zipE insert_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> map_of_Cons_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_of_SomeD nz snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword1"><span class="command">have</span></span> nz'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?g</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> in_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n1</span> <span class="main">=</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c2</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> nz <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n1</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_power_eq <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c2</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="skolem">n2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_power_eq <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> poly <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n1</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> poly <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">c2</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n2</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword1"><span class="command">have</span></span> distinct'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="var">?g</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nz' distinct <span class="keyword1"><span class="command">have</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise coprime <span class="main">(</span><span class="var">?g</span> <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pairwise_imageI coprime_linear_poly' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_key_imp_eq_value
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def n_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">zs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def Let_def case_prod_unfold <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fst <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="var">?cs'</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="var">?cs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span>
               from_decomp <span class="main">(</span>map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">[:</span><span class="bound">c</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>
                           <span class="main">(</span>fst <span class="main">(</span><span class="var">?cs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="var">?cs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="var">?cs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nz distinct' coprime
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_fraction_decomposition poly_pfd_simple<span class="main">)</span>
       <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def case_prod_unfold <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> this <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> azs <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> fps_of_poly <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> from_decomp
                  <span class="main">(</span>map <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">[:</span><span class="bound">c</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span>fst <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">:]</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?S</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> fps_const <span class="main">(</span><span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">/</span>
                      <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="main">(</span>fst <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">*</span>fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_decomp_def map_nth n_def fps_of_poly_linear' fps_of_poly_simps
                    fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_ac <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fps_const_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">.</span>
                      Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> poly <span class="main">(</span>inverse_irred_power_poly <span class="main">(</span><span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>
                          <span class="main">(</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl one_minus_const_fps_X_neg_power''<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">a</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right fps_sum_nth poly_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def case_prod_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_factored_ratfps</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span><span class="main">)</span> poly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solve_factored_ratfps</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span> <span class="keyword1">case</span> poly_pfd_simple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="bound">a</span><span class="main">,</span> zip_with <span class="main">(</span><span class="main">λ</span><span class="bound">zs</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">←</span> zip <span class="bound">zs</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="bound">n</span><span class="main">]</span><span class="main">.</span>
              inverse_irred_power_poly <span class="bound">z</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">zs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rational_FPS_Solver-length_snd_poly_pfd_simple"><span class="command">lemma</span></span> length_snd_poly_pfd_simple <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Solver-length_nth_snd_poly_pfd_simple"><span class="command">lemma</span></span> length_nth_snd_poly_pfd_simple <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">⟹</span> length <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cs</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_pfd_simple_def case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Solver-solve_factored_ratfps_roots"><span class="command">lemma</span></span> solve_factored_ratfps_roots<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>snd <span class="main">(</span>solve_factored_ratfps <span class="free">p</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map fst <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solve_factored_ratfps_def poly_pfd_simple case_prod_unfold Let_def
                    zip_with_altdef o_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interp_ratfps_solution</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interp_ratfps_solution</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">cs</span><span class="main">)</span> <span class="bound">n</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="bound">cs</span><span class="main">.</span> poly <span class="bound">q</span> <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rational_FPS_Solver-solve_factored_ratfps"><span class="command">lemma</span></span> solve_factored_ratfps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span> poly"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="free">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
           Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps <span class="free">p</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> azs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span> solve_factored_ratfps <span class="free">p</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> azs <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> fst <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solve_factored_ratfps_def Let_def case_prod_unfold<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> snd <span class="main">(</span>poly_pfd_simple <span class="free">p</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> azs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">zs'</span><span class="main">)</span> <span class="main">=</span> poly_pfd_simple <span class="free">p</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> azs <span class="keyword1"><span class="command">have</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> snd <span class="main">(</span>solve_factored_ratfps <span class="free">p</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> coeff <span class="skolem">a</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> poly <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span>
                 inverse_irred_power_poly <span class="main">(</span><span class="skolem">zs'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solve_rat_fps_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> distinct azs' nz<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> azs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> interp_ratfps_solution_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a zs solve_factored_ratfps_def Let_def case_prod_unfold zip_altdef
                   zip_with_altdef' sum_list_sum_nth atLeast0LessThan zs'_def lessThan_Suc_atMost
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fps_ext sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_factored_ratfps'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solve_factored_ratfps'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">cs</span><span class="main">)</span><span class="main">.</span> solve_factored_ratfps <span class="main">(</span>smult <span class="main">(</span>inverse <span class="bound">a</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">cs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rational_FPS_Solver-solve_factored_ratfps'"><span class="command">lemma</span></span> solve_factored_ratfps'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="free">fctrs</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="free">fctrs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> interp_alt_factorization <span class="free">fctrs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">fctrs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> q<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_alt_factorization_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> q
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>interp_alt_factorization <span class="free">fctrs</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interp_alt_factorization_def case_prod_unfold coeff_0_prod_list
                   o_def coeff_0_power prod_list_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fctrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fctrs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fctrs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"solve_factored_ratfps' <span class="free">p</span> <span class="free">fctrs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def interp_alt_factorization_def fctrs<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>smult <span class="skolem">a</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          fps_of_poly <span class="free">p</span> <span class="main">/</span> <span class="main">(</span>fps_const <span class="skolem">a</span> <span class="main">*</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_poly_smult case_prod_unfold <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_const <span class="skolem">a</span> <span class="main">/</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_unit_div_mult2_eq<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_0_power coeff_0_prod_list prod_list_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_const <span class="skolem">a</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>smult <span class="main">(</span>inverse <span class="skolem">a</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_const_inverse fps_divide_unit<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="skolem">a</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def interp_alt_factorization_def fctrs <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>smult <span class="main">(</span>inverse <span class="skolem">a</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span>
                   fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">cs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="bound">c</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
               Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps <span class="main">(</span>smult <span class="main">(</span>inverse <span class="skolem">a</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> solve_factored_ratfps<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def fctrs solve_factored_ratfps'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="free">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solve_factored_ratfps'_def fctrs<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Solver-degree_Poly_eq"><span class="command">lemma</span></span> degree_Poly_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> last <span class="free">xs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"degree <span class="main">(</span>Poly <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"no_trailing <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> no_trailing_unfold<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_eq_length_coeffs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Solver-degree_Poly'"><span class="command">lemma</span></span> degree_Poly'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>Poly <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_strip_while_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_eq_length_coeffs<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Solver-degree_inverse_irred_power_poly_le"><span class="command">lemma</span></span> degree_inverse_irred_power_poly_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"degree <span class="main">(</span>inverse_irred_power_poly <span class="free">c</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inverse_irred_power_poly_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> degree_Poly'<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Solver-degree_inverse_irred_power_poly"><span class="command">lemma</span></span> degree_inverse_irred_power_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"degree <span class="main">(</span>inverse_irred_power_poly <span class="free">c</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inverse_irred_power_poly_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_Poly_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>


<span class="keyword1" id="Rational_FPS_Solver-reflect_poly_0_iff"><span class="command">lemma</span></span> reflect_poly_0_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reflect_poly <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> coeff_0_reflect_poly_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Rational_FPS_Solver-degree_sum_list_le"><span class="command">lemma</span></span> degree_sum_list_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">⟹</span> degree <span class="bound">p</span> <span class="main">≤</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> degree <span class="main">(</span>sum_list <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> degree_add_le<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ratfps_closed_form_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">≡</span> reflect_poly <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">rs</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span>
                coeff <span class="free">r</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">c</span></span> <span class="main">|</span> poly <span class="free">q'</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> poly <span class="main">(</span><span class="free">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> poly <span class="free">q'</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">rs</span> <span class="bound">z</span><span class="main">)</span> <span class="main">≤</span> order <span class="bound">z</span> <span class="free">q'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nz'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> complex_alt_factorization_exists <span class="main">[</span><span class="operator">OF</span> nz<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fctrs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fctrs<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="skolem">fctrs</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> nz <span class="keyword1"><span class="command">have</span></span> fctrs'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="skolem">fctrs</span> <span class="free">q'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reflect_factorization'<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> fst <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> snd <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> the <span class="main">∘</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> nz' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="free">q'</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_factorization_of_roots <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">fctrs</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">fctrs</span>"</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main">]</span> fctrs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">r</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that fctrs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_of_is_SomeI<span class="main">)</span>
         <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def case_prod_unfold solve_factored_ratfps'_def ts_def
                      solve_factored_ratfps_roots is_alt_factorization_of_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rs_def ts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def solve_factored_ratfps'_def case_prod_unfold solve_factored_ratfps_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span> <span class="main">=</span>
            Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> solve_factored_ratfps' <span class="main">[</span><span class="operator">OF</span> fctrs nz'<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">…</span> <span class="skolem">n</span> <span class="main">=</span> interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> coeff <span class="skolem">r</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>snd <span class="main">(</span>solve_factored_ratfps' <span class="free">p</span> <span class="skolem">fctrs</span><span class="main">)</span><span class="main">.</span>
                                   poly <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> snd <span class="bound">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> interp_ratfps_solution_def case_prod_unfold r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span><span class="skolem">ts</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> snd <span class="bound">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">]</span></span> refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rs ts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">c</span><span class="main">←</span>map snd <span class="skolem">ts</span><span class="main">.</span>
                       poly <span class="main">(</span><span class="skolem">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">ts</span> <span class="main">=</span> map fst <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> solve_factored_ratfps'_def case_prod_unfold ts_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solve_factored_ratfps_roots<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">c</span><span class="main">←</span><span class="main">…</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">c</span></span> <span class="main">|</span> poly <span class="free">q'</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots
      <span class="keyword1"><span class="command">using</span></span> fctrs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_list_distinct_conv_sum_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span>
                    coeff <span class="skolem">r</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">c</span><span class="main">∈</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> poly <span class="free">q'</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">q'</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> roots <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="skolem">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_def solve_factored_ratfps'_def case_prod_unfold solve_factored_ratfps_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="skolem">z</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rs<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>zip <span class="main">(</span>snd <span class="main">(</span>poly_pfd_simple <span class="main">(</span>smult <span class="main">(</span>inverse <span class="main">(</span>fst <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">fctrs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>
                       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">.</span>
                         inverse_irred_power_poly <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def solve_factored_ratfps'_def solve_factored_ratfps_def o_def
                     case_prod_unfold Let_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">…</span> <span class="main">≤</span> snd <span class="main">(</span>snd <span class="skolem">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> degree_sum_list_le<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> degree_inverse_irred_power_poly_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q'</span> <span class="main">=</span> Suc <span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nz' fctrs' i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_factorization_of_order<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">q'</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem"><span class="skolem">fctrs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">fctrs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">fctrs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> order <span class="skolem">z</span> <span class="free">q'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Linear_Recurrences_Common">
<div class="head">
<h1>Theory Linear_Recurrences_Common</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Linear_Recurrence_Common.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Material common to homogenous and inhomogenous linear recurrences›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Linear_Recurrences_Common
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_fps_denominator</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_fps_denominator</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> Poly <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Recurrences_Common-lr_fps_denominator_code"><span class="command">lemma</span></span> lr_fps_denominator_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_fps_denominator_def<span class="main">)</span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lr_fps_denominator'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lr_fps_denominator'</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> Poly <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1" id="Linear_Recurrences_Common-lr_fps_denominator'_code"><span class="command">lemma</span></span> lr_fps_denominator'_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>lr_fps_denominator' <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> strip_while <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_fps_denominator'_def<span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Common-lr_fps_denominator_nz"><span class="command">lemma</span></span> lr_fps_denominator_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> lr_fps_denominator <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lr_fps_denominator_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeffs_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Linear_Recurrences_Common-lr_fps_denominator'_nz"><span class="command">lemma</span></span> lr_fps_denominator'_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> lr_fps_denominator' <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lr_fps_denominator'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeffs_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Linear_Homogenous_Recurrences">
<div class="head">
<h1>Theory Linear_Homogenous_Recurrences</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Linear_Homogenous_Recurrences.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Homogenous linear recurrences›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Linear_Homogenous_Recurrences
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="#RatFPS">RatFPS</a>
  <a href="#Rational_FPS_Solver">Rational_FPS_Solver</a>
  <a href="#Linear_Recurrences_Common">Linear_Recurrences_Common</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is the numerator of the rational generating function of a 
  linear homogenous recurrence.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lhr_fps_numerator</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lhr_fps_numerator</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> 
      Poly <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="bound">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">N</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
      
<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_fps_numerator_code"><span class="command">lemma</span></span> lhr_fps_numerator_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>lhr_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> 
     strip_while <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="bound">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">N</span><span class="main">+</span><span class="free">m</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhr_fps_numerator_def Let_def<span class="main">)</span>
 
<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_fps_aux"><span class="command">lemma</span></span> lhr_fps_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≡</span> Poly <span class="main">[</span><span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">N</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≡</span> Poly <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">N</span><span class="main">+</span><span class="free">m</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="free">q</span> <span class="main">/</span> fps_of_poly <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">include</span></span> fps_notation
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> Abs_fps <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="free">c</span> <span class="free">N</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">N</span> <span class="main">+</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">N</span> <span class="main">-</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth atLeast0AtMost<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_default_def p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_default_def p_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="free">N</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth atLeast0AtMost<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def nth_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span> <span class="main">=</span> fps_of_poly <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> cN <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> fps_of_poly <span class="free">q</span> <span class="main">/</span> fps_of_poly <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unit_eq_div2<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_fps"><span class="command">lemma</span></span> lhr_fps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cN<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>lhr_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span><span class="main">)</span> <span class="main">/</span> 
              fps_of_poly <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">q</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> Poly <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">N</span> <span class="main">+</span> <span class="free">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Poly <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">N</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="skolem">p</span> <span class="main">/</span> fps_of_poly <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lhr_fps_aux<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> lhr_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def lhr_fps_numerator_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> lr_fps_denominator <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def lr_fps_denominator_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_default_def rev_nth N_def not_less cs <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Do I even need this? *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lhr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lhr</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field list<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> last <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">lhr</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">-</span>last <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> lhr.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_rec"><span class="command">lemma</span></span> lhr_rec<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">≥</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> lhr <span class="free">cs</span> <span class="free">fs</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>length <span class="free">cs</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">{..&lt;</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">…</span> <span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> lhr <span class="free">cs</span> <span class="free">fs</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> lhr <span class="free">cs</span> <span class="free">fs</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
                    last <span class="free">cs</span> <span class="main">*</span> lhr <span class="free">cs</span> <span class="free">fs</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> last_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lhr.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Homogenous_Recurrences-lhrI"><span class="command">lemma</span></span> lhrI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">≥</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">=</span> lhr <span class="free">cs</span> <span class="free">fs</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lhr.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cs</span> <span class="skolem">fs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">fs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">cs</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>length <span class="skolem">cs</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">{..&lt;</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">…</span> <span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
                      last <span class="skolem">cs</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> last_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> lhr <span class="skolem">cs</span> <span class="skolem">fs</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> lhr <span class="skolem">cs</span> <span class="skolem">fs</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">-</span>last <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">cs</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> eq_neg_iff_add_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2-4<span class="main">)</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lhr <span class="skolem">cs</span> <span class="skolem">fs</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lhr.simps<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 1<span class="main"><span class="main">(</span></span>2-5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhr.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* END TODO *)</span>

<span class="keyword1"><span class="command">locale</span></span> linear_homogenous_recurrence <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_semiring_0"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs_not_null <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> last_cs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hd_cs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> enough_base<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≥</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rec<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">fs</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_fps_numerator_altdef"><span class="command">lemma</span></span> lhr_fps_numerator_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lhr_fps_numerator <span class="main">(</span>length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span><span class="main">)</span> <span class="free">cs</span> <span class="free">f</span> <span class="main">=</span>
     lhr_fps_numerator <span class="main">(</span>length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span><span class="main">)</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="main">=</span> 
          Poly <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">N</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhr_fps_numerator_def Let_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> enough_base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def m_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> min <span class="skolem">N</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> 
      <span class="keyword1"><span class="command">using</span></span> enough_base that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> base<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq N_def m_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span> <span class="main">=</span>
           map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly <span class="main">…</span> <span class="main">=</span> lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enough_base
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhr_fps_numerator_def Let_def m_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* TODO Duplication *)</span>
<span class="keyword1" id="Linear_Homogenous_Recurrences-solve_lhr_aux"><span class="command">lemma</span></span> solve_lhr_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear_homogenous_recurrence <span class="free">f</span> <span class="free">cs</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_factorization_of <span class="free">fctrs</span> <span class="main">(</span>lr_fps_denominator' <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="main">(</span>lhr_fps_numerator 
                  <span class="main">(</span>length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span><span class="main">)</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="free">fctrs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> linear_homogenous_recurrence <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="free">fctrs</span> <span class="main">(</span>reflect_poly <span class="main">(</span>lr_fps_denominator' <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> reflect_factorization<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_fps_denominator'_def
                      nth_default_def hd_conv_nth <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span>lr_fps_denominator' <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> lr_fps_denominator <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lr_fps_denominator_def lr_fps_denominator'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeffs_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeffs_reflect_poly strip_while_rev <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                                 no_trailing_unfold last_rev <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> strip_while_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> factorization<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alt_factorization_of <span class="free">fctrs</span> <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> fctrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fctrs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fctrs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="skolem">a</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"solve_factored_ratfps' <span class="skolem">p</span> <span class="free">fctrs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"solve_factored_ratfps' <span class="skolem">p</span> <span class="free">fctrs</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> sol'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">=</span> solve_factored_ratfps <span class="skolem">p'</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sol <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fctrs p'_def solve_factored_ratfps_def 
                                          solve_factored_ratfps'_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> factorization'<span class="main">:</span> <span class="quoted"><span class="quoted">"lr_fps_denominator <span class="free">cs</span> <span class="main">=</span> interp_alt_factorization <span class="free">fctrs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorization <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alt_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">ds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fctrs is_factorization_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> coeff_0_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_fps_denominator_def nth_default_def 
                  hd_conv_nth <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hd_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>lr_fps_denominator' <span class="free">cs</span><span class="main">)</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lr_fps_denominator'_def nth_default_def hd_conv_nth <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> no_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_in_factorization_iff fctrs<span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> a_nz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fctrs interp_factorization_def is_factorization_of_def lr_fps_denominator'_nz<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> unit1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>fps_const <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>fps_of_poly <span class="main">(</span>interp_alt_factorization <span class="free">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_0_denom factorization' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> unit2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">←</span><span class="skolem">ds</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> fst <span class="bound">p</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fctrs case_prod_unfold interp_alt_factorization_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span><span class="main">)</span> <span class="main">/</span>
                        fps_of_poly <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> lhr_fps<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="free">cs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">…</span> <span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rec<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="main">=</span> lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lhr_fps_numerator_def <span class="keyword1"><span class="command">using</span></span> enough_base
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def poly_eq_iff nth_default_def base 
                   m_def Suc_le_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">…</span> <span class="main">/</span> fps_of_poly <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> 
               fps_of_poly <span class="main">(</span>lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> 
                 <span class="main">(</span>fps_const <span class="main">(</span>fst <span class="free">fctrs</span><span class="main">)</span> <span class="main">*</span> 
                   fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">←</span>snd <span class="free">fctrs</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> fst <span class="bound">p</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms factorization' interp_alt_factorization_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def fps_of_poly_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> unit1 unit2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_poly <span class="skolem">p</span> <span class="main">/</span> fps_const <span class="skolem">a</span> <span class="main">/</span> 
                                     fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">ds</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_unit_div_mult2_eq<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fctrs case_prod_unfold p_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> unit1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="skolem">p</span> <span class="main">/</span> fps_const <span class="skolem">a</span> <span class="main">=</span> fps_of_poly <span class="skolem">p'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_divide_unit fps_of_poly_smult fps_const_inverse p'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> distinct no_zero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> fps_of_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">ds</span><span class="main">.</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="bound">c</span><span class="main">:]</span><span class="main">^</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> 
      Abs_fps <span class="main">(</span>interp_ratfps_solution <span class="main">(</span>solve_factored_ratfps' <span class="skolem">p</span> <span class="free">fctrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> solve_factored_ratfps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold sol' sol<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def m_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lhr_fps</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">=</span> lhr_fps_numerator <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">q</span> <span class="main">=</span> lr_fps_denominator <span class="free"><span class="bound"><span class="entity">as</span></span></span>
     <span class="keyword1">in</span>  ratfps_of_poly <span class="bound">p</span> <span class="main">/</span> ratfps_of_poly <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Homogenous_Recurrences-lhr_fps_correct"><span class="command">lemma</span></span> lhr_fps_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear_homogenous_recurrence <span class="free">f</span> <span class="free">cs</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>lhr_fps <span class="free">cs</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> Abs_fps <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> linear_homogenous_recurrence <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lhr_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?denom</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lr_fps_denominator <span class="free">cs</span>"</span></span>
 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="free">cs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> fps_of_poly <span class="var">?num</span> <span class="main">/</span> fps_of_poly <span class="var">?denom</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lhr_fps<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> rec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?num</span> <span class="main">=</span> <span class="var">?num'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lhr_fps_numerator_altdef <span class="main"><span class="main">[</span></span><span class="operator">folded</span> m_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="var">?num'</span> <span class="main">/</span> fps_of_poly <span class="var">?denom</span> <span class="main">=</span> 
                fps_of_ratfps <span class="main">(</span>ratfps_of_poly <span class="var">?num'</span> <span class="main">/</span> ratfps_of_poly <span class="var">?denom</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> enough_base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fps_of_ratfps <span class="main">(</span>lhr_fps <span class="free">cs</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> base fps_of_ratfps_def case_prod_unfold lhr_fps_def m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Eulerian_Polynomials">
<div class="head">
<h1>Theory Eulerian_Polynomials</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Eulerian_Polynomials.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Eulerian polynomials›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Eulerian_Polynomials
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Stirling.html">HOL-Combinatorics.Stirling</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Eulerian polynomials are a sequence of polynomials that is related to
  the closed forms of the power series
  \[\sum_{n=0}^\infty n^k X^n\]
  for a fixed $k$.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eulerian_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> idom poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eulerian_poly</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eulerian_poly</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">eulerian_poly</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">in</span> 
     <span class="main">[:</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">:]</span> <span class="main">*</span> pderiv <span class="bound">p</span> <span class="main">+</span> <span class="bound">p</span> <span class="main">*</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> of_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">:]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> eulerian_poly_Suc <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> eulerian_poly.simps<span class="main">(</span>2<span class="main">)</span>

<span class="keyword1" id="Eulerian_Polynomials-eulerian_poly"><span class="command">lemma</span></span> eulerian_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>eulerian_poly <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field poly<span class="main">)</span> <span class="main">=</span> 
     Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> inverse <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fps_inverse_unique <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_mult_eq_1 fps_inverse_gp' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_mult_eq_1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fps"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>eulerian_poly <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fps"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def Suc F_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"fps_deriv <span class="skolem">p</span> <span class="main">=</span> fps_deriv <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p fps_deriv_power <span class="dynamic"><span class="dynamic">algebra_simps</span></span> fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_of_nat 
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc of_nat_Suc fps_const_neg<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>eulerian_poly <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fps_X <span class="main">*</span> fps_deriv <span class="skolem">F</span> <span class="main">+</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def p_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_of_poly_simps eulerian_poly_Suc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p p' fps_deriv_power fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_of_nat
                <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc of_nat_Suc fps_const_neg<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_X <span class="main">*</span> fps_deriv <span class="skolem">F</span> <span class="main">+</span> <span class="skolem">F</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> F_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Eulerian_Polynomials-eulerian_poly'"><span class="command">lemma</span></span> eulerian_poly'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
     fps_of_poly <span class="main">(</span>eulerian_poly <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field poly<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eulerian_poly<span class="main">)</span> <span class="operator">simp</span>
  
<span class="keyword1" id="Eulerian_Polynomials-eulerian_poly''"><span class="command">lemma</span></span> eulerian_poly''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
           fps_of_poly <span class="main">(</span>pCons <span class="main">0</span> <span class="main">(</span>eulerian_poly <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field poly<span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> fps_X <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> 
               fps_of_poly <span class="main">(</span>eulerian_poly <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eulerian_poly'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_X <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>pCons <span class="main">0</span> <span class="main">(</span>eulerian_poly <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_of_poly_pCons fps_divide_unit<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fps_monom_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fps_monom_poly</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> pcompose <span class="main">(</span>pCons <span class="main">0</span> <span class="main">(</span>eulerian_poly <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">:]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fps_monom_poly_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fps_monom_poly_aux</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[:</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">:]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fps_monom_poly_aux</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">fps_monom_poly_aux</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
       <span class="keyword1">in</span>  <span class="main">[:</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">:]</span> <span class="main">*</span> pderiv <span class="bound">p</span> <span class="main">+</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span> of_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">:]</span> <span class="main">*</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Eulerian_Polynomials-fps_monom_poly_aux"><span class="command">lemma</span></span> fps_monom_poly_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_monom_poly_aux <span class="free">c</span> <span class="free">k</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>pcompose <span class="main">(</span>eulerian_poly <span class="free">k</span><span class="main">)</span> <span class="main">[:</span><span class="main">0</span><span class="main">,</span><span class="free">c</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eulerian_poly_Suc Let_def pderiv_pcompose pcompose_pCons
                    pcompose_add pcompose_smult pcompose_uminus smult_add_right pderiv_pCons
                    pderiv_smult <span class="dynamic"><span class="dynamic">algebra_simps</span></span> one_pCons<span class="main">)</span>

<span class="keyword1" id="Eulerian_Polynomials-fps_monom_poly_code"><span class="command">lemma</span></span> fps_monom_poly_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fps_monom_poly <span class="free">c</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> pCons <span class="main">0</span> <span class="main">(</span>fps_monom_poly_aux <span class="free">c</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_monom_poly_def fps_monom_poly_aux pcompose_pCons<span class="main">)</span>

<span class="keyword1" id="Eulerian_Polynomials-fps_monom_aux"><span class="command">lemma</span></span> fps_monom_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>fps_monom_poly <span class="main">1</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gp <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_monom_poly_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> eulerian_poly''<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_monom_poly_def<span class="main">)</span>

<span class="keyword1" id="Eulerian_Polynomials-fps_monom"><span class="command">lemma</span></span> fps_monom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> 
      fps_of_poly <span class="main">(</span>fps_monom_poly <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> 
          fps_compose <span class="main">(</span>Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fps_compose_linear<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>fps_monom_poly <span class="main">1</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fps_monom_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_compose <span class="main">…</span> <span class="main">(</span>fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">=</span> 
                 <span class="main">(</span>fps_of_poly <span class="main">(</span>fps_monom_poly <span class="main">1</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">oo</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">/</span>
                 <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">oo</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_compose_divide_distrib<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_compose_sub_distrib <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="main">(</span>fps_monom_poly <span class="main">1</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">oo</span> <span class="main">(</span>fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">=</span> 
                fps_of_poly <span class="main">(</span>fps_monom_poly <span class="free">c</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_monom_poly_def fps_of_poly_pcompose fps_of_poly_simps
                  fps_of_poly_pCons mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">oo</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="free">c</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fps_compose_sub_distrib <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Linear_Inhomogenous_Recurrences">
<div class="head">
<h1>Theory Linear_Inhomogenous_Recurrences</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Linear_Inhomogenous_Recurrences.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Inhomogenous linear recurrences›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Linear_Inhomogenous_Recurrences
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="#Linear_Homogenous_Recurrences">Linear_Homogenous_Recurrences</a>
  <a href="#Eulerian_Polynomials">Eulerian_Polynomials</a> 
  <a href="#RatFPS">RatFPS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lir_fps_numerator</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lir_fps_numerator</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> 
      Poly <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="bound">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">k</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">N</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-lir_fps_numerator_code"><span class="command">lemma</span></span> lir_fps_numerator_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>lir_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> 
     strip_while <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="bound">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">N</span><span class="main">+</span><span class="free">m</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lir_fps_numerator_def Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">locale</span></span> linear_inhomogenous_recurrence <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs_not_null <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> last_cs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hd_cs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> enough_base<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≥</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rec<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span> <span class="main">⟹</span> 
                     <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">cs</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-coeff_0_lr_fps_denominator"><span class="command">lemma</span></span> coeff_0_lr_fps_denominator <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> last <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lr_fps_denominator_def nth_default_def nth_Cons hd_conv_nth <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hd_rev<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-lir_fps_numerator_altdef"><span class="command">lemma</span></span> lir_fps_numerator_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lir_fps_numerator <span class="main">(</span>length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span><span class="main">)</span> <span class="free">cs</span> <span class="free">f</span> <span class="free">g</span> <span class="main">=</span>
     lir_fps_numerator <span class="main">(</span>length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span><span class="main">)</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lir_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> 
          Poly <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">N</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lir_fps_numerator_def Let_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> enough_base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def m_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> min <span class="skolem">N</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> 
      <span class="keyword1"><span class="command">using</span></span> enough_base that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> base<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq N_def m_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span> <span class="main">=</span>
           map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="skolem">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly <span class="main">…</span> <span class="main">=</span> lir_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enough_base
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lir_fps_numerator_def Let_def m_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Linear_Inhomogenous_Recurrences-lir_fps_aux"><span class="command">lemma</span></span> lir_fps_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≡</span> Poly <span class="main">[</span><span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">N</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≡</span> Poly <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">N</span><span class="main">+</span><span class="free">m</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="free">q</span> <span class="main">+</span> Abs_fps <span class="free">g</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">include</span></span> fps_notation
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> Abs_fps <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="free">c</span> <span class="free">N</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">N</span> <span class="main">+</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">N</span> <span class="main">-</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth atLeast0AtMost<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_default_def p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_default_def p_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="free">N</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="free">N</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rec<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth atLeast0AtMost<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="skolem">n</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">c</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def nth_default_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def nth_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fps_of_poly <span class="free">p</span> <span class="main">*</span> <span class="skolem">F</span> <span class="main">=</span> fps_of_poly <span class="free">q</span> <span class="main">+</span> Abs_fps <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cN <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="free">q</span> <span class="main">+</span> Abs_fps <span class="free">g</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unit_eq_div2<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-lir_fps"><span class="command">lemma</span></span> lir_fps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">N</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cN<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">cs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="main">(</span>lir_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">+</span> Abs_fps <span class="free">g</span><span class="main">)</span> <span class="main">/</span> 
              fps_of_poly <span class="main">(</span>lr_fps_denominator <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">q</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> Poly <span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>min <span class="free">N</span> <span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">k</span><span class="main">.</span> k <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">N</span><span class="main">+</span><span class="free">m</span><span class="main">]</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Poly <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">N</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="skolem">p</span> <span class="main">+</span> Abs_fps <span class="free">g</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="skolem">q</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> p_def q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lir_fps_aux<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> lir_fps_numerator <span class="free">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def lir_fps_numerator_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> lr_fps_denominator <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def lr_fps_denominator_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_default_def rev_nth N_def not_less cs <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> polyexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_polyexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">)</span> polyexp <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_polyexp</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-eval_polyexp_Nil"><span class="command">lemma</span></span> eval_polyexp_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval_polyexp <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_polyexp_def<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-eval_polyexp_Cons"><span class="command">lemma</span></span> eval_polyexp_Cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eval_polyexp <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span> <span class="main">*</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> eval_polyexp <span class="free">xs</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_polyexp_def<span class="main">)</span>

  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polyexp_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> field<span class="main">)</span> polyexp <span class="main">⇒</span> <span class="tfree">'a</span> fps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">polyexp_fps</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> fps_of_poly <span class="main">(</span>Polynomial.smult <span class="bound">a</span> <span class="main">(</span>fps_monom_poly <span class="bound">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> 
                       <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="bound">b</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_fps_Nil"><span class="command">lemma</span></span> polyexp_fps_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"polyexp_fps <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_fps_def<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_fps_Cons"><span class="command">lemma</span></span> polyexp_fps_Cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"polyexp_fps <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> 
     fps_of_poly <span class="main">(</span>Polynomial.smult <span class="bound">a</span> <span class="main">(</span>fps_monom_poly <span class="bound">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="bound">b</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
     polyexp_fps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_fps_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">polyexp_ratfps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> field_gcd<span class="main">)</span> polyexp <span class="main">⇒</span> <span class="tfree">'a</span> ratfps"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">polyexp_ratfps</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> ratfps_of_poly <span class="main">(</span>Polynomial.smult <span class="bound">a</span> <span class="main">(</span>fps_monom_poly <span class="bound">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
                       ratfps_of_poly <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="bound">b</span><span class="main">:]</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     
<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_ratfps_Nil"><span class="command">lemma</span></span> polyexp_ratfps_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"polyexp_ratfps <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_ratfps_def<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_ratfps_Cons"><span class="command">lemma</span></span> polyexp_ratfps_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"polyexp_ratfps <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">k</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span>
  ratfps_of_poly <span class="main">(</span>Polynomial.smult <span class="bound">a</span> <span class="main">(</span>fps_monom_poly <span class="bound">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> 
     ratfps_of_poly <span class="main">(</span><span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="bound">b</span><span class="main">:]</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> polyexp_ratfps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_ratfps_def<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_fps"><span class="command">lemma</span></span> polyexp_fps<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span>eval_polyexp <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> polyexp_fps <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span>eval_polyexp <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          fps_const <span class="skolem">a</span> <span class="main">*</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> Abs_fps <span class="main">(</span>eval_polyexp <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_polyexp_Cons fps_plus_def mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> 
               fps_of_poly <span class="main">(</span>fps_monom_poly <span class="skolem">b</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fps_const <span class="skolem">b</span> <span class="main">*</span> fps_X<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fps_monom<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_const <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fps_const <span class="skolem">a</span> <span class="main">*</span> <span class="var">?A</span><span class="main">)</span> <span class="main">/</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> unit_div_mult_swap<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_const <span class="skolem">a</span> <span class="main">*</span> <span class="var">?A</span> <span class="main">=</span> fps_of_poly <span class="main">(</span>Polynomial.smult <span class="skolem">a</span> <span class="main">(</span>fps_monom_poly <span class="skolem">b</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Cons.IH
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_fps_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_zero_def<span class="main">)</span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-polyexp_ratfps"><span class="command">lemma</span></span> polyexp_ratfps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fps_of_ratfps <span class="main">(</span>polyexp_ratfps <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> polyexp_fps <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc fps_const_neg 
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_0_power fps_of_poly_power fps_of_poly_smult fps_of_poly_pCons 
                 fps_const_neg <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult_ac polyexp_ratfps_Cons polyexp_fps_Cons<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lir_fps</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_gcd list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> polyexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ratfps<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lir_fps</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> None <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">=</span> lir_fps_numerator <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>eval_polyexp <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">q</span> <span class="main">=</span> lr_fps_denominator <span class="free"><span class="bound"><span class="entity">cs</span></span></span>
     <span class="keyword1">in</span>  Some <span class="main">(</span><span class="main">(</span>ratfps_of_poly <span class="bound">p</span> <span class="main">+</span> polyexp_ratfps <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>ratfps_of_poly <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Inhomogenous_Recurrences-lir_fps_correct"><span class="command">lemma</span></span> lir_fps_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field_gcd"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear_inhomogenous_recurrence <span class="free">f</span> <span class="main">(</span>eval_polyexp <span class="free">g</span><span class="main">)</span> <span class="free">cs</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_option fps_of_ratfps <span class="main">(</span>lir_fps <span class="free">cs</span> <span class="free">fs</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Abs_fps <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> linear_inhomogenous_recurrence <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"eval_polyexp <span class="free">g</span>"</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="free">fs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lir_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="free">f</span> <span class="main">(</span>eval_polyexp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lir_fps_numerator <span class="skolem">m</span> <span class="free">cs</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>eval_polyexp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?denom</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lr_fps_denominator <span class="free">cs</span>"</span></span>
 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span>length <span class="free">cs</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="free">cs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>fps_of_poly <span class="var">?num</span> <span class="main">+</span> Abs_fps <span class="main">(</span>eval_polyexp <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="var">?denom</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lir_fps<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> rec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?num</span> <span class="main">=</span> <span class="var">?num'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lir_fps_numerator_altdef <span class="main"><span class="main">[</span></span><span class="operator">folded</span> m_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_of_poly <span class="var">?num'</span> <span class="main">+</span> Abs_fps <span class="main">(</span>eval_polyexp <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fps_of_poly <span class="var">?denom</span> <span class="main">=</span> 
                fps_of_ratfps <span class="main">(</span><span class="main">(</span>ratfps_of_poly <span class="var">?num'</span> <span class="main">+</span> polyexp_ratfps <span class="free">g</span><span class="main">)</span> <span class="main">*</span> 
                  inverse <span class="main">(</span>ratfps_of_poly <span class="var">?denom</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> polyexp_fps fps_divide_unit<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> enough_base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">…</span> <span class="main">=</span> map_option fps_of_ratfps <span class="main">(</span>lir_fps <span class="free">cs</span> <span class="free">fs</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> base fps_of_ratfps_def case_prod_unfold lir_fps_def m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rational_FPS_Asymptotics">
<div class="head">
<h1>Theory Rational_FPS_Asymptotics</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Rational_FPS_Asymptotics.thy
  Author:  Manuel Eberl, TU München
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Rational_FPS_Asymptotics
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Landau_Symbols.html">HOL-Library.Landau_Symbols</a>"</span>
  <span class="quoted">"<a href="../../polynomial_factorization/theories/#Square_Free_Factorization">Polynomial_Factorization.Square_Free_Factorization</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Real_Asymp/Real_Asymp.html">HOL-Real_Asymp.Real_Asymp</a>"</span>
  <span class="quoted">"<a href="../../count_complex_roots/theories/#Count_Complex_Roots">Count_Complex_Roots.Count_Complex_Roots</a>"</span>
  <a href="#Linear_Homogenous_Recurrences">Linear_Homogenous_Recurrences</a>
  <a href="#Linear_Inhomogenous_Recurrences">Linear_Inhomogenous_Recurrences</a>
  <a href="#RatFPS">RatFPS</a>
  <a href="#Rational_FPS_Solver">Rational_FPS_Solver</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-poly_asymp_equiv"><span class="command">lemma</span></span> poly_asymp_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≤</span> at_infinity"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="free">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> poly_pCons'<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">*</span> poly <span class="skolem">q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">(</span>degree <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="skolem">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pCons.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">*</span> poly <span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_pCons'<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="skolem">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_left<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> poly <span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>lead_coeff <span class="skolem">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span> *<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="skolem">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def mult_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> poly <span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> at_infinity <span class="free">F</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filterlim_def assms<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ω[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smallomega_1_conv_filterlim
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Limits.filterlim_power_at_infinity filterlim_ident<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smallomega_iff_smallo<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="skolem">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-poly_bigtheta"><span class="command">lemma</span></span> poly_bigtheta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≤</span> at_infinity"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">∈</span> <span class="keyword1">Θ[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lead_coeff <span class="free">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_asymp_equiv assms<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> asymp_equiv_imp_bigtheta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-poly_bigo"><span class="command">lemma</span></span> poly_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≤</span> at_infinity"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> degree <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Ω[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> degree <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ω[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> smallomega_1_conv_filterlim <span class="keyword1"><span class="command">using</span></span> assms False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Limits.filterlim_power_at_infinity filterlim_ident<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_omega.small_imp_big<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">∈</span> <span class="keyword1">Θ[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_bigtheta<span class="main">[</span><span class="operator">OF</span> False assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">F</span><span class="main">](</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> degree <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.mult landau_o.big_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bigomega_iff_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> degree <span class="free">p</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> degree <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-reflect_poly_dvdI"><span class="command">lemma</span></span> reflect_poly_dvdI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_semiring_1<span class="main">,</span>semiring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reflect_poly <span class="free">p</span> <span class="keyword1">dvd</span> reflect_poly <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reflect_poly_mult<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Asymptotics-smult_altdef"><span class="command">lemma</span></span> smult_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="free">c</span><span class="main">:]</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Asymptotics-smult_power"><span class="command">lemma</span></span> smult_power<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="free">c</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="free">c</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">[:</span><span class="free">c</span> <span class="main">^</span> <span class="free">n</span><span class="main">:]</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="free">c</span><span class="main">:]</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">[:</span><span class="free">c</span> <span class="main">^</span> <span class="free">n</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="free">c</span> <span class="main">^</span> <span class="free">n</span><span class="main">:]</span> <span class="main">=</span> <span class="main">[:</span><span class="free">c</span><span class="main">:]</span> <span class="main">^</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">[:</span><span class="free">c</span><span class="main">:]</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_mult_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-order_reflect_poly_ge"><span class="command">lemma</span></span> order_reflect_poly_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">≥</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">dvd</span> reflect_poly <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> reflect_poly_dvdI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> order_divides<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reflect_poly <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
               smult <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">^</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="free">c</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reflect_poly_power reflect_poly_pCons smult_power<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="free">c</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">dvd</span> reflect_poly <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> order_divides<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-order_reflect_poly"><span class="command">lemma</span></span> order_reflect_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">≥</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_reflect_poly_ge<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">≤</span>
                     order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>reflect_poly <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_reflect_poly_ge<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="free">c</span> <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-poly_reflect_eq_0_iff"><span class="command">lemma</span></span> poly_reflect_eq_0_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"poly <span class="main">(</span>reflect_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field<span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">p</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_reflect_poly_nz inverse_eq_divide<span class="main">)</span>
  

<span class="keyword1"><span class="command">theorem</span></span> ratfps_nth_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> roots1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> ball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> poly <span class="free">q</span> <span class="bound">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> roots2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> sphere <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> poly <span class="free">q</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> order <span class="bound">z</span> <span class="free">q</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> reflect_poly <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> roots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_0_coeff_0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ratfps_closed_form_exists<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> r rs <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> closed_form <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> coeff <span class="skolem">r</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">c</span></span> <span class="main">|</span> poly <span class="skolem">q'</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> closed_form<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_bigo big_sum_in_bigo<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> coeff <span class="skolem">r</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MOST_nat coeff_eq_0 cofinite_eq_sequentially <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bigthetaI_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> poly <span class="skolem">q'</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">c</span><span class="main">)</span> <span class="bound">n</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">c</span> <span class="main">=</span> <span class="free">R</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">―‹The case of a root at the border of the disc›</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.mult landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> poly_bigo tendsto_of_nat<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> order <span class="skolem">c</span> <span class="main">(</span>reflect_poly <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed_form<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">c</span> <span class="main">(</span>reflect_poly <span class="free">q</span><span class="main">)</span> <span class="main">=</span> order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_reflect_poly<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">q</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword2"><span class="keyword">and</span></span> c
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> roots2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def norm_divide poly_reflect_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span>"</span></span><span class="main">]</span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def poly_reflect_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>complex_of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_power<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> complex_of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> landau_o.big.norm_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False  <span class="comment1">―‹The case of a root in the interior of the disc›</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">c</span> <span class="main">&lt;</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> roots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="skolem">c</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def poly_reflect_eq_0_iff norm_divide <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> degree <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> poly <span class="main">(</span><span class="skolem">rs</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.mult landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> poly_bigo tendsto_of_nat<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> landau_o.big.norm_iff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">^</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">R</span> <span class="main">/</span> norm <span class="skolem">c</span><span class="main">)</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm <span class="skolem">c</span> <span class="main">&lt;</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">^</span> <span class="skolem">l</span> <span class="main">*</span> norm <span class="skolem">c</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_divide landau_o.big.divide_eq1<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>of_nat <span class="bound">x</span> <span class="main">^</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> 
                <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>of_nat <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> complex_of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> norm_power norm_mult <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-order_power"><span class="command">lemma</span></span> order_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> order <span class="free">c</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> order <span class="free">c</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_mult<span class="main">)</span>

<span class="keyword1" id="Rational_FPS_Asymptotics-same_root_imp_not_coprime"><span class="command">lemma</span></span> same_root_imp_not_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">q</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> gcd <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">p</span> <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coprime_imp_gcd_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> is_unit_polyE<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Rational_FPS_Asymptotics-ratfps_nth_bigo_square_free_factorization"><span class="command">lemma</span></span> ratfps_nth_bigo_square_free_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">q</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> roots1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>ball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">c</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> roots2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>sphere <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">c</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> smult <span class="free">b</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> <span class="bound">c</span> <span class="main">^</span> Suc <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def prod.case <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="skolem">c1</span> <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c1</span> <span class="skolem">c2</span> <span class="skolem">m</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def case_prod_unfold<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_nth_bigo<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">q</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">q</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">c</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q poly_prod image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> roots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> sphere <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> order<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">=</span> order <span class="skolem">z</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> <span class="bound">c</span> <span class="main">^</span> Suc <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_smult q<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> order <span class="skolem">z</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">c</span> <span class="main">^</span> Suc <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_prod<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> coprime<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> order_power<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c0</span> <span class="bound">l0</span><span class="main">.</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">l0</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">∧</span> poly <span class="bound">c0</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">l</span>
        <span class="keyword1"><span class="command">using</span></span> False that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_root<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">―‹The order of a root is determined by the unique polynomial in the
                   square-free factorisation that contains it.›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c0</span></span> <span class="skolem"><span class="skolem">l0</span></span> <span class="keyword2"><span class="keyword">where</span></span> cl0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c0</span><span class="main">,</span> <span class="skolem">l0</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">c0</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="skolem">l0</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="skolem">c0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">c0</span><span class="main">,</span> <span class="skolem">l0</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cl0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c0</span><span class="main">,</span> <span class="skolem">l0</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">c0</span><span class="main">,</span> <span class="skolem">l0</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Suc <span class="bound">l</span> <span class="main">*</span> order <span class="skolem">z</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cl</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cl</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c0</span><span class="main">,</span> <span class="skolem">l0</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cl</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> cl <span class="keyword2"><span class="keyword">and</span></span> cl0 <span class="keyword2"><span class="keyword">and</span></span> coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c0</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l0</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">c</span> <span class="skolem">c0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> same_root_imp_not_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">c0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> cl0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">c</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_root<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_free <span class="skolem">c0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cl0 assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rsquarefree <span class="skolem">c0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> square_free_rsquarefree<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cl0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="skolem">c0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rsquarefree_def' order_root <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">=</span> Suc <span class="skolem">l0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> roots2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c0</span></span> <span class="quoted"><span class="skolem">l0</span></span><span class="main">]</span> cl0 z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l0</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l0</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">z</span> <span class="free">q</span> <span class="main">≤</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">find_consts</span></span> name<span class="main">:</span><span class="quoted">"Count_Complex"</span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">proots_ball_card</span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">proots_sphere_card</span>

<span class="keyword1" id="Rational_FPS_Asymptotics-proots_within_card_zero_iff"><span class="command">lemma</span></span> proots_within_card_zero_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span>proots_within <span class="free">p</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_0_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_proots<span class="main">)</span>


<span class="keyword1" id="Rational_FPS_Asymptotics-ratfps_nth_bigo_square_free_factorization'"><span class="command">lemma</span></span> ratfps_nth_bigo_square_free_factorization'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">q</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> roots1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> proots_ball_card <span class="main">(</span>fst <span class="bound">cl</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> roots2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> proots_sphere_card <span class="main">(</span>fst <span class="bound">cl</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
                     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> snd <span class="bound">cl</span> <span class="main">&gt;</span> <span class="free">k</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_nth_bigo_square_free_factorization<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> smult <span class="free">b</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">∈</span>set <span class="free">cs</span><span class="main">.</span> <span class="bound">c</span> <span class="main">^</span> Suc <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def prod.case <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>ball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">.</span> poly <span class="skolem">c</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> roots1 that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>proots_within <span class="skolem">c</span> <span class="main">(</span>ball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proots_ball_card_def list_all_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> proots_within_card_zero_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>sphere <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">.</span> poly <span class="skolem">c</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> roots2 that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>proots_within <span class="skolem">c</span> <span class="main">(</span>sphere <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proots_sphere_card_def list_all_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> proots_within_card_zero_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ratfps_has_asymptotics</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ratfps_has_asymptotics</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">cs</span> <span class="main">=</span> snd <span class="main">(</span>yun_factorization gcd <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span>  list_all <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> proots_ball_card <span class="main">(</span>fst <span class="bound">cl</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="bound">cs</span> <span class="main">∧</span>
          list_all <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> proots_sphere_card <span class="main">(</span>fst <span class="bound">cl</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">cl</span><span class="main">.</span> snd <span class="bound">cl</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rational_FPS_Asymptotics-ratfps_has_asymptotics_correct"><span class="command">lemma</span></span> ratfps_has_asymptotics_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ratfps_has_asymptotics <span class="free">q</span> <span class="free">k</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">p</span> <span class="main">/</span> fps_of_poly <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> of_real <span class="free">R</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ratfps_nth_bigo_square_free_factorization'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">q</span> <span class="main">(</span>fst <span class="main">(</span>yun_factorization gcd <span class="free">q</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>yun_factorization gcd <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> yun_factorization<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ratfps_has_asymptotics_def Let_def list_all_def<span class="main">)</span>


<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>fps_nth <span class="main">(</span>fps_of_poly <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">/</span> fps_of_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span> <span class="main">::</span> real<span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">5</span><span class="main">]</span>"</span></span>




<span class="keyword1"><span class="command">method</span></span> ratfps_bigo <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> ratfps_has_asymptotics_correct<span class="main"><span class="keyword3">;</span></span> <span class="operator">eval</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">/</span> fps_of_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span> <span class="main">::</span> complex<span class="main">:]</span><span class="main">)</span> <span class="main">∈</span>
         <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="main">0</span> <span class="main">*</span> complex_of_real <span class="numeral">1.618034</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">ratfps_bigo</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="main">1</span> <span class="main">/</span> fps_of_poly <span class="main">[:</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span> <span class="main">::</span> complex<span class="main">:]</span><span class="main">)</span> <span class="main">∈</span>
         <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> complex_of_real <span class="main">1</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">ratfps_bigo</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fps_nth <span class="main">(</span>fps_of_poly <span class="free">f</span> <span class="main">/</span> fps_of_poly <span class="main">[:</span><span class="numeral">5</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">1</span> <span class="main">::</span> complex<span class="main">:]</span><span class="main">)</span> <span class="main">∈</span>
         <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="main">^</span> <span class="main">0</span> <span class="main">*</span> complex_of_real <span class="numeral">0.69202</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">ratfps_bigo</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>