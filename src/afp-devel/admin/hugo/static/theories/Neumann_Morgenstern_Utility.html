<div id="PMF_Composition">
<div class="head">
<h1>Theory PMF_Composition</h1>
</div>
<pre class="source"><span class="comment1">(* License: LGPL *)</span>
<span class="comment1">(* Author: Julian Parsert *)</span>


<span class="keyword1"><span class="command">theory</span></span> PMF_Composition
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Composition of Probability Mass functions ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mix_pmf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> pmf <span class="main">⇒</span> <span class="tfree">'a</span> pmf <span class="main">⇒</span> <span class="tfree">'a</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mix_pmf</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>bernoulli_pmf <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">X</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_pmf_def pmf_bind<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix_deeper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="free">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib' pmf_mix<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_pmf_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_pmf <span class="main">0</span> <span class="main">=</span> return_pmf False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_pmf.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bernoulli_pmf_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bernoulli_pmf <span class="main">1</span> <span class="main">=</span> return_pmf True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_pmf.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_pmf_def bind_return_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">1</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_pmf_def bind_return_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_pmf_mix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="free">p</span> <span class="main">∪</span> set_pmf <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_pmf_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_pmf_mix_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_pmf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_equiv_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="free">p</span> <span class="main">⟹</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">=</span> pmf <span class="free">q</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="free">q</span> <span class="main">⟹</span> pmf <span class="free">q</span> <span class="bound">e</span> <span class="main">=</span> pmf <span class="free">p</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_irrefl pmf_neq_exists_less pmf_not_neg set_pmf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_equiv_intro1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="free">p</span> <span class="main">⟹</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">=</span> pmf <span class="free">q</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> assms set_pmf_iff assms 
      linorder_not_le order_refl pmf_neq_exists_less pmf_not_neg set_pmf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_inverse_switch_eqals<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span>  pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="free">q</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span>  pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span>  pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span>  pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fst add_0_left assms mult_eq_0_iff pmf_mix set_pmf_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_equiv_intro1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_comp_left_div<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="free">e</span> <span class="main">-</span> <span class="free">β</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> atLeastAtMost_iff less_divide_eq_1 
        less_eq_real_def not_less pmf_mix zero_le_divide_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">α</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>1<span class="main">)</span> pmf_mix <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span><span class="free">α</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  mult.assoc  ring_class.ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span><span class="main">*</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * diff_divide_distrib right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="free">e</span> <span class="main">+</span> <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span> <span class="main">-</span> <span class="free">β</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span><span class="main">-</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">*</span> pmf <span class="free">q</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_comp_with_dif_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="free">β</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_equiv_intro1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set_pmf <span class="var">?r</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set_pmf <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a pmf_mix_deeper <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mix_pmf_comp_left_div pmf_eq_0_set_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?l</span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">β</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">e</span> <span class="main">-</span> <span class="free">β</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_mix_deeper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">β</span><span class="main">/</span><span class="free">α</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> mix_pmf_comp_left_div<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>mix_pmf <span class="free">β</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> pmf <span class="main">(</span>mix_pmf <span class="main">(</span><span class="free">β</span> <span class="main">/</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mix_pmf_comp_left_div pmf_mix_deeper<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> product_mix_pmf_prob_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">a</span> <span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span>  mix_pmf <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> mult_le_one assms g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> alt_<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="skolem">l</span><span class="main">.</span> pmf <span class="skolem">r</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="bound">e</span> <span class="main">-</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">r</span> <span class="skolem">e</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">e</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">γ</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">γ</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>›</span></span> g pmf_mix r <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">e</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span> <span class="main">-</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> pmf <span class="main">(</span>mix_pmf <span class="skolem">γ</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation g r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">γ</span>  <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="skolem">e</span> <span class="main">-</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">r</span> <span class="skolem">e</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="skolem">e</span> <span class="main">-</span> <span class="skolem">γ</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="skolem">e</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="skolem">r</span><span class="main">.</span> pmf <span class="skolem">l</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">b</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">+</span> pmf <span class="free">q</span> <span class="bound">e</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> allI pmf_mix_deeper assms<span class="main">(</span>2<span class="main">)</span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">a</span> <span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> neg<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span>mix_pmf <span class="free">a</span> <span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult_cancel_right2 pmf_mix_0 set_pmf_mix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> mix_pmf <span class="free">a</span> <span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_le_0_iff_le g mix_pmf_comp_with_dif_equiv mult_eq_0_iff 
          nonzero_mult_div_cancel_right not_le order_refl y<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> b neg assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_subset_of_original<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set_pmf <span class="free">p</span> <span class="main">∪</span> set_pmf <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_pmf_mix<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms less_eq_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_preserves_finite_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> finite_Un finite_subset mix_pmf_subset_of_original<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_certain_iff_singleton_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> empty_iff finite.emptyI finite_insert insert_iff 
          not_le pmf_le_1 pmf_neq_exists_less pmf_nonneg set_pmf_iff set_return_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sumeq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_pmf_eq_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span>"</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> set_pmf_nemtpy<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_pmf_not_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_0_eq less_one nat_neq_iff neg sum.infinite sumeq_1 zero_neq_one<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>     
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set_pmf <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  set_pmf_nemtpy is_singletonI' is_singleton_altdef
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> neg<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AE_measure_pmf_iff UNIV_I empty_iff insert_iff
            measure_pmf.prob_eq_1 pmf.rep_eq sets_measure_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sumeq_1 neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> g1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> card_1_singletonE less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pmf.rep_eq subset_eq
    sum_pmf_eq_1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set_pmf <span class="free"><span class="free">p</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span>  card_gt_0_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set_pmf <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> 
    measure_measure_pmf_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set_pmf <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We thank Manuel Eberl for suggesting the following two lemmas. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set_pmf <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">q</span> <span class="main">=</span> set_pmf <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> mix_pmf <span class="free">a</span> <span class="free">q</span> <span class="main">(</span>return_pmf <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a_n1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pmf_eq_0_set_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_certain_iff_singleton_support <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> 
        Diff_cancel assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_1_singletonE singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> embed_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> pmf <span class="free">p</span> <span class="bound">z</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">q</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> pmf <span class="free">p</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_embed_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_pmf_eq_1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="bound">x</span> <span class="main">+</span> 
                      ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">+</span> 
                    <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_add<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> pmf <span class="free">p</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_indicator_finite<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>
                 <span class="main">-</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ennreal_minus<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> inverse <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> ennreal_mult' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inverse <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">∈</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ennreal_mult'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> eq
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>inverse <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>return_pmf <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q pmf_mix pmf_le_1 a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">q</span> <span class="main">=</span> set_pmf <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q set_pmf_eq a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> y assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix_induct <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> degenerate mix<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> degenerate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>return_pmf <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mix<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">a</span> <span class="bound">y</span><span class="main">.</span> set_pmf <span class="bound">p</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> 
                         <span class="free">P</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>mix_pmf <span class="bound">a</span> <span class="bound">p</span> <span class="main">(</span>return_pmf <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_not_empty <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> return_pmf <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_pmf_subset_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> singleton <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> degenerate<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">B</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mix_pmf_partition<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">q</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">q</span> <span class="main">=</span> set_pmf <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> mix_pmf <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">(</span>return_pmf <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>mix_pmf <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">(</span>return_pmf <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert.prems decomp<span class="main">(</span>1<span class="main">)</span> insert.hyps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mix insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decomp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> decomp<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_mix_induct' <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> degenerate mix<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> degenerate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>return_pmf <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mix<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> set_pmf <span class="bound">p</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> set_pmf <span class="bound">q</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> 
                         <span class="free">P</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>mix_pmf <span class="bound">a</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmf_mix_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_sum_distribute_mix_pmf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span>  <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_pmf_eq_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span>  <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sum_pmf_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_pmf_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst add.assoc add_diff_cancel_left' add_uminus_conv_diff assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        mult.right_neutral order_refl sum_distrib_left sum_pmf_eq_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distribute_alpha_over_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">T</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">T</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> sum.cong sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_over_subset_pmf_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="main">|</span> <span class="main">(</span>sub<span class="main">)</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊂</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> sub
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">T</span> <span class="main">-</span> <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> set_pmf <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> A_def Un_Diff_cancel2 
          Un_absorb2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf.commute inf_sup_aci<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def pmf_eq_0_set_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expected_value_mix_pmf_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> measure_pmf.expectation <span class="free">p</span> <span class="free">f</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="free">q</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mix_pmf_preserves_finite_support assms less_eq_real_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">q</span> <span class="main">⊆</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms assms set_pmf_mix <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mult.assoc sum.cong sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distribute_alpha_over_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fn pmf_integral_code_unfold pmf_integral_pmf_set_integral
        pmf_set_integral_code_alt_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_mix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> ****<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute ring_class.ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">q</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsets sum_over_subset_pmf_support<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set_pmf <span class="free">q</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsets sum_over_subset_pmf_support<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> measure_pmf.expectation <span class="free">q</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pmf_integral_code_unfold pmf_integral_pmf_set_integral pmf_set_integral_code_alt_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pmf_integral_code_unfold pmf_integral_pmf_set_integral pmf_set_integral_code_alt_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span> <span class="quoted">"**"</span> <span class="quoted">"***"</span> <span class="quoted">"****"</span> f g h<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expected_value_mix_pmf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> measure_pmf.expectation <span class="free">p</span> <span class="free">f</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="free">q</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">|</span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> less_eq_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 pmf_mix_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">q</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="free">q</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> b expected_value_mix_pmf_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 pmf_mix_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lotteries">
<div class="head">
<h1>Theory Lotteries</h1>
</div>
<pre class="source"><span class="comment1">(* License: LGPL *)</span>
<span class="comment1">(* Author: Julian Parsert *)</span>

<span class="keyword1"><span class="command">theory</span></span> Lotteries
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="PMF_Composition.html">PMF_Composition</a>
    <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Lotteries ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lotteries_on</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lotteries_on</span> <span class="free"><span class="bound"><span class="entity">Oc</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> <span class="main">(</span>set_pmf <span class="bound">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Oc</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lotteries_on_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">A</span> <span class="main">⊆</span> lotteries_on <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_mono assms gfp.leq_trans lotteries_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> support_in_outcomes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">oc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> lotteries_on <span class="bound">oc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set_pmf <span class="bound">p</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">oc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lotteries_on_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms 
      empty_subsetI ex_in_conv insert_subset set_return_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_support_one_oc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">outcomes</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> finite <span class="main">(</span>set_pmf <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms card.infinite finite_subset lotteries_on_def mem_Collect_eq zero_neq_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_outcome_card_support_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">outcomes</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> card <span class="main">(</span>set_pmf <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms card.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">=</span> card <span class="main">(</span>set_pmf <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms card_eq_0_iff card_mono finite_support_one_oc le_neq_implies_less 
        less_one lotteries_on_def mem_Collect_eq set_pmf_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> finite_nempty_ex_degernate_in_lotteries<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">out</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> lotteries_on <span class="free">out</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">out</span><span class="main">.</span> pmf <span class="bound">e</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">∈</span>lotteries_on <span class="free">out</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">out</span><span class="main">.</span> pmf <span class="bound">e</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> lotteries_on <span class="free">out</span><span class="main">.</span> set_pmf <span class="bound">e</span> <span class="main">⊆</span> <span class="free">out</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lotteries_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> lotteries_on <span class="free">out</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>set_pmf <span class="bound">e</span><span class="main">.</span> pmf <span class="bound">e</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_pmf_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset  assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_subset order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> a assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card.empty card_gt_0_iff card_seteq 
        empty_subsetI finite.emptyI finite_insert insert_subset lotteries_on_def subsetI
        measure_measure_pmf_finite mem_Collect_eq nat_less_le pmf.rep_eq set_pmf_of_set <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_support_1_probability_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set_pmf <span class="free">p</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">e</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms card_1_singletonE card_ge_0_finite 
      card_subset_eq ex_card le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> measure_measure_pmf_finite 
      pmf.rep_eq singletonD sum_pmf_eq_1 zero_less_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_outcome_card_lotteries_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">outcomes</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms card_1_singletonE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> exl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> pmf <span class="bound">l</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x assms card.infinite empty_iff 
        finite_nempty_ex_degernate_in_lotteries insert_iff zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pmfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> set_pmf <span class="bound">l</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_subset_singleton x<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> pmf <span class="bound">l</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_subset_singleton x<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exl empty_iff is_singletonI' is_singleton_altdef
        order_refl pmfs set_pmf_subset_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> return_pmf_card_equals_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">=</span> card <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">=</span> return_pmf <span class="main">`</span> <span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">=</span> card <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_in_lotteries<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> lotteries_on <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>mix_pmf <span class="free">a</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="free">p</span> <span class="main">∪</span> set_pmf <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_pmf_mix<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_subset_iff assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lotteries_on_def mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_degen_lotteries_equals_outcomes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> lotteries_on <span class="free">out</span><span class="main">.</span> card <span class="main">(</span>set_pmf <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> card <span class="free">out</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>empty<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span> <span class="main">(</span>not_empty<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> not_empty
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">DG</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      DG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">DG</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> lotteries_on <span class="free">out</span><span class="main">.</span> card <span class="main">(</span>set_pmf <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AP</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AP</span> <span class="main">=</span> <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">out</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">AP</span> <span class="main">=</span> card <span class="free">out</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> AP return_pmf_card_equals_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span> <span class="main">∈</span> <span class="skolem">DG</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="skolem">AP</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">DG</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> lotteries_on <span class="free">out</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">=</span> card <span class="main">(</span>set_pmf <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> DG <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">out</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">l</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> card_1_singletonE singletonI support_in_outcomes<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"return_pmf <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_pmf_subset_singleton x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">AP</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> AP x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AP</span> <span class="main">=</span> <span class="skolem">DG</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="skolem">AP</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> lotteries_on <span class="free">out</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def AP<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AP</span> <span class="main">⊆</span> <span class="skolem">DG</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DG AP <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> DG ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_not_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Neumann_Morgenstern_Utility_Theorem">
<div class="head">
<h1>Theory Neumann_Morgenstern_Utility_Theorem</h1>
</div>
<pre class="source"><span class="comment1">(* License: LGPL *)</span>
<span class="comment1">(* Author: Julian Parsert *)</span>


<span class="keyword1"><span class="command">theory</span></span> Neumann_Morgenstern_Utility_Theorem
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
    <span class="quoted">"<a href="../First_Welfare_Theorem/Utility_Functions.html">First_Welfare_Theorem.Utility_Functions</a>"</span>
    <a href="Lotteries.html">Lotteries</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Properties of Preferences ›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Independent Preferences›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Independence is sometimes called substitution ›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Notice how r is "added" to the right of mix-pmf and the element to the left q/p changes ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">independent_vnm</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">independent_vnm</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">α</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms independent_vnm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">r</span> <span class="bound">α</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> independent_vnmI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> assms greaterThanAtMost_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnm_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> 
  <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> independent_vnmI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> a greaterThanLessThan_iff 
        linorder_neqE_linordered_idom not_le pmf_mix_1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> independent_vnm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> independece_dest_alt<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">α</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">α</span>
  <span class="keyword3"><span class="command">assume</span></span> as1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> as2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> as3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> as4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="skolem">q</span> <span class="main">=</span> mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as1 as2 as3 assms<span class="main">(</span>1<span class="main">)</span> independent_vnm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmD1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms independent_vnm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">α</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms independece_dest_alt  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmD3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">α</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms independece_dest_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vnmD4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> 
      independece_dest_alt pmf_mix_0 refl_onD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> approx_indep_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="var">?lo</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> clct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">x</span> <span class="main">∧</span> independent_vnm <span class="var">?lo</span> <span class="free">ℛ</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="var">?lo</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="var">?lo</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="var">?lo</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span>  a assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff 
        ind preference_def rational_preference_def rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_lo<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="var">?lo</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?lo</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanLessThan_iff
        less_eq_real_def mix_pmf_in_lotteries pmf_mix_0 pmf_mix_1 a<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="free">α</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_lo<span class="main">(</span>2<span class="main">)</span> rational_preference.compl rpr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff clct
        greaterThanAtMost_iff independent_vnmD2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> approx_imp_approx_ind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> approx_indep_ge assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> ind rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> geq_imp_mix_geq_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xy_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preference.not_outside rational_preference_def rpr<span class="main">)</span>
      <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preference_def rational_preference_def rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mpf</span> <span class="main">∈</span> <span class="var">?lot</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> mix_pmf_in_lotteries <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">α</span></span><span class="main">]</span> xy_p assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> approx_indep_ge assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ind preference.not_outside 
        rational_preference.compl rational_preference_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="var">?lot</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff independece_dest_alt 
        less_eq_real_def pmf_mix_0 rational_preference.compl rpr ind xy_p<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>      
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> set_pmf_mix_eq xy_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> geq_imp_mix_geq_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">β</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> geq_imp_mix_geq_right<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> geq_imp_mix_geq_right ind rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">β</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> b pmf_inverse_switch_eqals<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sg_imp_mix_sg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> xy_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preference.not_outside rational_preference_def rpr<span class="main">)</span>
      <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preference_def rational_preference_def rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mpf</span> <span class="main">∈</span> <span class="var">?lot</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> mix_pmf_in_lotteries <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">α</span></span><span class="main">]</span> xy_p assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="var">?lot</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span>  independece_dest_alt ind xy_p<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff 
        less_eq_real_def set_pmf_mix_eq xy_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> all2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="var">?lot</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> ind independece_dest_alt xy_p<span class="main">(</span>1<span class="main">)</span> xy_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff 
        less_eq_real_def set_pmf_mix_eq xy_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Continuity ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Continuity is sometimes called Archimedean Axiom›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">continuous_vnm</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">continuous_vnm</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">]</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">]</span> <span class="bound">r</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≈[</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">]</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_vnmD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">r</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≈[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> continuous_vnm_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_vnmI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≽[</span><span class="free">P</span><span class="main">]</span> <span class="bound">r</span> <span class="main">⟹</span> 
    <span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>mix_pmf <span class="bound">α</span> <span class="bound">p</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≈[</span><span class="free">P</span><span class="main">]</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="free">C</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms continuous_vnm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mix_in_lot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> less_eq_real_def mix_pmf_in_lotteries <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">lemma</span></span> non_unique_continuous_unfolding<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> cnt continuous_vnmD assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span><span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="main">⟷</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">q</span> <span class="main">∨</span> <span class="bound">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms rational_preference.compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> preference_def rational_preference_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> continuous_vnmD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ System U start, as per vNM›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ These are the first two assumptions which we use to derive the first results.
       We assume rationality and independence. In this system U the von-Neumann-Morgenstern 
        Utility Theorem is proven. ›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">outcomes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℛ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">≡</span> lotteries_on <span class="free">outcomes</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relation_in_carrier<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> 𝒫 <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> preference_def rational_preference_def rpr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_preferred_independence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ind <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> relation_in_carrier antisym_conv1 assms atLeastAtMost_iff 
      greaterThanAtMost_iff independece_dest_alt pmf_mix_0 
      rational_preference.no_better_thansubset_rel rpr subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_strict_preferred_independence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ind independent_vnmD2 
      independent_vnmD3 relation_in_carrier<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_preferred_independence_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms mix_in_lot relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms mix_in_lot assms<span class="main">(</span>2<span class="main">)</span> relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> ind independent_vnmD3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> x_sg_y_sg_mpmf_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">b</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">b</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms ind rpr sg_imp_mix_sg <span class="quoted">"2"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">b</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> 𝒫"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sg preference_def rational_preference_def rpr<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">b</span> <span class="free">x</span> <span class="free">x</span> <span class="main">∈</span> 𝒫"</span></span>
      <span class="keyword1"><span class="command">using</span></span> relation_in_carrier assms<span class="main">(</span>2<span class="main">)</span> mix_in_lot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> assms<span class="main">(</span>2<span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">b</span> <span class="free">x</span> <span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">b</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mix_pmf_preferred_independence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>›</span></span> greaterThanAtMost_iff greaterThanLessThan_iff ind 
          independece_dest_alt less_eq_real_def preference_def 
          rational_preference.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relation_in_carrier rpr<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> mix_pmf_preferred_independence
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff less_eq_real_def set_pmf_mix_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neumann_3B_b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"preorder_on 𝒫 <span class="free">ℛ</span> <span class="main">∧</span> rational_preference_axioms 𝒫 <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> preference_def rational_preference_def rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff greaterThanLessThan_iff 
        less_eq_real_def pmf_inverse_switch_eqals x_sg_y_sg_mpmf_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neumann_3B_b_non_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="main">(</span><span class="free">u</span><span class="main">::</span><span class="tfree">'a</span> pmf<span class="main">)</span> <span class="free">v</span> <span class="main">=</span> mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="free">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_inverse_switch_eqals assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f2 relation_in_carrier 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mix_pmf_preferred_independence set_pmf_mix_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> greater_mix_pmf_greater_step_1_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">β</span> <span class="free">v</span> <span class="free">u</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">v</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> mix_pmf <span class="free">β</span> <span class="free">v</span> <span class="free">u</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">β</span> <span class="main">*</span> <span class="skolem">γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> greaterThanLessThan_iff 
        mult.commute nonzero_eq_divide_eq not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">γ</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> g greaterThanLessThan_iff 
        less_trans mult.right_neutral mult_less_cancel_left_pos not_le 
        sgn_le_0_iff sgn_pos zero_le_one zero_le_sgn_iff zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t_in<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> <span class="free">v</span> <span class="free">u</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mix_pmf_in_lotteries preference_def rational_preference_def rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="free">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_sg_y_sg_mpmf_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">β</span>"</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff greaterThanAtMost_iff greaterThanLessThan_iff 
        less_eq_real_def pmf_inverse_switch_eqals x_sg_y_sg_mpmf_right<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> ind rpr sg_imp_mix_sg t <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="skolem">γ</span> <span class="skolem">t</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="skolem">γ</span> <span class="skolem">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> 𝒫"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> atLeastAtMost_iff g1 mix_in_lot mix_pmf_in_lotteries 
          not_less order.asym preference_def rational_preference_def rpr t<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">γ</span> <span class="main">(</span>mix_pmf <span class="free">β</span> <span class="free">v</span> <span class="free">u</span><span class="main">)</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> neumann_3B_b<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="skolem">γ</span></span><span class="main">]</span> assms t g1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> greaterThanAtMost_iff greaterThanLessThan_iff 
          ind less_eq_real_def rpr sg_imp_mix_sg<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> product_mix_pmf_prob_distrib<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> <span class="free">v</span> <span class="free">u</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">v</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t_s atLeastAtMost_iff g g1 greaterThanLessThan_iff less_eq_real_def mult.commute t<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ This lemma is in called step 1 in literature. 
In Von Neumann and Morgenstern's book this is A:A (albeit more general) ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_1_most_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">β</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ex<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>m<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">β</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> m
    <span class="keyword1"><span class="command">consider</span></span>  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> ind rpr sg_imp_mix_sg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span><span class="main">/</span><span class="free">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> ind rpr sg_imp_mix_sg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> div_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> mx_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> 𝒫"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sg preference_def rational_preference_def rpr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> y_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> 𝒫"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preference_def rational_preference_def rpr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="var">?d</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> 𝒫"</span></span>
        <span class="keyword1"><span class="command">using</span></span> div_in mx_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix_in_lot<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" mix_pmf <span class="free">β</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">y</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sg_imp_mix_sg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">ℛ</span></span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">β</span></span><span class="main">]</span> sg div_in rpr ind
          a assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2"</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> al1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">y</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atLeastAtMost_iff greaterThanAtMost_iff ind 
            independece_dest_alt preference.not_outside rational_preference_def rpr y_P<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> greater_mix_pmf_greater_step_1_aux assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a div_in divide_less_eq_1_pos greaterThanAtMost_iff 
            greaterThanLessThan_iff mix_pmf_comp_with_dif_equiv neumann_3B_b sg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Kreps refers to this lemma as 5.6 c. 
       The lemma after that is also significant.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> approx_remains_after_same_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> approx_indep_ge assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> ind rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This lemma is the symmetric version of the previous lemma. 
       This lemma is never mentioned in literature anywhere. 
       Even though it looks trivial now, due to the asymmetric nature of the 
       independence axiom, it is not so trivial, and definitely worth mentioning. ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> approx_remains_after_same_comp_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">r</span> <span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">r</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">r</span> <span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mix_in_lot pmf_inverse_switch_eqals 
    rational_preference.compl relation_in_carrier rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">r</span> <span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">r</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> approx_remains_after_same_comp<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">α</span></span><span class="main">]</span> pmf_inverse_switch_eqals<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> 1 
      pmf_inverse_switch_eqals rpr mix_pmf_preferred_independence<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">α</span></span> <span class="main">_</span> <span class="main">_</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mix_pmf_preferred_independence<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_of_preferred_is_preferred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rpr assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> rational_preference.compl relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>3<span class="main">)</span> geq_imp_mix_geq_right ind rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rpr preference.transitivity<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rational_preference_def transE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">p</span>"</span></span>      
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> assms geq_imp_mix_geq_left ind rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rpr preference.transitivity<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rational_preference_def transE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mix_of_not_preferred_is_not_preferred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rpr assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> rational_preference.compl relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> neumann_3B_b_non_strict calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rpr preference.transitivity<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rational_preference_def transE<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> neumann_3B_b_non_strict calculation
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mix_pmf_preferred_independence relation_in_carrier set_pmf_mix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rpr preference.transitivity<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rational_preference_def transE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">degenerate_lotteries</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">degenerate_lotteries</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> 𝒫<span class="main">.</span> card <span class="main">(</span>set_pmf <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">best</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">best</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">worst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">worst</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degenerate_total<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">∀</span><span class="bound">m</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">m</span> <span class="main">∨</span> <span class="bound">m</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degenerate_lotteries_def rational_preference.compl rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> degen_outcome_cardinalities<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card degenerate_lotteries <span class="main">=</span> card <span class="free">outcomes</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_degen_lotteries_equals_outcomes degenerate_lotteries_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> degenerate_lots_subset_all<span class="main">:</span> <span class="quoted"><span class="quoted">"degenerate_lotteries <span class="main">⊆</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degenerate_lotteries_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alt_definition_of_degenerate_lotteries<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">outcomes</span><span class="main">}</span> <span class="main">=</span> degenerate_lotteries"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">outcomes</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">outcomes</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> degenerate_lotteries"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degenerate_lotteries_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">outcomes</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> degenerate_lotteries"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_pmf <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degenerate_lotteries_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a degenerate_lots_subset_all subset_iff support_in_outcomes<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">e</span><span class="main">}</span> <span class="main">=</span> set_pmf <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_1_singletonE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">outcomes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> return_pmf <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>return_pmf <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">outcomes</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> best_indifferent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> best<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> best<span class="main">.</span> <span class="bound">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> best_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> worst_indifferent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> worst<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> worst<span class="main">.</span> <span class="bound">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> worst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> best_worst_indiff_all_indiff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> best"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worst"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> 
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a best_def assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a assms worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
          rational_preference.strict_is_neg_transitive relation_in_carrier rpr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>local.𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rational_preference.compl 
        rational_preference.strict_is_neg_transitive relation_in_carrier rpr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Like Step 1 most general but with IFF. ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mix_pmf_pref_iff_more_likely <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="free">β</span> <span class="main">⟷</span> mix_pmf <span class="free">α</span> <span class="free">b</span> <span class="free">w</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">β</span> <span class="free">b</span> <span class="free">w</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms step_1_most_general<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">β</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_linordered_idom step_1_most_general<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> better_worse_good_mix_preferred<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="free">β</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">b</span> <span class="free">w</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">β</span> <span class="free">b</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> atLeastAtMost_iff 
        less_eq_real_def mix_of_not_preferred_is_not_preferred 
        mix_of_preferred_is_preferred mix_pmf_preferred_independence 
        pmf_mix_0 relation_in_carrier step_1_most_general<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Add finiteness and non emptyness of outcomes ›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_degenerate_lotteries<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite degenerate_lotteries"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degen_outcome_cardinalities fnt nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> degenerate_has_max_preferred<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?DG</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degenerate_lotteries"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="var">?DG</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degenerate_lots_subset_all rational_preference.all_carrier_ex_sub_rel rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="var">?DG</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e'</span> <span class="main">∈</span> <span class="var">?DG</span><span class="main">.</span> <span class="bound">e</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_0_eq degen_outcome_cardinalities 
        finite_degenerate_lotteries fnt nempty subset_eq
        rational_preference.finite_nonempty_carrier_has_maximum <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degenerate_has_min_preferred<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?DG</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degenerate_lotteries"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="var">?DG</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degenerate_lots_subset_all rational_preference.all_carrier_ex_sub_rel rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="var">?DG</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e'</span> <span class="main">∈</span> <span class="var">?DG</span><span class="main">.</span> <span class="bound">e'</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> R<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_0_eq degen_outcome_cardinalities 
        finite_degenerate_lotteries fnt nempty subset_eq
        rational_preference.finite_nonempty_carrier_has_minimum <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_best_degenerate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degenerate_has_max_preferred <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_worst_degenerate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degenerate_has_min_preferred <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> best_degenerate_in_best_overall<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> degenerate_lotteries"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="skolem">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_best_degenerate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">b</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fnt<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> b<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> degenerate_lots_subset_all subset_iff support_in_outcomes<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">b</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b card_1_singletonE degenerate_lotteries_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> return_pmf <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alt_definition_of_degenerate_lotteries b<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="main">⟶</span> return_pmf <span class="skolem">B</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 asm<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmf_mix_induct'<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>degenerate <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> B P_def deg set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def lotteries_on_def mix_of_not_preferred_is_not_preferred
               mix_of_not_preferred_is_not_preferred<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="skolem">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation B P_def set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> b degenerate_lots_subset_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> worst_degenerate_in_worst_overall<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> degenerate_lotteries"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> degenerate_lotteries<span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_worst_degenerate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">b</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fnt<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> b<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> degenerate_lots_subset_all subset_iff support_in_outcomes<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">b</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b card_1_singletonE degenerate_lotteries_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> return_pmf <span class="bound">d</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alt_definition_of_degenerate_lotteries b<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="main">⟶</span> <span class="bound">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> return_pmf <span class="skolem">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 asm<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmf_mix_induct'<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>degenerate <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> B P_def deg set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def lotteries_on_def mix_of_preferred_is_preferred
          mix_of_not_preferred_is_not_preferred<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">e</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation B P_def set_pmf_subset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> b degenerate_lots_subset_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> overall_best_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"best <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> best_def best_degenerate_in_best_overall degenerate_lots_subset_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> overall_worst_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"worst <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degenerate_lots_subset_all worst_def worst_degenerate_in_worst_overall <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> trans_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> preference.indiff_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">ℛ</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> assms rpr rational_preference_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ First EXPLICIT use of the axiom of choice ›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">some_best</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">some_best</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> best<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">some_worst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">some_worst</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> degenerate_lotteries <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> worst<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">my_U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">my_U</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">α</span><span class="main">.</span> <span class="bound">α</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> some_best some_worst<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_best_and_degenerate<span class="main">:</span> <span class="quoted"><span class="quoted">"degenerate_lotteries <span class="main">∩</span> best <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> best_def best_degenerate_in_best_overall degenerate_lots_subset_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> exists_worst_and_degenerate<span class="main">:</span> <span class="quoted"><span class="quoted">"degenerate_lotteries <span class="main">∩</span> worst <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> worst_def worst_degenerate_in_worst_overall degenerate_lots_subset_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> some_best_in_best<span class="main">:</span> <span class="quoted"><span class="quoted">"some_best <span class="main">∈</span> best"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_best_and_degenerate some_best_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_emptyI some_eq_ex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> some_worst_in_worst<span class="main">:</span> <span class="quoted"><span class="quoted">"some_worst <span class="main">∈</span> worst"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_worst_and_degenerate some_worst_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_emptyI some_eq_ex<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> best_always_at_least_as_good_mix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> some_best <span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> best_def mix_of_preferred_is_preferred 
    rational_preference.compl rpr some_best_in_best <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> geq_mix_imp_weak_pref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">β</span> some_best some_worst"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> best_def some_best_in_best some_worst_in_worst worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span> <span class="main">-</span> <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_mix_pmf_indiff_indiff_best_worst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> best"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">α</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">l</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">b</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms best_worst_indiff_all_indiff<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mix_of_preferred_is_preferred
      best_worst_indiff_all_indiff<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mix_of_not_preferred_is_not_preferred<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> indiff_imp_same_utility_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> some_best some_worst <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> some_best some_worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> linorder_neqE_linordered_idom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> leq_mix_imp_weak_inferior<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> some_best some_worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">≥</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> some_best some_worst <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> some_best some_worst <span class="main">⟹</span> <span class="free">α</span> <span class="main">≤</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> indiff_imp_same_utility_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> some_best some_worst"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"mix_pmf <span class="free">β</span> some_best some_worst <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> some_best some_worst"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> geq_mix_imp_weak_pref le_cases *<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ge_mix_pmf_preferred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="free">β</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Add continuity to assumptions ›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ In Literature this is referred to as step 2. ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> step_2_unique_continuous_unfolding<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">α</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> neg_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄!</span><span class="bound">α</span><span class="main">.</span> <span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_unique_continuous_unfolding<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">ℛ</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> 
      assms cnt rpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
    a_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">β</span> <span class="free">p</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">≠</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neg_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">&gt;</span> <span class="skolem">β</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">&gt;</span> <span class="skolem">α</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_b <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> step_1_most_general<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="skolem">α</span></span> <span class="quoted"><span class="skolem">β</span></span><span class="main">]</span> assms 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">β</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_b<span class="main">(</span>1<span class="main">)</span> a_b<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rational_preference.strict_is_neg_transitive relation_in_carrier rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">with</span></span> step_1_most_general<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="skolem">β</span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">β</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span>mix_pmf <span class="skolem">α</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_b<span class="main">(</span>1<span class="main">)</span> a_b<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rational_preference.strict_is_neg_transitive relation_in_carrier rpr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ These folowing two lemmas are referred to sometimes called step 2. ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> create_unique_indiff_using_distinct_best_worst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> best"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">α</span></span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">l</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">b</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">l</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> best_def
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> worst_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">α</span></span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">l</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">b</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_2_unique_continuous_unfolding<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_element_bw_mix_is_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> best"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">l</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> <span class="free">b</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> best_def worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> create_unique_indiff_using_distinct_best_worst assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_mix_pmf_indiff_indiff_best_worst assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> my_U_is_defined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">∈</span> best"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_best_in_best<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"some_worst <span class="main">∈</span> worst"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_worst_in_worst<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> exists_element_bw_mix_is_approx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"some_best"</span></span> <span class="quoted"><span class="quoted">"some_worst"</span></span><span class="main">]</span> calculation assms
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="bound">α</span> some_best some_worst"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> my_U_def someI_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> e my_U_def someI_ex<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> weak_pref_mix_with_my_U_weak_pref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms my_U_is_defined<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> relation_in_carrier rpr 
      rational_preference.weak_is_transitive<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_greater_my_U<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">=</span> my_U <span class="free">q</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&lt;</span> my_U <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation geq_mix_imp_weak_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> geq_my_U_imp_weak_preference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">≥</span> my_U <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p_q<span class="main">:</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> ge_mix_pmf_preferred<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"some_best"</span></span> <span class="quoted"><span class="quoted">"some_worst"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span>"</span></span><span class="main">]</span> 
    p_q assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">=</span> my_U <span class="free">q</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_q<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rational_preference.compl 
          rpr step_1_most_general weak_pref_mix_with_my_U_weak_pref<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> my_U_is_defined<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> trans_approx<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> my_U_represents_pref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> my_U <span class="free">p</span> <span class="main">≥</span> my_U <span class="free">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p_def<span class="main">:</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> weak_pref_mix_with_my_U_weak_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">using</span></span> leq_mix_imp_weak_inferior<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span>"</span></span><span class="main">]</span> p_def a
        assms<span class="main">(</span>1<span class="main">)</span> leq_mix_imp_weak_inferior <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">using</span></span> geq_my_U_imp_weak_preference
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> first_iff_u_greater_strict_preff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span> <span class="main">⟷</span> mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">&gt;</span> my_U <span class="free">q</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> preferred_greater_my_U<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> assms a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> second_iff_calib_mix_pref_strict_pref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst <span class="main">⟷</span> <span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> geq_my_U_imp_weak_preference 
      leq_mix_imp_weak_inferior weak_pref_mix_with_my_U_weak_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"my_U <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> some_best some_worst <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> some_best some_worst"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> leq_mix_imp_weak_inferior my_U_represents_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> my_U_is_linear_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"my_U <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> my_U <span class="free">p</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> my_U <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> some_best"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">=</span> some_worst"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Up</span></span> <span class="keyword2"><span class="keyword">where</span></span> Up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Up</span> <span class="main">=</span> my_U <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Uq</span></span> <span class="keyword2"><span class="keyword">where</span></span> Uq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Uq</span> <span class="main">=</span> my_U <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> long_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Up</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Up my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Uq</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Uq my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Up</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> mult_le_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_le_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">α</span>"</span></span> <span class="quoted"><span class="skolem">Uq</span></span><span class="main">]</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> add_nonneg_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span>"</span></span><span class="main">]</span> 
        convex_bound_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Up</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">Uq</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="free">α</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main">]</span> B W Up <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="main">(</span>mix_pmf <span class="skolem">Uq</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms my_U_is_defined<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main">]</span> B W Uq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> mix_pmf_preferred_independence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="skolem">Uq</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">=</span> 
            mix_pmf <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mixPQ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set_pmf <span class="var">?L</span><span class="main">.</span> pmf <span class="main">(</span><span class="var">?L</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> pmf <span class="var">?mixPQ</span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> 
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set_pmf <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="var">?L</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> pmf <span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">+</span> 
        pmf <span class="main">(</span>mix_pmf <span class="skolem">Uq</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">-</span> <span class="free">α</span> <span class="main">*</span> pmf <span class="main">(</span>mix_pmf <span class="skolem">Uq</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> pmf_mix_deeper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mix_pmf <span class="skolem">Uq</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">*</span> pmf <span class="skolem">B</span> <span class="skolem">e</span> <span class="main">+</span> <span class="free">α</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">-</span> <span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">+</span> <span class="skolem">Uq</span> <span class="main">*</span> pmf <span class="skolem">B</span> <span class="skolem">e</span> <span class="main">+</span> 
        pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">-</span> <span class="skolem">Uq</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">-</span> <span class="free">α</span> <span class="main">*</span> <span class="skolem">Uq</span> <span class="main">*</span> pmf <span class="skolem">B</span> <span class="skolem">e</span> <span class="main">-</span> <span class="free">α</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">+</span> <span class="free">α</span> <span class="main">*</span> <span class="skolem">Uq</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> left_diff_distrib' pmf_mix_deeper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Up</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">W</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> pmf_mix_deeper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Uq</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">W</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span>
          assms Up Uq my_U_is_defined<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> j4<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="var">?mixPQ</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span> <span class="main">*</span> pmf <span class="skolem">B</span> <span class="skolem">e</span> <span class="main">+</span> 
        pmf <span class="skolem">W</span> <span class="skolem">e</span> <span class="main">-</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span> <span class="main">*</span> pmf <span class="skolem">W</span> <span class="skolem">e</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> pmf_mix_deeper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">W</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> long_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="var">?L</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> pmf <span class="var">?mixPQ</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i1 i3 mult.commute right_diff_distrib' ring_class.ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pmf_equiv_intro1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="main">(</span>mix_pmf <span class="skolem">Up</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> approx_remains_after_same_comp_left assms<span class="main">(</span>3<span class="main">)</span> mp_in snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="free">α</span> <span class="main">(</span>mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Up Uq f2 trans_approx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="free">α</span> <span class="main">(</span>mix_pmf <span class="main">(</span>my_U <span class="free">p</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">(</span>mix_pmf <span class="main">(</span>my_U <span class="free">q</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">W</span><span class="main">)</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Up Uq ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"my_U <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> <span class="skolem">Up</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Uq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * B W assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> indiff_imp_same_utility_value long_in 
        my_U_is_defined<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> my_U_is_defined<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> my_U_represents_pref relation_in_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Up Uq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Now we define a more general Utility 
       function that also takes the degenerate case into account ›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">general_U</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">general_U</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> some_best <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> some_worst <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> my_U <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> general_U_is_linear_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"general_U <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> <span class="main">(</span>general_U <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>general_U <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"some_best <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
    <span class="keyword1"><span class="command">using</span></span> best_def some_best_in_best some_worst_in_worst worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> general_U_def my_U_is_linear_function <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> general_U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> general_U_ordinal_Utility<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ordinal_utility 𝒫 <span class="free">ℛ</span> general_U"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"some_best <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
    <span class="keyword1"><span class="command">using</span></span> best_def some_best_in_best some_worst_in_worst worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>general_U <span class="skolem">y</span> <span class="main">≤</span> general_U <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 my_U_represents_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> general_U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"general_U <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"general_U <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b general_U_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> best_worst_indiff_all_indiff<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
          some_best_in_best some_worst_in_worst trans_approx<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span>general_U <span class="skolem">y</span> <span class="main">≤</span> general_U <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> general_U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹  Proof of the linearity of general-U. 
        If we consider the definition of expected utility 
        functions from Maschler, Solan, Zamir we are done. ›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="bound">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">u</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"general_U"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"some_best <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"some_best <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> some_worst"</span></span>
    <span class="keyword1"><span class="command">using</span></span> best_def some_best_in_best some_worst_in_worst worst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">(</span>mix_pmf <span class="free">α</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> <span class="var">?u</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="var">?u</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> general_U_def my_U_is_linear_function <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> general_U_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Now I define a Utility function that assigns a utility to all outcomes. 
       These are only finitely many ›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ocU</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ocU</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> general_U <span class="main">(</span>return_pmf <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> geral_U_is_expected_value_of_ocU<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"general_U <span class="free">p</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> ocU"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fnt assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmf_mix_induct'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mix <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"general_U <span class="main">(</span>mix_pmf <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> general_U <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> general_U <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> general_U_is_linear_function<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> mix.hyps assms lotteries_on_def mix.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">p</span> ocU <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">q</span> ocU"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mix.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mix.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> ocU"</span></span>
    <span class="keyword1"><span class="command">using</span></span> general_U_is_linear_function expected_value_mix_pmf_distrib fnt infinite_super mix.hyps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fnt mix.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mix.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_in_outcomes assms fnt integral_measure_pmf_real ocU_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_utility_expected_value<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ordinal_utility 𝒫 <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> ocU<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ocs<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">y</span> <span class="main">⊆</span> <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"1"</span> subsetI support_in_outcomes<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">(</span>measure_pmf.expectation <span class="skolem">y</span> ocU <span class="main">≤</span> measure_pmf.expectation <span class="skolem">x</span> ocU<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"general_U <span class="skolem">x</span> <span class="main">≥</span> general_U <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span>›</span></span> general_U_ordinal_Utility ordinal_utility_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>measure_pmf.expectation <span class="skolem">y</span> ocU <span class="main">≤</span> measure_pmf.expectation <span class="skolem">x</span> ocU<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> geral_U_is_expected_value_of_ocU ocs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>measure_pmf.expectation <span class="skolem">y</span> ocU <span class="main">≤</span> measure_pmf.expectation <span class="skolem">x</span> ocU<span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>measure_pmf.expectation <span class="skolem">y</span> ocU <span class="main">≤</span> measure_pmf.expectation <span class="skolem">x</span> ocU<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"general_U <span class="skolem">x</span> <span class="main">≥</span> general_U <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  geral_U_is_expected_value_of_ocU ocs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ocs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> general_U_ordinal_Utility ordinal_utility.util_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> relation_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordinal_utility_expected_value'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility 𝒫 <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordinal_utility_expected_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ocU_is_expected_utility_bernoulli<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> 𝒫<span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="bound">y</span> <span class="main">⟷</span> 
  measure_pmf.expectation <span class="bound">x</span> ocU <span class="main">≥</span> measure_pmf.expectation <span class="bound">y</span> ocU"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordinal_utility_expected_value <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ordinal_utility.util_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* continuous *)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="comment1">(* finite outcomes *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* system U *)</span>


<span class="keyword1"><span class="command">lemma</span></span> expected_value_is_utility_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">x</span> <span class="free">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="free">y</span> <span class="free">u</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> ordinal_utility.util_def_conf 
    ordinal_utility.ordinal_utility_left iffI  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> system_U_implies_vNM_utility<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rpr<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordinal_utility_expected_value'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> vNM_utility_implies_rationality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> ordinal_util_imp_rat_prefs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> vNM_utility_implies_independence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> independent_vnmI2<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>  <span class="skolem">q</span> <span class="skolem">r</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">α</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_lots<span class="main">:</span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> a1 a3 a4 mix_in_lot <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> a2 a3 a4 mix_in_lot <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> fnts<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_pmf <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 a2 a3 fnt infinite_super lotteries_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    u<span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span> <span class="main">⟹</span> mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> u a1 a2 ordinal_utility.util_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> 
        <span class="skolem">α</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> expected_value_mix_pmf_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">α</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> assms fnts a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> 
        <span class="skolem">α</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> expected_value_mix_pmf_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">α</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> assms fnts a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">using</span></span> a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> u ordinal_utility_expected_value' ocU_is_expected_utility_bernoulli in_lots
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_lots ordinal_utility_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ordinal_utility.ordinal_utility_left u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> 
        <span class="skolem">α</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> expected_value_mix_pmf_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">α</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> assms fnts a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> 
        <span class="skolem">α</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> expected_value_mix_pmf_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">α</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> assms fnts a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">using</span></span> a4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 a2 ordinal_utility.util_def_conf u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span> <span class="main">=</span> mix_pmf <span class="skolem">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> mix_pmf <span class="skolem">α</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_weight_for_equality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≥</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">e</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="bound">e</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">e</span> <span class="main">*</span> <span class="free">c</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> closed_segment <span class="free">a</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_segment_eq_real_ivl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vNM_utilty_implies_continuity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_vnmI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span> "</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ordinal_utility.util_imp_trans transD<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    u<span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> geqa<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span>"</span></span> 
    <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a4 u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ordinal_utility.ordinal_utility_left<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> fnts<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 a2 a3 fnt infinite_super lotteries_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≻[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">r</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> mix_pmf <span class="bound">α</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> a1 a2 a3 a b ordinal_utility.util_def_conf u <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> geqa a b c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
      e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_weight_for_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="skolem">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">*</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> expected_value_mix_pmf_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">-</span><span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> fnts <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span>  measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> expected_value_is_utility_function<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">e</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="free">ℛ</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> *
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mix_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">∈</span> 𝒫 <span class="free">outcomes</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">-</span> <span class="skolem">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>›</span></span> a1 a3 mix_in_lot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f a2 ordinal_utility.util_def u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_weight_for_equality expected_value_mix_pmf_distrib * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≈[</span><span class="free">ℛ</span><span class="main">]</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"2"</span> a4 assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ordinal_utility.util_imp_trans transD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Von_Neumann_Morgenstern_Utility_Theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> 
         independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> 
         continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">⟷</span> 
   <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vNM_utility_implies_independence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span> 
    system_U_implies_vNM_utility<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
    vNM_utilty_implies_continuity<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span>
    ordinal_util_imp_rat_prefs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">outcomes</span>"</span></span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Expected_Utility">
<div class="head">
<h1>Theory Expected_Utility</h1>
</div>
<pre class="source"><span class="comment1">(* License: LGPL *)</span>

<span class="keyword1"><span class="command">theory</span></span> Expected_Utility
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Neumann_Morgenstern_Utility_Theorem.html">Neumann_Morgenstern_Utility_Theorem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Definition of vNM-utility function ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We define a version of the vNM Utility function using the locale mechanism. 
       Currently this definition and system U have no proven relation yet. ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Important: u is actually not the von Neuman Utility Function, 
       but a Bernoulli Utility Function. The Expected value p 
       given u is the von Neumann Utility Function. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> vNM_utility <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">outcomes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf relation"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">relation</span> <span class="main">⊆</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span> <span class="main">×</span> lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span>  <span class="bound">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span> <span class="main">⟹</span> 
                  <span class="bound">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span> <span class="main">⟹</span> 
        <span class="bound">p</span> <span class="main">≽[</span><span class="free">relation</span><span class="main">]</span> <span class="bound">q</span> <span class="main">⟷</span> measure_pmf.expectation <span class="bound">p</span> <span class="free">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="bound">q</span> <span class="free">u</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vNM_utilityD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">relation</span> <span class="main">⊆</span> <span class="main">(</span>lotteries_on <span class="free">outcomes</span> <span class="main">×</span> lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span> <span class="main">⟹</span> 
    <span class="free">p</span> <span class="main">≽[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="free">q</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vNM_utility_axioms vNM_utility_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms contra_subsetD mem_Sigma_iff vNM_utility_axioms vNM_utility_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mem_Sigma_iff subsetCE vNM_utility_axioms vNM_utility_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> utility_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="free">q</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms vNM_utility_axioms vNM_utility_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> not_outside<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_outside<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* vNM_Utility *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> vNM_utility <span class="main">⊆</span> ordinal_utility <span class="quoted"><span class="quoted">"<span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">relation</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> measure_pmf.expectation <span class="bound">p</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> not_outside<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_outside<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> vNM_utility_axioms vNM_utility_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> vNM_utility
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_preference_iff_strict_utility<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> 
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">&gt;</span> measure_pmf.expectation <span class="free">q</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_eq_real_def not_le util_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_distrib_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span>  <span class="free">u</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">z</span> <span class="main">*</span>  <span class="free">u</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pmf_util_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="free">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Finite outcomes ›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_equals_pmf_expectation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vNM_utilityD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fnt<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> support_in_outcomes assms fnt integral_measure_pmf_real
      sum_pmf_util_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> real_scaleR_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> expected_utility_weak_preference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_equals_pmf_expectation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
        sum_equals_pmf_expectation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
   vNM_utility_def assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> util_def_conf <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_leq_zero_weak_preference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> diff_le_0_iff_le
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> expected_utility_weak_preference<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expected_utility_strict_preference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">&gt;</span> measure_pmf.expectation <span class="free">q</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms expected_utility_weak_preference less_eq_real_def not_le
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> util_def_conf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scale_pos_left<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vNM_utility <span class="free">outcomes</span> <span class="free">relation</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> vNM_utility_axioms vNM_utility_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fnt <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span>measure_pmf.expectation <span class="skolem">q</span> <span class="free">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="skolem">p</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> expected_utility_weak_preference<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> dist_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_distrib_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> dist_c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_distrib_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽</span> <span class="skolem">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="skolem">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> utility_ge
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">)</span> sum_equals_pmf_expectation <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> dist_c dist_c'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">q</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>1<span class="main">)</span> mult_le_cancel_iff2 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_c dist_c'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≽</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">)</span> assms <span class="quoted">"2"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * sum_equals_pmf_expectation<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">outcomes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_equals_pmf_expectation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
    sum_equals_pmf_expectation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> strict_prefernce_iff_strict_utility
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_alt_def_utility_g<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≻[</span><span class="free">relation</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms not_outside<span class="main">(</span>1<span class="main">)</span> not_outside<span class="main">(</span>2<span class="main">)</span> strict_alt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* finite outcomes *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Definition of vNM Utility Function as locale *)</span>

<span class="keyword1"><span class="command">lemma</span></span> vnm_utility_is_ordinal_utility<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vNM_utility <span class="free">outcomes</span> <span class="free">relation</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ordinal_utility <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">relation</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> measure_pmf.expectation <span class="bound">p</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms vNM_utility_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms vNM_utility.not_outside<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms vNM_utility.not_outside<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vnm_utility_imp_reational_prefs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vNM_utility <span class="free">outcomes</span> <span class="free">relation</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">relation</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms vNM_utility.not_outside<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms vNM_utility.not_outside<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">relation</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ordinal_utility.util_imp_trans vnm_utility_is_ordinal_utility <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">relation</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms order_refl refl_on_def vNM_utility_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> preorder_on_def t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total_on <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">relation</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ordinal_utility.util_imp_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">outcomes</span>"</span></span> 
        <span class="quoted"><span class="free">relation</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">z</span><span class="main">∈</span><span class="free">outcomes</span><span class="main">.</span> <span class="main">(</span>pmf <span class="bound">p</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      assms vnm_utility_is_ordinal_utility
    <span class="keyword1"><span class="command">using</span></span> ordinal_utility.util_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> expected_utilty_theorem_form_vnm_utility<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fnt<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">outcomes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outcomes</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> 
         independent_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> 
         continuous_vnm <span class="main">(</span>lotteries_on <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">⟷</span> 
         <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> vNM_utility <span class="free">outcomes</span> <span class="free">ℛ</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> independent_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> continuous_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Von_Neumann_Morgenstern_Utility_Theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">outcomes</span></span> <span class="quoted"><span class="free">ℛ</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> ordinal_utility <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    u<span class="main">:</span> <span class="quoted"><span class="quoted">"ordinal_utility <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure_pmf.expectation <span class="bound">x</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vNM_utility <span class="free">outcomes</span> <span class="free">ℛ</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u ordinal_utility.relation_subset_crossp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> expected_value_is_utility_function fnt u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> vNM_utility <span class="free">outcomes</span> <span class="free">ℛ</span> <span class="bound">u</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> vNM_utility <span class="free">outcomes</span> <span class="free">ℛ</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vnm_utility_imp_reational_prefs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fnt vNM_utility_implies_independence vnm_utility_is_ordinal_utility<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fnt vNM_utilty_implies_continuity vnm_utility_is_ordinal_utility<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rational_preference <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> independent_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span> <span class="main">∧</span> continuous_vnm <span class="main">(</span>𝒫 <span class="free">outcomes</span><span class="main">)</span> <span class="free">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>