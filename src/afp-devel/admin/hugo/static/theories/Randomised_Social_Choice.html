<div id="Order_Predicates">
<div class="head">
<h1>Theory Order_Predicates</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Order_Predicates.thy
  Author:   Manuel Eberl, TU München

  Locales for order relations modelled as predicates (as opposed to sets of pairs).
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Order Relations as Binary Predicates›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Order_Predicates
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Permutations.html">HOL-Library.Permutations</a>"</span>
  <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Operations on Relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type of binary relations›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> relation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_relation</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict_relation</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_relation_restrict_relation <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_relation <span class="free">A</span> <span class="main">(</span>restrict_relation <span class="free">B</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> restrict_relation <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_relation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_relation_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_relation <span class="main">{}</span> <span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_relation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_relation_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_relation UNIV <span class="free">R</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_relation_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preorders›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preorders are reflexive and transitive binary relations.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> preorder_on <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">carrier</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> relation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_outside<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_outside refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> preorder_on_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"preorder_on <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">f</span> <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_outside <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def refl <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> preorder_on_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"preorder_on <span class="main">(</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>restrict_relation <span class="free">A</span> <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_relation_def refl <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans not_outside<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preorder_on_restrict_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span> <span class="main">⟹</span> preorder_on <span class="free">A</span> <span class="main">(</span>restrict_relation <span class="free">A</span> <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> preorder_on_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_relation_carrier <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_relation <span class="free">carrier</span> <span class="free">le</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_outside <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_relation_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Total preorders›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Total preorders are preorders where any two elements are comparable.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> total_preorder_on <span class="main">=</span> preorder_on <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">le</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> total_preorder_on_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"total_preorder_on <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">f</span> <span class="free">le</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> preorder_on <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="free">f</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preorder_on_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_relation_def total<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total_preorder_on_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"total_preorder_on <span class="main">(</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>restrict_relation <span class="free">A</span> <span class="free">le</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> preorder_on <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"restrict_relation <span class="free">A</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> preorder_on_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> total <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_relation_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total_preorder_on_restrict_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span> <span class="main">⟹</span> total_preorder_on <span class="free">A</span> <span class="main">(</span>restrict_relation <span class="free">A</span> <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total_preorder_on_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some fancy notation for order relations›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">weakly_preferred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≼[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>10<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≼[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strongly_preferred</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≺[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>10<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≺[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indifferent</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>10<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">∼[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">weakly_not_preferred</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≽[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>10<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≽[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≽[</span><span class="free">R</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≼[</span><span class="free">R</span><span class="main">]</span> <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">strongly_not_preferred</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≻[</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>51<span class="main">,</span>10<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≻[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≺[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strongly_preferred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_strict_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strongly_preferred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_weak_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strongly_preferred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> total_preorder_on<span class="main">)</span> not_weakly_preferred_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">a</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> total_preorder_on<span class="main">)</span> not_strongly_preferred_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">a</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Orders›</span></span>

<span class="keyword1"><span class="command">locale</span></span> order_on <span class="main">=</span> preorder_on <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> antisymmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">le</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> linorder_on <span class="main">=</span> order_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="main">+</span> total_preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">carrier</span> <span class="free">le</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maximal elements›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Maximal elements are elements in a preorder for which there exists no strictly greater element.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Max_wrt_among</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Max_wrt_among</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict_relation <span class="free">A</span> <span class="free">R</span> <span class="main">=</span> restrict_relation <span class="free">A</span> <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">R</span> <span class="free">A</span> <span class="main">=</span> Max_wrt_among <span class="free">R'</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="free">R'</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_relation_def fun_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Max_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Max_wrt</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> Max_wrt_among <span class="free"><span class="bound"><span class="entity">R</span></span></span> UNIV"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_wrt <span class="free">R</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_def Max_wrt_among_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_preorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_def <span class="keyword1"><span class="command">using</span></span> not_outside refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_preorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt <span class="free">le</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_altdef <span class="keyword1"><span class="command">using</span></span> not_outside refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_preorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt <span class="free">le</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_preorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="free">carrier</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">∩</span> <span class="free">carrier</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∩</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> A_def<span class="main">]</span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟹</span> <span class="free">le</span> <span class="skolem">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">le</span> <span class="bound">z</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def Max_wrt_among_preorder Int_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">carrier</span> <span class="main">⟹</span> Max_wrt <span class="free">le</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_wrt_among_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_wrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_map_relation_vimage<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">⊆</span> Max_wrt_among <span class="main">(</span>map_relation <span class="free">f</span> <span class="free">le</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_wrt_among_def map_relation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_map_relation_vimage<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> Max_wrt <span class="free">le</span> <span class="main">⊆</span> Max_wrt <span class="main">(</span>map_relation <span class="free">f</span> <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_wrt_altdef map_relation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_subset_vimage_the_inv_into<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">B</span> <span class="main">⊆</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_f_f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_map_relation_bij_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">⊆</span> 
             Max_wrt_among <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Max_wrt_among_map_relation_vimage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inv <span class="free">f</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv inv_inv_eq bij_vimage_eq_inv_image<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_map_relation_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">=</span> Max_wrt_among <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI Max_wrt_among_map_relation_bij_subset assms<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> preorder_on <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preorder_on_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inv <span class="free">f</span>"</span></span><span class="main">]</span> assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv bij_vimage_eq_inv_image inv_inv_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_preorder R.Max_wrt_among_preorder 
    <span class="keyword1"><span class="command">using</span></span> assms bij_is_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def inv_f_f image_Int <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_map_relation_bij<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> Max_wrt <span class="free">le</span> <span class="main">=</span> Max_wrt <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> preorder_on <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preorder_on_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inv <span class="free">f</span>"</span></span><span class="main">]</span> bij
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv bij_vimage_eq_inv_image inv_inv_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bij <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R.Max_wrt_preorder Max_wrt_preorder
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def inv_f_f bij_is_inj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_outside <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_wrt_among_preorder <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Max_wrt <span class="free">le</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> Max_wrt <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_def <span class="keyword1"><span class="command">using</span></span> Max_wrt_among_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span> total_preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_total_preorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span> <span class="main">∩</span> <span class="free">A</span><span class="main">.</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_preorder <span class="keyword1"><span class="command">using</span></span> total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_total_preorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt <span class="free">le</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_preorder <span class="keyword1"><span class="command">using</span></span> total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> decompose_Max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> Max_wrt_among <span class="free">le</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"restrict_relation <span class="free">A</span> <span class="free">le</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∉</span> <span class="free">M</span> <span class="main">∧</span> restrict_relation <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def Max_wrt_among_total_preorder 
                            restrict_relation_def Int_absorb1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak rankings›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">of_weak_ranking</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set list <span class="main">⇒</span> <span class="tfree">'alt</span> relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> 
     <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≽[</span><span class="free">of_weak_ranking</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Nil' <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">[]</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Cons <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≽[</span>of_weak_ranking <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≽[</span>of_weak_ranking <span class="free">zs</span><span class="main">]</span> <span class="free">y</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> of_weak_ranking.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_conv_nth<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">z</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="free">y</span> <span class="free">x</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">zs</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">zs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">zs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_indifference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Cons<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_relation <span class="free">f</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(-`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_relation_def of_weak_ranking_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_permute'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_relation <span class="free">f</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="free">f</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(-`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_weak_ranking_map<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(-`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_vimage_eq_inv_image permutes_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_weak_ranking_permute'<span class="main">[</span><span class="operator">OF</span> permutes_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_inv_eq permutes_bij<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_weak_ranking</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_weak_ranking</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">{}</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_finite_weak_ranking</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_finite_weak_ranking</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> is_weak_ranking <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> finite <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_ranking</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> relation <span class="main">⇒</span> <span class="tfree">'alt</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_ranking</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">xs</span><span class="main">.</span> is_weak_ranking <span class="bound">xs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> of_weak_ranking <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_rankingI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span> 
     
<span class="keyword1"><span class="command">lemma</span></span> is_weak_rankingD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span> <span class="main">⟷</span> distinct <span class="free">xs</span> <span class="main">∧</span> disjoint <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def is_weak_ranking_def set_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> distinct_conv_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_weak_rankingD wf<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> wf ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_weak_ranking_nonempty wf<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"disjoint <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_weak_rankingI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def distinct_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_rev <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_map_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_iff distinct_map inj_on_image disjoint_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_rev <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟷</span> of_weak_ranking <span class="free">xs</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> of_weak_ranking.cases<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> diff_le_mono2<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_finite_weak_ranking_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_Cons_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_weak_ranking <span class="main">(</span><span class="main">{}</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_finite_weak_ranking_Cons_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_finite_weak_ranking <span class="main">(</span><span class="main">{}</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_finite_weak_ranking_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> 
      is_weak_ranking <span class="free">xs</span> <span class="main">∧</span> is_weak_ranking <span class="free">ys</span> <span class="main">∧</span>
      <span class="main">(</span>set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_weak_ranking_iff<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> disjointD disjoint_unionD1 disjoint_unionD2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> disjoint_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_Cons <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> 
      <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> is_weak_ranking <span class="free">xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_weak_ranking_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_finite_weak_ranking_Cons <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> 
      <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="free">x</span> <span class="main">∧</span> is_finite_weak_ranking <span class="free">xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def is_weak_ranking_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_weak_ranking_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_weak_ranking_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_weak_ranking_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
       <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">is_weak_ranking_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking_aux <span class="free">A</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_weak_ranking_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span> <span class="main">⟷</span> is_weak_ranking_aux <span class="main">{}</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> is_weak_ranking_aux<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> 
             find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≥</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms 
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_index_less_size_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> nth_find_index<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> A B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_weak_ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> ij <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≥</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≥</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this A<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> B<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_weak_ranking.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">lemma</span></span> total_preorder_of_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">A</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> of_weak_ranking.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">insert</span> ij<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> of_weak_ranking.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="skolem"><span class="skolem">k</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> j'k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ij j'k is_weak_rankingD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="free">xs</span><span class="main">]</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_relation_of_weak_ranking_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span><span class="free">A</span> <span class="main">#</span> <span class="free">As</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"restrict_relation <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="free">A</span> <span class="main">#</span> <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="free">As</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R.not_outside
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_relation_def of_weak_ranking_Cons
                     is_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">lemmas</span></span> of_weak_ranking_wf <span class="main">=</span> 
  total_preorder_of_weak_ranking is_weak_ranking_code insert_commute


<span class="comment1">(* Test *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">::</span>nat<span class="main">}</span> <span class="main">(</span>of_weak_ranking <span class="main">[</span><span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">2</span><span class="main">}</span><span class="main">,</span><span class="main">{</span><span class="numeral">4</span><span class="main">}</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_wf<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> R<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_imp_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Cons'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∨</span> <span class="main">(</span><span class="free">a</span> <span class="main">∉</span> <span class="free">x</span> <span class="main">∧</span> of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> wf of_weak_ranking_imp_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∨</span>  <span class="free">a</span> <span class="main">∉</span> <span class="free">x</span> <span class="main">∧</span> of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons of_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∉</span> <span class="free">x</span> <span class="main">∧</span> of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_of_weak_ranking_Cons1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.Max_wrt_among_total_preorder
          R'.Max_wrt_among_total_preorder of_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_of_weak_ranking_Cons2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> wf R'.not_outside<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.Max_wrt_among_total_preorder is_weak_ranking_Cons
          R'.Max_wrt_among_total_preorder of_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_among_of_weak_ranking_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_wrt_among_of_weak_ranking_Cons1 Max_wrt_among_of_weak_ranking_Cons2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_of_weak_ranking_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_wrt <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons Max_wrt_def Max_wrt_among_of_weak_ranking_Cons<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_of_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max_wrt <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> hd <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_wrt_def Max_wrt_among_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_wrt_of_weak_ranking_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">locale</span></span> finite_total_preorder_on <span class="main">=</span> total_preorder_on <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_carrier <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">carrier</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_total_preorder_on_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">f</span> <span class="free">le</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="free">f</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> total_preorder_on_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">weak_ranking_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_ranking_aux</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">weak_ranking_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>
     Max_wrt_among <span class="free">le</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#</span> <span class="free">weak_ranking_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free">carrier</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">weak_ranking_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> undefined"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure card"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_nonempty Max_wrt_among_subset<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="var">?B</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="var">?B</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_aux_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking_aux <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_ranking_aux.induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> empty nonempty<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nonempty <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Max_wrt_among_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_aux_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span> <span class="main">⟹</span> is_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_ranking_aux.induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> empty nonempty<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nonempty <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>Max_wrt_among <span class="free">le</span> <span class="skolem">A</span> <span class="main">#</span> weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_weak_ranking_Cons
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonempty.prems nonempty.hyps <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_nonempty<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> nonempty.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonempty.IH<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> nonempty.prems nonempty.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_nonempty<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nonempty.prems 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_aux_Union<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> nonempty.prems nonempty.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>    

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_weak_ranking_aux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> restrict_relation <span class="free">A</span> <span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_ranking_aux.induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> empty nonempty<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nonempty <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> Max_wrt_among <span class="free">le</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> nonempty.prems nonempty.hyps <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty.prems <span class="keyword1"><span class="command">have</span></span> in_MD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> M_def Max_wrt_among_total_preorder
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty.prems <span class="keyword1"><span class="command">have</span></span> in_MI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> M_def Max_wrt_among_total_preorder
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_absorb1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nonempty.prems nonempty.hyps
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> 
                restrict_relation <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">M</span><span class="main">)</span> <span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="skolem">M</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nonempty.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty.prems 
    <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking weak_ranking_aux_wf weak_ranking_aux_Union<span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> nonempty.prems nonempty.hyps M weak_ranking_aux_Union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span> R'.not_outside<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">M</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_relation_def of_weak_ranking_Cons IH M_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_MD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_MI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_weak_ranking_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">carrier</span><span class="main">)</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">carrier</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> weak_ranking_aux_wf<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">carrier</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking weak_ranking_aux_wf weak_ranking_aux_Union<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_aux_Union<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">carrier</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> of_weak_ranking_weak_ranking_aux'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> R.not_outside <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking_aux <span class="free">carrier</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> not_outside False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_aux_unique'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">As</span>"</span></span>
          <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">As</span> <span class="main">=</span> restrict_relation <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="free">le</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="main">=</span> weak_ranking_aux <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_relation <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> restrict_relation_of_weak_ranking_Cons Cons.prems<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span> <span class="main">=</span> restrict_relation <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">le</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="skolem">As</span> <span class="main">=</span> restrict_relation <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"weak_ranking_aux <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">As</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sym <span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.IH<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
       Max_wrt_among <span class="main">(</span>of_weak_ranking <span class="main">(</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_wrt_among_of_weak_ranking_Cons2<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> Max<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">le</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking_aux <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">#</span> weak_ranking_aux <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">As</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking_aux <span class="main">…</span> <span class="main">=</span> <span class="skolem">As</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_aux_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">As</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">As</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="main">=</span> weak_ranking_aux <span class="free">carrier</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> total_preorder_of_weak_ranking assms<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> R.not_outside not_outside R.refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="main">=</span> weak_ranking_aux <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">As</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_aux_unique'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_total_preorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> weak_ranking_aux_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">carrier</span></span><span class="main">]</span> of_weak_ranking_weak_ranking_aux
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> is_weak_ranking <span class="bound">x</span> <span class="main">∧</span> <span class="free">le</span> <span class="main">=</span> of_weak_ranking <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">∧</span> <span class="free">le</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span> <span class="main">=</span> weak_ranking_aux <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_aux_unique weak_ranking_total_preorder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_altdef weak_ranking_aux_Union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">As</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">As</span> <span class="main">=</span> <span class="free">le</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">As</span> <span class="main">=</span> weak_ranking <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> weak_ranking_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> weak_ranking_aux_unique<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span> <span class="main">=</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_vimage permutes_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> finite_total_preorder_on <span class="quoted"><span class="quoted">"inv <span class="free">f</span> <span class="main">-`</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"map_relation <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span> <span class="free">le</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_total_preorder_on_map<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_weak_ranking_map_inj<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder permutes_inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R.weak_ranking_unique<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_permute weak_ranking_Union weak_ranking_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_index_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_weak_ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_index_unique'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> find_index <span class="main">(</span><span class="main">(∈)</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms find_index_less_size_conv nth_mem
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_index_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> _ assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>
        nth_find_index<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∈)</span></span></span> <span class="free"><span class="free"><span class="free">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_eqclass1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_eqclass2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> weak_ranking <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def weak_ranking_total_preorder<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?le'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> le <span class="keyword1"><span class="command">have</span></span> le'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?le'</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?le'</span> <span class="free">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder xs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> le'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> le'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">j'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> i'j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ij i'j' <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_index_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij i'j' A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_index_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ij i'j' k eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hd_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> hd <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> weak_ranking_Union assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> weak_ranking_Union <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> last <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> weak_ranking_Union assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> weak_ranking_Union <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_weak_ranking.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="main"><span class="main"><span class="main">(</span></span></span>weak_ranking <span class="free"><span class="free"><span class="free">le</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The index in weak ranking of a given alternative. An element with index 0 is 
  first-ranked; larger indices correspond to less-preferred alternatives.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_ranking_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_ranking_index</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> find_index <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_weak_ranking_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking_index <span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> weak_ranking_index <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms weak_ranking_Union <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_ranking_index <span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> weak_ranking_index_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_index_less_size_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> weak_ranking_index <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> weak_ranking_index_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_find_index<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ranking_index_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span> weak_ranking_index <span class="free">x</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> weak_ranking_index_unique'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_index_def weak_ranking_total_preorder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ranking_index_le_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking_index <span class="free">x</span> <span class="main">≥</span> weak_ranking_index <span class="free">y</span> <span class="main">⟷</span> <span class="free">le</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_total_preorder<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> weak_ranking_index <span class="free">x</span> <span class="main">≥</span> weak_ranking_index <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weak_ranking_index <span class="free">x</span> <span class="main">≥</span> weak_ranking_index <span class="free">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_weak_ranking.intros<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_weak_ranking_index assms<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> weak_ranking <span class="free">le</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> of_weak_ranking.cases<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> ranking_index_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> ranking_index_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_ranking_index <span class="free">x</span> <span class="main">≥</span> weak_ranking_index <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> weak_ranking <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> weak_ranking_unique<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> of_weak_ranking_weak_ranking <span class="main">=</span> 
  finite_total_preorder_on.weak_ranking_total_preorder<span class="main">(</span>2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_total_preorder_on_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">A</span> <span class="free">R</span> <span class="main">⟷</span> total_preorder_on <span class="free">A</span> <span class="free">R</span> <span class="main">∧</span> finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_total_preorder_on_def finite_total_preorder_on_axioms_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_total_preorder_of_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">A</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> total_preorder_of_weak_ranking<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> is_finite_weak_ranking_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_of_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_total_preorder_of_weak_ranking<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> weak_ranking_unique<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">R1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">R1</span> <span class="main">=</span> weak_ranking <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">=</span> <span class="free">R2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">R1</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">R2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_weak_ranking<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_eq_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">R1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking <span class="free">R1</span> <span class="main">=</span> weak_ranking <span class="free">R2</span> <span class="main">⟷</span> <span class="free">R1</span> <span class="main">=</span> <span class="free">R2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms weak_ranking_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preferred_alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> relation <span class="main">⇒</span> <span class="tfree">'alt</span> <span class="main">⇒</span> <span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preferred_alts</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> preorder_on<span class="main">)</span> preferred_alts_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> preferred_alts <span class="free">le</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preferred_alts_def refl<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> preorder_on<span class="main">)</span> preferred_alts_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"preferred_alts <span class="free">le</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_outside<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> preorder_on<span class="main">)</span> preferred_alts_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"preferred_alts <span class="free">le</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> preferred_alts_def <span class="keyword1"><span class="command">using</span></span> not_outside <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rankings›</span></span>

<span class="comment1">(* TODO: Extend theory on rankings. Can probably mostly be based on
   existing theory on weak rankings. *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ranking</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> relation <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ranking</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> map the_elem <span class="main">(</span>weak_ranking <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> finite_linorder_on <span class="main">=</span> linorder_on <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_carrier <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">carrier</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> finite_total_preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">fact</span> finite_carrier<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_singleton <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> is_singletonI'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> weak_ranking_total_preorder<span class="main">(</span>1<span class="main">)</span> is_weak_ranking_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span>of_weak_ranking <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking_indifference<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> weak_ranking_total_preorder<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> antisymmetric<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weak_ranking_ranking<span class="main">:</span> <span class="quoted"><span class="quoted">"weak_ranking <span class="free">le</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>ranking <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ranking_def map_map o_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_idI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_singleton <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> singleton_weak_ranking<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>the_elem <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_singletonE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Preference_Profiles">
<div class="head">
<h1>Theory Preference_Profiles</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Preference_Profiles.thy
  Author:   Manuel Eberl, TU München

  Definition of (weak) preference profiles and functions for building
  and manipulating them
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preference Profiles›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Preference_Profiles
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a> 
  <a href="Order_Predicates.html">Order_Predicates</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type of preference profiles›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span> relation"</span></span>

<span class="keyword1"><span class="command">locale</span></span> preorder_family <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">carrier</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> relation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dom</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">dom</span> <span class="main">⟹</span> preorder_on <span class="free">carrier</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_in_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">dom</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">R</span> <span class="free">i</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_dom'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">dom</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> pref_profile_wf <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty_agents <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonempty_alts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prefs_wf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> finite_total_preorder_on <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prefs_undefined <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">R</span> <span class="free">i</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_alts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty_agents <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_carrier<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_wf' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> total_preorder_on <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> preorder_on <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefs_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_total_preorder_on_def total_preorder_on_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> prefs_wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_outside<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_outside<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> preorder_family <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> preorder_family.intro<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> prefs_undefined' <span class="main">=</span> not_in_dom'

<span class="keyword1"><span class="command">lemma</span></span> wf_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">Ri'</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> finite_alts <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pref_profile_wf.intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_permute_agents<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">using</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_profile_wf.intro prefs_wf<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> pref_profile_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">R1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">R2</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">=</span> <span class="free">R2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> R1<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> R2<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">R2</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Permutes a preference profile w.r.t. alternatives in the way described in the paper.
  This is needed for the definition of neutrality.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">permute_profile</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permute_profile</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> permute_profile_map_relation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map_relation <span class="main">(</span>inv <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def map_relation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permute_profile_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="main">∘</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff permute_profile_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permute_profile_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permute_profile id <span class="free">R</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permute_profile_o<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"permute_profile <span class="free">f</span> <span class="main">(</span>permute_profile <span class="free">g</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> permute_profile <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def o_inv_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> wf_permute_alts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pref_profile_wf.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_in_image permutes_inv<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R.not_outside<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"inv <span class="free"><span class="free">σ</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"inv <span class="free"><span class="free">σ</span></span> <span class="skolem"><span class="skolem">y</span></span>"</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permute_profile_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R.trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="skolem">z</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R.total R.refl R.finite_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def pref_profile_wf_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This shows that the above definition is equivalent to that in the paper.  
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> permute_profile_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≡</span> permute_profile <span class="free">σ</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R'</span> <span class="free">i</span><span class="main">]</span> <span class="free">σ</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def permutes_inverses<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pareto dominance›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Pareto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span> relation<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'alt</span> relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≼[</span><span class="free">Pareto</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≼[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A Pareto loser is an alternative that is Pareto-dominated by some other alternative.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pareto_losers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pareto_losers</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pareto_losersI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> pareto_losers <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pareto_losers_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> preorder_family
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Pareto_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">dom</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="skolem">j</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A preorder_on.refl<span class="main">[</span><span class="operator">OF</span> in_dom<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">dom</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">dom</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> nonempty_dom <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> j A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="skolem">j</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="skolem">j</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_outside refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Pareto_strict_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">dom</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">dom</span><span class="main">.</span> <span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def Pareto_iff nonempty_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Pareto_strictI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">dom</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_strict_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Pareto_strictI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">dom</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">x</span> <span class="main">≽[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_strict_iff <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> Pareto<span class="main">:</span> preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preorder_on <span class="free">carrier</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> preorder_on.not_outside<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> preorder_on.refl<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
           preorder_on.trans<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty_dom <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"preorder_on <span class="free">carrier</span> <span class="main">(</span>Pareto <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> i <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pareto_loser_in_alts<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pareto_losers <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">dom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="skolem">i</span><span class="main">]</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pareto_losers_def Pareto_strict_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="skolem">i</span><span class="main">]</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="skolem">i</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_outside <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pareto_losersE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pareto_losers <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pareto_losers_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> Pareto.not_outside<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> y <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preferred alternatives›</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_alts_subset_alts<span class="main">:</span> <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_preferred_alts <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_outside
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_alts_altdef<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preorder_on.preferred_alts_altdef<span class="main">)</span>  

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Favourite alternatives›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">favorites</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">favorites</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Max_wrt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">favorite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">favorite</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> the_elem <span class="main">(</span>favorites <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_unique_favorites</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_unique_favorites</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> favorites <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> is_singleton <span class="main">(</span>favorites <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"favorites <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">alts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_def Max_wrt_total_preorder Max_wrt_among_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_def Max_wrt_def Max_wrt_among_def pref_profile_wf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_no_agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span> <span class="main">⟹</span> favorites <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> favorites_def Max_wrt_def Max_wrt_among_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_altdef'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"favorites <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≽[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Max_wrt_among_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">alts</span></span><span class="main">]</span> Max_wrt_among_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">alts</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> favorites_altdef Max_wrt_among_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_subset_alts<span class="main">:</span> <span class="quoted"><span class="quoted">"favorites <span class="free">R</span> <span class="free">i</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> favorites_altdef'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_favorites <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>favorites <span class="free">R</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> favorites_subset_alts finite_alts  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> favorites <span class="free">R</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> favorites_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_nonempty<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_permute<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"favorites <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">`</span> favorites <span class="free">R</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> favorites_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_wrt_map_relation_bij<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def map_relation_def permutes_bij<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_unique_favorites_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> is_singleton <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>favorites <span class="free">R</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> favorites_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_unique_favorites_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> is_singleton <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_singleton <span class="main">(</span>favorites <span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> favorites <span class="free">R</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_nonempty<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_altdef'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_unique_favorites_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> pref_profile_unique_favorites <span class="main">=</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique_favorites'<span class="main">:</span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> unique_favorites<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> favorites <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{</span>favorite <span class="free">R</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unique_favorites' 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> favorite_def has_unique_favorites_altdef is_singleton_the_elem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> favorite_in_alts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> favorite <span class="free">R</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> favorites_subset_alts<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unique_favorites<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Anonymous profiles›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> apref_profile <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set list multiset"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">anonymous_profile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> apref_profile"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> anonymous_profile_auxdef<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">anonymous_profile</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span>weak_ranking <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>mset_set <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> agents_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Ri<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">interpret</span></span> preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> carrier_eq Ri nonempty_alts <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefs_undefined'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> anonymous_profile_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R</span> <span class="main">=</span> image_mset <span class="main">(</span>weak_ranking <span class="main">∘</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>mset_set <span class="free">agents</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> agents_eq anonymous_profile_auxdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> anonymous_profile_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span>  <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> 
             image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_permute_alts<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">{#</span>weak_ranking <span class="main">(</span>map_relation <span class="main">(</span>inv <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R'.anonymous_profile_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  multiset.map_comp permute_profile_map_relation o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_mset_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_total_preorder_on.weak_ranking_permute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">alts</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> anonymous_profile_def multiset.map_comp o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> anonymous_profile_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             anonymous_profile <span class="free">R</span> <span class="main">-</span> <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_total_preorder_on_iff wf_update<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">Ri'</span> <span class="keyword1">else</span> <span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'.anonymous_profile_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> weak_ranking <span class="free">Ri'</span> <span class="keyword1">else</span> weak_ranking <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_mset_cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">agents</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">i</span><span class="main">}</span><span class="main">#}</span> <span class="main">+</span>
                    <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">agents</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">i</span><span class="main">}</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_mset_If<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> filter_mset_mset_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">agents</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">agents</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">agents</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_set <span class="main">(</span><span class="free">agents</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> mset_set <span class="free">agents</span> <span class="main">-</span> <span class="main">{#</span><span class="free">i</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">…</span><span class="main">#}</span> <span class="main">=</span>
            <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span> <span class="main">-</span> <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_mset_Diff<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_multiset_in_set mset_subset_eq_single<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> 
               anonymous_profile <span class="free">R</span> <span class="main">-</span> <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span>weak_ranking <span class="free">Ri'</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> anonymous_profile_def add_ac o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preference profiles from lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefs_from_table</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span> <span class="main">×</span> <span class="tfree">'alt</span> set list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefs_from_table</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> case_option <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> of_weak_ranking <span class="main">(</span>map_of <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefs_from_table_wf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefs_from_table_wf</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="main">∧</span> 
       set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">∧</span> 
       is_finite_weak_ranking <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_wfI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⋃</span><span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss</span><span class="main">)</span> <span class="main">⟹</span> is_finite_weak_ranking <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prefs_from_table_wf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_wfD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="free">agents</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⋃</span><span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss</span><span class="main">)</span> <span class="main">⟹</span> is_finite_weak_ranking <span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prefs_from_table_wf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       
<span class="keyword1"><span class="command">lemma</span></span> pref_profile_from_tableI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span> <span class="main">⟹</span> pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span>prefs_from_table <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pref_profile_wf.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xss</span> <span class="skolem">i</span> <span class="main">=</span> of_weak_ranking <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xss</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def map_of_eq_None_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="main">(</span>prefs_from_table <span class="free">xss</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_total_preorder_of_weak_ranking<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xss</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prefs_from_table <span class="free">xss</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="main">=</span> prefs_from_table <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="main">=</span> map_of <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_of_inject_set<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_undef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xss</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">xss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xss</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_map_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xss</span> <span class="free">i</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xss</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def map_of_eq_None_iff prefs_from_table_wf_def
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">xs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> of_weak_ranking <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
             prefs_from_table <span class="free">xs'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs'_def<span class="main">)</span>  
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span> 
    <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> k xs'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def map_of_eq_None_iff 
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> k xs' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs'</span> <span class="skolem">k</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def k'<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="skolem">k</span> <span class="main">=</span> map_of <span class="free">xs'</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> prefs_from_table <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">y'</span><span class="main">)</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> prefs_from_table <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">y'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permute_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="free">σ</span> <span class="main">=</span> prefs_from_table <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> 
          <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">xs</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">of</span>
             None <span class="main">⇒</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False
           <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> of_weak_ranking <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_of_permute<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> prefs_from_table <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permute_profile_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="main">(</span>prefs_from_table <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> 
             prefs_from_table <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">=</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prefs_from_table_wfI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Union <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prefs_from_table_wf_def permutes_image o_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def is_weak_ranking_iff prefs_from_table_wf_def
            distinct_map permutes_inj_on inj_on_image <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjoint_image<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Union <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prefs_from_table_wf_def permutes_image o_def case_prod_unfold<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms wf' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_def prefs_from_table_undef<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> the <span class="main">(</span>map_of <span class="free">xss</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i wf <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xss</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xss</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def xs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> xs_in_xss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">xss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> set_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wfD<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
                   of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prefs_from_table_map_of<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_weak_ranking <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_of_map<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> of_weak_ranking <span class="skolem">xs</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_permute map_relation_def set_xs perm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> permute_profile <span class="free">σ</span> <span class="main">(</span>prefs_from_table <span class="free">xss</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def xs permute_profile_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Automatic evaluation of preference profiles›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_prefs_from_table <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">[]</span><span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> of_weak_ranking <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> prefs_from_table <span class="main">(</span><span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_of_weak_ranking <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> of_weak_ranking <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="free">x</span> <span class="main">⟹</span> of_weak_ranking <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> of_weak_ranking <span class="free">xs</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="main">=</span> prefs_from_table <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> prefs_from_table <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> prefs_from_table <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> fst <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_weak_ranking_Collect_ge</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_weak_ranking_Collect_ge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> of_weak_ranking <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Collect_of_weak_ranking<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>of_weak_ranking <span class="free">xs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Collect_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Collect_ge_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="main">[]</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Collect_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Collect_ge_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">⟹</span> of_weak_ranking_Collect_ge <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">x</span> <span class="main">⟹</span> of_weak_ranking_Collect_ge <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> of_weak_ranking_Collect_ge <span class="free">xs</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Cons of_weak_ranking_Collect_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> of_weak_ranking_Collect_ge_Cons'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> of_weak_ranking_Collect_ge <span class="free">xs</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Cons of_weak_ranking_Collect_ge_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> anonymise_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> agents<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">{#</span>weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def anonymous_profile_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> image_mset_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈#</span> mset_set <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i assms 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> 
              weak_ranking <span class="main">(</span>of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_map_of<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> the <span class="main">(</span>map_of <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_of_weak_ranking<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>map_of <span class="free">xs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> agents <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_set <span class="free">agents</span> <span class="main">=</span> mset_set <span class="main">(</span>set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mset_set_set<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈#</span> mset <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_mset_map_of<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefs_from_table_agent_permutation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="free">π</span> <span class="main">=</span> prefs_from_table <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> agents<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> agents'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> agents agents' wf<span class="main">(</span>1<span class="main">)</span> wf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_iff_mset_eq_distinct <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wfD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> same_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mset <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">g</span> <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> map fst <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_eq_permutation <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_length <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> mset_eq g 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>permute_list <span class="skolem">g</span> <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> mset_eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> 
             <span class="quoted"><span class="quoted">"permute_list <span class="skolem">f</span> <span class="main">(</span>permute_list <span class="skolem">g</span> <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map snd <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_eq_permutation <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> same_length <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> 
                 <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_length<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="skolem"><span class="skolem">unidx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> index <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">unidx</span> <span class="skolem">i</span> <span class="main">=</span> map fst <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">idx</span> <span class="free">agents</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_index<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bij_betw_idx<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">idx</span> <span class="free">agents</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idx_def agents<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">unidx</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agents unidx_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> unidx_idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">unidx</span> <span class="main">(</span><span class="skolem">idx</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> idx_def unidx_def <span class="keyword1"><span class="command">using</span></span> nth_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"map fst <span class="free">xs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agents set_map <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nth_map <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> idx_unidx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">(</span><span class="skolem">unidx</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> idx_def unidx_def <span class="keyword1"><span class="command">using</span></span> wf<span class="main">(</span>1<span class="main">)</span> index_nth_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="free">xs</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wfD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">unidx</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">idx</span><span class="main">)</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">unidx</span> <span class="main">∘</span> inv <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">idx</span><span class="main">)</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="skolem">unidx</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">idx</span><span class="main">)</span> <span class="free">agents</span> <span class="free">agents</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> unidx_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_trans bij_betw_idx permutes_imp_bij f g bij_betw_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="main">(</span><span class="operator">insert</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> g<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def same_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> bij_betw <span class="skolem">π</span> <span class="free">agents</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_imp_permutes<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">∘</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f g <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> permutes_compose<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_length<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> inv_π<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> f<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def π'_def idx_unidx unidx_idx inv_f_f permutes_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def π'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> perm <span class="keyword1"><span class="command">have</span></span> inv_π'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_inv_eq permutes_bij<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> wf h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">ys</span> <span class="main">=</span> prefs_from_table <span class="main">(</span>permute_list <span class="skolem">h</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prefs_from_table_eqI<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wfD permute_list_map <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">h</span> <span class="free">ys</span> <span class="main">=</span> permute_list <span class="skolem">h</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_map_fst_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> same_length f g
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">h</span> <span class="main">(</span>zip <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            zip <span class="main">(</span>permute_list <span class="skolem">f</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permute_list_zip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> h<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def permute_list_compose<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">f</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">unidx</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> f<span class="main">(</span>1<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permute_list_nth<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_length unidx_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">(</span><span class="skolem">unidx</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def idx_unidx<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="skolem">π</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unidx_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">f</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> map <span class="skolem">π</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">f</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">π</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zip <span class="main">(</span>map <span class="skolem">π</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>inv <span class="skolem">π'</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold inv_π'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> permutes_inv<span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span> inv_π <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="main">…</span> <span class="main">=</span> prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> permute_prefs_from_table <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agents<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="main">∘</span> <span class="skolem">π'</span> <span class="main">=</span> prefs_from_table <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π'</span></span><span class="main">]</span> permutes_inv<span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span> inv_π <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permute_list_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"permute_list <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">f</span> <span class="main">(</span>index <span class="free">xs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> index_nth_id permute_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_eq_permutation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">f</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">g</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">A</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="free">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_distinct_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map <span class="free">g</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_set_set<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mset_eq_permutation<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">π</span> <span class="main">(</span>map <span class="free">g</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="free">A</span> <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_trans bij_betw_index xs refl permutes_imp_bij π bij_betw_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan xs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> bij_betw <span class="skolem">π'</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_imp_permutes<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> π xs<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">π'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_list_map permute_list_distinct
          permutes_image π'_def that atLeast0LessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> anonymous_profile_agent_permutation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R1</span> <span class="main">=</span> anonymous_profile <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span>  <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">∘</span> <span class="free">π</span> <span class="main">=</span> <span class="free">R1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R1<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> R2<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R1</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span> <span class="main">=</span> 
                  <span class="main">{#</span>weak_ranking <span class="main">(</span><span class="free">R2</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> mset_set <span class="free">agents</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1.anonymous_profile_def R2.anonymous_profile_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> image_mset_eq_permutation<span class="main">[</span><span class="operator">OF</span> this fin<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> π <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> π <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> π <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span><span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R2.wf_permute_agents<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R2'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span> <span class="main">=</span> <span class="free">R1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pref_profile_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf' wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> π <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span><span class="main">(</span><span class="free">R2</span> <span class="keyword1">o</span> <span class="skolem">π</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> weak_ranking <span class="main">(</span><span class="free">R1</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf' wf<span class="main">(</span>1<span class="main">)</span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">R1</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_eqD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">alts</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> R2'.prefs_wf<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> π<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Elections">
<div class="head">
<h1>Theory Elections</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Elections
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Preference_Profiles.html">Preference_Profiles</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An election consists of a finite set of agents and a finite non-empty 
  set of alternatives.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> election <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_agents <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_alts <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty_agents <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty_alts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_pref_profile</span> <span class="main">≡</span> pref_profile_wf <span class="free">agents</span> <span class="free">alts</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_total_preorder_on_iff' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">R</span> <span class="main">⟷</span> total_preorder_on <span class="free">alts</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_total_preorder_on_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pref_profile_wfI' <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> total_preorder_on <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> is_pref_profile <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_wf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_pref_profile_update <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pref_profile_wf.wf_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> election <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> election_axioms<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> R<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_prefs_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Max_wrt <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> R.Max_wrt_preorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_wrt_prefs_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_wrt <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R.Max_wrt_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_imp_preferred<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span> Max_wrt <span class="free">R</span> <span class="main">⊆</span> preferred_alts <span class="free">R</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R.total
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.Max_wrt_total_preorder preferred_alts_def strongly_preferred_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lotteries">
<div class="head">
<h1>Theory Lotteries</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Libraries.thy
  Author:   Manuel Eberl, TU München

  Definition of lotteries on a set. (Essentially just restricting PMFs to a carrier set)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts about PMFs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lotteries
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type of lotteries (a probability mass function)›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'alt</span> lottery <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> pmf"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lotteries_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> lottery set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lotteries_on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> set_pmf <span class="bound">p</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_of_set_lottery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> pmf_of_set <span class="free">A</span> <span class="main">∈</span> lotteries_on <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lotteries_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_of_list_lottery<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pmf_of_list_wf <span class="free">xs</span> <span class="main">⟹</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> pmf_of_list <span class="free">xs</span> <span class="main">∈</span> lotteries_on <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_pmf_of_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> return_pmf_in_lotteries_on <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> return_pmf <span class="free">x</span> <span class="main">∈</span> lotteries_on <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Utility_Functions">
<div class="head">
<h1>Theory Utility_Functions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Utility_Functions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
  <a href="Lotteries.html">Lotteries</a>
  <a href="Preference_Profiles.html">Preference_Profiles</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of von Neumann--Morgenstern utility functions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> vnm_utility <span class="main">=</span> finite_total_preorder_on <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> utility_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">u</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> utility_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">u</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_outside<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main">]</span> utility_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> utility_less_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">u</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> utility_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> utility_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> utility_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">u</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_outside<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main">]</span> utility_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma allows us to compute the expected utility by summing
  over all indifference classes, using the fact that alternatives in the same
  indifference class must have the same utility.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> expected_utility_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">←</span>weak_ranking <span class="free">le</span><span class="main">.</span> <span class="free">u</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">*</span> measure_pmf.prob <span class="free">p</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="free">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_carrier<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_ranking_Union<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> carrier <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_carrier<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">←</span>weak_ranking <span class="free">le</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="free">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum_list <span class="var">?xs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> weak_ranking_total_preorder
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Union_disjoint<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_iff disjoint_def sum.distinct_set_conv_list<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span>  <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="free">u</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="bound">A</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong HOL.refl sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> A x this<span class="main">]</span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> A this x<span class="main">]</span> x this A
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> utility_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="free">u</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">*</span> measure_pmf.prob <span class="free">p</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong HOL.refl<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left measure_measure_pmf_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scaled<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">insert</span> utility_le_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> utility_le_iff<span class="main">[</span><span class="operator">OF</span> xy<span class="main">]</span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> utility_le_iff<span class="main">[</span><span class="operator">OF</span> xy<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> add_right<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a consistent utility function, any function that assigns equal values to
  equivalent alternatives can be added to it (scaled with a sufficiently small <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ε</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>),
  again yielding a consistent utility function.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> add_epsilon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">ε</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">u</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">carrier</span></span></span> <span class="main"><span class="main"><span class="main">×</span></span></span> <span class="free"><span class="free"><span class="free">carrier</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> not_outside<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> Min <span class="main">(</span>insert <span class="main">1</span> <span class="var">?A</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>insert <span class="main">1</span> <span class="var">?A</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_pos_pos <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> utility_less<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ε <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&lt;</span> Min <span class="main">(</span>insert <span class="main">1</span> <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> less xy finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>insert <span class="main">1</span> <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">y</span> <span class="main">-</span> <span class="free">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ε_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> utility_less<span class="main">[</span><span class="operator">OF</span> xy<span class="main">]</span> ε <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> not_less add_less_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> xy<span class="main">[</span><span class="operator">THEN</span> utility_le<span class="main">]</span> A<span class="main">[</span><span class="operator">OF</span> xy<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">u</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> total<span class="main">[</span><span class="operator">OF</span> xy<span class="main">]</span> mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ε this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_epsilon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">le</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">ε</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">ε</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">ε</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">ε</span> <span class="main">*</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_epsilon<span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> neg_equal_iff_equal<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stochastic_Dominance">
<div class="head">
<h1>Theory Stochastic_Dominance</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stochastic Dominance›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stochastic_Dominance
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
  <a href="Lotteries.html">Lotteries</a>
  <a href="Preference_Profiles.html">Preference_Profiles</a>
  <a href="Utility_Functions.html">Utility_Functions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Stochastic Dominance›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the definition of stochastic dominance. It lifts a preference relation
  on alternatives to the stochastic dominance ordering on lotteries.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> relation <span class="main">⇒</span> <span class="tfree">'alt</span> lottery relation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≽[</span><span class="free">SD</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">x</span> <span class="bound">x</span> <span class="main">⟶</span> measure_pmf.prob <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≥</span>
                       measure_pmf.prob <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SD <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff SD_def lotteries_on_def set_pmf_not_empty<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stochastic dominance over any relation is a preorder.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SD_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SD_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_is_preorder<span class="main">:</span> <span class="quoted"><span class="quoted">"preorder_on <span class="main">(</span>lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>SD <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_preorder<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span>
                     measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_def preferred_alts_def carrier_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_preorderI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span>
             measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_preorder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_preorderD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span>
             measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_preorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_refl' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_def carrier_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_is_preorder'<span class="main">:</span> <span class="quoted"><span class="quoted">"preorder_on <span class="main">(</span>lotteries_on <span class="free">carrier</span><span class="main">)</span> <span class="main">(</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SD_is_preorder<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">le</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrier_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_singleton_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"return_pmf <span class="free">x</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> SD<span class="main">:</span> <span class="quoted"><span class="quoted">"return_pmf <span class="free">x</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms SD_preorderD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> SD<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span>
            measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="free">q</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.measure_ge_1_iff measure_pmf.prob_eq_1 preferred_alts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"return_pmf <span class="free">x</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SD_preorderI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span>
              <span class="main">≤</span> measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff measure_pmf.prob_eq_1 preferred_alts_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preferred_alts_def indicator_def measure_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_singleton_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> SD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_pmf <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> y assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_pmf_posI<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> measure_pmf.prob <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SD_preorderD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> SD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def preferred_alts_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SD_preorderI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span>
            measure_pmf.prob <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def indicator_def measure_le_0_iff
                       measure_pmf.prob_eq_0 AE_measure_pmf_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def preferred_alts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_strict_singleton_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"return_pmf <span class="free">x</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def SD_singleton_left SD_singleton_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_strict_singleton_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set_pmf <span class="free">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def SD_singleton_left SD_singleton_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> return_pmf <span class="free">x</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> SD_singleton_left<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_strict_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> return_pmf <span class="free">x</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> return_pmf <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Ri<span class="main">:</span> preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> SD_singleton_left <span class="main">=</span> Ri.SD_singleton_left
<span class="keyword1"><span class="command">lemmas</span></span> SD_singleton_right <span class="main">=</span> Ri.SD_singleton_right
<span class="keyword1"><span class="command">lemmas</span></span> SD_strict_singleton_left <span class="main">=</span> Ri.SD_strict_singleton_left
<span class="keyword1"><span class="command">lemmas</span></span> SD_strict_singleton_right <span class="main">=</span> Ri.SD_strict_singleton_right
<span class="keyword1"><span class="command">lemmas</span></span> SD_singleton <span class="main">=</span> Ri.SD_singleton
<span class="keyword1"><span class="command">lemmas</span></span> SD_strict_singleton <span class="main">=</span> Ri.SD_strict_singleton

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> SD_singleton SD_strict_singleton


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stochastic Dominance for preference profiles›</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_pref_profile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">∧</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span>
                         measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> not_outside
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_preorder preferred_alts_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_pref_profileI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span>
             measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span>
             measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_pref_profile<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_pref_profileD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span>
             measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span>
             measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_pref_profile<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹SD efficient lotteries›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SD_efficient</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  SD_efficient_auxdef<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">SD_efficient</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≻[</span>Pareto <span class="main">(</span>SD <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> SD<span class="main">:</span> preorder_family <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="quoted">"lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"SD <span class="main">∘</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> preorder_family.intro SD_is_preorder<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preorder_on.SD_is_preorder' prefs_undefined'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A lottery is considered SD-efficient if there is no other lottery such that
  all agents weakly prefer the other lottery (w.r.t. stochastic dominance) and at least
  one agent strongly prefers the other lottery.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>lotteries_on <span class="free">alts</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≻[</span>Pareto <span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>lotteries_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≻[</span>Pareto <span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_auxdef <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nonempty_agents <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> preorder_on.refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> not_outside<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span> <span class="main">⟷</span>
     <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>lotteries_on <span class="free">alts</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def SD.Pareto_iff strongly_preferred_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficientI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficientI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span><span class="main">.</span> <span class="free">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficientE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficientD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">q</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' strongly_preferred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_singleton_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> pareto_losers <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pareto_losers <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pareto_losersE<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> y <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> y <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SD_inefficientI'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"return_pmf <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_strict_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="main">(</span>return_pmf <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> SD_inefficientE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> q i <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> q <span class="main">=</span> this
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_pmf <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≻[</span><span class="free">R</span> <span class="skolem">i</span><span class="main">]</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_strict_singleton_left<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_strict_iff SD_singleton_left<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pareto_losers <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalence proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that a lottery is preferred w.r.t. Stochastic Dominance iff
  it yields more expected utility for all compatible utility functions.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> finite_total_preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_vnm_utility</span> <span class="main">≡</span> vnm_utility <span class="free">carrier</span> <span class="free">le</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> utility_weak_ranking_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_vnm_utility <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">-</span> weak_ranking_index <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> this<span class="main">[</span><span class="operator">THEN</span> nth_weak_ranking_index<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">THEN</span> nth_weak_ranking_index<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">(</span>length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">-</span> weak_ranking_index <span class="skolem">x</span><span class="main">)</span>
            <span class="main">≤</span> real <span class="main">(</span>length <span class="main">(</span>weak_ranking <span class="free">le</span><span class="main">)</span> <span class="main">-</span> weak_ranking_index <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">le</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_iff'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
  TODO: one direction could probably be generalised to weakly consistent
  utility functions
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> SD_iff_expected_utilities_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> is_vnm_utility <span class="bound">u</span> <span class="main">⟶</span> measure_pmf.expectation <span class="free">p</span> <span class="bound">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">q</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> SD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_utility<span class="main">:</span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> is_utility <span class="keyword1"><span class="command">interpret</span></span> vnm_utility <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> weak_ranking <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="main">=</span> of_weak_ranking <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def weak_ranking_total_preorder<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pref</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> measure_pmf.prob <span class="bound">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?pref'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> measure_pmf.prob <span class="bound">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> xs_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def weak_ranking_total_preorder<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> f_def is_weak_ranking_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> someI_ex<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that f weak_ranking_Union <span class="keyword1"><span class="command">unfolding</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms weak_ranking_Union <span class="keyword1"><span class="command">have</span></span> carrier_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def lotteries_on_def set_pmf_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> SD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?pref</span> <span class="free">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?pref</span> <span class="free">q</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> f'<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> SD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_preorder preferred_alts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that weak_ranking_index_unique<span class="main">[</span><span class="operator">OF</span> xs_wf that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ f<span class="main">]</span>
               weak_ranking_index_unique<span class="main">[</span><span class="operator">OF</span> xs_wf that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ f<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.intros<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">=</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> measure_pmf.prob <span class="skolem">p</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def expected_utility_weak_ranking xs_def sum_list_sum_nth atLeast0LessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong HOL.refl<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
              measure_pmf.prob <span class="skolem">p</span> <span class="main">(</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.finite_measure_Diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span>
                   <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">f</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> i f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> weak_ranking_eqclass2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ le<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> _ this f<span class="main">]</span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> _ f this<span class="main">]</span> i
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> measure_pmf.prob <span class="skolem">p</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
                      <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                      <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n sum.lessThan_Suc_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong HOL.refl<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≼[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> weak_ranking_Union <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth xs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> _ f j<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> weak_ranking_eqclass1<span class="main">[</span><span class="operator">OF</span> _ j<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> f<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="free">le</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">z</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="free">le</span> <span class="skolem">z</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">unfolding</span></span> n_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iff f_le strongly_preferred_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> not_outside<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">-</span> <span class="main">(</span><span class="main">…</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
       <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="var">?pref</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs sum_subtractf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">0</span> <span class="main">≺[</span><span class="free">le</span><span class="main">]</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_weak_ranking<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span>"</span></span><span class="main">]</span> xs_nonempty f not_outside
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_conv_nth xs_def strongly_preferred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">carrier</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> last_weak_ranking<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> xs_nonempty f not_outside
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth xs_def n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="skolem">p</span> <span class="free">carrier</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.prob_eq_1<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff lotteries_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">THEN</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SD_preorder n_def <span class="keyword1"><span class="command">using</span></span> f'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_left_mono SD' <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> utility_le_iff f_le<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> is_vnm_utility <span class="bound">u</span> <span class="main">⟶</span> measure_pmf.expectation <span class="free">p</span> <span class="bound">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">q</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> expected_utility_le<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> weak_ranking <span class="free">le</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="main">=</span> of_weak_ranking <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def weak_ranking_total_preorder<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def weak_ranking_Union<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> carrier_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_not_empty<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?idx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> length <span class="skolem">xs</span> <span class="main">-</span> weak_ranking_index <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> preferred_subset_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_outside x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">/</span> real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span>
             measure_pmf.prob <span class="free">q</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">/</span> real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> field_le_epsilon<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ε</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">y</span> <span class="main">=</span> indicator <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">x</span><span class="main">}</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="var">?idx</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">have</span></span> is_utility<span class="main">:</span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def xs_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> vnm_utility.add_left vnm_utility.scaled utility_weak_ranking_index<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"indicator <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">x</span><span class="main">}</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="main">(</span>indicator <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≽[</span><span class="free">le</span><span class="main">]</span> <span class="skolem">x</span><span class="main">}</span> <span class="skolem">z</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span><span class="main">|</span><span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span><span class="main">|</span><span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="var">?idx</span> <span class="bound">y</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg sum_nonneg pmf_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> expected_utility_le is_utility <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="skolem">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="skolem">u</span> <span class="bound">a</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_carrier<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_eq <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span><span class="main">|</span><span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="var">?idx</span> <span class="bound">y</span> <span class="main">*</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span><span class="main">|</span><span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="var">?idx</span> <span class="bound">y</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x preferred_subset_carrier not_outside
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_def sum.distrib finite_carrier <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_distrib_left Int_absorb1 <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> rev_conj_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> <span class="var">?idx</span> <span class="bound">y</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">carrier</span><span class="main">.</span> length <span class="skolem">xs</span> <span class="main">*</span> pmf <span class="free">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure_pmf.expectation <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_carrier<span class="main"><span class="main">]</span></span><span class="main">)</span>
                       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def set_pmf_eq <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span> <span class="main">|</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> measure_pmf.prob <span class="free">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> preferred_subset_carrier finite_carrier<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_measure_pmf_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">y</span></span> <span class="main">|</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> measure_pmf.prob <span class="free">q</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> preferred_subset_carrier finite_carrier<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_measure_pmf_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">/</span> length <span class="skolem">xs</span> <span class="main">≤</span>
                      measure_pmf.prob <span class="free">q</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">/</span> length <span class="skolem">xs</span> <span class="main">+</span> <span class="skolem">ε</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> carrier_nonempty carrier <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">≤</span>
                       measure_pmf.prob <span class="free">q</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">le</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SD_preorder preferred_alts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_strict_SD_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">p</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> is_vnm_utility <span class="bound">u</span> <span class="main">∧</span> measure_pmf.expectation <span class="free">q</span> <span class="bound">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="free">p</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">::</span> <span class="tfree">'a</span> pmf <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> is_vnm_utility <span class="bound">u</span> <span class="main">∧</span> <span class="var">?E</span> <span class="free">p</span> <span class="bound">u</span> <span class="main">≥</span> <span class="var">?E</span> <span class="free">q</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="free">p</span> <span class="skolem">u</span> <span class="main">≥</span> <span class="var">?E</span> <span class="free">q</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">interpret</span></span> u<span class="main">:</span> vnm_utility <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">≺[</span>SD <span class="free">le</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≺[</span>SD <span class="free">le</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="free">p</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="var">?E</span> <span class="free">q</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_iff_expected_utilities_le strongly_preferred_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> u_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="free">p</span> <span class="skolem">u</span> <span class="main">=</span> <span class="var">?E</span> <span class="free">q</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> antisym<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> less assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="free">p</span> <span class="skolem">u'</span> <span class="main">&lt;</span> <span class="var">?E</span> <span class="free">q</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_iff_expected_utilities_le strongly_preferred_def not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> u'<span class="main">:</span> vnm_utility <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="quoted"><span class="skolem">u'</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">ε</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> is_vnm_utility <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">u</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">ε</span> <span class="main">*</span> <span class="skolem">u'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> u.diff_epsilon antisym u'.utility_le<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> ε <span class="main">=</span> this
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u''</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="skolem">u'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">interpret</span></span> u''<span class="main">:</span> vnm_utility <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">le</span></span> <span class="quoted"><span class="skolem">u''</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">have</span></span> exp_u''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="skolem">p</span> <span class="skolem">u''</span> <span class="main">=</span> <span class="var">?E</span> <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">-</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="var">?E</span> <span class="skolem">p</span> <span class="skolem">u'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">carrier</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def u''_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_subtractf sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms ε <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="free">p</span> <span class="skolem">u''</span> <span class="main">&gt;</span> <span class="var">?E</span> <span class="free">q</span> <span class="skolem">u''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_u'' <span class="dynamic"><span class="dynamic">algebra_simps</span></span> u_eq u'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> pq<span class="main">[</span><span class="operator">OF</span> u''.vnm_utility_axioms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms utility_weak_ranking_index<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def SD_iff_expected_utilities_le not_le not_less <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_SD_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> is_vnm_utility <span class="bound">u</span> <span class="main">⟶</span> measure_pmf.expectation <span class="free">p</span> <span class="bound">u</span> <span class="main">&lt;</span> measure_pmf.expectation <span class="free">q</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_strict_SD_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SD_Efficiency">
<div class="head">
<h1>Theory SD_Efficiency</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    SD_Efficiency.thy
  Author:   Manuel Eberl, TU München

  Characterisation of SD-efficiency.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> SD_Efficiency
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <a href="Preference_Profiles.html">Preference_Profiles</a> <a href="Lotteries.html">Lotteries</a> <a href="Stochastic_Dominance.html">Stochastic_Dominance</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* 
  TODO: Perhaps a general concept of "efficiency" can be introduced, 
  parametrised over the way in which two lotteries are compared.
*)</span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficient_support_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inefficient<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> support<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p'</span> <span class="main">⊆</span> set_pmf <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lotteries<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> p'_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inefficient <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="skolem">q'</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p'</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p'</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="skolem">q'</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> set_pmf <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> set_pmf <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lotteries <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p'</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="skolem">q'</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_alts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> Min <span class="main">(</span>insert <span class="main">1</span> <span class="main">{</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p'</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="skolem">q'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p'</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="skolem">q'</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">supp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">supp</span> <span class="main">=</span> set_pmf <span class="free">p</span> <span class="main">∪</span> set_pmf <span class="skolem">q'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> lotteries finite_alts q'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> finite_supp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">supp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def supp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> support <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">q'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">supp</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supp_def set_pmf_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> finite support subset <span class="keyword1"><span class="command">have</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ε_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> set_pmf_eq'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p'</span> <span class="skolem">x</span> <span class="main">&gt;</span> pmf <span class="skolem">q'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">≤</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p'</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="skolem">q'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> pmf_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> ε <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> embed_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_count_space'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            ennreal <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="skolem">q'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="free">p'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_ennreal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ennreal_cong<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_subtractf ring_distribs sum.distrib sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> finite_supp support <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> sum_pmf_eq_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> nonneg finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> pmf_q<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="skolem">q'</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">p'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_embed_pmf<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> support <span class="keyword1"><span class="command">have</span></span> support_q<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">q</span> <span class="main">⊆</span> <span class="skolem">supp</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lotteries support q'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> q_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def supp_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> support_q support <span class="keyword1"><span class="command">have</span></span> expected_utility<span class="main">:</span>
    <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">q</span> <span class="skolem">u</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">+</span> 
         <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>measure_pmf.expectation <span class="skolem">q'</span> <span class="skolem">u</span> <span class="main">-</span> measure_pmf.expectation <span class="free">p'</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_supp<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_q supp_def sum.distrib sum_distrib_left 
                   sum_distrib_right sum_subtractf <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> i lotteries q'<span class="main">(</span>1<span class="main">)</span> q'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> q_wf p'_wf ε <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_iff_expected_utilities_le expected_utility<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>›</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> lotteries q'<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> q_wf p'_wf ε <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_iff_expected_utilities_le expected_utility not_le strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> q_wf <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_support_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p'</span> <span class="main">⊆</span> set_pmf <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SD_inefficient_support_subset<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_same_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">=</span> set_pmf <span class="free">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span> <span class="main">⟷</span> SD_efficient <span class="free">R</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SD_inefficient_support_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">p'</span></span><span class="main">]</span> SD_inefficient_support_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span> <span class="main">⟷</span> SD_efficient <span class="free">R</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>set_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_alts
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SD_efficient_same_support<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> set_pmf_of_set<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_not_empty lotteries_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_alts<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_no_pareto_loser<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> efficient<span class="main">:</span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">∩</span> pareto_losers <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> pareto_losers <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>return_pmf <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> set_pmf <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> efficient this p_wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="main">(</span>return_pmf <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SD_efficient_support_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> pareto_losers <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_efficient_singleton_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given two lotteries with the same support where one is strictly Pareto-SD-preferred to 
  the other, one can construct a third lottery that is weakly Pareto-SD-preferred to the 
  better lottery (and therefore strictly Pareto-SD-preferred to the worse lottery) and
  whose support is a strict subset of the original supports.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> improve_lottery_support_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
          <span class="quoted"><span class="quoted">"set_pmf <span class="free">p</span> <span class="main">=</span> set_pmf <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≽[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="free">r</span> <span class="main">⊂</span> set_pmf <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> set_pmf <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_alts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ex_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_neq_exists_less<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> Min <span class="main">{</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">supp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">supp</span> <span class="main">=</span> set_pmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms finite_alts <span class="keyword1"><span class="command">have</span></span> finite_supp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">supp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def supp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">supp</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supp_def set_pmf_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> finite subset ex_less <span class="keyword1"><span class="command">have</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ε_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min.boundedI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> pmf_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">≤</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">q</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> pmf_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> ε <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> embed_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_count_space'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            ennreal <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_ennreal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ennreal_cong<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_subtractf ring_distribs sum.distrib sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> finite_supp  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> sum_pmf_eq_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supp_def assms<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">supp</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> nonneg finite_supp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> pmf_r<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">r</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>pmf <span class="free">q</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_embed_pmf<span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">r</span> <span class="main">⊆</span> <span class="skolem">supp</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite ex_less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">∈</span> <span class="main">{</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">-</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> ε_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_in<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span>pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">-</span> pmf <span class="free">q</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pmf <span class="skolem">r</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_r <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">&gt;</span> pmf <span class="free">q</span> <span class="skolem">x</span>›</span></span> pmf_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="free">p</span> <span class="main">-</span> set_pmf <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set_pmf <span class="skolem">r</span> <span class="main">⊆</span> <span class="skolem">supp</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> support_r<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">r</span> <span class="main">⊂</span> set_pmf <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword1"><span class="command">have</span></span> r_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≽[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SD.Pareto_iff <span class="keyword1"><span class="command">unfolding</span></span> o_def
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> SD_iff_expected_utilities_le<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_vnm_utility <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> support_r <span class="keyword1"><span class="command">have</span></span> expected_utility_r<span class="main">:</span>
        <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span> <span class="main">=</span> measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">+</span> 
             <span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span> <span class="main">-</span> measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> integral_measure_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_supp<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supp_def assms pmf_r sum.distrib sum_distrib_left
            sum_distrib_right sum_subtractf <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assms i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD.Pareto_strict_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span> <span class="main">≥</span> measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SD_iff_expected_utilities_le r_wf<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ε</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="free">p</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">q</span> <span class="skolem">u</span> <span class="main">≤</span> measure_pmf.expectation <span class="skolem">r</span> <span class="skolem">u</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> expected_utility_r<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> r_wf this support_r<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Existence of SD-efficient lotteries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we will show that any lottery can be `improved' to an SD-efficient lottery,
  i.e. for any lottery, there exists an SD-efficient lottery that is weakly SD-preferred to 
  the original one by all agents.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> lottery"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lott<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">improve_lottery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> lottery <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">improve_lottery</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">r</span></span><span class="main">∈</span>lotteries_on <span class="free">alts</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> set_pmf <span class="bound">r'</span> <span class="main">⊂</span> set_pmf <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> improve_lottery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> improve_lottery <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">⟹</span> <span class="bound">r'</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span>set_pmf <span class="bound">r'</span> <span class="main">⊂</span> set_pmf <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">r</span></span><span class="main">∈</span>lotteries_on <span class="free">alts</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> subset_alts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> set_pmf<span class="main">`</span><span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="keyword1"><span class="command">using</span></span> that 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> r_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> set_pmf <span class="bound">r'</span> <span class="main">⊂</span> set_pmf <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def improve_lottery_def Let_def A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def SD_efficient_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nonempty'<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf<span class="main">`</span><span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">`</span> <span class="skolem">A</span> <span class="main">⊆</span> Pow <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def lotteries_on_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> finite_alts <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">X</span><span class="main">,</span><span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊂</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊆</span> <span class="free">alts</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset_wf<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> set_pmf<span class="main">`</span><span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">⊂</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∉</span> set_pmf <span class="main">`</span> <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfE_min'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf nonempty'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> set_pmf <span class="bound">r'</span> <span class="main">⊂</span> set_pmf <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_alts<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> r_altdef<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">⟹</span> <span class="bound">r'</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span>set_pmf <span class="bound">r'</span> <span class="main">⊂</span> set_pmf <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">sd_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'alt</span> lottery option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sd_chain</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sd_chain</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">case</span> <span class="free">sd_chain</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> None
      <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">if</span> SD_efficient <span class="free">R</span> <span class="bound">p</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>improve_lottery <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_None_propagate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> sd_chain <span class="free">n</span> <span class="main">=</span> None <span class="main">⟹</span> sd_chain <span class="free">m</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_Some_propagate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> sd_chain <span class="free">m</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> sd_chain <span class="free">n</span> <span class="main">=</span> Some <span class="bound">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sd_chain_None_propagate<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_NoneD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sd_chain <span class="free">n</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> sd_chain <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">p</span> <span class="main">∧</span> SD_efficient <span class="free">R</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_lottery<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">n</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> lott<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> improve_lottery<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">m</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≺[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> improve_lottery<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_strictly_preferred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">m</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">n</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≺[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strict_inc_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">k</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sd_chain_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sd_chain.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step.hyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sd_chain_Some_propagate<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> step.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_chain <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sd_chain.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≺[</span>Pareto <span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sd_chain_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> r step.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≺[</span>Pareto <span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step.IH<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SD.Pareto.strict_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> sd_chain_preferred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">m</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="free">n</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≼[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> sd_chain_strictly_preferred<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SD.Pareto.refl sd_chain_lottery<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_efficient_lottery_exists<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≽[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> sd_chain <span class="bound">n</span> <span class="main">=</span> None"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> sd_chain <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> option.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> sd_chain <span class="bound">m</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_chain <span class="skolem">m</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword1"><span class="command">have</span></span> m_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nz Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> sd_chain <span class="bound">m</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> m_def<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_chain <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sd_chain <span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sd_chain_preferred<span class="main">[</span><span class="operator">OF</span> _ sd_chain.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≽[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_chain_lottery<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>set_pmf <span class="main">∘</span> the <span class="main">∘</span> sd_chain<span class="main">)</span> <span class="main">⊆</span> Pow <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> sd_chain_lottery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>set_pmf <span class="main">∘</span> the <span class="main">∘</span> sd_chain<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> pigeonhole_infinite<span class="main">[</span><span class="operator">OF</span> infinite_UNIV_nat this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">n</span><span class="main">.</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">{</span><span class="bound">n</span><span class="main">.</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">k</span> <span class="main">&gt;</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="bound">n</span><span class="main">.</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">k</span> <span class="main">&gt;</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_pmf <span class="main">(</span>the <span class="main">(</span>sd_chain <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_chain <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"sd_chain <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> mn pq <span class="keyword1"><span class="command">have</span></span> supp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="skolem">p</span> <span class="main">=</span> set_pmf <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> mn<span class="main">(</span>1<span class="main">)</span> pq <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≺[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sd_chain_strictly_preferred<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹sd_chain <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">q</span>›</span></span> sd_chain.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> improve_lottery <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sd_chain.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> pq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_chain_lottery<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> improve_lottery_support_subset<span class="main">[</span><span class="operator">OF</span> this less supp_eq<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> s <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> improve_lottery<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> r s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SD.Pareto.strict_weak_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> improve_lottery<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> supp_eq r 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>set_pmf <span class="skolem">s</span> <span class="main">⊂</span> set_pmf <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>lotteries_on <span class="free">alts</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≽[</span>Pareto<span class="main">(</span>SD<span class="main">∘</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span> <span class="main">∧</span> SD_efficient <span class="free">R</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SD_efficient_lottery_exists<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Social_Decision_Schemes">
<div class="head">
<h1>Theory Social_Decision_Schemes</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Social Decision Schemes.thy
  Author:   Manuel Eberl, TU München

  Definitions of Social Decision Schemes, their properties, and related concepts
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Social Decision Schemes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Social_Decision_Schemes
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
  <a href="Preference_Profiles.html">Preference_Profiles</a>
  <a href="Elections.html">Elections</a>
  <a href="Order_Predicates.html">Order_Predicates</a>
  <a href="Stochastic_Dominance.html">Stochastic_Dominance</a>
  <a href="SD_Efficiency.html">SD_Efficiency</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Social Choice definitions›</span></span>

<span class="keyword1"><span class="command">context</span></span> election
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The set of lotteries, i.e. the probability mass functions on the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  whose support is a subset of the alternative set. 
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lotteries</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lotteries</span> <span class="main">≡</span> lotteries_on <span class="free">alts</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The probability that a lottery returns an alternative that is in the given set
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lottery_prob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> lottery <span class="main">⇒</span> <span class="tfree">'alt</span> set <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lottery_prob</span> <span class="main">≡</span> measure_pmf.prob"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lottery_prob_alts_superset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lottery_prob <span class="free">p</span> <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf.prob_eq_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AE_measure_pmf_iff lotteries_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lottery_prob_alts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries <span class="main">⟹</span> lottery_prob <span class="free">p</span> <span class="free">alts</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lottery_prob_alts_superset<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the context of an election, a preference profile is a function that 
  assigns to each agent her preference relation (which is a total preorder)
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Social Decision Schemes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the context of an election, a Social Decision Scheme (SDS) is a function that 
  maps preference profiles to lotteries on the alternatives.
›</span></span> 
<span class="keyword1"><span class="command">locale</span></span> social_decision_scheme <span class="main">=</span> election <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sds_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span> <span class="main">⟹</span> <span class="free">sds</span> <span class="free">R</span> <span class="main">∈</span> lotteries"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Anonymity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An SDS is anonymous if permuting the agents in the input does not change the result.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> anonymous_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> anonymous<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span> <span class="main">⟹</span> is_pref_profile <span class="free">R</span> <span class="main">⟹</span> <span class="free">sds</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="free">R</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> anonymity_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">(</span>prefs_from_table <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prefs_from_table_agent_permutation<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> π <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> anonymous<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> anonymity_prefs_from_table_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">=</span> prefs_from_table <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">=</span> prefs_from_table <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="free">R1</span> <span class="main">=</span> <span class="free">sds</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> anonymity_prefs_from_table<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mset_map<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Neutrality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An SDS is neutral if permuting the alternatives in the input does not change the
  result, modulo the equivalent permutation in the output lottery.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> neutral_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> neutral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span> <span class="main">⟹</span> is_pref_profile <span class="free">R</span> <span class="main">⟹</span> 
                        <span class="free">sds</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Alternative formulation of neutrality that shows that our definition is 
  equivalent to that in the paper.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> neutral'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sds_wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> pmf <span class="main">(</span>map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> neutral<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_map_inj'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> an_sds <span class="main">=</span> 
  anonymous_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span> neutral_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sds_anonymous_neutral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R1</span> <span class="main">=</span> 
                 image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="free">R1</span> <span class="main">=</span> map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R1<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> R2<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2.wf_permute_alts<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eq perm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R1</span> <span class="main">=</span> anonymous_profile <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2.anonymous_profile_permute<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> anonymous_profile_agent_permutation<span class="main">[</span><span class="operator">OF</span> this wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf'<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span> <span class="main">=</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> anonymous<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> neutral<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="free">σ</span> <span class="free">R2</span> <span class="main">∘</span> <span class="skolem">π</span> <span class="main">=</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sds_anonymous_neutral'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R1</span> <span class="main">=</span> 
                 image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="free">R1</span> <span class="main">=</span> map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sds_anonymous_neutral<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">…</span> <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_map_inj' permutes_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sds_automorphism<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R</span><span class="main">)</span> <span class="main">=</span> anonymous_profile <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sds_anonymous_neutral<span class="main">[</span><span class="operator">OF</span> perm wf wf eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> an_sds_automorphism_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">yss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> prefs_from_table <span class="free">yss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> an<span class="main">:</span> <span class="quoted"><span class="quoted">"an_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>permutation_of_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="free">yss</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">yss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> 
                <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> permutation_of_list <span class="free">xs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> perm <span class="main">=</span> list_permutesI<span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"permutation_of_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> perm' <span class="main">=</span> permutation_of_list_permutes <span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm' <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"permute_profile <span class="var">?σ</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.wf_permute_alts<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> an <span class="keyword1"><span class="command">interpret</span></span> an_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> eq wf <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="var">?σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R</span><span class="main">)</span> <span class="main">=</span> anonymous_profile <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> anonymise_prefs_from_table mset_map multiset.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> perm' x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> pmf <span class="main">(</span>map_pmf <span class="var">?σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?σ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_map_inj' permutes_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq' x wf' perm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="var">?σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sds_automorphism<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.anonymous_profile_permute pref_profile_from_tableI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ex-post efficiency›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ex_post_efficient_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ex_post_efficient<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span> <span class="main">⟹</span> set_pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="main">∩</span> pareto_losers <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_post_efficient'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_post_efficient<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq pareto_losers_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_post_efficient''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="free">y</span> <span class="main">≽[</span><span class="free">R</span> <span class="bound">i</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">y</span> <span class="main">≼[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex_post_efficient'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pareto_iff strongly_preferred_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹SD efficiency›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An SDS is SD-efficient if it returns an SD-efficient lottery for every 
  preference profile, i.e. if the SDS outputs a lottery, it is never the case 
  that there is another lottery that is weakly preferred by all agents an 
  strictly preferred by at least one agent.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> sd_efficient_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SD_efficient<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span> <span class="main">⟹</span> SD_efficient <span class="free">R</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An alternative formulation of SD-efficiency that is somewhat more convenient to use.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SD_efficient'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≻[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> SD_efficient<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> sds_wf<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> SD_efficient_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any SD-efficient SDS is also ex-post efficient.
›</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> ex_post_efficient_sds
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> R_wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span><span class="free">sds</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∩</span> pareto_losers <span class="skolem">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SD_efficient_no_pareto_loser SD_efficient sds_wf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following rule can be used to derive facts from inefficient supports:
  If a set of alternatives is an inefficient support, at least one of the 
  alternatives in it must receive probability 0.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> SD_inefficient_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inefficient<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> set_pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_pmf_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_alts<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inefficient <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SD_inefficient_support_subset<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf sds_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SD_efficient wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficient_support'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
     wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="free">p</span> <span class="main">≽[</span>SD<span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span> pmf_of_set <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> pmf_of_set <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SD_inefficient_support<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wit <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SD_inefficientI'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak strategyproofness›</span></span>

<span class="keyword1"><span class="command">context</span></span> social_decision_scheme
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The SDS is said to be manipulable for a particular preference profile,
  a particular agent, and a particular alternative preference ordering for that agent
  if the lottery obtained if the agent submits the alternative preferences strictly 
  SD-dominates that obtained if the original preferences are submitted.
  (SD-dominated w.r.t. the original preferences)
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">manipulable_profile</span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span> relation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">manipulable_profile</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">Ri'</span></span></span> <span class="main">⟷</span> <span class="free">sds</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">Ri'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≻[</span>SD <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An SDS is weakly strategyproof (or just strategyproof) if it is not manipulable 
  for any combination of preference profiles, agents, and alternative preference relations.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> strategyproof_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strategyproof<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span> <span class="main">⟹</span>
         <span class="main">¬</span>manipulable_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span>  


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong strategyproofness›</span></span>

<span class="keyword1"><span class="command">context</span></span> social_decision_scheme
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The SDS is said to be strongly strategyproof for a particular preference profile, 
  a particular agent, and a particular alternative preference ordering for that agent
  if the lottery obtained if the agent submits the alternative preferences is
  SD-dominated by the one obtained if the original preferences are submitted.
  (SD-dominated w.r.t. the original preferences)
  
  In other words: the SDS is strategyproof w.r.t the preference profile $R$ and 
  the agent $i$ and the alternative preference relation $R_i'$ if the lottery for 
  obtained for $R$ is at least as good for $i$ as the lottery obtained when $i$ 
  misrepresents her preferences as $R_i'$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strongly_strategyproof_profile</span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'agent</span> <span class="main">⇒</span> <span class="tfree">'alt</span> relation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strongly_strategyproof_profile</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">Ri'</span></span></span> <span class="main">⟷</span> <span class="free">sds</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≽[</span>SD <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">Ri'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strongly_strategyproof_profileI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>
                               <span class="main">≤</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strongly_strategyproof_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strongly_strategyproof_profile_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sds_wf assms pref_profile_wf.wf_update<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strongly_strategyproof_imp_not_manipulable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strongly_strategyproof_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>manipulable_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> strongly_strategyproof_profile_def manipulable_profile_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An SDS is strongly strategyproof if it is strongly strategyproof for all combinations
  of preference profiles, agents, and alternative preference relations.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> strongly_strategyproof_sds <span class="main">=</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strongly_strategyproof<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span> <span class="main">⟹</span>
         strongly_strategyproof_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any SDS that is strongly strategyproof is also weakly strategyproof.
›</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> strategyproof_sds
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_strategyproof_imp_not_manipulable strongly_strategyproof<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> strategyproof_an_sds <span class="main">=</span>
  strategyproof_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span> an_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SDS_Lowering">
<div class="head">
<h1>Theory SDS_Lowering</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    SDS_Lowering.thy
  Author:   Manuel Eberl, TU München

  Allows to lower an SDS, i.e. take an existing ex-post efficient SDS
  and construct from it an SDS for fewer agents and alternatives. (which is
  also ex-post efficient)
    The standard properties (anonymity, neutrality, SD efficiency, strategyproofness)
  are preserved by this construction.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lowering Social Decision Schemes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SDS_Lowering
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Social_Decision_Schemes.html">Social_Decision_Schemes</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_pref_profile</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set <span class="main">⇒</span> <span class="tfree">'alt</span> set <span class="main">⇒</span> <span class="tfree">'agent</span> set <span class="main">⇒</span> <span class="tfree">'alt</span> set <span class="main">⇒</span>
       <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_pref_profile</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">agents'</span></span></span> <span class="free"><span class="bound"><span class="entity">alts'</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> 
     <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">alts'</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">alts'</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">agents'</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">⊆</span> <span class="free">agents'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≡</span> lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts'</span> <span class="main">(</span><span class="free">R'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> True assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> total <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lift_pref_profile_def R'_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pref_profile_wf_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_permute_agents<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">⊆</span> <span class="free">agents'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> 
             lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span> <span class="main">∘</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms permutes_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def o_def permutes_in_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_permute_alts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> 
             permute_profile <span class="free">σ</span> <span class="main">(</span>lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> permutes_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms permutes_inj<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inv <span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def permutes_in_image
          permute_profile_def fun_eq_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> lotteries_on_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">A</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lotteries_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> lottery_prob_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">A</span> <span class="main">⟹</span> measure_pmf.prob <span class="free">p</span> <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measure_pmf.prob_eq_1 lotteries_on_def AE_measure_pmf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> election<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">⊆</span> <span class="free">agents'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≡</span> lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">interpretation</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="free">R'</span></span> 
  <span class="keyword1"><span class="command">using</span></span> election R_wf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_def lift_pref_profile_wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_strict_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span>lift_pref_profile <span class="free">agents</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span>
     <span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">-</span> <span class="free">alts</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≺[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_outside election
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def strongly_preferred_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_pref_profile_def strongly_preferred_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_alts_lift_pref_profile<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span><span class="free">R'</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
             <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="keyword1">then</span> preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">alts'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> Ri<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> i x election Ri.not_outside
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def R'_def lift_pref_profile_def Ri.refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def R'_def lift_pref_profile_def i x<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_Pareto_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> <span class="free">alts</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≼[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> R.nonempty_agents <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> Ri<span class="main">:</span> finite_total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> R'.Pareto_iff R.Pareto_iff <span class="keyword1"><span class="command">unfolding</span></span> R'_def lift_pref_profile_def
    <span class="keyword1"><span class="command">using</span></span> election i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preorder_on.refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R.in_dom<span class="main"><span class="main">]</span></span> 
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> R.nonempty_alts R.nonempty_agents  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ri.not_outside<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_pref_profile_Pareto_strict_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> <span class="free">alts</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def lift_pref_profile_Pareto_iff R.Pareto.not_outside<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pareto_losers_lift_pref_profile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pareto_losers <span class="free">R'</span> <span class="main">=</span> pareto_losers <span class="free">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">alts'</span> <span class="main">-</span> <span class="free">alts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≺[</span>Pareto<span class="main">(</span><span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that R.Pareto.not_outside <span class="keyword1"><span class="command">unfolding</span></span> strongly_preferred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> election that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> R.nonempty_alts <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pareto_losers_def lift_pref_profile_Pareto_strict_iff <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> lift_SD_iff_agent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R'</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">interpret</span></span> Ri<span class="main">:</span> preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> i election <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R'i<span class="main">:</span> preorder_on <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms election <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lotteries_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms election i' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ri.SD_preorder R'i.SD_preorder 
          preferred_alts_lift_pref_profile lottery_prob_carrier<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> lift_SD_iff_nonagent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span> <span class="main">-</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R'</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i election <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R'i<span class="main">:</span> preorder_on <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms election <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lotteries_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms election i' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R'i.SD_preorder preferred_alts_lift_pref_profile lottery_prob_carrier<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lift_SD_iff <span class="main">=</span> lift_SD_iff_agent lift_SD_iff_nonagent

<span class="keyword1"><span class="command">lemma</span></span> lift_SD_iff'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span> <span class="main">⟹</span>
     <span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R'</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_SD_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_SD_strict_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">R'</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≺[</span>SD<span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def lift_SD_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_Pareto_SD_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≼[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms election <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.SD.Pareto_iff R'.SD.Pareto_iff lift_SD_iff'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_Pareto_SD_strict_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≺[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≺[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def lift_Pareto_SD_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_SD_efficient_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R'</span> <span class="free">p</span> <span class="main">⟷</span> SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eff<span class="main">:</span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">q</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> q election <span class="keyword1"><span class="command">have</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lotteries_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">q</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'.SD_efficient_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_Pareto_SD_strict_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.SD_efficient_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eff<span class="main">:</span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">q</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> lotteries_on <span class="free">alts'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> R'.SD_efficient_lottery_exists<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> q' <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> q' <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_pmf <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">-</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pareto_losers <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pareto_losers_lift_pref_profile<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> R'.SD_efficient_no_pareto_loser<span class="main">[</span><span class="operator">OF</span> q'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_pmf <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q' less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R'</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> R'.SD.Pareto.strict_weak_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> lotteries_on <span class="free">alts</span>›</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≻[</span>Pareto<span class="main">(</span>SD <span class="main">∘</span> <span class="free">R</span><span class="main">)</span><span class="main">]</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lift_Pareto_SD_strict_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD_efficient <span class="free">R</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.SD_efficient_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eff <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="free">R'</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'.SD_efficient_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> sds_lowering <span class="main">=</span> 
  ex_post_efficient_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">agents'</span> <span class="free">alts'</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> agents'_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alts'_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> agents'_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">agents'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alts'_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_agents' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> agents'_subset finite_agents <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_alts' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alts'_subset finite_alts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">≡</span> lift_pref_profile <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">agents</span> <span class="free">alts</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lowered</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lowered</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">∘</span> lift"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_wf <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span> <span class="main">⟹</span> is_pref_profile <span class="main">(</span>lift <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alts'_subset agents'_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lift_pref_profile_wf<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">sublocale</span></span> lowered<span class="main">:</span> election <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_alts_lift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="free">R</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span>
     preferred_alts <span class="main">(</span>lift <span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">agents'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="keyword1">then</span> preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">alts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alts'_subset agents'_subset
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> preferred_alts_lift_pref_profile<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pareto_losers_lift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="free">R</span> <span class="main">⟹</span> pareto_losers <span class="main">(</span>lift <span class="free">R</span><span class="main">)</span> <span class="main">=</span> pareto_losers <span class="free">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">alts</span> <span class="main">-</span> <span class="free">alts'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> agents'_subset alts'_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pareto_losers_lift_pref_profile<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> lowered_lotteries<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.lotteries <span class="main">⊆</span> lotteries"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lotteries_on_def <span class="keyword1"><span class="command">using</span></span> alts'_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">sublocale</span></span> lowered<span class="main">:</span> social_decision_scheme <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents'</span> <span class="free">alts'</span> <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R_wf <span class="keyword1"><span class="command">have</span></span> R'_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lift_wf<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lowered <span class="skolem">R</span> <span class="main">∈</span> lowered.lotteries"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lotteries_on_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>lowered <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="free">sds</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowered_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ex_post_efficient<span class="main">[</span><span class="operator">OF</span> R'_wf<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> pareto_losers <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> pareto_losers_lift<span class="main">[</span><span class="operator">OF</span> R_wf<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">alts</span> <span class="main">-</span> <span class="free">alts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sds_wf<span class="main">[</span><span class="operator">OF</span> R'_wf<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ex_post_efficient_sds <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>lowered <span class="skolem">R</span><span class="main">)</span> <span class="main">∩</span> pareto_losers <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lowered_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex_post_efficient lift_wf R_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pareto_losers <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> pareto_losers <span class="skolem">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">alts</span> <span class="main">-</span> <span class="free">alts'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pareto_losers_lift R_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>lowered <span class="skolem">R</span><span class="main">)</span> <span class="main">∩</span> pareto_losers <span class="skolem">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lowered_in_lotteries <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="free">R</span> <span class="main">⟹</span> lowered <span class="free">R</span> <span class="main">∈</span> lotteries"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lowered.sds_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> lowered_lotteries <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">locale</span></span> sds_lowering_anonymous <span class="main">=</span>
  anonymous_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span>
  sds_lowering <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="free">agents'</span> <span class="free">alts'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> lowered<span class="main">:</span> anonymous_sds <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> lift <span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> agents'_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lift_pref_profile_permute_agents<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>lift <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">(</span>lift <span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> perm R_wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> agents'_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> permutes_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> anonymous<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>lift <span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowered_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lowered <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> lowered <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lowered_def o_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sds_lowering_neutral <span class="main">=</span>
  neutral_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span>
  sds_lowering <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="free">agents'</span> <span class="free">alts'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> lowered<span class="main">:</span> neutral_sds <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">permutes</span> <span class="free">alts'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm alts'_subset 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> permute_profile <span class="skolem">σ</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lift_pref_profile_permute_alts<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>lift <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sds</span> <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> R_wf perm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> perm alts'_subset 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="skolem">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lowered <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="skolem">σ</span> <span class="main">(</span>lowered <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowered_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sds_lowering_sd_efficient <span class="main">=</span>
  sd_efficient_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span>
  sds_lowering <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="free">agents'</span> <span class="free">alts'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sd_efficient_sds <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> R_wf agents'_subset alts'_subset <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SD_efficient <span class="skolem">R</span> <span class="main">(</span>lowered <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lowered_def o_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lift_SD_efficient_iff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> SD_efficient R_wf lowered.sds_wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R_wf<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lowered_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> sds_lowering_strategyproof <span class="main">=</span>
  strategyproof_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="main">+</span>
  sds_lowering <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">agents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'alt</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sds</span> <span class="free">agents'</span> <span class="free">alts'</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> strategyproof_sds <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted">lowered</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">Ri'</span>
  <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.is_pref_profile <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents'</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ri'<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts'</span> <span class="skolem">Ri'</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> manipulable<span class="main">:</span> <span class="quoted"><span class="quoted">"lowered.manipulable_profile <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">Ri'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> i agents'_subset <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> R_wf <span class="keyword1"><span class="command">interpret</span></span> liftR<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"lift <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lift_Ri'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lift_Ri'</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">alts'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts'</span> <span class="main">∧</span> <span class="skolem">Ri'</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">lift_Ri'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Ri' <span class="keyword1"><span class="command">interpret</span></span> Ri'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts'</span></span> <span class="quoted"><span class="skolem">Ri'</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_lift_Ri'<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="skolem">lift_Ri'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ri'.total
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_Ri'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ri'.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> agents'_subset i <span class="keyword1"><span class="command">have</span></span> S_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> lift <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff lift_pref_profile_def lift_Ri'_def S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lowered <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lowered.lotteries"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lowered.sds_wf R.wf_update i Ri'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> sds_S_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="skolem">S</span> <span class="main">∈</span> lowered.lotteries"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_altdef lowered_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> manipulable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lowered <span class="skolem">R</span> <span class="main">≺[</span>SD <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="main">(</span>lift <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lowered.manipulable_profile_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowered_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> S_altdef <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lowered <span class="skolem">R</span> <span class="main">≺[</span>SD <span class="main">(</span>lift <span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="free">sds</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R_wf i lowered.sds_wf<span class="main">[</span><span class="operator">OF</span> R_wf<span class="main">]</span> sds_S_wf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lift_SD_strict_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agents'_subset alts'_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"manipulable_profile <span class="main">(</span>lift <span class="skolem">R</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">lift_Ri'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> manipulable_profile_def lowered_def S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> strategyproof<span class="main">[</span><span class="operator">OF</span> lift_wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R_wf<span class="main"><span class="main">]</span></span> i' wf_lift_Ri'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> sds_lowering_anonymous_neutral_sdeff_stratproof <span class="main">=</span>
  sds_lowering_anonymous <span class="main">+</span> sds_lowering_neutral <span class="main">+</span> 
  sds_lowering_sd_efficient <span class="main">+</span> sds_lowering_strategyproof

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Random_Dictatorship">
<div class="head">
<h1>Theory Random_Dictatorship</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Random_Dictatorship.thy
  Author:   Manuel Eberl, TU München

  Definition and basic properties of Random Dictatorship
  (on weak preferences)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Random Dictatorship›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Random_Dictatorship
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="Social_Decision_Schemes.html">Social_Decision_Schemes</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define Random Dictatorship as a social decision scheme on total preorders 
  (i.e. agents are allowed to have ties in their rankings) by first selecting an agent
  uniformly at random and then selecting one of that agents' most preferred alternatives
  uniformly at random. Note that this definition also works for weak preferences.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">random_dictatorship</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set <span class="main">⇒</span> <span class="tfree">'alt</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  random_dictatorship_auxdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">random_dictatorship</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="free"><span class="bound"><span class="entity">agents</span></span></span><span class="main">;</span> 
        pmf_of_set <span class="main">(</span>Max_wrt_among <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span><span class="main">)</span>
      <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> election
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RD</span> <span class="main">≡</span> random_dictatorship <span class="free">agents</span> <span class="free">alts</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> random_dictatorship_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"RD <span class="free">R</span> <span class="main">=</span>
            <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="free">agents</span><span class="main">;</span> 
              pmf_of_set <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span>
            <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_dictatorship_auxdef favorites_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> random_dictatorship_unique_favorites<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RD <span class="free">R</span> <span class="main">=</span> map_pmf <span class="main">(</span>favorite <span class="free">R</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="free">agents</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_unique_favorites <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> random_dictatorship_def<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> map_pmf_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_favorites pmf_of_set_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> random_dictatorship_unique_favorites'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RD <span class="free">R</span> <span class="main">=</span> pmf_of_multiset <span class="main">(</span>image_mset <span class="main">(</span>favorite <span class="free">R</span><span class="main">)</span> <span class="main">(</span>mset_set <span class="free">agents</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_dictatorship_unique_favorites map_pmf_of_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pmf_random_dictatorship<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>RD <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> indicator <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">/</span>
              real <span class="main">(</span>card <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>card <span class="free">agents</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> nonempty_dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">agents</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nonempty_agents<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>pmf <span class="main">(</span>RD <span class="free">R</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
           ennreal <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> pmf <span class="main">(</span>pmf_of_set <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>card <span class="free">agents</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="var">?p</span> <span class="main">/</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> random_dictatorship_def<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_pmf_bind nn_integral_pmf_of_set max_def 
          divide_ennreal <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ennreal_of_nat_eq_real_of_nat sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> indicator <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>card <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_nonempty<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ennreal_inj<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg divide_nonneg_nonneg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> RD<span class="main">:</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> R_wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RD <span class="skolem">R</span> <span class="main">∈</span> lotteries"</span></span>
    <span class="keyword1"><span class="command">using</span></span> favorites_subset_alts favorites_nonempty
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lotteries_on_def random_dictatorship_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that Random Dictatorship fulfils anonymity, neutrality, 
  and strong strategyproofness.
  At the very least, this shows that the definitions of these notions are 
  consistent.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Anonymity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following proof is essentially the following:
  In Random Dictatorship, permuting the agents in the preference profile is the same
  as applying the permutation to the agent that was picked uniformly at random in the 
  first step. However, uniform distributions are invariant under permutation, therefore
  the outcome is totally unchanged.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RD<span class="main">:</span> anonymous_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">π</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> wf_permute_agents<span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RD <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="skolem">π</span> <span class="main">(</span>pmf_of_set <span class="free">agents</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> pmf_of_set <span class="main">(</span>favorites <span class="skolem">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf random_dictatorship_def o_def favorites_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> perm wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> RD <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_of_set_inj permutes_inj_on permutes_image random_dictatorship_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RD <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> RD <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Neutrality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proof of neutrality is similar to that of anonymity. We have proven elsewhere
  that the most preferred alternatives of an agent in a profile with permuted alternatives
  are simply the image of the originally preferred alternatives.
  Since we pick one alternative from the most preferred alternatives of the selected agent
  uniformly at random, this means that we effectively pick an agent, then pick on of her 
  most preferred alternatives, and then apply the permutation to that alternative, 
  which is simply Random Dictatorship transformed with the permutation.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RD<span class="main">:</span> neutral_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">R</span>
  <span class="keyword3"><span class="command">assume</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R_wf <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf_permute_alts<span class="main">[</span><span class="operator">OF</span> perm<span class="main">]</span> R_wf perm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RD <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="skolem">σ</span> <span class="main">(</span>RD <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_dictatorship_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_dictatorship_def map_bind_pmf 
          favorites_permute map_pmf_of_set_inj permutes_inj_on favorites_nonempty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong strategyproofness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The argument for strategyproofness is quite simple:
  Since the preferences submitted by an agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> only influence 
  the outcome when that agent is picked in the first process, it suffices 
  to focus on this case.
  When the agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> submits her true preferences, the probability of 
  obtaining a result at least as good as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (for any alternative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
  is 1, since the outcome will always be one of her most-preferred alternatives.
  Obviously, the probability of obtaining such a result cannot exceed 1 no matter
  what preferences she submits instead, and thus, RD is strategyproof.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RD<span class="main">:</span> strongly_strategyproof_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RD</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> RD.strongly_strategyproof_profile_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">Ri'</span> <span class="keyword3"><span class="command">assume</span></span> R_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> Ri'_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="skolem">Ri'</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> R_wf Ri'_wf i <span class="keyword1"><span class="command">have</span></span> R'_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.wf_update<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SD <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>RD <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>RD <span class="skolem">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> R.SD_pref_profileI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>RD <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
             <span class="main">≤</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>RD <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ri'_wf maximal_imp_preferred<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono nn_integral_mono_AE 
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_dictatorship_def R_wf R'_wf AE_measure_pmf_iff Max_wrt_prefs_finite
                     emeasure_pmf_of_set Int_absorb2 favorites_def
                     Max_wrt_prefs_nonempty card_gt_0_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>RD <span class="main">(</span><span class="skolem">R</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
            <span class="main">≤</span> lottery_prob <span class="main">(</span>RD <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_eq_measure<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R_wf R'_wf<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RD.sds_wf i<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Random_Serial_Dictatorship">
<div class="head">
<h1>Theory Random_Serial_Dictatorship</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Random_Serial_Dictatorship.thy
  Author:   Manuel Eberl, TU München

  Definition and basic properties of Random Serial Dictatorship
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Random Serial Dictatorship›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Random_Serial_Dictatorship
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="Social_Decision_Schemes.html">Social_Decision_Schemes</a>
  <a href="Random_Dictatorship.html">Random_Dictatorship</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Random Serial Dictatorship is an anonymous, neutral, strongly strategy-proof, 
  and ex-post efficient Social Decision Scheme that extends Random Dictatorship
  to the domain of weak preferences.
  
  We define RSD using a fold over a random permutation. Effectively, we choose a random
  order of the agents (in the form of a list) and then traverse that list from left to right,
  where each agent in turn removes all the alternatives that are not top-ranked among the 
  remaining ones.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">random_serial_dictatorship</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'agent</span> set <span class="main">⇒</span> <span class="tfree">'alt</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'agent</span><span class="main">,</span> <span class="tfree">'alt</span><span class="main">)</span> pref_profile <span class="main">⇒</span> <span class="tfree">'alt</span> lottery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">random_serial_dictatorship</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> 
     fold_bind_random_permutation <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">alts</span><span class="main">.</span> Max_wrt_among <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">alts</span><span class="main">)</span> pmf_of_set <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following two facts correspond give an alternative recursive definition to
  the above definition, which uses random permutations and list folding.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"random_serial_dictatorship <span class="main">{}</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">=</span> pmf_of_set <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">agents</span> <span class="main">⟹</span> <span class="free">agents</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> 
    random_serial_dictatorship <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="free">agents</span><span class="main">;</span>
        random_serial_dictatorship <span class="main">(</span><span class="free">agents</span> <span class="main">-</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="free">alts</span><span class="main">)</span> <span class="free">R</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_def<span class="main">)</span>
     
     
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the RSD winners w.r.t. a given set of alternatives and a fixed permutation 
  (i.e. list) of agents. In contrast to the above definition, the RSD winners are 
  determined by traversing the list of agents from right to left.
    This may seem strange, but it makes induction much easier, since induction over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  does not require generalisation over the set of alternatives and is therefore much 
  easier than over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">foldl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rsd_winners</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rsd_winners</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">alts</span><span class="main">.</span> Max_wrt_among <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">alts</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rsd_winners_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">agents</span><span class="main">)</span> <span class="main">=</span> Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="free">agents</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rsd_winners_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_map <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">agents</span><span class="main">)</span> <span class="main">=</span> rsd_winners <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">alts</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rsd_winners_def foldr_map o_def<span class="main">)</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There is now another alternative definition of RSD in terms of the
  RSD winners. This will mostly be used for induction.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"random_serial_dictatorship <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">agents'</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">agents</span><span class="main">)</span><span class="main">;</span>
               pmf_of_set <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="bound">agents'</span><span class="main">)</span>
             <span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_def 
         fold_bind_random_permutation_foldr assms rsd_winners_def<span class="main">)</span>
   
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma shows that folding from left to right yields the same
  distribution. This is probably the most commonly used definition in the literature,
  along with the recursive one.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_foldl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"random_serial_dictatorship <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">=</span>
             <span class="keyword1">do</span> <span class="main">{</span>
               <span class="bound">agents'</span> <span class="main">←</span> pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">agents</span><span class="main">)</span><span class="main">;</span>
               pmf_of_set <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">alts</span> <span class="bound">i</span><span class="main">.</span> Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">alts</span><span class="main">)</span> <span class="free">alts</span> <span class="bound">agents'</span><span class="main">)</span>
             <span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_def fold_bind_random_permutation_foldl assms<span class="main">)</span>


   
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts about RSD›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pareto-equivalence classes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First of all, we introduce the auxiliary notion of a Pareto-equivalence class.
  A non-empty set of alternatives is a Pareto equivalence class if all agents are 
  indifferent between all alternatives in it, and if some alternative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  is contained in the set, any other alternative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">y</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is contained in it
  if and only if, to all agents, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is at least as good as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    The importance of this notion lies in the fact that the set of RSD winners is always
  a Pareto-equivalence class, which we will later use to show ex-post efficiency and
  strategy-proofness.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RSD_pareto_eqclass</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RSD_pareto_eqclass</span> <span class="free"><span class="bound"><span class="entity">agents</span></span></span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span>
     <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">alts</span></span></span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">agents</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclassI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> RSD_pareto_eqclass_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclassD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> RSD_pareto_eqclass_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclass_indiff_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> RSD_pareto_eqclass_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclass_empty <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> RSD_pareto_eqclass <span class="main">{}</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">alts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RSD_pareto_eqclassI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pref_profile_wf<span class="main">)</span> RSD_pareto_eqclass_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents'</span> <span class="free">alts</span> <span class="free">R</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="main">(</span>insert <span class="free">i</span> <span class="free">agents'</span><span class="main">)</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">(</span>Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> RSD_pareto_eqclassI Max_wrt_among_nonempty Max_wrt_among_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RSD_pareto_eqclassD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Max_wrt_among_total_preorder 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> RSD_pareto_eqclassD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1 Int_absorb2 finite_subset<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about RSD winners›</span></span>

<span class="keyword1"><span class="command">context</span></span> pref_profile_wf
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any RSD winner is a valid alternative.  
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
      <span class="keyword1"><span class="command">using</span></span> Max_wrt_among_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There is always at least one RSD winner.  
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>  <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="free">agents'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
      <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_nonempty<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> B <span class="main">=</span> this

  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">alts'</span> <span class="main">⊆</span> <span class="free">alts</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">alts'</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="free">agents'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="skolem">agents'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> B<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="skolem">agents'</span>"</span></span><span class="main">]</span> rsd_winners_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">agents'</span></span> <span class="quoted"><span class="free">alts'</span></span><span class="main">]</span> finite wf
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Obviously, the set of RSD winners is always finite.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_finite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="free">agents'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rsd_winners_subset<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rsd_winners_wf <span class="main">=</span> 
  rsd_winners_subset rsd_winners_nonempty rsd_winners_finite


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The set of RSD winners is a Pareto-equivalence class.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclass_rsd_winners_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="main">(</span>set <span class="free">agents'</span><span class="main">)</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="free">agents'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="skolem">agents'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_simps rsd_winners_Cons<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">intro</span> RSD_pareto_eqclass_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons.IH finite<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_pareto_eqclass_rsd_winners<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">=</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="free">agents'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RSD_pareto_eqclass_rsd_winners_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For the proof of strategy-proofness, we need to define indifference sets
  and lift preference relations to sets in a specific way.
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An indifference set for a given preference relation is a non-empty set of alternatives 
  such that the agent is indifferent over all of them.
›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">indiff_set</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indiff_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> indiff_set_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"indiff_set <span class="free">S</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> indiff_set <span class="free">S</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> indiff_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given an arbitrary set of alternatives <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and an indifference set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  we say that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is set-preferred over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> w.r.t. the preference 
  relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if all (or, equivalently, any) of the alternatives in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  are preferred over all alternatives in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">RSD_set_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RSD_set_rel</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> indiff_set <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The most-preferred alternatives (w.r.t. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) among any non-empty set of alternatives 
  form an indifference set w.r.t. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> indiff_set_Max_wrt_among<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">carrier</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"indiff_set <span class="free">S</span> <span class="main">(</span>Max_wrt_among <span class="free">S</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> indiff_set_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">carrier</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="free">S</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_wrt_among_nonempty<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Max_wrt_among <span class="free">S</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>Max_wrt_among <span class="free">S</span> <span class="free">A</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indiff_set_def Max_wrt_among_total_preorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now consider the set of RSD winners in the setting of a preference profile <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  and a manipulated profile <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span> <span class="main"><span class="main">:=</span></span> <span class="free"><span class="free">Ri'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    This theorem shows that the set of RSD winners in the outcome is either the same
  in both cases or the outcome for the truthful profile is an indifference set that is
  set-preferred over the outcome for the manipulated profile.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_manipulation_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">≡</span> rsd_winners <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> rsd_winners <span class="free">R</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">agents'</span> <span class="main">=</span> <span class="free">w</span> <span class="free">agents'</span> <span class="main">∨</span> RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="free">agents'</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">agents'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">j</span> <span class="skolem">agents'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf i <span class="keyword1"><span class="command">interpret</span></span> Ri<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> wf Cons.prems <span class="keyword1"><span class="command">interpret</span></span> Rj<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> Ri'<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ri'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf assms Cons.prems 
    <span class="keyword1"><span class="command">have</span></span> indiff_set<span class="main">:</span> <span class="quoted"><span class="quoted">"indiff_set <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> indiff_set_Max_wrt_among<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite<span class="main"><span class="main">]</span></span> rsd_winners_wf<span class="main">)</span> <span class="operator">simp_all</span>
        
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> j <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> indiff_set Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> RSD_set_rel_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ri.Max_wrt_among_total_preorder Ri'.Max_wrt_among_total_preorder<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> j <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="skolem">agents'</span> <span class="main">=</span> <span class="free">w</span> <span class="skolem">agents'</span> <span class="main">∨</span> RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="skolem">agents'</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">agents'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="skolem">agents'</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">agents'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> indiff_set<span class="main">:</span> <span class="quoted"><span class="quoted">"indiff_set <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">agents'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RSD_set_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems finite <span class="quoted"><span class="quoted">‹<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">agents'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">agents'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rsd_winners_wf<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max_wrt_among <span class="main">(</span><span class="free">R</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">agents'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Rj.Max_wrt_among_nonempty<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indiff_set <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> indiff_set_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> indiff_set<span class="main"><span class="main">]</span></span> Rj.Max_wrt_among_subset<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rj.Max_wrt_among_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> rel <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">w'</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">w</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">.</span> <span class="free">R</span> <span class="free">i</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RSD_set_rel_def Rj.Max_wrt_among_total_preorder<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">#</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> RSD_set_rel_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following variant of the previous theorem is slightly easier to use.
  We eliminate the case where the two outcomes are the same by observing that
  the original outcome is then also set-preferred to the manipulated one.
    In essence, this means that no matter what manipulation is done, the 
  original outcome is always set-preferred to the manipulated one.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_manipulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">=</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">≡</span> rsd_winners <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> rsd_winners <span class="free">R</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">w'</span> <span class="free">agents'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">w</span> <span class="free">agents'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≼[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">agents'</span> <span class="main">=</span> <span class="free">w</span> <span class="free">agents'</span> <span class="main">∨</span> RSD_set_rel <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w'</span> <span class="free">agents'</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">agents'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rsd_winners_manipulation_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>4-6<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">agents'</span> <span class="main">=</span> <span class="free">w</span> <span class="free">agents'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="main">(</span>set <span class="free">agents'</span><span class="main">)</span> <span class="free">alts</span> <span class="free">R</span> <span class="main">(</span><span class="free">w</span> <span class="free">agents'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> RSD_pareto_eqclass_rsd_winners_aux<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> RSD_pareto_eqclass_indiff_set<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> i eq assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RSD_set_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The lottery that RSD yields is well-defined.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>random_serial_dictatorship <span class="free">agents'</span> <span class="free">alts'</span> <span class="free">R</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">agents'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>pmf_of_set <span class="main">(</span>rsd_winners <span class="free">R</span> <span class="free">alts'</span> <span class="skolem">agents''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts'</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">agents''</span> <span class="main">∈</span> permutations_of_set <span class="free">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">agents''</span>
    <span class="keyword1"><span class="command">using</span></span> that assms rsd_winners_wf<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> alts' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">alts'</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> agents' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">agents''</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> A <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Permutation of alternatives commutes with RSD winners.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rsd_winners_permute_profile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rsd_winners <span class="main">(</span>permute_profile <span class="free">σ</span> <span class="free">R</span><span class="main">)</span> <span class="free">alts</span> <span class="free">agents'</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">`</span> rsd_winners <span class="free">R</span> <span class="free">alts</span> <span class="free">agents'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">agents'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="skolem">agents'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf Cons <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> perm Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_profile_map_relation Max_wrt_among_map_relation_bij permutes_bij<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> random_serial_dictatorship_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents'</span> <span class="main">⊆</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"random_serial_dictatorship <span class="free">agents'</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="free">R</span> <span class="main">=</span> return_pmf <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="var">?d</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> random_serial_dictatorship_support<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_pmf_subset_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  With all the facts that we have proven about the RSD winners, the hard work is
  mostly done. We can now simply fix some arbitrary order of the agents, apply the 
  theorems about the RSD winners, and show the properties we want to show without 
  doing much reasoning about probabilities.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> election
<span class="keyword2"><span class="keyword">begin</span></span>     

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">RSD</span> <span class="main">≡</span> random_serial_dictatorship <span class="free">agents</span> <span class="free">alts</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Well-definedness›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RSD<span class="main">:</span> social_decision_scheme <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RSD</span>
  <span class="keyword1"><span class="command">using</span></span> pref_profile_wf.random_serial_dictatorship_support<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lotteries_on_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹RD extension›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RSD_extends_RD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"has_unique_favorites <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RSD <span class="free">R</span> <span class="main">=</span> RD <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> unique <span class="keyword1"><span class="command">interpret</span></span> pref_profile_unique_favorites <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD <span class="free">R</span> <span class="main">=</span> pmf_of_set <span class="free">agents</span> <span class="main">⤜</span> 
                  <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> random_serial_dictatorship <span class="main">(</span><span class="free">agents</span> <span class="main">-</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>favorites <span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_nonempty favorites_altdef Max_wrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="free">agents</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> return_pmf <span class="main">(</span>favorite <span class="free">R</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> random_serial_dictatorship_singleton <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_favorites favorite_in_alts<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> RD <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_dictatorship_unique_favorites map_pmf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Anonymity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Anonymity is a direct consequence of the fact that we randomise over all
  permutations in a uniform way.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RSD<span class="main">:</span> anonymous_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RSD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">agents'</span><span class="main">.</span> pmf_of_set <span class="main">(</span>rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="bound">agents'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span>map <span class="skolem">π</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">agents</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_altdef bind_map_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> RSD <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_pmf_of_set_inj permutes_inj_on inj_on_mapI
                  permutations_of_set_image_permutes random_serial_dictatorship_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RSD <span class="main">(</span><span class="skolem">R</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> RSD <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Neutrality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Neutrality follows from the fact that the RSD winners of a permuted profile 
  are simply the image of the original RSD winners under the permutation.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RSD<span class="main">:</span> neutral_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RSD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RSD <span class="main">(</span>permute_profile <span class="skolem">σ</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="skolem">σ</span> <span class="main">(</span>RSD <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> permutations_of_setD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_altdef rsd_winners_permute_profile
                   map_bind_pmf map_pmf_of_set_inj permutes_inj_on rsd_winners_wf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Ex-post efficiency›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Ex-post efficiency follows from the fact that the set of RSD winners 
  is a Pareto-equivalence class.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RSD<span class="main">:</span> ex_post_efficient_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RSD</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>RSD <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pareto_losers <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pareto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≻[</span>Pareto<span class="main">(</span><span class="skolem">R</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pareto_losersE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pareto_loser_in_alts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">agents'</span></span> <span class="keyword2"><span class="keyword">where</span></span> agents'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">agents'</span> <span class="main">=</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>pmf_of_set <span class="main">(</span>rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_altdef <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> permutations_of_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rsd_winners_wf<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> alts' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">alts</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> agents' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">agents'</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_of_setD<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> wf agents' 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="skolem">R</span> <span class="main">(</span>rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> RSD_pareto_eqclass_rsd_winners<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> winner_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≼[</span><span class="skolem">R</span> <span class="bound">i</span><span class="main">]</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> RSD_pareto_eqclass_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> x' pareto winner_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> winner_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strongly_preferred_def Pareto_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>RSD <span class="skolem">R</span><span class="main">)</span> <span class="main">∩</span> pareto_losers <span class="skolem">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Strong strategy-proofness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Strong strategy-proofness is slightly more difficult to show. We have already shown
  that the set of RSD winners for the truthful profile is always set-preferred (by the
  manipulating agent) to the RSD winners for the manipulated profile.
    This can now be used to show strategy-proofness: We recall that the set of RSD 
  winners is always an indifference class. Therefore, given any fixed alternative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  and considering a fixed order of the agents, either all of the RSD winners in the original
  profile are at least as good as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or none of them are, and, since the original 
  RSD winners are set-preferred to the manipulated ones, none of the RSD winners in the
  manipulated case are at least as good than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> either in that case.
    This means that for a fixed order of agents, either the probability that the original  
  outcome is at least as good as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is 1 or the probability that the manipulated
  outcome is at least as good as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'alt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is 0.
    Therefore, the original lottery is clearly SD-preferred to the manipulated one.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RSD<span class="main">:</span> strongly_strategyproof_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted">RSD</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="skolem">Ri'</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="skolem">Ri'</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">Ri'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf wf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_def R.wf_update<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> R'<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="skolem">R'</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> wf <span class="main">=</span> wf wf'
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">interpret</span></span> Ri<span class="main">:</span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">agents'</span> <span class="keyword3"><span class="command">assume</span></span> agents'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">agents'</span> <span class="main">∈</span> permutations_of_set <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> agents' <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">agents'</span> <span class="main">=</span> <span class="free">agents</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutations_of_set_def<span class="main">)</span>
      
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?W</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rsd_winners <span class="skolem">R</span> <span class="free">alts</span> <span class="skolem">agents'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?W'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rsd_winners <span class="skolem">R'</span> <span class="free">alts</span> <span class="skolem">agents'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> indiff_set<span class="main">:</span> <span class="quoted"><span class="quoted">"RSD_pareto_eqclass <span class="free">agents</span> <span class="free">alts</span> <span class="skolem">R</span> <span class="var">?W</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R.RSD_pareto_eqclass_rsd_winners<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> R.rsd_winners_wf R'.rsd_winners_wf
      <span class="keyword1"><span class="command">have</span></span> winners<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W'</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?W'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?W</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> winners <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> wf' i <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?W'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?W</span><span class="main">.</span> <span class="skolem">R</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R.rsd_winners_manipulation<span class="main">)</span> <span class="operator">simp_all</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>pmf_of_set <span class="var">?W</span><span class="main">)</span> <span class="var">?A</span> <span class="main">≥</span> lottery_prob <span class="main">(</span>pmf_of_set <span class="var">?W'</span><span class="main">)</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≽[</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">]</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> y RSD_pareto_eqclass_indiff_set<span class="main">[</span><span class="operator">OF</span> indiff_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>  winners
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">⊆</span> preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ri.trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> winners <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> measure_pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> y mono <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W'</span> <span class="main">∩</span> preferred_alts <span class="main">(</span><span class="skolem">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ri.trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> winners <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> measure_pmf_of_set<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb2 one_ereal_def measure_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>pmf_of_set <span class="var">?W</span><span class="main">)</span><span class="main">)</span> <span class="var">?A</span> <span class="main">≥</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>pmf_of_set <span class="var">?W'</span><span class="main">)</span><span class="main">)</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_eq_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>RSD <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="var">?A</span> <span class="main">≥</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>RSD <span class="skolem">R'</span><span class="main">)</span><span class="main">)</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_serial_dictatorship_altdef AE_measure_pmf_iff
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_mono_AE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>RSD <span class="skolem">R</span><span class="main">)</span> <span class="var">?A</span> <span class="main">≥</span> lottery_prob <span class="main">(</span>RSD <span class="skolem">R'</span><span class="main">)</span> <span class="var">?A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_eq_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Randomised_Social_Choice">
<div class="head">
<h1>Theory Randomised_Social_Choice</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Randomised_Social_Choice
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="SDS_Lowering.html">SDS_Lowering</a>
  <a href="Random_Dictatorship.html">Random_Dictatorship</a>
  <a href="Random_Serial_Dictatorship.html">Random_Serial_Dictatorship</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Preference_Profile_Cmd">
<div class="head">
<h1>Theory Preference_Profile_Cmd</h1>
</div>
<pre class="source"><span class="comment1">(*  
  Title:    Preference_Profiles_Cmd.thy
  Author:   Manuel Eberl, TU München

  Provides the preference_profile command that defines preference profiles,
  proves well-formedness, and provides some useful lemmas for them.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Automatic definition of Preference Profiles›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Preference_Profile_Cmd
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="Elections.html">../Elections</a>"</span>
<span class="keyword2"><span class="keyword">keywords</span></span>
  <span class="quoted">"preference_profile"</span> <span class="main">::</span> thy_goal
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹preference_profiles.ML›</span>


<span class="keyword1"><span class="command">context</span></span> election
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preferred_alts_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
             of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_profile_from_tableI assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
          Collect <span class="main">(</span>of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_Collect_of_weak_ranking <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> prefs_from_table_wfD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_weak_ranking.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prefs_from_table_map_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Collect_ge_def preferred_alts_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> favorites_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"favorites <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> hd <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff prefs_from_table_wf_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> favorites_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_def is_finite_weak_ranking_def 
                  Max_wrt_of_weak_ranking prefs_from_table_wfD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> has_unique_favorites_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"has_unique_favorites <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> 
             list_all <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> is_singleton <span class="main">(</span>hd <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_profile_from_tableI assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">agents</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_unique_favorites_altdef <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> favorites_prefs_from_table list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Automatic definition of preference profiles from tables›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">favorites_prefs_from_table</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> <span class="free">favorites_prefs_from_table</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> <span class="free">favorites_prefs_from_table</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
               <span class="free">favorites_prefs_from_table</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">favorites_prefs_from_table</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust old.prod.exhaust<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> election<span class="main">)</span> eval_favorites_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"favorites_prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> 
             favorites <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"favorites <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> hd <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_prefs_from_table<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> favorites_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> favorites_prefs_from_table.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"favorites <span class="main">(</span>prefs_from_table <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> favorites_def Max_wrt_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> favorites_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> favorites_prefs_from_table.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">weak_ranking_prefs_from_table</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> <span class="free">weak_ranking_prefs_from_table</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">weak_ranking_prefs_from_table</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟹</span> <span class="free">weak_ranking_prefs_from_table</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">weak_ranking_prefs_from_table</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust old.prod.exhaust<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_weak_ranking_prefs_from_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"weak_ranking_prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def prefs_from_table_wf_def weak_ranking_of_weak_ranking
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> weak_ranking_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_ranking_prefs_from_table.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">agents</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"weak_ranking <span class="main">(</span>prefs_from_table <span class="free">xs</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> i' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> weak_ranking_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> weak_ranking_prefs_from_table.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_prefs_from_table_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> prefs_from_table <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≺[</span><span class="free">R</span> <span class="free">i</span><span class="main">]</span> <span class="free">b</span> <span class="main">⟷</span> prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∧</span> <span class="main">¬</span>prefs_from_table <span class="free">xs</span> <span class="free">i</span> <span class="free">b</span> <span class="free">a</span>"</span></span>
          <span class="quoted"><span class="quoted">"anonymous_profile <span class="free">R</span> <span class="main">=</span> mset <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
             preferred_alts <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
             of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
             favorites <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> favorites_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
          <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
             weak_ranking <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> weak_ranking_prefs_from_table <span class="free">xs</span> <span class="free">i</span>"</span></span>
          <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
             favorite <span class="free">R</span> <span class="free">i</span> <span class="main">=</span> the_elem <span class="main">(</span>favorites_prefs_from_table <span class="free">xs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"election <span class="free">agents</span> <span class="free">alts</span> <span class="main">⟹</span> 
             has_unique_favorites <span class="free">R</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> is_singleton <span class="main">(</span>hd <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms prefs_from_table_wfD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strongly_preferred_def favorite_def anonymise_prefs_from_table
        election.preferred_alts_prefs_from_table election.eval_favorites_prefs_from_table
        election.has_unique_favorites_prefs_from_table eval_weak_ranking_prefs_from_table<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pref_profile_from_tableI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">≡</span> prefs_from_table <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI<span class="main">)</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PREFERENCE_PROFILES_CMD</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">info</span>

<span class="keyword1"><span class="keyword">val</span></span> preference_profile <span class="main">:</span> 
  <span class="main">(</span>term * term<span class="main">)</span> * <span class="main">(</span><span class="main">(</span>binding * <span class="main">(</span>term * term list list<span class="main">)</span> list<span class="main">)</span> list<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.state</span>

<span class="keyword1"><span class="keyword">val</span></span> preference_profile_cmd <span class="main">:</span> 
  <span class="main">(</span>string * string<span class="main">)</span> * <span class="main">(</span><span class="main">(</span>binding * <span class="main">(</span>string * string list list<span class="main">)</span> list<span class="main">)</span> list<span class="main">)</span> <span class="main">-&gt;</span> 
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.state</span>

<span class="keyword1"><span class="keyword">val</span></span> get_info <span class="main">:</span> term <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">info</span>
<span class="keyword1"><span class="keyword">val</span></span> add_info <span class="main">:</span> term <span class="main">-&gt;</span> <span class="entity">info</span> <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
<span class="keyword1"><span class="keyword">val</span></span> transform_info <span class="main">:</span> <span class="entity">info</span> <span class="main">-&gt;</span> morphism <span class="main">-&gt;</span> <span class="entity">info</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Preference_Profiles_Cmd</span> <span class="main">:</span> <span class="entity">PREFERENCE_PROFILES_CMD</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> Preference_Profiles


<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">info</span> <span class="main">=</span> 
  <span class="main">{</span> term <span class="main">:</span> term<span class="main">,</span> def_thm <span class="main">:</span> thm<span class="main">,</span> wf_thm <span class="main">:</span> thm<span class="main">,</span> wf_raw_thm <span class="main">:</span> thm<span class="main">,</span> binding <span class="main">:</span> binding<span class="main">,</span>
    raw <span class="main">:</span> <span class="main">(</span>term * term list list<span class="main">)</span> list<span class="main">,</span> eval_thms <span class="main">:</span> thm list <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">transform_info</span> <span class="main">(</span><span class="main">{</span>term <span class="main">=</span> <span class="entity">t</span><span class="main">,</span> <span class="entity">binding</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">,</span> <span class="entity">wf_thm</span><span class="main">,</span> <span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">raw</span><span class="main">,</span> <span class="entity">eval_thms</span><span class="main">}</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="entity">phi</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Morphism.thm <span class="entity">phi</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fact</span> <span class="main">=</span> Morphism.fact <span class="entity">phi</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term</span> <span class="main">=</span> Morphism.term <span class="entity">phi</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bdg</span> <span class="main">=</span> Morphism.binding <span class="entity">phi</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">{</span> term <span class="main">=</span> <span class="entity">term</span> <span class="entity">t</span><span class="main">,</span> binding <span class="main">=</span> <span class="entity">bdg</span> <span class="entity">binding</span><span class="main">,</span> def_thm <span class="main">=</span> <span class="entity">thm</span> <span class="entity">def_thm</span><span class="main">,</span> wf_thm <span class="main">=</span> <span class="entity">thm</span> <span class="entity">wf_thm</span><span class="main">,</span> 
        wf_raw_thm <span class="main">=</span> <span class="entity">thm</span> <span class="entity">wf_raw_thm</span><span class="main">,</span> raw <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">bss</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">term</span> <span class="entity">a</span><span class="main">,</span> map <span class="main">(</span>map <span class="entity">term</span><span class="main">)</span> <span class="entity">bss</span><span class="main">)</span><span class="main">)</span> <span class="entity">raw</span><span class="main">,</span>
        eval_thms <span class="main">=</span> <span class="entity">fact</span> <span class="entity">eval_thms</span> <span class="main">}</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Generic_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span>term * <span class="entity">info</span><span class="main">)</span> Item_Net.T
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Item_Net.init <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv o apply2 fst<span class="main">)</span> <span class="main">(</span>single o fst<span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Item_Net.merge
<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_info</span> <span class="entity">term</span> <span class="entity">lthy</span> <span class="main">=</span> 
  Item_Net.retrieve <span class="main">(</span>Data.get <span class="main">(</span>Context.Proof <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="entity">term</span> |&gt; the_single |&gt; snd

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_info</span> <span class="entity">term</span> <span class="entity">info</span> <span class="entity">lthy</span> <span class="main">=</span>
  Data.map <span class="main">(</span>Item_Net.update <span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="entity">info</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span>
  
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_infos</span> <span class="entity">infos</span> <span class="entity">lthy</span> <span class="main">=</span>
  Data.map <span class="main">(</span>fold Item_Net.update <span class="entity">infos</span><span class="main">)</span> <span class="entity">lthy</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">preference_profile_aux</span> <span class="entity">agents</span> <span class="entity">alts</span> <span class="main">(</span><span class="entity">binding</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_Type'</span> <span class="main">=</span> Term.dest_Type #&gt; snd #&gt; hd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">agentT</span><span class="main">,</span> <span class="entity">altT</span><span class="main">)</span> <span class="main">=</span> apply2 <span class="main">(</span><span class="entity">dest_Type'</span> o fastype_of<span class="main">)</span> <span class="main">(</span><span class="entity">agents</span><span class="main">,</span> <span class="entity">alts</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alt_setT</span> <span class="main">=</span> <span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">define</span> <span class="entity">t</span> <span class="main">=</span> 
      Local_Theory.define <span class="main">(</span><span class="main">(</span><span class="entity">binding</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">,</span> 
        <span class="main">(</span><span class="main">(</span>Binding.suffix_name <span class="inner_quoted">"_def"</span> <span class="entity">binding</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> <span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">agentT</span><span class="main">,</span> <span class="entity">HOLogic.listT</span> <span class="main">(</span><span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">args'</span> <span class="main">=</span> 
      <span class="entity">args</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> ||&gt; map <span class="main">(</span><span class="entity">HOLogic.mk_set</span> <span class="entity">altT</span><span class="main">)</span> ||&gt; <span class="entity">HOLogic.mk_list</span> <span class="entity">alt_setT</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t_raw</span> <span class="main">=</span> 
      <span class="entity">args'</span> 
        |&gt; map <span class="entity">HOLogic.mk_prod</span> 
        |&gt; <span class="entity">HOLogic.mk_list</span> <span class="entity">ty</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> prefs_from_table<span class="antiquote">}</span></span><span class="main">,</span> 
              <span class="entity">HOLogic.listT</span> <span class="entity">ty</span> --&gt; <span class="entity">pref_profileT</span> <span class="entity">agentT</span> <span class="entity">altT</span><span class="main">)</span> $ <span class="entity">t_raw</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">prefs</span><span class="main">,</span> <span class="entity">prefs_def</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">define</span> <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prefs_from_table_wf_const</span> <span class="main">=</span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> prefs_from_table_wf<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">HOLogic.mk_setT</span> <span class="entity">agentT</span> --&gt; <span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span> --&gt; 
          <span class="entity">HOLogic.listT</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">agentT</span><span class="main">,</span> <span class="entity">HOLogic.listT</span> <span class="main">(</span><span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> --&gt;
          <span class="entity">HOLogic.boolT</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wf_prop</span> <span class="main">=</span> <span class="main">(</span><span class="entity">prefs_from_table_wf_const</span> $ <span class="entity">agents</span> $ <span class="entity">alts</span> $ <span class="entity">t_raw</span><span class="main">)</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span>

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">(</span><span class="entity">prefs</span><span class="main">,</span> <span class="entity">wf_prop</span><span class="main">,</span> <span class="entity">prefs_def</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_accum</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_accum_aux</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="entity">s</span> <span class="entity">acc</span> <span class="main">=</span> <span class="main">(</span>rev <span class="entity">acc</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">fold_accum_aux</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="entity">s</span> <span class="entity">acc</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">s'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">fold_accum_aux</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">s'</span> <span class="main">(</span><span class="entity">y</span>::<span class="entity">acc</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">fold_accum_aux</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">s</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">preference_profile</span> <span class="main">(</span><span class="main">(</span><span class="entity">agents</span><span class="main">,</span> <span class="entity">alts</span><span class="main">)</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">qualify</span> <span class="entity">pref</span> <span class="entity">suff</span> <span class="main">=</span> Binding.qualify true <span class="main">(</span>Binding.name_of <span class="entity">pref</span><span class="main">)</span> <span class="main">(</span>Binding.name <span class="entity">suff</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">results</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fold_accum</span> <span class="main">(</span><span class="entity">preference_profile_aux</span> <span class="entity">agents</span> <span class="entity">alts</span><span class="main">)</span> <span class="entity">args</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prefs_terms</span> <span class="main">=</span> map <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">results</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wf_props</span> <span class="main">=</span> map <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">results</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">defs</span> <span class="main">=</span> map <span class="main">(</span>snd o <span class="main">#</span><span class="inner_numeral">3</span><span class="main">)</span> <span class="entity">results</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">raws</span> <span class="main">=</span> map snd <span class="entity">args</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bindings</span> <span class="main">=</span> map fst <span class="entity">args</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">lthy</span> <span class="main">=</span>
       <span class="keyword2"><span class="keyword">let</span></span> 
         <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy'</span> <span class="main">=</span> put_simpset <span class="entity">HOL_ss</span> <span class="entity">lthy</span> addsimps
           <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> list.set Union_insert Un_insert_left insert_not_empty Int_empty_left Int_empty_right
              insert_commute Un_empty_left Un_empty_right insert_absorb2 Union_empty
              is_weak_ranking_Cons is_weak_ranking_Nil finite_insert finite.emptyI
              Set.singleton_iff Set.empty_iff Set.ball_simps<span class="antiquote">}</span></span></span>
        <span class="keyword2"><span class="keyword">in</span></span>
          Local_Defs.unfold_tac <span class="entity">lthy</span> <span class="entity">defs</span>
            THEN ALLGOALS <span class="main">(</span>resolve_tac <span class="entity">lthy</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> prefs_from_table_wfI<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span>
            THEN Local_Defs.unfold_tac <span class="entity">lthy</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> is_finite_weak_ranking_def list.set insert_iff
               empty_iff simp_thms list.map snd_conv fst_conv<span class="antiquote">}</span></span></span>
            THEN ALLGOALS <span class="main">(</span>TRY o REPEAT_ALL_NEW <span class="main">(</span>eresolve_tac <span class="entity">lthy</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> disjE<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
            THEN ALLGOALS <span class="main">(</span>TRY o <span class="entity">Hypsubst.hyp_subst_tac</span> <span class="entity">lthy</span><span class="main">)</span>
            THEN ALLGOALS <span class="main">(</span><span class="entity">Simplifier.asm_full_simp_tac</span> <span class="entity">lthy'</span><span class="main">)</span>
            THEN ALLGOALS <span class="main">(</span>TRY o REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">lthy</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
            THEN distinct_subgoals_tac
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">after_qed</span> <span class="main">[</span><span class="entity">wf_thms_raw</span><span class="main">]</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_thms</span> <span class="entity">attrs</span> <span class="entity">suffix</span> <span class="main">(</span><span class="entity">thms</span> <span class="main">:</span> thm list<span class="main">)</span> <span class="entity">binding</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">qualify</span> <span class="entity">binding</span> <span class="entity">suffix</span><span class="main">,</span> <span class="entity">attrs</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">thms</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_thmss</span> <span class="entity">simp</span> <span class="entity">suffix</span> <span class="entity">thmss</span> <span class="main">=</span> map2 <span class="main">(</span><span class="entity">prep_thms</span> <span class="entity">simp</span> <span class="entity">suffix</span><span class="main">)</span> <span class="entity">thmss</span> <span class="entity">bindings</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">notes</span> <span class="entity">thmss</span> <span class="entity">suffix</span> <span class="entity">attrs</span> <span class="entity">lthy</span> <span class="main">=</span> 
            Local_Theory.notes <span class="main">(</span><span class="entity">prep_thmss</span> <span class="entity">attrs</span> <span class="entity">suffix</span> <span class="entity">thmss</span><span class="main">)</span> <span class="entity">lthy</span> |&gt; snd
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">note</span> <span class="entity">thms</span> <span class="entity">suffix</span> <span class="entity">attrs</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">notes</span> <span class="main">(</span>map single <span class="entity">thms</span><span class="main">)</span> <span class="entity">suffix</span> <span class="entity">attrs</span> <span class="entity">lthy</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eval_thmss</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">def</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">wf</span> <span class="main">=&gt;</span> 
          map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> OF <span class="main">[</span><span class="entity">def</span><span class="main">,</span> <span class="entity">wf</span><span class="main">]</span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval_prefs_from_table_aux<span class="antiquote">}</span></span></span><span class="main">)</span> 
          <span class="entity">defs</span> <span class="entity">wf_thms_raw</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wf_thms</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">def</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">wf</span> <span class="main">=&gt;</span> 
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pref_profile_from_tableI'<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">def</span><span class="main">,</span> <span class="entity">wf</span><span class="main">]</span><span class="main">)</span> <span class="entity">defs</span> <span class="entity">wf_thms_raw</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_infos</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">bdg</span>::<span class="entity">bdgs</span><span class="main">)</span> <span class="main">(</span><span class="entity">t</span>::<span class="entity">ts</span><span class="main">)</span> <span class="main">(</span><span class="entity">r</span>::<span class="entity">raws</span><span class="main">)</span> <span class="main">(</span><span class="entity">def</span>::<span class="entity">def_thms</span><span class="main">)</span> <span class="main">(</span><span class="entity">wf</span>::<span class="entity">wf_thms</span><span class="main">)</span> 
                   <span class="main">(</span><span class="entity">wf_raw</span>::<span class="entity">wf_raw_thms</span><span class="main">)</span> <span class="main">(</span><span class="entity">evals</span>::<span class="entity">eval_thmss</span><span class="main">)</span> <span class="main">=</span>
              <span class="entity">aux</span> <span class="main">(</span><span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">{</span>binding <span class="main">=</span> <span class="entity">bdg</span><span class="main">,</span> term <span class="main">=</span> <span class="entity">t</span><span class="main">,</span> raw <span class="main">=</span> <span class="entity">r</span><span class="main">,</span> def_thm <span class="main">=</span> <span class="entity">def</span><span class="main">,</span> wf_thm <span class="main">=</span> <span class="entity">wf</span><span class="main">,</span>
                 wf_raw_thm <span class="main">=</span> <span class="entity">wf_raw</span><span class="main">,</span> eval_thms <span class="main">=</span> <span class="entity">evals</span><span class="main">}</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span> 
                 <span class="entity">bdgs</span> <span class="entity">ts</span> <span class="entity">raws</span> <span class="entity">def_thms</span> <span class="entity">wf_thms</span> <span class="entity">wf_raw_thms</span> <span class="entity">eval_thmss</span>
            <span class="main">|</span> <span class="entity">aux</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="entity">acc</span> <span class="main">:</span> <span class="main">(</span>term * <span class="entity">info</span><span class="main">)</span> list<span class="main">)</span>
            <span class="main">|</span> <span class="entity">aux</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">aux</span> <span class="main">[</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infos</span> <span class="main">=</span> <span class="entity">mk_infos</span> <span class="entity">bindings</span> <span class="entity">prefs_terms</span> <span class="entity">raws</span> <span class="entity">defs</span> <span class="entity">wf_thms</span> <span class="entity">wf_thms_raw</span> <span class="entity">eval_thmss</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">lthy</span> 
        |&gt; <span class="entity">note</span> <span class="entity">wf_thms_raw</span> <span class="inner_quoted">"wf_raw"</span> <span class="main">[</span><span class="main">]</span>
        |&gt; <span class="entity">note</span> <span class="entity">wf_thms</span> <span class="inner_quoted">"wf"</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="antiquote">}</span></span></span> 
        |&gt; <span class="entity">notes</span> <span class="entity">eval_thmss</span> <span class="inner_quoted">"eval"</span> <span class="main">[</span><span class="main">]</span>
        |&gt; Local_Theory.declaration <span class="main">{</span>syntax <span class="main">=</span> false<span class="main">,</span> pervasive <span class="main">=</span> false<span class="main">}</span>
             <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">m</span> <span class="main">=&gt;</span> <span class="entity">add_infos</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>Morphism.term <span class="entity">m</span> <span class="entity">t</span><span class="main">,</span> <span class="entity">transform_info</span> <span class="entity">i</span> <span class="entity">m</span><span class="main">)</span><span class="main">)</span> <span class="entity">infos</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">after_qed</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> <span class="main">[</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">prop</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">prop</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">wf_props</span><span class="main">]</span> <span class="entity">lthy</span>
    |&gt; <span class="entity">Proof.refine_singleton</span> <span class="main">(</span><span class="entity">Method.Basic</span> <span class="main">(</span><span class="entity">SIMPLE_METHOD</span> o <span class="entity">tac</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">preference_profile_cmd</span> <span class="main">(</span><span class="main">(</span><span class="entity">agents</span><span class="main">,</span> <span class="entity">alts</span><span class="main">)</span><span class="main">,</span> <span class="entity">argss</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> Syntax.read_term <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read'</span> <span class="entity">ty</span> <span class="entity">t</span> <span class="main">=</span> Syntax.parse_term <span class="entity">lthy</span> <span class="entity">t</span> |&gt; Type.constraint <span class="entity">ty</span> |&gt; Syntax.check_term <span class="entity">lthy</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">agents'</span> <span class="main">=</span> <span class="entity">read</span> <span class="entity">agents</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts'</span> <span class="main">=</span> <span class="entity">read</span> <span class="entity">alts</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">agentT</span> <span class="main">=</span> <span class="entity">agents'</span> |&gt; fastype_of |&gt; dest_Type |&gt; snd |&gt; hd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">alts'</span> |&gt; fastype_of |&gt; dest_Type |&gt; snd |&gt; hd
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_pref_elem</span> <span class="entity">ts</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">read'</span> <span class="entity">altT</span><span class="main">)</span> <span class="entity">ts</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_prefs</span> <span class="entity">prefs</span> <span class="main">=</span> map <span class="entity">read_pref_elem</span> <span class="entity">prefs</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep</span> <span class="main">(</span><span class="entity">binding</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="entity">binding</span><span class="main">,</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">agent</span><span class="main">,</span> <span class="entity">prefs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">read'</span> <span class="entity">agentT</span> <span class="entity">agent</span><span class="main">,</span> <span class="entity">read_prefs</span> <span class="entity">prefs</span><span class="main">)</span><span class="main">)</span> <span class="entity">args</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">preference_profile</span> <span class="main">(</span><span class="main">(</span><span class="entity">agents'</span><span class="main">,</span> <span class="entity">alts'</span><span class="main">)</span><span class="main">,</span> map <span class="entity">prep</span> <span class="entity">argss</span><span class="main">)</span> <span class="entity">lthy</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_prefs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_pref_elem</span> <span class="main">=</span> 
      <span class="main">(</span>Args.bracks <span class="main">(</span>Parse.list1 Parse.term<span class="main">)</span><span class="main">)</span> ||
      Parse.term &gt;&gt; single
  <span class="keyword2"><span class="keyword">in</span></span>
    Parse.list1 <span class="entity">parse_pref_elem</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_pref_profile</span> <span class="main">=</span>
  Parse.binding --| Args.$$$ <span class="inner_quoted">"="</span> -- Scan.repeat1 <span class="main">(</span>Parse.term --| Args.colon -- <span class="entity">parse_prefs</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">preference_profile</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"construct preference profiles from a table"</span>
    <span class="main">(</span>Args.$$$ <span class="inner_quoted">"agents"</span> |-- Args.colon |-- Parse.term --| Args.$$$ <span class="inner_quoted">"alts"</span> --| Args.colon 
       -- Parse.term --| Args.$$$ <span class="inner_quoted">"where"</span> --
     Parse.and_list1 <span class="entity">parse_pref_profile</span> &gt;&gt; <span class="entity">preference_profile_cmd</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/preference_profiles.ML">
<div class="head">
<h1>File ‹preference_profiles.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PREFERENCE_PROFILES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prefs</span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">profile</span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">support</span>
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">permutation</span>


<span class="keyword1"><span class="keyword">val</span></span> apply_permutation <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> 'a
<span class="keyword1"><span class="keyword">val</span></span> apply_reverse_permutation <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> 'a
<span class="keyword1"><span class="keyword">val</span></span> is_identity <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> fixpoints <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> <span class="main">-&gt;</span> 'a list
<span class="keyword1"><span class="keyword">val</span></span> permutations <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> Seq.seq
<span class="keyword1"><span class="keyword">val</span></span> cycles <span class="main">:</span> <span class="main">(</span>'a * 'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">permutation</span> <span class="main">-&gt;</span> 'a list list

<span class="comment1">(* Equality of weak rankings *)</span>
<span class="keyword1"><span class="keyword">val</span></span> eq_prefs <span class="main">:</span> <span class="main">(</span><span class="entity">prefs</span> * <span class="entity">prefs</span><span class="main">)</span> <span class="main">-&gt;</span> bool

<span class="comment1">(* Equivalence of preference profiles up to permutation of agents *)</span>
<span class="keyword1"><span class="keyword">val</span></span> equiv_profile_anonymity <span class="main">:</span> <span class="main">(</span><span class="entity">profile</span> * <span class="entity">profile</span><span class="main">)</span> <span class="main">-&gt;</span> bool

<span class="keyword1"><span class="keyword">val</span></span> agents_of_profile <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> term list
<span class="keyword1"><span class="keyword">val</span></span> agentT <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> typ
<span class="keyword1"><span class="keyword">val</span></span> alts_of_profile <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> term list
<span class="keyword1"><span class="keyword">val</span></span> altT <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> typ
<span class="keyword1"><span class="keyword">val</span></span> pref_profileT <span class="main">:</span> typ <span class="main">-&gt;</span> typ <span class="main">-&gt;</span> typ

<span class="keyword1"><span class="keyword">val</span></span> permute_profile <span class="main">:</span> term <span class="entity">permutation</span> <span class="main">-&gt;</span> <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="entity">profile</span>

<span class="keyword1"><span class="keyword">val</span></span> ranking <span class="main">:</span> <span class="entity">prefs</span> <span class="main">-&gt;</span> term * term <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> strict_ranking <span class="main">:</span> <span class="entity">prefs</span> <span class="main">-&gt;</span> term * term <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> pareto <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> term * term <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> strict_pareto <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> term * term <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> relation_of_prefs <span class="main">:</span> <span class="entity">prefs</span> <span class="main">-&gt;</span> <span class="main">(</span>term * term<span class="main">)</span> list

<span class="comment1">(* Lazy list of all permutations that, when applied to the first profile, yield one 
   anonymity-equivalent to the second profile *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_an_isomorphisms <span class="main">:</span> <span class="entity">profile</span> * <span class="entity">profile</span> <span class="main">-&gt;</span> term <span class="entity">permutation</span> Seq.seq

<span class="comment1">(* Return the first such isomorphism (or NONE) *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_an_isomorphism <span class="main">:</span> <span class="entity">profile</span> * <span class="entity">profile</span> <span class="main">-&gt;</span> term <span class="entity">permutation</span> option

<span class="comment1">(* Find all non-trivial automorphisms of a preference profile *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_an_automorphisms <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="main">(</span>term * term<span class="main">)</span> * term <span class="entity">permutation</span><span class="main">)</span> list

<span class="comment1">(* Compute a list of normalising equations implied by the automorphisms of a 
   preference profile *)</span>
<span class="keyword1"><span class="keyword">val</span></span> derive_orbit_equations <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="main">(</span>term * term<span class="main">)</span> * term <span class="entity">permutation</span><span class="main">)</span> list

<span class="comment1">(* The list of alternatives that are weakly preferred to the given alternative *)</span>
<span class="keyword1"><span class="keyword">val</span></span> preferred_alts <span class="main">:</span> <span class="entity">prefs</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term list

<span class="comment1">(* The list of Pareto-domination pairs (first element dominates second; strict preference
   for the agent in the third component) *)</span>
<span class="keyword1"><span class="keyword">val</span></span> pareto_pairs <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="main">(</span>term * term * term<span class="main">)</span> list

<span class="comment1">(* The set of all Pareto losers in a profile *)</span>
<span class="keyword1"><span class="keyword">val</span></span> pareto_losers <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="main">(</span>term * term * term<span class="main">)</span> list

<span class="keyword1"><span class="keyword">val</span></span> find_pareto_witness <span class="main">:</span> <span class="entity">profile</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="main">(</span>term * term * term<span class="main">)</span> option

<span class="keyword1"><span class="keyword">val</span></span> manipulation_distance <span class="main">:</span> <span class="main">(</span><span class="entity">prefs</span> * <span class="entity">prefs</span><span class="main">)</span> <span class="main">-&gt;</span> int

<span class="comment1">(* Finds all ways for one voter to manipulate the first given profile to obtain a profile
   that is equivalent to the second profile modulo anonymity and neutrality.
   Returns a witness for each possible manipulation, consisting of the manipulating voter, 
   the voter with whose preferences her preferences need to be replaced, 
   and the permutation of alternatives.
 *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_manipulations <span class="main">:</span> <span class="entity">profile</span> * <span class="entity">profile</span> <span class="main">-&gt;</span> <span class="main">(</span>term * term * int * term <span class="entity">permutation</span><span class="main">)</span> list

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Preference_Profiles</span> <span class="main">:</span> <span class="entity">PREFERENCE_PROFILES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prefs</span> <span class="main">=</span> term list list
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">profile</span> <span class="main">=</span> <span class="main">(</span>term * <span class="entity">prefs</span><span class="main">)</span> list
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">permutation</span> <span class="main">=</span> <span class="main">(</span>'a * 'a<span class="main">)</span> list
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">support</span> <span class="main">=</span> term list
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">lottery</span> <span class="main">=</span> <span class="main">(</span>term * Rat.rat<span class="main">)</span> list

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pref_profileT</span> <span class="entity">agentT</span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">agentT</span> --&gt; <span class="entity">altT</span> --&gt; <span class="entity">altT</span> --&gt; <span class="entity">HOLogic.boolT</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_prefs</span> <span class="main">=</span> eq_list <span class="main">(</span>eq_set <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">equiv_profile_anonymity</span> <span class="entity">xy</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xy</span> <span class="main">=</span> apply2 <span class="main">(</span>map snd<span class="main">)</span> <span class="entity">xy</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    submultiset <span class="entity">eq_prefs</span> <span class="entity">xy</span> <span class="keyword1"><span class="keyword">andalso</span></span> submultiset <span class="entity">eq_prefs</span> <span class="main">(</span>swap <span class="entity">xy</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">agents_of_profile</span> <span class="main">=</span> map fst
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">agentT</span> <span class="main">=</span> hd #&gt; fst #&gt; fastype_of
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts_of_profile</span> <span class="main">=</span> hd #&gt; snd #&gt; List.concat
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">altT</span> <span class="main">=</span> hd #&gt; snd #&gt; hd #&gt; hd #&gt; fastype_of

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mem</span> <span class="main">=</span> member <span class="keyword1"><span class="keyword">op</span></span> aconv
<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ranking</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">ranking</span> <span class="main">(</span><span class="entity">xs</span> :: <span class="entity">xss</span><span class="main">)</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mem</span> <span class="entity">xs</span> <span class="entity">y</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span>not <span class="main">(</span><span class="entity">mem</span> <span class="entity">xs</span> <span class="entity">x</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">ranking</span> <span class="entity">xss</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strict_ranking</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">strict_ranking</span> <span class="main">(</span><span class="entity">xs</span> :: <span class="entity">xss</span><span class="main">)</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> 
      not <span class="main">(</span><span class="entity">mem</span> <span class="entity">xs</span> <span class="entity">x</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="main">(</span><span class="entity">mem</span> <span class="entity">xs</span> <span class="entity">y</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">strict_ranking</span> <span class="entity">xss</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fixpoints</span> <span class="entity">eq</span> <span class="entity">xs</span> <span class="main">=</span> <span class="entity">xs</span> |&gt; filter <span class="entity">eq</span> |&gt; map fst

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_permutation</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">apply_permutation</span> <span class="entity">eq</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span>::<span class="entity">p</span><span class="main">)</span> <span class="entity">x'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">x'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">apply_permutation</span> <span class="entity">eq</span> <span class="entity">p</span> <span class="entity">x'</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_reverse_permutation</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">apply_reverse_permutation</span> <span class="entity">eq</span> <span class="main">(</span><span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span>::<span class="entity">p</span><span class="main">)</span> <span class="entity">x'</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">x'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">apply_reverse_permutation</span> <span class="entity">eq</span> <span class="entity">p</span> <span class="entity">x'</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_identity</span> <span class="main">=</span> forall

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cycles</span> <span class="entity">eq</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go3</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Match
      <span class="main">|</span> <span class="entity">go3</span> <span class="entity">acc</span> <span class="entity">a</span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
         <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">acc</span> @ <span class="entity">xs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">go3</span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">a</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go2</span> <span class="entity">cyc</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">xs</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> 
        <span class="main">(</span><span class="entity">cyc</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> 
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">go3</span> <span class="main">[</span><span class="main">]</span> <span class="entity">b</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">go2</span> <span class="main">(</span><span class="entity">b</span>::<span class="entity">cyc</span><span class="main">)</span> <span class="entity">a</span> <span class="entity">c</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go1</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go1</span> <span class="entity">acc</span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">go2</span> <span class="main">[</span><span class="entity">a</span><span class="main">]</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="entity">cyc</span><span class="main">,</span> <span class="entity">xs'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">go1</span> <span class="main">(</span>rev <span class="entity">cyc</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs'</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    rev o <span class="entity">go1</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>    

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">permutations</span> <span class="entity">eq</span> <span class="entity">xs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> Seq.single <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="entity">xs</span> <span class="main">=</span> Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">go</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">acc</span><span class="main">)</span> <span class="main">(</span>remove1 <span class="entity">eq</span> <span class="entity">x</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Seq.of_list <span class="entity">xs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ys</span> <span class="main">=&gt;</span> <span class="entity">xs</span> ~~ <span class="entity">ys</span><span class="main">)</span> <span class="main">(</span><span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">permute_profile</span> <span class="entity">p</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">yss</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> map <span class="main">(</span>map <span class="main">(</span><span class="entity">apply_permutation</span> <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">yss</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_an_isomorphisms</span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">ys</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_iso</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">equiv_profile_anonymity</span> <span class="main">(</span><span class="entity">permute_profile</span> <span class="entity">p</span> <span class="entity">xs</span><span class="main">,</span> <span class="entity">ys</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">permutations</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span> <span class="main">(</span><span class="entity">alts_of_profile</span> <span class="entity">xs</span><span class="main">)</span>
    |&gt; Seq.filter <span class="main">(</span><span class="entity">is_iso</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">find_an_isomorphism</span> <span class="main">=</span>
  <span class="entity">find_an_isomorphisms</span> #&gt; Seq.pull #&gt; Option.map fst

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq_fold</span> <span class="entity">f</span> <span class="entity">s</span> <span class="entity">acc</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="entity">acc</span>
  <span class="main">|</span> SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">seq_fold</span> <span class="entity">f</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span> <span class="entity">acc</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_an_automorphisms</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">a</span> aconv <span class="entity">c</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">b</span> aconv <span class="entity">d</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> 
    |&gt; <span class="entity">find_an_isomorphisms</span>
    |&gt; Seq.map <span class="main">(</span>filter_out <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span><span class="main">)</span>
    |&gt; Seq.filter <span class="main">(</span>not o null<span class="main">)</span>
    |&gt; Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> Seq.of_list <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span>
    |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">seq_fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> insert <span class="entity">eq</span> <span class="entity">x</span> <span class="entity">y</span><span class="main">)</span> <span class="entity">s</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">preferred_alts</span> <span class="entity">r</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> member <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">xs</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">xs</span> @ <span class="entity">acc</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">go</span> <span class="main">(</span><span class="entity">xs</span> @ <span class="entity">acc</span><span class="main">)</span> <span class="entity">xss</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="entity">r</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pareto</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=</span> forall <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">prefs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ranking</span> <span class="entity">prefs</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strict_pareto</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pareto</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span><span class="entity">pareto</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pareto_pairs</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dom_set</span> <span class="entity">x</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
          <span class="main">|</span> <span class="entity">go</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="main">=</span> 
              <span class="keyword2"><span class="keyword">if</span></span> member <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">xs</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> List.concat <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">go</span> <span class="entity">xss</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">xss</span><span class="main">)</span> <span class="main">=&gt;</span> inter <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="main">(</span><span class="entity">go</span> <span class="entity">xss</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span> <span class="entity">alts</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filter_out_symmetric</span> <span class="entity">xs</span> <span class="main">=</span>
      filter_out <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> member <span class="main">(</span>eq_pair <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span> <span class="entity">xs</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">filter_out_trans</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
          <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">if</span></span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv o apply2 snd<span class="main">)</span> <span class="entity">acc</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> 
                <span class="entity">go</span> <span class="entity">acc</span> <span class="entity">xs</span> 
              <span class="keyword2"><span class="keyword">else</span></span> 
                <span class="entity">go</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">go</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">alts</span>
    |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">dom_set</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    |&gt; List.concat
    |&gt; <span class="entity">filter_out_symmetric</span>
    |&gt; <span class="entity">filter_out_trans</span>
    |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> find_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">strict_ranking</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span> |&gt; the |&gt; fst<span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pareto_losers</span> <span class="main">=</span> 
  <span class="entity">pareto_pairs</span> #&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">a</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">)</span> #&gt; distinct <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv o apply2 <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_pareto_witness</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="entity">alts_of_profile</span> <span class="entity">p</span>
  |&gt; remove <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">x</span>
  |&gt; get_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> 
       <span class="keyword2"><span class="keyword">if</span></span> forall <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">prefs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">ranking</span> <span class="entity">prefs</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">then</span></span>
         find_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">prefs</span><span class="main">)</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">ranking</span> <span class="entity">prefs</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span>
         |&gt; Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">else</span></span>
         NONE<span class="main">)</span>

<span class="comment1">(* Poor man's Union-Find *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eqclasses</span> <span class="entity">eq</span> <span class="entity">carrier</span> <span class="entity">eqs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="entity">m</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ra</span> <span class="main">=</span> the <span class="main">(</span>AList.lookup <span class="entity">eq</span> <span class="entity">m</span> <span class="entity">a</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rb</span> <span class="main">=</span> the <span class="main">(</span>AList.lookup <span class="entity">eq</span> <span class="entity">m</span> <span class="entity">b</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        map <span class="main">(</span>apsnd <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span> <span class="entity">ra</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">rb</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">m</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    fold <span class="entity">merge</span> <span class="entity">eqs</span> <span class="main">(</span><span class="entity">carrier</span> ~~ <span class="entity">carrier</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">derive_orbit_equations</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">automorphisms</span> <span class="main">=</span> <span class="entity">find_an_automorphisms</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reprs</span> <span class="main">=</span> <span class="entity">eqclasses</span> <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">alts</span> <span class="main">(</span>map fst <span class="entity">automorphisms</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">repr</span> <span class="main">=</span> AList.lookup <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">reprs</span> #&gt; the
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">automorphisms</span> <span class="main">=</span> filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">b</span> aconv <span class="entity">repr</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">automorphisms</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">automorphisms</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">manipulations</span> <span class="entity">xs</span> <span class="entity">y</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="entity">xs1</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs2</span><span class="main">)</span> <span class="main">=</span> 
          <span class="entity">go</span> <span class="main">(</span><span class="main">(</span>fst <span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> rev <span class="entity">xs1</span> @ <span class="main">(</span>fst <span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> :: <span class="entity">xs2</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs1</span><span class="main">)</span> <span class="entity">xs2</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    rev <span class="main">(</span><span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bind</span> <span class="main">=</span> Seq.maps
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bind'</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">bind</span> <span class="entity">f</span> <span class="main">(</span>Seq.of_list <span class="entity">x</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">relation_of_prefs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">go</span> <span class="main">(</span>maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> map <span class="main">(</span>pair <span class="entity">x</span><span class="main">)</span> <span class="main">(</span>flat <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> @ <span class="entity">acc</span><span class="main">)</span> <span class="entity">xss</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">manipulation_distance</span> <span class="main">(</span><span class="entity">prefs1</span><span class="main">,</span> <span class="entity">prefs2</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r1</span> <span class="main">=</span> <span class="entity">relation_of_prefs</span> <span class="entity">prefs1</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r2</span> <span class="main">=</span> <span class="entity">relation_of_prefs</span> <span class="entity">prefs2</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subtract'</span> <span class="main">=</span> subtract <span class="main">(</span>eq_pair <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    length <span class="main">(</span><span class="entity">subtract'</span> <span class="entity">r1</span> <span class="entity">r2</span><span class="main">)</span> + length <span class="main">(</span><span class="entity">subtract'</span> <span class="entity">r2</span> <span class="entity">r1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_manipulations</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p1</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prefs</span> <span class="entity">p</span> <span class="entity">i</span> <span class="main">=</span> the <span class="main">(</span>AList.lookup <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">p</span> <span class="entity">i</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">permutations</span> <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">alts</span> |&gt; <span class="entity">bind</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">sigma</span> <span class="main">=&gt;</span>
      <span class="entity">p2</span> |&gt; <span class="entity">bind'</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">j</span><span class="main">,</span> <span class="entity">prefs</span><span class="main">)</span> <span class="main">=&gt;</span>
        Seq.of_list <span class="main">(</span><span class="entity">manipulations</span> <span class="main">(</span><span class="entity">permute_profile</span> <span class="entity">sigma</span> <span class="entity">p1</span><span class="main">)</span> <span class="entity">prefs</span><span class="main">)</span>
        |&gt; Seq.filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">p1'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">equiv_profile_anonymity</span> <span class="main">(</span><span class="entity">p1'</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span><span class="main">)</span>
        |&gt; Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="entity">sigma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        |&gt; Seq.map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="entity">sigma</span><span class="main">)</span> <span class="main">=&gt;</span>
             <span class="keyword2"><span class="keyword">let</span></span>
               <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prefs1</span><span class="main">,</span> <span class="entity">prefs2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">prefs</span> <span class="entity">p1</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">prefs</span> <span class="entity">p2</span> <span class="entity">j</span><span class="main">)</span>
               <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prefs1</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="entity">apply_permutation</span> <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">sigma</span><span class="main">)</span><span class="main">)</span> <span class="entity">prefs1</span>
               <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dist</span> <span class="main">=</span> <span class="entity">manipulation_distance</span> <span class="main">(</span><span class="entity">prefs1</span><span class="main">,</span> <span class="entity">prefs2</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">in</span></span>
               SOME <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="entity">dist</span><span class="main">,</span> <span class="entity">sigma</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    |&gt; Seq.list_of
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="QSOpt_Exact">
<div class="head">
<h1>Theory QSOpt_Exact</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> QSOpt_Exact
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*ML_file "rat.ML"*)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">RAT_UTILS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> rat_to_string <span class="main">:</span> Rat.rat <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> pretty_rat <span class="main">:</span> Rat.rat <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> string_to_rat <span class="main">:</span> string <span class="main">-&gt;</span> Rat.rat option
  <span class="keyword1"><span class="keyword">val</span></span> mk_rat_number <span class="main">:</span> typ <span class="main">-&gt;</span> Rat.rat <span class="main">-&gt;</span> term
  <span class="keyword1"><span class="keyword">val</span></span> dest_rat_number <span class="main">:</span> term <span class="main">-&gt;</span> Rat.rat
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Rat_Utils</span> <span class="main">:</span> <span class="entity">RAT_UTILS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rat_to_string</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Rat.dest <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=&gt;</span> Int.toString <span class="entity">a</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">a</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"~ "</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">""</span><span class="main">)</span> ^ Int.toString <span class="main">(</span>abs <span class="entity">a</span><span class="main">)</span> ^ <span class="inner_quoted">" / "</span> ^ Int.toString <span class="entity">b</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_rat</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Rat.dest <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">a</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"-"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">""</span><span class="main">)</span> ^ Int.toString <span class="entity">a</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">a</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"- "</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">""</span><span class="main">)</span> ^ Int.toString <span class="main">(</span>abs <span class="entity">a</span><span class="main">)</span> ^ <span class="inner_quoted">" / "</span> ^ Int.toString <span class="entity">b</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string_to_rat</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">s1</span><span class="main">,</span> <span class="entity">s2'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">s</span> |&gt; Substring.full |&gt; Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> &lt;&gt; <span class="inner_quoted">#"/"</span><span class="main">)</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">s1</span><span class="main">,</span> <span class="entity">s2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">s1</span><span class="main">,</span> <span class="entity">s2'</span><span class="main">)</span> |&gt; apsnd <span class="main">(</span>Substring.triml <span class="inner_numeral">1</span><span class="main">)</span> |&gt; apply2 Substring.string
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.isEmpty <span class="entity">s2'</span> <span class="keyword2"><span class="keyword">then</span></span>
      Option.map Rat.of_int <span class="main">(</span>Int.fromString <span class="entity">s1</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      Option.mapPartial <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> Rat.make <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>Int.fromString <span class="entity">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Int.fromString <span class="entity">s1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_num</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span> 
    Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Code_Numeral.int_of_integer"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">dest_num</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">HOLogic.dest_number</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_rat_number</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span> 
    <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Rings.divide_class.divide"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">a</span> $ <span class="entity">b</span>
      <span class="main">=&gt;</span> Rat.make <span class="main">(</span>snd <span class="main">(</span><span class="entity">dest_num</span> <span class="entity">a</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="entity">dest_num</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Groups.uminus_class.uminus"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">a</span> 
      <span class="main">=&gt;</span> ~ <span class="main">(</span><span class="entity">dest_rat_number</span> <span class="entity">a</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Rat.field_char_0_class.of_rat"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">a</span> <span class="main">=&gt;</span> <span class="entity">dest_rat_number</span> <span class="entity">a</span>
  <span class="main">|</span>  <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Rat.Frct"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "Product_Type.Pair"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">a</span> $ <span class="entity">b</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=&gt;</span> Rat.make <span class="main">(</span>snd <span class="main">(</span><span class="entity">dest_num</span> <span class="entity">a</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="entity">dest_num</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Rat.of_int <span class="main">(</span>snd <span class="main">(</span><span class="entity">dest_num</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_rat_number</span> <span class="entity">ty</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Rat.dest <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">HOLogic.mk_number</span> <span class="entity">ty</span> <span class="entity">a</span>
  <span class="main">|</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Rings.divide_class.divide<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">ty</span> --&gt; <span class="entity">ty</span> --&gt; <span class="entity">ty</span><span class="main">)</span> $ 
        <span class="entity">HOLogic.mk_number</span> <span class="entity">ty</span> <span class="entity">a</span> $ <span class="entity">HOLogic.mk_number</span> <span class="entity">ty</span> <span class="entity">b</span>

<span class="keyword2"><span class="keyword">end</span></span>

›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LP_PARAMS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span>
<span class="keyword1"><span class="keyword">val</span></span> print <span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> string
<span class="keyword1"><span class="keyword">val</span></span> read <span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">T</span> option
<span class="keyword1"><span class="keyword">val</span></span> compare <span class="main">:</span> <span class="main">(</span><span class="entity">T</span> * <span class="entity">T</span><span class="main">)</span> <span class="main">-&gt;</span> General.order
<span class="keyword1"><span class="keyword">val</span></span> negate <span class="main">:</span> <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">T</span>
<span class="keyword1"><span class="keyword">val</span></span> from_int <span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">T</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LINEAR_PROGRAM_COMMON</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">exception</span></span> QSOpt_Parse
  <span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">infty</span> <span class="main">=</span> <span class="entity">Finite</span> <span class="keyword2"><span class="keyword">of</span></span> 'a <span class="main">|</span> <span class="entity">Pos_Infty</span> <span class="main">|</span> <span class="entity">Neg_Infty</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">comparison</span> <span class="main">=</span> <span class="entity">LEQ</span> <span class="main">|</span> <span class="entity">EQ</span> <span class="main">|</span> <span class="entity">GEQ</span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">optimization_mode</span> <span class="main">=</span> <span class="entity">MAXIMIZE</span> <span class="main">|</span> <span class="entity">MINIMIZE</span>
  <span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">result</span> <span class="main">=</span> <span class="entity">Optimal</span> <span class="keyword2"><span class="keyword">of</span></span> 'a * <span class="main">(</span>string * 'a<span class="main">)</span> list <span class="main">|</span> <span class="entity">Unbounded</span> <span class="main">|</span> <span class="entity">Infeasible</span> <span class="main">|</span> <span class="entity">Unknown</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">var</span> <span class="main">=</span> string
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">bound</span> <span class="main">=</span> 'a <span class="entity">infty</span> * <span class="entity">var</span> * 'a <span class="entity">infty</span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">linterm</span> <span class="main">=</span> <span class="main">(</span>'a * <span class="entity">var</span><span class="main">)</span> list
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">constraint</span> <span class="main">=</span> 'a <span class="entity">linterm</span> * <span class="entity">comparison</span> * 'a
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">prog</span> <span class="main">=</span> <span class="entity">optimization_mode</span> * 'a <span class="entity">linterm</span> * 'a <span class="entity">constraint</span> list * 'a <span class="entity">bound</span> list
  
  <span class="keyword1"><span class="keyword">val</span></span> is_finite <span class="main">:</span> 'a <span class="entity">infty</span> <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> map_infty <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">infty</span> <span class="main">-&gt;</span> 'b <span class="entity">infty</span>

  <span class="keyword1"><span class="keyword">val</span></span> print_infty <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">infty</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> print_comparison <span class="main">:</span> <span class="entity">comparison</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> print_optimization_mode <span class="main">:</span> <span class="entity">optimization_mode</span> <span class="main">-&gt;</span> string
  
  <span class="keyword1"><span class="keyword">val</span></span> gen_print_bound <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="entity">bound</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> gen_print_linterm <span class="main">:</span>
    <span class="main">(</span><span class="main">(</span>'a * 'a <span class="main">-&gt;</span> General.order<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> 'a<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> 'a<span class="main">)</span><span class="main">)</span> <span class="main">-&gt;</span> 
    'a <span class="entity">linterm</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> gen_print_constraint <span class="main">:</span>
    <span class="main">(</span><span class="main">(</span>'a * 'a <span class="main">-&gt;</span> General.order<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> 'a<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> 'a<span class="main">)</span><span class="main">)</span> <span class="main">-&gt;</span> 
    'a <span class="entity">constraint</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> gen_print_program <span class="main">:</span>
    <span class="main">(</span><span class="main">(</span>'a * 'a <span class="main">-&gt;</span> General.order<span class="main">)</span> * <span class="main">(</span>int <span class="main">-&gt;</span> 'a<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> * <span class="main">(</span>'a <span class="main">-&gt;</span> 'a<span class="main">)</span><span class="main">)</span> <span class="main">-&gt;</span> 
    'a <span class="entity">prog</span> <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> gen_read_result <span class="main">:</span> <span class="main">(</span>string <span class="main">-&gt;</span> 'a option<span class="main">)</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">result</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LINEAR_PROGRAM</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
<span class="keyword1"><span class="keyword">include</span></span> <span class="entity">LINEAR_PROGRAM_COMMON</span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span>

<span class="keyword1"><span class="keyword">val</span></span> print_bound <span class="main">:</span> <span class="entity">T</span> <span class="entity">bound</span> <span class="main">-&gt;</span> string
<span class="keyword1"><span class="keyword">val</span></span> print_linterm <span class="main">:</span> <span class="entity">T</span> <span class="entity">linterm</span> <span class="main">-&gt;</span> string
<span class="keyword1"><span class="keyword">val</span></span> print_constraint <span class="main">:</span> <span class="entity">T</span> <span class="entity">constraint</span> <span class="main">-&gt;</span> string
<span class="keyword1"><span class="keyword">val</span></span> print_program <span class="main">:</span> <span class="entity">T</span> <span class="entity">prog</span> <span class="main">-&gt;</span> string

<span class="keyword1"><span class="keyword">val</span></span> save_program <span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">T</span> <span class="entity">prog</span> <span class="main">-&gt;</span> unit
<span class="keyword1"><span class="keyword">val</span></span> solve_program <span class="main">:</span> <span class="entity">T</span> <span class="entity">prog</span> <span class="main">-&gt;</span> <span class="entity">T</span> <span class="entity">result</span>
<span class="keyword1"><span class="keyword">val</span></span> read_result <span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">T</span> <span class="entity">result</span>
<span class="keyword1"><span class="keyword">val</span></span> read_result_file <span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">T</span> <span class="entity">result</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Linear_Program_Common</span> <span class="main">:</span> <span class="entity">LINEAR_PROGRAM_COMMON</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">QSOpt_Parse</span>
<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">infty</span> <span class="main">=</span> <span class="entity">Finite</span> <span class="keyword2"><span class="keyword">of</span></span> 'a <span class="main">|</span> <span class="entity">Pos_Infty</span> <span class="main">|</span> <span class="entity">Neg_Infty</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">comparison</span> <span class="main">=</span> <span class="entity">LEQ</span> <span class="main">|</span> <span class="entity">EQ</span> <span class="main">|</span> <span class="entity">GEQ</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">optimization_mode</span> <span class="main">=</span> <span class="entity">MAXIMIZE</span> <span class="main">|</span> <span class="entity">MINIMIZE</span>
<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">result</span> <span class="main">=</span> <span class="entity">Optimal</span> <span class="keyword2"><span class="keyword">of</span></span> 'a * <span class="main">(</span>string * 'a<span class="main">)</span> list <span class="main">|</span> <span class="entity">Unbounded</span> <span class="main">|</span> <span class="entity">Infeasible</span> <span class="main">|</span> <span class="entity">Unknown</span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">var</span> <span class="main">=</span> string

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">bound</span> <span class="main">=</span> 'a <span class="entity">infty</span> * <span class="entity">var</span> * 'a <span class="entity">infty</span>
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">linterm</span> <span class="main">=</span> <span class="main">(</span>'a * <span class="entity">var</span><span class="main">)</span> list
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">constraint</span> <span class="main">=</span> 'a <span class="entity">linterm</span> * <span class="entity">comparison</span> * 'a
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">prog</span> <span class="main">=</span> <span class="entity">optimization_mode</span> * 'a <span class="entity">linterm</span> * 'a <span class="entity">constraint</span> list * 'a <span class="entity">bound</span> list

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_finite</span> <span class="main">(</span><span class="entity">Finite</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_finite</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_infty</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">Finite</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Finite</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">map_infty</span> <span class="main">_</span> <span class="entity">Pos_Infty</span> <span class="main">=</span> <span class="entity">Pos_Infty</span>
  <span class="main">|</span> <span class="entity">map_infty</span> <span class="main">_</span> <span class="entity">Neg_Infty</span> <span class="main">=</span> <span class="entity">Neg_Infty</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_infty</span> <span class="main">_</span> <span class="entity">Neg_Infty</span> <span class="main">=</span> <span class="inner_quoted">"-INF"</span>
  <span class="main">|</span> <span class="entity">print_infty</span> <span class="main">_</span> <span class="entity">Pos_Infty</span> <span class="main">=</span> <span class="inner_quoted">"INF"</span>
  <span class="main">|</span> <span class="entity">print_infty</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">Finite</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_comparison</span> <span class="entity">LEQ</span> <span class="main">=</span> <span class="inner_quoted">"&lt;="</span>
  <span class="main">|</span> <span class="entity">print_comparison</span> <span class="entity">EQ</span> <span class="main">=</span> <span class="inner_quoted">"="</span>
  <span class="main">|</span> <span class="entity">print_comparison</span> <span class="entity">GEQ</span> <span class="main">=</span> <span class="inner_quoted">"&gt;="</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_optimization_mode</span> <span class="entity">MINIMIZE</span> <span class="main">=</span> <span class="inner_quoted">"MINIMIZE"</span>
  <span class="main">|</span> <span class="entity">print_optimization_mode</span> <span class="entity">MAXIMIZE</span> <span class="main">=</span> <span class="inner_quoted">"MAXIMIZE"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_print_bound</span> <span class="main">_</span> <span class="main">(</span><span class="entity">Neg_Infty</span><span class="main">,</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">Pos_Infty</span><span class="main">)</span> <span class="main">=</span> <span class="entity">v</span> ^ <span class="inner_quoted">" free"</span>
  <span class="main">|</span> <span class="entity">gen_print_bound</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">Neg_Infty</span><span class="main">,</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="entity">v</span> ^ <span class="inner_quoted">" &lt;= "</span> ^ <span class="entity">print_infty</span> <span class="entity">f</span> <span class="entity">u</span>
  <span class="main">|</span> <span class="entity">gen_print_bound</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">Pos_Infty</span><span class="main">)</span> <span class="main">=</span>  <span class="entity">print_infty</span> <span class="entity">f</span> <span class="entity">l</span> ^ <span class="inner_quoted">" &lt;= "</span> ^ <span class="entity">v</span>
  <span class="main">|</span> <span class="entity">gen_print_bound</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">v</span><span class="main">,</span> <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="entity">print_infty</span> <span class="entity">f</span> <span class="entity">l</span> ^ <span class="inner_quoted">" &lt;= "</span> ^ <span class="entity">v</span> ^ <span class="inner_quoted">" &lt;= "</span> ^ <span class="entity">print_infty</span> <span class="entity">f</span> <span class="entity">u</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_print_summand</span> <span class="main">(</span><span class="entity">cmp</span><span class="main">,</span> <span class="entity">from_int</span><span class="main">,</span> <span class="entity">print</span><span class="main">,</span> <span class="entity">negate</span><span class="main">)</span> <span class="entity">first</span> <span class="entity">c</span> <span class="entity">v</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">neg</span> <span class="main">=</span> <span class="main">(</span><span class="entity">cmp</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">from_int</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> LESS<span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eq</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span><span class="entity">cmp</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> EQUAL<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">one</span> <span class="main">=</span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">from_int</span> <span class="inner_numeral">1</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mone</span> <span class="main">=</span> <span class="entity">eq</span> <span class="main">(</span><span class="entity">from_int</span> <span class="main">(</span><span class="inner_numeral">~1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c'</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">first</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">one</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">""</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">first</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">mone</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"- "</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">first</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">print</span> <span class="entity">c</span> ^ <span class="inner_quoted">" "</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mone</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">" - "</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">one</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">" + "</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">neg</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">" - "</span> ^ <span class="entity">print</span> <span class="main">(</span><span class="entity">negate</span> <span class="entity">c</span><span class="main">)</span> ^ <span class="inner_quoted">" "</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">" + "</span> ^ <span class="entity">print</span> <span class="entity">c</span> ^ <span class="inner_quoted">" "</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">c'</span> ^ <span class="entity">v</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_print_linterm</span> <span class="entity">ops</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> length <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_summand</span> <span class="main">=</span> <span class="entity">gen_print_summand</span> <span class="entity">ops</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">v</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">print_summand</span> <span class="main">(</span><span class="entity">i</span> <span class="main">=</span> <span class="entity">n</span><span class="main">)</span> <span class="entity">c</span> <span class="entity">v</span> ^ <span class="entity">acc</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    snd <span class="main">(</span>fold <span class="entity">go</span> <span class="main">(</span>rev <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_quoted">""</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_print_constraint</span> <span class="main">(</span><span class="entity">ops</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">print</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">cmp</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">=</span> 
   <span class="entity">gen_print_linterm</span> <span class="entity">ops</span> <span class="entity">lhs</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">print_comparison</span> <span class="entity">cmp</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">print</span> <span class="entity">rhs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_print_program</span> <span class="main">(</span><span class="entity">ops</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">print</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">mode</span><span class="main">,</span> <span class="entity">obj</span><span class="main">,</span> <span class="entity">constrs</span><span class="main">,</span> <span class="entity">bnds</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">padding</span> <span class="main">=</span> replicate_string <span class="inner_numeral">4</span> <span class="inner_quoted">" "</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_block</span> <span class="entity">s</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">s</span> :: map <span class="main">(</span>prefix <span class="entity">padding</span> o <span class="entity">f</span><span class="main">)</span> <span class="entity">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_block'</span> <span class="entity">s</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">xs</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">mk_block</span> <span class="entity">s</span> <span class="entity">f</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lines</span> <span class="main">=</span>
      <span class="entity">mk_block</span> <span class="main">(</span><span class="entity">print_optimization_mode</span> <span class="entity">mode</span><span class="main">)</span> <span class="main">(</span><span class="entity">gen_print_linterm</span> <span class="entity">ops</span><span class="main">)</span> <span class="main">[</span><span class="entity">obj</span><span class="main">]</span> @
      <span class="entity">mk_block'</span> <span class="inner_quoted">"ST"</span> <span class="main">(</span><span class="entity">gen_print_constraint</span> <span class="entity">ops</span><span class="main">)</span> <span class="entity">constrs</span> @
      <span class="entity">mk_block'</span> <span class="inner_quoted">"BOUNDS"</span> <span class="main">(</span><span class="entity">gen_print_bound</span> <span class="entity">print</span><span class="main">)</span> <span class="entity">bnds</span> @ <span class="main">[</span><span class="inner_quoted">"END"</span><span class="main">,</span> <span class="inner_quoted">""</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    cat_lines <span class="entity">lines</span>
  <span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">QSOpt_Parse</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_status</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> String.isPrefix <span class="inner_quoted">"status "</span> <span class="entity">x</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span>String.isPrefix <span class="inner_quoted">"status ="</span> <span class="entity">x</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">statuses</span> <span class="main">=</span> <span class="main">[</span><span class="inner_quoted">"OPTIMAL"</span><span class="main">,</span> <span class="inner_quoted">"INFEASIBLE"</span><span class="main">,</span> <span class="inner_quoted">"UNBOUNDED"</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> find_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> String.isPrefix <span class="main">(</span><span class="inner_quoted">"status "</span> ^ <span class="entity">s</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">statuses</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> SOME <span class="inner_quoted">"UNKNOWN"</span>
      <span class="main">|</span> SOME <span class="entity">y</span> <span class="main">=&gt;</span> SOME <span class="entity">y</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span>
    NONE

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> NONE
  <span class="main">|</span> <span class="entity">apply</span> <span class="entity">abort</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">abort</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span>
        NONE 
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">apply</span> <span class="entity">abort</span> <span class="entity">f</span> <span class="entity">xs</span>
      <span class="main">|</span> SOME <span class="entity">y</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_repeat</span> <span class="entity">abort</span> <span class="main">(</span><span class="entity">f</span> <span class="main">:</span> string <span class="main">-&gt;</span> 'a option<span class="main">)</span> <span class="main">:</span> string list <span class="main">-&gt;</span> 'a list * string list <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="entity">xs</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">apply</span> <span class="entity">abort</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="main">(</span>rev <span class="entity">acc</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span>
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">go</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">the_apply</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">apply</span> <span class="main">(</span>K false<span class="main">)</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">QSOpt_Parse</span>
  <span class="main">|</span> SOME <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">y</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_unit</span> <span class="entity">p</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">apply</span> <span class="main">(</span>not o <span class="entity">p</span><span class="main">)</span> <span class="main">(</span>K <span class="main">(</span>SOME <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">QSOpt_Parse</span>
  <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_read_value</span> <span class="entity">read</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> unprefix <span class="inner_quoted">"Value = "</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">read</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> NONE

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trim</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">chop</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">chop</span> <span class="main">(</span><span class="entity">l</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Char.isSpace <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">chop</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">l</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    String.implode o <span class="entity">chop</span> o rev o <span class="entity">chop</span> o rev o String.explode
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_read_assignment</span> <span class="entity">read</span> <span class="entity">x</span> <span class="main">:</span> <span class="main">(</span>string * 'a<span class="main">)</span> option <span class="main">=</span>
  <span class="entity">x</span> |&gt; try <span class="main">(</span>
    Substring.full 
    #&gt; Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> &lt;&gt; <span class="inner_quoted">#"="</span><span class="main">)</span> 
    #&gt; apply2 Substring.string 
    #&gt; apsnd <span class="main">(</span>unprefix <span class="inner_quoted">"="</span><span class="main">)</span>
    #&gt; apply2 <span class="entity">trim</span><span class="main">)</span>
  |&gt; Option.mapPartial <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">read</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_read_result</span> <span class="entity">read</span> <span class="entity">s</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span> |&gt; split_lines |&gt; map <span class="entity">trim</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">status</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">the_apply</span> <span class="entity">read_status</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">result</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">status</span> <span class="main">=</span> <span class="inner_quoted">"OPTIMAL"</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">value</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">the_apply</span> <span class="main">(</span><span class="entity">gen_read_value</span> <span class="entity">read</span><span class="main">)</span> <span class="entity">s</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">apply_unit</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> <span class="main">=</span> <span class="inner_quoted">"VARS:"</span><span class="main">)</span> <span class="entity">s</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vars</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">apply_repeat</span> <span class="main">(</span>String.isSuffix <span class="inner_quoted">":"</span><span class="main">)</span> <span class="main">(</span><span class="entity">gen_read_assignment</span> <span class="entity">read</span><span class="main">)</span> <span class="entity">s</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">Optimal</span> <span class="main">(</span><span class="entity">value</span><span class="main">,</span> <span class="entity">vars</span><span class="main">)</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">status</span> <span class="main">=</span> <span class="inner_quoted">"INFEASIBLE"</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="main">(</span><span class="entity">Infeasible</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">status</span> <span class="main">=</span> <span class="inner_quoted">"UNBOUNDED"</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="main">(</span><span class="entity">Unbounded</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="main">(</span><span class="entity">Unknown</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">result</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">Linear_Program</span><span class="main">(</span>LP_Params <span class="main">:</span> <span class="entity">LP_PARAMS</span><span class="main">)</span> <span class="main">:</span> <span class="entity">LINEAR_PROGRAM</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> Linear_Program_Common<span class="main">;</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> <span class="entity">LP_Params</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ops</span> <span class="main">=</span> <span class="main">(</span><span class="entity">compare</span><span class="main">,</span> <span class="entity">from_int</span><span class="main">,</span> <span class="entity">print</span><span class="main">,</span> <span class="entity">negate</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">T</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_bound</span> <span class="main">=</span> <span class="entity">gen_print_bound</span> <span class="entity">print</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_linterm</span> <span class="main">=</span> <span class="entity">gen_print_linterm</span> <span class="entity">ops</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_constraint</span> <span class="main">=</span> <span class="entity">gen_print_constraint</span> <span class="entity">ops</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print_program</span> <span class="main">=</span> <span class="entity">gen_print_program</span> <span class="entity">ops</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">save_program</span> <span class="entity">filename</span> <span class="entity">prog</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> <span class="entity">print_program</span> <span class="entity">prog</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> TextIO.openOut <span class="entity">filename</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> TextIO.output <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">output</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> TextIO.closeOut <span class="entity">f</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap</span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_quoted">"\""</span>^<span class="entity">s</span>^<span class="inner_quoted">"\""</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read_result</span> <span class="main">=</span> <span class="entity">gen_read_result</span> <span class="entity">LP_Params.read</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_result_file</span> <span class="entity">filename</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">f</span> <span class="main">=</span> TextIO.openIn <span class="entity">filename</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> TextIO.input <span class="entity">f</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> TextIO.closeIn <span class="entity">f</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">read_result</span> <span class="entity">s</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve_program</span> <span class="entity">prog</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> string_of_int <span class="main">(</span>Time.toMicroseconds <span class="main">(</span>Time.now <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lpname</span> <span class="main">=</span> Path.implode <span class="main">(</span>Path.expand <span class="main">(</span><span class="entity">Isabelle_System.create_tmp_path</span> <span class="entity">name</span> <span class="inner_quoted">".lp"</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">resultname</span> <span class="main">=</span> Path.implode <span class="main">(</span>Path.expand <span class="main">(</span><span class="entity">Isabelle_System.create_tmp_path</span> <span class="entity">name</span> <span class="inner_quoted">".sol"</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">save_program</span> <span class="entity">lpname</span> <span class="entity">prog</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">esolver_path</span> <span class="main">=</span> getenv <span class="inner_quoted">"QSOPT_EXACT_PATH"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">esolver</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">esolver_path</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"esolver"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">esolver_path</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">command</span> <span class="main">=</span>  <span class="entity">wrap</span> <span class="entity">esolver</span> ^ <span class="inner_quoted">" -O "</span> ^ <span class="entity">wrap</span> <span class="entity">resultname</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">wrap</span> <span class="entity">lpname</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>err <span class="main">=</span> <span class="entity">err</span><span class="main">,</span> rc <span class="main">=</span> <span class="entity">rc</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">Bash.process</span> <span class="entity">command</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">rc</span> &lt;&gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"QSopt_exact returned with an error (return code "</span> ^ 
          Int.toString <span class="entity">rc</span> ^ <span class="inner_quoted">"):\n"</span> ^ <span class="entity">err</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">read_result_file</span> <span class="entity">resultname</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> OS.FileSys.remove <span class="entity">lpname</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> OS.FileSys.remove <span class="entity">resultname</span>
        <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">result</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Rat_Linear_Program</span> <span class="main">=</span> <span class="entity">Linear_Program</span><span class="main">(</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> Rat.rat

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">print</span> <span class="main">=</span> <span class="entity">Rat_Utils.rat_to_string</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> <span class="entity">Rat_Utils.string_to_rat</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compare</span> <span class="main">=</span> Rat.ord
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">from_int</span> <span class="main">=</span> Rat.of_int
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">negate</span> <span class="main">=</span> Rat.neg

<span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

›</span>


<span class="comment1">(*
ML_val ‹
  open Rat_Linear_Program;

  val mode = MAXIMIZE
  val goal = map (apfst Rat.from_int) [(~1, "r1"), (1, "r2")]
  fun mk_constr xs cmp rhs = (map (apfst Rat.from_int) xs, cmp, Rat.from_int rhs)
  fun mk_bnd (l, x, u) = (map_infty Rat.from_int l, x, map_infty Rat.from_int u)
  val mk_bnds = map mk_bnd
  val constr1 = mk_constr [(1, "x"), (~1, "y")] EQ 42
  val bnds = mk_bnds [(Finite (~2), "x", Pos_Infty), (Finite 0, "y", Finite 1)]
  val prog = (mode, goal, [constr1], bnds)
  val _ = writeln (print_program prog)
  val _ = save_program "/tmp/foo.lp" prog
› *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SDS_Automation">
<div class="head">
<h1>Theory SDS_Automation</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    SDS_Automation.thy
  Author:  Manuel Eberl &lt;eberlm@in.tum.de&gt;

  This theory provides a number of commands to automatically derive restrictions on the 
  results of Social Decision Schemes fulfilling properties like Anonymity, Neutrality, 
  Ex-post- or SD-efficiency, and SD-Strategy-Proofness.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Automatic Fact Gathering for Social Decision Schemes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SDS_Automation
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="Preference_Profile_Cmd.html">Preference_Profile_Cmd</a>
    <a href="QSOpt_Exact.html">QSOpt_Exact</a>
    <span class="quoted">"<a href="Social_Decision_Schemes.html">../Social_Decision_Schemes</a>"</span>
<span class="keyword2"><span class="keyword">keywords</span></span> 
  <span class="quoted">"derive_orbit_equations"</span>
  <span class="quoted">"derive_support_conditions"</span> 
  <span class="quoted">"derive_ex_post_conditions"</span>
  <span class="quoted">"find_inefficient_supports"</span>
  <span class="quoted">"prove_inefficient_supports"</span>
  <span class="quoted">"derive_strategyproofness_conditions"</span> <span class="main">::</span> thy_goal
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now provide the following commands to automatically derive restrictions on the results
  of Social Decision Schemes satisfying Anonymity, Neutrality, Efficiency, or Strategy-Proofness:
  \begin{description}
    \item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> derive_orbit_equations<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to derive equalities arising from automorphisms of the 
      given profiles due to Anonymity and Neutrality
    \item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> derive_ex_post_conditions<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to find all Pareto losers and the given profiles and 
      derive the facts that they must be assigned probability 0 by any \textit{ex-post}-efficient
      SDS
    \item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> find_inefficient_supports<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to use Linear Programming to find all minimal SD-inefficient 
      (but not \textit{ex-post}-inefficient) supports in the given profiles and output a 
      corresponding witness lottery for each of them
    \item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> prove_inefficient_supports<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to prove a specified set of support conditions arising from
      \textit{ex-post}- or \textit{SD}-Efficiency. For conditions arising from \textit{SD}-Efficiency,
      a witness lottery must be specified (e.\,g. as computed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> derive_orbit_equations<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
    \item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> derive_support_conditions<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to automatically find and prove all support conditions
      arising from \textit{ex-post-} and \textit{SD}-Efficiency
    \item [<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> derive_strategyproofness_conditions<span class="antiquote"><span class="antiquote">}</span></span></span></span>] to automatically derive all conditions
      arising from weak Strategy-Proofness and any manipulations between the given preference 
      profiles. An optional maximum manipulation size can be specified.
  \end{description}
  All commands except <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> find_inefficient_supports<span class="antiquote"><span class="antiquote">}</span></span></span></span> open a proof state and leave behind 
  proof obligations for the user to discharge. This should always be possible using the Simplifier,
  possibly with a few additional rules, depending on the context.
 
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disj_False_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> False <span class="main">⟷</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> multiset_add_ac <span class="main">=</span> add_ac<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> multiset"</span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> less_or_eq_real<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_Diff_single_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">c</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_post_efficient_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> prefs_from_table <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="free">y</span> <span class="main">≽[</span>prefs_from_table <span class="free">xss</span> <span class="bound">i</span><span class="main">]</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">y</span> <span class="main">≼[</span>prefs_from_table <span class="free">xss</span> <span class="free">i</span><span class="main">]</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ex_post_efficient_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span> <span class="main">⟶</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ex_post<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_post_efficient_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ex_post <span class="keyword1"><span class="command">interpret</span></span> ex_post_efficient_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex_post_efficient''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_inefficient_support_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> prefs_from_table <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> set <span class="free">as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> 
    sum_list <span class="main">(</span>map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> prefs_from_table <span class="free">xss</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span>
    real <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span>prefs_from_table <span class="free">xss</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>length <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">alts</span><span class="main">.</span> sum_list <span class="main">(</span>map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> prefs_from_table <span class="free">xss</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span>
                        real <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span>prefs_from_table <span class="free">xss</span> <span class="free">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>length <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sd_efficient_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sd_efficient_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"pref_profile_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">R</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sd_efficient_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> ys <span class="keyword1"><span class="command">have</span></span> ys'<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf_of_list_wf <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_list_wfI<span class="main">)</span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ys' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>pmf_of_list <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
      sum_list <span class="main">(</span>map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> prefs_from_table <span class="free">xss</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf_of_list<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preferred_alts_def R<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>pmf_of_set <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
      real <span class="main">(</span>card <span class="main">(</span>set <span class="free">as</span> <span class="main">∩</span> preferred_alts <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>card <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measure_pmf_of_set<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">∩</span> preferred_alts <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preferred_alts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distinct_card distinct_filter assms<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">=</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distinct_card assms<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="main">(</span>pmf_of_set <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preferred_alts <span class="main">(</span><span class="free">R</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
      real <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span>prefs_from_table <span class="free">xss</span> <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>length <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> B <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SD_inefficient_support'<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ys ys' <span class="keyword3"><span class="command">show</span></span> lottery1<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf_of_list <span class="free">ys</span> <span class="main">∈</span> lotteries"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_list_lottery<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> lottery2<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf_of_set <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> lotteries"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set_lottery<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> i as SD2 lottery1 lottery2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>SD <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>pmf_of_list <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> preorder_on.SD_preorder<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">alts</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A B not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> as SD1 lottery1 lottery2 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">agents</span><span class="main">.</span> SD <span class="main">(</span><span class="free">R</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="main">(</span>pmf_of_list <span class="free">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preorder_on.SD_preorder<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">alts</span></span><span class="main"><span class="main">]</span></span> A B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> as<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pref_classes</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pref_classes</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="free"><span class="bound"><span class="entity">le</span></span></span> <span class="main">=</span> preferred_alts <span class="free"><span class="bound"><span class="entity">le</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">alts</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">alts</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pref_classes_lists</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pref_classes_lists</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pref_classes_lists</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">pref_classes_lists</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pref_classes_lists_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pref_classes_lists_aux</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pref_classes_lists_aux</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free">pref_classes_lists_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pref_classes_lists_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pref_classes_lists <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(∪)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> pref_classes_lists <span class="free">xs</span> <span class="main">∪</span> pref_classes_lists <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pref_classes_lists_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="free">acc</span> <span class="free">xss</span> <span class="main">=</span> 
            <span class="main">(</span>insert <span class="free">acc</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∪</span> <span class="free">acc</span><span class="main">)</span> <span class="main">`</span> pref_classes_lists <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">acc</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pref_classes_lists_aux.induct <span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Nil Cons<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">acc</span> <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">acc</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">xss</span> <span class="main">=</span>
                          insert <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>pref_classes_lists <span class="main">(</span>rev <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                          <span class="main">{</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="skolem">acc</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> 
      insert <span class="skolem">acc</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> pref_classes_lists <span class="main">(</span>rev <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
         <span class="main">{</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons pref_classes_lists_append image_image Un_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span>  A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="skolem">acc</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> 
                            pref_classes_lists <span class="main">(</span>rev <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">acc</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_classes_lists_append image_image Un_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pref_classes_list_aux_hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xss</span> <span class="main">=</span> hd <span class="free">xss</span> <span class="main">#</span> tl <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xss</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> is_weak_ranking <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> is_weak_ranking_Cons<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> 
           insert <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∪</span> hd <span class="free">xss</span><span class="main">)</span> <span class="main">`</span> pref_classes_lists <span class="main">(</span>rev <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
           <span class="main">{</span>hd <span class="free">xss</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_classes_lists_aux<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xss</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> set_simps<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∪</span> hd <span class="free">xss</span><span class="main">)</span> <span class="main">`</span> pref_classes_lists <span class="main">(</span>rev <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               pref_classes_lists <span class="main">(</span>rev <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>hd <span class="free">xss</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pref_classes_lists_append<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>hd <span class="free">xss</span><span class="main">]</span> <span class="main">=</span> rev <span class="free">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> A<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rev.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pref_classes_of_weak_ranking_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="free">xss</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists <span class="free">xss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> set <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="free">xss</span> <span class="skolem">x</span> <span class="main">∈</span> pref_classes_lists <span class="free">xss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons of_weak_ranking_Collect_ge_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pref_classes_lists <span class="free">xss</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> of_weak_ranking_Collect_ge <span class="free">xss</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pref_classes_lists <span class="skolem">xss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons of_weak_ranking_Collect_ge_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pref_classes_lists <span class="skolem">xss</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> of_weak_ranking_Collect_ge <span class="skolem">xss</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_weak_ranking_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> of_weak_ranking_Collect_ge <span class="skolem">xss</span> <span class="main">`</span>
                         <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">xs</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Collect_ge_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_pref_classes_of_weak_ranking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pref_classes <span class="free">alts</span> <span class="main">(</span>of_weak_ranking <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes <span class="free">alts</span> <span class="main">(</span>of_weak_ranking <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> 
               preferred_alts <span class="main">(</span>of_weak_ranking <span class="free">xss</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pref_classes_def assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_classes_of_weak_ranking_aux<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_weak_ranking_Collect_ge <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> preferred_alts <span class="main">(</span>of_weak_ranking <span class="free">xss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_weak_ranking_Collect_ge_def preferred_alts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preferred_alts <span class="main">(</span>of_weak_ranking <span class="free">xss</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                    pref_classes_lists <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes_lists <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span>set <span class="free">xss</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> 
                          pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xss</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_classes_list_aux_hd_tl <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> preorder_on
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SD_iff_pref_classes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> lotteries_on <span class="free">carrier</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span> <span class="main">⟷</span> 
             <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">carrier</span> <span class="free">le</span><span class="main">.</span> measure_pmf.prob <span class="free">p</span> <span class="bound">A</span> <span class="main">≤</span> measure_pmf.prob <span class="free">q</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> pref_classes <span class="free">carrier</span> <span class="free">le</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="skolem">A</span> <span class="main">≤</span> measure_pmf.prob <span class="free">q</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SD_preorder pref_classes_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">carrier</span> <span class="free">le</span><span class="main">.</span> measure_pmf.prob <span class="free">p</span> <span class="bound">A</span> <span class="main">≤</span> measure_pmf.prob <span class="free">q</span> <span class="bound">A</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≼[</span>SD<span class="main">(</span><span class="free">le</span><span class="main">)</span><span class="main">]</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SD_preorderI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">carrier</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">x</span><span class="main">)</span>
             <span class="main">≤</span> measure_pmf.prob <span class="free">q</span> <span class="main">(</span>preferred_alts <span class="free">le</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"preferred_alts <span class="free">le</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">carrier</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preferred_alts <span class="free">le</span> <span class="skolem">x</span> <span class="main">∈</span> pref_classes <span class="free">carrier</span> <span class="free">le</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pref_classes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> DiffI imageI<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">p</span> <span class="free">carrier</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="free">q</span> <span class="free">carrier</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measure_pmf.prob_eq_1 lotteries_on_def AE_measure_pmf_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> strategyproof_an_sds<span class="main">)</span> strategyproof'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">&lt;</span>
                        lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span>
                        lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">interpret</span></span> total_preorder_on <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> manipulable_profile <span class="free">R</span> <span class="free">i</span> <span class="free">Ri'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> strategyproof<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> wf i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="free">R</span> <span class="main">∈</span> lotteries"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span><span class="free">R</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> lotteries"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sds_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> manipulable_profile_def strongly_preferred_def
                        SD_iff_pref_classes not_le not_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pref_classes_lists_aux_finite<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> pref_classes_lists_aux <span class="free">acc</span> <span class="free">xss</span> <span class="main">⟹</span> finite <span class="free">acc</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> finite <span class="bound">A</span><span class="main">)</span>
      <span class="main">⟹</span> finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pref_classes_lists_aux.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strategyproof_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">=</span> prefs_from_table <span class="free">xss1</span>"</span></span>
              <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">=</span> prefs_from_table <span class="free">xss2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sds<span class="main">:</span> <span class="quoted"><span class="quoted">"strategyproof_an_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">R1</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">R2</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">R2</span>"</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">xss1</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> 
               <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sds <span class="keyword1"><span class="command">interpret</span></span> strategyproof_an_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ri'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf j <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="var">?Ri'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI pref_profile_wf.prefs_wf'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>1<span class="main">)</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xss1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prefs_from_table_wfD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> prefs_from_table_wfD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> prefs_from_table_wfD<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> this<span class="main">]</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_classes_lists_aux_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def list.set_sel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="skolem">p</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_measure_pmf_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> strategyproof'<span class="main">[</span><span class="operator">OF</span> wf' i<span class="main">]</span> eq <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R1</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="bound">A</span> <span class="main">&lt;</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R1</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> wf eq i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="free">i</span> <span class="main">=</span> of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_map_of<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes <span class="free">alts</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_finite_weak_ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eval_pref_classes_of_weak_ranking<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strategyproof_aux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">≡</span> prefs_from_table <span class="free">xss1</span>"</span></span>
              <span class="quoted"><span class="quoted">"prefs_from_table_wf <span class="free">agents</span> <span class="free">alts</span> <span class="free">xss2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">≡</span> prefs_from_table <span class="free">xss2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sds<span class="main">:</span> <span class="quoted"><span class="quoted">"strategyproof_an_sds <span class="free">agents</span> <span class="free">alts</span> <span class="free">sds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="free">agents</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"list_permutes <span class="free">ys</span> <span class="free">alts</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≡</span> permutation_of_list <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">≡</span> inverse_permutation_of_list <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≡</span> the <span class="main">(</span>map_of <span class="free">xss1</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xss2</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ri'</span> <span class="main">≡</span> of_weak_ranking <span class="free">xs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> distinct <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>map snd <span class="free">xss1</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span>the <span class="main">(</span>map_of <span class="free">xss1</span> <span class="free">i</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">xs'</span><span class="main">#}</span> <span class="main">=</span>
                  mset <span class="main">(</span>map <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="free">xss2</span><span class="main">)</span>"</span></span>
               <span class="quoted"><span class="quoted">"pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">`</span> <span class="free">ps</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"list_permutes <span class="free">ys</span> <span class="free">alts</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">σ'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∧</span> <span class="var">?th</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword1"><span class="command">have</span></span> perm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">permutes</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sds <span class="keyword1"><span class="command">interpret</span></span> strategyproof_an_sds <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">sds</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>3<span class="main">)</span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xss2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prefs_from_table_wfD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> xs'_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>map_of <span class="free">xss2</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> wf<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> xs'_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">xss2</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_weak_ranking_map_inj permutes_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm'<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * xs'_aux' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="free">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs' is_finite_weak_ranking_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prefs_from_table_wfD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> xs'_aux<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs' 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Union <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> permutes_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> perm'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_weak_ranking <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"is_finite_weak_ranking <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">alts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this wf j <span class="keyword1"><span class="command">have</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R1</span>"</span></span> <span class="quoted"><span class="quoted">"total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span> 
                      <span class="quoted"><span class="quoted">"is_pref_profile <span class="free">R2</span>"</span></span> <span class="quoted"><span class="quoted">"finite_total_preorder_on <span class="free">alts</span> <span class="free">Ri'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ri'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pref_profile_from_tableI pref_profile_wf.prefs_wf'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
                                 total_preorder_of_weak_ranking<span class="main">)</span>

 <span class="keyword1"><span class="command">interpret</span></span> R1<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
 <span class="keyword1"><span class="command">interpret</span></span> R2<span class="main">:</span> pref_profile_wf <span class="quoted"><span class="free">agents</span></span> <span class="quoted"><span class="free">alts</span></span> <span class="quoted"><span class="free">R2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">from</span></span> wf<span class="main">(</span>1<span class="main">)</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">xss1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_wf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prefs_from_table_wfD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eq<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="free">xss1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> prefs_from_table_wfD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> prefs_from_table_wfD<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> this<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> wf i wf' wf_xs' xs eq 
    <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"anonymous_profile <span class="main">(</span><span class="free">R1</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>anonymous_profile <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> R1.anonymous_profile_update<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ri'_def weak_ranking_of_weak_ranking mset_map multiset.map_comp xs_def
          anonymise_prefs_from_table prefs_from_table_map_of<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pref_classes_lists_aux_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_finite_weak_ranking_def list.set_sel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lottery_prob <span class="skolem">p</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> pmf <span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measure_measure_pmf_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> strategyproof'<span class="main">[</span><span class="operator">OF</span> wf'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> i<span class="main">]</span> eq' <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R1</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="main">(</span><span class="free">R1</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">&lt;</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>pref_classes <span class="free">alts</span> <span class="main">(</span><span class="free">R1</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="main">(</span><span class="free">R1</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span> lottery_prob <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq' i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sds</span> <span class="main">(</span><span class="free">R1</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">Ri'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sds_anonymous_neutral permutation_of_list_permutes perm wf'
                              pref_profile_wf.wf_update eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> wf eq i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="free">i</span> <span class="main">=</span> of_weak_ranking <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefs_from_table_map_of xs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pref_classes <span class="free">alts</span> <span class="main">(</span>of_weak_ranking <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> pref_classes_lists_aux <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_finite_weak_ranking_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eval_pref_classes_of_weak_ranking<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span>map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span>map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="bound">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R1</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_ps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A eq sum.distinct_set_conv_list <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> measure_map_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> perm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>map_pmf <span class="free">σ</span> <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">sds</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_map_inj'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff permutes_inj permutes_inverses<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> perm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> σ_def σ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inverse_permutation_of_list_correct <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹randomised_social_choice.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹sds_automation.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/randomised_social_choice.ML">
<div class="head">
<h1>File ‹randomised_social_choice.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">RANDOMISED_SOCIAL_CHOICE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">lottery</span>

<span class="keyword1"><span class="keyword">val</span></span> lotteryT <span class="main">:</span> typ <span class="main">-&gt;</span> typ
<span class="keyword1"><span class="keyword">val</span></span> sdsT <span class="main">:</span> typ <span class="main">-&gt;</span> typ <span class="main">-&gt;</span> typ

<span class="keyword1"><span class="keyword">val</span></span> probability <span class="main">:</span> <span class="entity">lottery</span> <span class="main">-&gt;</span> term list <span class="main">-&gt;</span> Rat.rat
<span class="keyword1"><span class="keyword">val</span></span> stochastic_dominance <span class="main">:</span> <span class="entity">Preference_Profiles.prefs</span> <span class="main">-&gt;</span> <span class="entity">lottery</span> * <span class="entity">lottery</span> <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> strict_stochastic_dominance <span class="main">:</span> <span class="entity">Preference_Profiles.prefs</span> <span class="main">-&gt;</span> <span class="entity">lottery</span> * <span class="entity">lottery</span> <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> mk_support_witness <span class="main">:</span> <span class="entity">Preference_Profiles.profile</span> <span class="main">-&gt;</span> <span class="entity">Preference_Profiles.support</span> * <span class="entity">lottery</span> <span class="main">-&gt;</span> 
  <span class="entity">Preference_Profiles.support</span> * <span class="entity">lottery</span> * term

<span class="comment1">(* Construct the linear program that encodes SD inefficiency of the given support *)</span>
<span class="keyword1"><span class="keyword">val</span></span> mk_inefficiency_lp <span class="main">:</span> 
  <span class="entity">Preference_Profiles.profile</span> <span class="main">-&gt;</span> <span class="entity">Preference_Profiles.support</span> <span class="main">-&gt;</span> <span class="main">(</span>string list * string * int<span class="main">)</span> list

<span class="comment1">(* Find a lottery that is strictly SD-preferred to the given support and the agent who
   strictly prefers it. *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_inefficiency_witness <span class="main">:</span> 
  <span class="entity">Preference_Profiles.profile</span> <span class="main">-&gt;</span> <span class="entity">Preference_Profiles.support</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">lottery</span> * term<span class="main">)</span> option

<span class="comment1">(* Finds all non-singleton inefficient supports with a inefficiency certificate for each one.
   (non-singleton because singleton inefficient supports are simply Pareto losers *)</span>
<span class="keyword1"><span class="keyword">val</span></span> find_minimal_inefficient_supports <span class="main">:</span> 
  <span class="entity">Preference_Profiles.profile</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Preference_Profiles.support</span> * <span class="entity">lottery</span> * term<span class="main">)</span> list

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Randomised_Social_Choice</span> <span class="main">:</span> <span class="entity">RANDOMISED_SOCIAL_CHOICE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">lottery</span> <span class="main">=</span> <span class="main">(</span>term * Rat.rat<span class="main">)</span> list

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> Rat_Linear_Program
  <span class="keyword3"><span class="keyword">open</span></span> Preference_Profiles
<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lotteryT</span> <span class="entity">altT</span> <span class="main">=</span> Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> pmf<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">[</span><span class="entity">altT</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sdsT</span> <span class="entity">agentT</span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">pref_profileT</span> <span class="entity">agentT</span> <span class="entity">altT</span> --&gt; <span class="entity">lotteryT</span> <span class="entity">altT</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_inefficiency_lp</span> <span class="entity">p</span> <span class="entity">support</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alt_ids</span> <span class="main">=</span> <span class="entity">alts</span> ~~ List.tabulate <span class="main">(</span>length <span class="entity">alts</span><span class="main">,</span> Int.toString<span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">in_support</span> <span class="main">=</span> member <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">support</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_lottery_var</span> <span class="entity">x</span> <span class="main">=</span> <span class="inner_quoted">"q"</span> ^ the <span class="main">(</span>AList.lookup <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">alt_ids</span> <span class="entity">x</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_slack_var</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> <span class="inner_quoted">"r"</span> ^ Int.toString <span class="entity">i</span> ^ <span class="inner_quoted">"_"</span> ^ Int.toString <span class="entity">j</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ineqs_for_agent</span> <span class="entity">acc</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">mk_ineqs_for_agent</span> <span class="entity">acc</span> <span class="main">_</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">mk_ineqs_for_agent</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="entity">j</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs'</span> <span class="main">=</span> map <span class="entity">mk_lottery_var</span> <span class="entity">xs</span> @ <span class="entity">lhs</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs'</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="entity">in_support</span> <span class="entity">xs</span><span class="main">)</span> + <span class="entity">rhs</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">mk_ineqs_for_agent</span> <span class="main">(</span><span class="main">(</span><span class="entity">lhs'</span><span class="main">,</span><span class="entity">mk_slack_var</span> <span class="entity">i</span> <span class="entity">j</span><span class="main">,</span><span class="entity">rhs'</span><span class="main">)</span>::<span class="entity">acc</span><span class="main">)</span> <span class="main">(</span><span class="entity">lhs'</span><span class="main">,</span><span class="entity">rhs'</span><span class="main">)</span> <span class="entity">xss</span> <span class="main">(</span><span class="entity">j</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">i</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">mk_ineqs_for_agent</span> <span class="entity">acc</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">r</span> <span class="inner_numeral">0</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> |&gt; snd
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lp_constr_to_qsopt_constr</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">slack</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Rat.of_int <span class="entity">n</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs'</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@</span><span class="main">~</span>1</span></span><span class="main">,</span> <span class="entity">slack</span><span class="main">)</span> :: map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">lhs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">lhs'</span><span class="main">,</span> <span class="entity">EQ</span><span class="main">,</span> Rat.of_int <span class="entity">rhs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_inefficiency_lp_qsopt</span> <span class="entity">p</span> <span class="entity">support</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">constrs</span> <span class="main">=</span> <span class="entity">mk_inefficiency_lp</span> <span class="entity">p</span> <span class="entity">support</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> length <span class="entity">support</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sum</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@</span>1</span></span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alt_ids</span> <span class="main">=</span> <span class="entity">alts</span> ~~ List.tabulate <span class="main">(</span>length <span class="entity">alts</span><span class="main">,</span> Int.toString<span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_lottery_var</span> <span class="entity">x</span> <span class="main">=</span> <span class="inner_quoted">"q"</span> ^ the <span class="main">(</span>AList.lookup <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">alt_ids</span> <span class="entity">x</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lottery_vars</span> <span class="main">=</span> map <span class="entity">mk_lottery_var</span> <span class="entity">alts</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">slack_vars</span> <span class="main">=</span> map <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">constrs</span>
 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">constrs'</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">lp_constr_to_qsopt_constr</span> <span class="entity">n</span><span class="main">)</span> <span class="entity">constrs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq</span> <span class="main">=</span> <span class="main">(</span><span class="entity">sum</span> <span class="entity">lottery_vars</span><span class="main">,</span> <span class="entity">EQ</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>1</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">MAXIMIZE</span><span class="main">,</span> <span class="entity">sum</span> <span class="entity">slack_vars</span><span class="main">,</span> <span class="entity">eq</span> :: <span class="entity">constrs'</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_inefficiency_witness</span> <span class="entity">p</span> <span class="entity">lottery</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> <span class="entity">alts_of_profile</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lottery_vars</span> <span class="main">=</span> List.tabulate <span class="main">(</span>length <span class="entity">alts</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="inner_quoted">"q"</span> ^ Int.toString <span class="entity">x</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">slack_vars</span> <span class="main">=</span> 
      <span class="entity">p</span> ~~ List.tabulate <span class="main">(</span>length <span class="entity">p</span><span class="main">,</span> Int.toString<span class="main">)</span>
      |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">prefs</span><span class="main">)</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> 
           <span class="main">(</span><span class="entity">x</span><span class="main">,</span> List.tabulate <span class="main">(</span>length <span class="entity">prefs</span> - <span class="inner_numeral">1</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">j</span> <span class="main">=&gt;</span> <span class="inner_quoted">"r"</span> ^ <span class="entity">i</span> ^ <span class="inner_quoted">"_"</span> ^ Int.toString <span class="entity">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">the_default</span> <span class="entity">x</span> NONE <span class="main">=</span> <span class="entity">x</span>
      <span class="main">|</span> <span class="entity">the_default</span> <span class="main">_</span> <span class="main">(</span>SOME <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> <span class="entity">y</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_solution</span> <span class="main">(</span><span class="entity">diff</span><span class="main">,</span> <span class="entity">assignments</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_val</span> <span class="main">=</span> <span class="entity">the_default</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span> o AList.lookup <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">assignments</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span>
          <span class="entity">slack_vars</span> 
          |&gt; find_first <span class="main">(</span>snd #&gt; exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">get_val</span> <span class="entity">x</span> &gt; <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span><span class="main">)</span><span class="main">)</span> 
          |&gt; Option.map fst
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">diff</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span> <span class="keyword2"><span class="keyword">then</span></span> 
          NONE 
        <span class="keyword2"><span class="keyword">else</span></span> 
          Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">alts</span> ~~ map <span class="entity">get_val</span> <span class="entity">lottery_vars</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">solve_program</span> <span class="main">(</span><span class="entity">mk_inefficiency_lp_qsopt</span> <span class="entity">p</span> <span class="entity">lottery</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">Optimal</span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">process_solution</span> <span class="entity">x</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Match
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">power_set</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="entity">acc</span><span class="main">]</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="entity">xs</span> @ <span class="entity">go</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span> |&gt; sort <span class="main">(</span>int_ord o apply2 length<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_singleton</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_singleton</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_minimal_inefficient_supports</span> <span class="entity">p</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">alts</span> <span class="main">=</span> subtract <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="main">(</span>map <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span><span class="entity">pareto_losers</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">alts_of_profile</span> <span class="entity">p</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">supp</span> <span class="entity">acc</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> List.null <span class="entity">supp</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">is_singleton</span> <span class="entity">supp</span> <span class="keyword1"><span class="keyword">orelse</span></span>
            member <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> subset <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="main">(</span><span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span><span class="main">)</span> <span class="entity">acc</span> <span class="entity">supp</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">acc</span>
      <span class="keyword2"><span class="keyword">else</span></span> 
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">find_inefficiency_witness</span> <span class="entity">p</span> <span class="entity">supp</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">acc</span>
        <span class="main">|</span> SOME <span class="main">(</span><span class="entity">lott</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">supp</span><span class="main">,</span> <span class="entity">lott</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> :: <span class="entity">acc</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    fold <span class="entity">go</span> <span class="main">(</span><span class="entity">power_set</span> <span class="entity">alts</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">probability</span> <span class="main">(</span><span class="entity">lott1</span> <span class="main">:</span> <span class="entity">lottery</span><span class="main">)</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="entity">lott1</span> |&gt; filter <span class="main">(</span>member <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">xs</span> o fst<span class="main">)</span> |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> snd <span class="entity">x</span> + <span class="entity">y</span><span class="main">)</span> <span class="entity">xs</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">uniform_lottery</span> <span class="entity">xs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> Rat.make <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> length <span class="entity">xs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">stochastic_dominance</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">lott1</span><span class="main">,</span> <span class="entity">lott2</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">go</span> <span class="main">_</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">go</span> <span class="main">(</span><span class="entity">prob1</span> <span class="main">:</span> Rat.rat<span class="main">,</span> <span class="entity">prob2</span> <span class="main">:</span> Rat.rat<span class="main">)</span> <span class="main">(</span><span class="entity">xs</span>::<span class="entity">xss</span><span class="main">)</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prob1</span><span class="main">,</span> <span class="entity">prob2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">prob1</span> + <span class="entity">probability</span> <span class="entity">lott1</span> <span class="entity">xs</span><span class="main">,</span> <span class="entity">prob2</span> + <span class="entity">probability</span> <span class="entity">lott2</span> <span class="entity">xs</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>  
            <span class="entity">prob1</span> &lt;= <span class="entity">prob2</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">go</span> <span class="main">(</span><span class="entity">prob1</span><span class="main">,</span> <span class="entity">prob2</span><span class="main">)</span> <span class="entity">xss</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@</span>0</span></span><span class="main">)</span> <span class="entity">p</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strict_stochastic_dominance</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">lott1</span><span class="main">,</span> <span class="entity">lott2</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">stochastic_dominance</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">lott1</span><span class="main">,</span> <span class="entity">lott2</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span><span class="entity">stochastic_dominance</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">lott2</span><span class="main">,</span> <span class="entity">lott1</span><span class="main">)</span><span class="main">)</span>  

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_support_witness</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">supp</span><span class="main">,</span> <span class="entity">lott</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lott'</span> <span class="main">=</span> <span class="entity">uniform_lottery</span> <span class="entity">supp</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> find_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ps</span><span class="main">)</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">stochastic_dominance</span> <span class="entity">ps</span> <span class="main">(</span><span class="entity">lott</span><span class="main">,</span> <span class="entity">lott'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">p</span>
            |&gt; Option.map fst
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> error <span class="inner_quoted">"Not a proper inefficiency wittnes."</span>
    <span class="main">|</span> SOME <span class="entity">i</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">supp</span><span class="main">,</span> <span class="entity">lott</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/sds_automation.ML">
<div class="head">
<h1>File ‹sds_automation.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_in_set</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cterm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"prove_in_set"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">prove</span> <span class="entity">x</span> <span class="entity">prefix</span> <span class="main">(</span><span class="entity">y</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> aconv <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> fastype_of <span class="entity">x</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cty</span> <span class="main">=</span> Thm.ctyp_of <span class="entity">ctxt</span> <span class="entity">ty</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> insertI1<span class="antiquote">}</span></span></span>
              |&gt; Thm.instantiate' <span class="main">[</span>SOME <span class="entity">cty</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">cterm</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span> <span class="entity">HOLogic.mk_set</span> <span class="entity">ty</span> <span class="entity">xs</span><span class="main">]</span><span class="main">)</span>
              |&gt; fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> 
                 <span class="main">(</span><span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> insertI2<span class="antiquote">}</span></span></span><span class="main">)</span> |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">[</span>SOME <span class="main">(</span><span class="entity">cterm</span> <span class="entity">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="entity">prefix</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="entity">prove</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">prefix</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Set.member<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">xs</span> <span class="main">=&gt;</span>
        <span class="entity">prove</span> <span class="entity">x</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">xs</span> |&gt; <span class="entity">HOLogic.dest_set</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"prove_in_set"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_in_list</span> <span class="entity">ctxt</span> <span class="entity">x</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cterm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove</span> <span class="main">_</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"prove_in_list"</span><span class="main">,</span> <span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">prove</span> <span class="entity">x</span> <span class="entity">prefix</span> <span class="main">(</span><span class="entity">y</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> aconv <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> fastype_of <span class="entity">x</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cty</span> <span class="main">=</span> Thm.ctyp_of <span class="entity">ctxt</span> <span class="entity">ty</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list.set_intros<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>
              |&gt; Thm.instantiate' <span class="main">[</span>SOME <span class="entity">cty</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">cterm</span><span class="main">)</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span> <span class="entity">HOLogic.mk_list</span> <span class="entity">ty</span> <span class="entity">xs</span><span class="main">]</span><span class="main">)</span>
              |&gt; fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> 
                 <span class="main">(</span><span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list.set_intros<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">)</span> |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">[</span>SOME <span class="main">(</span><span class="entity">cterm</span> <span class="entity">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="entity">prefix</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="entity">prove</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">prefix</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">prove</span> <span class="entity">x</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_inverse_permutation_of_list_conv</span> <span class="entity">wf_thm</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"eval_inverse_permutation_of_list_conv"</span><span class="main">,</span> <span class="main">[</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_eq</span> <span class="entity">xs</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xy</span> <span class="main">=</span> <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">prove_in_list</span> <span class="entity">ctxt</span> <span class="entity">xy</span> <span class="main">(</span><span class="entity">HOLogic.dest_list</span> <span class="entity">xs</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_reflection<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> inverse_permutation_of_list_unique<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">wf_thm</span><span class="main">,</span> <span class="entity">thm</span><span class="main">]</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="entity">xs</span> <span class="entity">y</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xs'</span> <span class="main">=</span> <span class="entity">xs</span> |&gt; <span class="entity">HOLogic.dest_list</span> |&gt; map <span class="entity">HOLogic.dest_prod</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> get_first <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">y</span> aconv <span class="entity">y'</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> NONE<span class="main">)</span> <span class="entity">xs'</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span>
        <span class="main">|</span> SOME <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">mk_eq</span> <span class="entity">xs</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> inverse_permutation_of_list<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">xs</span> $ <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">aux</span> <span class="entity">xs</span> <span class="entity">x</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword3"><span class="keyword">open</span></span> Preference_Profiles
<span class="keyword3"><span class="keyword">open</span></span> Randomised_Social_Choice
<span class="keyword3"><span class="keyword">open</span></span> Preference_Profiles_Cmd

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_permutation_term</span> <span class="entity">sigma</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">sigma</span> |&gt; hd |&gt; fst |&gt; fastype_of
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">sigma</span> |&gt; map <span class="entity">HOLogic.mk_prod</span> |&gt; <span class="entity">HOLogic.mk_list</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">altT</span><span class="main">,</span> <span class="entity">altT</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_orbit_intro_thms_single</span> <span class="entity">ctxt</span> <span class="entity">sds_an_thm</span> <span class="main">(</span><span class="entity">p</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span> <span class="entity">sigma</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>wf_raw_thm <span class="main">=</span> <span class="entity">wf_raw_thm</span><span class="main">,</span> def_thm <span class="main">=</span> <span class="entity">def_thm</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cterm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sigma_term</span> <span class="main">=</span> <span class="entity">mk_permutation_term</span> <span class="entity">sigma</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> an_sds_automorphism_aux<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">,</span> <span class="entity">sds_an_thm</span><span class="main">]</span><span class="main">)</span>
              |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">cterm</span><span class="main">)</span> <span class="main">[</span><span class="entity">sigma_term</span><span class="main">,</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_orbit_intro_thms</span> <span class="entity">ctxt</span> <span class="entity">sds_an_thm</span> <span class="main">(</span><span class="entity">p</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>raw <span class="main">=</span> <span class="entity">p_raw</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">p</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">derive_orbit_equations</span> <span class="entity">p_raw</span>
    |&gt; map <span class="main">(</span><span class="entity">prepare_orbit_intro_thms_single</span> <span class="entity">ctxt</span> <span class="entity">sds_an_thm</span> <span class="entity">p</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_agents_alts_term</span> <span class="main">(</span><span class="main">{</span><span class="entity">wf_thm</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">agents</span> :: <span class="entity">alts</span> :: <span class="main">_</span> <span class="main">=</span> <span class="entity">wf_thm</span> |&gt; Thm.concl_of |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; strip_comb |&gt; snd
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">agents</span><span class="main">,</span> <span class="entity">alts</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_wf_thm</span> <span class="main">=</span>
  Thm.concl_of #&gt; <span class="entity">HOLogic.dest_Trueprop</span> #&gt; Term.dest_comb #&gt; snd

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_derive_orbit_equations</span> <span class="entity">lthy</span> <span class="entity">sds_an_thm</span> <span class="entity">ps</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy0</span> <span class="main">=</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infos</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">get_info</span> <span class="entity">p</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">altT</span><span class="main">,</span> <span class="entity">agentT</span><span class="main">)</span> <span class="main">=</span> <span class="entity">infos</span> |&gt; hd |&gt; <span class="main">#</span>raw |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">altT</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">agentT</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sdsT</span> <span class="main">=</span> <span class="entity">sdsT</span> <span class="entity">agentT</span> <span class="entity">altT</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sds_an_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">sds_an_thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">sds_an_thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">dest_wf_thm</span> <span class="entity">sds_an_thm</span><span class="main">,</span> <span class="entity">sds_an_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">[</span><span class="entity">sds</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Variable.variant_fixes <span class="main">[</span><span class="inner_quoted">"sds"</span><span class="main">]</span> <span class="entity">lthy0</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sdsT</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> Variable.declare_term <span class="entity">sds</span> <span class="entity">lthy</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">agents_term</span><span class="main">,</span> <span class="entity">alts_term</span><span class="main">)</span> <span class="main">=</span> <span class="entity">get_agents_alts_term</span> <span class="main">(</span>hd <span class="entity">infos</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds_an_const</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> an_sds<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">HOLogic.mk_setT</span> <span class="entity">agentT</span> --&gt; 
              <span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span> --&gt; <span class="entity">sdsT</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds_an_prop</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">sds_an_const</span> $ <span class="entity">agents_term</span> $ <span class="entity">alts_term</span> $ <span class="entity">sds</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">[</span><span class="entity">sds_an_thm</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Assumption.add_assumes <span class="main">[</span>Thm.cterm_of <span class="entity">lthy</span> <span class="entity">sds_an_prop</span><span class="main">]</span> <span class="entity">lthy</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sds_an_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intros</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">prepare_orbit_intro_thms</span> <span class="entity">lthy</span> <span class="entity">sds_an_thm</span><span class="main">)</span> <span class="entity">infos</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Thm.concl_of <span class="entity">x</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">intros</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bindings</span> <span class="main">=</span> <span class="entity">infos</span> |&gt; map 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">info</span> <span class="main">=&gt;</span> Binding.qualify true <span class="main">(</span>Binding.name_of <span class="main">(</span><span class="main">#</span>binding <span class="entity">info</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Binding.name <span class="inner_quoted">"orbits"</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">lthy</span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> multiset_add_ac insert_commute<span class="antiquote">}</span></span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">before_proof</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
          ALLGOALS <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span>List.concat <span class="entity">intros</span><span class="main">)</span><span class="main">)</span>
          THEN distinct_subgoals_tac
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">Method.Basic</span> <span class="main">(</span><span class="entity">SIMPLE_METHOD</span> o <span class="entity">tac</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">afterqed</span> <span class="main">(</span><span class="entity">thmss</span> <span class="main">:</span> thm list list<span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss</span> <span class="main">=</span> burrow <span class="main">(</span>Proof_Context.export <span class="entity">lthy</span> <span class="entity">lthy0</span><span class="main">)</span> <span class="entity">thmss</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss_aux</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">bdg</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">bdg</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">thms</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">bindings</span> <span class="entity">thmss</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Local_Theory.notes <span class="entity">thmss_aux</span> <span class="entity">lthy0</span>
        |&gt; snd
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Proof.theorem</span> NONE <span class="entity">afterqed</span> <span class="entity">goals</span> <span class="entity">lthy</span>
    |&gt; <span class="entity">Proof.refine_singleton</span> <span class="entity">before_proof</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">derive_orbit_equations_cmd</span> <span class="entity">wf_thm</span> <span class="entity">ps</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="entity">gen_derive_orbit_equations</span> <span class="entity">lthy</span> <span class="entity">wf_thm</span> <span class="main">(</span>map <span class="main">(</span>Syntax.read_term <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ps</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">optional_thm_parser</span> <span class="main">=</span> 
  Scan.option <span class="main">(</span>Args.parens Parse.thm<span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">optional_thms_parser</span> <span class="main">=</span> 
  Scan.option <span class="main">(</span>Args.parens Parse.thms1<span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">derive_orbit_equations</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"automatically derives the orbit equations for preference profiles"</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">optional_thm_parser</span> -- Scan.repeat1 Parse.term<span class="main">)</span> &gt;&gt; 
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">wf_thm</span><span class="main">,</span> <span class="entity">ps</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wf_thm</span> <span class="main">=</span> Option.map <span class="main">(</span>hd o Proof_Context.get_fact <span class="entity">ctxt</span> o fst<span class="main">)</span> <span class="entity">wf_thm</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">derive_orbit_equations_cmd</span> <span class="entity">wf_thm</span> <span class="entity">ps</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_prepare_ex_post_conditions</span> <span class="entity">find_losers</span> <span class="entity">sds</span> <span class="main">(</span><span class="entity">info</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>raw <span class="main">=</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">info</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">losers</span> <span class="main">=</span> <span class="entity">find_losers</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cterm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ex_post_efficient_aux<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">]</span><span class="main">)</span>
      |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">cterm</span><span class="main">)</span> <span class="main">[</span><span class="entity">i</span><span class="main">,</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">sds</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    map <span class="entity">prep</span> <span class="entity">losers</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prepare_find_ex_post_conditions</span> <span class="main">=</span> 
  <span class="entity">gen_prepare_ex_post_conditions</span> <span class="entity">pareto_losers</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_ex_post_conditions</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="entity">gen_prepare_ex_post_conditions</span> 
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p'</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p'</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">find_pareto_witness</span> <span class="entity">p</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> NONE<span class="main">)</span> <span class="entity">xs</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_prepare_sdeff_conditions</span> <span class="entity">find_supports</span> <span class="entity">sds</span> <span class="main">(</span><span class="entity">info</span> <span class="main">:</span> <span class="entity">info</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>raw <span class="main">=</span> <span class="entity">p</span><span class="main">,</span> <span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">info</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">altT</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supports</span> <span class="main">=</span> <span class="entity">find_supports</span> <span class="entity">p</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cterm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep</span> <span class="main">(</span><span class="entity">supp</span><span class="main">,</span><span class="entity">lott</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supp_list</span> <span class="main">=</span> <span class="entity">HOLogic.mk_list</span> <span class="entity">altT</span> <span class="entity">supp</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supp_set</span> <span class="main">=</span> <span class="entity">HOLogic.mk_set</span> <span class="entity">altT</span> <span class="entity">supp</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lott</span> <span class="main">=</span> 
          <span class="entity">lott</span>
          |&gt; map <span class="main">(</span><span class="entity">HOLogic.mk_prod</span> o apsnd <span class="main">(</span><span class="entity">Rat_Utils.mk_rat_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">Real.real</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
          |&gt; <span class="entity">HOLogic.mk_list</span> <span class="main">(</span><span class="entity">HOLogic.mk_prodT</span> <span class="main">(</span><span class="entity">altT</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">Real.real</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> SD_inefficient_support_aux<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">wf_raw_thm</span><span class="main">,</span> <span class="entity">def_thm</span><span class="main">]</span><span class="main">)</span>
        |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o <span class="entity">cterm</span><span class="main">)</span> <span class="main">[</span><span class="entity">supp_list</span><span class="main">,</span> <span class="entity">supp_set</span><span class="main">,</span> <span class="entity">lott</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">sds</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    map <span class="entity">prep</span> <span class="entity">supports</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prepare_find_sdeff_conditions</span> <span class="main">=</span> 
  <span class="entity">gen_prepare_sdeff_conditions</span> <span class="entity">find_minimal_inefficient_supports</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_sdeff_conditions_from_wits</span> <span class="entity">ss</span> <span class="main">=</span> 
  <span class="entity">gen_prepare_sdeff_conditions</span> 
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> map_filter <span class="main">(</span>
      <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p'</span><span class="main">,</span> <span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">p'</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="entity">mk_support_witness</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span> <span class="entity">ss</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_derive_support_conditions</span> <span class="entity">providers</span> <span class="entity">sds_thms</span> <span class="entity">ps</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy0</span> <span class="main">=</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infos</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">get_info</span> <span class="entity">p</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">altT</span><span class="main">,</span> <span class="entity">agentT</span><span class="main">)</span> <span class="main">=</span> <span class="entity">infos</span> |&gt; hd |&gt; <span class="main">#</span>raw |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">altT</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">agentT</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sdsT</span> <span class="main">=</span> <span class="entity">sdsT</span> <span class="entity">agentT</span> <span class="entity">altT</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sds_thms</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">sds_thms</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">sds_thms</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">dest_wf_thm</span> <span class="main">(</span>hd <span class="entity">sds_thms</span><span class="main">)</span><span class="main">,</span> <span class="entity">sds_thms</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">[</span><span class="entity">sds</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Variable.variant_fixes <span class="main">[</span><span class="inner_quoted">"sds"</span><span class="main">]</span> <span class="entity">lthy0</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sdsT</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> Variable.declare_term <span class="entity">sds</span> <span class="entity">lthy</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intros</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">info</span> <span class="main">=&gt;</span> List.concat <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span> <span class="entity">sds</span> <span class="entity">info</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">providers</span><span class="main">)</span><span class="main">)</span> <span class="entity">infos</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Thm.concl_of <span class="entity">x</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">intros</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bindings</span> <span class="main">=</span> <span class="entity">infos</span> |&gt; map 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">info</span> <span class="main">=&gt;</span> Binding.qualify true <span class="main">(</span>Binding.name_of <span class="main">(</span><span class="main">#</span>binding <span class="entity">info</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Binding.name <span class="inner_quoted">"support"</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">before_proof</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
          ALLGOALS <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span>List.concat <span class="entity">intros</span><span class="main">)</span><span class="main">)</span>
          THEN distinct_subgoals_tac
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">Method.Basic</span> <span class="main">(</span><span class="entity">SIMPLE_METHOD</span> o <span class="entity">tac</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_first_default</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">default</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> get_first <span class="entity">f</span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">default</span>
      <span class="main">|</span> SOME <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">y</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">postproc</span> <span class="entity">lthy</span> <span class="entity">thm</span> <span class="main">=</span>
      <span class="entity">thm</span> 
        |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HOL.mp<span class="antiquote">}</span></span></span><span class="main">)</span>
        |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">get_first_default</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm'</span> <span class="main">=&gt;</span> try <span class="main">(</span>Thm.implies_elim <span class="entity">thm</span><span class="main">)</span> <span class="entity">thm'</span><span class="main">)</span> <span class="entity">sds_thms</span> <span class="entity">thm</span><span class="main">)</span>
        |&gt; Local_Defs.unfold <span class="entity">lthy</span> 
             <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_reflection<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Set.bex_simps disj_False_right<span class="antiquote">}</span></span></span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">afterqed</span> <span class="main">(</span><span class="entity">thmss</span> <span class="main">:</span> thm list list<span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss</span> <span class="main">=</span> 
          <span class="entity">thmss</span> |&gt; burrow <span class="main">(</span>Proof_Context.export <span class="entity">lthy</span> <span class="entity">lthy0</span> o map <span class="main">(</span><span class="entity">postproc</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss_aux</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">bdg</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">bdg</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">thms</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">bindings</span> <span class="entity">thmss</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Local_Theory.notes <span class="entity">thmss_aux</span> <span class="entity">lthy0</span>
        |&gt; snd
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Proof.theorem</span> NONE <span class="entity">afterqed</span> <span class="entity">goals</span> <span class="entity">lthy</span>
    |&gt; <span class="entity">Proof.refine_singleton</span> <span class="entity">before_proof</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_derive_support_conditions_cmd</span> <span class="entity">providers</span> <span class="entity">wf_thms</span> <span class="entity">ts</span> <span class="entity">lthy</span> <span class="main">=</span> 
  <span class="entity">gen_derive_support_conditions</span> <span class="entity">providers</span> <span class="entity">wf_thms</span> <span class="main">(</span>map <span class="main">(</span>Syntax.read_term <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ts</span><span class="main">)</span> <span class="entity">lthy</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">derive_support_conditions_cmd</span> <span class="main">=</span> 
  <span class="entity">gen_derive_support_conditions_cmd</span> <span class="main">[</span><span class="entity">prepare_find_ex_post_conditions</span><span class="main">,</span> <span class="entity">prepare_find_sdeff_conditions</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">derive_ex_post_conditions_cmd</span> <span class="main">=</span>
  <span class="entity">gen_derive_support_conditions_cmd</span> <span class="main">[</span><span class="entity">prepare_find_ex_post_conditions</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_inefficient_supports</span> <span class="entity">p</span> <span class="main">=</span>
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">,</span> NONE<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">pareto_losers</span> <span class="entity">p</span><span class="main">)</span> @
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> SOME <span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">find_minimal_inefficient_supports</span> <span class="entity">p</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_sd_inefficient_supports_cmd</span> <span class="entity">ts</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> <span class="entity">ts</span> |&gt; map <span class="main">(</span>Syntax.read_term <span class="entity">lthy</span> #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">get_info</span> <span class="entity">p</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_lott</span> <span class="entity">lott</span> <span class="main">=</span> Pretty.block <span class="main">[</span>Pretty.str <span class="inner_quoted">"witness:"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
      Pretty.list <span class="inner_quoted">"["</span> <span class="inner_quoted">"]"</span> 
        <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> Pretty.block 
          <span class="main">[</span>Syntax.pretty_term <span class="entity">lthy</span> <span class="entity">x</span><span class="main">,</span> Pretty.str <span class="inner_quoted">":"</span><span class="main">,</span>
            Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> Pretty.str <span class="main">(</span>Rat.string_of_rat <span class="entity">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="entity">lott</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="entity">supp</span><span class="main">,</span> <span class="entity">lott</span><span class="main">)</span> <span class="main">=</span>
      Pretty.block <span class="main">(</span><span class="main">[</span>
        Syntax.pretty_term <span class="entity">lthy</span> <span class="entity">p</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span>
        Pretty.list <span class="inner_quoted">"["</span> <span class="inner_quoted">"]"</span> <span class="main">(</span>map <span class="main">(</span>Syntax.pretty_term <span class="entity">lthy</span><span class="main">)</span> <span class="entity">supp</span><span class="main">)</span><span class="main">]</span> @
        the_default <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Option.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">[</span>Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">pretty_lott</span> <span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="entity">lott</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">#</span>term <span class="entity">p</span><span class="main">,</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="entity">find_inefficient_supports</span> <span class="main">(</span><span class="main">#</span>raw <span class="entity">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ps</span>
    |&gt; map <span class="main">(</span>single o <span class="entity">pretty</span><span class="main">)</span>
    |&gt; Library.separate <span class="main">[</span>Pretty.keyword2 <span class="inner_quoted">" and"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">]</span>
    |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> <span class="main">[</span>Pretty.keyword1 <span class="inner_quoted">"prove_inefficient_supports"</span><span class="main">,</span> Pretty.fbrk<span class="main">]</span> :: <span class="entity">xs</span><span class="main">)</span>
    |&gt; flat
    |&gt; Pretty.block
    |&gt; Pretty.string_of
    |&gt; Output.information o Active.sendback_markup_command
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_sd_inefficient_supports_cmd</span> <span class="entity">thm</span> <span class="entity">xs</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map <span class="main">(</span>fst o fst<span class="main">)</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> Syntax.read_term <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts'</span> <span class="main">=</span> map <span class="entity">read</span> <span class="entity">ts</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">#</span>raw <span class="main">(</span><span class="entity">get_info</span> <span class="entity">t</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="entity">ts'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">supps</span> <span class="main">=</span> map <span class="main">(</span>map <span class="entity">read</span> o snd o fst<span class="main">)</span> <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lotts</span> <span class="main">=</span> map <span class="main">(</span>Option.map <span class="main">(</span>map <span class="main">(</span>apfst <span class="entity">read</span><span class="main">)</span><span class="main">)</span> o snd<span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">gen_derive_support_conditions_cmd</span> 
      <span class="main">[</span><span class="entity">prepare_sdeff_conditions_from_wits</span> 
         <span class="main">(</span>map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> NONE <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span><span class="main">,</span><span class="entity">z</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">,</span><span class="entity">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">ps</span> ~~ <span class="entity">supps</span> ~~ <span class="entity">lotts</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       <span class="entity">prepare_ex_post_conditions</span> 
         <span class="main">(</span>map_filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span> <span class="main">(</span><span class="entity">ps</span> ~~ <span class="entity">supps</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="entity">thm</span> <span class="entity">ts</span> <span class="entity">lthy</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">derive_support_conditions</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"automatically derive ex-post- and SD-Efficiency conditions for the support of preference profiles"</span>
    <span class="main">(</span><span class="entity">optional_thms_parser</span> -- Scan.repeat1 Parse.term &gt;&gt; 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">thms</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
         <span class="keyword2"><span class="keyword">let</span></span>
           <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> Option.map <span class="main">(</span>maps <span class="main">(</span>Proof_Context.get_fact <span class="entity">ctxt</span> o fst<span class="main">)</span><span class="main">)</span> <span class="entity">thms</span>
         <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">derive_support_conditions_cmd</span> <span class="entity">thms</span> <span class="entity">ts</span> <span class="entity">ctxt</span>
         <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">derive_ex_post_conditions</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"automatically derive zero-ness conditions for the Pareto losers"</span>
    <span class="main">(</span><span class="entity">optional_thm_parser</span> -- Scan.repeat1 Parse.term &gt;&gt; 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
         <span class="keyword2"><span class="keyword">let</span></span>
           <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Option.map <span class="main">(</span>Proof_Context.get_fact <span class="entity">ctxt</span> o fst<span class="main">)</span> <span class="entity">thm</span>
         <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">derive_ex_post_conditions_cmd</span> <span class="entity">thm</span> <span class="entity">ts</span> <span class="entity">ctxt</span>
         <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_rat</span> <span class="main">=</span>
  <span class="main">(</span>Parse.int -- Scan.optional <span class="main">(</span>Args.$$$ <span class="inner_quoted">"/"</span> |-- Parse.int<span class="main">)</span> <span class="inner_numeral">1</span><span class="main">)</span> &gt;&gt; Rat.make

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_support</span> <span class="main">=</span> Args.bracks <span class="main">(</span>Parse.list1 Parse.term<span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_lottery</span> <span class="main">=</span> Args.bracks <span class="main">(</span>Parse.list1 <span class="main">(</span>Parse.term --| Args.colon -- <span class="entity">parse_rat</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">find_inefficient_supports</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"automatically find SD-inefficient supports using linear programming"</span>
    <span class="main">(</span>Scan.repeat1 Parse.term &gt;&gt; <span class="comment1">(* TODO: is local_theory the right approach here? *)</span>
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ts</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
         <span class="keyword2"><span class="keyword">let</span></span>
           <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">find_sd_inefficient_supports_cmd</span> <span class="entity">ts</span> <span class="entity">ctxt</span>
         <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">ctxt</span>
         <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">prove_inefficient_supports</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"prove ex-post- or SD-inefficient supports (using witness lotteries for the latter)"</span>
    <span class="main">(</span><span class="entity">optional_thms_parser</span> -- Parse.and_list1 <span class="main">(</span>Parse.term -- <span class="entity">parse_support</span> -- 
       Scan.option <span class="main">(</span>Args.$$$ <span class="inner_quoted">"witness"</span> |-- Args.colon |-- <span class="entity">parse_lottery</span><span class="main">)</span><span class="main">)</span> &gt;&gt; 
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">thms</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
         <span class="keyword2"><span class="keyword">let</span></span>
           <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> Option.map <span class="main">(</span>maps <span class="main">(</span>Proof_Context.get_fact <span class="entity">ctxt</span> o fst<span class="main">)</span><span class="main">)</span> <span class="entity">thms</span>
         <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">prove_sd_inefficient_supports_cmd</span> <span class="entity">thms</span> <span class="entity">ts</span> <span class="entity">ctxt</span>
         <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>




<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pref_classes</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span> 
  <span class="main">|</span> <span class="entity">pref_classes</span> <span class="main">(</span><span class="entity">xs</span> :: <span class="entity">xss</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">_</span> <span class="entity">acc2</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc2</span>
        <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc1</span> <span class="entity">acc2</span> <span class="main">(</span><span class="entity">xs</span> :: <span class="entity">xss</span><span class="main">)</span> <span class="main">=</span> <span class="entity">go</span> <span class="main">(</span><span class="entity">xs</span> @ <span class="entity">acc1</span><span class="main">)</span> <span class="main">(</span>rev <span class="entity">acc1</span> :: <span class="entity">acc2</span><span class="main">)</span> <span class="entity">xss</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      rev <span class="main">(</span><span class="entity">go</span> <span class="entity">xs</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xss</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">combine_all</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> 
          <span class="entity">go</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> @ map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span> @ <span class="entity">acc</span><span class="main">)</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">go</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prepare_strategyproofness_intro_thms</span> <span class="entity">ctxt</span> <span class="entity">dist_limit</span> <span class="entity">sds_san_thm</span> <span class="main">(</span><span class="entity">ps</span> <span class="main">:</span> <span class="entity">info</span> list<span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">altT</span> <span class="main">=</span> <span class="entity">ps</span> |&gt; hd |&gt; <span class="main">#</span>raw |&gt; <span class="entity">altT</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">manipulations</span> <span class="main">=</span> 
      <span class="entity">combine_all</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">,</span> <span class="entity">find_manipulations</span> <span class="main">(</span><span class="main">#</span>raw <span class="entity">p1</span><span class="main">,</span> <span class="main">#</span>raw <span class="entity">p2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">manipulations</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">dist_limit</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">manipulations</span>
      <span class="main">|</span> SOME <span class="entity">l</span> <span class="main">=&gt;</span>
          map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">,</span> <span class="entity">ms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">,</span> filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">#</span><span class="inner_numeral">3</span> <span class="entity">x</span> &lt;= <span class="entity">l</span><span class="main">)</span> <span class="entity">ms</span><span class="main">)</span><span class="main">)</span> <span class="entity">manipulations</span>
    <span class="comment1">(* For Debugging/extracting witnesses only *)</span>
<span class="comment1">(*    val pretty_term_list = map (Pretty.quote o Syntax.pretty_term ctxt) #&gt; Pretty.list "[" "]"
    val pretty_perm = 
      map (fn (a,b) =&gt; Pretty.block [Pretty.str "(", Pretty.quote (Syntax.pretty_term ctxt a), 
        Pretty.str ",", Pretty.quote (Syntax.pretty_term ctxt b), Pretty.str ")"])
      #&gt; Pretty.list "[" "]"
    val foo =
      manipulations |&gt; map (fn (p1 : info, p2 : info, ms) =&gt;
        ms 
        |&gt; map (fn (i, j, _, sigma) =&gt;
          [Pretty.str "(", Binding.pretty (#binding p1), Pretty.str ",",
           Binding.pretty (#binding p2), Pretty.str ",",
           Pretty.quote (Syntax.pretty_term ctxt i), Pretty.str ",",
           Pretty.list "[" "]" (map pretty_term_list (the (AList.lookup op aconv (#raw p1) i))), Pretty.str ",",
           Pretty.list "[" "]" (map pretty_term_list (
            map (map (apply_reverse_permutation op aconv sigma)) (the (AList.lookup op aconv (#raw p2) j)))), Pretty.str ",",
           pretty_perm sigma, Pretty.str ")"]
          |&gt; Pretty.block
          ))
        |&gt; flat |&gt; Pretty.list "[" "]" |&gt; Pretty.writeln
*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_binding</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span> <span class="main">=</span>
      Binding.qualify true 
        <span class="main">(</span>Binding.name_of <span class="main">(</span><span class="main">#</span>binding <span class="entity">p1</span><span class="main">)</span> ^ <span class="inner_quoted">"_"</span> ^ Binding.name_of <span class="main">(</span><span class="main">#</span>binding <span class="entity">p2</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>Binding.name <span class="inner_quoted">"strategyproofness"</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_intro</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">sigma</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>wf_raw_thm <span class="main">=</span> <span class="entity">wf_raw_thm1</span><span class="main">,</span> def_thm <span class="main">=</span> <span class="entity">def_thm1</span><span class="main">,</span> raw <span class="main">=</span> <span class="entity">raw1</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">p1</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>wf_raw_thm <span class="main">=</span> <span class="entity">wf_raw_thm2</span><span class="main">,</span> def_thm <span class="main">=</span> <span class="entity">def_thm2</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">p2</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sigma'</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">a</span><span class="main">)</span><span class="main">)</span> <span class="entity">sigma</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> AList.lookup <span class="keyword1"><span class="keyword">op</span></span> aconv <span class="entity">raw1</span> <span class="entity">i</span> |&gt; the |&gt; <span class="entity">pref_classes</span>
                 |&gt; map <span class="main">(</span><span class="entity">HOLogic.mk_list</span> <span class="entity">altT</span><span class="main">)</span> 
                 |&gt; <span class="entity">HOLogic.mk_set</span> <span class="main">(</span><span class="entity">HOLogic.listT</span> <span class="entity">altT</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">[</span><span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="entity">mk_permutation_term</span> <span class="entity">sigma'</span><span class="main">,</span> <span class="entity">ps</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> strategyproof_aux'<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">wf_raw_thm1</span><span class="main">,</span> <span class="entity">def_thm1</span><span class="main">,</span> <span class="entity">wf_raw_thm2</span><span class="main">,</span> <span class="entity">def_thm2</span><span class="main">,</span> <span class="entity">sds_san_thm</span><span class="main">]</span><span class="main">)</span>
          |&gt; Thm.instantiate' <span class="main">[</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>SOME o Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">insts</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">mk_binding</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="entity">mk_intro</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="entity">manipulations</span>
      <span class="main">:</span> <span class="main">(</span>binding * thm list<span class="main">)</span> list
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_derive_strategyproofness_conditions</span> <span class="entity">lthy</span> <span class="entity">dist_limit</span> <span class="entity">sds_san_thm</span> <span class="entity">ps</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy0</span> <span class="main">=</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infos</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">get_info</span> <span class="entity">p</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">altT</span><span class="main">,</span> <span class="entity">agentT</span><span class="main">)</span> <span class="main">=</span> <span class="entity">infos</span> |&gt; hd |&gt; <span class="main">#</span>raw |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">altT</span> <span class="entity">x</span><span class="main">,</span> <span class="entity">agentT</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sdsT</span> <span class="main">=</span> <span class="entity">sdsT</span> <span class="entity">agentT</span> <span class="entity">altT</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sds_san_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">sds_san_thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">sds_san_thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">dest_wf_thm</span> <span class="entity">sds_san_thm</span><span class="main">,</span> <span class="entity">sds_san_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> 
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">[</span><span class="entity">sds</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Variable.variant_fixes <span class="main">[</span><span class="inner_quoted">"sds"</span><span class="main">]</span> <span class="entity">lthy0</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sdsT</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> Variable.declare_term <span class="entity">sds</span> <span class="entity">lthy</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">agents_term</span><span class="main">,</span> <span class="entity">alts_term</span><span class="main">)</span> <span class="main">=</span> <span class="entity">get_agents_alts_term</span> <span class="main">(</span>hd <span class="entity">infos</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds_san_const</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> strategyproof_an_sds<span class="antiquote">}</span></span><span class="main">,</span>
               <span class="entity">HOLogic.mk_setT</span> <span class="entity">agentT</span> --&gt; <span class="entity">HOLogic.mk_setT</span> <span class="entity">altT</span> --&gt; <span class="entity">sdsT</span> --&gt; <span class="entity">HOLogic.boolT</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sds_san_prop</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">sds_san_const</span> $ <span class="entity">agents_term</span> $ <span class="entity">alts_term</span> $ <span class="entity">sds</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">[</span><span class="entity">sds_san_thm</span><span class="main">]</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Assumption.add_assumes <span class="main">[</span>Thm.cterm_of <span class="entity">lthy</span> <span class="entity">sds_san_prop</span><span class="main">]</span> <span class="entity">lthy</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="entity">sds</span><span class="main">,</span> <span class="entity">sds_san_thm</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intros</span> <span class="main">=</span> <span class="entity">prepare_strategyproofness_intro_thms</span> <span class="entity">lthy</span> <span class="entity">dist_limit</span> <span class="entity">sds_san_thm</span> <span class="entity">infos</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> map <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span>Thm.concl_of <span class="entity">x</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> o snd<span class="main">)</span> <span class="entity">intros</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bindings</span> <span class="main">=</span> map fst <span class="entity">intros</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">lthy</span> addsimps 
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> multiset_add_ac insert_commute insert_eq_iff multiset_Diff_single_normalize<span class="antiquote">}</span></span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">before_proof</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span> 
          ALLGOALS <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span>List.concat <span class="main">(</span>map snd <span class="entity">intros</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          THEN distinct_subgoals_tac
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">Method.Basic</span> <span class="main">(</span><span class="entity">SIMPLE_METHOD</span> o <span class="entity">tac</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">postproc</span> <span class="entity">lthy</span> <span class="entity">thm</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">perm_thm</span> <span class="main">=</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HOL.conjunct1<span class="antiquote">}</span></span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HOL.conjunct2<span class="antiquote">}</span></span></span><span class="main">)</span>
        |&gt; Local_Defs.unfold <span class="entity">lthy</span> 
           <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Set.bex_simps Set.ball_simps HOL.simp_thms list.map sum_list.Cons sum_list.Nil
                  add_0_right less_or_eq_real<span class="antiquote">}</span></span></span>
        |&gt; Conv.fconv_rule <span class="main">(</span>Conv.top_sweep_conv 
             <span class="main">(</span><span class="entity">eval_inverse_permutation_of_list_conv</span> <span class="entity">perm_thm</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">afterqed</span> <span class="main">(</span><span class="entity">thmss</span> <span class="main">:</span> thm list list<span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss</span> <span class="main">=</span> burrow <span class="main">(</span>Proof_Context.export <span class="entity">lthy</span> <span class="entity">lthy0</span> o map <span class="main">(</span><span class="entity">postproc</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="entity">thmss</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmss_aux</span> <span class="main">=</span> map2 <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">bdg</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">bdg</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="entity">thms</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">bindings</span> <span class="entity">thmss</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Local_Theory.notes <span class="entity">thmss_aux</span> <span class="entity">lthy0</span>
        |&gt; snd
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Proof.theorem</span> NONE <span class="entity">afterqed</span> <span class="entity">goals</span> <span class="entity">lthy</span>
    |&gt; <span class="entity">Proof.refine_singleton</span> <span class="entity">before_proof</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">derive_strategyproofness_conditions_cmd</span> <span class="entity">dist_limit</span> <span class="entity">sds_san_thm</span> <span class="entity">ps</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="entity">gen_derive_strategyproofness_conditions</span> <span class="entity">lthy</span> <span class="entity">dist_limit</span> <span class="entity">sds_san_thm</span> <span class="main">(</span>map <span class="main">(</span>Syntax.read_term <span class="entity">lthy</span><span class="main">)</span> <span class="entity">ps</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> <span class="keyword1">derive_strategyproofness_conditions</span><span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"automatically derives the conditions arising from strategy-proofness for preference profiles"</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">optional_thm_parser</span> -- Scan.option <span class="main">(</span>Args.$$$ <span class="inner_quoted">"distance"</span> |-- Args.colon |-- Parse.int<span class="main">)</span> 
        -- Scan.repeat1 Parse.term<span class="main">)</span> &gt;&gt; 
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">wf_thm</span><span class="main">,</span> <span class="entity">dist_limit</span><span class="main">)</span><span class="main">,</span> <span class="entity">ps</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> 
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wf_thm</span> <span class="main">=</span> Option.map <span class="main">(</span>hd o Proof_Context.get_fact <span class="entity">ctxt</span> o fst<span class="main">)</span> <span class="entity">wf_thm</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">derive_strategyproofness_conditions_cmd</span> <span class="entity">dist_limit</span> <span class="entity">wf_thm</span> <span class="entity">ps</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>