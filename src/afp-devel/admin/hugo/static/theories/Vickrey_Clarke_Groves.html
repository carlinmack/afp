<div id="SetUtils">
<div class="head">
<h1>Theory SetUtils</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional material that we would have expected in Set.thy›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SetUtils
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An inference (introduction) rule that combines <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> equalityI<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> subsetI<span class="antiquote"><span class="antiquote">}</span></span></span></span> to a single step›</span></span>
<span class="keyword1" id="SetUtils-equalitySubsetI"><span class="command">lemma</span></span> equalitySubsetI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trivial sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A trivial set (i.e. singleton or empty), as in Mizar›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trivial</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trivial</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊆</span> <span class="main">{</span>the_elem <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty set is trivial.›</span></span>
<span class="keyword1" id="SetUtils-trivial_empty"><span class="command">lemma</span></span> trivial_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> trivial_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> empty_subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A singleton set is trivial.›</span></span>
<span class="keyword1" id="SetUtils-trivial_singleton"><span class="command">lemma</span></span> trivial_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> trivial_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a trivial set has a singleton subset, the latter is unique.›</span></span>
<span class="keyword1" id="SetUtils-singleton_sub_trivial_uniq"><span class="command">lemma</span></span> singleton_sub_trivial_uniq<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">x</span> <span class="free">X</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> the_elem <span class="free">X</span>"</span></span>
<span class="comment1">(* CL: The following takes 16 ms in Isabelle2013-1-RC1:
   by (metis assms(1) assms(2) insert_not_empty insert_subset subset_empty subset_insert trivial_def trivial_imp_no_distinct) *)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> trivial_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any subset of a trivial set is trivial.›</span></span>

<span class="keyword1" id="SetUtils-trivial_subset"><span class="command">lemma</span></span> trivial_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
                      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span>
<span class="comment1">(* CL: The following takes 36 ms in Isabelle2013-1-RC1:
   by (metis assms(1) assms(2) equals0D no_distinct_imp_trivial subsetI subset_antisym subset_singletonD trivial_cases) *)</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> trivial_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> subset_empty subset_insertI2 subset_singletonD<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are no two different elements in a trivial set.›</span></span>

<span class="keyword1" id="SetUtils-trivial_imp_no_distinct"><span class="command">lemma</span></span> trivial_imp_no_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> triv<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="comment1">(* CL: The following takes 17 ms in Isabelle2013-1-RC1: *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_subsetI insert_subset singleton_sub_trivial_uniq<span class="main">)</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The image of a set under a function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹an equivalent notation for the image of a set, using set comprehension›</span></span>
<span class="keyword1" id="SetUtils-image_Collect_mem"><span class="command">lemma</span></span> image_Collect_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big Union›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An element is in the union of a family of sets if it is in one of the family's member sets.›</span></span>

<span class="keyword1" id="SetUtils-Union_member"><span class="command">lemma</span></span> Union_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="free">F</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1" id="SetUtils-trivial_subset_non_empty"><span class="command">lemma</span></span> trivial_subset_non_empty<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trivial_def assms in_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="SetUtils-trivial_implies_finite"><span class="command">lemma</span></span> trivial_implies_finite<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite.simps subset_singletonD trivial_def<span class="main">)</span>
<span class="comment1">(* finite.simps trivial_cases by metis *)</span>

<span class="keyword1" id="SetUtils-lm01"><span class="command">lemma</span></span> lm01<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
              <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="main">(</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">)</span> <span class="main">&amp;</span> card <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trivial_def assms One_nat_def card_cartesian_product card.empty card_insert_disjoint
            empty_iff finite.emptyI le0 trivial_implies_finite order_refl subset_singletonD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SetUtils-lm02"><span class="command">lemma</span></span> lm02<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"trivial <span class="free">X</span><span class="main">=</span><span class="main">(</span>card <span class="free">X</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms One_nat_def card.empty card_insert_if card_mono card_seteq empty_iff 
            empty_subsetI finite.cases finite.emptyI finite_insert insert_mono 
            trivial_def trivial_singleton
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SetUtils-lm03"><span class="command">lemma</span></span> lm03<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl the_elem_eq trivial_def<span class="main">)</span>

<span class="keyword1" id="SetUtils-lm04"><span class="command">lemma</span></span> lm04<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">X</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> singleton_sub_trivial_uniq assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_antisym trivial_def<span class="main">)</span>

<span class="keyword1" id="SetUtils-lm05"><span class="command">lemma</span></span> lm05<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> trivial <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">T</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">-</span> <span class="free">T</span>  <span class="main">≠</span>  <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff empty_iff subsetI trivial_subset<span class="main">)</span>

<span class="keyword1" id="SetUtils-lm06"><span class="command">lemma</span></span> lm06<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>  <span class="main">&amp;</span>  card <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
              <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> trivial_def <span class="keyword1"><span class="command">using</span></span> trivial_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_cartesian_product lm02<span class="main">)</span>

<span class="keyword1" id="SetUtils-lm07"><span class="command">lemma</span></span> lm07<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finite <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">&amp;</span> card <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lm01 lm06 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SetUtils-trivial_empty_or_singleton"><span class="command">lemma</span></span> trivial_empty_or_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span>the_elem <span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_singletonD trivial_def trivial_empty trivial_singleton<span class="main">)</span>

<span class="keyword1" id="SetUtils-trivial_cartesian"><span class="command">lemma</span></span> trivial_cartesian<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">Y</span>"</span></span> 
            <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms lm07 One_nat_def Sigma_empty1 Sigma_empty2 card.empty card_insert_if
            finite_SigmaI trivial_implies_finite nat_1_eq_mult_iff order_refl subset_singletonD trivial_def trivial_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SetUtils-trivial_same"><span class="command">lemma</span></span> trivial_same<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">=</span> <span class="bound">x2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trivial_def trivial_imp_no_distinct ex_in_conv insertCI subsetI subset_singletonD
            trivial_singleton 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SetUtils-lm08"><span class="command">lemma</span></span> lm08<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pow <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{}</span><span class="main">,</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 
              <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> trivial_same <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SetUtils-lm09"><span class="command">lemma</span></span> lm09<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> 
              <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pow <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{}</span><span class="main">,</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms trivial_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="SetUtils-lm10"><span class="command">lemma</span></span> lm10<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>Pow <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{}</span><span class="main">,</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lm08 lm09 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="SetUtils-lm11"><span class="command">lemma</span></span> lm11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">∩</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">P</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="SetUtils-lm12"><span class="command">lemma</span></span> lm12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">∈</span> <span class="free">P</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SetUtils-lm13"><span class="command">lemma</span></span> lm13<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">B</span>"</span></span> 
             <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>  <span class="main">=</span>  <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">B</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms inj_on_Un <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="SetUtils-injection_union"><span class="command">lemma</span></span> injection_union<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
              <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms lm13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="SetUtils-lm14"><span class="command">lemma</span></span> lm14<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pow <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span><span class="main">=</span><span class="main">{}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Partitions">
<div class="head">
<h1>Theory Partitions</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partitions of sets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partitions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="SetUtils.html">SetUtils</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We define the set of all partitions of a set (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">all_partitions</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) in textbook style, as well as a computable function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">all_partitions_list</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to algorithmically compute this set (then represented as a list).  This function is suitable for code generation.  We prove the equivalence of the two definition in order to ensure that the generated code correctly implements the original textbook-style definition.  For further background on the overall approach, see Caminati, Kerber, Lange, Rowat: \href{http://arxiv.org/abs/1308.1779}{Proving soundness of combinatorial Vickrey auctions and generating verified executable code}, 2013.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a family of non-overlapping  sets.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_non_overlapping</span> 
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_non_overlapping</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">Y</span><span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> <span class="bound">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">=</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* alternative, less concise formalisation:
"is_non_overlapping P = (∀ ec1 ∈ P . ec1 ≠ {} ∧ (∀ ec2 ∈ P - {ec1}. ec1 ∩ ec2 = {}))"
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A subfamily of a non-overlapping family is also a non-overlapping family›</span></span>

<span class="keyword1" id="Partitions-subset_is_non_overlapping"><span class="command">lemma</span></span> subset_is_non_overlapping<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
<span class="comment1">(* CL: The following takes 387 ms with Isabelle2013-1-RC1:
   by (metis is_non_overlapping_def non_overlapping rev_subsetD subset). MC: possibly useful for TPTP *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_overlapping <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This is not used at the moment, but it is interesting, as the proof
   was very hard to find for Sledgehammer. MC: possibly useful for TPTP *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The family that results from removing one element from an equivalence class of a non-overlapping family is not otherwise a member of the family.›</span></span>
<span class="keyword1" id="Partitions-remove_from_eq_class_preserves_disjoint"><span class="command">lemma</span></span> remove_from_eq_class_preserves_disjoint<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> eq_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Int_Diff is_non_overlapping_def Diff_disjoint Diff_eq_empty_iff 
        Int_absorb2 insert_Diff_if insert_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inserting into a non-overlapping family <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is disjoint with the set 
  partitioned by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, yields another non-overlapping family.›</span></span>

<span class="keyword1" id="Partitions-non_overlapping_extension1"><span class="command">lemma</span></span> non_overlapping_extension1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> partition<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Z</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Y_Z_in_ext_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> insert <span class="free">X</span> <span class="free">P</span> <span class="main">∧</span> <span class="skolem">Z</span> <span class="main">∈</span> insert <span class="free">X</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∩</span> <span class="skolem">Z</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Z</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∩</span> <span class="skolem">Z</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Y_Z_in_ext_P partition disjoint
        <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∩</span> <span class="skolem">Z</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Y_Z_in_ext_P partition non_empty
        <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An element of a non-overlapping family has no intersection with any other of its elements.›</span></span>
<span class="keyword1" id="Partitions-disj_eq_classes"><span class="command">lemma</span></span> disj_eq_classes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> x_in_two_eq_classes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> other_eq_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_in_two_eq_classes other_eq_class <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> other_eq_class <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty set is not element of a non-overlapping family.›</span></span>
<span class="keyword1" id="Partitions-no_empty_in_non_overlapping"><span class="command">lemma</span></span> no_empty_in_non_overlapping<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">p</span>"</span></span>
<span class="comment1">(* CL: The following takes 36 ms with Isabelle2013-1-RC1:
   by (metis Int_iff all_not_in_conv assms is_non_overlapping_def). MC: possibly useful for TPTP *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a partition of the set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The infix notation takes the form ``noun-verb-object''›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_partition_of</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">partitions</span>"</span> 75<span class="main">)</span>
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_partition_of</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> is_non_overlapping <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No partition of a non-empty set is empty.›</span></span>
<span class="keyword1" id="Partitions-non_empty_imp_non_empty_partition"><span class="command">lemma</span></span> non_empty_imp_non_empty_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">partitions</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every element of a partitioned set ends up in one element in the partition.›</span></span>
<span class="keyword1" id="Partitions-elem_in_partition"><span class="command">lemma</span></span> elem_in_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">partitions</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> part in_set <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UnionE<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every element of the difference of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and another set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ends up in 
  an element of a partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but not in an element of the partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">B</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Partitions-diff_elem_in_partition"><span class="command">lemma</span></span> diff_elem_in_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">partitions</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span> <span class="free">B</span> <span class="main">}</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">S</span>"</span></span>
<span class="comment1">(* Sledgehammer in Isabelle2013-1-RC1 can't do this within the default time limit. 
MC: possibly useful for TPTP *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> part x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff elem_in_partition<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every element of a partitioned set ends up in exactly one set.›</span></span>
<span class="keyword1" id="Partitions-elem_in_uniq_set"><span class="command">lemma</span></span> elem_in_uniq_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">partitions</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound"><span class="bound">X</span></span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> elem_in_partition<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> part in_set *
      <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def is_non_overlapping_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A non-empty set ``is'' a partition of itself.›</span></span>
<span class="keyword1" id="Partitions-set_partitions_itself"><span class="command">lemma</span></span> set_partitions_itself<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="keyword1">partitions</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def is_non_overlapping_def
<span class="comment1">(* CL: the following takes 48 ms on my machine with Isabelle2013:
   by (metis Sup_empty Sup_insert assms inf_idem singletonE sup_bot_right). MC: possibly useful for TPTP *)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> singletonD<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X</span> <span class="main">∈</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="bound">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">=</span> <span class="bound">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty set is a partition of the empty set.›</span></span>
<span class="keyword1" id="Partitions-emptyset_part_emptyset1"><span class="command">lemma</span></span> emptyset_part_emptyset1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">partitions</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any partition of the empty set is empty.›</span></span>
<span class="keyword1" id="Partitions-emptyset_part_emptyset2"><span class="command">lemma</span></span> emptyset_part_emptyset2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">partitions</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def is_non_overlapping_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Classical set-theoretical definition of ``all partitions of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>''›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_partitions</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">all_partitions</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span> <span class="main">.</span> <span class="bound">P</span> <span class="keyword1">partitions</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all partitions of the empty set only contains the empty set.
  We need this to prove the base case of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">all_partitions_paper_equiv_alg</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Partitions-emptyset_part_emptyset3"><span class="command">lemma</span></span> emptyset_part_emptyset3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_partitions <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def <span class="keyword1"><span class="command">using</span></span> emptyset_part_emptyset1 emptyset_part_emptyset2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inserts an element new\_el into a specified set S inside a given family of sets›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_into_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert_into_member</span> <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">Sets</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">new_el</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Sets</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert_into_member<span class="antiquote"><span class="antiquote">}</span></span></span></span> to insert a fresh element, which is not a member of the
  set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being partitioned, into a non-overlapping family of sets yields another
  non-overlapping family.›</span></span>
<span class="keyword1" id="Partitions-non_overlapping_extension2"><span class="command">lemma</span></span> non_overlapping_extension2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">new_el</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> class_element<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">new_el</span> <span class="main">∉</span> <span class="main">⋃</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>insert_into_member <span class="free">new_el</span> <span class="free">P</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="free">new_el</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rest_is_non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_overlapping subset_is_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> non_overlapping class_element <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disj_eq_classes<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>insert <span class="var">?Y</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rest_is_non_overlapping disjoint non_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> non_overlapping_extension1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_into_member_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inserts an element into a specified set inside the given list of sets --
   the list variant of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert_into_member<span class="antiquote"><span class="antiquote">}</span></span></span></span>

   The rationale for this variant and for everything that depends on it is:
   While it is possible to computationally enumerate ``all partitions of a set'' as an
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set set set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we need a list representation to apply further computational
   functions to partitions.  Because of the way we construct partitions (using functions
   such as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">all_coarser_partitions_with</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> below) it is not sufficient to simply use 
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set set list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but we need <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set list list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  This is because it is hard 
   to impossible to convert a set to a list, whereas it is easy to convert a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> list<span class="antiquote"><span class="antiquote">}</span></span></span></span> to a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> set<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_into_member_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert_into_member_list</span> <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">Sets</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">new_el</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>remove1 <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">Sets</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert_into_member_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert_into_member<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equivalent
  (as in returning the same set).›</span></span>
<span class="keyword1" id="Partitions-insert_into_member_list_equivalence"><span class="command">lemma</span></span> insert_into_member_list_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">new_el</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Sets</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Sets</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insert_into_member_list <span class="free">new_el</span> <span class="free">Sets</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> insert_into_member <span class="free">new_el</span> <span class="main">(</span>set <span class="free">Sets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insert_into_member_list_def insert_into_member_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹an alternative characterization of the set partitioned by a partition obtained by 
  inserting an element into an equivalence class of a given partition (if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  \emph{is} a partition)›</span></span>
<span class="keyword1" id="Partitions-insert_into_member_partition1"><span class="command">lemma</span></span> insert_into_member_partition1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">set</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>insert_into_member <span class="free">elem</span> <span class="free">P</span> <span class="free">set</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">set</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">set</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* CL: The following takes 12 ms in Isabelle2013-1-RC1:
   by (metis insert_into_member_def). MC: possibly useful for TPTP *)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert_into_member_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assuming that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a partition of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">new_el</span></span> <span class="main"><span class="main">∉</span></span> <span class="free"><span class="free">S</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the function defined below yields
  all possible partitions of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">S</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">new_el</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that are coarser than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  (i.e.\ not splitting classes that already exist in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).  These comprise one partition 
  with a class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">new_el</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and all other classes unchanged,
  as well as all partitions obtained by inserting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">new_el</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into one class of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at a time. While we use the definition to build coarser partitions of an existing partition P, the definition itself does not require P to be a partition.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coarser_partitions_with</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">coarser_partitions_with</span> <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> 
    insert
    <span class="comment1">― ‹Let <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> be a partition of a set <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set›</span></span>,›</span>
    <span class="comment1">― ‹and suppose <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el ∉ Set›</span></span>, i.e. <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{new_el} ∉ P›</span></span>,›</span>
    <span class="comment1">― ‹then the following constructs a partition of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set ∪ {new_el}›</span></span> obtained by›</span>
    <span class="comment1">― ‹inserting a new class <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{new_el}›</span></span> and leaving all previous classes unchanged.›</span>
    <span class="main">(</span>insert <span class="main">{</span><span class="free"><span class="bound"><span class="entity">new_el</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>
    <span class="comment1">― ‹Let <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> be a partition of a set <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set›</span></span>,›</span>
    <span class="comment1">― ‹and suppose <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el ∉ Set›</span></span>,›</span>
    <span class="comment1">― ‹then the following constructs›</span>
    <span class="comment1">― ‹the set of those partitions of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set ∪ {new_el}›</span></span> obtained by›</span>
    <span class="comment1">― ‹inserting <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el›</span></span> into one class of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> at a time.›</span>
    <span class="main">(</span><span class="main">(</span>insert_into_member <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹the list variant of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coarser_partitions_with_list</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">coarser_partitions_with_list</span> <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> 
    <span class="comment1">― ‹Let <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> be a partition of a set <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set›</span></span>,›</span>
    <span class="comment1">― ‹and suppose <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el ∉ Set›</span></span>, i.e. <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{new_el} ∉ set P›</span></span>,›</span>
    <span class="comment1">― ‹then the following constructs a partition of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set ∪ {new_el}›</span></span> obtained by›</span>
    <span class="comment1">― ‹inserting a new class <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{new_el}›</span></span> and leaving all previous classes unchanged.›</span>
    <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">new_el</span></span></span><span class="main">}</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>
    <span class="main">#</span>
    <span class="comment1">― ‹Let <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> be a partition of a set <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set›</span></span>,›</span>
    <span class="comment1">― ‹and suppose <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el ∉ Set›</span></span>,›</span>
    <span class="comment1">― ‹then the following constructs›</span>
    <span class="comment1">― ‹the set of those partitions of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Set ∪ {new_el}›</span></span> obtained by›</span>
    <span class="comment1">― ‹inserting <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>new_el›</span></span> into one class of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P›</span></span> at a time.›</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">(</span>insert_into_member_list <span class="free"><span class="bound"><span class="entity">new_el</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> coarser_partitions_with_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equivalent.›</span></span>
<span class="keyword1" id="Partitions-coarser_partitions_with_list_equivalence"><span class="command">lemma</span></span> coarser_partitions_with_list_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>coarser_partitions_with_list <span class="free">new_el</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         coarser_partitions_with <span class="free">new_el</span> <span class="main">(</span>set <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>coarser_partitions_with_list <span class="free">new_el</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map set <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="free">new_el</span><span class="main">}</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(</span>insert_into_member_list <span class="free">new_el</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_list_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="main">(</span>insert <span class="main">{</span><span class="free">new_el</span><span class="main">}</span> <span class="main">(</span>set <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>set <span class="main">∘</span> <span class="main">(</span>insert_into_member_list <span class="free">new_el</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="main">(</span>insert <span class="main">{</span><span class="free">new_el</span><span class="main">}</span> <span class="main">(</span>set <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>insert_into_member <span class="free">new_el</span> <span class="main">(</span>set <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms insert_into_member_list_equivalence <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any member of the set of coarser partitions of a given partition, obtained by inserting 
  a given fresh element into each of its classes, is non\_overlapping.›</span></span>
<span class="keyword1" id="Partitions-non_overlapping_extension3"><span class="command">lemma</span></span> non_overlapping_extension3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> new_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="main">∉</span> <span class="main">⋃</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Q_coarser<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> coarser_partitions_with <span class="free">elem</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">{</span><span class="free">elem</span><span class="main">}</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q_coarser_unfolded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> insert <span class="var">?q</span> <span class="main">(</span>insert_into_member <span class="free">elem</span> <span class="free">P</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Q_coarser 
    <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> P_non_overlapping new_elem non_overlapping_extension1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> <span class="main">(</span>insert_into_member <span class="free">elem</span> <span class="free">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_coarser_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> non_overlapping_extension2 P_non_overlapping new_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a partition of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">elem</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> an element (which may or may not be
  in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> already).  Then, any member of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"coarser_partitions_with <span class="free"><span class="free">elem</span></span> <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a set of sets
  whose union is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">S</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">elem</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.\ it satisfies one of the necessary criteria for being a partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">S</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">elem</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Partitions-coarser_partitions_covers"><span class="command">lemma</span></span> coarser_partitions_covers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> coarser_partitions_with <span class="free">elem</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">Q</span> <span class="main">=</span> insert <span class="free">elem</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> <span class="main">(</span>insert_into_member <span class="free">elem</span> <span class="free">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">elem</span><span class="main">}</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">eq_class</span> <span class="keyword3"><span class="command">assume</span></span> eq_class_in_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eq_class</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">eq_class</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">eq_class</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">eq_class</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_into_member_partition1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_insert Un_commute Un_empty_right Un_insert_right insert_Diff_single<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq_class_in_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">eq_class</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">eq_class</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>insert_into_member <span class="free">elem</span> <span class="free">P</span> <span class="skolem">eq_class</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_into_member_partition1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Q_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Removes the element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">elem</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from every set in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and removes from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> any
  remaining empty sets.  This function is intended to be applied to partitions, i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">elem</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  occurs in at most one set.  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">partition_without</span></span> <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reverses <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"coarser_partitions_with <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span> is one-to-many, while this is one-to-one, so we can think of a tree relation,
where coarser partitions of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">S</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">elem</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are child nodes of one partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_without</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">partition_without</span> <span class="free"><span class="bound"><span class="entity">elem</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">elem</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
<span class="comment1">(* Set comprehension notation { x - {elem} | x . x ∈ P } would look nicer but is harder to do proofs about *)</span>

<span class="comment1">(* We don't need to define partition_without_list. *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alternative characterization of the set partitioned by the partition obtained 
  by removing an element from a given partition using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> partition_without<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="Partitions-partition_without_covers"><span class="command">lemma</span></span> partition_without_covers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>partition_without <span class="free">elem</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">P</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>partition_without <span class="free">elem</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any class of the partition obtained by removing an element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">elem</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from an
  original partition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> partition_without<span class="antiquote"><span class="antiquote">}</span></span></span></span> equals some
  class of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, reduced by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">elem</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Partitions-super_class"><span class="command">lemma</span></span> super_class<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> partition_without <span class="free">elem</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Z</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition_without_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z_in_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Z_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Diff_iff image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class of sets obtained by removing an element from a non-overlapping class is another
  non-overlapping clas.›</span></span>
<span class="keyword1" id="Partitions-non_overlapping_without_is_non_overlapping"><span class="command">lemma</span></span> non_overlapping_without_is_non_overlapping<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>partition_without <span class="free">elem</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X1</span> <span class="main">∈</span> <span class="var">?Q</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">X2</span> <span class="main">∈</span> <span class="var">?Q</span><span class="main">.</span> <span class="bound">X1</span> <span class="main">∩</span> <span class="bound">X2</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="bound">X1</span> <span class="main">=</span> <span class="bound">X2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X1</span> <span class="keyword3"><span class="command">assume</span></span> X1_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z1</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z1_in_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z1</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Z1_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> <span class="skolem">Z1</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> super_class<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> X1_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X1_in_Q partition_without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X2</span> <span class="main">∈</span> <span class="var">?Q</span><span class="main">.</span> <span class="skolem">X1</span> <span class="main">∩</span> <span class="bound">X2</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="skolem">X1</span> <span class="main">=</span> <span class="bound">X2</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">∈</span> <span class="var">?Q</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z2</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z2_in_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z2</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Z2_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> <span class="skolem">Z2</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> super_class<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">∩</span> <span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="skolem">X1</span> <span class="main">=</span> <span class="skolem">X2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">∩</span> <span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z1</span> <span class="main">∩</span> <span class="skolem">Z2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z1_sup Z2_sup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z1</span> <span class="main">=</span> <span class="skolem">Z2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z1_in_P Z2_in_P assms <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z1_sup Z2_sup <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">=</span> <span class="skolem">X2</span> <span class="main">⟶</span> <span class="skolem">X1</span> <span class="main">∩</span> <span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X1_non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X1</span> <span class="main">∩</span> <span class="skolem">X2</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">X1</span> <span class="main">=</span> <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"coarser_partitions_with <span class="free"><span class="free">elem</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the ``inverse'' of 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"partition_without <span class="free"><span class="free">elem</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Partitions-coarser_partitions_inv_without"><span class="command">lemma</span></span> coarser_partitions_inv_without<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> coarser_partitions_with <span class="free">elem</span> <span class="main">(</span>partition_without <span class="free">elem</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> coarser_partitions_with <span class="free">elem</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?remove_elem</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span> <span class="comment1">(* function that removes elem out of a set *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="comment1">(* the equivalence class of elem *)</span>
    <span class="keyword2"><span class="keyword">where</span></span> elem_eq_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem_eq_class'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?elem_neq_classes</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span>"</span></span> <span class="comment1">(* those equivalence classes of which elem is not a member *)</span>
  <span class="keyword1"><span class="command">have</span></span> P_wrt_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_eq_class' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?elem_eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span> <span class="comment1">(* other elements equivalent to elem *)</span>
  <span class="keyword1"><span class="command">have</span></span> Y_elem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?remove_elem</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="comment1">(* those classes,of which elem is not a member, form a partition *)</span>
  <span class="keyword1"><span class="command">have</span></span> elem_neq_classes_part<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="var">?elem_neq_classes</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_is_non_overlapping non_overlapping
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> elem_eq_wrt_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?elem_eq</span> <span class="main">∈</span> <span class="var">?remove_elem</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_eq_class' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* consider a class W, of which elem is not a member *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">W</span> <span class="keyword3"><span class="command">assume</span></span> W_eq_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">∈</span> <span class="var">?elem_neq_classes</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="main">∉</span> <span class="skolem">W</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elem_eq_class elem_eq_class' non_overlapping is_non_overlapping_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?remove_elem</span> <span class="skolem">W</span> <span class="main">=</span> <span class="skolem">W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> elem_neq_classes_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?remove_elem</span> <span class="main">`</span> <span class="var">?elem_neq_classes</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> Q_unfolded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="var">?remove_elem</span> <span class="main">`</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> partition_without_def
    <span class="keyword1"><span class="command">using</span></span> image_Collect_mem
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?remove_elem</span> <span class="main">`</span> <span class="main">(</span><span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_wrt_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Y_elem_eq elem_neq_classes_id image_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> Q_wrt_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?elem_eq</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="var">?elem_eq</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> elem_eq_class elem_eq_class' non_overlapping Diff_Int_distrib2 Diff_iff empty_Diff insert_iff
<span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?elem_eq</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_overlapping no_empty_in_non_overlapping
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> elem_neq_classes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?elem_neq_classes</span> <span class="main">-</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?elem_eq</span> <span class="main">∉</span> <span class="var">?Q</span>"</span></span> <span class="comment1">(* the class of elem is not a member of ?Q = partition_without elem P *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?elem_eq</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elem_eq_wrt_P Q_unfolded
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Y_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_eq_class <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q_wrt_elem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_empty_in_non_overlapping elem_neq_classes_part
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">{</span><span class="free">elem</span><span class="main">}</span> <span class="var">?Q</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Y_singleton elem_eq_class'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?elem_eq</span> <span class="main">∉</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_empty_in_non_overlapping non_overlapping non_overlapping_without_is_non_overlapping
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_into_member <span class="free">elem</span> <span class="main">(</span><span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span><span class="main">)</span> <span class="var">?elem_eq</span> <span class="main">=</span> insert <span class="main">(</span><span class="var">?elem_eq</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert_into_member_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?elem_eq</span> <span class="main">∪</span> <span class="main">{</span><span class="free">elem</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_neq_classes <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_eq_class <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_into_member <span class="free">elem</span> <span class="main">(</span><span class="main">{</span><span class="var">?elem_eq</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span><span class="main">)</span> <span class="var">?elem_eq</span> <span class="main">=</span> <span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?elem_neq_classes</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span> <span class="main">=</span> insert_into_member <span class="free">elem</span> <span class="var">?Q</span> <span class="var">?elem_eq</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q_wrt_elem Y' partition_without_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">Y</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span> <span class="main">∈</span> insert_into_member <span class="free">elem</span> <span class="var">?Q</span> <span class="main">`</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">Y</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?elem_neq_classes</span> <span class="main">∈</span> coarser_partitions_with <span class="free">elem</span> <span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P_wrt_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Ps</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of partitions, this is intended to compute the set of all coarser
  partitions (given an extension element) of all partitions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Ps</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_coarser_partitions_with</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set set <span class="main">⇒</span> <span class="tfree">'a</span> set set set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_coarser_partitions_with</span> <span class="free"><span class="bound"><span class="entity">elem</span></span></span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>coarser_partitions_with <span class="free"><span class="bound"><span class="entity">elem</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹the list variant of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_coarser_partitions_with_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set list list <span class="main">⇒</span> <span class="tfree">'a</span> set list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_coarser_partitions_with_list</span> <span class="free"><span class="bound"><span class="entity">elem</span></span></span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="main">=</span> 
         concat <span class="main">(</span>map <span class="main">(</span>coarser_partitions_with_list <span class="free"><span class="bound"><span class="entity">elem</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_coarser_partitions_with_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equivalent.›</span></span>
<span class="keyword1" id="Partitions-all_coarser_partitions_with_list_equivalence"><span class="command">lemma</span></span> all_coarser_partitions_with_list_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">elem</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Ps</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">.</span> distinct <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_coarser_partitions_with_list <span class="free">elem</span> <span class="free">Ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_coarser_partitions_with <span class="free">elem</span> <span class="main">(</span>set <span class="main">(</span>map set <span class="free">Ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?list_expr</span> <span class="main">=</span> <span class="var">?set_expr</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?list_expr</span> <span class="main">=</span> set <span class="main">(</span>map set <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span>coarser_partitions_with_list <span class="free">elem</span><span class="main">)</span> <span class="free">Ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_coarser_partitions_with_list_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>coarser_partitions_with_list <span class="free">elem</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">Ps</span><span class="main">)</span> <span class="main">.</span> set <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span> coarser_partitions_with_list <span class="free">elem</span> <span class="bound">P</span> <span class="main">|</span> <span class="bound">P</span> <span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">}</span> <span class="main">.</span> set <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Collect_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> set <span class="main">(</span>map set <span class="main">(</span>coarser_partitions_with_list <span class="free">elem</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">P</span> <span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> coarser_partitions_with <span class="free">elem</span> <span class="main">(</span>set <span class="bound">P</span><span class="main">)</span> <span class="main">|</span> <span class="bound">P</span> <span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct coarser_partitions_with_list_equivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>coarser_partitions_with <span class="free">elem</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">`</span> <span class="main">(</span>set <span class="free">Ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Collect_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>coarser_partitions_with <span class="free">elem</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>map set <span class="free">Ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?set_expr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_coarser_partitions_with_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹all partitions of a set (given as list) in form of a set›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">all_partitions_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
   <span class="quoted"><span class="quoted">"<span class="free">all_partitions_set</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">all_partitions_set</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> all_coarser_partitions_with <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free">all_partitions_set</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹all partitions of a set (given as list) in form of a list›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">all_partitions_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
   <span class="quoted"><span class="quoted">"<span class="free">all_partitions_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">all_partitions_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> all_coarser_partitions_with_list <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free">all_partitions_list</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A list of partitions coarser than a given partition in list representation (constructed
  with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> coarser_partitions_with<span class="antiquote"><span class="antiquote">}</span></span></span></span> is distinct under certain conditions.›</span></span>
<span class="keyword1" id="Partitions-coarser_partitions_with_list_distinct"><span class="command">lemma</span></span> coarser_partitions_with_list_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ps_coarser<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> set <span class="main">(</span>coarser_partitions_with_list <span class="free">x</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> partition<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>set <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∉</span> set <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>coarser_partitions_with_list <span class="free">x</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">#</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>insert_into_member_list <span class="free">x</span> <span class="free">Q</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> coarser_partitions_with_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ps_coarser <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">#</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">(</span>insert_into_member_list <span class="free">x</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">#</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword2"><span class="keyword">and</span></span> new <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>insert_into_member_list <span class="free">x</span> <span class="free">Q</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> set <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ps_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> insert_into_member_list <span class="free">x</span> <span class="free">Q</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ps_insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>remove1 <span class="skolem">X</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_into_member_list_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>removeAll <span class="skolem">X</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_remove1_removeAll<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ps_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>removeAll <span class="skolem">X</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> distinct_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∉</span> set <span class="main">(</span>removeAll <span class="skolem">X</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">from</span></span> partition <span class="keyword1"><span class="command">have</span></span> partition'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">Q</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∩</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> set <span class="main">(</span>removeAll <span class="skolem">X</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> X_in_Q partition <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> partition' inf_sup_absorb member_remove no_empty_in_non_overlapping remove_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> ps_list distinct <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_removeAll<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The classical definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_partitions<span class="antiquote"><span class="antiquote">}</span></span></span></span> and the algorithmic (constructive) definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_partitions_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equivalent.›</span></span>
<span class="keyword1" id="Partitions-all_partitions_equivalence'"><span class="command">lemma</span></span> all_partitions_equivalence'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> 
         <span class="main">(</span><span class="main">(</span>set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          all_partitions <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">ps</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="free">xs</span><span class="main">)</span> <span class="main">.</span> distinct <span class="bound">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_partitions <span class="main">(</span>set <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> List.set_simps<span class="main">(</span>1<span class="main">)</span> emptyset_part_emptyset3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(* Sledgehammer no longer seems to find this, maybe after we have added the "distinct" part to the theorem statement. *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ps</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="main">[]</span><span class="main">)</span> <span class="main">.</span> distinct <span class="bound">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.hyps
    <span class="keyword1"><span class="command">have</span></span> hyp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems Cons.hyps
    <span class="keyword1"><span class="command">have</span></span> hyp_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ps</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span> <span class="main">.</span> distinct <span class="bound">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> distinct_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> x_notin_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_partitions <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equalitySubsetI<span class="main">)</span> <span class="comment1">(* -- {* case set → list *} *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="comment1">(* a partition *)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P_without_x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"partition_without <span class="skolem">x</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> P_partitions_exc_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="var">?P_without_x</span> <span class="main">=</span> <span class="main">⋃</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partition_without_covers <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_partition_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">partitions</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_non_overlapping<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> is_partition_of <span class="keyword1"><span class="command">have</span></span> P_covers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="skolem">P</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P_without_x</span> <span class="keyword1">partitions</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def
      <span class="keyword1"><span class="command">using</span></span> is_non_overlapping non_overlapping_without_is_non_overlapping partition_without_covers P_covers x_notin_xs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hyp_equiv <span class="keyword1"><span class="command">have</span></span> p_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P_without_x</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> coarser_partitions_with <span class="skolem">x</span> <span class="var">?P_without_x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coarser_partitions_inv_without is_non_overlapping P_covers
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insertI1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>coarser_partitions_with <span class="skolem">x</span> <span class="main">`</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> all_coarser_partitions_with <span class="skolem">x</span> <span class="main">(</span>set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_coarser_partitions_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_coarser_partitions_with_list_equivalence hyp_distinct
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_partitions_list.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* -- {* case list → set *} *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="comment1">(* a partition *)</span>
    <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map set <span class="main">(</span>all_coarser_partitions_with_list <span class="skolem">x</span> <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> all_coarser_partitions_with <span class="skolem">x</span> <span class="main">(</span>set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_xs hyp_distinct all_coarser_partitions_with_list_equivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> all_coarser_partitions_with <span class="skolem">x</span> <span class="main">(</span>all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_xs hyp_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> P_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_coarser_partitions_with <span class="skolem">x</span> <span class="main">(</span>all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> all_coarser_partitions_with <span class="skolem">x</span> <span class="main">(</span>all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>coarser_partitions_with <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_coarser_partitions_with_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> P_in_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Y_coarser<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> coarser_partitions_with <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> Y_coarser <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> Q_part_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Y_coarser'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> coarser_partitions_with <span class="skolem">x</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> P_in_Y Y_coarser' <span class="keyword1"><span class="command">have</span></span> P_wrt_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> coarser_partitions_with <span class="skolem">x</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_part_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">partitions</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_covers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="skolem">Q</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> non_overlapping_extension3 P_wrt_Q x_notin_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="skolem">P</span> <span class="main">=</span> set <span class="skolem">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q_covers P_in_Y Y_coarser' coarser_partitions_covers <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="skolem">P</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_notin_xs P_wrt_Q Q_covers
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_is_Un sup_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">partitions</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P_partition <span class="keyword1"><span class="command">unfolding</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ps</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> distinct <span class="bound">ps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list"</span></span> <span class="keyword3"><span class="command">assume</span></span> ps_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>all_coarser_partitions_with_list <span class="skolem">x</span> <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span>coarser_partitions_with_list <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_coarser_partitions_with_list_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>set <span class="main">∘</span> <span class="main">(</span>coarser_partitions_with_list <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> all_parts_unfolded<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>set <span class="main">∘</span> <span class="main">(</span>coarser_partitions_with_list <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(* … = ⋃ { set (coarser_partitions_with_list x ps) | ps . ps ∈ set (all_partitions_list xs) }
       (more readable, but less useful in proofs) *)</span>

    <span class="keyword1"><span class="command">with</span></span> ps_part <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ps_coarser<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> set <span class="main">(</span>coarser_partitions_with_list <span class="skolem">x</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> UnionE comp_def imageE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> qs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> distinct_xs hyp_equiv <span class="keyword1"><span class="command">have</span></span> qs_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs_part<span class="main">:</span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>set <span class="skolem">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_partitions_def is_partition_of_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> distinct_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs distinct_xs hyp_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∉</span> set <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs_hyp
      <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def is_partition_of_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> UnionI insertI1 mem_Collect_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> ps_coarser distinct_qs qs_part new
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coarser_partitions_with_list_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The classical definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_partitions<span class="antiquote"><span class="antiquote">}</span></span></span></span> and the algorithmic (constructive) definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_partitions_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> are equivalent.  This is a front-end theorem derived from
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> all_partitions_equivalence'<span class="antiquote"><span class="antiquote">}</span></span></span></span>; it does not make the auxiliary statement about partitions
  being distinct lists.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> all_partitions_paper_equiv_alg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> set <span class="main">(</span>map set <span class="main">(</span>all_partitions_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> all_partitions <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_partitions_equivalence' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function that we will be using in practice to compute all partitions of a set,
  a set-oriented front-end to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> all_partitions_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_partitions_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder set <span class="main">⇒</span> <span class="tfree">'a</span> set list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_partitions_alg</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> all_partitions_list <span class="main">(</span>sorted_list_of_set <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="RelationOperators">
<div class="head">
<h1>Theory RelationOperators</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional operators on relations, going beyond Relations.thy,
  and properties of these operators›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RelationOperators
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="SetUtils.html">SetUtils</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluating a relation as a function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an input has a unique image element under a given relation, return that element; 
  otherwise return a fallback value.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_rel_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_rel_or</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">im</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span> <span class="keyword1">in</span> <span class="keyword1">if</span> card <span class="bound">im</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> the_elem <span class="bound">im</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹right-uniqueness of a relation: the image of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> trivial<span class="antiquote"><span class="antiquote">}</span></span></span></span> set (i.e.\ an empty or
  singleton set) under the relation is trivial again. 
This is the set-theoretical way of characterizing functions, as opposed to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span> functions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">runiq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">runiq</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span> <span class="main">.</span> trivial <span class="bound">X</span> <span class="main">⟶</span> trivial <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">``</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Restriction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹restriction of a relation to a set (usually resulting in a relation with a smaller domain)›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">||</span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">||</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">×</span> Range <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹extensional characterization of the pairs within a restricted relation›</span></span>
<span class="keyword1" id="RelationOperators-restrict_ext"><span class="command">lemma</span></span> restrict_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">||</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">using</span></span> Range_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alternative statement of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> restrict_ext<span class="antiquote"><span class="antiquote">}</span></span></span></span> without explicitly naming the pair's components›</span></span>
<span class="keyword1" id="RelationOperators-restrict_ext'"><span class="command">lemma</span></span> restrict_ext'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">||</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> fst <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">||</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> fst <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Restricting a relation to the empty set yields the empty set.›</span></span>
<span class="keyword1" id="RelationOperators-restrict_empty"><span class="command">lemma</span></span> restrict_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A restriction is a subrelation of the original relation.›</span></span>
<span class="keyword1" id="RelationOperators-restriction_is_subrel"><span class="command">lemma</span></span> restriction_is_subrel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Restricting a relation only has an effect within its domain.›</span></span>
<span class="keyword1" id="RelationOperators-restriction_within_domain"><span class="command">lemma</span></span> restriction_within_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> <span class="free">X</span> <span class="main">=</span> <span class="free">P</span> <span class="main">||</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alternative characterization of the restriction of a relation to a singleton set›</span></span>
<span class="keyword1" id="RelationOperators-restrict_to_singleton"><span class="command">lemma</span></span> restrict_to_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">P</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation outside some set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a set-theoretical relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and an ``exclusion'' set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, return those
  tuples of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose first component is not in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  In other words, exclude <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  from the domain of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Outside</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">outside</span>"</span> 75<span class="main">)</span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1"><span class="free">outside</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">×</span> Range <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Considering a relation outside some set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reduces its domain by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="RelationOperators-outside_reduces_domain"><span class="command">lemma</span></span> outside_reduces_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Considering a relation outside a singleton set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reduces its domain by 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> Domain_outside_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">R</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms outside_reduces_domain <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For any set, a relation equals the union of its restriction to that set and its
  pairs outside that set.›</span></span>
<span class="keyword1" id="RelationOperators-outside_union_restrict"><span class="command">lemma</span></span> outside_union_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Outside_def restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The range of a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> outside some exclusion set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a 
  subset of the image of the domain of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, minus <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="RelationOperators-Range_outside_sub_Image_Domain"><span class="command">lemma</span></span> Range_outside_sub_Image_Domain<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> <span class="main">(</span>Domain <span class="free">R</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Outside_def Image_def Domain_def Range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Considering a relation outside some set does not enlarge its range.›</span></span>
<span class="keyword1" id="RelationOperators-Range_outside_sub"><span class="command">lemma</span></span> Range_outside_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms outside_union_restrict <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_mono inf_sup_ord<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Flipping pairs of relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹flipping a pair: exchanging first and second component›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flip</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">flip</span> <span class="free"><span class="bound"><span class="entity">tup</span></span></span> <span class="main">=</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">tup</span></span></span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">tup</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Flipped pairs can be found in the converse relation.›</span></span>
<span class="keyword1" id="RelationOperators-flip_in_conv"><span class="command">lemma</span></span> flip_in_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">tup</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flip <span class="free">tup</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> flip_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Flipping a pair twice doesn't change it.›</span></span>
<span class="keyword1" id="RelationOperators-flip_flip"><span class="command">lemma</span></span> flip_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"flip <span class="main">(</span>flip <span class="free">tup</span><span class="main">)</span> <span class="main">=</span> <span class="free">tup</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> flip_def fst_conv snd_conv surjective_pairing<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Flipping all pairs in a relation yields the converse relation.›</span></span>
<span class="keyword1" id="RelationOperators-flip_conv"><span class="command">lemma</span></span> flip_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"flip <span class="main">`</span> <span class="free">R</span> <span class="main">=</span> <span class="free">R</span><span class="main">¯</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flip <span class="main">`</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{</span> flip <span class="bound">tup</span> <span class="main">|</span> <span class="bound">tup</span> <span class="main">.</span> <span class="bound">tup</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_Collect_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">tup</span> <span class="main">.</span> <span class="bound">tup</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flip_in_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse flip_flip<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">R</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation as a function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Evaluates a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for a single argument, as if it were a function.
  This will only work if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is right-unique, i.e. if the image is always a singleton set.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">,,</span>"</span> 75<span class="main">)</span> <span class="comment1">(* . (Mizar's notation) confuses Isar *)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">,,</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> the_elem <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paste›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹the union of two binary relations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where pairs from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  override pairs from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when their first components coincide.
This is particularly useful when P, Q are <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">runiq</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and one wants to preserve that property.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">paste</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+*</span>"</span> 75<span class="main">)</span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">+*</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">outside</span> Domain <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a subrelation of another relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s
  domain, pasting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same as forming their union.›</span></span>
<span class="keyword1" id="RelationOperators-paste_subrel"><span class="command">lemma</span></span> paste_subrel<span class="main">:</span> 
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> Domain <span class="free">Q</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> 
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> paste_def <span class="keyword1"><span class="command">using</span></span> assms outside_union_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pasting two relations with disjoint domains is the same as forming their union.›</span></span>
<span class="keyword1" id="RelationOperators-paste_disj_domains"><span class="command">lemma</span></span> paste_disj_domains<span class="main">:</span> 
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">P</span> <span class="main">∩</span> Domain <span class="free">Q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivalent to pasting its restriction to some set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="keyword1"><span class="keyword1">outside</span></span> <span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="RelationOperators-paste_outside_restrict"><span class="command">lemma</span></span> paste_outside_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">+*</span> <span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Outside_def restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">P</span> <span class="main">||</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> outside_union_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> paste_disj_domains <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The domain of two pasted relations equals the union of their domains.›</span></span>
<span class="keyword1" id="RelationOperators-paste_Domain"><span class="command">lemma</span></span> paste_Domain<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span><span class="main">=</span>Domain <span class="free">P</span><span class="main">∪</span>Domain <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pasting two relations yields a subrelation of their union.›</span></span>
<span class="keyword1" id="RelationOperators-paste_sub_Un"><span class="command">lemma</span></span> paste_sub_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The range of two pasted relations is a subset of the union of their ranges.›</span></span>
<span class="keyword1" id="RelationOperators-paste_Range"><span class="command">lemma</span></span> paste_Range<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⊆</span> Range <span class="free">P</span> <span class="main">∪</span> Range <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> paste_sub_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="RelationProperties">
<div class="head">
<h1>Theory RelationProperties</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional properties of relations, and operators on relations,
  as they have been defined by Relations.thy›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RelationProperties
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="RelationOperators.html">RelationOperators</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Right-Uniqueness›</span></span>

<span class="comment1">(* flip is applied to pairs so that (flip (x, y)) = (y, x) *)</span>
<span class="keyword1" id="RelationProperties-injflip"><span class="command">lemma</span></span> injflip<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on flip <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> flip_flip inj_on_def<span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm01"><span class="command">lemma</span></span> lm01<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">P</span> <span class="main">=</span> card <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> card_image flip_conv injflip <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="RelationProperties-cardinalityOneTheElemIdentity"><span class="command">lemma</span></span> cardinalityOneTheElemIdentity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span><span class="main">=</span><span class="main">{</span>the_elem <span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def card_Suc_eq card.empty empty_iff the_elem_eq<span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm02"><span class="command">lemma</span></span> lm02<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span><span class="main">=</span><span class="main">{}</span> <span class="main">∨</span> card <span class="free">X</span><span class="main">=</span><span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> cardinalityOneTheElemIdentity order_refl subset_singletonD trivial_def trivial_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm03"><span class="command">lemma</span></span> lm03<span class="main">:</span> <span class="quoted"><span class="quoted">"trivial <span class="free">P</span> <span class="main">=</span> trivial <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> trivial_def subset_singletonD  subset_refl subset_insertI cardinalityOneTheElemIdentity converse_inject
        converse_empty lm01 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* The range of P restricted to X is equal to the image of X through P *)</span>
<span class="keyword1" id="RelationProperties-restrictedRange"><span class="command">lemma</span></span> restrictedRange<span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">P</span><span class="main">||</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span><span class="main">``</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="RelationProperties-doubleRestriction"><span class="command">lemma</span></span> doubleRestriction<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">||</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="RelationProperties-restrictedDomain"><span class="command">lemma</span></span> restrictedDomain<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">R</span><span class="main">||</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> Domain <span class="free">R</span> <span class="main">∩</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A subrelation of a right-unique relation is right-unique.›</span></span>

<span class="keyword1" id="RelationProperties-subrel_runiq"><span class="command">lemma</span></span> subrel_runiq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms runiq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_mono subsetI trivial_subset<span class="main">)</span>

<span class="keyword1" id="RelationProperties-rightUniqueInjectiveOnFirstImplication"><span class="command">lemma</span></span> rightUniqueInjectiveOnFirstImplication<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on fst <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def 
  <span class="keyword1"><span class="command">using</span></span> assms runiq_def trivial_def trivial_imp_no_distinct 
        the_elem_eq surjective_pairing subsetI Image_singleton_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alternative characterization of right-uniqueness: the image of a singleton set is
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> trivial<span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.\ an empty or a singleton set.›</span></span>
<span class="keyword1" id="RelationProperties-runiq_alt"><span class="command">lemma</span></span> runiq_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">.</span> trivial <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_empty2 trivial_empty_or_singleton trivial_singleton<span class="main">)</span> 
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹an alternative definition of right-uniqueness in terms of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> eval_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(* Note that R `` {x} is the image of {x} under R and R ,, x gives you an element y such that R x y. Because of right-uniqueness in this case the element is determined, otherwise it may be undetermined *)</span>
<span class="keyword1" id="RelationProperties-runiq_wrt_eval_rel"><span class="command">lemma</span></span> runiq_wrt_eval_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">.</span> <span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">R</span> <span class="main">,,</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval_rel.simps runiq_alt trivial_def<span class="main">)</span>

<span class="keyword1" id="RelationProperties-rightUniquePair"><span class="command">lemma</span></span> rightUniquePair<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">=</span><span class="free">f</span><span class="main">,,</span><span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms runiq_wrt_eval_rel subset_singletonD Image_singleton_iff equals0D singletonE 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="RelationProperties-runiq_basic"><span class="command">lemma</span></span> runiq_basic<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">y'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">y'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiq_alt trivial_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="RelationProperties-rightUniqueFunctionAfterInverse"><span class="command">lemma</span></span> rightUniqueFunctionAfterInverse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">``</span><span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">``</span><span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms runiq_basic ImageE converse_iff subsetI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm04"><span class="command">lemma</span></span> lm04<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">∈</span> Range <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">^-1</span> <span class="main">``</span> <span class="main">{</span><span class="free">y1</span><span class="main">}</span> <span class="main">∩</span> <span class="free">f</span><span class="main">^-1</span> <span class="main">``</span> <span class="main">{</span><span class="free">y2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">``</span><span class="main">{</span><span class="free">y1</span><span class="main">}</span><span class="main">=</span><span class="free">f</span><span class="main">^-1</span><span class="main">``</span><span class="main">{</span><span class="free">y2</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueFunctionAfterInverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="RelationProperties-converse_Image"><span class="command">lemma</span></span> converse_Image<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> runiq<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> runiq_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">R</span><span class="main">^-1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">^-1</span><span class="main">)</span> <span class="main">``</span> <span class="free">R</span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse rightUniqueFunctionAfterInverse<span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm05"><span class="command">lemma</span></span> lm05<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on fst <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiq_basic 
  <span class="keyword1"><span class="command">using</span></span> assms fst_conv inj_on_def old.prod.inject 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* Another characterization of runiq, relating the set theoretical expression P to the injectivity of the function fst applied to P *)</span>
<span class="keyword1" id="RelationProperties-rightUniqueInjectiveOnFirst"><span class="command">lemma</span></span> rightUniqueInjectiveOnFirst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>runiq <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inj_on fst <span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> rightUniqueInjectiveOnFirstImplication lm05 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="RelationProperties-disj_Un_runiq"><span class="command">lemma</span></span> disj_Un_runiq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueInjectiveOnFirst fst_eq_Domain injection_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="RelationProperties-runiq_paste1"><span class="command">lemma</span></span> runiq_paste1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> Domain <span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def 
  <span class="keyword1"><span class="command">using</span></span> assms disj_Un_runiq Diff_disjoint Un_commute outside_reduces_domain
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> runiq_paste2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms runiq_paste1 subrel_runiq Diff_subset Outside_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="comment1">(* Let f be a function, then its graph {(x, f x)} and all its restrictions such that P x for arbitrary P are right-unique. *)</span>
<span class="keyword1" id="RelationProperties-rightUniqueRestrictedGraph"><span class="command">lemma</span></span> rightUniqueRestrictedGraph<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiq_basic <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="RelationProperties-rightUniqueSetCardinality"><span class="command">lemma</span></span> rightUniqueSetCardinality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">=</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  lm02 DomainE Image_singleton_iff empty_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> runiq_alt<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The image of a singleton set under a right-unique relation is a singleton set.›</span></span>
<span class="keyword1" id="RelationProperties-Image_runiq_eq_eval"><span class="command">lemma</span></span> Image_runiq_eq_eval<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">R</span> <span class="main">,,</span> <span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueSetCardinality
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval_rel.simps cardinalityOneTheElemIdentity<span class="main">)</span>

<span class="keyword1" id="RelationProperties-lm06"><span class="command">lemma</span></span> lm06<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms trivial_subset_non_empty runiq_basic snd_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A singleton relation is right-unique.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> runiq_singleton_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> trivial_singleton lm06 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty relation is right-unique›</span></span>
<span class="keyword1" id="RelationProperties-runiq_emptyrel"><span class="command">lemma</span></span> runiq_emptyrel<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> trivial_empty lm06 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* characterization of right-uniqueness with  ∃! *)</span>
<span class="keyword1" id="RelationProperties-runiq_wrt_ex1"><span class="command">lemma</span></span> runiq_wrt_ex1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"runiq <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> Domain <span class="free">R</span> <span class="main">.</span> <span class="main">∃!</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> runiq_basic <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain.DomainI Domain.cases<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alternative characterization of the fact that, if a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is right-unique,
  its evaluation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span><span class="main"><span class="main">,,</span></span><span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on some argument <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in its domain, occurs in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s
  range. Note that we need runiq R in order to get a definite value for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span><span class="main"><span class="main">,,</span></span><span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="RelationProperties-eval_runiq_rel"><span class="command">lemma</span></span> eval_runiq_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> runiq<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">R</span><span class="main">,,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rightUniquePair runiq_wrt_ex1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Evaluating a right-unique relation as a function on the relation's domain yields an
  element from its range.›</span></span>
<span class="keyword1" id="RelationProperties-eval_runiq_in_Range"><span class="command">lemma</span></span> eval_runiq_in_Range<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">,,</span> <span class="free">a</span> <span class="main">∈</span> Range <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_iff eval_runiq_rel<span class="main">)</span>





<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Converse›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inverse image of the image of a singleton set under some relation is the same
  singleton set, if both the relation and its converse are right-unique and the singleton set
  is in the relation's domain.›</span></span>
<span class="keyword1" id="RelationProperties-converse_Image_singleton_Domain"><span class="command">lemma</span></span> converse_Image_singleton_Domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> runiq<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> runiq_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span> <span class="main">``</span> <span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">¯</span> <span class="main">``</span> <span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> runiq domain <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> runiq_def trivial_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">R</span><span class="main">¯</span> <span class="main">``</span> <span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms runiq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sup <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> singleton_sub_trivial_uniq subset_antisym trivial_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The images of two disjoint sets under an injective function are disjoint.›</span></span>

<span class="keyword1" id="RelationProperties-disj_Domain_imp_disj_Image"><span class="command">lemma</span></span> disj_Domain_imp_disj_Image<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">R</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> runiq_basic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="RelationProperties-runiq_converse_paste_singleton"><span class="command">lemma</span></span> runiq_converse_paste_singleton<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∉</span><span class="main">(</span>Range <span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">(</span><span class="var">?P</span><span class="main">^-1</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?P</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> paste_sub_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span><span class="main">^-1</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">^-1</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span><span class="main">^-1</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span> <span class="main">∩</span> Domain <span class="main">{</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">(</span><span class="free">P</span><span class="main">^-1</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disj_Un_runiq runiq_singleton_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subrel_runiq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>










<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Injectivity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a classical definition of the set of all injective functions from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">injections</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">injections</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">R</span> <span class="main">.</span> Domain <span class="bound">R</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> Range <span class="bound">R</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> runiq <span class="bound">R</span> <span class="main">∧</span> runiq <span class="main">(</span><span class="bound">R</span><span class="main">¯</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following definition is a constructive (computational) characterization of the set of all injections X Y, represented by a list. That is, we define the list of all injective functions (represented as relations) from one set (represented as a list) to another set. We formally prove the equivalence of the constructive and the classical definition in Universes.thy.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">injections_alg</span> <span class="comment1">(* :: "'a list ⇒ 'b::linorder set ⇒ ('a × 'b) set list" *)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">injections_alg</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">{}</span><span class="main">]</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="free">injections_alg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> concat <span class="main">[</span> <span class="main">[</span> <span class="bound">R</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">.</span> y <span class="main">←</span> sorted_list_of_set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">-</span> Range <span class="bound">R</span><span class="main">)</span> <span class="main">]</span>
       <span class="main">.</span> R <span class="main">←</span> <span class="free">injections_alg</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">]</span>"</span></span>
<span class="comment1">(* We need this as a list in order to be able to iterate over it.  It would be easy to provide 
   an alternative of type ('a × 'b) set set, by using ⋃ and set comprehension. *)</span>

<span class="keyword1" id="RelationProperties-Image_within_domain'"><span class="command">lemma</span></span> Image_within_domain'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">R</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Argmax">
<div class="head">
<h1>Theory Argmax</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;


Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Locus where a function or a list (of linord type) attains its maximum value›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Argmax
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Structural induction is used in proofs on lists.›</span></span>
<span class="keyword1" id="Argmax-structInduct"><span class="command">lemma</span></span> structInduct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span>"</span></span> 
                    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">l</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms list_nonempty_induct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹the subset of elements of a set where a function reaches its maximum›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">argmax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">argmax</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="comment1">(* For reasons we do not understand we have to duplicate the definition as a lemma 
   in order to prove lm16 in CombinatorialAuctions.thy. *)</span>
<span class="keyword1" id="Argmax-argmaxLemma"><span class="command">lemma</span></span> argmaxLemma<span class="main">:</span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Argmax-maxLemma"><span class="command">lemma</span></span> maxLemma<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">X</span><span class="main">)</span> <span class="main">&gt;=</span> <span class="free">f</span> <span class="free">x</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&gt;=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Max.coboundedI finite_imageI image_eqI<span class="main">)</span>

<span class="keyword1" id="Argmax-lm01"><span class="command">lemma</span></span> lm01<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Argmax-lm02"><span class="command">lemma</span></span> lm02<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Argmax-argmaxEquivalence"><span class="command">lemma</span></span> argmaxEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> argmax <span class="free">g</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms argmaxLemma Collect_cong image_cong 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The arg max of a function over a non-empty set is non-empty.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> argmax_non_empty_iff<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
                                <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">X</span> <span class="main">≠</span><span class="main">{}</span>"</span></span>
                                <span class="keyword1"><span class="command">using</span></span> assms Max_in finite_imageI image_is_empty lm01 lm02 
                                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The previous definition of argmax operates on sets. In the following we define a corresponding notion on lists. To this end, we start with defining a filter predicate and are looking for the elements of a list satisfying a given predicate;
but, rather than returning them directly, we return the (sorted) list of their indices. 
This is done, in different ways, by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">filterpositions</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">filterpositions2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="comment1">(* Given a list l, filterpositions yields the indices of its elements which satisfy a given pred P*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filterpositions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">=&gt;</span> bool<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> list <span class="main">=&gt;</span> nat list"</span></span>
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">filterpositions</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> map snd <span class="main">(</span>filter <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">o</span> fst<span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>upt <span class="main">0</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* That is, you take the list [a0, a1, ..., an] pair with the indices [0, 1, ..., n], i.e., you get
   [(a0,0), (a1,1), ..., (an,n)] look where the predicate (P o fst) holds and return the list of the
   corresponding snd elements. *)</span>


<span class="comment1">(* Alternative definition, making use of list comprehension. In the next line the type info is
   commented out, since the type inference can be left to Isabelle. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filterpositions2</span> <span class="comment1">(*  :: "('a =&gt; bool) =&gt; 'a list =&gt; nat list" *)</span>
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">filterpositions2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maxpositions</span> <span class="comment1">(*:: "'a::linorder list =&gt; nat list"*)</span> 
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxpositions</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> filterpositions2 <span class="main">(</span><span class="main">%</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> Max <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1" id="Argmax-lm03"><span class="command">lemma</span></span> lm03<span class="main">:</span> <span class="quoted"><span class="quoted">"maxpositions <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span><span class="main">.</span> n<span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">l</span><span class="main">!</span><span class="bound">n</span> <span class="main">≥</span> Max<span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> maxpositions_def filterpositions2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* argmaxList takes a function and a list as arguments and looks for the positions of the elements at which the function applied to the list element is maximal, e.g., 
for the list [9, 3, 5, 9, 13] and the function `modulo 8', the function applied to the list would give the list [1, 3, 5, 1, 5], that is, argmaxList will return [2, 4]. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">argmaxList</span> <span class="comment1">(*:: "('a =&gt; ('b::linorder)) =&gt; 'a list =&gt; 'a list"*)</span>
           <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">argmaxList</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>maxpositions <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The following lemmas state some relationships between different representation such as map and list comprehension *)</span>
<span class="keyword1" id="Argmax-lm04"><span class="command">lemma</span></span> lm04<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="free">l</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="free">l</span><span class="main">,</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
<span class="comment1">(*sledgehammer-generated proof. 
  Commented out the first three lines (they look quite useless), making it more readable. 
  assume "∀v0. SMT2.fun_app uu__ v0 = (if P v0 then [v0] else [])"
  assume "∀v0. SMT2.fun_app uua__ v0 = (if v0 ∈ set l then if P v0 then [v0] else [] else [])" 
  obtain v3_0 :: "('a ⇒ 'a list) ⇒ 'a list ⇒ ('a ⇒ 'a list) ⇒ 'a" where *)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">uu</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">uu</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">uu</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> 
    map <span class="main">(</span><span class="main">λ</span><span class="bound">uu</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">uu</span> <span class="main">∈</span> set <span class="free">l</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">uu</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">uu</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">n</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">n</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> 
    concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">l</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">n</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">n</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Argmax-lm05"><span class="command">lemma</span></span> lm05<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lm04 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="comment1">(* sledgehammer suggested:  concat_map_singleton map_ident  map_ext by smt*)</span>

<span class="keyword1" id="Argmax-lm06"><span class="command">lemma</span></span> lm06<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">m</span> <span class="free">P</span> 
            <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="bound">n</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* Base case stating the property for the empty list *)</span>
<span class="keyword1" id="Argmax-map_commutes_a"><span class="command">lemma</span></span> map_commutes_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">f</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[]</span><span class="main">,</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">&lt;-</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Step case where the element x is added to the list xs *)</span>
<span class="keyword1" id="Argmax-map_commutes_b"><span class="command">lemma</span></span> map_commutes_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="free">f</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="bound">xs</span><span class="main">,</span>     <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">&lt;-</span> <span class="main">(</span>map <span class="free">f</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span>     <span class="free">Q</span> <span class="bound">x</span><span class="main">]</span> <span class="main">⟶</span> 
                                <span class="main">[</span><span class="free">f</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">&lt;-</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* General case comprising the two previous cases. *)</span>
<span class="keyword1" id="Argmax-map_commutes"><span class="command">lemma</span></span> map_commutes<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> 
                    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">f</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="free">xs</span><span class="main">,</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">&lt;-</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_commutes_a map_commutes_b structInduct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Argmax-lm07"><span class="command">lemma</span></span> lm07<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">l</span> 
            <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxpositions <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> 
                   <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">≥</span> Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span> 
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"maxpositions <span class="main">(</span><span class="var">?fl</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="comment1">(* Pattern matching abbreviation ?fl corresponds to (map f l). Used in the proof, not part of lemma itself *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxpositions <span class="var">?fl</span> <span class="main">=</span> 
  <span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="var">?fl</span><span class="main">]</span><span class="main">,</span> <span class="bound">n</span><span class="main">∈</span> set<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="var">?fl</span><span class="main">]</span><span class="main">,</span> <span class="var">?fl</span><span class="main">!</span><span class="bound">n</span> <span class="main">≥</span> Max <span class="main">(</span>set <span class="var">?fl</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm04 <span class="keyword1"><span class="command">unfolding</span></span> filterpositions2_def maxpositions_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
  <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="bound">n</span><span class="main">&lt;</span>size <span class="free">l</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?fl</span><span class="main">!</span><span class="bound">n</span>  <span class="main">≥</span> Max <span class="main">(</span>set <span class="var">?fl</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
  <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="bound">n</span><span class="main">&lt;</span>size <span class="free">l</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>  <span class="main">≥</span> Max <span class="main">(</span>set <span class="var">?fl</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> nth_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
  <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="bound">n</span><span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>  <span class="main">≥</span> Max <span class="main">(</span>set <span class="var">?fl</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_iff le0 set_upt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  
  <span class="main">[</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">≥</span> Max <span class="main">(</span>set <span class="var">?fl</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm05 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Argmax-lm08"><span class="command">lemma</span></span> lm08<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">l</span> 
            <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmaxList <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> 
                   <span class="main">[</span> <span class="free">l</span><span class="main">!</span><span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">≥</span> Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lm07 argmaxList_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm06<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The theorem expresses that argmaxList is the list of arguments greater equal the Max of the list.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> argmaxadequacy<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> 
                        <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmaxList <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span> <span class="bound">x</span> <span class="main">&lt;-</span> <span class="free">l</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
                        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lh</span><span class="main">=</span><span class="main">_</span>"</span></span><span class="main">)</span> <span class="comment1">(* pattern match ?lh abbreviates "argmaxList f l" *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">%</span> <span class="bound">y</span><span class="main">::</span><span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mh</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">[</span>nth <span class="free">l</span> <span class="bound">n</span> <span class="main">.</span> n <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="var">?P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nth <span class="free">l</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rh</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="bound">x</span> <span class="main">&lt;-</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lh</span> <span class="main">=</span> <span class="var">?mh</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm08 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rh</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">&lt;-</span> <span class="free">l</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="MiscTools">
<div class="head">
<h1>Theory MiscTools</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Toolbox of various definitions and theorems about sets, relations and lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> MiscTools 

<span class="keyword2"><span class="keyword">imports</span></span> 
<span class="quoted">"<a href="../../HOL/HOL-Library/Discrete.html">HOL-Library.Discrete</a>"</span>
<a href="RelationProperties.html">RelationProperties</a>
<span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
<span class="quoted">"<a href="../../HOL/HOL-Library/Indicator_Function.html">HOL-Library.Indicator_Function</a>"</span>
<a href="Argmax.html">Argmax</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts and notations about relations, sets and functions.›</span></span>

<span class="comment1">(* We use as alternative notation for paste instead of +* also +&lt; and overload this with the next definition *)</span>
<span class="keyword1"><span class="command">notation</span></span> paste <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+&lt;</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+&lt;›</span></span></span></span> abbreviation permits to shorten the notation for altering a function f in a single point by giving a pair (a, b) so that the new function has value b with argument a.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">singlepaste</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">singlepaste</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pair</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">notation</span></span> singlepaste <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+&lt;</span>"</span> 75<span class="main">)</span>
<span class="comment1">(* Type of g in f +&lt; g should avoid ambiguities *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>--›</span></span></span></span> abbreviation permits to shorten the notation for considering a function outside a single point.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">singleoutside</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">--</span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">--</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">outside</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Turns a HOL function into a set-theoretical function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="comment1">(*Graph :: "('a =&gt; 'b) =&gt; ('a × 'b) set" where *)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Graph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inverts <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Graph</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (which is equivalently done by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">eval_rel</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>
<span class="comment1">(* Assume (x, y) is in R. Apply R to x, i.e., R ,, x,  will result in y assumed y is unique. *)</span>  

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toFunction</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">,,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* toFunction = eval_rel *)</span>
<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="quoted"><span class="quoted">"toFunction <span class="main">=</span> eval_rel"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> toFunction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm001"><span class="command">lemma</span></span> lm001<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">Q</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹update behaves like P +* Q (paste), but without enlarging P's Domain. update is the set theoretic equivalent of the lambda function update <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">fun_upd</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">||</span> <span class="main">(</span>Domain <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">notation</span></span> update <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+^</span>"</span> 75<span class="main">)</span>

<span class="comment1">(* The operator runiqer will make out of an arbitrary relation a function by making a choice to all those elements in the domain for which the value is not unique by applying the axiom of choice. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">runiqer</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">runiqer</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">graph</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Graph</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but with a built-in restriction to a given set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
This makes it computable for finite X, whereas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Graph <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">||</span></span> <span class="free"><span class="free">X</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not computable. 
Duplicates the eponymous definition found in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Function_Order›</span></span></span></span>, which is otherwise not needed.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">graph</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">graph</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1" id="MiscTools-lm002"><span class="command">lemma</span></span> lm002<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊇</span> graph <span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">(</span>toFunction <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def toFunction_def
  <span class="keyword1"><span class="command">using</span></span> assms graph_def toFunction_def eval_runiq_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm003"><span class="command">lemma</span></span> lm003<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> graph <span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">(</span>toFunction <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def toFunction_def
  <span class="keyword1"><span class="command">using</span></span> assms eval_runiq_rel runiq_basic Domain.DomainI mem_Collect_eq subrelI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm004"><span class="command">lemma</span></span> lm004<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> graph <span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">(</span>toFunction <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm002 lm003 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-domainOfGraph"><span class="command">lemma</span></span> domainOfGraph<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq<span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;</span> Domain<span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span><span class="main">=</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def 
  <span class="keyword1"><span class="command">using</span></span> rightUniqueRestrictedGraph <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="comment1">(* The following definition gives the image of a relation R for a fixed element x. It is equivalent to eval_rel for right unique R, but more general since it determines values even when R is not right unique. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_rel2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> set<span class="main">)</span><span class="main">)</span> set<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">notation</span></span> eval_rel2 <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">,,,</span>"</span> 75<span class="main">)</span>

<span class="keyword1" id="MiscTools-imageEquivalence"><span class="command">lemma</span></span> imageEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> set<span class="main">)</span><span class="main">)</span> set<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">,,</span><span class="free">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">,,,</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Image_runiq_eq_eval cSup_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* UNIV is the universal set containing everything of the given type. It is defined in Set.thy.*)</span>
<span class="keyword1" id="MiscTools-lm005"><span class="command">lemma</span></span> lm005<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Graph <span class="free">f</span><span class="main">=</span>graph UNIV <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Graph_def graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-graphIntersection"><span class="command">lemma</span></span> graphIntersection<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"graph <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="free">f</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span> <span class="main">||</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def 
  <span class="keyword1"><span class="command">using</span></span> Int_iff mem_Collect_eq restrict_ext subrelI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">runiqs</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">runiqs</span><span class="main">=</span><span class="main">{</span><span class="bound">f</span><span class="main">.</span> runiq <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="MiscTools-outsideOutside"><span class="command">lemma</span></span> outsideOutside<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">outside</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm006<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> outsideOutside <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

<span class="keyword1" id="MiscTools-lm007"><span class="command">lemma</span></span> lm007<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">P</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">+*</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm008<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">+*</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm007 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> outsideUnion<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> restrict_to_singleton outside_union_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm009"><span class="command">lemma</span></span> lm009<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="free">P</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outsideUnion sup.right_idem<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm010<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">+*</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> paste_outside_restrict restrict_to_singleton<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm011"><span class="command">lemma</span></span> lm011<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">+*</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm010 lm008 paste_def Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm012"><span class="command">lemma</span></span> lm012<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊇</span> <span class="free">R</span><span class="main">+*</span><span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_least Un_upper1 outside_union_restrict paste_def 
            restrict_to_singleton restriction_is_subrel<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm013"><span class="command">lemma</span></span> lm013<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="free">R</span> <span class="main">+*</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm011 lm012 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-rightUniqueTrivialCartes"><span class="command">lemma</span></span> rightUniqueTrivialCartes<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms runiq_def Image_subset lm013 trivial_subset lm011 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* Two constant functions can be combined to a function *)</span>
<span class="keyword1" id="MiscTools-lm014"><span class="command">lemma</span></span> lm014<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">+*</span> <span class="main">(</span><span class="free">Y</span> <span class="main">×</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> rightUniqueTrivialCartes trivial_singleton runiq_paste2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm015"><span class="command">lemma</span></span> lm015<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">||</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">P</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>    <span class="main">&amp;</span>    <span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def restrict_def Sigma_Un_distrib1 Un_upper1 inf_mono Diff_mono subset_refl 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sigma_mono inf_le1<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm016"><span class="command">lemma</span></span> lm016<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">||</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">P</span><span class="main">||</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>       <span class="main">&amp;</span>    <span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm015 distrib_sup_le sup_idem le_inf_iff subset_antisym sup_commute
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sup_ge1<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm017"><span class="command">lemma</span></span> lm017<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span><span class="main">``</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-cardinalityOneSubset"><span class="command">lemma</span></span> cardinalityOneSubset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Union <span class="free">X</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms cardinalityOneTheElemIdentity <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cSup_singleton insert_subset<span class="main">)</span>

<span class="keyword1" id="MiscTools-cardinalityOneTheElem"><span class="command">lemma</span></span> cardinalityOneTheElem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="free">X</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> insert_subset cardinalityOneTheElemIdentity<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm018"><span class="command">lemma</span></span> lm018<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X1</span><span class="main">)</span> <span class="keyword1">outside</span> <span class="free">X2</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X2</span><span class="main">)</span> <span class="keyword1">outside</span> <span class="free">X1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outsideOutside sup_commute<span class="main">)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ordered relations›</span></span>

<span class="comment1">(* note that card <span class="hidden">❙</span><b>X</b>≥1 means in Isabelle that X is finite and not empty *)</span>
<span class="keyword1" id="MiscTools-lm019"><span class="command">lemma</span></span> lm019<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span><span class="main">≥</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> Max <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> Max_in One_nat_def card_eq_0_iff lessI not_le<span class="main">)</span>

<span class="comment1">(* assume the function f has a maximum in mx *)</span>
<span class="keyword1" id="MiscTools-lm020"><span class="command">lemma</span></span> lm020<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">mx</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> argmax <span class="free">f</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm021"><span class="command">lemma</span></span> lm021<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">mx</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">mx</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">mx</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mk_disjoint_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-lm022"><span class="command">lemma</span></span> lm022<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">mx</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">mx</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">mx</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm021 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> argmax_non_empty_iff equals0D subset_singletonD<span class="main">)</span>

<span class="comment1">(* The following corollary is essentially the same as lm022, however, is simplifies a proof in UniformTieBreaking.thy *)</span>
<span class="keyword1"><span class="command">corollary</span></span> argmaxProperty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="free">X</span> <span class="main">&amp;</span> <span class="free">mx</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">aa</span> <span class="main">∈</span> <span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">mx</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">aa</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">mx</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> argmax <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">mx</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm022 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm023<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mx</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">mx</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">mx</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm022 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff insertI1<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm024"><span class="command">lemma</span></span> lm024<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">=</span> id"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_id inj_on_imageI2<span class="main">)</span>

<span class="comment1">(* Note that Pow X is the powerset of X *)</span>
<span class="keyword1" id="MiscTools-lm025"><span class="command">lemma</span></span> lm025<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms inj_on_image_eq_iff inj_onI PowD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-injectionPowerset"><span class="command">lemma</span></span> injectionPowerset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm025 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_inj_on<span class="main">)</span>

<span class="comment1">(* the finest possible partition of X, e.g., X = {1, 2, 3} goes to {{1}, {2}, {3}}. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finestpart</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finestpart</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="MiscTools-finestPart"><span class="command">lemma</span></span> finestPart<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finestpart <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">|</span><span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-finestPartUnion"><span class="command">lemma</span></span> finestPartUnion<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">=</span><span class="main">⋃</span> <span class="main">(</span>finestpart <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestPart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm026"><span class="command">lemma</span></span> lm026<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Union <span class="main">∘</span> finestpart <span class="main">=</span> id"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def finestPartUnion <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm027"><span class="command">lemma</span></span> lm027<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on Union <span class="main">(</span>finestpart <span class="main">`</span> UNIV<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm026 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_id inj_on_imageI<span class="main">)</span>

<span class="keyword1" id="MiscTools-nonEqualitySetOfSets"><span class="command">lemma</span></span> nonEqualitySetOfSets<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lm028<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on finestpart UNIV"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> nonEqualitySetOfSets finestPart <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> injI<span class="main">)</span>

<span class="comment1">(* E.g. in the following example, with X = {{1}, {1,2}}, x can be {1} and {1,2} and Y is {{1}} and {{1},{2}}, that is, the lefthand and righthand sides evaluate to {{1},{2}} *)</span>
<span class="keyword1" id="MiscTools-unionFinestPart"><span class="command">lemma</span></span> unionFinestPart<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">Y</span> <span class="main">|</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>finestpart<span class="main">`</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Now we specialize the previous lemma to the situation where X consists of a relation (that is is a set of pairs) *)</span>
<span class="keyword1" id="MiscTools-rangeSetOfPairs"><span class="command">lemma</span></span> rangeSetOfPairs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span><span class="bound">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> Range <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Further specialization to a singleton for Y *)</span>
<span class="keyword1" id="MiscTools-setOfPairsEquality"><span class="command">lemma</span></span> setOfPairsEquality<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-setOfPairs"><span class="command">lemma</span></span> setOfPairs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span>  snd <span class="free">pair</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span>fst <span class="free">pair</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="free">pair</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm029"><span class="command">lemma</span></span> lm029<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> finestpart <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-pairDifference"><span class="command">lemma</span></span> pairDifference<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">Y</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm030"><span class="command">lemma</span></span> lm030<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">P</span> <span class="main">=</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> Pow <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm031"><span class="command">lemma</span></span> lm031<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-sortingSameSet"><span class="command">lemma</span></span> sortingSameSet<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sorted_list_of_set <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* We assume for the next lemma that f has value in numbers, and sum f A is
   sum f(x) for x in A. *)</span>
<span class="keyword1" id="MiscTools-lm032"><span class="command">lemma</span></span> lm032<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD2 Int_iff Un_Diff_Int Un_commute finite_Un sum.union_inter_neutral<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> sumOutside<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">g</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>sum <span class="free">f</span> <span class="main">(</span><span class="free">g</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Outside_def restrict_def <span class="keyword1"><span class="command">using</span></span> assms add.commute inf_commute lm032 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="MiscTools-lm033"><span class="command">lemma</span></span> lm033<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">P</span> <span class="main">⊆</span> Domain <span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm034"><span class="command">lemma</span></span> lm034<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">=</span><span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">P</span> <span class="main">⊆</span> Domain <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms paste_def Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm035"><span class="command">lemma</span></span> lm035<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">P</span> <span class="main">⊆</span> Domain <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">=</span><span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm033 lm034 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">||</span><span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">+*</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_lower2 restrictedDomain lm035<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm036"><span class="command">lemma</span></span> lm036<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">||</span><span class="free">X</span>   <span class="main">=</span>   <span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span>Domain <span class="free">P</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm037"><span class="command">lemma</span></span> lm037<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span>    <span class="free">P</span> <span class="main">||</span> <span class="main">(</span><span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span><span class="main">-</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm036 lm016 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute restrictedDomain outside_reduces_domain<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm038"><span class="command">lemma</span></span> lm038<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">Q</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm036
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint Domain_empty_iff Int_Diff inf_commute restrictedDomain     
            outside_reduces_domain restrict_empty<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm039"><span class="command">lemma</span></span> lm039<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Q</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm038 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm040"><span class="command">lemma</span></span> lm040<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Q</span> <span class="main">||</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>   <span class="main">&amp;</span>   <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Q</span> <span class="main">||</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def restrict_def lm039 lm015 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm041"><span class="command">lemma</span></span> lm041<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">outside</span> <span class="free">X</span>    <span class="main">=</span>    <span class="free">P</span> <span class="main">||</span> <span class="main">(</span><span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def restrict_def  lm037 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm042"><span class="command">lemma</span></span> lm042<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* x is a (non-empty) element of the family XX whose union is a subset of X *)</span>
<span class="keyword1" id="MiscTools-lm043"><span class="command">lemma</span></span> lm043<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">XX</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">XX</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Note that set converts lists such as L1 into sets. L1 is here a list of lists and l an element, that is, a list. We assume furthermore that f2 is constant function with the fixed 2nd argument N. Then we can convert lists to sets in a canonical way. *)</span>
<span class="keyword1" id="MiscTools-lm044"><span class="command">lemma</span></span> lm044<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> set <span class="free">L1</span><span class="main">.</span> set <span class="free">L2</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span>set <span class="free">L2</span><span class="main">.</span> l <span class="main">&lt;-</span> <span class="free">L1</span><span class="main">]</span>  <span class="main">=</span>  <span class="main">{</span><span class="free">f2</span> <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="free">L1</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Two Variants of the previous lemma *)</span>
<span class="keyword1" id="MiscTools-setVsList"><span class="command">lemma</span></span> setVsList<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">g1</span> <span class="free">G</span><span class="main">)</span><span class="main">.</span> set <span class="main">(</span><span class="free">g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span>set <span class="main">(</span><span class="free">g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span><span class="main">.</span> l <span class="main">&lt;-</span> <span class="main">(</span><span class="free">g1</span> <span class="free">G</span><span class="main">)</span><span class="main">]</span>  <span class="main">=</span>  <span class="main">{</span><span class="free">f2</span> <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span><span class="free">g1</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm045"><span class="command">lemma</span></span> lm045<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">g1</span> <span class="free">G</span><span class="main">)</span><span class="main">.</span> set <span class="main">(</span><span class="free">g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">N</span><span class="main">)</span> <span class="main">--&gt;</span>  
     <span class="main">{</span><span class="free">f2</span> <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span><span class="free">g1</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> set <span class="main">[</span>set <span class="main">(</span><span class="free">g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span><span class="main">.</span> l <span class="main">&lt;-</span> <span class="free">g1</span> <span class="free">G</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm046"><span class="command">lemma</span></span> lm046<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span>  <span class="main">=</span>  <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">Y</span><span class="main">)</span><span class="main">``</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm047"><span class="command">lemma</span></span> lm047<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Range <span class="free">P</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Range <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">Q</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span><span class="main">^-1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain_converse converse_Un disj_Un_runiq<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm048"><span class="command">lemma</span></span> lm048<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Range <span class="free">P</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Range <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">Q</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span><span class="main">^-1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm047 assms subrel_runiq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse converse_subset_swap paste_sub_Un<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm049"><span class="command">lemma</span></span> lm049<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms card_Suc_eq One_nat_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_within_domain' Suc_neq_Zero assms rightUniqueSetCardinality<span class="main">)</span>

<span class="comment1">(* triples a can be bracket in any way, i.e., (1st, (2nd, 3rd)) → ((1st, 2nd), 3rd).*)</span>
<span class="keyword1" id="MiscTools-lm050"><span class="command">lemma</span></span> lm050<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>fst <span class="bound">a</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injI<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm051"><span class="command">lemma</span></span> lm051<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> Max <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Max.coboundedI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm052"><span class="command">lemma</span></span> lm052<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_in finite_imageI image_is_empty<span class="main">)</span>

<span class="comment1">(* Note that in the following -` means the inverse image of the following set. *)</span>
<span class="keyword1" id="MiscTools-lm053"><span class="command">lemma</span></span> lm053<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-lm054"><span class="command">lemma</span></span> lm054<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"argmax <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm055"><span class="command">lemma</span></span> lm055<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> argmax <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">&amp;</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> argmax.simps mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-rangeEmpty"><span class="command">lemma</span></span> rangeEmpty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="main">-`</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-finitePairSecondRange"><span class="command">lemma</span></span> finitePairSecondRange<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> finite <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Range <span class="free">R</span><span class="main">.</span> finite <span class="bound">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm056"><span class="command">lemma</span></span> lm056<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> snd <span class="main">`</span> <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-lm057"><span class="command">lemma</span></span> lm057<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fst <span class="free">pair</span> <span class="main">=</span> snd <span class="main">(</span>flip <span class="free">pair</span><span class="main">)</span> <span class="main">&amp;</span> snd <span class="free">pair</span> <span class="main">=</span> fst <span class="main">(</span>flip <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> flip_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-flip_flip2"><span class="command">lemma</span></span> flip_flip2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"flip <span class="main">∘</span> flip   <span class="main">=</span>   id"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> flip_flip <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm058"><span class="command">lemma</span></span> lm058<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fst <span class="main">=</span> <span class="main">(</span>snd<span class="main">∘</span>flip<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm057 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm059"><span class="command">lemma</span></span> lm059<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"snd <span class="main">=</span> <span class="main">(</span>fst<span class="main">∘</span>flip<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm057 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm060"><span class="command">lemma</span></span> lm060<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on fst <span class="free">P</span> <span class="main">=</span> inj_on <span class="main">(</span>snd<span class="main">∘</span>flip<span class="main">)</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm058 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm062"><span class="command">lemma</span></span> lm062<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on fst <span class="free">P</span> <span class="main">=</span> inj_on snd <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm060 flip_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse inj_on_imageI lm059<span class="main">)</span>

<span class="keyword1" id="MiscTools-sumPairsInverse"><span class="command">lemma</span></span> sumPairsInverse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="free">P</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span>Range <span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm062 converse_converse rightUniqueInjectiveOnFirst rightUniqueInjectiveOnFirst
        sum.reindex snd_eq_Range 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-notEmptyFinestpart"><span class="command">lemma</span></span> notEmptyFinestpart<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finestpart <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm063"><span class="command">lemma</span></span> lm063<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.reindex<span class="main">)</span>

<span class="keyword1" id="MiscTools-functionOnFirstEqualsSecond"><span class="command">lemma</span></span> functionOnFirstEqualsSecond<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">,,</span><span class="main">(</span>fst <span class="free">z</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">z</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rightUniquePair surjective_pairing<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm064"><span class="command">lemma</span></span> lm064<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="free">R</span><span class="main">)</span> <span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">=</span> sum snd <span class="free">R</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms toFunction_def sum.reindex_cong functionOnFirstEqualsSecond
        rightUniqueInjectiveOnFirst 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> fst_eq_Domain<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm065<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm064 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute restrictedDomain<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm066"><span class="command">lemma</span></span> lm066<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span><span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_idemp ImageE Range.intros Range_outside_sub_Image_Domain lm041
            lm042 order_class.order.antisym subsetI<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm067"><span class="command">lemma</span></span> lm067<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">||</span><span class="free">X</span><span class="main">)</span> <span class="main">``</span> <span class="free">X</span> <span class="main">=</span> <span class="free">R</span><span class="main">``</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Int_absorb doubleRestriction restrictedRange <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm068"><span class="command">lemma</span></span> lm068<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms doubleRestriction restrictedRange Int_empty_right Int_iff 
        Int_insert_right_if1 restrictedDomain 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm069"><span class="command">lemma</span></span> lm069<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">,,</span><span class="free">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">,,</span><span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms doubleRestriction restrictedRange Int_empty_right Int_iff Int_insert_right_if1
        eval_rel.simps 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm070"><span class="command">lemma</span></span> lm070<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sum.cong lm069 toFunction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> sumRestrictedToDomainInvariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm065 lm070 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> sumRestrictedOnFunction<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> Domain <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm064 restrictedDomain Int_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-cardFinestpart"><span class="command">lemma</span></span> cardFinestpart<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>finestpart <span class="free">X</span><span class="main">)</span> <span class="main">=</span> card <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> card_image inj_on_inverseI the_elem_eq<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm071<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finestpart <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>    <span class="main">&amp;</span>    card <span class="main">∘</span> finestpart <span class="main">=</span> card"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> cardFinestpart finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-finiteFinestpart"><span class="command">lemma</span></span> finiteFinestpart<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>finestpart <span class="free">X</span><span class="main">)</span> <span class="main">=</span> finite <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def lm071 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_eq_0_iff empty_is_image finite.simps cardFinestpart<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm072"><span class="command">lemma</span></span> lm072<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">∘</span> finestpart <span class="main">=</span> finite"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finiteFinestpart <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-finestpartSubset"><span class="command">lemma</span></span> finestpartSubset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finestpart <span class="free">X</span> <span class="main">⊆</span> finestpart <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mono<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm073<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finestpart <span class="free">x</span> <span class="main">⊆</span> finestpart <span class="main">(</span><span class="main">⋃</span> <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finestpartSubset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm074"><span class="command">lemma</span></span> lm074<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>finestpart <span class="main">`</span> <span class="free">XX</span><span class="main">)</span> <span class="main">⊆</span> finestpart <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def lm073 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-lm075"><span class="command">lemma</span></span> lm075<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>finestpart <span class="main">`</span> <span class="free">XX</span><span class="main">)</span> <span class="main">⊇</span> finestpart <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊇</span> <span class="var">?R</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> finestpart_def <span class="keyword1"><span class="command">using</span></span> finestpart_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> commuteUnionFinestpart<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>finestpart <span class="main">`</span> <span class="free">XX</span><span class="main">)</span> <span class="main">=</span> finestpart <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm074 lm075 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-unionImage"><span class="command">lemma</span></span> unionImage<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span> <span class="main">=</span> 
         <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">a</span><span class="main">,,</span><span class="bound">x</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Image_runiq_eq_eval 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> cSup_singleton<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm076"><span class="command">lemma</span></span> lm076<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span> <span class="main">=</span> card <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueInjectiveOnFirst card_image <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain_fst<span class="main">)</span>

<span class="keyword1" id="MiscTools-finiteDomainImpliesFinite"><span class="command">lemma</span></span> finiteDomainImpliesFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Domain <span class="free">f</span><span class="main">)</span> <span class="main">=</span> finite <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Domain_empty_iff card_eq_0_iff finite.emptyI lm076 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* A relation for the sum of all y∈Y of f(x,y) for a fixed x. *)</span>
<span class="keyword1" id="MiscTools-sumCurry"><span class="command">lemma</span></span> sumCurry<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">(</span>curry <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">%</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>curry <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span><span class="main">=</span><span class="quoted"><span class="free">f</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Pair_inject inj_onI<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="free">Y</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">`</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟶</span> <span class="var">?g</span> <span class="bound">y</span> <span class="main">=</span> <span class="var">?h</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum.reindex_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-lm077"><span class="command">lemma</span></span> lm077<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">%</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sumCurry Sigma_cong curry_def sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm078<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>sum <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Diff_iff IntD2 Un_Diff_Int finite_Un inf_commute sum.union_inter_neutral 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm079"><span class="command">lemma</span></span> lm079<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span><span class="main">``</span><span class="main">(</span>Domain <span class="free">Q</span><span class="main">∩</span><span class="free">X</span><span class="main">)</span>  <span class="main">=</span>  <span class="free">Q</span><span class="main">``</span><span class="main">(</span>Domain <span class="free">Q</span><span class="main">∩</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def Outside_def Image_def Domain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm080<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span>  <span class="free">Q</span><span class="main">``</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Int_commute lm079 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm017<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm081<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">``</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">``</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms paste_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm082"><span class="command">lemma</span></span> lm082<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∩</span><span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="free">Y</span><span class="main">)</span><span class="main">``</span><span class="free">X</span><span class="main">=</span><span class="free">P</span><span class="main">``</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm083<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∩</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span><span class="main">``</span><span class="free">X</span><span class="main">=</span><span class="free">P</span><span class="main">``</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm081 lm082 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm084"><span class="command">lemma</span></span> lm084<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> card <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_lower1 Int_lower2 card_seteq order_refl<span class="main">)</span>

<span class="keyword1" id="MiscTools-cardinalityIntersectionEquality"><span class="command">lemma</span></span> cardinalityIntersectionEquality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">X</span> <span class="main">=</span> card <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> card <span class="free">X</span><span class="main">)</span>     <span class="main">=</span>    <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm084 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_seteq le_iff_inf order_refl<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm085"><span class="command">lemma</span></span> lm085<span class="main">:</span> <span class="comment1">(*fixes f::"'a =&gt; 'b" fixes P::"'a =&gt; bool" fixes xx::"'a"*)</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xx</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">,,</span><span class="free">xx</span>   <span class="main">=</span>   <span class="free">f</span> <span class="free">xx</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?F</span><span class="main">``</span><span class="main">{</span><span class="free">xx</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span><span class="main">=</span><span class="main">{</span><span class="free">f</span> <span class="free">xx</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Image_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-graphEqImage"><span class="command">lemma</span></span> graphEqImage<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">X</span> <span class="free">f</span><span class="main">,,</span><span class="free">x</span>   <span class="main">=</span>   <span class="free">f</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def <span class="keyword1"><span class="command">using</span></span> assms lm085 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Gr_def<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm086"><span class="command">lemma</span></span> lm086<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Graph <span class="free">f</span><span class="main">,,</span><span class="free">x</span>    <span class="main">=</span>    <span class="free">f</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> UNIV_I graphEqImage lm005 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-lm087"><span class="command">lemma</span></span> lm087<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"toFunction <span class="main">(</span>Graph <span class="free">f</span><span class="main">)</span>    <span class="main">=</span>    <span class="free">f</span>"</span></span>    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="main">_</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">x</span><span class="main">=</span><span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> toFunction_def lm086 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-lm088"><span class="command">lemma</span></span> lm088<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">outside</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outside_union_restrict subset_Un_eq sup_left_idem<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm089"><span class="command">lemma</span></span> lm089<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range<span class="main">(</span><span class="free">f</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">-</span><span class="main">(</span><span class="free">f</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm090"><span class="command">lemma</span></span> lm090<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">¯</span><span class="main">``</span><span class="main">(</span><span class="main">(</span>Range <span class="free">P</span><span class="main">)</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">¯</span><span class="main">)</span><span class="main">``</span><span class="free">Y</span><span class="main">)</span>   <span class="main">=</span>   <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueFunctionAfterInverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm091"><span class="command">lemma</span></span> lm091<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">P</span><span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">``</span><span class="main">(</span><span class="main">(</span>Domain <span class="free">P</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>  <span class="main">=</span>  <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueFunctionAfterInverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm092"><span class="command">lemma</span></span> lm092<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Range<span class="main">(</span><span class="free">f</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">-</span><span class="main">(</span><span class="free">f</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Diff_triv lm091 lm066 Diff_iff ImageE Range_iff subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1" id="MiscTools-rangeOutside"><span class="command">lemma</span></span> rangeOutside<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Range<span class="main">(</span><span class="free">f</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">-</span><span class="main">(</span><span class="free">f</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm089 lm092 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_class.order.antisym<span class="main">)</span>

<span class="comment1">(* X and Y are family of sets such that any x and y in X and Y resp. are disjoint. *)</span>
<span class="keyword1" id="MiscTools-unionIntersectionEmpty"><span class="command">lemma</span></span> unionIntersectionEmpty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">Y</span><span class="main">.</span> <span class="bound">x</span><span class="main">∩</span><span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span><span class="main">∩</span><span class="main">(</span><span class="main">⋃</span> <span class="free">Y</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-setEqualityAsDifference"><span class="command">lemma</span></span> setEqualityAsDifference<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">=</span>  <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm093"><span class="command">lemma</span></span> lm093<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">R</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm095"><span class="command">lemma</span></span> lm095<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="main">(</span>Domain <span class="free">R</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>Range <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-finiteRelationCharacterization"><span class="command">lemma</span></span> finiteRelationCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span> <span class="main">&amp;</span> finite <span class="main">(</span>Range <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> finite <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev_finite_subset finite_SigmaI lm095 finite_Domain finite_Range <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-familyUnionFiniteEverySetFinite"><span class="command">lemma</span></span> familyUnionFiniteEverySetFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">XX</span><span class="main">.</span> finite <span class="bound">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper finite_subset<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm096"><span class="command">lemma</span></span> lm096<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span><span class="main">``</span><span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">``</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueFunctionAfterInverse <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_mono order_refl subset_trans<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm097"><span class="command">lemma</span></span> lm097<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">,,</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_singleton_iff rightUniquePair<span class="main">)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indicator function in set-theoretical form.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Outside'</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">outside</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Chi</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">==</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>nat<span class="main">}</span><span class="main">)</span> <span class="main">+*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">notation</span></span> Chi <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;||</span>"</span> 80<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">chii</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">==</span> toFunction <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">&lt;||</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">notation</span></span> chii <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;|</span>"</span> 80<span class="main">)</span>

<span class="comment1">(* X is a set and chi X is a function that returns 1 for elements X and 0 else. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">chi</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">==</span> indicator <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="MiscTools-lm098"><span class="command">lemma</span></span> lm098<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">X</span> <span class="main">&lt;||</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm014<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm099"><span class="command">lemma</span></span> lm099<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span> <span class="main">&lt;||</span> <span class="free">Y</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms toFunction_def paste_def Outside_def runiq_def lm014 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm100"><span class="command">lemma</span></span> lm100<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span><span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span> <span class="main">&lt;||</span> <span class="free">Y</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms toFunction_def paste_def Outside_def runiq_def lm014 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm101"><span class="command">lemma</span></span> lm101<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">&lt;||</span> <span class="free">Y</span><span class="main">)</span><span class="main">,,</span><span class="free">x</span> <span class="main">=</span> chi <span class="free">X</span> <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm014 lm099 lm100 lm097 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI Un_iff indicator_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> indicator_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-lm102"><span class="command">lemma</span></span> lm102<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> chi <span class="free">X</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms toFunction_def lm101 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm103<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>chi <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm102 sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm104<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> sum <span class="free">g</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> sum.cong<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm105<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span><span class="main">⊆</span><span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">Y</span> <span class="main">=</span> sum <span class="free">g</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm104 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm106<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span> <span class="main">=</span> sum <span class="main">(</span>chi <span class="free">X</span><span class="main">)</span> <span class="free">Z</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">Z</span><span class="main">.</span><span class="main">(</span><span class="free">X</span><span class="main">&lt;|</span><span class="free">Y</span><span class="main">)</span> <span class="bound">x</span><span class="main">=</span><span class="main">(</span>chi <span class="free">X</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm102 in_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm104 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm107<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span>chi <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> lm108<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm107 lm106 Diff_iff in_mono subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm109<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span>    <span class="main">=</span>    sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span>   <span class="main">+</span>  <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm078 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm110<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm078 lm108 comm_monoid_add_class.add_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm111<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>chi <span class="free">X</span><span class="main">)</span> <span class="free">Z</span> <span class="main">=</span> card <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Z</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sum_indicator_eq_card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm112<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span> <span class="main">=</span> card <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm111 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm106 sum_indicator_eq_card<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subsetCardinality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> card <span class="free">X</span> <span class="main">-</span> card <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm112 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb2 Un_upper1 card.infinite equalityE sum.infinite<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> differenceSumVsCardinality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span>  int <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>card <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm112 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb2 Un_upper1 card.infinite equalityE sum.infinite<span class="main">)</span>

<span class="comment1">(* type conversion in Isabelle *)</span>
<span class="keyword1" id="MiscTools-lm113"><span class="command">lemma</span></span> lm113<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> real <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* same as differenceSumVsCardinality but for type real *)</span>
<span class="keyword1"><span class="command">corollary</span></span> differenceSumVsCardinalityReal<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span><span class="main">⊆</span><span class="free">X</span><span class="main">∪</span><span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span>sum <span class="main">(</span><span class="free">X</span> <span class="main">&lt;|</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> 
         real <span class="main">(</span>card <span class="free">X</span><span class="main">)</span> <span class="main">-</span> real <span class="main">(</span>card <span class="main">(</span><span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm112 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb2 Un_upper1 card.infinite equalityE sum.infinite<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="comment1">(* If there is an element in a list satisfying P, then the list of all elements satisfying P is not the empty list *)</span>
<span class="keyword1" id="MiscTools-lm114"><span class="command">lemma</span></span> lm114<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Assume ll is an element of list l, then there is an index n such that the n-th entry of l is ll. *)</span>
<span class="keyword1" id="MiscTools-lm115"><span class="command">lemma</span></span> lm115<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">∈</span> <span class="main">(</span>nth <span class="free">l</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">.</span> <span class="free">ll</span><span class="main">=</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth vimageI2<span class="main">)</span>

<span class="comment1">(* variant of the above *)</span>
<span class="keyword1" id="MiscTools-lm116"><span class="command">lemma</span></span> lm116<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">ll</span><span class="main">=</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span> <span class="main">&amp;</span> <span class="bound">n</span> <span class="main">&lt;</span> size <span class="free">l</span> <span class="main">&amp;</span> <span class="bound">n</span> <span class="main">&gt;=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le0<span class="main">)</span>

<span class="comment1">(* another variant of the above *)</span>
<span class="keyword1" id="MiscTools-lm117"><span class="command">lemma</span></span> lm117<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">∩</span> set <span class="free">l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm116 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* variant of lm114 *)</span>
<span class="keyword1" id="MiscTools-nonEmptyListFiltered"><span class="command">lemma</span></span> nonEmptyListFiltered<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">∩</span> set <span class="free">l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms filterpositions2_def lm117 lm114 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* take the elements of a list l which are also in a set X then this forms a subset of X intersection with the elements of the list *)</span>
<span class="keyword1" id="MiscTools-lm118"><span class="command">lemma</span></span> lm118<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nth <span class="free">l</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">∩</span>set <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* variant of the above *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm119<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nth <span class="free">l</span><span class="main">)</span><span class="main">`</span> set <span class="main">(</span>filterpositions2 <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∩</span>  set <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> filterpositions2_def <span class="keyword1"><span class="command">using</span></span> lm118 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="MiscTools-lm120"><span class="command">lemma</span></span> lm120<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">N</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> atLeast0LessThan lessThan_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* If X is a set of indices then the corresponding elements combined are a subset of all the elements of the list. *)</span>
<span class="keyword1" id="MiscTools-lm121"><span class="command">lemma</span></span> lm121<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">list</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nth <span class="free">list</span><span class="main">)</span><span class="main">`</span><span class="free">X</span> <span class="main">⊆</span> set <span class="free">list</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms atLeastLessThan_def atLeast0LessThan lessThan_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* The indices of the elements of a list satisfying a predicate P are a subset of all the indices. *)</span>
<span class="keyword1" id="MiscTools-lm122"><span class="command">lemma</span></span> lm122<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">[</span><span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">]</span><span class="main">,</span> <span class="free">P</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">l</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* variant of the above *)</span>
<span class="keyword1" id="MiscTools-lm123"><span class="command">lemma</span></span> lm123<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>filterpositions2 <span class="free">pre</span> <span class="free">list</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free">list</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> filterpositions2_def lm122 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computing all the permutations of a list›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rotateLeft</span> <span class="main">==</span> rotate"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rotateRight</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">==</span> rotateLeft <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="comment1">(* for n in {0, ..., size l} inserts x in l so that it will have index n in the output*)</span>
<span class="comment1">(* note that for other n, the behaviour is not guaranteed to be consistent with that *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">insertAt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> rotateRight <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main">(</span>rotateLeft <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* for n in {0,..., fact(size l) - 1 }, 
   perm2 l n gives all and only the possible permutations of l *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">perm2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">perm2</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">perm2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> insertAt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">perm2</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="bound">n</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">takeAll</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">==</span> map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">)</span> <span class="main">(</span>filterpositions2 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="MiscTools-permutationNotEmpty"><span class="command">lemma</span></span> permutationNotEmpty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm2 <span class="free">l</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms perm2.simps<span class="main">(</span>2<span class="main">)</span> rotate_is_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm124"><span class="command">lemma</span></span> lm124<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>takeAll <span class="free">P</span> <span class="free">list</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nth <span class="free">list</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>filterpositions2 <span class="free">P</span> <span class="free">list</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> listIntersectionWithSet<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">⊆</span>  <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> set <span class="free">l</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm119 lm124 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm125<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>takeAll <span class="free">P</span> <span class="free">list</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">list</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm123 lm124 lm121 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-takeAllSubset"><span class="command">lemma</span></span> takeAllSubset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="free">list</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_subset_iff listIntersectionWithSet<span class="main">)</span> 

<span class="keyword1" id="MiscTools-lm126"><span class="command">lemma</span></span> lm126<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>insertAt <span class="free">x</span> <span class="free">l</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-lm127"><span class="command">lemma</span></span> lm127<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> set <span class="main">(</span>perm2 <span class="main">[]</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> set <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-lm128"><span class="command">lemma</span></span> lm128<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>set <span class="main">(</span>perm2 <span class="free">l</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>perm2 <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm126 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* Combining the previous two lemmas we get inductively that the set of elements in a permuted list are the same as the elements in the original list. This is weaker than saying (perm2 l n) is a permutation of l, but suffices for our purposes. *)</span> 
<span class="keyword1"><span class="command">corollary</span></span> permutationInvariance<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> set <span class="main">(</span>perm2 <span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">l</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> set <span class="main">(</span>perm2 <span class="bound">l</span> <span class="bound">n</span><span class="main">)</span>  <span class="main">=</span>  set <span class="bound">l</span><span class="main">)</span>"</span></span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm127 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> 
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> 
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* variant of listIntersectionWithSet with permutation added *)</span>
<span class="keyword1"><span class="command">corollary</span></span> takeAllPermutation<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>perm2 <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>  <span class="main">⊆</span>  <span class="free">X</span> <span class="main">∩</span> set <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> listIntersectionWithSet permutationInvariance <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* "subList list1 list2" extracts the components of list1 according to the indices given in list2, e.g.,  "subList [1::nat,2,3,4] [0,2]" gives [1,3] *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">subList</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">xl</span></span></span> <span class="main">==</span> map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xl</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A more computable version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">toFunction</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="comment1">(* If R is a relation and the image of x is unique then take that, else take the fallback *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">toFunctionWithFallback</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">fallback</span></span></span> <span class="main">==</span> 
              <span class="main">(</span><span class="main">%</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,,</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fallback</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> 
  toFunctionWithFallback <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">Else</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sum'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum'</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">==</span> sum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="MiscTools-lm129"><span class="command">lemma</span></span> lm129<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_runiq_eq_eval toFunction_def<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm130"><span class="command">lemma</span></span> lm130<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="main">(</span>Domain <span class="free">f</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span>  sum <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="main">(</span>Domain <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sum.cong lm129 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm131"><span class="command">lemma</span></span> lm131<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">-`</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">Y</span>  <span class="main">=</span>  <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_subsetD sum.neutral vimage_singleton_eq<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm132"><span class="command">lemma</span></span> lm132<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">-`</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Int_lower2 add.comm_neutral assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> lm078 lm131 order_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* - means the complement of a set. *)</span>
<span class="keyword1" id="MiscTools-lm133"><span class="command">lemma</span></span> lm133<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span>Domain <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span><span class="main">-`</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm134<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free">X</span>    <span class="main">=</span>   sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">=</span><span class="free">X</span><span class="main">-</span><span class="main">(</span><span class="main">-</span>Domain <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms lm133 lm132 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm135<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">)</span>   <span class="main">=</span>   sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span><span class="main">=</span><span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm134<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm136<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> sum <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lm130 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm135<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-lm137"><span class="command">lemma</span></span> lm137<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="keyword1">Else</span> <span class="main">0</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> sum' <span class="free">f</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm138<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span>Domain <span class="free">f</span><span class="main">)</span>   <span class="main">=</span>   sum' <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm137 lm136 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="MiscTools-lm139"><span class="command">lemma</span></span> lm139<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"argmax <span class="main">(</span>sum' <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>argmax <span class="main">∘</span> sum'<span class="main">)</span> <span class="free">b</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-domainConstant"><span class="command">lemma</span></span> domainConstant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">Y</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>nat<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">&amp;</span> Domain <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-domainCharacteristicFunction"><span class="command">lemma</span></span> domainCharacteristicFunction<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">X</span> <span class="main">&lt;||</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> domainConstant paste_Domain sup_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-functionEquivalenceOnSets"><span class="command">lemma</span></span> functionEquivalenceOnSets<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">X</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cardinalities of sets.›</span></span>
<span class="keyword1" id="MiscTools-lm140"><span class="command">lemma</span></span> lm140<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">R</span><span class="main">^-1</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">A</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms rightUniqueInjectiveOnFirst converse_Image <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="MiscTools-intersectionEmptyRelationIntersectionEmpty"><span class="command">lemma</span></span> intersectionEmptyRelationIntersectionEmpty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">R</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X1</span> <span class="main">∩</span> <span class="free">X2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">X1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">X2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disj_Domain_imp_disj_Image inf_assoc inf_bot_right<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm141"><span class="command">lemma</span></span> lm141<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="free">f</span> <span class="main">``</span> <span class="main">(</span><span class="free">f</span><span class="main">^-1</span> <span class="main">``</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rightUniqueFunctionAfterInverse trivial_subset<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm142"><span class="command">lemma</span></span> lm142<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> trivial_empty_or_singleton card_Pow Pow_empty assms trivial_implies_finite
        cardinalityOneTheElemIdentity power_one_right the_elem_eq 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm143"><span class="command">lemma</span></span> lm143<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pow_bottom Pow_top cardinalityOneTheElemIdentity singletonD<span class="main">)</span>

<span class="comment1">(* Note that in Isabelle infinite sets have cardinality 0 *)</span> 
<span class="keyword1" id="MiscTools-lm144"><span class="command">lemma</span></span> lm144<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span>finite <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lm145<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm144 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm146"><span class="command">lemma</span></span> lm146<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span><span class="main">=</span>Discrete.log <span class="main">(</span>card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms log_exp card_Pow <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.infinite finite_Pow_iff<span class="main">)</span>

<span class="keyword1" id="MiscTools-log_2"><span class="command">lemma</span></span> log_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Discrete.log <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> log_exp <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-lm147"><span class="command">lemma</span></span> lm147<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm146 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MiscTools-lm148"><span class="command">lemma</span></span> lm148<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> card <span class="main">(</span>Pow <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trivial <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms trivial_empty_or_singleton lm143 lm147 cardinalityOneTheElemIdentity <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm149"><span class="command">lemma</span></span> lm149<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"trivial <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm148 lm142 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MiscTools-lm150"><span class="command">lemma</span></span> lm150<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">f</span> <span class="main">=</span> Domain <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subrel_runiq<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm151"><span class="command">lemma</span></span> lm151<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊆</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">f</span> <span class="main">=</span> Domain <span class="free">g</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊆</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Domain_iff contra_subsetD runiq_wrt_ex1 subrelI
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span>hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-lm152"><span class="command">lemma</span></span> lm152<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">f</span> <span class="main">⊆</span> Domain <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">R</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm151 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domain_mono dual_order.antisym<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm153"><span class="command">lemma</span></span> lm153<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"graph <span class="free">X</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>Graph <span class="free">f</span><span class="main">)</span> <span class="main">||</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> inf_top.left_neutral lm005 domainOfGraph restrictedDomain lm152 graphIntersection
        restriction_is_subrel subrel_runiq subset_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="MiscTools-lm154"><span class="command">lemma</span></span> lm154<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"graph <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span> <span class="main">||</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> doubleRestriction lm153 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-restrictionVsIntersection"><span class="command">lemma</span></span> restrictionVsIntersection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X2</span><span class="main">}</span> <span class="main">||</span> <span class="free">X1</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X2</span> <span class="main">∩</span> <span class="free">X1</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> graph_def lm154 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm155"><span class="command">lemma</span></span> lm155<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> Domain <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">X</span> <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">||</span><span class="free">X</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊆</span> <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">∩</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute inf.absorb1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"graph <span class="free">X</span> <span class="main">(</span>toFunction <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">||</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> doubleRestriction lm004 lm153<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-lm156"><span class="command">lemma</span></span> lm156<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Graph <span class="free">f</span><span class="main">)</span> <span class="main">``</span> <span class="free">X</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Graph_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MiscTools-lm157"><span class="command">lemma</span></span> lm157<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> Domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">``</span><span class="free">X</span> <span class="main">=</span> <span class="main">(</span>eval_rel <span class="free">f</span><span class="main">)</span><span class="main">`</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm156 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrictedRange lm153 lm155 toFunction_def<span class="main">)</span>

<span class="keyword1" id="MiscTools-cardOneImageCardOne"><span class="command">lemma</span></span> cardOneImageCardOne<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms card_image card_image_le 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms One_nat_def Suc_not_Zero card.infinite finite_imageI 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms card_image_le One_nat_def Suc_not_Zero card.infinite
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms image_empty image_insert 
                                    cardinalityOneTheElemIdentity the_elem_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MiscTools-cardOneTheElem"><span class="command">lemma</span></span> cardOneTheElem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>the_elem <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms image_empty image_insert the_elem_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cardinalityOneTheElemIdentity<span class="main">)</span>

<span class="comment1">(* With split being the inverse of curry we have with g as swap f,  (g x y) = (f y x) *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">swap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">==</span> curry <span class="main">(</span><span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">∘</span> flip<span class="main">)</span>"</span></span> <span class="comment1">(*swaps the two arguments of a function*)</span>

<span class="comment1">(* X is finite if and only if X is the set of elements of some list. *)</span>
<span class="keyword1" id="MiscTools-lm158"><span class="command">lemma</span></span> lm158<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span>   <span class="main">=</span>  <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> range set<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set finite_list image_iff rangeI<span class="main">)</span>

<span class="comment1">(* as above, just as lambda expression *)</span>
<span class="keyword1" id="MiscTools-lm159"><span class="command">lemma</span></span> lm159<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span>range set<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm158 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="MiscTools-lm160"><span class="command">lemma</span></span> lm160<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"swap <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="main">%</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_eq_dest_lhs curry_def flip_def fst_conv old.prod.case snd_conv<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some easy properties on real numbers›</span></span>
<span class="keyword1" id="MiscTools-lm161"><span class="command">lemma</span></span> lm161<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">real</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">c</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">*</span><span class="free">c</span><span class="main">=</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">b</span><span class="main">-</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> real_scaleR_def real_vector.scale_right_diff_distrib<span class="main">)</span>

<span class="keyword1" id="MiscTools-lm162"><span class="command">lemma</span></span> lm162<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">real</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">c</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">*</span><span class="free">b</span><span class="main">=</span><span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">c</span><span class="main">)</span><span class="main">*</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm161 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="StrictCombinatorialAuction">
<div class="head">
<h1>Theory StrictCombinatorialAuction</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;


Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definitions about those Combinatorial Auctions which are strict (i.e., which assign all the available goods)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> StrictCombinatorialAuction
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="Partitions.html">Partitions</a>
  <a href="MiscTools.html">MiscTools</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> index <span class="main">=</span> <span class="quoted"><span class="quoted">"integer"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> participant <span class="main">=</span> <span class="quoted">index</span>
<span class="keyword1"><span class="command">type_synonym</span></span> good <span class="main">=</span> <span class="quoted"><span class="quoted">"integer"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> goods <span class="main">=</span> <span class="quoted"><span class="quoted">"good set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> price <span class="main">=</span> <span class="quoted">real</span>
<span class="keyword1"><span class="command">type_synonym</span></span> bids3 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>participant <span class="main">×</span> goods<span class="main">)</span> <span class="main">×</span> price<span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> bids <span class="main">=</span> <span class="quoted"><span class="quoted">"participant <span class="main">⇒</span> goods <span class="main">⇒</span> price"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> allocation_rel <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>goods <span class="main">×</span> participant<span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> allocation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>participant <span class="main">×</span> goods<span class="main">)</span> set"</span></span> 
<span class="keyword1"><span class="command">type_synonym</span></span> payments <span class="main">=</span> <span class="quoted"><span class="quoted">"participant <span class="main">⇒</span> price"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> bidvector <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>participant <span class="main">×</span> goods<span class="main">)</span> <span class="main">⇒</span> price"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bidvector</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">::</span>bids<span class="main">)</span> <span class="main">==</span> case_prod <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">proceeds</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">::</span>bidvector<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">allo</span></span></span><span class="main">::</span>allocation<span class="main">)</span> <span class="main">==</span> sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">allo</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">winnersOfAllo</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span>allocation<span class="main">)</span> <span class="main">==</span> Domain <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">allocatedGoods</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">allo</span></span></span><span class="main">::</span>allocation<span class="main">)</span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="free"><span class="bound"><span class="entity">allo</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* possible_allocations_rel defines all possible allocations of a set of goods G to a set of participants N: 
  injective functions that map sets of goods to their potential buyers, i.e.\ participants.
  Here, we assume that everything gets allocated, i.e. that there is no free disposal.
  This assumption facilitates the paper↔algorithm equivalence proof for injective functions.
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">possible_allocations_rel</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">possible_allocations_rel</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> Union <span class="main">{</span> injections <span class="bound">Y</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">|</span> <span class="bound">Y</span> <span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> all_partitions <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">}</span>"</span></span> 

<span class="comment1">(* The following abbreviations duplicate the corresponding definitions in RelationProperties.thy. This is done since typically abbreviations are efficient in theorem proving, however, not in code extraction. *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_partition_of'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">==</span> <span class="main">(</span><span class="main">⋃</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> is_non_overlapping <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_partitions'</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="bound">P</span> <span class="main">.</span> is_partition_of' <span class="bound">P</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">possible_allocations_rel'</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">==</span> Union<span class="main">{</span>injections <span class="bound">Y</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">|</span> <span class="bound">Y</span> <span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> all_partitions' <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">allAllocations</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">allAllocations</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> converse <span class="main">`</span> <span class="main">(</span>possible_allocations_rel <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹algorithmic version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> possible_allocations_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">possible_allocations_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"goods <span class="main">⇒</span> participant set <span class="main">⇒</span> allocation_rel list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">possible_allocations_alg</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> 
         concat <span class="main">[</span> injections_alg <span class="bound">Y</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">.</span> Y <span class="main">←</span> all_partitions_alg <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">allAllocationsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> 
              map converse <span class="main">(</span>concat <span class="main">[</span><span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">.</span> l <span class="main">←</span> all_partitions_list <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹VCG mechanism›</span></span>

<span class="comment1">(* N is the set of bidders, G the set of goods, and b the bidvector *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">winningAllocationsRel</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> 
              argmax <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>allAllocations <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* t is a tie breaking function *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">winningAllocationRel</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>winningAllocationsRel <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is the computational version of winningAllocationsRel *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">winningAllocationsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> argmaxList <span class="main">(</span>proceeds <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>allAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is the computational version of winningAllocationRel *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">winningAllocationAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>winningAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹payments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹alpha is the maximum sum of bids of all bidders except bidder <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>'s bid, computed over all possible allocations of all goods,
  i.e. the value reportedly generated by value maximization when solved without n's bids›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">alpha</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> Max <span class="main">(</span><span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>allAllocations <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* computational version of alpha *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphaAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> Max <span class="main">(</span><span class="main">(</span>proceeds <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>set <span class="main">(</span>allAllocationsAlg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">::</span><span class="main">_</span> list<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* revenue with participant n removed from winning allocation *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">remainingValueRel</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">(</span>winningAllocationRel <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">--</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* computational version of remainingValueRel *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">remainingValueAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> proceeds <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">(</span>winningAllocationAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">--</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* function to determine payments for each participant *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">paymentsRel</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> <span class="main">(</span>alpha <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>remainingValueRel <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* computational version of paymentsRel *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">paymentsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> <span class="main">(</span>alphaAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>remainingValueAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Universes">
<div class="head">
<h1>Theory Universes</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;


Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sets of injections, partitions, allocations expressed as suitable subsets of the corresponding universes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Universes

<span class="keyword2"><span class="keyword">imports</span></span> 
<span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
<a href="StrictCombinatorialAuction.html">StrictCombinatorialAuction</a> 
<span class="quoted">"<a href="../../HOL/HOL-Library/Indicator_Function.html">HOL-Library.Indicator_Function</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary lemmas›</span></span>

<span class="keyword1" id="Universes-lm001"><span class="command">lemma</span></span> lm001<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_alg <span class="free">X</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_sorted_list_of_set all_partitions_alg_def all_partitions_equivalence'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* This is a variant of the bridging theorem that the classical and constructive definitions of all_partitions characterize the same set *)</span>
<span class="keyword1" id="Universes-lm002"><span class="command">lemma</span></span> lm002<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_partitions <span class="free">G</span>  <span class="main">=</span>  set <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>all_partitions_alg <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sortingSameSet all_partitions_alg_def all_partitions_paper_equiv_alg
        distinct_sorted_list_of_set image_set 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions of various subsets of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">UNIV</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="comment1">(* For with R = {({1,2},2), ({2,3},3)} is a choice relation, choosing one element of the set. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">isChoice</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">partitionsUniverse</span> <span class="main">==</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> is_non_overlapping <span class="bound">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partitionsUniverse <span class="main">⊆</span> Pow UNIV"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>       

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">partitionValuedUniverse</span> <span class="main">==</span> <span class="main">⋃</span> <span class="bound">P</span> <span class="main">∈</span> partitionsUniverse<span class="main">.</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"partitionValuedUniverse <span class="main">⊆</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>Pow UNIV<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">injectionsUniverse</span> <span class="main">==</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> <span class="main">(</span>runiq <span class="bound">R</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span>runiq <span class="main">(</span><span class="bound">R</span><span class="main">^-1</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="comment1">(* allocations are injections so that goods are allocated at most once and the range from a partition of the goods. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">allocationsUniverse</span> <span class="main">==</span> injectionsUniverse <span class="main">∩</span> partitionValuedUniverse"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">totalRels</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> Domain <span class="bound">R</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">&amp;</span> Range <span class="bound">R</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">}</span>"</span></span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Results about the sets defined in the previous section›</span></span>

<span class="keyword1" id="Universes-lm003"><span class="command">lemma</span></span> lm003<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x1</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x2</span> <span class="main">∈</span> <span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="bound">x1</span><span class="main">}</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">∩</span> <span class="bound">x2</span>  <span class="main">=</span>  <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm004"><span class="command">lemma</span></span> lm004<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"isChoice <span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_within_domain' empty_subsetI insert_subset graphEqImage domainOfGraph 
            runiq_wrt_eval_rel subset_trans<span class="main">)</span>

<span class="keyword1" id="Universes-lm006"><span class="command">lemma</span></span> lm006<span class="main">:</span> <span class="quoted"><span class="quoted">"injections <span class="free">X</span> <span class="free">Y</span> <span class="main">⊆</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm007"><span class="command">lemma</span></span> lm007<span class="main">:</span> <span class="quoted"><span class="quoted">"injections <span class="free">X</span> <span class="free">Y</span> <span class="main">⊆</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm008"><span class="command">lemma</span></span> lm008<span class="main">:</span> <span class="quoted"><span class="quoted">"injections <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> totalRels <span class="free">X</span> <span class="free">Y</span> <span class="main">∩</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq Int_assoc<span class="main">)</span>

<span class="keyword1" id="Universes-allocationInverseRangeDomainProperty"><span class="command">lemma</span></span> allocationInverseRangeDomainProperty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">^-1</span> <span class="main">∈</span> injections <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="free">N</span> <span class="main">&amp;</span> 
          <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="keyword1">partitions</span> <span class="free">G</span> <span class="main">&amp;</span> 
          Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">using</span></span> assms all_partitions_def injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm009"><span class="command">lemma</span></span> lm009<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">XX</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">YY</span> <span class="main">⊆</span> <span class="free">XX</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">XX</span> <span class="main">-</span> <span class="free">YY</span><span class="main">)</span> <span class="keyword1">partitions</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span> <span class="main">-</span> <span class="main">⋃</span> <span class="free">YY</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xx</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">XX</span> <span class="main">-</span> <span class="free">YY</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">XX</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="free">YY</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">-</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">YY</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="var">?xx</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∩</span> <span class="bound">x</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff rev_subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="var">?xx</span> <span class="main">⊆</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="var">?xx</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="var">?xx</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_is_non_overlapping 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-allocationRightUniqueRangeDomain"><span class="command">lemma</span></span> allocationRightUniqueRangeDomain<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> possible_allocations_rel <span class="free">G</span> <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span> <span class="main">&amp;</span> 
         runiq <span class="main">(</span><span class="free">a</span><span class="main">¯</span><span class="main">)</span> <span class="main">&amp;</span> 
         <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="keyword1">partitions</span> <span class="free">G</span> <span class="main">&amp;</span> 
         Range <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injections <span class="skolem">Y</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="skolem">Y</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 injections_def all_partitions_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* converse of the previous lemma *)</span>
<span class="keyword1" id="Universes-lm010"><span class="command">lemma</span></span> lm010<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">a</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="keyword1">partitions</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> possible_allocations_rel <span class="free">G</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injections <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> injections_def 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>  assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> all_partitions_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* lemma allocationRightUniqueRangeDomain and lm010 combined *)</span>
<span class="keyword1" id="Universes-allocationProperty"><span class="command">lemma</span></span> allocationProperty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> possible_allocations_rel <span class="free">G</span> <span class="free">N</span> <span class="main">⟷</span>
   runiq <span class="free">a</span> <span class="main">&amp;</span> runiq <span class="main">(</span><span class="free">a</span><span class="main">¯</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="keyword1">partitions</span> <span class="free">G</span> <span class="main">&amp;</span> Range <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> allocationRightUniqueRangeDomain lm010 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm011"><span class="command">lemma</span></span> lm011<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel' <span class="free">G</span> <span class="free">N</span> <span class="main">⊆</span> injectionsUniverse"</span></span>
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Universes-lm012"><span class="command">lemma</span></span> lm012<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel <span class="free">G</span> <span class="free">N</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm013"><span class="command">lemma</span></span> lm013<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injections <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> injections <span class="free">X</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm014"><span class="command">lemma</span></span> lm014<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"all_partitions <span class="free">X</span> <span class="main">=</span> all_partitions' <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> all_partitions_def is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm015"><span class="command">lemma</span></span> lm015<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel' <span class="free">A</span> <span class="free">B</span>  <span class="main">=</span>  possible_allocations_rel <span class="free">A</span> <span class="free">B</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span><span class="main">=</span><span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span><span class="main">=</span><span class="main">⋃</span> <span class="main">{</span> injections <span class="bound">Y</span> <span class="free">B</span> <span class="main">|</span> <span class="bound">Y</span> <span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> all_partitions <span class="free">A</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm014 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm016"><span class="command">lemma</span></span> lm016<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel <span class="free">G</span> <span class="free">N</span> <span class="main">⊆</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Range <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> Domain <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm012 lm011 injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm017"><span class="command">lemma</span></span> lm017<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel <span class="free">G</span> <span class="free">N</span> <span class="main">⊇</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span> <span class="main">&amp;</span> Range <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* combination of the previous two lemmas *)</span>
<span class="keyword1" id="Universes-lm018"><span class="command">lemma</span></span> lm018<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"possible_allocations_rel <span class="free">G</span> <span class="free">N</span>   <span class="main">=</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span> <span class="main">&amp;</span> Range <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm016 lm017 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* all possible injections can be flipped and gives the same *)</span>
<span class="keyword1" id="Universes-lm019"><span class="command">lemma</span></span> lm019<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"converse <span class="main">`</span> injectionsUniverse <span class="main">=</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm020"><span class="command">lemma</span></span> lm020<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"converse<span class="main">`</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>  <span class="main">=</span>  <span class="main">(</span>converse<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>converse<span class="main">`</span><span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Universes-allocationInjectionsUnivervseProperty"><span class="command">lemma</span></span> allocationInjectionsUnivervseProperty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> Range <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"possible_allocations_rel <span class="free">G</span> <span class="free">N</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span><span class="quoted">converse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span><span class="main">=</span><span class="quoted">injectionsUniverse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"all_partitions <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span><span class="main">=</span><span class="quoted">Domain</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">=</span><span class="quoted">Range</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span><span class="main">`</span><span class="var">?A</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span><span class="main">`</span><span class="var">?I</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?c</span><span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="var">?r</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="var">?d</span> <span class="bound">a</span> <span class="main">∈</span> <span class="var">?P</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm018 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span><span class="main">`</span><span class="var">?I</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">aa</span><span class="main">.</span> <span class="var">?d</span> <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="var">?r</span> <span class="bound">aa</span> <span class="main">∈</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?I</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">aa</span><span class="main">.</span> <span class="var">?d</span> <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="var">?r</span> <span class="bound">aa</span> <span class="main">∈</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm019 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm021"><span class="command">lemma</span></span> lm021<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationInjectionsUnivervseProperty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm022"><span class="command">lemma</span></span> lm022<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> partitionValuedUniverse"</span></span>
  <span class="keyword1"><span class="command">using</span></span> allocationInverseRangeDomainProperty is_partition_of_def is_non_overlapping_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> allAllocationsUniverse<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm021 lm022 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> inf.bounded_iff<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> posssibleAllocationsRelCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> injectionsUniverse <span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationInjectionsUnivervseProperty Int_Collect Int_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm023<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N1</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="free">N1</span> <span class="main">∪</span> <span class="free">N2</span><span class="main">)</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N1</span> <span class="main">∪</span> <span class="free">N2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> posssibleAllocationsRelCharacterization 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_supI1<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injectionsUniverse <span class="main">&amp;</span> Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> assms posssibleAllocationsRelCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> posssibleAllocationsRelCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm024<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N1</span> <span class="free">G</span> <span class="main">⊆</span> allAllocations <span class="main">(</span><span class="free">N1</span> <span class="main">∪</span> <span class="free">N2</span><span class="main">)</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm023 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subsetI<span class="main">)</span>

<span class="keyword1" id="Universes-lm025"><span class="command">lemma</span></span> lm025<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="free">P1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">P2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P1</span>"</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P2</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P1</span> <span class="main">∪</span> <span class="free">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> <span class="free">P1</span> <span class="main">∪</span> <span class="free">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm026"><span class="command">lemma</span></span> lm026<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="free">P1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">P2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P1</span>"</span></span>
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P2</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P1</span> <span class="main">∪</span> <span class="free">P2</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> <span class="free">P1</span> <span class="main">∪</span> <span class="free">P2</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm027"><span class="command">lemma</span></span> lm027<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="free">P1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">P2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P1</span>"</span></span> 
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">P2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span><span class="free">P1</span> <span class="main">∪</span> <span class="free">P2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">using</span></span> assms lm025 lm026 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm028"><span class="command">lemma</span></span> lm028<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="free">Q</span> <span class="main">∪</span> <span class="main">(</span>Range <span class="main">(</span><span class="free">P</span> <span class="keyword1">outside</span> <span class="main">(</span>Domain <span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Range <span class="main">(</span><span class="free">P</span> <span class="main">+*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paste_def Range_Un_eq Un_commute<span class="main">)</span>

<span class="keyword1" id="Universes-lm029"><span class="command">lemma</span></span> lm029<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span>Range <span class="free">a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Range <span class="free">a2</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∪</span> <span class="free">a2</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms disj_Un_runiq 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Domain_converse converse_Un mem_Collect_eq<span class="main">)</span>

<span class="keyword1" id="Universes-nonOverlapping"><span class="command">lemma</span></span> nonOverlapping<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>Range <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> partitionsUniverse <span class="main">&amp;</span> <span class="free">R</span> <span class="main">⊆</span> UNIV <span class="main">×</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">R</span> <span class="main">⊆</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 mem_Collect_eq subset_is_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-allocationUnion"><span class="command">lemma</span></span> allocationUnion<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a1</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∪</span> <span class="free">a2</span> <span class="main">∈</span> allocationsUniverse"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∪</span> <span class="free">a2</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a1</span><span class="main">^-1</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a2</span><span class="main">^-1</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">=</span><span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span><span class="main">=</span><span class="quoted">Domain</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span><span class="main">=</span><span class="quoted">injectionsUniverse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted">partitionsUniverse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?PV</span></span></span><span class="main">=</span><span class="quoted">partitionValuedUniverse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main">=</span><span class="quoted">runiq</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?a</span><span class="main">^-1</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">is_non_overlapping</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a1</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonOverlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a1</span> <span class="main">∪</span> <span class="var">?r</span> <span class="free">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm027<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?r</span> <span class="free">a1</span> <span class="main">∪</span> <span class="var">?r</span> <span class="free">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?a</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a1</span> <span class="main">∪</span> <span class="var">?r</span> <span class="free">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm027 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?PV</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="free">a1</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a2</span><span class="main">)</span> <span class="main">⊆</span> Pow <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a1</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_empty_left<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="free">a1</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms nonOverlapping is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm029 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* - stands here for set difference *)</span>
<span class="keyword1" id="Universes-lm030"><span class="command">lemma</span></span> lm030<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Diff_subset converse_mono mem_Collect_eq subrel_runiq<span class="main">)</span>

<span class="comment1">(* Note that -` is the inverse image of a lambda function. *)</span>
<span class="keyword1" id="Universes-lm031"><span class="command">lemma</span></span> lm031<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">⊆</span> <span class="free">N</span>    <span class="main">&amp;</span>   Range <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">}</span> <span class="main">=</span>
   <span class="main">(</span>Domain <span class="main">-`</span><span class="main">(</span>Pow <span class="free">N</span><span class="main">)</span><span class="main">)</span>  <span class="main">∩</span>  <span class="main">(</span>Range <span class="main">-`</span> <span class="main">(</span>all_partitions <span class="free">G</span><span class="main">)</span><span class="main">)</span> "</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm032"><span class="command">lemma</span></span> lm032<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">(</span><span class="main">(</span>Range <span class="main">-`</span> <span class="main">(</span>all_partitions <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="main">-`</span><span class="main">(</span>Pow <span class="free">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> allocationInjectionsUnivervseProperty lm031 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Int_commute<span class="main">)</span>

<span class="comment1">(* -` is the reverse image of a function. This is a variant of lm023 with different bracketing *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm033<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   injectionsUniverse <span class="main">∩</span> <span class="main">(</span>Range <span class="main">-`</span> <span class="main">(</span>all_partitions <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="main">-`</span><span class="main">(</span>Pow <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm032 Int_assoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="Universes-lm034"><span class="command">lemma</span></span> lm034<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">^-1</span> <span class="main">∈</span> injections <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="free">N</span> <span class="main">&amp;</span> 
         Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> posssibleAllocationsRelCharacterization
                                   allocationInverseRangeDomainProperty<span class="main">)</span>

<span class="keyword1" id="Universes-lm035"><span class="command">lemma</span></span> lm035<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">^-1</span> <span class="main">∈</span> injections <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-allocationReverseInjective"><span class="command">lemma</span></span> allocationReverseInjective<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   <span class="main">(</span><span class="free">a</span><span class="main">^-1</span> <span class="main">∈</span> injections <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="free">N</span>  <span class="main">&amp;</span>  Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm034 lm035 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm036"><span class="command">lemma</span></span> lm036<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injections <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">&amp;</span> 
         Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span> <span class="main">&amp;</span>
         Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mem_Collect_eq injections_def posssibleAllocationsRelCharacterization order_refl 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Universes-lm037"><span class="command">lemma</span></span> lm037<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injections <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> 
          <span class="quoted"><span class="quoted">"Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> 
          <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms mem_Collect_eq posssibleAllocationsRelCharacterization injections_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Universes-characterizationallAllocations"><span class="command">lemma</span></span> characterizationallAllocations<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> injections <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>  <span class="main">&amp;</span> 
   Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">G</span> <span class="main">&amp;</span> 
   Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm036 lm037 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm038"><span class="command">lemma</span></span> lm038<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms subset_is_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-reducedAllocation"><span class="command">lemma</span></span> reducedAllocation<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm030 lm038 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm039"><span class="command">lemma</span></span> lm039<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injections <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms injections_def mem_Collect_eq order_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm040"><span class="command">lemma</span></span> lm040<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">=</span><span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">is_non_overlapping</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted">all_partitions</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonOverlapping Int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="free">a</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_partitions_def 
     <span class="keyword1"><span class="command">using</span></span> is_partition_of_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
     <span class="keyword1"><span class="command">using</span></span> assms IntI Int_lower1 equalityE allocationInjectionsUnivervseProperty 
           mem_Collect_eq rev_subsetD 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm041"><span class="command">lemma</span></span> lm041<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∈</span> partitionsUniverse<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm042"><span class="command">lemma</span></span> lm042<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm041 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-singlePairInInjectionsUniverse"><span class="command">lemma</span></span> singlePairInInjectionsUniverse<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiq_basic <span class="keyword1"><span class="command">using</span></span> runiq_singleton_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-allocationUniverseProperty"><span class="command">lemma</span></span> allocationUniverseProperty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm042 singlePairInInjectionsUniverse lm030 Int_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* PP is a family of partitions *)</span>
<span class="keyword1" id="Universes-lm043"><span class="command">lemma</span></span> lm043<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">PP</span>"</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>Union <span class="free">PP</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>Union <span class="main">`</span> <span class="free">PP</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">is_non_overlapping</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">=</span><span class="quoted">Union</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="free">PP</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">`</span> <span class="free">PP</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X</span><span class="main">∈</span><span class="var">?P1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="var">?P1</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">≠</span> <span class="bound">Y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms is_non_overlapping_def Int_absorb Int_empty_left UnionI Union_disjoint 
            ex_in_conv imageE 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> 
    <span class="keyword3"><span class="command">assume</span></span> 
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?P1</span> <span class="main">&amp;</span> <span class="skolem">Y</span><span class="main">∈</span><span class="var">?P1</span> <span class="main">&amp;</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="skolem"><span class="skolem">YY</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> 
    2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="var">?U</span> <span class="skolem">XX</span> <span class="main">&amp;</span> <span class="skolem">Y</span><span class="main">=</span><span class="var">?U</span> <span class="skolem">YY</span> <span class="main">&amp;</span> <span class="skolem">XX</span><span class="main">∈</span><span class="free">PP</span> <span class="main">&amp;</span> <span class="skolem">YY</span><span class="main">∈</span><span class="free">PP</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">⊆</span> Union <span class="free">PP</span> <span class="main">&amp;</span> <span class="skolem">YY</span> <span class="main">⊆</span> Union <span class="free">PP</span> <span class="main">&amp;</span> <span class="skolem">XX</span> <span class="main">∩</span> <span class="skolem">YY</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 2 is_non_overlapping_def assms<span class="main">(</span>1<span class="main">)</span> Sup_upper <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">XX</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">∈</span><span class="skolem">YY</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∩</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> is_non_overlapping_def 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI empty_iff subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 0 1 2 is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A preservation of reallocating goods of the participants in X to a single participant i. *)</span>
<span class="keyword1" id="Universes-lm044"><span class="command">lemma</span></span> lm044<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
         <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> 
         <span class="main">⋃</span> <span class="main">(</span>Range <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span><span class="main">=</span><span class="quoted">Domain</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">=</span><span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">=</span><span class="quoted">Union</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">is_non_overlapping</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted">partitionsUniverse</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main">=</span><span class="quoted">runiq</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Xi</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?Xi</span> <span class="main">×</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="var">?b</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Yi</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">``</span><span class="var">?Xi</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="var">?Yi</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a3</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?A2</span> <span class="main">-</span> <span class="var">?a3</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="var">?Xi</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?a1</span> <span class="main">∪</span> <span class="var">?a2</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span><span class="main">(</span><span class="var">?r</span><span class="main">(</span><span class="var">?a1</span><span class="main">∪</span><span class="var">?a2</span><span class="main">)</span><span class="main">)</span><span class="main">=</span><span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range_Un_eq Union_Un_distrib<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="var">?Xi</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a2</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?U</span><span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span>
  3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="free">a</span> <span class="main">&amp;</span> <span class="var">?u</span> <span class="main">(</span><span class="free">a</span><span class="main">^-1</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?r</span> <span class="var">?a1</span> <span class="main">⊆</span> <span class="var">?r</span> <span class="free">a</span> <span class="main">&amp;</span> <span class="var">?Yi</span> <span class="main">⊆</span> <span class="var">?r</span> <span class="free">a</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> assms Int_iff nonOverlapping mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?p</span> <span class="var">?Yi</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_is_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a1</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> <span class="var">?a2</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> allocationUniverseProperty assms<span class="main">(</span>1<span class="main">)</span> reducedAllocation <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?a1</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="var">?a2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">⟶</span> <span class="var">?t1</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> Un_empty_left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Un_absorb2 empty_subsetI<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?a1</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="var">?a2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">⟶</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?a1</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="var">?a2</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">⟶</span> <span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span>
    6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a1</span><span class="main">≠</span><span class="main">{}</span> <span class="main">&amp;</span> <span class="var">?a2</span><span class="main">≠</span><span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?a2</span><span class="main">⊇</span><span class="main">{</span><span class="var">?Y</span><span class="main">}</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> Diff_cancel Range_insert empty_subsetI insert_Diff_single insert_iff insert_subset 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?a1</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">&amp;</span> <span class="var">?r</span> <span class="var">?a2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?a1</span> <span class="main">⊆</span> <span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="var">?d</span> <span class="var">?a1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Yi</span> <span class="main">∩</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="var">?Xi</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> assms 3 6 Diff_disjoint intersectionEmptyRelationIntersectionEmpty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?a1</span> <span class="main">∩</span> <span class="var">?Yi</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">&amp;</span> <span class="var">?Yi</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">{</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">,</span> <span class="var">?Yi</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_non_overlapping_def 
         <span class="keyword1"><span class="command">using</span></span> IntI Int_commute empty_iff insert_iff subsetI subset_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">{</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">,</span> <span class="var">?Yi</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?U</span> <span class="main">{</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">,</span> <span class="var">?Yi</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span> Outside_def subset_is_non_overlapping<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?U</span><span class="main">`</span><span class="main">{</span><span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span><span class="main">,</span> <span class="var">?Yi</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm043 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span><span class="main">,</span> <span class="var">?Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?r</span> <span class="var">?a1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">∈</span><span class="var">?Yi</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> IntI empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?r</span> <span class="var">?a1</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">∈</span><span class="var">?Yi</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∩</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> 3 4 6 is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unionIntersectionEmpty
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v0</span><span class="main">.</span> <span class="bound">v0</span> <span class="main">∈</span> Range <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> Range <span class="free">a</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v1</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">v0</span> <span class="main">∩</span> <span class="bound">v1</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Range <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> Range <span class="free">a</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∩</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>Range <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> Range <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?a2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="var">?a1</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?d</span> <span class="var">?a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a1</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> reducedAllocation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a2</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> allocationUniverseProperty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a1</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> <span class="var">?a2</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span>
                     <span class="main">⋃</span><span class="main">(</span>Range <span class="var">?a1</span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="var">?a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">&amp;</span> Domain <span class="var">?a1</span> <span class="main">∩</span> Domain <span class="var">?a2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="keyword1"><span class="command">using</span></span> allocationUnion <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>       
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> allocationsUniverseOutsideUnion<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> 
           <span class="main">⋃</span><span class="main">(</span>Range<span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span>
                 allocationsUniverse"</span></span>
           <span class="keyword1"><span class="command">using</span></span> assms lm044 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm044 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> 
      <span class="main">⋃</span> <span class="main">(</span>Range <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* If there is an allocation with a participant in its domain, then the goods allocated are non-empty *)</span>
<span class="keyword1" id="Universes-lm045"><span class="command">lemma</span></span> lm045<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="free">X</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">is_non_overlapping</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">Range</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Int_iff nonOverlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">``</span><span class="free">X</span> <span class="main">⊆</span> <span class="var">?r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms subset_is_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">``</span><span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_member all_not_in_conv no_empty_in_non_overlapping<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* i is an additional bidder added to X *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm046<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span>  <span class="main">=</span>  <span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm045 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="comment1">(* variant of allocationsUniverseOutsideUnion *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm047<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> 
                         <span class="main">⋃</span><span class="main">(</span>Range<span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>Range<span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">&amp;</span> <span class="var">?t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> allocationsUniverseOutsideUnion 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse <span class="main">⟶</span> 
          <span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse"</span></span>
      <span class="keyword1"><span class="command">using</span></span> allocationsUniverseOutsideUnion <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> 
           allocationsUniverse <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span> <span class="main">``</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> allocationsUniverseOutsideUnion<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm045 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The bid vector does not decrease when you bid for extra goods *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">bidMonotonicity</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">==</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">(</span>trivial <span class="bound">t</span> <span class="main">&amp;</span> trivial <span class="bound">t'</span> <span class="main">&amp;</span> Union <span class="bound">t</span> <span class="main">⊆</span> Union <span class="bound">t'</span><span class="main">)</span> <span class="main">⟶</span> 
           sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">×</span><span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">×</span><span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="comment1">(* adding the goods in X weakly increases the revenue *)</span>
<span class="keyword1" id="Universes-lm048"><span class="command">lemma</span></span> lm048<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bidMonotonicity <span class="free">b</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted">runiq</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted">Union</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Xi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span><span class="var">?I</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span><span class="main">``</span><span class="var">?I</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?U</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="var">?Xi</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="var">?I</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="var">?I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="var">?U</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="var">?I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="var">?I</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?U</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="var">?I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="var">?t1</span> <span class="main">⊆</span> <span class="var">?U</span> <span class="var">?t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subrel_runiq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trivial <span class="var">?t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> runiq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trivial <span class="var">?t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trivial_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm049"><span class="command">lemma</span></span> lm049<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">XX</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">XX</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms mem_Collect_eq no_empty_in_non_overlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> emptyNotInRange<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm049 allAllocationsUniverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm050"><span class="command">lemma</span></span> lm050<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">a</span> <span class="main">⊆</span> Pow <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms allocationInverseRangeDomainProperty is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_Pow_Union<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm051<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> Range <span class="free">a</span> <span class="main">⊆</span> Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm050 insert_Diff_single emptyNotInRange subset_insert
        allocationInverseRangeDomainProperty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> allocationPowerset<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm051 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm052<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> Pow <span class="main">(</span><span class="free">N</span><span class="main">×</span><span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationPowerset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* reformulation of 43c with given set of goods and set of participants *)</span>
<span class="keyword1" id="Universes-lm053"><span class="command">lemma</span></span> lm053<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
           <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">N</span><span class="main">-</span><span class="free">X</span>"</span></span> 
           <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> 
           allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted">Union</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted">runiq</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted">Domain</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> allAllocationsUniverse  rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="var">?d</span> <span class="free">a</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?aa</span><span class="main">)</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lm047<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="var">?d</span> <span class="var">?aa</span><span class="main">)</span> <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> lm040 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="var">?d</span> <span class="var">?aa</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm023<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="var">?d</span> <span class="var">?aa</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">-</span> <span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> posssibleAllocationsRelCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?d</span> <span class="free">a</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="var">?U</span> <span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm024 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> in_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm054"><span class="command">lemma</span></span> lm054<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bidMonotonicity <span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="main">_</span> <span class="main">=&gt;</span> real<span class="main">)</span> <span class="free">i</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
          <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> 
           sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted">Union</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted">runiq</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted">Domain</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injectionsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="free">a</span> <span class="main">&amp;</span> <span class="var">?R</span><span class="main">--</span><span class="free">i</span> <span class="main">⊆</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">using</span></span> lm088 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?u</span> <span class="main">(</span><span class="var">?R</span><span class="main">--</span><span class="free">i</span><span class="main">)</span> <span class="main">&amp;</span> <span class="var">?u</span> <span class="var">?R</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> finite_subset subrel_runiq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"trivial <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> runiq_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trivial_cartesian trivial_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="bound">X</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outside_reduces_domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?R</span><span class="main">--</span><span class="free">i</span><span class="main">)</span> <span class="main">&amp;</span> finite <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">&amp;</span> 
      finite <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Outside_def trivial_implies_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outsideUnion<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="var">?R</span> <span class="main">=</span> sum <span class="free">b</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 sum.union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> sum.union_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="var">?R</span><span class="main">``</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lm048 assms<span class="main">(</span>1<span class="main">)</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="var">?R</span> <span class="main">≤</span> sum <span class="free">b</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">b</span> <span class="main">(</span><span class="var">?R</span> <span class="main">--</span> <span class="free">i</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="var">?U</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> 1 sum.union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">b</span> <span class="var">?aa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outsideOutside<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-elementOfPartitionOfFiniteSetIsFinite"><span class="command">lemma</span></span> elementOfPartitionOfFiniteSetIsFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">XX</span> <span class="main">∈</span> all_partitions <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">XX</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> all_partitions_def is_partition_of_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_UnionD mem_Collect_eq<span class="main">)</span>

<span class="keyword1" id="Universes-lm055"><span class="command">lemma</span></span> lm055<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finiteRelationCharacterization rev_finite_subset 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> characterizationallAllocations elementOfPartitionOfFiniteSetIsFinite<span class="main">)</span>

<span class="keyword1" id="Universes-allAllocationsFinite"><span class="command">lemma</span></span> allAllocationsFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>allAllocations <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow<span class="main">(</span><span class="free">N</span><span class="main">×</span><span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms finite_Pow_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm052 rev_finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm056<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bidMonotonicity <span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="main">_</span> <span class="main">=&gt;</span> real<span class="main">)</span> <span class="free">i</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">N</span><span class="main">-</span><span class="free">X</span>"</span></span> 
          <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="main">(</span>sum <span class="free">b</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> 
           sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⋃</span><span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">(</span><span class="free">X</span><span class="main">∪</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bidMonotonicity <span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="main">_</span> <span class="main">=&gt;</span> real<span class="main">)</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> allAllocationsUniverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm055 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">b</span> <span class="var">?aa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm054<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm053 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms allocationInverseRangeDomainProperty is_partition_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="var">?aa</span> <span class="main">∈</span> <span class="main">(</span>sum <span class="free">b</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>sum <span class="free">b</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms allAllocationsFinite assms<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="var">?aa</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span>sum <span class="free">b</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="free">X</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-cardinalityPreservation"><span class="command">lemma</span></span> cardinalityPreservation<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">XX</span><span class="main">.</span> finite <span class="bound">X</span>"</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">XX</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span> <span class="main">=</span> sum card <span class="free">XX</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms is_non_overlapping_def card_Union_disjoint disjointI<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> cardSumCommute<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">XX</span> <span class="keyword1">partitions</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">XX</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span> <span class="free">XX</span><span class="main">)</span> <span class="main">=</span> sum card <span class="free">XX</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms cardinalityPreservation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_partition_of_def familyUnionFiniteEverySetFinite<span class="main">)</span>

<span class="comment1">(* Σ_x∈ (Union C) (f x)   is the same as Σ_x∈ C (Σ_set∈ C (Σ_x∈set (f x))) *)</span>
<span class="keyword1" id="Universes-sumUnionDisjoint1"><span class="command">lemma</span></span> sumUnionDisjoint1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> finite <span class="bound">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="keyword1">Int</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>Union <span class="free">C</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">f</span><span class="main">)</span> <span class="free">C</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sum.Union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> sumUnionDisjoint2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> finite <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sumUnionDisjoint1 is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> sumUnionDisjoint3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> finite <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">partitions</span> <span class="free">XX</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">XX</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_partition_of_def sumUnionDisjoint2<span class="main">)</span>
 
<span class="keyword1"><span class="command">corollary</span></span> sum_associativity<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">partitions</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sumUnionDisjoint3 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_partition_of_def familyUnionFiniteEverySetFinite<span class="main">)</span>

<span class="keyword1" id="Universes-lm057"><span class="command">lemma</span></span> lm057<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms posssibleAllocationsRelCharacterization lm040 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm058<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span>
   allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm057 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm059<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationInverseRangeDomainProperty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm060<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> is_partition_of_def allocationInverseRangeDomainProperty mem_Collect_eq subsetI
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm061<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span>  <span class="main">⊆</span>  allocationsUniverse <span class="main">&amp;</span>
   allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm059 lm060 conj_subset_def allAllocationsUniverse <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> allAllocationsIntersectionSubset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> 
   allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R1</span> <span class="main">∩</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R1</span> <span class="main">&amp;</span> <span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm061<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> allAllocationsIntersection<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   <span class="main">(</span>allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>Domain <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> allAllocationsIntersectionSubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm058 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> allAllocationsIntersectionSetEquals<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>  <span class="main">=</span> 
   <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allocationsUniverse  <span class="main">&amp;</span> <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allAllocationsIntersection Int_Collect <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> allocationsUniverseOutside<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> reducedAllocation<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bridging theorem for injections›</span></span>

<span class="keyword1" id="Universes-lm062"><span class="command">lemma</span></span> lm062<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"totalRels <span class="main">{}</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm063"><span class="command">lemma</span></span> lm063<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CollectI converse_empty runiq_emptyrel<span class="main">)</span>

<span class="keyword1" id="Universes-lm064"><span class="command">lemma</span></span> lm064<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injectionsUniverse <span class="main">∩</span> <span class="main">(</span>totalRels <span class="main">{}</span> <span class="free">Y</span><span class="main">)</span>  <span class="main">=</span>  <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm062 lm063 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm065"><span class="command">lemma</span></span> lm065<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span>Domain <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">}</span> <span class="main">⊆</span> runiqs"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> paste_def runiqs_def <span class="keyword1"><span class="command">using</span></span> assms runiq_basic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm066"><span class="command">lemma</span></span> lm066<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"converse <span class="main">`</span> <span class="main">(</span>converse <span class="main">`</span> <span class="free">X</span><span class="main">)</span>  <span class="main">=</span>  <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm067"><span class="command">lemma</span></span> lm067<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∈</span> converse<span class="main">`</span>runiqs<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiqs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm068"><span class="command">lemma</span></span> lm068<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> Range <span class="free">f</span>  <span class="main">=</span>  <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"converse <span class="main">`</span> <span class="main">{</span> <span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">}</span> <span class="main">⊆</span> runiqs"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm065 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Universes-lm069"><span class="command">lemma</span></span> lm069<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">∈</span>converse<span class="main">`</span>runiqs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> Range <span class="free">f</span>  <span class="main">=</span>  <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> converse<span class="main">`</span>runiqs"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">f</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lm067 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"converse <span class="main">`</span> <span class="var">?l</span> <span class="main">⊆</span> runiqs"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm068<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">⊇</span> converse<span class="main">`</span><span class="main">(</span>converse<span class="main">`</span><span class="var">?l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"converse<span class="main">`</span><span class="main">(</span>converse<span class="main">`</span><span class="var">?l</span><span class="main">)</span><span class="main">=</span><span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm066<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm070"><span class="command">lemma</span></span> lm070<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">}</span> <span class="main">⊆</span> totalRels <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> Domain <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> Range <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Universes-lm071"><span class="command">lemma</span></span> lm071<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injectionsUniverse  <span class="main">=</span>  runiqs <span class="main">∩</span> converse<span class="main">`</span>runiqs"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> runiqs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm072"><span class="command">lemma</span></span> lm072<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> injectionsUniverse"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> Domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> injectionsUniverse"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> converse<span class="main">`</span>runiqs"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lm071 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> converse<span class="main">`</span>runiqs"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm069<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> runiqs"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> lm065 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm071 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm073"><span class="command">lemma</span></span> lm073<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injections <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> totalRels <span class="free">X</span> <span class="free">Y</span> <span class="main">∩</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm008 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm074"><span class="command">lemma</span></span> lm074<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">outside</span> <span class="free">A</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Outside_def lm030<span class="main">)</span>

<span class="keyword1" id="Universes-lm075"><span class="command">lemma</span></span> lm075<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> totalRels <span class="free">A</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">outside</span> <span class="free">C</span> <span class="main">∈</span> totalRels <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">C</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Outside_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm076"><span class="command">lemma</span></span> lm076<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="free">A</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">outside</span> <span class="free">C</span> <span class="main">∈</span> injections <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def Range_outside_sub lm030 mem_Collect_eq outside_reduces_domain
  <span class="keyword1"><span class="command">unfolding</span></span> injections_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Universes-lm077"><span class="command">lemma</span></span> lm077<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="free">A</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">outside</span> <span class="free">C</span> <span class="main">∈</span> injections <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm076 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm078"><span class="command">lemma</span></span> lm078<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">=</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Universes-lm079"><span class="command">lemma</span></span> lm079<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="free">f</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">f</span><span class="main">,,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm078 Image_runiq_eq_eval <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm080<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">f</span><span class="main">,,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm079 outsideUnion <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Universes-lm081"><span class="command">lemma</span></span> lm081<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> injectionsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Range<span class="main">(</span><span class="free">f</span> <span class="keyword1">outside</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Range <span class="free">f</span> <span class="main">-</span> <span class="free">f</span><span class="main">``</span><span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms mem_Collect_eq rangeOutside <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="Universes-lm082"><span class="command">lemma</span></span> lm082<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">g</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">{</span><span class="free">g</span><span class="main">--</span><span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range<span class="main">(</span><span class="free">g</span><span class="main">--</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">--</span><span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span>injectionsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lm008 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">,,</span><span class="free">x</span> <span class="main">∈</span> <span class="free">g</span><span class="main">``</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_runiq_eq_eval insertI1 mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">,,</span><span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm081 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="var">?f</span><span class="main">∪</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">g</span><span class="main">,,</span><span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> assms lm080 mem_Collect_eq <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm083<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">--</span><span class="free">x</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm077 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb insert_is_Un<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm084<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> injections <span class="main">(</span><span class="var">?X</span><span class="main">)</span> <span class="free">Y</span>"</span></span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="free">g</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">--</span><span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span>injections <span class="var">?X</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">g</span><span class="main">=</span><span class="var">?X</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> mem_Collect_eq <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm083 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="main">{</span><span class="var">?f</span><span class="main">∪</span><span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="free">Y</span><span class="main">-</span>Range <span class="var">?f</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm082<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm085<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">⊆</span> 
          <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm084 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm086"><span class="command">lemma</span></span> lm086<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> 
          injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm072 injections_def lm073 lm070 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> injectionsUniverse <span class="main">&amp;</span> <span class="free">x</span> <span class="main">∉</span> Domain <span class="skolem">f</span> <span class="main">&amp;</span> Domain <span class="skolem">f</span> <span class="main">=</span> <span class="free">X</span> <span class="main">&amp;</span> Range <span class="skolem">f</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> injectionsUniverse"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> Domain <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Y</span><span class="main">-</span>Range <span class="skolem">f</span><span class="main">)</span> <span class="main">∩</span> Range <span class="skolem">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Y</span><span class="main">-</span>Range <span class="skolem">f</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> injectionsUniverse"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm072<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Y</span><span class="main">-</span>Range <span class="skolem">f</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> totalRels <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lm070 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Y</span><span class="main">-</span>Range <span class="skolem">f</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> 
                     injectionsUniverse <span class="main">∩</span> totalRels <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">∪</span><span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm008 <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> injectionsUnionCommute<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
           injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span><span class="main">=</span>injections <span class="var">?X</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">=</span><span class="var">?r'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r'</span> <span class="main">⊆</span> injections <span class="var">?X</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm086<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> injections <span class="var">?X</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lm005 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">⊆</span> injections <span class="var">?X</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"injections <span class="var">?X</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm085<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm087"><span class="command">lemma</span></span> lm087<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Union <span class="main">{</span><span class="free">f</span> <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> Union <span class="main">{</span><span class="free">g</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Universes-lm088"><span class="command">lemma</span></span> lm088<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> Domain <span class="free">R</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Domain_empty Domain_insert Int_insert_right_if0
                              disjoint_iff_not_equal ex_in_conv paste_disj_domains<span class="main">)</span>

<span class="comment1">(* Union of {f ...} where f ranges over injections X Y *)</span>
<span class="keyword1" id="Universes-lm089"><span class="command">lemma</span></span> lm089<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span>  <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>  <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> Domain <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span><span class="main">=</span>Union <span class="main">{</span><span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">|</span><span class="bound">f</span> <span class="main">.</span><span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span> <span class="main">&amp;</span> <span class="free">x</span> <span class="main">∉</span> Domain <span class="bound">f</span><span class="main">}</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">=</span><span class="var">?l'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span><span class="main">=</span>Union <span class="main">{</span><span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">|</span><span class="bound">f</span> <span class="main">.</span><span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span> <span class="main">&amp;</span> <span class="free">x</span> <span class="main">∉</span> Domain <span class="bound">f</span><span class="main">}</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">=</span><span class="var">?r'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="free">X</span> <span class="free">Y</span> <span class="main">&amp;</span> <span class="free">x</span> <span class="main">∉</span> Domain <span class="bound">f</span> <span class="main">⟶</span> 
        <span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">=</span><span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> lm088 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span><span class="main">=</span><span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm087<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm090<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
           injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span><span class="main">=</span><span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span><span class="main">=</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="free">X</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm089<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injectionsUnionCommute<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm091"><span class="command">lemma</span></span> lm091<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">[</span> <span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">.</span> y <span class="main">←</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">%</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">]</span> <span class="main">=</span> 
   <span class="main">{</span><span class="free">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span> <span class="main">-</span>     <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* relationship of list and set notation for function application *)</span>
<span class="keyword1" id="Universes-lm092"><span class="command">lemma</span></span> lm092<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">L</span><span class="main">.</span> set <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat <span class="main">[</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">.</span> x <span class="main">&lt;-</span> <span class="free">L</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">L</span><span class="main">.</span> <span class="free">G</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* relationship of list and set notation for function extension *)</span>
<span class="keyword1" id="Universes-lm093"><span class="command">lemma</span></span> lm093<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat <span class="main">[</span> <span class="main">[</span> <span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">.</span> y <span class="main">←</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">%</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> Range <span class="bound">f</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">]</span><span class="main">.</span> f <span class="main">←</span> <span class="free">F</span> <span class="main">]</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">F</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* relationship of list vs set comprehension versions of function update*)</span>
<span class="keyword1" id="Universes-lm094"><span class="command">lemma</span></span> lm094<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">[</span> <span class="free">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">.</span> y <span class="main">←</span> sorted_list_of_set <span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">]</span> <span class="main">=</span>
           <span class="main">{</span>      <span class="free">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span>                 <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Universes-lm095"><span class="command">lemma</span></span> lm095<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat <span class="main">[</span><span class="main">[</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> y <span class="main">←</span> sorted_list_of_set<span class="main">(</span><span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">.</span> f <span class="main">←</span> <span class="free">F</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">F</span><span class="main">.</span><span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm094 lm092 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computable injections›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">injectionsAlg</span> 
    <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">injectionsAlg</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">{}</span><span class="main">]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">injectionsAlg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> 
       concat <span class="main">[</span> <span class="main">[</span><span class="bound">R</span><span class="main">∪</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> y <span class="main">←</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">%</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> Range <span class="bound">R</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">]</span>
               <span class="main">.</span>R <span class="main">←</span> <span class="free">injectionsAlg</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm096<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>injectionsAlg <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span>injectionsAlg <span class="free">xs</span> <span class="free">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm093 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lm097<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>injectionsAlg <span class="free">xs</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>injectionsAlg <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span> <span class="main">∈</span> injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>Range <span class="bound">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm096 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We sometimes use parallel <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">abbreviation</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">definition</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the same object to save typing `unfolding xxx' each time. There is also different behaviour in the code extraction.›</span></span>

<span class="keyword1" id="Universes-lm098"><span class="command">lemma</span></span> lm098<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"injections <span class="main">{}</span> <span class="free">Y</span>  <span class="main">=</span>  <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lm008 lm062 runiq_emptyrel<span class="main">)</span>

<span class="keyword1" id="Universes-lm099"><span class="command">lemma</span></span> lm099<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injections <span class="main">{}</span> <span class="free">Y</span>  <span class="main">=</span>  <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> injections_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm098 injections_def<span class="main">)</span>

<span class="keyword1" id="Universes-injectionsFromEmptyIsEmpty"><span class="command">lemma</span></span> injectionsFromEmptyIsEmpty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injectionsAlg <span class="main">[]</span> <span class="free">Y</span>  <span class="main">=</span>  <span class="main">[</span><span class="main">{}</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Relation between classical and algorithm definition of injections for induction step *)</span>
<span class="keyword1" id="Universes-lm100"><span class="command">lemma</span></span> lm100<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>injectionsAlg <span class="free">xs</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>injectionsAlg <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span><span class="main">=</span><span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">Y</span><span class="main">)</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm097<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injectionsUnionCommute<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm101"><span class="command">lemma</span></span> lm101<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span> 
          <span class="quoted"><span class="quoted">"set <span class="main">(</span>injections_alg <span class="free">xs</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>    <span class="quoted"><span class="quoted">"set <span class="main">(</span>injections_alg <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span><span class="main">=</span><span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">f</span><span class="main">∈</span>injections <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="main">+*</span> <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">-</span>Range <span class="bound">f</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> lm095 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm090<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-listInduct"><span class="command">lemma</span></span> listInduct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> structInduct<span class="main">)</span>

<span class="keyword1" id="Universes-injectionsFromEmptyAreEmpty"><span class="command">lemma</span></span> injectionsFromEmptyAreEmpty<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>injections_alg <span class="main">[]</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> injections_equiv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>injections_alg <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> injections <span class="main">(</span>set <span class="free">X</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> distinct <span class="bound">l</span> <span class="main">⟶</span> <span class="main">(</span>set <span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free">Y</span><span class="main">)</span><span class="main">=</span>injections <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> injectionsFromEmptyAreEmpty list.set<span class="main">(</span>1<span class="main">)</span> lm099 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lm101 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_is_Un list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> structInduct<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Universes-lm102"><span class="command">lemma</span></span> lm102<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distinct <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_partitions_equivalence'<span class="main">)</span>

<span class="comment1">(* apply bridging theorem injections_equiv to the partitions of all goods *)</span>
<span class="keyword1" id="Universes-bridgingInjection"><span class="command">lemma</span></span> bridgingInjection<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span>all_partitions_list <span class="free">G</span><span class="main">)</span><span class="main">.</span> set <span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> 
         injections <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lm102 injections_equiv assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_ge_0_finite<span class="main">)</span>

<span class="comment1">(* list vs set comprehension on partitions with bridging theorem *)</span>
<span class="keyword1" id="Universes-lm103"><span class="command">lemma</span></span> lm103<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>injections <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
         set <span class="main">[</span>set <span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> l <span class="main">←</span> all_partitions_list <span class="free">G</span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="main">=</span> <span class="quoted">all_partitions_list</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f2</span></span></span> <span class="main">=</span> <span class="quoted">injections</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="main">=</span> <span class="quoted">injections_alg</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?g1</span> <span class="free">G</span><span class="main">)</span><span class="main">.</span> set <span class="main">(</span><span class="var">?g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f2</span> <span class="main">(</span>set <span class="bound">l</span><span class="main">)</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms bridgingInjection <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span>set <span class="main">(</span><span class="var">?g2</span> <span class="bound">l</span> <span class="free">N</span><span class="main">)</span><span class="main">.</span> l <span class="main">&lt;-</span> <span class="var">?g1</span> <span class="free">G</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="var">?f2</span> <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map set <span class="main">(</span><span class="var">?g1</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> setVsList<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="var">?f2</span> <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> all_partitions_paper_equiv_alg assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* apply Union to both sides in lm103 *)</span>
<span class="keyword1" id="Universes-lm104"><span class="command">lemma</span></span> lm104<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Union <span class="main">{</span>injections <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
           Union <span class="main">(</span>set <span class="main">[</span>set <span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> l <span class="main">←</span> all_partitions_list <span class="free">G</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Union <span class="var">?L</span> <span class="main">=</span> Union <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm103<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* bridging lemma for allAllocations *)</span>
<span class="keyword1"><span class="command">corollary</span></span> allAllocationsBridgingLemma<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">=</span> 
           set<span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LL</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span>injections <span class="bound">P</span> <span class="free">N</span><span class="main">|</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> all_partitions <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?RR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="main">[</span>set <span class="main">(</span>injections_alg <span class="bound">l</span> <span class="free">N</span><span class="main">)</span> <span class="main">.</span> l <span class="main">←</span> all_partitions_list <span class="free">G</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LL</span> <span class="main">=</span> <span class="var">?RR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm104<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"converse <span class="main">`</span> <span class="var">?LL</span> <span class="main">=</span> converse <span class="main">`</span> <span class="var">?RR</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="UniformTieBreaking">
<div class="head">
<h1>Theory UniformTieBreaking</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Termination theorem for uniform tie-breaking›</span></span>

<span class="keyword1"><span class="command">theory</span></span> UniformTieBreaking

<span class="keyword2"><span class="keyword">imports</span></span> 
<a href="StrictCombinatorialAuction.html">StrictCombinatorialAuction</a>
<a href="Universes.html">Universes</a>
<span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Uniform tie breaking: definitions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Let us repeat the general context. Each bidder has made their bids and the VCG algorithm up
 to now allocates goods to the higher bidders. If there are several high bidders tie breaking has 
to take place. To do tie breaking we generate out of a random number a second bid vector so that 
the same algorithm can be run again to determine a unique allocation.

To this end, we associate to each allocation the bid in which each participant bids for a set 
of goods an amount equal to the cardinality of the intersection of the bid with the set 
she gets in this allocation.
By construction, the revenue of an auction run using this bid is maximal on the given allocation,
and this maximal is unique.
We can then use the bid constructed this way <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">tiebids</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to break ties by running an auction 
having the same form as a normal auction (that is why we use the adjective ``uniform''), 
only with this special bid vector.›</span></span>

<span class="comment1">(* omega pair is a tool to compute cardinalities of pairs, e.g. for a pair made of a participant 1 and a set of goods {11,12,13}, the result will be the set of pairs: {(1,{11}), (1,{12}), (1,{13})}.
*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">omega</span> <span class="free"><span class="bound"><span class="entity">pair</span></span></span> <span class="main">==</span> <span class="main">{</span>fst <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* pseudo allocation is like an allocation, but without uniqueness of the elements allocated *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pseudoAllocation</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span>omega <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* some abbreviation to defined tiebids below *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bidMaximizedBy</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> 
              pseudoAllocation <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="main">&lt;||</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">×</span> <span class="main">(</span>finestpart <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* functional version of the above *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxbid</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> 
              toFunction <span class="main">(</span>bidMaximizedBy <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* For bidding the cardinality of the second element of a single pair, i.e.,
   (bidder, goods) → ((bidder, goods), bid) *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">summedBid</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">pair</span></span></span> <span class="main">==</span> 
              <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* returns just the bid in the above *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">summedBidSecond</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">pair</span></span></span> <span class="main">==</span> 
              sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">pair</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* apply summedBid to each possible pair *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">summedBidVectorRel</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> <span class="main">(</span>summedBid <span class="free"><span class="bound"><span class="entity">bids</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* functional version of above *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">summedBidVector</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> toFunction <span class="main">(</span>summedBidVectorRel <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* tiebids returns a bid vector that when the VCG algorithm runs on it yields the singleton {allocation}. Functional version *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tiebids</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> summedBidVector <span class="main">(</span>maxbid <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="comment1">(* relational version of the above *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tiebids</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">==</span> summedBidVectorRel <span class="main">(</span>real<span class="main">∘</span>maxbid <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="comment1">(* Assumed we have a list and a random we take the random-th element of the list. However, if the
   random number is bigger than the list is long we take it modulo the length of the list *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">randomEl</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">::</span>integer<span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">list</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span>nat_of_integer <span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nat_of_integer <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span>integer<span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>

<span class="comment1">(* The randomEl taken out of a list is in the list *)</span>
<span class="keyword1" id="UniformTieBreaking-randomElLemma"><span class="command">lemma</span></span> randomElLemma<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">list</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"randomEl <span class="free">list</span> <span class="free">random</span> <span class="main">∈</span> set <span class="free">list</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> randomEl_def<span class="main">)</span>

<span class="comment1">(* The chosen allocation takes the random-th element of all possible winning allocations. This is
   done by taking the element given by randomEl list random defined above. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">chosenAllocation</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> 
   randomEl <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="main">(</span>winningAllocationsRel <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span><span class="main">)</span><span class="main">)</span> 
                     <span class="main">(</span>allAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> 
            <span class="free"><span class="bound"><span class="entity">random</span></span></span>"</span></span>

<span class="comment1">(* find the bid vector in random values that returns the chosen winning allocation *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">resolvingBid</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> 
  tiebids <span class="main">(</span>chosenAllocation <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Termination theorem for the uniform tie-breaking scheme›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> winningAllocationPossible<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"winningAllocationsRel <span class="free">N</span> <span class="free">G</span> <span class="free">b</span> <span class="main">⊆</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> injectionsFromEmptyAreEmpty mem_Collect_eq subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="UniformTieBreaking-subsetAllocation"><span class="command">lemma</span></span> subsetAllocation<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊆</span> <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> allocationsUniverse"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="free">a</span><span class="main">-</span><span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> reducedAllocation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm001"><span class="command">lemma</span></span> lm001<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">outside</span> <span class="free">X</span> <span class="main">∈</span> allocationsUniverse"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms reducedAllocation Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm002<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="main">(</span><span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationUniverseProperty pairDifference <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* TPTP? *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm003<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">{}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x1</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> allocationUniverseProperty empty_iff insert_Diff_if insert_iff prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm004<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allocationsUniverse <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm003 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm005<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> subsetAllocation lm003 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> empty_subsetI<span class="main">)</span>

<span class="keyword1" id="UniformTieBreaking-lm006"><span class="command">lemma</span></span> lm006<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> all_partitions_def is_partition_of_def is_non_overlapping_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="UniformTieBreaking-lm007"><span class="command">lemma</span></span> lm007<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> totalRels <span class="main">{</span><span class="free">G</span><span class="main">}</span> <span class="free">N</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="UniformTieBreaking-lm008"><span class="command">lemma</span></span> lm008<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> injections <span class="main">{</span><span class="free">G</span><span class="main">}</span> <span class="free">N</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms injections_def singlePairInInjectionsUniverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm009<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="free">G</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">∈</span><span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> possible_allocations_rel <span class="free">G</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">G</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> injections <span class="main">{</span><span class="free">G</span><span class="main">}</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm008 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">G</span><span class="main">}</span> <span class="main">∈</span> all_partitions <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm006 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm010<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">≠</span><span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm009
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> equals0I image_insert insert_absorb insert_not_empty<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm011<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"winningAllocationsRel <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">&amp;</span> finite <span class="main">(</span>winningAllocationsRel <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm010 allAllocationsFinite argmax_non_empty_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> winningAllocationPossible rev_finite_subset<span class="main">)</span>

<span class="keyword1" id="UniformTieBreaking-lm012"><span class="command">lemma</span></span> lm012<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="main">{}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> emptyset_part_emptyset3 rangeEmpty characterizationallAllocations
        mem_Collect_eq subsetI vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="UniformTieBreaking-lm013"><span class="command">lemma</span></span> lm013<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms elementOfPartitionOfFiniteSetIsFinite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> allocationReverseInjective<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> allocationFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_converse Range_converse imageE allocationProperty finiteDomainImpliesFinite lm013
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="UniformTieBreaking-lm014"><span class="command">lemma</span></span> lm014<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Range <span class="free">a</span><span class="main">.</span> finite <span class="bound">y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms is_partition_of_def allocationInverseRangeDomainProperty
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper rev_finite_subset<span class="main">)</span>

<span class="comment1">(* Note that allocations are strict, that is, all goods are allocated to the bidders at this point. Later we will have the seller as participant 0 getting all goods not allocated *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm015<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">G</span> <span class="main">=</span> sum card <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms cardSumCommute lm013 allocationInverseRangeDomainProperty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_partition_of_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Results on summed bid vectors›</span></span>

<span class="keyword1" id="UniformTieBreaking-lm016"><span class="command">lemma</span></span> lm016<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">|</span>
    <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Note that || stands for restriction, here to an allocation a *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm017<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span> <span class="main">||</span> <span class="free">a</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>   <span class="main">∩</span>  <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrictionVsIntersection<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm018<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">||</span> <span class="free">a</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted">summedBidVectorRel</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
             <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm016<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="var">?M</span> <span class="main">||</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm017<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm019"><span class="command">lemma</span></span> lm019<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> 
    <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm020<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">||</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">=</span><span class="quoted">summedBidVectorRel</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">summedBid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">pair</span><span class="main">,</span> sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="free">bids</span> <span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
           <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm018<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm019 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* the function made by (summedBid bids) is always injective, that is, also with domain UNIV *)</span>
<span class="keyword1" id="UniformTieBreaking-summedBidInjective"><span class="command">lemma</span></span> summedBidInjective<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> UNIV"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> fst_conv inj_on_inverseI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> 

<span class="comment1">(* restrict above to any set X *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm021<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> fst_conv inj_on_inverseI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* relationship between different formalizations of summedBid *)</span>
<span class="keyword1" id="UniformTieBreaking-lm022"><span class="command">lemma</span></span> lm022<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum snd <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> 
   sum <span class="main">(</span>snd <span class="main">∘</span> <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm021 sum.reindex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="comment1">(* remember: omega of (1,{11,12,13}) is {(1,{11}), (1,{12}), (1,{13})} *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm023<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>summedBid <span class="free">bids</span> <span class="free">pair</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">bids</span> <span class="main">(</span>omega <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sumCurry <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* restatement of the above *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm024<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> summedBid <span class="free">bids</span> <span class="main">=</span> <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">∘</span> omega"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm023 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="UniformTieBreaking-lm025"><span class="command">lemma</span></span> lm025<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite  <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>omega <span class="free">pair</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">corollary</span></span> lm026<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>omega <span class="free">pair</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms cardFinestpart card_cartesian_product_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="UniformTieBreaking-lm027"><span class="command">lemma</span></span> lm027<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>omega <span class="main">`</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"omega <span class="main">`</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">finestpart</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y1</span> <span class="skolem">y2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">∧</span> <span class="skolem">y2</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pair1</span></span> <span class="skolem"><span class="skolem">pair2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">=</span> omega <span class="skolem">pair1</span> <span class="main">&amp;</span> <span class="skolem">y2</span> <span class="main">=</span> omega <span class="skolem">pair2</span> <span class="main">&amp;</span> <span class="skolem">pair1</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">&amp;</span> <span class="skolem">pair2</span> <span class="main">∈</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">pair1</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">&amp;</span> snd <span class="skolem">pair1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_image_eqI snd_eq_Range<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">pair1</span> <span class="main">=</span> fst <span class="skolem">pair2</span> <span class="main">⟷</span> <span class="skolem">pair1</span> <span class="main">=</span> <span class="skolem">pair2</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms runiq_basic surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">∩</span> <span class="skolem">y2</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="skolem">y1</span> <span class="main">=</span> <span class="skolem">y2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">=</span> <span class="skolem">y2</span> <span class="main">⟷</span> <span class="skolem">y1</span> <span class="main">∩</span> <span class="skolem">y2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms notEmptyFinestpart <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb Times_empty insert_not_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_non_overlapping_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> inf_commute inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm028"><span class="command">lemma</span></span> lm028<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on omega <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">finestpart</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pair1</span> <span class="skolem">pair2</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pair1</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">&amp;</span> <span class="skolem">pair2</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">pair1</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">&amp;</span> snd <span class="skolem">pair2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Range.intros surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"omega <span class="skolem">pair1</span> <span class="main">=</span> omega <span class="skolem">pair2</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">(</span>snd <span class="skolem">pair1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">(</span>snd <span class="skolem">pair2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">pair1</span> <span class="main">=</span> snd <span class="skolem">pair2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finestPart nonEqualitySetOfSets<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fst <span class="skolem">pair1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>fst <span class="skolem">pair2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> notEmptyFinestpart 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_image_times<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pair1</span> <span class="main">=</span> <span class="skolem">pair2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_eqI singleton_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> inj_onI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm029"><span class="command">lemma</span></span> lm029<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> omega <span class="main">`</span> <span class="free">a</span><span class="main">.</span> finite <span class="bound">X</span>"</span></span> 
          <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>card <span class="main">∘</span> omega<span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum card <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cardinalityPreservation<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lm028 sum.reindex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm030"><span class="command">lemma</span></span> lm030<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>omega <span class="free">pair</span><span class="main">)</span><span class="main">=</span> card <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> cardFinestpart card_cartesian_product_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm031<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"card <span class="main">∘</span> omega <span class="main">=</span> card <span class="main">∘</span> snd"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm030 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* set image of omega on a set of pair is called pseudoAllocation *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm032<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">.</span> finite <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>card <span class="main">∘</span> snd<span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted">pseudoAllocation</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span><span class="quoted">card</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">.</span> finite <span class="main">(</span>omega <span class="bound">pair</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finiteFinestpart assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm027 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">(</span><span class="var">?P</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="var">?c</span> <span class="main">∘</span> omega<span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm029 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="var">?c</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm031 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm033<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">a</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">.</span> finite <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum card <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sumPairsInverse lm032 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">corollary</span></span> lm034<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyNotInRange<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">.</span> finite <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm014 finitePairSecondRange <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms allocationFinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Int_lower1 in_mono allocationInjectionsUnivervseProperty mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runiq <span class="main">(</span><span class="free">a</span><span class="main">^-1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> injections_def characterizationallAllocations mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum card <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm033 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm015 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm035<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">aa</span> <span class="main">⊆</span> pseudoAllocation <span class="free">a</span> <span class="main">∪</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>finestpart <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">-</span> 
            <span class="main">(</span>sum <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">-</span> 
            card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms subsetCardinality <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm036<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">aa</span> <span class="main">⊆</span> pseudoAllocation <span class="free">a</span> <span class="main">∪</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>finestpart <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>sum <span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
           int <span class="main">(</span>sum <span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         int <span class="main">(</span>card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
           int <span class="main">(</span>card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> differenceSumVsCardinality assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-lm037"><span class="command">lemma</span></span> lm037<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pseudoAllocation <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> lm038<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">using</span></span> assms lm012 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm039<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> lm034 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm040<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finite.emptyI lm039 lm038 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="UniformTieBreaking-lm041"><span class="command">lemma</span></span> lm041<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span>pseudoAllocation <span class="free">a</span> <span class="main">=</span> pseudoAllocation <span class="free">aa</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">=</span><span class="quoted">pseudoAllocation</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span><span class="main">=</span><span class="quoted">card</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AA</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">aa</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="var">?A</span><span class="main">=</span><span class="var">?c</span> <span class="free">G</span> <span class="main">&amp;</span> <span class="var">?c</span> <span class="var">?AA</span><span class="main">=</span><span class="var">?c</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm034 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span> <span class="main">&amp;</span> finite <span class="var">?AA</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm040 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms cardinalityIntersectionEquality <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* alternative definition for omega *)</span>
<span class="keyword1" id="UniformTieBreaking-lm042"><span class="command">lemma</span></span> lm042<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"omega <span class="free">pair</span> <span class="main">=</span> <span class="main">{</span>fst <span class="free">pair</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="free">pair</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> finestpart_def finestPart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* variant of above *)</span>
<span class="keyword1" id="UniformTieBreaking-lm043"><span class="command">lemma</span></span> lm043<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"omega <span class="free">pair</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span>  snd <span class="free">pair</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm042 setOfPairs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="UniformTieBreaking-lm044"><span class="command">lemma</span></span> lm044<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span><span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span><span class="main">}</span><span class="main">|</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">using</span></span> lm043 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-lm045"><span class="command">lemma</span></span> lm045<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span><span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span><span class="main">}</span><span class="main">|</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm046<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">using</span></span> setOfPairsEquality <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="UniformTieBreaking-lm047"><span class="command">lemma</span></span> lm047<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span>snd <span class="bound">pair</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span> <span class="main">=</span> 
         <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> assms Domain.DomainI fst_conv functionOnFirstEqualsSecond runiq_wrt_ex1 surjective_pairing
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm048<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">using</span></span> assms lm047 lm046 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm049<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>finestpart <span class="main">`</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def
  <span class="keyword1"><span class="command">using</span></span> lm046 rangeSetOfPairs unionFinestPart  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm050<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Range <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> finestpart <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> commuteUnionFinestpart lm049 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1" id="UniformTieBreaking-lm051"><span class="command">lemma</span></span> lm051<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm044 lm045 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="UniformTieBreaking-lm052"><span class="command">lemma</span></span> lm052<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span> <span class="main">=</span> 
   <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="UniformTieBreaking-lm053"><span class="command">lemma</span></span> lm053<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">a</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="main">{</span><span class="main">(</span>fst <span class="bound">pair</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span> <span class="bound">pair</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="bound">pair</span> <span class="main">&amp;</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm051<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm052<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm054"><span class="command">lemma</span></span> lm054<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> graph_def image_Collect_mem domainOfGraph <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm055<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"runiq <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="main">||</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">using</span></span> lm054 subrel_runiq Int_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-summedBidVectorCharacterization"><span class="command">lemma</span></span> summedBidVectorCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Domain <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm056<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> Domain <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">allAllocations</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span><span class="main">=</span><span class="quoted">summedBidVectorRel</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms allocationPowerset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Domain <span class="main">(</span><span class="var">?L</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> summedBidVectorCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm057<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∩</span> <span class="main">(</span>Domain <span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   sum snd <span class="main">(</span><span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">||</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sumRestrictedToDomainInvariant lm055 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm058<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="main">(</span>summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">||</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">=</span><span class="quoted">summedBidVector</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span><span class="main">=</span><span class="quoted">summedBidVectorRel</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> Domain <span class="main">(</span><span class="var">?L</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm056<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="var">?L</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="var">?l</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span><span class="var">?l</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="var">?L</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm057 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm059<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> 
         sum snd <span class="main">(</span><span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">summedBid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted">summedBidVectorRel</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted">summedBidVector</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?p</span> <span class="free">bids</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="var">?A</span> <span class="main">∩</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">||</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> sum snd <span class="var">?inner1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm020 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="var">?l</span> <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum snd <span class="var">?inner1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm058<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm060<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">summedBid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">=</span><span class="quoted">summedBidVector</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="main">(</span><span class="var">?p</span> <span class="free">bids</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">∩</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm059<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms allocationPowerset Int_absorb1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm061<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sum snd <span class="main">(</span><span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span> <span class="main">`</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>snd <span class="main">∘</span> <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum.reindex lm021 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm062<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>snd <span class="main">∘</span> <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">summedBid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted">summedBidVector</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum snd <span class="main">(</span><span class="main">(</span><span class="var">?p</span> <span class="free">bids</span><span class="main">)</span><span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm060<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm061 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm063<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">∘</span> omega<span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="main">(</span>summedBid <span class="free">bids</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">∘</span> omega"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"sum <span class="var">?inner1</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm062<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inner1</span> <span class="main">=</span> <span class="var">?inner2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm023 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm064<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>omega<span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyNotInRange<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on omega <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm028 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">∘</span> omega<span class="main">)</span> <span class="free">a</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">∘</span> omega<span class="main">)</span> <span class="free">a</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> assms lm063 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Extraction.exE_realizer<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm065"><span class="command">lemma</span></span> lm065<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>omega <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finite.emptyI finite.insertI finite_SigmaI finiteFinestpart  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm066<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">.</span> finite <span class="bound">y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> finite <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm065 imageE finitePairSecondRange <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm067<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> finite <span class="bound">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm066 lm014 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm068<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_non_overlapping <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms image_iff allocationRightUniqueRangeDomain<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyNotInRange<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm027 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm069"><span class="command">lemma</span></span> lm069<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>omega<span class="main">`</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">bids</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sumUnionDisjoint2 lm068 lm067 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm070<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="free">bids</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>omega <span class="main">`</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm064 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">bids</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>omega <span class="main">`</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm069 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm071"><span class="command">lemma</span></span> lm071<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domain <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pseudoAllocation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> lm072<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span>   <span class="main">&amp;</span>   Range <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span> <span class="main">=</span> finestpart <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm071 allocationInverseRangeDomainProperty lm050 is_partition_of_def subset_trans 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm073<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pseudoAllocation <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> finestpart <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">pseudoAllocation</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted">Domain</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">Range</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="var">?aa</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm072 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="var">?aa</span> <span class="main">⊆</span> finestpart <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm072 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> equalityE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="var">?aa</span> <span class="main">×</span> <span class="main">(</span><span class="var">?r</span> <span class="var">?aa</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> finestpart <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> finestpart <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>








<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From Pseudo-allocations to allocations›</span></span>

<span class="comment1">(* pseudoAllocationInv inverts pseudoAllocation *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pseudoAllocationInv</span> <span class="free"><span class="bound"><span class="entity">pseudo</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pseudo</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free"><span class="bound"><span class="entity">pseudo</span></span></span><span class="main">}</span>"</span></span>
 
<span class="keyword1" id="UniformTieBreaking-lm074"><span class="command">lemma</span></span> lm074<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> pseudoAllocationInv <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">|</span> <span class="bound">Y</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="main">&amp;</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?p</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="var">?p</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">.</span> <span class="free">a</span><span class="main">,,</span><span class="bound">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms eval_runiq_in_Range<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> Domain <span class="free">a</span><span class="main">.</span> finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> notEmptyFinestpart<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> Domain <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊇</span> Domain <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">=</span> Domain <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?a</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Domain <span class="var">?p</span> <span class="main">&amp;</span> <span class="skolem">z</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span> <span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?p</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Domain <span class="free">a</span> <span class="main">&amp;</span> <span class="skolem">z</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span> <span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?p</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">``</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>finestpart <span class="main">(</span><span class="free">a</span><span class="main">,,</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">=</span> <span class="free">a</span><span class="main">,,</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finestPartUnion<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_runiq_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">⊆</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"fst <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">,,</span><span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?YY</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"finestpart <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">&amp;</span> <span class="var">?x</span> <span class="main">∈</span> Domain <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_eq_Domain rev_image_eqI<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">&amp;</span> <span class="var">?x</span> <span class="main">∈</span> Domain <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">``</span> <span class="main">{</span><span class="var">?x</span><span class="main">}</span> <span class="main">=</span> <span class="var">?YY</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="var">?p</span> <span class="main">``</span> <span class="main">{</span><span class="var">?x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finestPartUnion<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="var">?x</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> functionOnFirstEqualsSecond
                                                           surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> pseudoAllocation <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm048 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm075<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> runiqs <span class="main">∩</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pseudoAllocationInv <span class="main">∘</span> pseudoAllocation<span class="main">)</span> <span class="free">a</span> <span class="main">=</span> id <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"runiq <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> runiqs_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> Range <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm074 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm076"><span class="command">lemma</span></span> lm076<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>pseudoAllocationInv <span class="main">∘</span> pseudoAllocation<span class="main">)</span> <span class="main">(</span>runiqs <span class="main">∩</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ne</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"runiqs <span class="main">∩</span> <span class="var">?ne</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"pseudoAllocationInv <span class="main">∘</span> pseudoAllocation"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">a2</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">a1</span> <span class="main">=</span> <span class="var">?f</span> <span class="bound">a2</span> <span class="main">⟶</span> id <span class="bound">a1</span> <span class="main">=</span> id <span class="bound">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm075 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a1</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">a2</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">a1</span> <span class="main">=</span> <span class="var">?f</span> <span class="bound">a2</span> <span class="main">⟶</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm077<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on pseudoAllocation <span class="main">(</span>runiqs <span class="main">∩</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm076 inj_on_imageI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-lm078"><span class="command">lemma</span></span> lm078<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"injectionsUniverse <span class="main">⊆</span> runiqs"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> runiqs_def Collect_conj_eq Int_lower1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="UniformTieBreaking-lm079"><span class="command">lemma</span></span> lm079<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"partitionValuedUniverse <span class="main">⊆</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> is_non_overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">corollary</span></span> lm080<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allocationsUniverse <span class="main">⊆</span> runiqs <span class="main">∩</span> Pow <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm078 lm079 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lm081<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on pseudoAllocation allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm077 lm080 subset_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm082<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inj_on pseudoAllocation <span class="main">(</span>allAllocations <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">G</span> <span class="main">⊆</span> allocationsUniverse"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> allAllocationsUniverse<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"inj_on pseudoAllocation <span class="main">(</span>allAllocations <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm081 subset_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm083"><span class="command">lemma</span></span> lm083<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span> <span class="main">⊆</span> set <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms winningAllocationPossible allAllocationsBridgingLemma <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
 
<span class="keyword1"><span class="command">corollary</span></span> lm084<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span> <span class="main">∩</span> set <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted">winningAllocationsRel</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted">allAllocationsAlg</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_gt_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="free">N</span> <span class="var">?G</span> <span class="free">bids</span> <span class="main">⊆</span> set <span class="main">(</span><span class="var">?a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm083 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms lm011 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set le_iff_inf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -` is the reverse image *)</span>
<span class="keyword1" id="UniformTieBreaking-lm085"><span class="command">lemma</span></span> lm085<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">-`</span><span class="main">{</span>True<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> lm086<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span><span class="main">)</span><span class="main">-`</span><span class="main">{</span>True<span class="main">}</span> <span class="main">∩</span> 
         set <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm084 lm085 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="UniformTieBreaking-lm087"><span class="command">lemma</span></span> lm087<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">∩</span> set <span class="free">l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"takeAll <span class="free">P</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms nonEmptyListFiltered filterpositions2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm088<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm087 lm086 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> lm089<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perm2 <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span><span class="main">)</span> 
                        <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> 
               <span class="free">n</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms permutationNotEmpty lm088 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* The chosen allocation is in the set of possible winning allocations *)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm090<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span> <span class="main">∈</span> winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b_x</span> <span class="bound">x</span><span class="main">.</span> set <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span> 
        <span class="main">∨</span> <span class="main">(</span>randomEl <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b_x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> set<span class="main">)</span> <span class="main">∈</span> <span class="bound">x</span> 
        <span class="main">∨</span> <span class="main">¬</span> set <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> randomElLemma subsetCE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"winningAllocationRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> 
          <span class="main">(</span><span class="main">(∈)</span> <span class="main">(</span>randomEl <span class="main">(</span>takeAll <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> winningAllocationRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">(∈)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">bids</span><span class="main">)</span>
                <span class="main">(</span>allAllocationsAlg <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">random</span><span class="main">)</span><span class="main">)</span> <span class="free">bids</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lm088 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> takeAllSubset set_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The following lemma proves a property of maxbid, which in the following will be proved to maximize the revenue. a and aa are allocations. *)</span>
<span class="keyword1" id="UniformTieBreaking-lm091"><span class="command">lemma</span></span> lm091<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>sum<span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
            sum<span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">)</span> <span class="main">=</span> 
         real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> 
            card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">pseudoAllocation</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted">finestpart</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted">maxbid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="free">a</span> <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="free">aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="var">?f</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm073 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="free">aa</span> <span class="main">⊆</span> <span class="var">?p</span> <span class="free">a</span> <span class="main">∪</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="var">?f</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm034 lm040 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>sum <span class="var">?B</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> sum <span class="var">?B</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span> <span class="main">=</span> 
                   real<span class="main">(</span>card <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">-</span>card<span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> differenceSumVsCardinalityReal <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms lm034 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UniformTieBreaking-lm092"><span class="command">lemma</span></span> lm092<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"summedBidVectorRel <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="main">=</span> graph <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>summedBidSecond <span class="free">bids</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> graph_def <span class="keyword1"><span class="command">using</span></span> lm016 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-lm093"><span class="command">lemma</span></span> lm093<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toFunction <span class="main">(</span>graph <span class="free">X</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> graphEqImage toFunction_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm094<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="free">pair</span> <span class="main">=</span> summedBidSecond <span class="free">bids</span> <span class="free">pair</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm093 lm092 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* type conversion to real commutes *)</span>
<span class="keyword1" id="UniformTieBreaking-lm095"><span class="command">lemma</span></span> lm095<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"summedBidSecond <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span><span class="main">(</span><span class="free">bids</span><span class="main">::</span> <span class="main">_</span> <span class="main">=&gt;</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">pair</span> <span class="main">=</span> real <span class="main">(</span>summedBidSecond <span class="free">bids</span> <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="UniformTieBreaking-lm096"><span class="command">lemma</span></span> lm096<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"summedBidVector <span class="main">(</span>real<span class="main">∘</span><span class="main">(</span><span class="free">bids</span><span class="main">::</span> <span class="main">_</span> <span class="main">=&gt;</span> nat<span class="main">)</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="free">pair</span> <span class="main">=</span> 
          real <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="free">pair</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm094 lm095 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* TPTP?*)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm097<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pair</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span><span class="free">bids</span><span class="main">::</span><span class="main">_</span><span class="main">=&gt;</span>nat<span class="main">)</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="bound">pair</span> <span class="main">=</span>
         <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="bound">pair</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="free">bids</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> real <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm096 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">X</span> <span class="main">∨</span> summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="free">bids</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span>real <span class="main">∘</span> summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">X</span> <span class="main">∨</span> summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="free">bids</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span>real <span class="main">∘</span> summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="skolem">esk48<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pair</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="free">bids</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="bound">pair</span> <span class="main">=</span> <span class="main">(</span>real <span class="main">∘</span> summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="bound">pair</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm098<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">G</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">(</span>summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span><span class="free">bids</span><span class="main">::</span><span class="main">_</span><span class="main">=&gt;</span>nat<span class="main">)</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">aa</span> <span class="main">=</span> 
         real <span class="main">(</span>sum <span class="main">(</span><span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">aa</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">aa</span><span class="main">.</span> summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="free">bids</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span> <span class="bound">pair</span> <span class="main">=</span> 
                     <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="bound">pair</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm097<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> sum <span class="main">(</span>real<span class="main">∘</span><span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">aa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm099<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">(</span>summedBidVector <span class="main">(</span>real <span class="main">∘</span> <span class="main">(</span><span class="free">bids</span><span class="main">::</span><span class="main">_</span><span class="main">=&gt;</span>nat<span class="main">)</span><span class="main">)</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">aa</span> <span class="main">=</span> 
         real <span class="main">(</span>sum <span class="main">(</span><span class="main">(</span>summedBidVector <span class="free">bids</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">aa</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm098 allocationPowerset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lm100<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">=</span> 
         real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">=</span><span class="quoted">summedBidVector</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">=</span><span class="quoted">maxbid</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main">=</span><span class="quoted">sum</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">pseudoAllocation</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bb</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="free">a</span> <span class="free">N</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"real <span class="main">∘</span> <span class="main">(</span><span class="var">?m</span> <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm091 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?b</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">=</span> <span class="var">?s</span> <span class="var">?b</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm070 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?b</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?bb</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm099<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?bb</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?b</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">=</span><span class="main">(</span><span class="var">?s</span> <span class="var">?b</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm070 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?b</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?bb</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm099<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">(</span><span class="var">?l</span> <span class="var">?bb</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> real <span class="main">(</span><span class="var">?s</span> <span class="var">?bb</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm101<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> real <span class="main">(</span>sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;=</span> card <span class="free">G</span> <span class="main">&amp;</span> 
         <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">&amp;</span> 
        <span class="main">(</span><span class="free">x</span><span class="main">=</span><span class="main">0</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">aa</span><span class="main">)</span> <span class="main">&amp;</span> 
        <span class="main">(</span><span class="free">aa</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">⟶</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">&lt;</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">pseudoAllocation</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">&gt;=</span> real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">=</span> 
                 real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span>pseudoAllocation <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> assms lm100 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span>real<span class="main">(</span>card <span class="free">G</span><span class="main">)</span><span class="main">-</span>card<span class="main">(</span>pseudoAllocation <span class="free">aa</span><span class="main">∩</span><span class="main">(</span>pseudoAllocation <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span> <span class="main">&amp;</span> card <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm034 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span><span class="main">)</span> <span class="main">&amp;</span> finite <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm040 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="var">?p</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Int_lower2 card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm100 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">=</span> <span class="var">?p</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> 3 lm041 4 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="free">aa</span> <span class="main">=</span> <span class="var">?p</span> <span class="free">a</span> <span class="main">⟶</span> <span class="free">a</span> <span class="main">=</span> <span class="free">aa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm082 inj_on_def 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="free">G</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> real <span class="main">(</span>card <span class="free">G</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?p</span> <span class="free">aa</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?p</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm100 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="free">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">⟶</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">&lt;</span> real <span class="main">(</span>sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 1 4 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 4 5
    <span class="keyword1"><span class="command">unfolding</span></span> of_nat_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="comment1">(* If for an arbitrary allocation a we compute tiebids for it then the corresponding revenue is strictly maximal. *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm102<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">aa</span> <span class="main">&lt;</span> sum <span class="main">(</span>tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">G</span><span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms lm101 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="UniformTieBreaking-lm103"><span class="command">lemma</span></span> lm103<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">∈</span> <span class="main">(</span>allAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">-</span><span class="main">{</span>chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>resolvingBid <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span><span class="main">)</span> <span class="free">aa</span> <span class="main">&lt;</span> 
         sum <span class="main">(</span>resolvingBid <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span><span class="main">)</span> <span class="main">(</span>chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">=</span><span class="quoted">allAllocations</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"set <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm090 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"winningAllocationsRel <span class="free">N</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="free">bids</span> <span class="main">⊆</span> <span class="var">?p</span> <span class="free">N</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms winningAllocationPossible <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?p</span> <span class="free">N</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm090 assms winningAllocationPossible rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms lm102 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* putting together the two rounds in the auction, first using the bids, then the random values. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">terminatingAuctionRel</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> 
              argmax <span class="main">(</span>sum <span class="main">(</span>resolvingBid <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">)</span><span class="main">)</span> 
                     <span class="main">(</span>argmax <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">bids</span></span></span><span class="main">)</span> <span class="main">(</span>allAllocations <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Termination theorem: it assures that the number of winning allocations is exactly one›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> winningAllocationUniqueness<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminatingAuctionRel <span class="free">N</span> <span class="free">G</span> <span class="main">(</span><span class="free">bids</span><span class="main">)</span> <span class="free">random</span> <span class="main">=</span> <span class="main">{</span>chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted">allAllocations</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"argmax <span class="main">(</span>sum <span class="free">bids</span><span class="main">)</span> <span class="main">(</span><span class="var">?p</span> <span class="free">N</span> <span class="var">?G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"chosenAllocation <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"resolvingBid <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum <span class="var">?b</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">=</span><span class="quoted">terminatingAuctionRel</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aa</span> <span class="main">∈</span> <span class="main">(</span>allAllocations <span class="free">N</span> <span class="var">?G</span><span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="var">?a</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">aa</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="var">?a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms lm103 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">aa</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="var">?a</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">aa</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm103 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?p</span> <span class="free">N</span> <span class="var">?G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms allAllocationsFinite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset winningAllocationPossible<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lm090 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?X</span> <span class="main">&amp;</span> <span class="var">?a</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">aa</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="var">?a</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">aa</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="var">?a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="var">?X</span> <span class="main">&amp;</span> <span class="var">?a</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">aa</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="var">?a</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">aa</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="var">?a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> argmax <span class="var">?f</span> <span class="var">?X</span> <span class="main">=</span> <span class="main">{</span><span class="var">?a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> argmaxProperty<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?a</span><span class="main">}</span> <span class="main">=</span> argmax <span class="var">?f</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> injectionsFromEmptyIsEmpty <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?t</span> <span class="free">N</span> <span class="free">G</span> <span class="free">bids</span> <span class="free">random</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The computable variant of Else is defined next as Elsee.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toFunctionWithFallbackAlg</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">fallback</span></span></span> <span class="main">==</span> 
            <span class="main">(</span><span class="main">%</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> Domain <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fallback</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> toFunctionWithFallbackAlg <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">Elsee</span>"</span> 75<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CombinatorialAuction">
<div class="head">
<h1>Theory CombinatorialAuction</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹VCG auction: definitions and theorems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CombinatorialAuction

<span class="keyword2"><span class="keyword">imports</span></span>
<a href="UniformTieBreaking.html">UniformTieBreaking</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of a VCG auction scheme, through the pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">vcga</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">vcgp</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="comment1">(* b is a bid vector and participants is the set of all participants present in b *)</span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">participants</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> Domain <span class="main">(</span>Domain <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* goods is the list of goods auctioned *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">goods</span> <span class="main">==</span> sorted_list_of_set <span class="keyword1">o</span> Union <span class="keyword1">o</span> Range <span class="keyword1">o</span> Domain"</span></span>

<span class="comment1">(* The seller is represented as integer 0, the other particants as integers 1, ..., n *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">seller</span> <span class="main">==</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>integer<span class="main">)</span>"</span></span>

<span class="comment1">(* allAllocations' and allAllocations'' are variants of allAllocations. All three formulations are equivent. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">allAllocations'</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> 
  injectionsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">&amp;</span> Range <span class="bound">a</span> <span class="main">∈</span> all_partitions <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">allAllocations''</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domain <span class="bound">a</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="CombinatorialAuction-allAllocationsEquivalence"><span class="command">lemma</span></span> allAllocationsEquivalence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> allAllocations' <span class="free">N</span> <span class="free">Ω</span> <span class="main">&amp;</span> allAllocations <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> allAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> allocationInjectionsUnivervseProperty allAllocationsIntersection <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CombinatorialAuction-allAllocationsVarCharacterization"><span class="command">lemma</span></span> allAllocationsVarCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allAllocations'' <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allocationsUniverse<span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">(* remove the seller from the set of all allocations *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">soldAllocations</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* soldAllocations' and soldAllocations'' are variants of soldAllocations reflecting the different
   formulations of allAllocations. soldAllocations''' is yet another variant. These variants are
   used since for different proofs different variants are easier to use. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">soldAllocations'</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>allAllocations' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">soldAllocations''</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>allAllocations'' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">soldAllocations'''</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> 
  allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">aa</span><span class="main">.</span> Domain <span class="bound">aa</span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span>Range <span class="bound">aa</span><span class="main">)</span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1" id="CombinatorialAuction-soldAllocationsEquivalence"><span class="command">lemma</span></span> soldAllocationsEquivalence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"soldAllocations <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> soldAllocations' <span class="free">N</span> <span class="free">Ω</span> <span class="main">&amp;</span> 
   soldAllocations' <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> allAllocationsEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> soldAllocationsEquivalenceVariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"soldAllocations <span class="main">=</span> soldAllocations'  <span class="main">&amp;</span> 
   soldAllocations' <span class="main">=</span> soldAllocations'' <span class="main">&amp;</span> 
   soldAllocations <span class="main">=</span> soldAllocations''"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> soldAllocationsEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CombinatorialAuction-allocationSellerMonotonicity"><span class="command">lemma</span></span> allocationSellerMonotonicity<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"soldAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free">Ω</span> <span class="main">⊆</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CombinatorialAuction-allocationsUniverseCharacterization"><span class="command">lemma</span></span> allocationsUniverseCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allocationsUniverse<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CombinatorialAuction-allocationMonotonicity"><span class="command">lemma</span></span> allocationMonotonicity<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N1</span> <span class="main">⊆</span> <span class="free">N2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allAllocations'' <span class="free">N1</span> <span class="free">Ω</span> <span class="main">⊆</span> allAllocations'' <span class="free">N2</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CombinatorialAuction-allocationWithOneParticipant"><span class="command">lemma</span></span> allocationWithOneParticipant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">a</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CombinatorialAuction-soldAllocationIsAllocation"><span class="command">lemma</span></span> soldAllocationIsAllocation<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
<span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span>  <span class="main">=</span><span class="skolem">aa</span> <span class="main">--</span> seller <span class="main">&amp;</span> <span class="skolem">aa</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="skolem">aa</span> <span class="main">&amp;</span> <span class="skolem">aa</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Outside_def <span class="keyword1"><span class="command">using</span></span> allAllocationsIntersectionSubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsetAllocation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-soldAllocationIsAllocationVariant"><span class="command">lemma</span></span> soldAllocationIsAllocationVariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span>Domain <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms soldAllocationIsAllocation
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-onlyGoodsAreSold"><span class="command">lemma</span></span> onlyGoodsAreSold<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CombinatorialAuction-soldAllocationIsRestricted"><span class="command">lemma</span></span> soldAllocationIsRestricted<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">∃</span><span class="bound">aa</span><span class="main">.</span> <span class="bound">aa</span> <span class="main">--</span> <span class="main">(</span>seller<span class="main">)</span> <span class="main">=</span> <span class="free">a</span>  <span class="main">∧</span>  <span class="bound">aa</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span><span class="free">N</span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Note that +* enlarges the function by one additional pair *)</span>
<span class="keyword1" id="CombinatorialAuction-restrictionConservation"><span class="command">lemma</span></span> restrictionConservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">+*</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">--</span> <span class="free">x</span> <span class="main">=</span> <span class="free">R</span> <span class="main">--</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Outside_def paste_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CombinatorialAuction-allocatedToBuyerMeansSold"><span class="command">lemma</span></span> allocatedToBuyerMeansSold<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"seller"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Ω</span><span class="main">-</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">×</span><span class="var">?Y</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∪</span><span class="var">?b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+*</span> <span class="var">?b</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span>
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="var">?i</span><span class="main">,</span><span class="free">Ω</span><span class="main">-</span><span class="main">⋃</span><span class="main">(</span>Range <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="var">?i</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> allocationUniverseProperty subsetAllocation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
  3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  4<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">∩</span> Domain <span class="var">?b</span> <span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allocationUnion<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span>Domain <span class="var">?aa</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?aa</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> allocationsUniverseCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?aa</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> allocationMonotonicity assms paste_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Range <span class="var">?aa</span> <span class="main">=</span> Range <span class="free">a</span> <span class="main">∪</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?aa</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ω</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Un_Diff_cancel Un_Diff_cancel2 Union_Un_distrib Union_empty Union_insert  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cSup_singleton subset_Un_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa'</span> <span class="main">=</span> <span class="var">?aa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> paste_disj_domains<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa'</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="var">?b</span> <span class="main">⊆</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?aa'</span> <span class="main">--</span> <span class="var">?i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">--</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrictionConservation<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> soldAllocationIsRestricted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-allocationCharacterization"><span class="command">lemma</span></span> allocationCharacterization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="free">Ω</span>  <span class="main">=</span>  
   <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> injectionsUniverse <span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">&amp;</span> Range <span class="free">a</span> <span class="main">∈</span> all_partitions <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> posssibleAllocationsRelCharacterization<span class="main">)</span>

<span class="comment1">(* The lemmas lm01, lm02, lm03, and lm04 are used in order to prove
   lemma soldAllocationVariantEquivalence   *)</span>
<span class="keyword1" id="CombinatorialAuction-lm01"><span class="command">lemma</span></span> lm01<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"seller"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">aa</span> <span class="main">--</span> <span class="var">?i</span> <span class="main">&amp;</span> <span class="skolem">aa</span> <span class="main">∈</span> allAllocations'' <span class="main">(</span><span class="free">N</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> soldAllocationIsRestricted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="skolem">aa</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> allocationCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">-</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms soldAllocationsEquivalenceVariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> soldAllocationIsAllocation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm02<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm01 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lm01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms onlyGoodsAreSold <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm03<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">aa</span><span class="main">.</span> Domain <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="bound">aa</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">∈</span>soldAllocations'' <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="free">a</span><span class="main">∈</span>allocationsUniverse<span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm02 allocatedToBuyerMeansSold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">∈</span>allocationsUniverse<span class="main">&amp;</span> Domain <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm04<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span>
   <span class="main">(</span><span class="free">a</span><span class="main">∈</span> <span class="main">(</span>allocationsUniverse <span class="main">∩</span> <span class="main">{</span><span class="bound">aa</span><span class="main">.</span> Domain <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span>seller<span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="bound">aa</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm03 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Int_iff<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> soldAllocationVariantEquivalence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"soldAllocations'' <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> soldAllocations''' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">{</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∈</span> <span class="var">?R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm04<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* We use lm05 in order to show a variant for soldAllocations without ''' *)</span>
<span class="keyword1" id="CombinatorialAuction-lm05"><span class="command">lemma</span></span> lm05<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations''' <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">--</span> <span class="free">n</span> <span class="main">∈</span> soldAllocations''' <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bb</span></span></span> <span class="main">=</span> <span class="quoted">seller</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted">Domain</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">Range</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">aa</span><span class="main">.</span> <span class="var">?d</span> <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span><span class="var">?r</span> <span class="bound">aa</span><span class="main">)</span><span class="main">⊆</span><span class="free">Ω</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">aa</span><span class="main">.</span> <span class="var">?d</span> <span class="bound">aa</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span><span class="var">?r</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="var">?X2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span> <span class="main">&amp;</span> <span class="main">⋃</span><span class="main">(</span><span class="var">?r</span> <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">(</span><span class="free">a</span><span class="main">--</span><span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> outside_reduces_domain <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_mono subset_refl<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">(</span><span class="free">a</span><span class="main">--</span><span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">-</span><span class="main">{</span><span class="var">?bb</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span><span class="free">a</span><span class="main">--</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Ω</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Outside_def <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">--</span> <span class="free">n</span> <span class="main">∈</span> <span class="var">?X1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">--</span><span class="free">n</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Int_iff allocationsUniverseOutside <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-allAllocationsEquivalenceExtended"><span class="command">lemma</span></span> allAllocationsEquivalenceExtended<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"soldAllocations <span class="main">=</span>  soldAllocations' <span class="main">&amp;</span> 
   soldAllocations' <span class="main">=</span> soldAllocations'' <span class="main">&amp;</span>
   soldAllocations'' <span class="main">=</span> soldAllocations'''"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> soldAllocationVariantEquivalence soldAllocationsEquivalenceVariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* The following corollary shows that an allocation is invariant to subtracting a single bidder.   
   This is used a fundamental step to prove the non-negativity of price in VCG. *)</span>
<span class="keyword1"><span class="command">corollary</span></span> soldAllocationRestriction<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">--</span> <span class="free">n</span> <span class="main">∈</span> soldAllocations <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted">soldAllocations'''</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="var">?A'</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms allAllocationsEquivalenceExtended <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">--</span> <span class="free">n</span> <span class="main">∈</span> <span class="var">?A'</span> <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm05<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> allAllocationsEquivalenceExtended <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> allocationGoodsMonotonicity<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ω1</span> <span class="main">⊆</span> <span class="free">Ω2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"soldAllocations''' <span class="free">N</span> <span class="free">Ω1</span> <span class="main">⊆</span> soldAllocations''' <span class="free">N</span> <span class="free">Ω2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> allocationGoodsMonotonicityVariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ω1</span> <span class="main">⊆</span> <span class="free">Ω2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"soldAllocations'' <span class="free">N</span> <span class="free">Ω1</span> <span class="main">⊆</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"soldAllocations'' <span class="free">N</span> <span class="free">Ω1</span> <span class="main">=</span> soldAllocations''' <span class="free">N</span> <span class="free">Ω1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> soldAllocationVariantEquivalence<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> soldAllocations''' <span class="free">N</span> <span class="free">Ω2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allocationGoodsMonotonicity<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> soldAllocations'' <span class="free">N</span> <span class="free">Ω2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> soldAllocationVariantEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* maximalStrictAllocationsAlg are the allocations maximizing the revenue. They also include the
   unallocated goods assigned to the seller (bidder 0).*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">maximalStrictAllocations</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> argmax <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* randomBids builds up a bid vector from a random number so that bidding with this bid vector
   resolves any ties. Details are defined in UniformTieBreaking.thy *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">randomBids</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> resolvingBid <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span>"</span></span>

<span class="comment1">(* vcgas gives the one-element set with the winning allocation after tie breaking.
   (argmax∘sum) b ... determines the set of all maximal allocations.
   (argmax∘sum) (randomBids ...) restricts that by tie-breaking to a singleton.
   Outside' {seller} removes the seller from the only allocation in the singleton.   *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcgas</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>  <span class="main">==</span> 
  Outside' <span class="main">{</span>seller<span class="main">}</span> <span class="main">`</span><span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
                                      <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Takes the element out of the one elemnt set (vcgas ...) *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcga</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> the_elem <span class="main">(</span>vcgas <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* alternative definition of vcga *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcga'</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
  <span class="main">(</span>the_elem <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBids <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">(</span>maximalStrictAllocations <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">--</span> seller"</span></span>

<span class="comment1">(* The following three auxiliary lemmas, lm06, lm07, and lm08 are used to prove lemma
   vcgaEquivalence as well as in the theorem that cardinality of vcgas is one.*)</span>
<span class="keyword1" id="CombinatorialAuction-lm06"><span class="command">lemma</span></span> lm06<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> 
                                 <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> 
         <span class="main">(</span>the_elem <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> 
                                    <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">--</span> seller"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cardOneTheElem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lm07<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> 
                                 <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> 
                                        <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">--</span> seller"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm06<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-lm08"><span class="command">lemma</span></span> lm08<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">bids</span> <span class="free">random</span><span class="main">)</span>
                               <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">bids</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?l</span><span class="main">=</span><span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">bids</span> <span class="free">random</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted">sum</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted">argmax</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∘</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?N</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">(</span><span class="var">?s</span> <span class="var">?b'</span><span class="main">)</span> <span class="main">(</span><span class="var">?a</span> <span class="main">(</span><span class="var">?s</span> <span class="free">bids</span><span class="main">)</span> <span class="main">(</span>allAllocations <span class="var">?N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{</span>chosenAllocation <span class="var">?N</span> <span class="free">Ω</span> <span class="free">bids</span> <span class="free">random</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> winningAllocationUniqueness<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span> <span class="var">?f</span> <span class="var">?b'</span> <span class="main">(</span><span class="var">?f</span> <span class="free">bids</span> <span class="main">(</span>allAllocations <span class="var">?N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">{</span>chosenAllocation <span class="var">?N</span> <span class="free">Ω</span> <span class="free">bids</span> <span class="free">random</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">...</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-vcgaEquivalence"><span class="command">lemma</span></span> vcgaEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lm07 lm08 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* After showing that the cardinality of vcgas is 1, we know that the_elem to determine vcga
   will return a definite value. *)</span>
<span class="keyword1"><span class="command">theorem</span></span> vcgaDefiniteness<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>vcgas <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> 
                              <span class="main">(</span><span class="main">(</span>argmax<span class="main">∘</span>sum<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">1</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?X</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms lm08 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Outside'<span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="var">?X</span> <span class="main">=</span> vcgas <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cardOneImageCardOne <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The following lemma is a variant of the vcgaDefiniteness theorem. *)</span>
<span class="keyword1" id="CombinatorialAuction-vcgaDefinitenessVariant"><span class="command">lemma</span></span> vcgaDefinitenessVariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"card <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                       <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">1</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?L</span><span class="main">=</span><span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>seller<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?n</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?n</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminatingAuctionRel <span class="main">(</span><span class="var">?n</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>chosenAllocation <span class="main">(</span><span class="var">?n</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> winningAllocationUniqueness<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> terminatingAuctionRel <span class="main">(</span><span class="var">?n</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> winningAllocationIsMaximal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                          <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
         <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="var">?X</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?X</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vcgaDefinitenessVariant<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cardinalityOneTheElem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> winningAllocationIsMaximalWithoutSeller<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms winningAllocationIsMaximal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CombinatorialAuction-maximalAllactionWithoutSeller"><span class="command">lemma</span></span> maximalAllactionWithoutSeller<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊆</span> soldAllocations <span class="free">N</span> <span class="free">Ω</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CombinatorialAuction-onlyGoodsAreAllocatedAuxiliary"><span class="command">lemma</span></span> onlyGoodsAreAllocatedAuxiliary<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> winningAllocationIsMaximalWithoutSeller<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> maximalAllactionWithoutSeller  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> onlyGoodsAreAllocated<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">∈</span><span class="var">?r</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> onlyGoodsAreAllocatedAuxiliary<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms vcgaEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Let b be a bid vector such that the seller's bid for each possible set of goods is 0 then 
   the revenue does not depend on the presence of the seller. *)</span>
<span class="keyword1"><span class="command">corollary</span></span> neutralSeller<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> Range <span class="free">a</span> <span class="main">⟶</span><span class="free">b</span> <span class="main">(</span>seller<span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="free">a</span> <span class="main">=</span> sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span><span class="main">--</span>seller<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted">seller</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">a</span><span class="main">||</span><span class="main">{</span><span class="var">?n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Int<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">a</span><span class="main">||</span><span class="main">{</span><span class="var">?n</span><span class="main">}</span><span class="main">.</span> <span class="free">b</span> <span class="bound">z</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span><span class="free">a</span><span class="main">||</span><span class="main">{</span><span class="var">?n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.neutral<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sumOutside assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.comm_neutral<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> neutralSellerVariant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> finite <span class="bound">a</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span>Range <span class="bound">a</span> <span class="main">⟶</span> <span class="free">b</span> <span class="main">(</span>seller<span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>sum <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>sum <span class="free">b</span> <span class="main">(</span><span class="bound">a</span> <span class="main">--</span> seller<span class="main">)</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms neutralSeller <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="CombinatorialAuction-vcgaIsMaximalAux1"><span class="command">lemma</span></span> vcgaIsMaximalAux1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>  <span class="main">∧</span>  <span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">--</span> seller<span class="main">)</span>  <span class="main">&amp;</span>
                <span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> argmax <span class="main">(</span>sum <span class="free">b</span><span class="main">)</span> <span class="main">(</span>allAllocations <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms winningAllocationIsMaximalWithoutSeller <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="CombinatorialAuction-vcgaIsMaximalAux2"><span class="command">lemma</span></span> vcgaIsMaximalAux2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">X</span> <span class="main">∈</span> Range <span class="bound">a</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span>seller<span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="var">?X</span><span class="main">.</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Max<span class="main">{</span>sum <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted">seller</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted">sum</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span> <span class="main">&amp;</span> 
      <span class="var">?a</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">--</span><span class="var">?n</span> <span class="main">&amp;</span> 
      <span class="main">(</span><span class="skolem">a</span> <span class="main">∈</span> argmax <span class="main">(</span>sum <span class="free">b</span><span class="main">)</span> <span class="main">(</span>allAllocations<span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span><span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&amp;</span> <span class="var">?a</span><span class="main">=</span><span class="main">_</span> <span class="main">&amp;</span> <span class="skolem">a</span><span class="main">∈</span><span class="var">?Z</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> vcgaIsMaximalAux1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">.</span> finite <span class="bound">a</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span>Range <span class="bound">a</span> <span class="main">⟶</span> <span class="free">b</span> <span class="main">(</span><span class="var">?n</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> List.finite_set allocationFinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> 
  2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?X</span><span class="main">∩</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="var">?s</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="var">?s</span> <span class="free">b</span> <span class="main">`</span> <span class="var">?X</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> injectionsUnionCommute <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="var">?s</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="var">?s</span> <span class="free">b</span> <span class="main">`</span> <span class="var">?X</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> injectionsUnionCommute <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="free">b</span> <span class="main">`</span> <span class="var">?X</span> <span class="main">=</span> <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="var">?X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="free">b</span> <span class="skolem">a</span> <span class="main">=</span> Max <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="var">?X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="var">?X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="main">(</span><span class="bound">a</span><span class="main">--</span><span class="var">?n</span><span class="main">)</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="var">?X</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> neutralSellerVariant<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> Outside' <span class="main">{</span><span class="var">?n</span><span class="main">}</span><span class="main">`</span><span class="var">?X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="var">?s</span> <span class="free">b</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?s</span> <span class="free">b</span> <span class="main">(</span><span class="skolem">a</span><span class="main">--</span><span class="var">?n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 neutralSeller <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="free">b</span> <span class="var">?a</span><span class="main">=</span>Max<span class="main">{</span><span class="var">?s</span> <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Adequacy theorem: The allocation satisfies the standard pen-and-paper specification 
of a VCG auction. See, for example, \cite[\S~1.2]{cramton}.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> vcgaIsMaximal<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span>seller<span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span> <span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Max<span class="main">{</span>sum <span class="free">b</span> <span class="bound">a</span><span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> soldAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms vcgaIsMaximalAux2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> vcgaIsAllocationAllocatingGoodsOnly<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> allocationsUniverse <span class="main">&amp;</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Ω</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted">seller</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">--</span> seller <span class="main">&amp;</span> <span class="skolem">a</span> <span class="main">∈</span> maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms winningAllocationIsMaximalWithoutSeller <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> 
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="main">{</span><span class="var">?n</span><span class="main">}</span><span class="main">∪</span><span class="free">N</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span> <span class="main">⊆</span> allocationsUniverse"</span></span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> winningAllocationPossible 
                                    allAllocationsUniverse subset_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">--</span> seller  <span class="main">&amp;</span>  <span class="skolem">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> allocationsUniverseOutside <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> set <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> allAllocationsIntersectionSetEquals 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?a</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Outside_def 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> allocationsUniverseOutside Outside_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The price a participant n has to pay is the revenue achieved if n had not participated minus
   the value of the goods allocated not to n. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcgp</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span>
   Max <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">`</span> <span class="main">(</span>soldAllocations <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">-</span>  <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>vcga <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">--</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Since vcga is well-defined the following theorem is trivial. *)</span>
<span class="keyword1"><span class="command">theorem</span></span> vcgpDefiniteness<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">y</span><span class="main">.</span> vcgp <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms vcgaDefiniteness <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CombinatorialAuction-soldAllocationsFinite"><span class="command">lemma</span></span> soldAllocationsFinite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>soldAllocations <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms allAllocationsFinite finite.emptyI finite.insertI finite_UnI finite_imageI 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The price paid by any participant is non-negative.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> NonnegPrices<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vcgp <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="free">n</span> <span class="main">&gt;=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>price<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted">soldAllocations</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum <span class="free">b</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?A</span> <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> onlyGoodsAreAllocated<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">--</span> <span class="free">n</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> soldAllocationRestriction<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?A</span> <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> soldAllocationsFinite finite_set finite_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?f</span><span class="main">`</span><span class="main">(</span><span class="var">?A</span> <span class="main">(</span><span class="free">N</span><span class="main">-</span><span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?f</span> <span class="main">(</span><span class="var">?a</span> <span class="main">--</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&gt;=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> maxLemma<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">-</span> <span class="var">?R</span> <span class="main">&gt;=</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-allocationDisjointAuxiliary"><span class="command">lemma</span></span> allocationDisjointAuxiliary<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">∈</span> Domain <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">∈</span> Domain <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">,,</span><span class="free">n1</span> <span class="main">∩</span> <span class="free">a</span><span class="main">,,</span><span class="free">n2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">a</span> <span class="main">∈</span> partitionsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonOverlapping <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> injectionsUniverse <span class="main">&amp;</span> <span class="free">a</span> <span class="main">∈</span> partitionValuedUniverse"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> IntD1 IntD2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">,,</span><span class="free">n1</span> <span class="main">∈</span> Range <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> eval_runiq_in_Range mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">,,</span><span class="free">n1</span> <span class="main">≠</span> <span class="free">a</span><span class="main">,,</span><span class="free">n2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms converse.intros eval_runiq_rel mem_Collect_eq runiq_basic 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> is_non_overlapping_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> eval_runiq_in_Range mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-allocationDisjoint"><span class="command">lemma</span></span> allocationDisjoint<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">∈</span> Domain <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">∈</span> Domain <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">,,,</span><span class="free">n1</span> <span class="main">∩</span> <span class="free">a</span><span class="main">,,,</span><span class="free">n2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms allocationDisjointAuxiliary imageEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹No good is assigned twice.›</span></span>
<span class="comment1">(* We assume implicitely that n1, n2 are participants, Ω a goods list and N the participant set
   with "n1 ∈ Domain (vcga' N Ω b r)" "n2 ∈ Domain (vcga' N Ω b r)". However,
   formally these assumptions are not needed for the theorem. *)</span> 
<span class="keyword1"><span class="command">theorem</span></span> PairwiseDisjointAllocations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">,,,</span><span class="free">n1</span> <span class="main">∩</span> <span class="main">(</span>vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">,,,</span><span class="free">n2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> allocationsUniverse"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vcgaIsAllocationAllocatingGoodsOnly assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> allocationDisjoint assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nothing outside the set of goods is allocated.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> OnlyGoodsAllocated<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">(</span>vcga <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">,,,</span><span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="free">Ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vcga' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> allocationsUniverse"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> vcgaIsAllocationAllocatingGoodsOnly <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"runiq <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> Domain <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms vcgaEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span><span class="main">,,</span><span class="free">n</span> <span class="main">∈</span> Range <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eval_runiq_in_Range <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">with</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span><span class="main">,,,</span><span class="free">n</span> <span class="main">∈</span> Range <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imageEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms vcgaEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>Range <span class="var">?a</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> vcgaIsAllocationAllocatingGoodsOnly <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computable versions of the VCG formalization›</span></span>

<span class="comment1">(*  The computable versions are used to extract code.
   Furthermore we prove the equivalence with their classical counterparts. This computes the set of all maximal allocations including the seller. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">maximalStrictAllocationsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span>
  argmax <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>allAllocationsAlg <span class="main">(</span><span class="main">{</span>seller<span class="main">}</span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* This computes the maximal allocation after tie breaking. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">chosenAllocationAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>integer<span class="main">)</span> <span class="main">==</span> 
  <span class="main">(</span>randomEl <span class="main">(</span>takeAll <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="main">(</span>argmax <span class="main">∘</span> sum<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>set <span class="main">(</span>allAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">(</span>allAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span> 
            <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is the computable version of maxbid in UniformTieBreaking.thy. It takes an allocation, 
   the bidders and the goods and computes a bid such for each good a bidder bids 1 if they get
   that good in allocation a, else they bid 0.*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxbidAlg</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> <span class="main">(</span>bidMaximizedBy <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* This is the completed version of summedBidVectorRel by returning 0 if 
   summedBidVectorRel is not defined. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">summedBidVectorAlg</span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> <span class="main">(</span>summedBidVectorRel <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* Computable version of tiebids. If computes a bid vector that when the VCG algorithm runs 
   on it yields the singleton {a}. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tiebidsAlg</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> summedBidVectorAlg <span class="main">(</span>maxbidAlg <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span>"</span></span>

<span class="comment1">(* Computable version of resolvingBid, that is, is computes the bid vector in random values 
   that returns the chosen winning allocation *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">resolvingBidAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> 
  tiebidsAlg <span class="main">(</span>chosenAllocationAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The same as above, but adding the seller who receives all unallocated goods. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">randomBidsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> resolvingBidAlg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span>"</span></span>

<span class="comment1">(* Computable allocation without those participants who do not receive anything. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcgaAlgWithoutLosers</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> 
  <span class="main">(</span>the_elem <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBidsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">(</span>maximalStrictAllocationsAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">--</span> seller"</span></span>

<span class="comment1">(* Adding losers to an arbitrary allocation *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">addLosers</span> <span class="free"><span class="bound"><span class="entity">participantset</span></span></span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span> <span class="main">==</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">participantset</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="main">+*</span> <span class="free"><span class="bound"><span class="entity">allocation</span></span></span>"</span></span>

<span class="comment1">(* Computable version of vcga. It computes the winning allocation incl. losers. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcgaAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> addLosers <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>vcgaAlgWithoutLosers <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Computable version of soldAllocations *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">soldAllocationsAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="main">==</span> 
  <span class="main">(</span>Outside' <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>allAllocationsAlg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∪</span> <span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Computable version of vcgp, which computes the prices each participant has to pay. Note that
   losers do not pay anything, hence vcgaAlgWithoutLosers is here equivalent to vcgaAlg. 
   The price a participant n has to pay is the revenue achieved if n had not participated minus
   the value of the goods allocated not to n.*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcgpAlg</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">winningAllocation</span></span></span><span class="main">::</span>allocation<span class="main">)</span> <span class="main">=</span>
  Max <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">`</span> <span class="main">(</span>soldAllocationsAlg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
  <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">winningAllocation</span></span></span> <span class="main">--</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CombinatorialAuction-functionCompletion"><span class="command">lemma</span></span> functionCompletion<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Domain <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"toFunction <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> toFunctionWithFallbackAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms toFunction_def<span class="main">)</span>

<span class="comment1">(* This technical lemma shows the equivalence of Elsee and toFunction inside a sum expression
   under certain assumptions. It is used for the proof of the bridging theorem that
   the two versions of the definition of maximalStrictAllocations are equivalent.*)</span>
<span class="keyword1" id="CombinatorialAuction-lm09"><span class="command">lemma</span></span> lm09<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">pair</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">pair</span> <span class="main">∈</span> Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> 
                <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         sum <span class="main">(</span><span class="main">%</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> 
                <span class="main">(</span>finestpart <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">g</span><span class="main">.</span><span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">g</span><span class="main">.</span><span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span><span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> finestpart <span class="main">(</span>snd <span class="free">pair</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> finestpart <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms finestpartSubset  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff Pow_iff in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">g</span> <span class="main">=</span> <span class="var">?f2</span> <span class="skolem">g</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">×</span> finestpart <span class="free">Ω</span> <span class="main">∨</span> <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 0 mem_Sigma_iff<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pseudoAllocation <span class="free">a</span> <span class="main">&lt;|</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> finestpart <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> 
                 maxbidAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span> <span class="main">(</span>fst <span class="free">pair</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> toFunctionWithFallbackAlg_def maxbidAlg_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domainCharacteristicFunction UnCI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> toFunction_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> maxbidAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* lm10, lm11, lm12, l13 are variants of lm09 *)</span>
<span class="keyword1"><span class="command">corollary</span></span> lm10<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"summedBid <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="free">pair</span> <span class="main">=</span> 
          summedBid <span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> <span class="free">pair</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">pair</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">pair</span> <span class="main">∈</span> Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lm09 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm11<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pair</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>  
   summedBid <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="bound">pair</span> <span class="main">=</span> 
   summedBid <span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> <span class="bound">pair</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1"><span class="command">corollary</span></span> lm12<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>summedBid <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">=</span>
   <span class="main">(</span>summedBid <span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">`</span> <span class="var">?Z</span> <span class="main">=</span> <span class="var">?f2</span> <span class="main">`</span> <span class="var">?Z</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">z</span> <span class="main">∈</span> <span class="var">?Z</span><span class="main">.</span> <span class="var">?f1</span> <span class="bound">z</span> <span class="main">=</span> <span class="var">?f2</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lm11<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> functionEquivalenceOnSets<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lm13<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"summedBidVectorRel <span class="main">(</span>toFunction <span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span>
   summedBidVectorRel <span class="main">(</span><span class="main">(</span>bidMaximizedBy <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lm12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> maxbidEquivalence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"summedBidVectorRel <span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> 
   summedBidVectorRel <span class="main">(</span>maxbidAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> maxbidAlg_def <span class="keyword1"><span class="command">using</span></span> lm13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CombinatorialAuction-summedBidVectorEquivalence"><span class="command">lemma</span></span> summedBidVectorEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"summedBidVector <span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span> <span class="main">=</span> summedBidVectorAlg <span class="main">(</span>maxbidAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="var">?g1</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?f2</span> <span class="var">?g2</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxbidAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summedBidVectorRel <span class="var">?h1</span> <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> summedBidVectorRel <span class="var">?h2</span> <span class="free">N</span> <span class="free">Ω</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> maxbidEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summedBidVectorAlg <span class="var">?h2</span> <span class="free">N</span> <span class="free">Ω</span> <span class="main">=</span> <span class="main">(</span>summedBidVectorRel <span class="var">?h2</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> summedBidVectorAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" summedBidVectorAlg <span class="var">?h2</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">=</span>summedBidVectorRel <span class="var">?h1</span> <span class="free">N</span> <span class="free">Ω</span> <span class="keyword1">Elsee</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>toFunction <span class="main">(</span>summedBidVectorRel <span class="var">?h1</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms functionCompletion summedBidVectorCharacterization <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summedBidVectorAlg <span class="var">?h2</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>toFunction <span class="main">(</span>summedBidVectorRel <span class="var">?h1</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TPTP ? *)</span>
<span class="keyword1"><span class="command">corollary</span></span> chosenAllocationEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"chosenAllocation <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="main">=</span> chosenAllocationAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms allAllocationsBridgingLemma
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> chosenAllocationAlg_def comp_apply<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> tiebidsBridgingLemma<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tiebids <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span> <span class="main">=</span> tiebidsAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="main">_</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> summedBidVector <span class="main">(</span>maxbid <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> summedBidVectorAlg <span class="main">(</span>maxbidAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span><span class="main">)</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> summedBidVectorEquivalence<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tiebidsAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tiebids'</span><span class="main">=</span>tiebids"</span></span>
<span class="keyword1"><span class="command">corollary</span></span> tiebidsBridgingLemma'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tiebids' <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span> <span class="main">=</span> tiebidsAlg <span class="free">a</span> <span class="free">N</span> <span class="free">Ω</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms tiebidsBridgingLemma tiebids'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">resolvingBid'</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span> <span class="main">==</span> 
  tiebids' <span class="main">(</span>chosenAllocation <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">bids</span></span></span> <span class="free"><span class="bound"><span class="entity">random</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CombinatorialAuction-resolvingBidEquivalence"><span class="command">lemma</span></span> resolvingBidEquivalence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"resolvingBid' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> resolvingBidAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms chosenAllocationEquivalence tiebidsBridgingLemma' resolvingBidAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
<span class="keyword1" id="CombinatorialAuction-sumResolvingBidEquivalence"><span class="command">lemma</span></span> sumResolvingBidEquivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>resolvingBid' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>resolvingBidAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">a</span><span class="main">.</span> resolvingBid' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="bound">x</span> <span class="main">=</span> resolvingBidAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="bound">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms resolvingBidEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-resolvingBidBridgingLemma"><span class="command">lemma</span></span> resolvingBidBridgingLemma<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>resolvingBid <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>resolvingBidAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span>sum <span class="main">(</span>resolvingBid' <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tiebids'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span><span class="var">?R</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumResolvingBidEquivalence<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CombinatorialAuction-allAllocationsInPowerset"><span class="command">lemma</span></span> allAllocationsInPowerset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"allAllocations <span class="free">N</span> <span class="free">Ω</span> <span class="main">⊆</span> Pow <span class="main">(</span><span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="free">Ω</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PowI allocationPowerset subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> resolvingBidBridgingLemmaVariant1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>resolvingBid <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>resolvingBidAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">×</span> <span class="main">(</span>Pow <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> allAllocationsInPowerset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> resolvingBidBridgingLemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> resolvingBidBridgingLemmaVariant2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> sup_eq_bot_iff insert_not_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_gt_0_iff finite.emptyI finite.insertI finite_UnI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> allAllocations <span class="main">(</span><span class="free">N</span><span class="main">∪</span><span class="main">{</span>seller<span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> randomBidsAlg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> resolvingBidBridgingLemmaVariant1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> tiebreakingGivesSingleton<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                      <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">.</span> 
        sum <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="bound">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>1<span class="main">)</span> resolvingBidBridgingLemmaVariant2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"argmax <span class="main">(</span>sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>
             argmax <span class="main">(</span>sum <span class="main">(</span>randomBids <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> argmaxEquivalence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vcgaDefinitenessVariant<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> maximalAllocationBridgingTheorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> maximalStrictAllocationsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>seller<span class="main">}</span> <span class="main">∪</span> <span class="free">N</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?N</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> card_gt_0_iff finite_insert insert_is_Un insert_not_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> allAllocationsBridgingLemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> vcgaAlgDefinedness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ω</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>maximalStrictAllocationsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>argmax <span class="main">(</span>sum <span class="main">(</span>randomBidsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tiebreakingGivesSingleton<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximalStrictAllocations <span class="free">N</span> <span class="main">(</span>set <span class="free">Ω</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> maximalStrictAllocationsAlg <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> maximalAllocationBridgingTheorem<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CombinatorialAuctionCodeExtraction">
<div class="head">
<h1>Theory CombinatorialAuctionCodeExtraction</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹VCG auction: Scala code extraction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CombinatorialAuctionCodeExtraction

<span class="keyword2"><span class="keyword">imports</span></span>
<a href="CombinatorialAuction.html">CombinatorialAuction</a>

<span class="comment1">(* The following theories are needed for the extraction of Scala code *)</span>
<span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span> 
<span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Int.html">HOL-Library.Code_Target_Int</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Next we define some auxiliary functions to facilitate pretty printing in Scala *)</span>
<span class="comment1">(* allocationPrettyPrint transforms sets into lists *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">allocationPrettyPrint</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
   <span class="main">{</span>map <span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> sorted_list_of_set<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>sorted_list_of_set <span class="main">∘</span> Domain<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="comment1">(* We define bids in Scala as lists of three elements: (participants, goods, bid). To use our
   vcga algorithm we need the bid vector to be a function from pairs (participant, {goods}) to
   the corresponding bid. Bid2funcBid does this conversion. singleBidConverter is a corresponding
   helper function. *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">singleBidConverter</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">==</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> set <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Bid2funcBid</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> set <span class="main">(</span>map singleBidConverter <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">Elsee</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>integer<span class="main">)</span>"</span></span>

<span class="comment1">(* participantsSet extracts the participants from a bid vector. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">participantsSet</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* goodsList extracts the goods from a bid vector. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">goodsList</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>Union <span class="main">(</span><span class="main">(</span>set <span class="keyword1">o</span> fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span><span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* payment is a wrapper to reuse the allocation so that it is computed only once. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">payments</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span>allocation<span class="main">)</span> <span class="main">=</span> 
            vcgpAlg <span class="main">(</span><span class="main">(</span>participantsSet <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>goodsList <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>Bid2funcBid <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">::</span>allocation<span class="main">)</span>"</span></span>

<span class="comment1">(* Isabelle will export code for the vcgaAlg and payments as well as all other functions
   necessary for the computation and write it to a file of choice, in this case the file
   VCG.scala *)</span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">vcgaAlg</span></span> <span class="quoted"><span class="quoted">payments</span></span> <span class="quoted"><span class="quoted">allocationPrettyPrint</span></span> <span class="keyword2"><span class="keyword">in</span></span> Scala <span class="keyword2"><span class="keyword">module_name</span></span> VCG 
            <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹VCG-withoutWrapper.scala›</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* At this moment in time the code generated works well under Linux. However, there is a naming
   conflict in Windows originating from conflating nat and Nat as well as sup_set and Sup_set. 
   In order to make the code runnable under Windows as well, it is possible to universally
   replace, e.g., Nat by NNat and Sup_set by SSup_set. The following shell command may be 
   helpful with that. *)</span>
<span class="comment1">(* 
{ { echo asdff; tac VCG-withoutWrapper.scala ; } | 
    sed -n -e '1,/\}/ !p'  | 
    tac | 
    cat - ../addedWrapper.scala; echo \}; }| 
    sed -e "s/\(Nat\)\([^a-zA-Z]\)/NNat\2/g; s/\(Sup_set\)\([^a-zA-Z]\)/SSup_set\2/g" &gt;
    VCG.scala
*)</span>


</pre>
</div><div id="FirstPrice">
<div class="head">
<h1>Theory FirstPrice</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First-price auction: adapted from VCG auction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FirstPrice

<span class="keyword2"><span class="keyword">imports</span></span>
<a href="CombinatorialAuction.html">CombinatorialAuction</a>


<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* In a first price auction we use the same allocation algorithm as in a VCG auction. 
   The price a winning bidder has to pay is given by evaluating b with respect to the bidder
   and the set he/she gets. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">firstPriceP</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span>
  <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> winningAllocationAlg <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">Ω</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The non-negativity of prices follows immediately from the assumptions that all bids are
   non-negative. *)</span>
<span class="keyword1"><span class="command">theorem</span></span> NonnegFirstPrices<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"firstPriceP <span class="free">N</span> <span class="free">Ω</span> <span class="free">b</span> <span class="free">r</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CombinatorialAuctionExamples">
<div class="head">
<h1>Theory CombinatorialAuctionExamples</h1>
</div>
<pre class="source"><span class="comment1">(*
Auction Theory Toolbox (http://formare.github.io/auctions/)

Authors:
* Marco B. Caminati http://caminati.co.nr
* Manfred Kerber &lt;mnfrd.krbr@gmail.com&gt;
* Christoph Lange &lt;math.semantic.web@gmail.com&gt;
* Colin Rowat &lt;c.rowat@bham.ac.uk&gt;

Dually licenced under
* Creative Commons Attribution (CC-BY) 3.0
* ISC License (1-clause BSD License)
See LICENSE file for details
(Rationale for this dual licence: http://arxiv.org/abs/1107.3212)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹VCG auction: three simple examples evaluating the VCG allocation algorithm
          vcgaAlg and the price determination algorithm vcgpAlg in Isabelle›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CombinatorialAuctionExamples

<span class="keyword2"><span class="keyword">imports</span></span>
<a href="CombinatorialAuction.html">CombinatorialAuction</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* The following counterexample is built by deleting the additional assumption that n1 ≠ n2. *)</span>
<span class="comment1">(* Since this a "false" theorem, the following needs to be commented out, since otherwise
   the subsequent lines will fail. *)</span>
<span class="comment1">(* theorem counterexample_allocationDisjoint: 
  assumes "a ∈ allocationsUniverse" "n1∈ Domain a" "n2 ∈ Domain a"
  shows "a,,,n1 ∩ a,,,n2 = {}" nitpick
*)</span>


<span class="comment1">(* Test example 1 for evaluation of vcga and vcgp in Isabelle *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="comment1">(* r1 in {0, 1, 2, ... 23 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N1</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ω1</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">12</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>integer<span class="main">,</span> <span class="main">{</span><span class="numeral">11</span><span class="main">::</span>integer<span class="main">,</span> <span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>          <span class="numeral">2</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>          <span class="numeral">2</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>          <span class="numeral">2</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>          <span class="numeral">2</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcga1</span> <span class="main">=</span> vcgaAlg N1 Ω1 <span class="main">(</span>b1 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r1"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vcga1"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N1 Ω1 <span class="main">(</span>b1 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r1 <span class="main">1</span> vcga1"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N1 Ω1 <span class="main">(</span>b1 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r1 <span class="numeral">2</span> vcga1"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N1 Ω1 <span class="main">(</span>b1 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r1 <span class="numeral">3</span> vcga1"</span></span>

<span class="comment1">(* Test example 2 for evaluation of vcga and vcgp in Isabelle *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="comment1">(* r1 in {0, 1, 2, ... 23 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N2</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ω2</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">12</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>integer<span class="main">,</span> <span class="main">{</span><span class="numeral">11</span><span class="main">::</span>integer<span class="main">,</span> <span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="numeral">5</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>              <span class="numeral">3</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>              <span class="numeral">3</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>              <span class="numeral">2</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>              <span class="numeral">4</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcga2</span> <span class="main">=</span> vcgaAlg N2 Ω2 <span class="main">(</span>b2 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r2"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vcga2"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N2 Ω2 <span class="main">(</span>b2 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r2 <span class="main">1</span> vcga2"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N2 Ω2 <span class="main">(</span>b2 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r2 <span class="numeral">2</span> vcga2"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N2 Ω2 <span class="main">(</span>b2 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r2 <span class="numeral">3</span> vcga2"</span></span>


<span class="comment1">(* Test example 3 for evaluation of vcga and vcgp in Isabelle *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r3</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="comment1">(* r1 in {0, 1, 2, ... 47 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N3</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>integer<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ω3</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">12</span><span class="main">,</span> <span class="numeral">13</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b3</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>integer<span class="main">,</span> <span class="main">{</span><span class="numeral">11</span><span class="main">::</span>integer<span class="main">,</span> <span class="numeral">12</span><span class="main">,</span> <span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="numeral">20</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">,</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>               <span class="numeral">18</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>                  <span class="numeral">10</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>                  <span class="numeral">15</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>                  <span class="numeral">15</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">,</span><span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>               <span class="numeral">18</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>                   <span class="numeral">2</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">,</span><span class="numeral">12</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>               <span class="numeral">12</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">,</span><span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>               <span class="numeral">17</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">12</span><span class="main">,</span><span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>               <span class="numeral">18</span><span class="main">)</span><span class="main">,</span>
                  <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span>          <span class="main">{</span><span class="numeral">11</span><span class="main">,</span><span class="numeral">12</span><span class="main">,</span><span class="numeral">13</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>            <span class="numeral">19</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vcga3</span> <span class="main">=</span> vcgaAlg N3 Ω3 <span class="main">(</span>b3 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r3"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vcga3"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N3 Ω3 <span class="main">(</span>b3 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r3 <span class="main">1</span> vcga3"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N3 Ω3 <span class="main">(</span>b3 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r3 <span class="numeral">2</span> vcga3"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"vcgpAlg N3 Ω3 <span class="main">(</span>b3 <span class="keyword1">Elsee</span> <span class="main">0</span><span class="main">)</span> r3 <span class="numeral">3</span> vcga3"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>