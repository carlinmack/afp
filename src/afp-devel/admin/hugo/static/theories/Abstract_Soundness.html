<div id="Finite_Proof_Soundness">
<div class="head">
<h1>Theory Finite_Proof_Soundness</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Finite_Proof_Soundness
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Abstract_Completeness/Abstract_Completeness.html">Abstract_Completeness.Abstract_Completeness</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Soundness›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Soundness <span class="main">=</span> RuleSystem_Defs <span class="quoted"><span class="free">eff</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> fset <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">structure</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'structure</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'structure</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> local_soundness<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">.</span>
      <span class="main">⟦</span><span class="bound">r</span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span><span class="main">.</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s'</span><span class="main">⟧</span>
      <span class="main">⟹</span>
      <span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span><span class="main">.</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ssat</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span><span class="main">.</span> <span class="free">sat</span> <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> epath_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"epath <span class="main">(</span><span class="free">srs</span> <span class="main">@-</span> <span class="free">steps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"epath <span class="free">steps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">srs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">steps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ssat <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f w <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tfinite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfinite <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_soundness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="main"><span class="main"><span class="main">(</span></span></span>root <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fimage <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> root<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>cont <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> tfinite<span class="main">)</span>
      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Soundness *)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Infinite_Proof_Soundness">
<div class="head">
<h1>Theory Infinite_Proof_Soundness</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Infinite_Proof_Soundness
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Finite_Proof_Soundness.html">Finite_Proof_Soundness</a> <span class="quoted">"<a href="../../HOL/HOL-Library/BNF_Corec.html">HOL-Library.BNF_Corec</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Reference: A Generic Cyclic Theorem Prover
by James Brotherston, Nikos Gorogiannis, and Rasmus L. Petersen
*)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Soundness of Infinite Proof Trees›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">num</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>stake <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!!</span><span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> num<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> num <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!!</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="bound">m</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!!</span><span class="bound">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> n_def num_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LeastI_ex<span class="main"><span class="main">]</span></span> allI impI Least_le<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ev <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> list_all <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stake <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ev_induct_strong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> num_stl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"num <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> Suc <span class="main">(</span>num <span class="free">P</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> num_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Least_Suc<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"num <span class="free"><span class="free"><span class="free">P</span></span></span> <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> num<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">corecursive</span></span> <span class="entity">decr0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">Ord</span></span></span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="bound">js</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ord</span></span></span> <span class="main">∧</span> shd <span class="bound">js</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">js</span></span></span>
     <span class="keyword1">then</span> undefined
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">js</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ord</span></span></span> <span class="main">∧</span> shd <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span><span class="main">)</span>
          <span class="keyword1">then</span> shd <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">##</span> <span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">Ord</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">js</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">js</span></span></span>
          <span class="keyword1">else</span> <span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">Ord</span></span></span> <span class="free"><span class="bound"><span class="entity">minSoFar</span></span></span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">js</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Ord</span><span class="main">,</span><span class="bound">m</span><span class="main">,</span><span class="bound">js</span><span class="main">)</span><span class="main">.</span> num <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">Ord</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">m</span><span class="main">)</span> <span class="bound">js</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> well_order_on_defs <span class="main">=</span>
  well_order_on_def linear_order_on_def partial_order_on_def
  preorder_on_def trans_def antisym_def refl_on_def

<span class="keyword1"><span class="command">lemma</span></span> sdrop_length_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sdrop <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_iff_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xl</span> <span class="bound">xs2</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">xl</span> <span class="main">@-</span> <span class="bound">xs2</span> <span class="main">∧</span> <span class="free">φ</span> <span class="bound">xs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ev.base ev_imp_shift ev_shift<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> Infinite_Soundness <span class="main">=</span> RuleSystem_Defs <span class="quoted"><span class="free">eff</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> fset <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">structure</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'structure</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'structure</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sequent</span> <span class="main">⇒</span> <span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'marker</span> <span class="main">×</span> bool <span class="main">×</span> <span class="tfree">'marker</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ord</span> rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'marker</span> <span class="main">×</span> <span class="tfree">'structure</span> <span class="main">⇒</span> <span class="tfree">'ord</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    Ord<span class="main">:</span> <span class="quoted"><span class="quoted">"well_order <span class="free">Ord</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>
    descent<span class="main">:</span> <span class="comment1">(* The original paper has an error in stating this: quantifies existentially
  instead of universally over r *)</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span> <span class="bound">S</span><span class="main">.</span>
      <span class="main">⟦</span><span class="bound">r</span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">;</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span><span class="main">;</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span><span class="main">⟧</span>
      <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">s'</span> <span class="bound">S'</span><span class="main">.</span>
        <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl</span> <span class="main">∧</span> <span class="bound">S'</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S'</span> <span class="bound">s'</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="bound">v'</span> <span class="bound">b</span><span class="main">.</span>
          <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">s'</span> <span class="main">⟶</span>
             <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span> <span class="main">⟶</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The descent property subsumes local_soundness: *)</span>
<span class="keyword1"><span class="command">sublocale</span></span> Infinite_Soundness <span class="main">&lt;</span> Soundness <span class="keyword2"><span class="keyword">where</span></span> eff <span class="main">=</span> <span class="quoted"><span class="free">eff</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="main">=</span> <span class="quoted"><span class="free">rules</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"structure"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">structure</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sat <span class="main">=</span> <span class="quoted"><span class="free">sat</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> descent<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> Infinite_Soundness
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* The notion of a trace of markers following a path: to make the original paper definition
into a rigorous one, we include the trace of "progressing bits" as well:  *)</span>
<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">follow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool stream <span class="main">⇒</span> <span class="tfree">'marker</span> stream <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span>step stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">Ms</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> fst <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span> <span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">Ms</span></span></span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">⟧</span>
 <span class="main">⟹</span>
 <span class="free">follow</span> <span class="main">(</span>SCons <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">(</span>SCons <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">Ms</span></span></span><span class="main">)</span> <span class="main">(</span>SCons <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Now infinite progress simply means "always eventually the bit is True": *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">infDecr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">infDecr</span> <span class="main">≡</span> alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span><span class="main">.</span> shd <span class="bound">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Good trees: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">good</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span>dtree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">steps</span><span class="main">.</span>
  ipath <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">steps</span>
  <span class="main">⟶</span>
  ev <span class="main">(</span><span class="main">λ</span><span class="bound">steps'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">Ms</span><span class="main">.</span> follow <span class="bound">bs</span> <span class="bound">Ms</span> <span class="bound">steps'</span> <span class="main">∧</span> infDecr <span class="bound">bs</span><span class="main">)</span> <span class="bound">steps</span>"</span></span>
<span class="comment1">(* Note the mixture of temporal connectives and standard HOL quantifiers:
an advantage of the shallow embedding of LTL *)</span>

<span class="comment1">(* Trivially, finite trees are particular cases of good trees, since they
have no infinite paths: *)</span>
<span class="keyword1"><span class="command">lemma</span></span> tfinite_good<span class="main">:</span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span> <span class="main">⟹</span> good <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ftree_no_ipath <span class="keyword1"><span class="command">unfolding</span></span> good_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sequent</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sequent</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'sequent</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">konigDtree</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span> dtree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span> step <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"shd <span class="main">(</span><span class="free">konigDtree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"stl <span class="main">(</span><span class="free">konigDtree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">r</span> <span class="main">=</span> snd <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
   <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">|∈|</span> fimage <span class="main">(</span>fst <span class="keyword1">o</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">t'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="free">konigDtree</span> <span class="bound">t'</span> <span class="bound">a'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stl_konigDtree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≡</span> fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> snd <span class="main">(</span>root <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">|∈|</span> fimage <span class="main">(</span>fst <span class="keyword1">o</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="free">t</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">a''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">a''</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">a'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free">t</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">inv</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span>
  <span class="main">∧</span> stl <span class="main">(</span>konigDtree <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> konigDtree <span class="bound">t'</span> <span class="bound">a'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">|∈|</span> fimage <span class="main">(</span>fst <span class="keyword1">o</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'a'</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s'a'</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">s'a'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">t'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span>dtree<span class="main">)</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free">t</span> <span class="main">∧</span> <span class="var">?s'</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">a''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="var">?s'</span><span class="main">,</span><span class="var">?a'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> s'a'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free">t</span> <span class="main">∧</span> <span class="var">?s'</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s'</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free">t</span> <span class="main">∧</span> <span class="var">?s'</span> <span class="main">=</span> fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> t'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t' P s' assms P_def s'a'_def t'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?a'</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> konigDtree.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> konigDtree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span> <span class="bound">a</span><span class="main">.</span>
  <span class="main">⟦</span><span class="bound">r</span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">;</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s'</span> <span class="bound">a'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl</span> <span class="main">∧</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">stepas</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">stepas</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">=</span> shd <span class="main">(</span>stl <span class="bound">stepas</span><span class="main">)</span> <span class="keyword1">in</span>
          <span class="free">inv</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>konigDtree <span class="free">t</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alw <span class="skolem">t</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">|∈|</span> <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span>"</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> alw stl_konigDtree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf.cases<span class="main">)</span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> konigDtree_ipath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span> <span class="bound">a</span><span class="main">.</span>
  <span class="main">⟦</span><span class="bound">r</span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">;</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s'</span> <span class="bound">a'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl</span> <span class="main">∧</span> <span class="free">inv</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pred</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipath <span class="free">t</span> <span class="main">(</span>smap fst <span class="main">(</span>konigDtree <span class="free">t</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ipath <span class="skolem">t</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">|∈|</span> <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span>"</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ipath stl_konigDtree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf.cases<span class="main">)</span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context *)</span>

<span class="keyword1"><span class="command">lemma</span></span> follow_stl_smap_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"follow <span class="free">bs</span> <span class="free">Ms</span> <span class="main">(</span>smap fst <span class="free">stepSs</span><span class="main">)</span> <span class="main">⟹</span>
   follow <span class="main">(</span>stl <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">Ms</span><span class="main">)</span> <span class="main">(</span>smap fst <span class="main">(</span>stl <span class="free">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> follow.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream.map_sel <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_sel<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> epath_stl_smap_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"epath <span class="main">(</span>smap fst <span class="free">stepSs</span><span class="main">)</span> <span class="main">⟹</span>
   epath <span class="main">(</span>smap fst <span class="main">(</span>stl <span class="free">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> epath.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream.map_sel <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_sel<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> infDecr_tl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infDecr <span class="free">bs</span> <span class="main">⟹</span> infDecr <span class="main">(</span>stl <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> infDecr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Proof of the main theorem: *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">descent</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">descent</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="bound">v'</span> <span class="bound">b</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span> <span class="main">⟶</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> descentE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"descent <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">S'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="free">s</span> <span class="free">r</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">S'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟶</span> <span class="free">σ</span><span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">S'</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">konigDown</span> <span class="main">≡</span> konigDtree <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span><span class="main">)</span> descent"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> konigDown<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">structure</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">sat</span> <span class="free">S</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">stepSs</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">stepSs</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> shd <span class="main">(</span>stl <span class="bound">stepSs</span><span class="main">)</span> <span class="keyword1">in</span>
                    <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span> <span class="main">∧</span> descent <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> konigDtree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span>"</span></span> <span class="quoted">descent</span><span class="main">,</span> <span class="operator">unfolded</span> konigDown_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms descent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> konigDown_ipath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">structure</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">sat</span> <span class="free">S</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ipath <span class="free">t</span> <span class="main">(</span>smap fst <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> konigDtree_ipath<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span>"</span></span> <span class="quoted">descent</span><span class="main">,</span> <span class="operator">unfolded</span> konigDown_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms descent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"good <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">structure</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">sat</span> <span class="free">S</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_ev_Ord<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ks</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">ks</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="free">ks</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span><span class="main">)</span> <span class="free">ks</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">stepSs</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">stepSs</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> shd <span class="main">(</span>stl <span class="bound">stepSs</span><span class="main">)</span> <span class="keyword1">in</span>
                      <span class="bound">S</span> <span class="main">∈</span> <span class="free">structure</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">sat</span> <span class="bound">S</span> <span class="bound">s</span> <span class="main">∧</span> descent <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">P</span> <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> konigDown<span class="main">[</span><span class="operator">OF</span> w S<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">srs</span></span> <span class="skolem"><span class="skolem">steps</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">Ms</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"smap fst <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">srs</span> <span class="main">@-</span> <span class="skolem">steps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"follow <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">steps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"infDecr <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> konigDown_ipath<span class="main">[</span><span class="operator">OF</span> w S<span class="main">]</span> t <span class="keyword1"><span class="command">unfolding</span></span> good_def ev_iff_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">stepSs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">stepSs</span> <span class="main">=</span> sdrop <span class="main">(</span>length <span class="skolem">srs</span><span class="main">)</span> <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">steps</span> <span class="main">=</span> smap fst <span class="skolem">stepSs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stepSs_def sdrop_smap<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"epath <span class="skolem">steps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_ipath_epath<span class="main">[</span><span class="operator">OF</span> w konigDown_ipath<span class="main"><span class="main">[</span></span><span class="operator">OF</span> w S<span class="main"><span class="main">]</span></span><span class="main">]</span> 0 epath_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">P</span> <span class="main">(</span>konigDown <span class="free">t</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> konigDown<span class="main">[</span><span class="operator">OF</span> w S<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="skolem">P</span> <span class="skolem">stepSs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alw_sdrop <span class="keyword1"><span class="command">unfolding</span></span> stepSs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ks</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap <span class="free">σ</span> <span class="main">(</span>szip <span class="skolem">Ms</span> <span class="main">(</span>smap snd <span class="skolem">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ks</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">ks</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="var">?ks</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e f P <span class="keyword1"><span class="command">unfolding</span></span> steps <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">Ms</span></span> <span class="quoted"><span class="skolem">stepSs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw_coinduct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alw <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?steps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap fst <span class="skolem">stepSs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap snd <span class="skolem">stepSs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?MSs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"szip <span class="skolem">Ms</span> <span class="main">(</span>smap snd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="main">(</span>stl <span class="var">?steps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">Ms</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">Ms</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M</span><span class="main">,</span> <span class="var">?b</span><span class="main">,</span> <span class="var">?M'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="var">?s</span> <span class="var">?r</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹follow <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="main">(</span>smap fst <span class="skolem">stepSs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> follow.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"descent <span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span> <span class="var">?r</span> <span class="main">(</span><span class="var">?s'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹alw <span class="skolem">P</span> <span class="skolem">stepSs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="var">?M'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">(</span><span class="var">?M</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> descentE<span class="main">[</span><span class="operator">OF</span> 2 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stl <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">bs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">Ms</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">stepSs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span><span class="main">)</span> <span class="var">?ks</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e f P i <span class="keyword1"><span class="command">unfolding</span></span> steps <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">Ms</span></span> <span class="quoted"><span class="skolem">stepSs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw_coinduct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alw <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?steps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap fst <span class="skolem">stepSs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap snd <span class="skolem">stepSs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?MSs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"szip <span class="skolem">Ms</span> <span class="main">(</span>smap snd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="main">(</span>stl <span class="var">?steps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">Ms</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">Ms</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M</span><span class="main">,</span> <span class="var">?b</span><span class="main">,</span> <span class="var">?M'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="var">?s</span> <span class="var">?r</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹follow <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="main">(</span>smap fst <span class="skolem">stepSs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> follow.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"descent <span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span> <span class="var">?r</span> <span class="main">(</span><span class="var">?s'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹alw <span class="skolem">P</span> <span class="skolem">stepSs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="var">?M'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">(</span><span class="var">?M</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> descentE<span class="main">[</span><span class="operator">OF</span> 2 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev shd <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹infDecr <span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> infDecr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹epath <span class="var">?steps</span>›</span></span> <span class="quoted"><span class="quoted">‹follow <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="var">?steps</span>›</span></span> <span class="quoted"><span class="quoted">‹alw <span class="skolem">P</span> <span class="skolem">stepSs</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Ms</span></span> <span class="quoted"><span class="skolem">stepSs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?steps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap fst <span class="skolem">stepSs</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap snd <span class="skolem">stepSs</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?MSs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"szip <span class="skolem">Ms</span> <span class="main">(</span>smap snd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="main">(</span>stl <span class="var">?steps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="var">?steps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">stepSs</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">stepSs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">Ms</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="skolem">Ms</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">bs</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M</span><span class="main">,</span> <span class="var">?b</span><span class="main">,</span> <span class="var">?M'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="var">?s</span> <span class="var">?r</span> <span class="var">?s'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹follow <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="main">(</span>smap fst <span class="skolem">stepSs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> follow.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"descent <span class="main">(</span><span class="var">?s</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span> <span class="var">?r</span> <span class="main">(</span><span class="var">?s'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹alw <span class="skolem">P</span> <span class="skolem">stepSs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">(</span><span class="var">?M'</span><span class="main">,</span><span class="var">?S'</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span><span class="main">(</span><span class="var">?M</span><span class="main">,</span><span class="var">?S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> descentE<span class="main">[</span><span class="operator">OF</span> 2 1<span class="main">]</span> <span class="quoted"><span class="quoted">‹shd <span class="skolem">bs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span>
                  <span class="main">(</span>smap <span class="free">σ</span>
                  <span class="main">(</span>szip <span class="main">(</span>stl <span class="skolem">Ms</span><span class="main">)</span> <span class="main">(</span>smap snd <span class="main">(</span>stl <span class="skolem">stepSs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3-5<span class="main">)</span> step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"stl <span class="skolem">stepSs</span>"</span></span> <span class="quoted"><span class="quoted">"stl <span class="skolem">Ms</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stl <span class="skolem">bs</span> <span class="skolem">Ms</span> <span class="skolem">stepSs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">bs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">Ms</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"stl <span class="skolem"><span class="skolem"><span class="skolem">stepSs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ks</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">ks</span><span class="main">.</span>
        alw <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">ks</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="bound">ks</span> <span class="main">∧</span>
        alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span><span class="main">)</span> <span class="bound">ks</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_ks<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">ks</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> ks"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> alw_ev_ks<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span><span class="main">)</span> ks"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ks_def <span class="keyword1"><span class="command">using</span></span> alw_ev_Ord someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ks</span><span class="main">.</span>
        alw <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">ks</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="bound">ks</span> <span class="main">∧</span>
        alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">ks</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">ks</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">ks</span><span class="main">)</span><span class="main">)</span> <span class="bound">ks</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">decr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="main">≡</span> decr0 <span class="free">Ord</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> decr_simps <span class="main">=</span> decr0.code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Ord</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">js</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="free">js</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span><span class="main">)</span> <span class="free">js</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decr_ev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shd <span class="free">js</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="bound">js</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="bound">js</span> <span class="main">≠</span> <span class="free">m</span><span class="main">)</span> <span class="free">js</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="var">?φ</span> <span class="free">m</span> <span class="bound">js</span><span class="main">)</span> <span class="free">js</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span> <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ae <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a m <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">ls</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span>shd <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">js</span><span class="main">.</span> <span class="var">?φ</span> <span class="main">(</span>shd <span class="skolem">ls</span><span class="main">)</span> <span class="bound">js</span> <span class="main">⟹</span> <span class="var">?φ</span> <span class="free">m</span> <span class="bound">js</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>shd <span class="skolem">ls</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>›</span></span> Ord <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ev_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="main">(</span>shd <span class="skolem">ls</span><span class="main">)</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decr_simps_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shd <span class="free">js</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"shd <span class="free">js</span> <span class="main">≠</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decr <span class="free">m</span> <span class="free">js</span> <span class="main">=</span> shd <span class="free">js</span> <span class="main">##</span> decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="free">js</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decr_ev<span class="main">[</span><span class="operator">OF</span> m<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> decr_simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> decr_simps_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="free">js</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">js</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shd <span class="free">js</span><span class="main">,</span> shd <span class="free">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ord
    <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def linear_order_on_def partial_order_on_def
      preorder_on_def refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> decr_ev<span class="main">[</span><span class="operator">OF</span> m<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> decr_simps<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context *)</span>

<span class="keyword1"><span class="command">lemma</span></span> stl_decr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="free">js</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span><span class="main">)</span> <span class="free">js</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shd <span class="free">js</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">js1</span> <span class="bound">js2</span><span class="main">.</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">js1</span> <span class="main">@-</span> <span class="bound">js2</span> <span class="main">∧</span> set <span class="bound">js1</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">∧</span>
 <span class="main">(</span>shd <span class="bound">js2</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="bound">js2</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span>
  shd <span class="main">(</span>decr <span class="free">m</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">js2</span> <span class="main">∧</span> stl <span class="main">(</span>decr <span class="free">m</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="bound">js2</span><span class="main">)</span> <span class="bound">js2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">js1</span> <span class="bound">js2</span><span class="main">.</span> <span class="var">?φ</span> <span class="free">js</span> <span class="bound">js1</span> <span class="bound">js2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> decr_ev<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> m a ae <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ev_induct_strong<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">js</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">js</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">js</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">js1</span></span> <span class="skolem"><span class="skolem">js2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="main">(</span>stl <span class="skolem">js</span><span class="main">)</span> <span class="skolem">js1</span> <span class="skolem">js2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">js</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"shd <span class="skolem"><span class="skolem"><span class="skolem">js</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">js1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">js2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> decr_simps_eq step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span> stream.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> stl_decr_shd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="free">js</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ae<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span><span class="main">)</span> <span class="free">js</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">js1</span> <span class="bound">js2</span><span class="main">.</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">js1</span> <span class="main">@-</span> <span class="bound">js2</span> <span class="main">∧</span> set <span class="bound">js1</span> <span class="main">⊆</span> <span class="main">{</span>shd <span class="free">js</span><span class="main">}</span> <span class="main">∧</span>
 <span class="main">(</span>shd <span class="bound">js2</span><span class="main">,</span> shd <span class="free">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="bound">js2</span> <span class="main">≠</span> shd <span class="free">js</span> <span class="main">∧</span>
  shd <span class="main">(</span>decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">js2</span> <span class="main">∧</span> stl <span class="main">(</span>decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="bound">js2</span><span class="main">)</span> <span class="bound">js2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ord <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> stl_decr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> decr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span><span class="main">)</span> <span class="free">js</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="free">js</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span><span class="main">)</span> <span class="free">js</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ae</span> <span class="free">js</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">(</span>decr <span class="main">(</span>shd <span class="free">js</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"alw <span class="var">?φ</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ξ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ls</span> <span class="bound">js</span><span class="main">.</span> <span class="bound">ls</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="bound">js</span><span class="main">)</span> <span class="bound">js</span> <span class="main">∧</span> <span class="var">?a</span> <span class="bound">js</span> <span class="main">∧</span> <span class="var">?ae</span> <span class="bound">js</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ls</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">js</span><span class="main">.</span> <span class="var">?ξ</span> <span class="skolem">ls</span> <span class="bound">js</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"alw <span class="var">?φ</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> alw_coinduct<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ls</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">js</span><span class="main">.</span> <span class="var">?ξ</span> <span class="skolem">ls</span> <span class="bound">js</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">js</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ξ</span> <span class="skolem">ls</span> <span class="skolem">js</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">js1</span></span> <span class="skolem"><span class="skolem">js2</span></span> <span class="keyword2"><span class="keyword">where</span></span> js<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">js</span> <span class="main">=</span> <span class="skolem">js1</span> <span class="main">@-</span> <span class="skolem">js2</span> <span class="main">∧</span> set <span class="skolem">js1</span> <span class="main">⊆</span> <span class="main">{</span>shd <span class="skolem">js</span><span class="main">}</span> <span class="main">∧</span>
       <span class="main">(</span>shd <span class="skolem">js2</span><span class="main">,</span> shd <span class="skolem">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="skolem">js2</span> <span class="main">≠</span> shd <span class="skolem">js</span> <span class="main">∧</span>
       shd <span class="skolem">ls</span> <span class="main">=</span> shd <span class="skolem">js2</span> <span class="main">∧</span> stl <span class="skolem">ls</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="skolem">js2</span><span class="main">)</span> <span class="skolem">js2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> stl_decr_shd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">js3</span></span> <span class="skolem"><span class="skolem">js4</span></span> <span class="keyword2"><span class="keyword">where</span></span> js2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">js2</span> <span class="main">=</span> <span class="skolem">js3</span> <span class="main">@-</span> <span class="skolem">js4</span> <span class="main">∧</span> set <span class="skolem">js3</span> <span class="main">⊆</span> <span class="main">{</span>shd <span class="skolem">js2</span><span class="main">}</span> <span class="main">∧</span>
       <span class="main">(</span>shd <span class="skolem">js4</span><span class="main">,</span> shd <span class="skolem">js2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="skolem">js4</span> <span class="main">≠</span> shd <span class="skolem">js2</span> <span class="main">∧</span>
       shd <span class="main">(</span>decr <span class="main">(</span>shd <span class="skolem">js2</span><span class="main">)</span> <span class="skolem">js2</span><span class="main">)</span> <span class="main">=</span> shd <span class="skolem">js4</span> <span class="main">∧</span> stl <span class="main">(</span><span class="main">(</span>decr <span class="main">(</span>shd <span class="skolem">js2</span><span class="main">)</span> <span class="skolem">js2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> decr <span class="main">(</span>shd <span class="skolem">js4</span><span class="main">)</span> <span class="skolem">js4</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> stl_decr_shd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">js2</span></span><span class="main">]</span> a ae <span class="keyword1"><span class="command">using</span></span> 1 alw_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 js js2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_shift stl_decr_shd<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_snth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!!</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">!!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> alw.cases alw_iff_sdrop sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sdrop_stl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> F<span class="main">:</span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> decr <span class="main">(</span>shd ks<span class="main">)</span> ks"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">js</span><span class="main">.</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span><span class="main">,</span> shd <span class="bound">js</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">∧</span> shd <span class="main">(</span>stl <span class="bound">js</span><span class="main">)</span> <span class="main">≠</span> shd <span class="bound">js</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decr<span class="main">[</span><span class="operator">OF</span> alw_ks alw_ev_ks<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ls_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> range <span class="main">(</span>snth <span class="skolem">ls</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Wellfounded.wf"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wf</span> <span class="main">(</span><span class="free">Ord</span> <span class="main">-</span> Id<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ord <span class="keyword1"><span class="command">unfolding</span></span> well_order_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">-</span> Id <span class="main">⟶</span> <span class="bound">q'</span> <span class="main">∉</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wfE_min<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span><span class="main">!!</span><span class="skolem">n</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">!!</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ord</span> <span class="main">-</span> Id"</span></span> <span class="keyword1"><span class="command">using</span></span> alw_snth<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 2 Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context *)</span>

<span class="comment1">(* Main theorem: *)</span>
<span class="keyword1"><span class="command">theorem</span></span> infinite_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"good <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">structure</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">S</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> F<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Infinite_Soundness *)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Soundness of Cyclic Proof Trees›</span></span>

<span class="comment1">(* Cyclic trees *)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>discs_sels<span class="main">)</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree <span class="main">=</span>
  Link <span class="tfree"><span class="quoted"><span class="tfree">'link</span></span></span> <span class="main">|</span>
  cNode  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">)</span> step"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree fset"</span></span>

<span class="keyword1"><span class="command">corecursive</span></span> <span class="entity">treeOf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">treeOf</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="bound">l</span> <span class="main">=</span> Link <span class="bound">l'</span>
    <span class="comment1">― ‹makes sense only if backward links point to normal nodes, not to backwards links:›</span>
     <span class="keyword1">then</span> undefined
     <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="keyword1">of</span>
             Link <span class="bound">l</span> <span class="main">⇒</span> <span class="free">treeOf</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="bound">l</span><span class="main">)</span>
            <span class="main">|</span>cNode <span class="bound">step</span> <span class="bound">cts</span> <span class="main">⇒</span> Node <span class="bound">step</span> <span class="main">(</span>fimage <span class="main">(</span><span class="free">treeOf</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span><span class="main">)</span> <span class="bound">cts</span><span class="main">)</span>
          <span class="main">)</span>
   <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Link <span class="bound">l'</span> <span class="main">=&gt;</span> Suc <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> treeOf.code<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> Infinite_Soundness
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pointsTo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'link</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span>ctree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pointsTo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">pointsTo</span> <span class="bound">l</span> <span class="main">≠</span> Link <span class="bound">l'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">seqOf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">seqOf</span> <span class="main">(</span>Link <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">seqOf</span> <span class="main">(</span><span class="free">pointsTo</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">seqOf</span> <span class="main">(</span>cNode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Link <span class="bound">l'</span> <span class="main">=&gt;</span> Suc <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointsTo<span class="main">)</span>

    <span class="comment1">(* Note: Here, "inductive" instead of "coinductive" would not do! *)</span>
<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">cwf</span> <span class="keyword2"><span class="keyword">where</span></span>
  Node<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cwf</span> <span class="main">(</span><span class="free">pointsTo</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">cwf</span> <span class="main">(</span>Link <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
  cNode<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>fimage seqOf <span class="free"><span class="bound"><span class="entity">cts</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">ct'</span><span class="main">.</span> <span class="bound">ct'</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">cts</span></span></span> <span class="main">⟹</span> <span class="free">cwf</span> <span class="bound">ct'</span><span class="main">⟧</span>
<span class="main">⟹</span>
<span class="free">cwf</span> <span class="main">(</span>cNode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cgood</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="main">≡</span> good <span class="main">(</span>treeOf <span class="free">pointsTo</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cwf_Link<span class="main">:</span> <span class="quoted"><span class="quoted">"cwf <span class="main">(</span>Link <span class="free">l</span><span class="main">)</span> <span class="main">⟷</span> cwf <span class="main">(</span><span class="free">pointsTo</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cwf_cNode_seqOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cwf <span class="main">(</span>cNode <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="free">cts</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">eff</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span>fimage seqOf <span class="free">cts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> treeOf_seqOf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> root <span class="main">∘</span> treeOf <span class="free">pointsTo</span> <span class="main">=</span> seqOf"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ct</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>treeOf <span class="free">pointsTo</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> seqOf <span class="skolem">ct</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointsTo<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_treeOf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cwf <span class="free">ct</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>treeOf <span class="free">pointsTo</span> <span class="free">ct</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ct</span> <span class="bound">t</span><span class="main">.</span> cwf <span class="bound">ct</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> treeOf <span class="free">pointsTo</span> <span class="bound">ct</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ct</span><span class="main">.</span> <span class="var">?φ</span> <span class="bound">ct</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> wf.coinduct<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ct</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"treeOf <span class="free">pointsTo</span> <span class="skolem">ct</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"cwf <span class="skolem">ct</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"
       <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> treeOf <span class="free">pointsTo</span> <span class="skolem">ct</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span>
           snd <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> R <span class="main">∧</span>
           effStep <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ct'</span><span class="main">.</span> <span class="var">?φ</span> <span class="bound">ct'</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> wf <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?t</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>root <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> R"</span></span> <span class="keyword1"><span class="command">using</span></span> pointsTo ct
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cwf_Link<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"effStep <span class="main">(</span>root <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="var">?t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pointsTo ct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cwf_Link<span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="var">?t</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ct'</span><span class="main">.</span> <span class="var">?φ</span> <span class="bound">ct'</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ct</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Link <span class="skolem">l</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">cts</span></span> <span class="keyword2"><span class="keyword">where</span></span> pl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pointsTo</span> <span class="skolem">l</span> <span class="main">=</span> cNode <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span> <span class="skolem">cts</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> pointsTo <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pointsTo</span> <span class="skolem">l</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ct'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ct'</span> <span class="main">|∈|</span> <span class="skolem">cts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> treeOf <span class="free">pointsTo</span> <span class="skolem">ct'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Link pl pointsTo <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cwf <span class="skolem">ct'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ct' ct pl <span class="keyword1"><span class="command">unfolding</span></span> Link
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cwf_Link <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cNode <span class="skolem">step</span> <span class="skolem">cts</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> cNode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ct</span> <span class="main">=</span> cNode <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span> <span class="skolem">cts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">step</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ct'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ct'</span> <span class="main">|∈|</span> <span class="skolem">cts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> treeOf <span class="free">pointsTo</span> <span class="skolem">ct'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cNode pointsTo <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cwf <span class="skolem">ct'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ct' ct <span class="keyword1"><span class="command">unfolding</span></span> cNode
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cwf_Link <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cwf.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> cyclic_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cwf <span class="free">ct</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cgood <span class="free">ct</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">structure</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">S</span> <span class="main">(</span>seqOf <span class="free">ct</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> infinite_soundness wf_treeOf assms
  <span class="keyword1"><span class="command">unfolding</span></span> cgood_def treeOf_seqOf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> comp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Infinite_Soundness *)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Appendix: The definition of treeOf under more flexible assumptions about pointsTo›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rels</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rels</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="bound">l'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span><span class="main">,</span> Link <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">l'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'link</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>rels <span class="main">`</span> <span class="main">{</span><span class="bound">pointsTo</span><span class="main">.</span> wf <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">.</span> <span class="bound">pointsTo</span> <span class="bound">l'</span> <span class="main">=</span> Link <span class="bound">l</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_rels<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">pointsTo</span> <span class="main">::</span> <span class="tfree">'link</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span>ctree<span class="main">)</span> <span class="bound">l'</span> <span class="main">=</span> Link <span class="bound">l</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?w</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>rels <span class="free">pointsTo</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_map_prod_image
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'link</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="free">pointsTo</span><span class="main">,</span><span class="free">pointsTo</span> <span class="bound">l'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">pointsTo</span><span class="main">,</span> Link <span class="bound">l'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">l'</span><span class="main">.</span>
                 <span class="main">(</span><span class="main">∀</span><span class="bound">l''</span><span class="main">.</span> <span class="free">pointsTo</span> <span class="bound">l'</span> <span class="main">≠</span> Link <span class="bound">l''</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'link</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'sequent</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'link</span><span class="main">)</span> ctree<span class="main">)</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> image <span class="main">(</span>map_prod <span class="main">(</span>map_prod id Link<span class="main">)</span> <span class="main">(</span>map_prod id Link<span class="main">)</span><span class="main">)</span> <span class="main">(</span>inv_image <span class="var">?w</span> snd<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"rels <span class="free">pointsTo</span> <span class="main">⊆</span> <span class="skolem">r1</span> <span class="main">∪</span> <span class="skolem">r2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rels_def r1_def r2_def <span class="keyword1"><span class="command">unfolding</span></span> inv_image_def image_Collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tOfL</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Link <span class="bound">l'</span> <span class="main">=&gt;</span> Suc <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ctree.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> r2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_map_prod_image wf_inv_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="skolem">r1</span> <span class="main">∩</span> Range <span class="skolem">r2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def r2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 0<span class="main"><span class="main">]</span></span> wf_Un<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_UN<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_UN<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corecursive</span></span> <span class="entity">treeOf'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">treeOf'</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> wf <span class="main">{</span><span class="main">(</span><span class="bound">l'</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span>  <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="bound">l</span> <span class="main">=</span> Link <span class="bound">l'</span><span class="main">}</span>
    <span class="comment1">― ‹makes sense only if backward links point to normal nodes, not to backwards links:›</span>
     <span class="keyword1">then</span> undefined
     <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ct</span></span></span> <span class="keyword1">of</span>
             Link <span class="bound">l</span> <span class="main">⇒</span> <span class="free">treeOf'</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span> <span class="bound">l</span><span class="main">)</span>
            <span class="main">|</span>cNode <span class="bound">step</span> <span class="bound">cts</span> <span class="main">⇒</span> Node <span class="bound">step</span> <span class="main">(</span>fimage <span class="main">(</span><span class="free">treeOf'</span> <span class="free"><span class="bound"><span class="entity">pointsTo</span></span></span><span class="main">)</span> <span class="bound">cts</span><span class="main">)</span>
          <span class="main">)</span>
   <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted">rel</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> rel <span class="keyword1"><span class="command">unfolding</span></span> rel_def rels_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>